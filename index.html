<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</title>

<style>
body {
  font-family: "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont;
  background: #f6e7d3;
  text-align: center;
}
input {
  width: 60%;
  padding: 10px;
  font-size: 16px;
}
button {
  padding: 10px 18px;
  margin: 6px;
  font-size: 16px;
}
canvas {
  margin-top: 20px;
}
#result {
  margin-top: 16px;
  font-size: 20px;
}
</style>
</head>

<body>

<h2>ğŸ¯ ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h2>

<div>
  <input id="names" value="1 2 3" />
</div>

<div>
  <button id="spinOnce">é–‹å§‹æ—‹è½‰</button>
  <button id="spin10">é€£è½‰ 10 æ¬¡</button>
</div>

<canvas id="cv" width="420" height="420"></canvas>

<div id="result">å°šæœªæŠ½ç±¤</div>

<audio id="drum" src="drum.mp3" preload="auto"></audio>

<script>
/* =========================
   MVP Step3 æ ¸å¿ƒï¼ˆå”¯ä¸€ï¼‰
   ========================= */

const canvas = document.getElementById("cv");
const ctx = canvas.getContext("2d");
const drum = document.getElementById("drum");
const resultBox = document.getElementById("result");

let items = [];
let rotation = 0;
let spinning = false;

function parseNames() {
  items = document.getElementById("names").value
    .trim()
    .split(/[\s,]+/)
    .filter(Boolean);
}

function drawWheel(highlightIndex = null) {
  const n = items.length;
  const cx = 210, cy = 210, r = 180;
  ctx.clearRect(0,0,420,420);

  for (let i=0;i<n;i++){
    const a0 = rotation + i * 2*Math.PI/n;
    const a1 = a0 + 2*Math.PI/n;

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,a0,a1);
    ctx.closePath();

    ctx.fillStyle = (i===highlightIndex) ? "#f5bc00" : "#f9d88a";
    ctx.fill();
    ctx.strokeStyle = "#fff";
    ctx.stroke();

    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(a0 + Math.PI/n);
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillStyle="#333";
    ctx.font="16px sans-serif";
    ctx.fillText(items[i], r*0.65, 0);
    ctx.restore();
  }

  // æŒ‡é‡ï¼ˆå€’ä¸‰è§’ï¼Œå›ºå®šï¼‰
  ctx.fillStyle="red";
  ctx.beginPath();
  ctx.moveTo(cx,cy-r-12);
  ctx.lineTo(cx-8,cy-r+6);
  ctx.lineTo(cx+8,cy-r+6);
  ctx.closePath();
  ctx.fill();
}

function spinOnce(callback){
  if(spinning) return;
  spinning=true;

  parseNames();
  if(items.length===0){ spinning=false; return; }

  const n = items.length;
  const winIndex = Math.floor(Math.random()*n);
  const slice = 2*Math.PI/n;

  const target =
    (Math.PI*1.5) -
    (winIndex*slice + slice/2) +
    Math.PI*6;

  const start = rotation;
  const duration = 4200;
  const t0 = performance.now();

  drum.currentTime = 0;
  drum.play().catch(()=>{});

  function anim(t){
    const p = Math.min((t-t0)/duration,1);
    const ease = 1-Math.pow(1-p,3);
    rotation = start + (target-start)*ease;
    drawWheel();
    if(p<1){
      requestAnimationFrame(anim);
    } else {
      rotation = target;
      drawWheel(winIndex);
      drum.onended = ()=>{
        resultBox.innerHTML = `ğŸ¯ æŠ½ä¸­ï¼š${items[winIndex]}`;
        spinning=false;
        if(callback) callback();
      };
    }
  }
  requestAnimationFrame(anim);
}

document.getElementById("spinOnce").onclick = ()=> spinOnce();

document.getElementById("spin10").onclick = ()=>{
  let count=0;
  const run=()=>{
    if(count>=10) return;
    spinOnce(()=>{
      count++;
      setTimeout(run,300);
    });
  };
  run();
};

parseNames();
drawWheel();
</script>

</body>
</html>