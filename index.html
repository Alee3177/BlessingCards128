<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>BlessingCards128｜第一輪姓名輪盤 v5.3</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  background:#fff8e7;
  font-family:"Noto Sans TC",sans-serif;
  text-align:center;
  padding:20px;
  color:#5b3a00;
}
h1{color:#b07500}

.logo{width:120px;margin-bottom:10px}

input{
  width:300px;
  padding:10px;
  font-size:18px;
  border-radius:8px;
  border:1px solid #bf8a3e;
}

button{
  background:#f7c76c;
  border:none;
  padding:10px 22px;
  border-radius:24px;
  font-size:16px;
  margin:6px;
  cursor:pointer;
}

#wheelBox{
  position:relative;
  width:380px;
  height:380px;
  margin:24px auto;
}

#wheel{
  width:380px;
  height:380px;
}

#pointer{
  position:absolute;
  top:-28px;
  left:50%;
  transform:translateX(-50%);
  font-size:44px;
  color:red;
  z-index:10;
}

#status{
  font-size:20px;
  margin-top:10px;
}
</style>
</head>

<body>

<h1>祝福經句紅包（第一輪測試）</h1>
<img src="logo3524.png" class="logo"><br>

<input id="nameInput" placeholder="輸入姓名，用、或空白分隔"><br>

<button onclick="lockList()">鎖定名單</button>
<button onclick="startSpin()">開始抽姓名</button>
<button onclick="resetAll()">全部歸零</button>

<div id="wheelBox">
  <div id="pointer">▼</div>
  <canvas id="wheel" width="380" height="380"></canvas>
</div>

<div id="status">請輸入姓名並鎖定名單</div>

<script>
/* ========= 狀態 ========= */
let names = [];
let used = [];
let locked = false;
let isSpinning = false;

/* ========= Canvas ========= */
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const C = 190, R = 175;

/* ========= 工具 ========= */
function resetAll(){
  names=[]; used=[]; locked=false;
  document.getElementById("nameInput").value="";
  ctx.clearRect(0,0,380,380);
  document.getElementById("status").innerText="已清空，請重新輸入姓名";
}

function lockList(){
  const raw=document.getElementById("nameInput").value.trim();
  if(!raw){alert("請輸入姓名");return;}
  const arr=[...new Set(raw.split(/[,、\s]+/).filter(Boolean))];
  if(arr.length<2){alert("至少兩位");return;}
  names=arr; used=[]; locked=true;
  drawWheel(names,0);
  document.getElementById("status").innerText=`名單已鎖定（${names.length} 位）`;
}

/* ========= 畫輪盤 ========= */
function drawWheel(items,angle){
  ctx.clearRect(0,0,380,380);
  const n=items.length;
  const arc=2*Math.PI/n;

  ctx.save();
  ctx.translate(C,C);
  ctx.rotate(angle);
  ctx.translate(-C,-C);

  for(let i=0;i<n;i++){
    const a0=i*arc-Math.PI/2;
    const a1=a0+arc;

    ctx.beginPath();
    ctx.moveTo(C,C);
    ctx.arc(C,C,R,a0,a1);
    ctx.fillStyle=i%2?"#fcdca0":"#fde7b5";
    ctx.fill();
    ctx.strokeStyle="#fff";
    ctx.lineWidth=2;
    ctx.stroke();

    ctx.save();
    ctx.translate(C,C);
    ctx.rotate(a0+arc/2);
    ctx.textAlign="right";
    ctx.font="20px Noto Sans TC";
    ctx.fillStyle="#5b3a00";
    ctx.fillText(items[i],R-18,8);
    ctx.restore();
  }

  ctx.restore();
}

/* ========= 核心：精準轉動 ========= */
function startSpin(){
  if(!locked){alert("請先鎖定名單");return;}
  if(isSpinning){return;}

  const remain=names.filter(n=>!used.includes(n));
  if(remain.length===0){
    alert("全部姓名已抽完");
    return;
  }

  const winner=remain[Math.floor(Math.random()*remain.length)];
  const index=names.indexOf(winner);

  isSpinning=true;
  document.getElementById("status").innerText="輪盤轉動中…";

  const n=names.length;
  const arc=2*Math.PI/n;
  const targetAngle=-(index*arc+arc/2);

  const start=performance.now();
  const duration=4200;
  const spins=6*2*Math.PI;

  function animate(t){
    const p=Math.min((t-start)/duration,1);
    const ease=1-Math.pow(1-p,3);
    const angle=spins*ease+targetAngle;
    drawWheel(names,angle);

    if(p<1){
      requestAnimationFrame(animate);
    }else{
      drawWheel(names,targetAngle);
      used.push(winner);
      document.getElementById("status").innerText=`第 1 輪完成：抽中「${winner}」`;
      isSpinning=false;
    }
  }
  requestAnimationFrame(animate);
}
</script>

</body>
</html>
