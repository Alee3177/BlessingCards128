<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>BlessingCards128ï½œç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰v8.5.3</title>

  <style>
    :root{
      --bg:#fff8e7;
      --text:#5b3a00;
      --accent:#b07500;
      --btn:#f7c76c;
      --btnHover:#f3b84f;
      --border:#bf8a3e;
      --danger:#c0392b;
    }
    body{
      background:var(--bg);
      font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      text-align:center;
      padding:22px;
      color:var(--text);
      margin:0;
    }
    h1{
      color:var(--accent);
      font-size:26px;
      margin:0 0 10px 0;
      line-height:1.25;
    }
    .logo{
      width:120px;
      margin:0 auto 14px;
      display:block;
    }

    #nameInput{
      width:min(360px, 86vw);
      padding:10px 12px;
      font-size:18px;
      border-radius:10px;
      border:1px solid var(--border);
      margin:0 0 12px 0;
      outline:none;
      background:#fff;
    }

    .btn{
      background:var(--btn);
      border:none;
      padding:12px 18px;
      border-radius:25px;
      font-size:18px;
      color:var(--text);
      cursor:pointer;
      margin:6px;
      transition:filter .12s ease, transform .02s ease;
    }
    .btn:hover{ background:var(--btnHover); }
    .btn:active{ transform:translateY(1px); }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      filter:grayscale(.1);
    }

    @keyframes blink{
      0%{opacity:1}
      50%{opacity:.25}
      100%{opacity:1}
    }
    .blinking{ animation:blink 1s infinite; }

    #wheelContainer{
      position:relative;
      width:380px;
      height:380px;
      margin:22px auto 10px;
    }
    #wheelCanvas{
      width:380px;
      height:380px;
      display:block;
      margin:0 auto;
    }
    #wheelPointer{
      position:absolute;
      top:-26px;
      left:50%;
      transform:translateX(-50%);
      font-size:44px;
      color:red;
      z-index:20;
      user-select:none;
    }

    #statusText{
      font-size:20px;
      margin-top:8px;
      color:#a56b00;
      white-space:pre-line;
      line-height:1.35;
      padding:0 10px;
    }
    #statusText.error{
      color:var(--danger);
      font-weight:700;
    }

    /* è½‰ç›¤ä¸­å¿ƒå…©è¡Œï¼šæ›¸å· / ç« ç¯€ï¼ˆç¬¬äºŒè¼ªçµæŸå¾Œæ‰é¡¯ç¤ºï¼‰ */
    #centerText{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      width:78%;
      text-align:center;
      display:none;
      z-index:10;
      pointer-events:none;
    }
    #centerText .book{
      font-size:22px;
      font-weight:700;
      color:var(--text);
      line-height:1.25;
    }
    #centerText .chapter{
      font-size:20px;
      color:var(--text);
      line-height:1.25;
      margin-top:6px;
    }

    /* å°å¾½ç« ï¼ˆå¯ä¸ç”¨é¡¯ç¤ºï¼Œä¿ç•™ä¸å½±éŸ¿ï¼‰ */
    #badge{
      position:absolute;
      top:12px;
      left:50%;
      transform:translateX(-50%);
      background:#fff;
      padding:6px 14px;
      border-radius:18px;
      font-size:18px;
      display:none;
      z-index:30;
    }

    .spacer{ height:6px; }

    @media (max-width:420px){
      #wheelContainer{ width:340px; height:340px; }
      #wheelCanvas{ width:340px; height:340px; }
      #wheelPointer{ top:-24px; font-size:42px; }
    }
  </style>
</head>

<body>
  <h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h1>
  <img src="logo3524.png" class="logo" alt="logo">

  <input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼ˆå¯ç”¨é€—è™Ÿ/é “è™Ÿ/ç©ºç™½åˆ†éš”ï¼‰" autocomplete="off" />
  <div class="spacer"></div>

  <button id="lockBtn" class="btn">é–å®šåå–®</button>
  <button id="startBtn" class="btn">é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
  <button id="resetBtn" class="btn">å…¨éƒ¨æ­¸é›¶</button>
  <button id="pdfBtn" class="btn">æŠ½ç±¤ç´€éŒ„ PDF</button>

  <div class="spacer"></div>
  <button id="secondBtn" class="btn" style="display:none;">æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
  <button id="viewerBtn" class="btn" style="display:none;">çœ‹ç´…åŒ…å…§å®¹</button>

  <div id="wheelContainer">
    <div id="wheelPointer">â–¼</div>
    <div id="badge"></div>

    <div id="centerText">
      <div class="book"></div>
      <div class="chapter"></div>
    </div>

    <canvas id="wheelCanvas" width="380" height="380"></canvas>
  </div>

  <div id="statusText">è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€</div>

  <!-- ç¶“æ–‡å°ç…§è¡¨ï¼ˆç·¨è™Ÿ â†’ æ›¸å· ç« ç¯€ï¼‰ -->
  <script src="verseRefMap.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  /****************************************************************
   * BlessingCards128 - v8.5.3 Stable Final
   * æ ¸å¿ƒè¦æ±‚ï¼š
   * - ç¬¬ä¸€è¼ªæŠ½ä¸­ = æŒ‡é‡åœä¸‹ä½ç½®å¿…å®šä¸€è‡´ï¼ˆè‡ªç„¶é€£çºŒå‹•ç•«ï¼Œä¸æœƒäºŒæ¬¡è·³å‹•ï¼‰
   * - ç¬¬äºŒè¼ªå¤–è§€æ²¿ç”¨å§“åè¼ªç›¤ï¼ˆå¯ç©ºç™½æ–‡å­—ï¼‰ï¼Œä½†æŒ‡é‡ä½ç½®å¿…é ˆä»åœåœ¨åŒä¸€ä½ï¼ˆåŒç¬¬ä¸€è¼ªä¸­çè€…ï¼‰
   * - ç¬¬äºŒè¼ªã€Œæ›¸å·/ç« ç¯€ã€åªåœ¨åœæ­¢å¾Œæ‰é¡¯ç¤ºï¼ˆé¿å…åƒä½œå¼Šï¼‰
   * - PDFï¼šç”¨ Canvas â†’ Image æ–¹å¼é€² PDFï¼Œä¸­æ–‡ä¸äº‚ç¢¼ï¼Œå­—é«”å›ºå®šé»‘è‰²
   * - è·¨è¼ªç´¯ç©ï¼šæœªæŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€æ™‚ï¼Œlogs/verses ç´¯ç©ï¼›é–å®šåå–®åªé‡ç½®æœ¬è¼ª usedNames
   ****************************************************************/

  // ---------- DOM ----------
  const $ = (id)=>document.getElementById(id);
  const nameInput = $("nameInput");
  const lockBtn   = $("lockBtn");
  const startBtn  = $("startBtn");
  const resetBtn  = $("resetBtn");
  const pdfBtn    = $("pdfBtn");
  const secondBtn = $("secondBtn");
  const viewerBtn = $("viewerBtn");

  const statusText = $("statusText");
  const badge = $("badge");

  const wheelContainer = $("wheelContainer");
  const centerText = $("centerText");
  const centerBook = centerText.querySelector(".book");
  const centerChap = centerText.querySelector(".chapter");

  const canvas = $("wheelCanvas");
  const ctx = canvas.getContext("2d", { alpha: true });

  // ---------- geometry ----------
  const CENTER = 190;
  const RADIUS = 180;

  // ---------- state ----------
  let nameList = [];
  let locked = false;

  let usedNames = [];     // æœ¬è¼ªå·²æŠ½éçš„äººï¼ˆæ¯è¼ªæœƒé‡ç½®ï¼‰
  let usedVerses = [];    // å…¨å±€ä¸é‡è¤‡ï¼ˆè·¨è¼ªä¿ç•™ï¼Œç›´åˆ°å…¨éƒ¨æ­¸é›¶ï¼‰
  let drawLogs = [];      // å…¨å±€ç´¯ç©ï¼ˆè·¨è¼ªä¿ç•™ï¼Œç›´åˆ°å…¨éƒ¨æ­¸é›¶ï¼‰

  let currentRotation = 0; // è¼ªç›¤ç›®å‰è§’åº¦ï¼ˆè·¨ç¬¬ä¸€è¼ª/ç¬¬äºŒè¼ªå…±ç”¨ï¼‰
  let selectedName = null;
  let selectedVerse = null;
  let selectedRef = null;

  let isSpinning = false;
  let awaitingSecondRound = false; // é˜²å‘†ï¼šç¬¬ä¸€è¼ªå¾Œå¿…é ˆå…ˆæŒ‰ç¬¬äºŒè¼ª

  // ---------- audio ----------
  let drumAudio = null;
  function playDrum(){
    // åƒ…åœ¨çœŸæ­£é–‹å§‹æ—‹è½‰æ™‚æ’­æ”¾ï¼Œä¸è¦åœ¨ focus / lockList æ™‚æ’­æ”¾
    return new Promise((resolve)=>{
      try{
        if(drumAudio){
          drumAudio.pause();
          drumAudio.currentTime = 0;
        }
        drumAudio = new Audio("audio/drum.mp3");
        drumAudio.preload = "auto";
        drumAudio.play().then(()=>resolve()).catch(()=>resolve());
      }catch(e){
        resolve();
      }
    });
  }

  function stopDrum(){
    try{
      if(drumAudio){
        drumAudio.pause();
        drumAudio.currentTime = 0;
      }
    }catch(e){}
  }

  // ---------- helpers ----------
  function setStatus(text, isError=false){
    statusText.classList.toggle("error", !!isError);
    statusText.textContent = text;
  }

  function setEndMessage(total){
    // ä¸‰è¡Œæç¤ºï¼ˆä½ æŒ‡å®šçš„æœ€æ–°ç‰ˆï¼‰
    const line1 = `ğŸ‰ æ­¤è¼ªè½‰ç›¤å·²å®Œæˆ ${total} ä½çš„ç´…åŒ…æŠ½ç±¤`;
    const line2 = `ğŸ“„ è«‹æŒ‰ã€ŒæŠ½ç±¤ç´€éŒ„ PDFã€ä¸‹è¼‰ç´€éŒ„ï¼Œæˆ–`;
    const line3 = `ğŸ” è¼¸å…¥æ–°å§“å â†’ æŒ‰ã€Œé–å®šåå–®ã€é–‹å§‹ä¸‹ä¸€è¼ªï¼›ä¹Ÿå¯æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€`;
    setStatus([line1,line2,line3].join("\n"), false);

    // PDF æŒ‰éˆ•é–ƒçˆæç¤ºï¼ˆä½†ä¸é–æ­»ï¼‰
    pdfBtn.classList.add("blinking");
  }

  function showBadge(text){
    if(!text){
      badge.style.display="none";
      badge.textContent="";
      return;
    }
    badge.textContent = text;
    badge.style.display="block";
  }

  function showCenterText(book, chap){
    if(!book && !chap){
      centerText.style.display="none";
      centerBook.textContent="";
      centerChap.textContent="";
      return;
    }
    centerBook.textContent = book || "";
    centerChap.textContent = chap || "";
    centerText.style.display="block";
  }

  function disableAll(disabled){
    // ä¸è¦æŠŠ reset / pdf æ°¸ä¹…é–æ­»ï¼›ä½†æ—‹è½‰ä¸­é¿å…èª¤è§¸
    const elems = [lockBtn,startBtn,resetBtn,pdfBtn,secondBtn,viewerBtn,nameInput];
    elems.forEach(el=>{ el.disabled = disabled; });
  }

  function normalizeNames(raw){
    // æ”¯æ´ï¼šé€—è™Ÿã€é “è™Ÿã€ç©ºç™½ çš†å¯
    return raw
      .trim()
      .split(/[,ã€\s]+/)
      .map(s=>s.trim())
      .filter(Boolean);
  }

  function hasDuplicate(arr){
    const seen = new Set();
    for(const x of arr){
      if(seen.has(x)) return true;
      seen.add(x);
    }
    return false;
  }

  function saveStorage(){
    localStorage.setItem("nameList", JSON.stringify(nameList));
    localStorage.setItem("locked", locked ? "1" : "0");
    localStorage.setItem("usedNames", JSON.stringify(usedNames));
    localStorage.setItem("usedVerses", JSON.stringify(usedVerses));
    localStorage.setItem("drawLogs", JSON.stringify(drawLogs));
    localStorage.setItem("currentRotation", String(currentRotation || 0));
    localStorage.setItem("awaitingSecondRound", awaitingSecondRound ? "1" : "0");
    localStorage.setItem("selectedName", selectedName || "");
    localStorage.setItem("selectedVerse", selectedVerse || "");
  }

  function loadStorage(){
    try{
      const nl = localStorage.getItem("nameList");
      if(nl) nameList = JSON.parse(nl) || [];
    }catch(e){ nameList=[]; }

    locked = localStorage.getItem("locked")==="1";

    try{ usedNames = JSON.parse(localStorage.getItem("usedNames")||"[]"); }catch(e){ usedNames=[]; }
    try{ usedVerses = JSON.parse(localStorage.getItem("usedVerses")||"[]"); }catch(e){ usedVerses=[]; }
    try{ drawLogs = JSON.parse(localStorage.getItem("drawLogs")||"[]"); }catch(e){ drawLogs=[]; }

    const rot = Number(localStorage.getItem("currentRotation")||"0");
    currentRotation = isFinite(rot) ? rot : 0;

    awaitingSecondRound = localStorage.getItem("awaitingSecondRound")==="1";
    selectedName = (localStorage.getItem("selectedName")||"") || null;
    selectedVerse = (localStorage.getItem("selectedVerse")||"") || null;
  }

  function resetAll(){
    stopDrum();
    localStorage.clear();

    nameList=[];
    locked=false;
    usedNames=[];
    usedVerses=[];
    drawLogs=[];
    currentRotation=0;
    selectedName=null;
    selectedVerse=null;
    selectedRef=null;
    awaitingSecondRound=false;

    pdfBtn.classList.remove("blinking");

    nameInput.value="";
    startBtn.disabled=false;
    secondBtn.style.display="none";
    viewerBtn.style.display="none";
    showCenterText("");
    showBadge("");

    drawWheel(nameList, 0, true);
    setStatus("è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€", false);
  }

  // ---------- drawing ----------
  function drawWheel(items, rotation, showLabels){
    // rotationï¼šæ•´é«”æ—‹è½‰è§’ï¼ˆå¼§åº¦ï¼‰ã€‚0 ä»£è¡¨ slice0 èµ·é»åœ¨ 12 é»æ–¹å‘
    ctx.clearRect(0,0,380,380);

    if(!items || items.length===0){
      // ç©ºè¼ªç›¤ä¹Ÿç•«å€‹åº•
      ctx.save();
      ctx.translate(CENTER,CENTER);
      ctx.beginPath();
      ctx.fillStyle="#fff";
      ctx.arc(0,0,RADIUS,0,Math.PI*2);
      ctx.fill();
      ctx.restore();
      return;
    }

    const count = items.length;
    const arc = (Math.PI*2)/count;

    ctx.save();
    ctx.translate(CENTER,CENTER);
    ctx.rotate(rotation);
    ctx.translate(-CENTER,-CENTER);

    for(let i=0;i<count;i++){
      const start = i*arc - Math.PI/2; // 12é»é–‹å§‹
      const end   = start + arc;

      ctx.beginPath();
      ctx.moveTo(CENTER,CENTER);
      ctx.fillStyle = (i%2===0) ? "#fde7b5" : "#fcdca0";
      ctx.arc(CENTER,CENTER,RADIUS,start,end);
      ctx.closePath();
      ctx.fill();

      // åˆ†éš”ç·šï¼šç¶­æŒä½ åŸæœ¬å–œæ­¡çš„ç²—ç´°/ç™½è‰²
      ctx.strokeStyle="#ffffff";
      ctx.lineWidth=2;
      ctx.stroke();

      if(showLabels){
        // æ–‡å­—
        ctx.save();
        ctx.translate(CENTER,CENTER);
        const mid = (start+end)/2;
        ctx.rotate(mid);
        ctx.textAlign="right";
        ctx.font="22px Noto Sans TC";
        ctx.fillStyle="#5b3a00";
        ctx.fillText(items[i], RADIUS-22, 10);
        ctx.restore();
      }
    }

    ctx.restore();
  }

  function easeOutCubic(t){
    return 1 - Math.pow(1-t, 3);
  }

  // ---------- core spin (ç²¾æº–å‘½ä¸­ï¼Œä¸”ä¸åšã€ŒäºŒæ¬¡é‡ç•«è·³å‹•ã€) ----------
  // æ–¹æ¡ˆï¼šä¿æŒ currentRotationï¼Œè¨ˆç®—è¦è®“ targetIndex çš„ä¸­å¿ƒå°æº– 12 é»(æŒ‡é‡)
  function spinToIndex(items, targetIndex, clockwise, durationMs){
    return new Promise(async (resolve)=>{
      if(isSpinning) return;
      isSpinning = true;

      disableAll(true);
      showBadge("");
      showCenterText("", "");

      const count = items.length;
      const arc = (Math.PI*2)/count;

      // ç›®æ¨™ slice ä¸­å¿ƒè§’ï¼ˆä»¥ 12é»èµ·ç®—ï¼‰
      const targetCenter = targetIndex*arc + arc/2;

      // æŒ‡é‡æ–¹å‘ = 12é» = 0
      const pointerAngle = 0;

      // è½‰å¹¾åœˆï¼šåŸºç¤åœˆæ•¸ + é€Ÿåº¦æå‡ï¼ˆä½ å·²æ¸¬ SPEED_BOOST=1.35 OKï¼‰
      const SPEED_BOOST = 1.35;
      const baseSpins = 4.8;
      const spins = baseSpins * SPEED_BOOST;

      const dir = clockwise ? 1 : -1;

      // æœ€çµ‚è¦å¢åŠ çš„æ—‹è½‰é‡ Î”ï¼Œä½¿ targetCenter å°æº– pointerAngle
      // Î” = (pointerAngle - targetCenter) - currentRotation + dir*(spins*2Ï€) + margin
      // ç‚ºé¿å…åœåœ¨ç·šä¸Šï¼šå°‡ç›®æ¨™ç•¥åå‘ slice ä¸­å¿ƒï¼ˆarc/2 å·²æ˜¯ä¸­å¿ƒï¼‰ï¼Œå†åŠ ä¸€å€‹ safetyMargin
      // safetyMargin è®“è½é»é›¢é‚Šç•Œè‡³å°‘ 10pxï¼ˆè§’åº¦ä¸Šç´„ç­‰æ–¼ 10/RADIUSï¼‰
      const safetyAngle = Math.max(0.0, 10 / RADIUS); // ~0.0556 rad
      const safeCenter = targetCenter + (arc>2*safetyAngle ? 0 : 0); // ä¿å®ˆï¼Œä¸æ”¹ä¸­å¿ƒ
      const delta = (pointerAngle - safeCenter) - currentRotation + dir*(spins*2*Math.PI);

      const startRotation = currentRotation;
      const endRotation   = startRotation + delta;

      // æ’­éŸ³æ•ˆï¼ˆèˆ‡å‹•ç•«åŒæ™‚é–‹å§‹ï¼‰
      await playDrum();

      const t0 = performance.now();

      function frame(now){
        let t = (now - t0) / durationMs;
        if(t>1) t=1;

        const eased = easeOutCubic(t);
        const rot = startRotation + (endRotation - startRotation)*eased;

        drawWheel(items, rot, true);

        if(t < 1){
          requestAnimationFrame(frame);
        }else{
          // æœ€çµ‚åœé»ï¼šç›´æ¥ç”¨ endRotationï¼Œé¿å…ã€Œæœ€å¾Œä¸€è·³ã€è¦–è¦º
          currentRotation = endRotation;

          stopDrum();

          isSpinning = false;
          disableAll(false);
          resolve(endRotation);
        }
      }

      requestAnimationFrame(frame);
    });
  }

  // ---------- round logic ----------
  function pickRandom(arr){
    return arr[Math.floor(Math.random()*arr.length)];
  }

  function remainingNames(){
    return nameList.filter(n => !usedNames.includes(n));
  }

  function getAvailableVerses(){
    const keys = Object.keys(window.VERSE_REF_MAP || {});
    return keys.filter(v => !usedVerses.includes(v));
  }

  function nowTimestamp(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    const ss = String(d.getSeconds()).padStart(2,"0");
    return `${yyyy}/${mm}/${dd} ${hh}:${mi}:${ss}`;
  }

  // é–å®šåå–®ï¼šé–‹å§‹æ–°ä¸€è¼ªï¼ˆåªé‡ç½® usedNamesï¼›ä¸æ¸…ç©º logs/versesï¼‰
  function lockList(){
    if(isSpinning) return;

    const raw = nameInput.value;
    const arr = normalizeNames(raw);

    if(arr.length < 2){
      alert("è‡³å°‘è¦æœ‰å…©ä½æ‰å¯ä»¥ï¼");
      return;
    }
    if(hasDuplicate(arr)){
      alert("Oops, æœ‰å§“åé‡è¤‡è¼¸å…¥äº†å”·ï¼");
      return;
    }

    nameList = arr;
    locked = true;

    // æ–°ä¸€è¼ªï¼šåªé‡ç½®æœ¬è¼ªå·²æŠ½éçš„äºº
    usedNames = [];
    selectedName = null;
    selectedVerse = null;
    selectedRef = null;
    awaitingSecondRound = false;

    // UI reset
    pdfBtn.classList.remove("blinking");
    secondBtn.style.display="none";
    viewerBtn.style.display="none";
    startBtn.disabled = false;

    // ä¿æŒ currentRotation ä¸é‡ç½®ï¼ˆé¿å…ä½ èªªã€Œé‡ç•«ä½ç½®ä¸åŒã€ï¼‰
    drawWheel(nameList, currentRotation, true);
    showCenterText("", "");
    showBadge("");

    setStatus(`ğŸ”’ æ–°ä¸€è¼ªåå–®å·²é–å®šï¼Œå…± ${nameList.length} ä½\nè«‹æŒ‰ã€Œé–‹å§‹æŠ½å§“å + ç¶“å¥ã€`, false);

    saveStorage();
  }

  async function startFirstRound(){
    if(isSpinning) return;

    if(!locked || nameList.length < 2){
      setStatus("è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€", true);
      return;
    }

    // é˜²å‘†ï¼šç¬¬ä¸€è¼ªå®Œæˆå¾Œï¼Œåœ¨æŒ‰ç¬¬äºŒè¼ªä¹‹å‰ï¼Œä¸å¯å†æ¬¡æŒ‰ç¬¬ä¸€è¼ª
    if(awaitingSecondRound){
      return;
    }

    const remaining = remainingNames();
    if(remaining.length === 0){
      // å·²å…¨éƒ¨æŠ½å®Œï¼ˆæœ¬è¼ªï¼‰ï¼Œæç¤ºä¸‹è¼‰æˆ–ä¸‹ä¸€è¼ª
      setEndMessage(nameList.length);
      startBtn.disabled = true;
      secondBtn.style.display="none";
      viewerBtn.style.display="none";
      saveStorage();
      return;
    }

    // æŠ½ä¸­äºº
    const winner = pickRandom(remaining);
    const targetIndex = nameList.indexOf(winner);

    selectedName = null;
    selectedVerse = null;
    selectedRef = null;

    setStatus("ğŸ¡ ç¬¬ 1 è¼ªï¼šå§“åè¼ªç›¤æŠ½ç±¤ä¸­â€¦", false);
    showCenterText("", "");
    showBadge("");

    // ç¬¬ä¸€è¼ªï¼šé€†æ™‚é‡
    await spinToIndex(nameList, targetIndex, false, getSpinDurationMs());

    // å®Œæˆ
    selectedName = winner;
    usedNames.push(winner);
    awaitingSecondRound = true;

    setStatus(`ğŸ¯ ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${winner}ã€`, false);

    // ç¬¬äºŒè¼ªæŒ‰éˆ•é¡¯ç¤º + é–ƒçˆ
    secondBtn.style.display="inline-block";
    secondBtn.classList.add("blinking");

    // ç¬¬ä¸€è¼ªå¾Œï¼šé–ä½ startBtnï¼ˆç›´åˆ°ç¬¬äºŒè¼ªçµæŸï¼‰
    startBtn.disabled = true;

    saveStorage();
  }

  async function startSecondRound(){
    if(isSpinning) return;

    if(!selectedName){
      return;
    }
    // ç¬¬äºŒè¼ªæŒ‰éˆ•ä¸å¯é‡æŒ‰
    secondBtn.classList.remove("blinking");
    secondBtn.style.display="none";

    const available = getAvailableVerses();
    if(available.length === 0){
      alert("128 å€‹ç¶“å¥éƒ½å·²æŠ½å®Œï¼è«‹æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€é‡æ–°é–‹å§‹ã€‚");
      return;
    }

    setStatus("ğŸ ç¬¬ 2 è¼ªï¼šç¥ç¦ç¶“å¥æŠ½ç±¤ä¸­â€¦", false);
    showBadge("");
    showCenterText("", ""); // é‡è¦ï¼šç¬¬äºŒè¼ªé–‹å§‹ä¸è¦å…ˆé¡¯ç¤ºæ›¸å·ç« ç¯€

    // ç¬¬äºŒè¼ªå¤–è§€ï¼šæ²¿ç”¨å§“åè¼ªç›¤ï¼Œä½†ä¸é¡¯ç¤ºå§“åï¼ˆç©ºç™½ï¼‰â€”â€”ä¾ä½ çš„æ–°è¦å‰‡
    // åšæ³•ï¼šæš«æ™‚ç”¨åŒæ¨£ slicesï¼Œä½† showLabels=false
    // ç‚ºäº†ä¸å‹•åŸ drawWheelï¼Œæˆ‘å€‘ç›´æ¥ drawWheel ä¸€æ¬¡ä¸ç•«å­—ï¼š
    drawWheel(nameList, currentRotation, false);

    // ç¬¬äºŒè¼ªæ—‹è½‰æ–¹å‘ï¼šé †æ™‚é‡
    // è¦å‰‡ï¼šç¬¬äºŒè¼ªåœé»å¿…é ˆä»åœåœ¨ã€Œç¬¬ä¸€è¼ªæŠ½ä¸­çš„äººã€(åŒä¸€ index)
    const idx = nameList.indexOf(selectedName);

    // å‹•ç•«æ—‹è½‰ï¼šæˆ‘å€‘ä»ç”¨ spinToIndex çš„ç²¾æº–è§’åº¦ï¼Œä½† drawWheel ä¸­ label æ”¹ç‚º false
    // å›  spinToIndex å…§éƒ¨å›ºå®š drawWheel(..., true)ï¼Œå› æ­¤ç¬¬äºŒè¼ªæˆ‘å€‘ç”¨å°ˆç”¨ç‰ˆæœ¬ï¼š
    await spinToIndex_NoLabel(nameList, idx, true, getSpinDurationMs());

    // å…§éƒ¨æŠ½ç¶“å¥ï¼ˆ001-128 ä¸é‡è¤‡ï¼‰
    selectedVerse = pickRandom(available);
    usedVerses.push(selectedVerse);

    const ref = (window.VERSE_REF_MAP && window.VERSE_REF_MAP[selectedVerse]) ? window.VERSE_REF_MAP[selectedVerse] : "";
    selectedRef = ref;

    // ç¬¬äºŒè¼ªåœæ­¢å¾Œæ‰é¡¯ç¤ºæ›¸å·/ç« ç¯€ï¼ˆå…©è¡Œï¼‰
    // ref æ ¼å¼ä¾‹å¦‚ "è©©ç¯‡ 118:24"
    let book="", chap="";
    if(ref){
      const parts = ref.split(/\s+/);
      book = parts[0] || "";
      chap = parts.slice(1).join(" ") || "";
    }
    showCenterText(book, chap);

    setStatus(`ğŸ¯ ç¬¬ 2 è¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ${selectedVerse}ã€`, false);

    // è¨˜éŒ„ logï¼ˆè·¨è¼ªç´¯ç©ï¼‰
    drawLogs.push({
      time: nowTimestamp(),
      name: selectedName,
      verse: selectedVerse,
      ref: ref
    });

    // çœ‹ç´…åŒ…æŒ‰éˆ•
    viewerBtn.style.display="inline-block";

    awaitingSecondRound = false;
    startBtn.disabled = false;

    saveStorage();

    // è‹¥æœ¬è¼ªéƒ½å·²æŠ½å®Œï¼ˆusedNames === nameListï¼‰
    if(usedNames.length >= nameList.length){
      // æœ¬è¼ªçµæŸï¼šæç¤ºï¼Œä¸¦è®“ PDF é–ƒçˆæé†’ä¸‹è¼‰
      setEndMessage(nameList.length);
      startBtn.disabled = true;
      secondBtn.style.display="none";
      viewerBtn.style.display="none";
      saveStorage();
    }
  }

  // ç¬¬äºŒè¼ªä¸é¡¯ç¤ºå§“åçš„ spin ç‰ˆæœ¬ï¼ˆé¿å…æ”¹å‹•ç¬¬ä¸€è¼ª coreï¼‰
  function spinToIndex_NoLabel(items, targetIndex, clockwise, durationMs){
    return new Promise(async (resolve)=>{
      if(isSpinning) return;
      isSpinning = true;

      disableAll(true);
      showBadge("");

      const count = items.length;
      const arc = (Math.PI*2)/count;

      const targetCenter = targetIndex*arc + arc/2;
      const pointerAngle = 0;

      const SPEED_BOOST = 1.35;
      const baseSpins = 4.8;
      const spins = baseSpins * SPEED_BOOST;
      const dir = clockwise ? 1 : -1;

      const delta = (pointerAngle - targetCenter) - currentRotation + dir*(spins*2*Math.PI);

      const startRotation = currentRotation;
      const endRotation   = startRotation + delta;

      await playDrum();

      const t0 = performance.now();

      function frame(now){
        let t = (now - t0) / durationMs;
        if(t>1) t=1;

        const eased = easeOutCubic(t);
        const rot = startRotation + (endRotation - startRotation)*eased;

        // ç¬¬äºŒè¼ªï¼šä¸ç•«å§“å
        drawWheel(items, rot, false);

        if(t < 1){
          requestAnimationFrame(frame);
        }else{
          currentRotation = endRotation;
          stopDrum();
          isSpinning = false;
          disableAll(false);
          resolve(endRotation);
        }
      }

      requestAnimationFrame(frame);
    });
  }

  function gotoViewer(){
    if(!selectedName || !selectedVerse) return;
    // å‚³ name / verse / time / ref
    const log = drawLogs[drawLogs.length-1];
    const time = log && log.time ? log.time : "";
    const ref = (window.VERSE_REF_MAP && window.VERSE_REF_MAP[selectedVerse]) ? window.VERSE_REF_MAP[selectedVerse] : "";
    const qs =
      `viewer.html?name=${encodeURIComponent(selectedName)}`+
      `&verse=${encodeURIComponent(selectedVerse)}`+
      `&ref=${encodeURIComponent(ref)}`+
      `&time=${encodeURIComponent(time)}`;
    location.href = qs;
  }

  // æ—‹è½‰ç§’æ•¸ï¼šé…åˆ drum.mp3ï¼ˆé€™è£¡ç”¨å›ºå®šå€¼ï¼Œé¿å…ä¸åŒæ‰‹æ©Ÿæ³¢å‹•ï¼‰
  // è‹¥ä½ ä¹‹å¾Œè¦ã€Œè‡ªå‹•è®€éŸ³æª”é•·åº¦ã€ä¹Ÿå¯åŠ ï¼Œä½†ç›®å‰ä»¥ç©©å®šå„ªå…ˆ
  function getSpinDurationMs(){
    // å¯ä¾ä½ ç›®å‰ drum.mp3 å¯¦éš›é•·åº¦å¾®èª¿
    // é€™ç‰ˆå…ˆç”¨ 5200msï¼ˆè¼ƒè‡ªç„¶ï¼‰
    return 5200;
  }

  // ---------- PDF: Canvas â†’ Image into PDF (é»‘è‰²æ–‡å­—) ----------
  async function exportPDF(){
    try{
      if(!drawLogs || drawLogs.length===0){
        alert("å°šç„¡ç´€éŒ„");
        return;
      }

      // æŒ‰ä¸‹ä¸‹è¼‰å¾Œï¼šå–æ¶ˆé–ƒçˆ
      pdfBtn.classList.remove("blinking");

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"pt", format:"a4" });

      // å…ˆç•«ä¸€å¼µé«˜è§£æçš„ã€Œæ–‡å­—æ¸…å–®ã€canvasï¼Œå†è½‰æˆåœ–ç‰‡æ”¾å…¥ PDF
      const pageW = 595.28; // A4 pt
      const pageH = 841.89;

      // å»ºç«‹é«˜è§£æ canvasï¼ˆ2xï¼‰
      const scale = 2;
      const c = document.createElement("canvas");
      c.width  = Math.floor(pageW * scale);
      c.height = Math.floor(pageH * scale);
      const g = c.getContext("2d");

      // èƒŒæ™¯ç™½
      g.fillStyle = "#ffffff";
      g.fillRect(0,0,c.width,c.height);

      // æ–‡å­—ï¼šå›ºå®šé»‘è‰²
      g.fillStyle = "#000000";
      g.font = `${28*scale}px "Noto Sans TC", Arial`;
      g.textBaseline = "top";

      g.fillText("BlessingCards128 æŠ½ç±¤ç´€éŒ„", 40*scale, 40*scale);

      g.font = `${20*scale}px "Noto Sans TC", Arial`;
      let y = 90*scale;

      const lineH = 28*scale;
      const marginBottom = 60*scale;

      function drawLine(line){
        // è¶…å‡ºé é¢å°±æ›é ï¼šæŠŠç›®å‰ canvas æ”¾é€² PDFï¼Œå†æ¸…ç•«ä¸‹ä¸€é 
        if(y + lineH > c.height - marginBottom){
          const img = c.toDataURL("image/png");
          doc.addImage(img, "PNG", 0, 0, pageW, pageH);
          doc.addPage();

          // clear next page
          g.fillStyle = "#ffffff";
          g.fillRect(0,0,c.width,c.height);
          g.fillStyle = "#000000";
          g.font = `${28*scale}px "Noto Sans TC", Arial`;
          g.fillText("BlessingCards128 æŠ½ç±¤ç´€éŒ„ï¼ˆçºŒï¼‰", 40*scale, 40*scale);
          g.font = `${20*scale}px "Noto Sans TC", Arial`;
          y = 90*scale;
        }
        g.fillText(line, 40*scale, y);
        y += lineH;
      }

      for(const log of drawLogs){
        const ref = (log.ref || (window.VERSE_REF_MAP && window.VERSE_REF_MAP[log.verse]) || "");
        const line = `[${log.time}] ${log.name}ï½œæŠ½ä¸­ç¶“å¥ï¼š${log.verse}ï¼ˆ${ref}ï¼‰`;
        drawLine(line);
      }

      // æœ€å¾Œä¸€é 
      const img = c.toDataURL("image/png");
      doc.addImage(img, "PNG", 0, 0, pageW, pageH);

      doc.save("BlessingCards128_æŠ½ç±¤ç´€éŒ„.pdf");
    }catch(err){
      console.error(err);
      alert("PDF ç”¢ç”Ÿå¤±æ•—ï¼šè«‹æŸ¥çœ‹ Console éŒ¯èª¤è¨Šæ¯ã€‚");
    }
  }

  // ---------- init ----------
  function initUIFromState(){
    if(locked && nameList.length>=2){
      nameInput.value = nameList.join("ã€");
      drawWheel(nameList, currentRotation, true);

      if(usedNames.length >= nameList.length){
        setEndMessage(nameList.length);
        startBtn.disabled = true;
      }else if(awaitingSecondRound){
        setStatus(`ğŸ¯ ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${selectedName || ""}ã€\nè«‹æŒ‰ã€ŒæŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰ã€`, false);
        startBtn.disabled = true;
        secondBtn.style.display="inline-block";
        secondBtn.classList.add("blinking");
      }else{
        setStatus(`åå–®å·²è¼‰å…¥ï¼Œå…± ${nameList.length} ä½\nè«‹æŒ‰ã€Œé–‹å§‹æŠ½å§“å + ç¶“å¥ã€`, false);
        startBtn.disabled = false;
      }
    }else{
      drawWheel([], 0, true);
      setStatus("è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€", false);
    }
  }

  // bind events
  lockBtn.addEventListener("click", ()=>{
    // é€™è£¡ä¸è¦æ’­æ”¾ drum
    lockList();
  });

  startBtn.addEventListener("click", ()=>{
    startFirstRound();
  });

  secondBtn.addEventListener("click", ()=>{
    startSecondRound();
  });

  viewerBtn.addEventListener("click", ()=>{
    gotoViewer();
  });

  resetBtn.addEventListener("click", ()=>{
    resetAll();
  });

  pdfBtn.addEventListener("click", ()=>{
    exportPDF();
  });

  // åˆå§‹è¼‰å…¥
  loadStorage();
  initUIFromState();

  </script>
</body>
</html>