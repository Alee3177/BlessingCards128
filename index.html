<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>BlessingCards128｜v5.4</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  background:#fff8e7;
  font-family:"Noto Sans TC",sans-serif;
  text-align:center;
  padding:20px;
  color:#5b3a00;
}
h1{color:#b07500}

.logo{width:120px;margin-bottom:10px}

input{
  width:300px;
  padding:10px;
  font-size:18px;
  border-radius:8px;
  border:1px solid #bf8a3e;
}

button{
  background:#f7c76c;
  border:none;
  padding:10px 22px;
  border-radius:24px;
  font-size:16px;
  margin:6px;
  cursor:pointer;
}

#wheelBox{
  position:relative;
  width:380px;
  height:380px;
  margin:24px auto;
}

#wheel{
  width:380px;
  height:380px;
}

#pointer{
  position:absolute;
  top:-28px;
  left:50%;
  transform:translateX(-50%);
  font-size:44px;
  color:red;
  z-index:10;
}

#badge{
  position:absolute;
  top:12px;
  left:50%;
  transform:translateX(-50%);
  background:#fff;
  padding:6px 14px;
  border-radius:18px;
  font-size:18px;
  display:none;
}

#status{
  font-size:20px;
  margin-top:10px;
}
</style>
</head>

<body>

<h1>祝福經句紅包（v5.4）</h1>
<img src="logo3524.png" class="logo"><br>

<input id="nameInput" placeholder="輸入姓名，用、或空白分隔"><br>

<button onclick="lockList()">鎖定名單</button>
<button onclick="startFirstRound()">開始抽姓名</button>
<button id="secondBtn" onclick="startSecondRound()" style="display:none">抽紅包（第二輪）</button>
<button onclick="resetAll()">全部歸零</button>

<div id="wheelBox">
  <div id="pointer">▼</div>
  <div id="badge"></div>
  <canvas id="wheel" width="380" height="380"></canvas>
</div>

<div id="status">請輸入姓名並鎖定名單</div>

<script src="verseRefMap.js"></script>

<script>
/* ===== 音效（一定要在 click 當下播放） ===== */
const drumAudio = new Audio("audio/drum.mp3");
drumAudio.preload = "auto";

/* ===== 狀態 ===== */
let names = [];
let usedNames = [];
let locked = false;
let spinning = false;

let selectedIndex = null;   // 第一輪選到的 index
let selectedName = null;    // 第一輪選到的人

/* ===== Canvas ===== */
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const C = 190, R = 175;

/* ===== 工具 ===== */
function resetAll(){
  names=[]; usedNames=[]; locked=false;
  selectedIndex=null; selectedName=null;
  document.getElementById("nameInput").value="";
  document.getElementById("secondBtn").style.display="none";
  document.getElementById("badge").style.display="none";
  ctx.clearRect(0,0,380,380);
  status("已清空，請重新輸入姓名");
}

function status(t){
  document.getElementById("status").innerText=t;
}

function lockList(){
  const raw=document.getElementById("nameInput").value.trim();
  if(!raw){alert("請輸入姓名");return;}
  const arr=[...new Set(raw.split(/[,、\s]+/).filter(Boolean))];
  if(arr.length<2){alert("至少兩位");return;}
  names=arr;
  usedNames=[];
  locked=true;
  drawWheel(0);
  status(`名單已鎖定（${names.length} 位）`);
}

/* ===== 畫輪盤（只依角度） ===== */
function drawWheel(angle){
  ctx.clearRect(0,0,380,380);
  const n=names.length;
  if(n===0) return;
  const arc=2*Math.PI/n;

  ctx.save();
  ctx.translate(C,C);
  ctx.rotate(angle);
  ctx.translate(-C,-C);

  for(let i=0;i<n;i++){
    const a0=i*arc-Math.PI/2;
    const a1=a0+arc;

    ctx.beginPath();
    ctx.moveTo(C,C);
    ctx.arc(C,C,R,a0,a1);
    ctx.fillStyle=i%2?"#fcdca0":"#fde7b5";
    ctx.fill();
    ctx.strokeStyle="#fff";
    ctx.lineWidth=2;
    ctx.stroke();

    ctx.save();
    ctx.translate(C,C);
    ctx.rotate(a0+arc/2);
    ctx.textAlign="right";
    ctx.font="20px Noto Sans TC";
    ctx.fillStyle="#5b3a00";
    ctx.fillText(names[i],R-18,8);
    ctx.restore();
  }
  ctx.restore();
}

/* ===== 核心轉動（共用） ===== */
function spinToIndex(targetIndex, clockwise, onDone){
  spinning=true;
  const n=names.length;
  const arc=2*Math.PI/n;

  // 指針在 -90°，目標是 slice 中心
  const targetAngle = -(targetIndex*arc + arc/2);
  const direction = clockwise ? 1 : -1;
  const spins = direction * 6 * 2 * Math.PI;

  const start = performance.now();
  const duration = 4200;

  function easeOut(t){ return 1-Math.pow(1-t,3); }

  function anim(now){
    const p=Math.min((now-start)/duration,1);
    const angle = spins*easeOut(p) + targetAngle;
    drawWheel(angle);
    if(p<1){
      requestAnimationFrame(anim);
    }else{
      drawWheel(targetAngle);
      spinning=false;
      onDone && onDone();
    }
  }
  requestAnimationFrame(anim);
}

/* ===== 第一輪：抽姓名（逆時針） ===== */
function startFirstRound(){
  if(!locked || spinning) return;

  const remain = names
    .map((n,i)=>({n,i}))
    .filter(o=>!usedNames.includes(o.i));

  if(remain.length===0){
    alert("全部姓名已抽完");
    return;
  }

  drumAudio.currentTime=0;
  drumAudio.play().catch(()=>{});

  const pick = remain[Math.floor(Math.random()*remain.length)];
  selectedIndex = pick.i;
  selectedName = pick.n;

  status("第 1 輪：姓名輪盤抽籤中…");
  document.getElementById("badge").style.display="none";

  spinToIndex(selectedIndex,false,()=>{
    usedNames.push(selectedIndex);
    status(`第 1 輪完成：抽中「${selectedName}」`);
    document.getElementById("secondBtn").style.display="inline-block";
  });
}

/* ===== 第二輪：抽紅包（順時針，index 不變） ===== */
function startSecondRound(){
  if(spinning || selectedIndex===null) return;

  drumAudio.currentTime=0;
  drumAudio.play().catch(()=>{});

  status("第 2 輪：祝福經句輪盤抽籤中…");
  document.getElementById("badge").style.display="none";

  spinToIndex(selectedIndex,true,()=>{
    // 內部只抽經句
    const all = Object.keys(VERSE_REF_MAP);
    const verse = all[Math.floor(Math.random()*all.length)];
    const ref = VERSE_REF_MAP[verse] || "";

    document.getElementById("badge").innerText = `編號「${verse}」`;
    document.getElementById("badge").style.display="block";

    status(`第 2 輪完成：抽中經句「${verse}」`);
  });
}
</script>

</body>
</html>
