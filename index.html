<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆBlessingCards128ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    background: #fef9ec;
    font-family: "Noto Sans TC", sans-serif;
    text-align: center;
    padding: 20px;
}

/* æ¨™é¡Œ */
h1 {
    font-size: 24px;
    color: #a66b00;
    margin-bottom: 20px;
}

/* æŒ‰éˆ• */
.btn {
    background: #f7c86c;
    padding: 12px 22px;
    border-radius: 25px;
    font-size: 16px;
    color: #5a3d00;
    cursor: pointer;
    display: inline-block;
    margin: 6px;
    border: none;
}
.btn:hover {
    background: #f5b953;
}

/* å§“åé¡¯ç¤ºï¼ˆé–å®šå¾Œï¼‰ */
.name-list {
    margin-top: 15px;
    font-size: 20px;
    color: #5a3d00;
}
.name-item {
    padding: 6px 0;
    border-bottom: 1px solid #d8b98b;
    width: 140px;
    margin: 0 auto;
}

/* è¼ªç›¤å€åŸŸ */
#wheelContainer {
    position: relative;
    width: 380px;
    height: 380px;
    margin: 30px auto;
}

#wheelCanvas {
    width: 380px;
    height: 380px;
}

/* æŒ‡é‡ â–¼ */
#wheelPointer {
    position: absolute;
    top: -22px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 38px;
    color: red;
    z-index: 10;
}

/* è¨Šæ¯å€ */
#statusText {
    font-size: 20px;
    color: #b06b00;
    margin-top: 15px;
}
</style>
</head>

<body>

<h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆBlessingCards128ï¼‰</h1>

<input id="nameInput" type="text" placeholder="è¼¸å…¥æ‰€æœ‰å§“åï¼Œç”¨ã€Œï¼Œã€åˆ†éš”" style="width:80%;padding:10px;border-radius:8px;border:1px solid #ccc;"><br><br>

<button class="btn" onclick="lockNames()">ğŸ”’ é–å®šåå–®</button>
<button class="btn" onclick="resetAll()">ğŸ”„ å…¨éƒ¨æ­¸é›¶</button><br>
<button class="btn" onclick="startDraw()">ğŸ‰ é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
<button class="btn" onclick="window.location='index_category.html'">ğŸ“š åˆ†é¡æŠ½ç±¤</button><br>

<button class="btn" onclick="exportPDF()">ğŸ“„ æŠ½ç±¤ç´€éŒ„ PDF</button>

<!-- é¡¯ç¤ºé–å®šå¾Œçš„å§“åæ¸…å–® -->
<div id="nameList"></div>

<!-- è¼ªç›¤ -->
<div id="wheelContainer">
    <div id="wheelPointer">â–¼</div>
    <canvas id="wheelCanvas" width="380" height="380"></canvas>
</div>

<div id="statusText">è«‹é–å®šåå–®å¾Œ æŒ‰ã€Œé–‹å§‹æŠ½å§“å + ç¶“å¥ã€</div>

<script>
/* -------------------------
   è®Šæ•¸
------------------------- */
let names = [];
let usedNames = [];
let usedVerses = [];
let isLocked = false;

let wheelCanvas = document.getElementById("wheelCanvas");
let ctx = wheelCanvas.getContext("2d");

let spinning = false;

/* -------------------------
   é–å®šåå–®
------------------------- */
function lockNames() {
    let raw = document.getElementById("nameInput").value.trim();
    if (!raw) { alert("è«‹è¼¸å…¥å§“åï¼"); return; }

    names = raw.split("ï¼Œ").map(n => n.trim()).filter(n => n.length > 0);
    if (names.length < 2) { alert("è‡³å°‘éœ€è¦ 2 ä½ï¼"); return; }

    isLocked = true;
    usedNames = [];

    let listHTML = "";
    names.forEach(n => listHTML += `<div class="name-item">${n}</div>`);
    document.getElementById("nameList").innerHTML = listHTML;

    drawWheel(names);
}

/* -------------------------
   é‡ç½®
------------------------- */
function resetAll() {
    isLocked = false;
    names = [];
    usedNames = [];
    usedVerses = [];
    document.getElementById("nameList").innerHTML = "";
    document.getElementById("statusText").innerText = "è«‹é–å®šåå–®å¾Œ æŒ‰ã€Œé–‹å§‹æŠ½å§“å + ç¶“å¥ã€";
    ctx.clearRect(0,0,380,380);
}

/* -------------------------
   æŠ½ç±¤æµç¨‹ï¼ˆå§“å â†’ ç¶“å¥ï¼‰
------------------------- */
async function startDraw() {
    if (!isLocked) { alert("è«‹å…ˆé–å®šåå–®ï¼"); return; }
    if (spinning) return;

    let available = names.filter(n => !usedNames.includes(n));
    if (available.length === 0) {
        alert("æ‰€æœ‰å§“åçš†å·²å®ŒæˆæŠ½ç±¤ï¼è«‹æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€é‡æ–°é–‹å§‹ã€‚");
        return;
    }

    /* ---------- ç¬¬ 1 è¼ªï¼šå§“å ---------- */
    spinning = true;
    document.getElementById("statusText").innerText = "ç¬¬ 1 è¼ªï¼šæŠ½å§“åä¸­â€¦";
    let nameWinner = await spinWheel(names, "reverse");
    usedNames.push(nameWinner);

    document.getElementById("statusText").innerText =
        `ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${nameWinner}ã€`;

    await sleep(5000);

    /* ---------- ç¬¬ 2 è¼ªï¼šç¶“å¥ï¼ˆ001-128ï¼‰ ---------- */
    document.getElementById("statusText").innerText =
        "ç¬¬ 2 è¼ªï¼šç¥ç¦ç¶“å¥è¼ªç›¤ï¼ˆ001~128ï¼‰æŠ½ç±¤ä¸­â€¦";

    let verseList = Array.from({length:128}, (_,i)=> String(i+1).padStart(3,"0"));
    let verseWinner = await spinWheel(verseList, "normal");

    usedVerses.push(verseWinner);

    document.getElementById("statusText").innerText =
        `ç¬¬ 2 è¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ç·¨è™Ÿã€Œ${verseWinner}ã€`;

    await sleep(5000);

    /* ---------- è·³ viewer.html ---------- */
    window.location.href =
        `viewer.html?mode=name&name=${encodeURIComponent(nameWinner)}&verse=${verseWinner}`;

    spinning = false;
}

/* -------------------------
   è½‰ç›¤ï¼šç•«é¢å›ºå®šç‚ºåŸå§‹å§“åæ•¸é‡
------------------------- */
function drawWheel(itemList) {
    let count = itemList.length;
    let arc = Math.PI * 2 / count;

    ctx.clearRect(0,0,380,380);

    for (let i = 0; i < count; i++) {
        ctx.beginPath();
        ctx.fillStyle = i % 2 === 0 ? "#fde7b5" : "#fcdca0";
        ctx.moveTo(190, 190);
        ctx.arc(190, 190, 180, arc * i, arc * (i + 1));
        ctx.fill();

        ctx.save();
        ctx.translate(190, 190);
        ctx.rotate(arc * i + arc / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#5a3d00";
        ctx.font = "18px Noto Sans TC";
        ctx.fillText(itemList[i], 160, 6);
        ctx.restore();
    }
}

/* -------------------------
   è½‰å‹•è¼ªç›¤
------------------------- */
function spinWheel(list, direction="normal") {
    return new Promise(resolve => {

        let total = list.length;
        let arc = Math.PI * 2 / total;

        let rotation = Math.random() * Math.PI * 4 + Math.PI * 6; // å¤šåœˆ
        if (direction === "reverse") rotation *= -1;

        let start = performance.now();

        function animate(now) {
            let progress = (now - start) / 5000; // 5 ç§’
            if (progress >= 1) progress = 1;

            let angle = rotation * easeOut(progress);

            ctx.save();
            ctx.clearRect(0,0,380,380);
            ctx.translate(190, 190);
            ctx.rotate(angle);
            ctx.translate(-190,-190);
            drawWheel(list);
            ctx.restore();

            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                let index = Math.floor((total - (angle % (2*Math.PI)) / arc) % total);
                resolve(list[index]);
            }
        }
        requestAnimationFrame(animate);
    });
}

function easeOut(t){ return 1 - Math.pow(1 - t, 3); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* -------------------------
   PDF åŒ¯å‡º
------------------------- */
function exportPDF() {
    alert("PDF åŠŸèƒ½å°šæœªå•Ÿç”¨ï¼ˆç­‰å¾…ä½ æä¾› font-base64 æˆ–å¤–éƒ¨å­—å‹ï¼‰");
}
</script>

</body>
</html>
