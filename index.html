<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</title>

<!-- è®“ logo å„ªå…ˆè¼‰å…¥ï¼ˆæ”¹å–„å‡ºç¾å¾ˆæ…¢ï¼‰ -->
<link rel="preload" as="image" href="logo3524.png">

<style>
body{
  font-family:"Noto Sans TC",system-ui;
  background:#fbf2df;
  text-align:center;
  margin:0;
  padding:16px;
  color:#5b3a00;
}
.logo{width:220px;margin:10px auto 0;display:block;}

#nameInput{
  width:90%;max-width:480px;padding:10px 14px;
  margin-top:10px;border-radius:10px;border:2px solid #e3c78c;
  font-size:18px;text-align:center;box-sizing:border-box;
}

.btn-row{
  margin-top:8px;
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
}
.btn{
  min-width:110px;
  padding:8px 16px;
  border-radius:999px;
  border:none;
  background:#f4b63a;
  color:#5b3a00;
  font-size:15px;
  font-weight:600;
  box-shadow:0 3px 0 #d59b25;
  cursor:pointer;
}
.btn:disabled{
  background:#f0ddaa;
  cursor:default;
}

.blink-btn{animation:flash .8s infinite alternate;}
@keyframes flash{from{opacity:1}to{opacity:.35}}

#wheel-container{
  position:relative;
  width:360px;
  height:360px;
  margin:16px auto;
}
#wheel{
  width:360px;
  height:360px;
}
#hl-svg{
  position:absolute;
  left:0;
  top:0;
  width:360px;
  height:360px;
  pointer-events:none;
}
#confettiCanvas{
  position:absolute;
  left:0;
  top:0;
  width:360px;
  height:360px;
  pointer-events:none;
}

@keyframes blink{from{opacity:1;}to{opacity:.25;}}
.blink{animation:blink .55s ease-in-out infinite alternate;}

#centerText{
  position:absolute;
  left:0;
  top:0;
  width:360px;
  height:360px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  pointer-events:none;
  font-size:18px;
  font-weight:700;
  white-space:pre-line;
}
#summaryBox{
  margin-top:10px;
  white-space:pre-line;
  font-weight:700;
}
/* PDF å®Œæˆå¯ä¸‹è¼‰ç‹€æ…‹ */
.btn-pdf-ready{
  background:#1976D2 !important;
  color:#fff !important;
  box-shadow:0 3px 0 #0d47a1;
}
/* å…¨éƒ¨æ­¸é›¶ï¼šå®Œæˆæ…‹ï¼ˆå±éšªç‹€æ…‹ï¼‰ */
.btn-reset-danger{
  background:#E53935;
  color:#fff;
  box-shadow:0 3px 0 #B71C1C;
}

/* ===== ä¸»æ§ç‹€æ…‹ç‡ˆ ===== */
.status-bar{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin:8px auto 4px auto;
  font-size:14px;
  font-weight:700;
}

/* ğŸ“¡ ä¸»æ§ç‹€æ…‹ç‡ˆæ•´é«”æ”¾å¤§ 20% */
.status-bar{
  transform: scale(1.2);
  transform-origin: center;
}

.status-bar .dot{
  width:12px;
  height:12px;
  border-radius:50%;
  background:#999;
  box-shadow:0 0 4px rgba(0,0,0,.3);
}

/* ç¶ ï¼šä¸»æ§æ­£å¸¸ */
.status-ok .dot{
  background:#2e7d32;
  box-shadow:0 0 8px rgba(46,125,50,.8);
}

/* é»ƒï¼šæ“ä½œä¸­ */
.status-warn .dot{
  background:#f9a825;
  box-shadow:0 0 8px rgba(249,168,37,.8);
}

/* ç´…ï¼šé–å®š / é›™ä¸»æŒ / éŒ¯èª¤ */
.status-error .dot{
  background:#c62828;
  box-shadow:0 0 8px rgba(198,40,40,.8);
}

/* ===== ä¸»æŒæ©Ÿ / è§€çœ¾ç‹€æ…‹é¢æ¿ ===== */
#hostPanel {
  position: fixed;
  top: 12px;
  right: 12px;
  background: rgba(0,0,0,0.75);
  color: #fff;
  padding: 10px 14px;
  border-radius: 10px;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  z-index: 9999;
  box-shadow: 0 6px 20px rgba(0,0,0,0.35);
}

#hostStatus.ok {
  color: #4caf50;
  font-weight: bold;
}

#hostStatus.warn {
  color: #ffb300;
  font-weight: bold;
}

#viewerStatus.ok {
  color: #03a9f4;
}

#viewerStatus.warn {
  color: #aaa;
}

/* =========================
   ğŸ“± QR Panelï¼ˆç©©å®šåˆä½µç‰ˆï¼‰
========================= */
#qrBox {
  margin-top: 8px;
  text-align: center;
  width: 200px;
  max-width: 200px;
  padding: 10px;
  box-sizing: border-box;
  cursor: pointer;
}

/* QR æœ¬é«”å°ºå¯¸ */
#qrCanvas {
  width: 160px;
  height: 160px;
  margin: 0 auto;
}

/* ä¿è­‰ QR ä¸æœƒæº¢å‡º */
#qrCanvas canvas,
#qrCanvas img {
  max-width: 160px;
  max-height: 160px;
  display: block;
  margin: 0 auto;
  border-radius: 8px;
  background: #fff;
  padding: 6px;
}

.qr-title {
  font-size: 13px;
  margin-bottom: 4px;
  color: #ffd54f;
  font-weight: bold;
}

.qr-hint {
  font-size: 11px;
  opacity: 0.85;
  margin-top: 2px;
}

/* æ‰‹æ©Ÿ QR ç¸®å°æ¨¡å¼ */
@media (max-width: 768px) {
  #hostPanel {
    transform: scale(0.75);
    transform-origin: top right;
  }
}

/* æ”¶åˆç‹€æ…‹ */
#qrBox.collapsed #qrCanvas,
#qrBox.collapsed .qr-hint,
#qrBox.collapsed button {
  display: none;
}

#qrBox.collapsed::after {
  content: "ğŸ“± é»æˆ‘å±•é–‹ QR";
  display: block;
  color: #ffd54f;
  font-size: 12px;
  margin-top: 6px;
}

/* çœ‹ç´…åŒ…é–ƒçˆæç¤º */
.blink-all {
  animation: blinkPulse 1s infinite;
}

/* ============================= */
/* ä¸»æ“ä½œæŒ‰éˆ•çµ±ä¸€é–ƒçˆæ¨£å¼ */
/* ============================= */
@keyframes mainBlink {
  0% {
    background-color: #f6c453;
    color: #000;
    box-shadow: 0 0 0 rgba(255,193,7,0.0);
    transform: scale(1);
  }
  50% {
    background-color: #ffeb99;
    color: #8b0000;
    box-shadow: 0 0 16px rgba(255,200,0,0.9);
    transform: scale(1.05);
  }
  100% {
    background-color: #f6c453;
    color: #000;
    box-shadow: 0 0 0 rgba(255,193,7,0.0);
    transform: scale(1);
  }
}

.blink-all {
  animation: mainBlink 1s infinite;
}

/* ç®¡ç†åŠŸèƒ½ - å¼·åˆ¶è§£é™¤ä¸»æŒæ©Ÿ */
.danger-btn {
  background: #b00020;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 16px;
  margin-top: 8px;
  cursor: pointer;
  font-weight: bold;
}

.danger-btn:hover {
  background: #d00030;
}

</style>

<script src="verseRefMap.js?v=20260105"></script>

<!-- â‘  jsPDF ä¸»ç¨‹å¼ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- â‘¡ QRCode æœ¬åœ°å¼•æ“ï¼ˆä¸€å®šè¦åœ¨ QR ç¨‹å¼ç¢¼å‰ï¼‰ -->

</head>

<body>

<img
  src="logo3524.png"
  class="logo"
  loading="eager"
  decoding="async"
  onerror="this.style.display='none'; console.warn('âš  logo3524.png è¼‰å…¥å¤±æ•—');"
/>

<h2>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h2>

<div id="masterStatus" class="status-bar">
  <span class="dot"></span>
  <span class="label">ç³»çµ±åˆå§‹åŒ–ä¸­</span>
</div>

<input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼Œå¯ç”¨ç©ºç™½æˆ–é€—è™Ÿåˆ†éš”">

<!-- ç¬¬ä¸€è¡Œ -->
<div class="btn-row">
  <button id="lockBtn" class="btn">é–å®šåå–®</button>
  <button id="spinBtn" class="btn" disabled>é–‹å§‹æŠ½å§“åï¼‹ç¶“å¥ï¼ˆç¬¬ä¸€è¼ªï¼‰</button>
</div>

<!-- ç¬¬äºŒè¡Œ -->
<div class="btn-row">
  <button id="viewBtn" class="btn" disabled>çœ‹ç´…åŒ…</button>
  <button id="secondBtn" class="btn" disabled>æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
</div>

<!-- ç¬¬ä¸‰è¡Œ -->
<div class="btn-row">
  <button id="resetBtn" class="btn">å…¨éƒ¨æ­¸é›¶</button>
  <button id="pdfBtn" class="btn" disabled>æŠ½ç±¤ç´€éŒ„ PDF</button>
</div>

<!-- ç®¡ç†åŠŸèƒ½ -->
<div class="btn-row admin-row">
  <button id="btnForceRelease" class="danger-btn">
    ğŸ”“ å¼·åˆ¶è§£é™¤ä¸»æŒæ©Ÿä½”ç”¨
  </button>
</div>

<div id="wheel-container">
  <canvas id="wheel" width="360" height="360"></canvas>
  <canvas id="confettiCanvas" width="360" height="360"></canvas>
  <svg id="hl-svg" viewBox="0 0 360 360"></svg>
  <div id="centerText"></div>
</div>

<div id="status">è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®</div>
<div id="result"></div>
<div id="summaryBox"></div>

<div id="hostPanel">
  <div id="hostStatus">ğŸ¤ ä¸»æŒæ©Ÿé›¢ç·š</div>
  <div id="viewerStatus">ğŸ‘¥ å°šç„¡è§€çœ¾</div>
<div id="qrCanvas"></div>
  <div class="qr-hint">è«‹ç”¨æ‰‹æ©Ÿæƒæ</div>

  <button id="copyViewerLink" class="qr-copy-btn">
    ğŸ“‹ è¤‡è£½çœ‹ç´…åŒ…é€£çµ
  </button>
</div>

<audio id="drum" preload="auto" playsinline src="audio/drum.mp3">
  <source src="audio/drum.mp3" type="audio/mpeg">
</audio>

<audio id="winSound" preload="auto" playsinline src="audio/win.mp3">
  <source src="audio/win.mp3" type="audio/mpeg">
</audio>

<!-- ===============================
  BlessingCards128 Resource Preloader
  é è¼‰ LOGO / éŸ³æ•ˆ / ç´…åŒ…åœ–ç‰‡
================================ -->
<script>
/* ==== ä¸»æ§æ——æ¨™ ==== */
const IS_MASTER = true;

/* ==== é–‹ç™¼ / ç¾å ´æ§åˆ¶ ==== */
const DISABLE_MASTER_LOCK = false;

/* ==== ä¸»æŒæ©Ÿé–å®šè­˜åˆ¥ï¼ˆé˜²å¤šä¸»æŒï¼‰ ==== */
const TAB_ID = Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 6);
const HEARTBEAT_TTL = 5000; // 5 ç§’å…§è¦–ç‚ºã€Œæ´»èºä¸»æŒæ©Ÿã€

const MASTER_KEY = "BLESSING_MASTER";

function claimMaster(){
  // âœ… åœç”¨è·¨åˆ†é /è·¨è£ç½®é–å®šï¼šä¸€å¾‹è¦–ç‚ºå¯æ“ä½œ
  try {
    localStorage.removeItem("hostLock");
    localStorage.removeItem("hostTimestamp");
    localStorage.removeItem("hostId");
  } catch(e) {}
  return true;
}

function heartbeatMaster() {
  if (!IS_MASTER) return;
  localStorage.setItem(MASTER_KEY, JSON.stringify({
    tabId: TAB_ID,
    heartbeat: Date.now()
  }));
}

setInterval(heartbeatMaster, 2000);

// ğŸ§¹ é—œé–‰/åˆ·æ–°åˆ†é æ™‚é‡‹æ”¾ä¸»æŒé–ï¼ˆé¿å…é•·æ™‚é–“å¡ä½ï¼‰
window.addEventListener("beforeunload", () => {
  try {
    const cur = JSON.parse(localStorage.getItem(MASTER_KEY) || "null");
    if (cur && cur.tabId === TAB_ID) localStorage.removeItem(MASTER_KEY);
  } catch {}
});

// âœ… åˆ‡åˆ°èƒŒæ™¯ä¹Ÿç¶­æŒå¿ƒè·³ï¼ˆæ‰‹æ©Ÿé–å±å¸¸è¦‹ï¼‰
document.addEventListener("visibilitychange", () => {
  if (!document.hidden) heartbeatMaster();
});

(function preloadResources(){

  console.log("ğŸ”¥ BlessingCards128 è³‡æºæš–æ©Ÿä¸­...");

  /* ===== 1ï¸âƒ£ LOGO ===== */
  const preloadLogo = new Image();
  preloadLogo.onload = () => {
    console.log("âœ… LOGO é è¼‰å®Œæˆ");
  };
  preloadLogo.onerror = () => {
    console.warn("âš  LOGO é è¼‰å¤±æ•—ï¼šlogo3524.png");
  };
  preloadLogo.src = "logo3524.png";

  /* ===== 2ï¸âƒ£ éŸ³æ•ˆ ===== */
  const preloadDrum = new Audio();
  preloadDrum.src = "audio/drum.mp3";
  preloadDrum.load();

  const preloadWin = new Audio();
  preloadWin.src = "audio/win.mp3";
  preloadWin.load();

  /* ===== 3ï¸âƒ£ ç´…åŒ…åœ–ç‰‡ï¼ˆæ‰‹æ©Ÿé™è¼‰ï¼‰===== */
  const MAX_PRELOAD = (window.innerWidth < 768 ? 24 : 128);
  const loaded = { count: 0 };

  for (let i = 1; i <= MAX_PRELOAD; i++) {
    const img = new Image();
    const no = String(i).padStart(3, "0");

    img.onload = () => {
      loaded.count++;
      if (loaded.count === MAX_PRELOAD) {
        console.log(`âœ… ç´…åŒ…åœ–ç‰‡æš–æ©Ÿå®Œæˆï¼ˆ${MAX_PRELOAD} å¼µï¼‰`);
      }
    };

    img.onerror = () => {
      console.warn("âš  ç„¡æ³•é è¼‰åœ–ç‰‡:", "cards/" + no + ".png");
    };

    img.src = "cards/" + no + ".png";
  }

})();


<script>
// =============================
// ğŸ“± QR Code ç”¢ç”Ÿ / æ›´æ–°ï¼ˆå”¯ä¸€å…¥å£ï¼Œç©©å®šç‰ˆï¼‰
// =============================



// =============================
// QR é¢æ¿äº’å‹• + è¤‡è£½é€£çµ
// =============================
document.addEventListener("DOMContentLoaded", () => {
  const qrBox = document.getElementById("qrBox");
  const copyBtn = document.getElementById("copyViewerLink");

  if (qrBox) {
    qrBox.classList.remove("collapsed"); // é è¨­å±•é–‹
    qrBox.onclick = () => {
      qrBox.classList.toggle("collapsed");
    };
  }

  if (copyBtn) {
    copyBtn.onclick = (e) => {
      e.stopPropagation();

      if (!window.currentVerse) {
        alert("å°šæœªæŠ½å‡ºç¶“å¥ï¼Œç„¡æ³•ç”¢ç”Ÿé€£çµ");
        return;
      }

      const base =
        location.origin +
        location.pathname.replace(/\/[^\/]*$/, "/");

      const url =
        base +
        "viewer.html" +
        "?no=" + encodeURIComponent(window.currentVerse) +
        "&name=" +
        encodeURIComponent(
          (window.names && window.lastWinnerIndex != null)
            ? window.names[window.lastWinnerIndex] || ""
            : ""
        );

      navigator.clipboard.writeText(url).then(() => {
        alert("å·²è¤‡è£½é€£çµåˆ°å‰ªè²¼ç°¿");
      });
    };
  }
});
</script>
	
<script>
// =============================
// ğŸ‘¥ Viewer è¨ˆæ•¸ï¼ˆä¿å‘½ç‰ˆï¼‰
// =============================
if (typeof updateViewerCount !== "function") {
  function updateViewerCount() {
    const KEY = "BLESSING_VIEWERS";
    const TTL = 30000;

    let viewers = {};
    try {
      viewers = JSON.parse(localStorage.getItem(KEY) || "{}");
    } catch {
      viewers = {};
    }

    const now = Date.now();
    let count = 0;

    Object.keys(viewers).forEach(id => {
      if (now - viewers[id] < TTL) {
        count++;
      } else {
        delete viewers[id];
      }
    });

    localStorage.setItem(KEY, JSON.stringify(viewers));

    const el = document.getElementById("viewerStatus");
    if (!el) return;

    if (count > 0) {
      el.textContent = `ğŸ‘¥ è§€çœ¾é€£ç·šä¸­ (${count})`;
      el.className = "ok";
    } else {
      el.textContent = "ğŸ‘¥ å°šç„¡è§€çœ¾";
      el.className = "warn";
    }
  }
}

//æ¯3ç§’æ›´æ–°ä¸€æ¬¡
setInterval(updateViewerCount, 3000);

// =============================
// ğŸ Red Envelope Logic (Bæ–¹æ¡ˆ)
// =============================
function showRedEnvelope(verse) {
  const panel = document.getElementById("redEnvelopePanel");
  const img = document.getElementById("envelopeImg");
  const label = document.getElementById("envelopeVerse");

  if (!panel || !img || !label) return;

  label.textContent = verse;
  img.onload = () => {
    panel.style.display = "block";
    playWin();
  };
  img.onerror = () => {
    alert("æ‰¾ä¸åˆ°åœ–ç‰‡: cards/" + verse + ".png");
  };
  img.src = "cards/" + verse + ".png";
}

// ä¸‹è¼‰ç´…åŒ…åœ–ç‰‡
function downloadEnvelope() {
  const img = document.getElementById("envelopeImg");
  if (!img || !img.complete) {
    alert("åœ–ç‰‡å°šæœªè¼‰å…¥å®Œæˆ");
    return;
  }

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  canvas.width = img.naturalWidth;
  canvas.height = img.naturalHeight;
  ctx.drawImage(img, 0, 0);

  canvas.toBlob(blob => {
    if (!blob) return;
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "verse_" + document.getElementById("envelopeVerse").textContent + ".png";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
}

// ä¸‹ä¸€ä½ï¼ˆä¿ç•™å·²æŠ½åå–®/ç¶“å¥ï¼‰
function nextPerson() {
  const panel = document.getElementById("redEnvelopePanel");
  if (panel) panel.style.display = "none";

  currentVerse = null;
  systemState = SYS_STATE.INIT;
  rotating = false;
  applyUIState();
}

// ç¶å®šæŒ‰éˆ•
document.addEventListener("DOMContentLoaded", () => {
  const d = document.getElementById("downloadEnvelopeBtn");
  const n = document.getElementById("nextPersonBtn");
  if (d) d.onclick = downloadEnvelope;
  if (n) n.onclick = nextPerson;
});

</script>


<!-- =============================
 ğŸ Red Envelope Panel (Single Page Mode)
============================= -->
<div id="redEnvelopePanel" style="display:none; margin-top:20px; padding:12px; border:2px solid #f6c453; border-radius:12px; background:#1a1a1a; color:#ffd54f;">
  <div style="font-weight:bold; margin-bottom:6px;">ğŸ æŠ½ä¸­ç´…åŒ…ç¶“å¥ <span id="envelopeVerse"></span></div>
  <img id="envelopeImg" style="max-width:100%; border-radius:8px; background:#fff; padding:6px;" />
  <div style="margin-top:10px;">
    <button id="downloadEnvelopeBtn" class="btn">ğŸ“¥ ä¸‹è¼‰ç´…åŒ…åœ–ç‰‡</button>
    <button id="nextPersonBtn" class="btn">â¡ ä¸‹ä¸€ä½</button>
  </div>
</div>

</body>
</html>
