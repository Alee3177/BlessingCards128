<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>BlessingCards128 - 抽姓名 + 經句</title>

<style>
:root {
  --bg: #fff7e6;
  --brown-text: #8a5500;
  --brown-title: #b37500;
  --gold-light: #ffe9a3;
  --gold-mid: #ffd166;
  --gold-dark: #e8a838;
}

body {
  margin: 0;
  background: var(--bg);
  font-family: "NotoSansTC", sans-serif;
  text-align: center;
  color: var(--brown-text);
}

.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px 16px 40px;
}

h1 {
  font-size: 26px;
  margin: 12px 0;
  color: var(--brown-title);
}

textarea {
  width: 100%;
  max-width: 520px;
  padding: 12px;
  font-size: 16px;
  border-radius: 12px;
  border: 1px solid #d0a85c;
  font-family: "NotoSansTC";
  background: white;
}

.btn {
  min-width: 180px;
  padding: 12px 20px;
  margin: 8px;
  border: none;
  border-radius: 999px;
  background: linear-gradient(180deg, var(--gold-light), var(--gold-mid));
  font-size: 18px;
  font-weight: 600;
  color: var(--brown-text);
  box-shadow: 0 3px 6px rgba(0,0,0,0.18);
  cursor: pointer;
}

.btn:hover {
  background: linear-gradient(180deg, var(--gold-mid), var(--gold-dark));
}

#wheelWrapper {
  margin-top: 40px;
  position: relative;
  width: 320px;
  margin-left: auto;
  margin-right: auto;
}

.pointer {
  position: absolute;
  left: 50%;
  top: -32px;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 18px solid transparent;
  border-right: 18px solid transparent;
  border-top: 32px solid red;
  z-index: 10;
}

canvas {
  width: 100%;
  height: auto;
}

#resultArea {
  margin-top: 20px;
  font-size: 22px;
  min-height: 2.5em;
}

#verseCount {
  margin-top: 10px;
  margin-bottom: 40px;
  font-size: 15px;
}
</style>

<!-- 載入字型 Base64（外部檔案） -->
<script src="font_base64.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- 音效：drumroll + win -->
<audio id="drumroll" src="audio/drumroll.mp3" preload="auto"></audio>
<audio id="winSound" src="audio/win.mp3" preload="auto"></audio>

</head>
<body>

<div class="container">
  <h1>抽姓名（BlessingCards128）</h1>

  <textarea id="nameInput" placeholder="請輸入姓名，以逗號分隔"></textarea>

  <div>
    <button class="btn" onclick="startNameSpin()">開始抽姓名</button>
    <button class="btn" onclick="goCategory()">分類抽籤</button>
  </div>

  <div id="verseCount">已抽經句：0 / 128</div>

  <div id="wheelWrapper">
    <div class="pointer"></div>
    <canvas id="nameWheel" width="320" height="320"></canvas>
  </div>

  <div id="resultArea"></div>

  <div>
    <button class="btn" onclick="resetAll()">全部歸零</button>
    <button class="btn" onclick="exportPDF()">抽籤紀錄 PDF</button>
  </div>
</div>
<script>
/* ========= 轉盤邏輯 ========= */

const POINTER_ANGLE = -Math.PI / 2;
let canvas, ctx;
let names = [];
let usedNames = [];
let usedVerses = [];
let spinning = false;
let currentWinner = "";

/* 音效 DOM */
let drumrollSound, winSound;

document.addEventListener("DOMContentLoaded", () => {
  canvas = document.getElementById("nameWheel");
  ctx = canvas.getContext("2d");

  drumrollSound = document.getElementById("drumroll");
  winSound = document.getElementById("winSound");

  usedNames = JSON.parse(localStorage.getItem("usedNamesAll") || "[]");
  usedVerses = JSON.parse(localStorage.getItem("usedVersesAll") || "[]");

  updateVerseCount();
  updateNames();

  /* ★ 行動裝置第一次點擊解鎖音效 */
  document.body.addEventListener("touchstart", () => {
    drumrollSound.play().catch(()=>{});
    winSound.play().catch(()=>{});
  }, { once: true });

});

/* 更新輸入姓名 */
function updateNames(){
  names = document.getElementById("nameInput").value
    .split(",")
    .map(s => s.trim())
    .filter(s => s.length > 0);

  drawWheel(0);
}

/* ========= 畫輪盤（含白色分隔線） ========= */
function drawWheel(angle){
  ctx.clearRect(0,0,320,320);
  ctx.save();

  ctx.translate(160,160);
  ctx.rotate(angle);
  ctx.translate(-160,-160);

  const count = names.length || 1;
  const arc = 2 * Math.PI / count;

  for(let i=0; i<count; i++){
    const start = i * arc;
    const end = start + arc;

    /* 扇形底色 */
    ctx.beginPath();
    ctx.moveTo(160,160);
    ctx.arc(160,160,160,start,end);
    ctx.closePath();

    ctx.fillStyle = i % 2 === 0 ? "#ffe6a1" : "#ffd48a";
    ctx.fill();

    /* 白色分隔線（你選 A） */
    ctx.strokeStyle = "white";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(160,160);
    ctx.lineTo(160 + 160*Math.cos(start), 160 + 160*Math.sin(start));
    ctx.stroke();

    /* 顯示姓名 */
    if(names[i]){
      const mid = start + arc/2;
      ctx.save();
      ctx.translate(160,160);
      ctx.rotate(mid);
      ctx.font = "bold 18px NotoSansTC";
      ctx.textAlign = "right";
      ctx.fillStyle = "#8a5500";
      ctx.fillText(names[i], 145, 5);
      ctx.restore();
    }
  }

  ctx.restore();
}

/* ========= 抽姓名動畫 ========= */
function startNameSpin(){
  if(spinning) return;

  updateNames();
  if(names.length === 0){
    alert("請輸入姓名");
    return;
  }

  const available = names.filter(n => !usedNames.includes(n));
  if(available.length === 0){
    alert("所有姓名已抽完！");
    return;
  }

  /* 隨機選一個得主 */
  const winner = available[Math.floor(Math.random()*available.length)];
  currentWinner = winner;

  const count = names.length;
  const arc = 2 * Math.PI / count;
  const index = names.indexOf(winner);
  const mid = index*arc + arc/2;

  /* 設定旋轉圈數（6 圈） */
  const spins = 6;
  const angleFinal = spins * 2 * Math.PI + (POINTER_ANGLE - mid);

  spinning = true;
  let startTime = null;
  const duration = 8000;

  /* ★ 播放鼓聲 drumroll */
  drumrollSound.currentTime = 0;
  drumrollSound.play().catch(()=>{});

  function animate(ts){
    if(!startTime) startTime = ts;
    const t = (ts - startTime) / duration;
    const eased = 1 - Math.pow(1 - t, 3);
    const angle = eased * angleFinal;

    drawWheel(angle);

    if(t < 1){
      requestAnimationFrame(animate);
    } else {
      spinning = false;
      finalizeWinner(winner);
    }
  }
  requestAnimationFrame(animate);
}

/* ========= 抽姓名完成 ========= */
function finalizeWinner(winner){
  /* 停 drumroll，播放 win */
  drumrollSound.pause();
  winSound.currentTime = 0;
  winSound.play().catch(()=>{});

  if(!usedNames.includes(winner)){
    usedNames.push(winner);
    localStorage.setItem("usedNamesAll", JSON.stringify(usedNames));
  }

  document.getElementById("resultArea").innerHTML =
    `抽中：<b>${winner}</b><br>
     <button class="btn" onclick="drawVerse()">抽經句</button>`;
}

/* ========= 抽經句（跳 viewer.html）加入經句紀錄 ========= */
function drawVerse(){
  if(!currentWinner){
    alert("請先抽姓名");
    return;
  }

  if(usedVerses.length >= 128){
    alert("經句已抽完！");
    return;
  }

  const remaining = [];
  for(let i=1;i<=128;i++){
    if(!usedVerses.includes(i)) remaining.push(i);
  }

  const verse = remaining[Math.floor(Math.random()*remaining.length)];

  usedVerses.push(verse);
  localStorage.setItem("usedVersesAll", JSON.stringify(usedVerses));

  updateVerseCount();

  const no = String(verse).padStart(3,"0");
  const encodedName = encodeURIComponent(currentWinner);

  /* ★★★ 新增：寫入抽籤紀錄（首頁沒有分類 → 給空字串） */
  addLogEntry(currentWinner, "", no, "");

  window.location = `viewer.html?no=${no}&name=${encodedName}`;
}

/* ========= 更新經句統計 ========= */
function updateVerseCount(){
  document.getElementById("verseCount").textContent =
    `已抽經句：${usedVerses.length} / 128`;
}

/* ========= 重置全部資料 ========= */
function resetAll(){
  if(!confirm("確定全部清除？")) return;

  usedNames = [];
  usedVerses = [];

  localStorage.setItem("usedNamesAll","[]");
  localStorage.setItem("usedVersesAll","[]");
  localStorage.setItem("drawLogs","[]");

  document.getElementById("resultArea").innerHTML = "";
  updateVerseCount();
  drawWheel(0);
}

/* ========= 前往分類抽籤 ========= */
function goCategory(){
  window.location = "index_category.html";
}

/* ========= 抽籤紀錄寫入 ========= */
function addLogEntry(name, category, verseNo, verseRef){
  let logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
  logs.push({
    time: new Date().toLocaleString(),
    name,
    category,
    verseNo,
    verseRef
  });
  localStorage.setItem("drawLogs", JSON.stringify(logs));
}

/* ========= 匯出 PDF ========= */
function exportPDF(){
  let logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");

  if(!logs.length){
    alert("目前沒有抽籤紀錄！");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  /* ★ 正確掛載你的 font_base64.js 字型 ★ */
  doc.addFileToVFS(
    "NotoSansTC.ttf",
    window.PDF_FONT.normal   /* ★ 你提供的字型 Base64 在這裡 */
  );
  doc.addFont("NotoSansTC.ttf","NotoSansTC","normal");
  doc.setFont("NotoSansTC","normal");

  doc.setFontSize(18);
  doc.text("BlessingCards128 抽籤紀錄", 40, 40);

  let y = 70;
  doc.setFontSize(12);

  logs.forEach(log => {
const line =
  `[${log.time}] ${log.name}`
  + (log.category ? `｜分類：${log.category}` : "")
  + `｜經句：${log.verseNo}`;

    const split = doc.splitTextToSize(line, 515);

    split.forEach(t=>{
      if(y > 780){
        doc.addPage();
        doc.setFont("NotoSansTC","normal");
        y = 40;
      }
      doc.text(t, 40, y);
      y += 18;
    });
  });

  doc.save("抽籤紀錄.pdf");
}
</script>

</body>
</html>
