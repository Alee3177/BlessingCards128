<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>祝福經句紅包（應許等您拿）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  background:#fff8e7;
  font-family:"Noto Sans TC", system-ui;
  text-align:center;
  padding:20px;
  color:#5b3a00;
}
h1{color:#b07500;margin-bottom:8px;}
.logo{width:120px;margin-bottom:12px;}

input{
  width:280px;
  padding:10px;
  font-size:18px;
  border-radius:8px;
  border:1px solid #bf8a3e;
}

button{
  margin:6px;
  padding:12px 22px;
  font-size:18px;
  border:none;
  border-radius:24px;
  background:#f7c76c;
  color:#5b3a00;
  cursor:pointer;
}
button:disabled{opacity:.45;cursor:not-allowed;}

#wheelBox{
  position:relative;
  width:380px;
  height:380px;
  margin:20px auto;
}
#pointer{
  position:absolute;
  top:-28px;
  left:50%;
  transform:translateX(-50%);
  font-size:46px;
  color:red;
  z-index:10;
}
canvas{background:transparent;}

#status{
  min-height:32px;
  font-size:20px;
  color:#a56b00;
  margin-top:6px;
}
</style>
</head>

<body>

<h1>祝福經句紅包（應許等您拿）</h1>
<img src="logo3524.png" class="logo">

<br>
<input id="nameInput" placeholder="輸入姓名，用逗號或空白分隔">
<br>

<button id="lockBtn">鎖定名單</button>
<button id="startBtn" disabled>開始抽姓名</button>
<button id="resetBtn">全部歸零</button>
<button id="pdfBtn">抽籤紀錄 PDF</button>

<div id="wheelBox">
  <div id="pointer">▼</div>
  <canvas id="wheel" width="380" height="380"></canvas>
</div>

<div id="status">請輸入姓名並鎖定名單</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* =========================
   v7.4 STABLE CORE
========================= */

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const CENTER = 190;
const RADIUS = 180;

const nameInput = document.getElementById("nameInput");
const lockBtn = document.getElementById("lockBtn");
const startBtn = document.getElementById("startBtn");
const resetBtn = document.getElementById("resetBtn");
const pdfBtn = document.getElementById("pdfBtn");
const status = document.getElementById("status");

let names = [];
let usedNames = [];
let logs = [];

let locked = false;
let spinning = false;
let currentAngle = 0;

/* -------- 音效（只在真正轉動時） -------- */
function playDrum(){
  const a = new Audio("audio/drum.mp3");
  a.play().catch(()=>{});
}

/* -------- 畫輪盤（靜態） -------- */
function drawWheel(){
  ctx.clearRect(0,0,380,380);
  if(names.length===0) return;

  const arc = Math.PI*2/names.length;

  for(let i=0;i<names.length;i++){
    const start = arc*i - Math.PI/2;
    const end = start + arc;

    ctx.beginPath();
    ctx.moveTo(CENTER,CENTER);
    ctx.arc(CENTER,CENTER,RADIUS,start,end);
    ctx.closePath();
    ctx.fillStyle = i%2===0 ? "#fde7b5" : "#fcdca0";
    ctx.fill();
    ctx.strokeStyle="#fff";
    ctx.lineWidth=2;
    ctx.stroke();

    ctx.save();
    ctx.translate(CENTER,CENTER);
    ctx.rotate(start + arc/2);
    ctx.textAlign="right";
    ctx.font="22px Noto Sans TC";
    ctx.fillStyle="#5b3a00";
    ctx.fillText(names[i], RADIUS-20, 8);
    ctx.restore();
  }
}

/* -------- index → 精準角度 -------- */
function angleForIndex(i){
  const arc = Math.PI*2/names.length;
  return -(i*arc + arc/2);
}

/* -------- 平滑旋轉（不中途重畫） -------- */
function spinToIndex(index){
  return new Promise(resolve=>{
    spinning = true;
    playDrum();

    const target = angleForIndex(index);
    const extra = Math.PI*2*4;
    const startAngle = currentAngle;
    const endAngle = target + extra;

    const startTime = performance.now();
    const duration = 4800;

    function animate(now){
      let t = (now-startTime)/duration;
      if(t>1) t=1;
      const ease = 1-Math.pow(1-t,3);
      currentAngle = startAngle + (endAngle-startAngle)*ease;

      ctx.save();
      ctx.clearRect(0,0,380,380);
      ctx.translate(CENTER,CENTER);
      ctx.rotate(currentAngle);
      ctx.translate(-CENTER,-CENTER);
      drawWheel();
      ctx.restore();

      if(t<1){
        requestAnimationFrame(animate);
      }else{
        currentAngle = target;
        ctx.save();
        ctx.clearRect(0,0,380,380);
        ctx.translate(CENTER,CENTER);
        ctx.rotate(currentAngle);
        ctx.translate(-CENTER,-CENTER);
        drawWheel();
        ctx.restore();

        spinning=false;
        resolve();
      }
    }
    requestAnimationFrame(animate);
  });
}

/* -------- 鎖定名單 -------- */
lockBtn.onclick = ()=>{
  if(spinning) return;

  const raw = nameInput.value.trim();
  if(!raw) return alert("請輸入姓名");

  const arr = raw.split(/[,、\s]+/).filter(Boolean);
  if(arr.length<2) return alert("至少需要兩位");

  const set = new Set(arr);
  if(set.size!==arr.length){
    return alert("Oops, 有姓名被重複輸入了唷！");
  }

  names = arr;
  usedNames = [];
  logs = [];
  locked = true;
  currentAngle = 0;

  drawWheel();
  startBtn.disabled = false;
  status.innerText = `名單已鎖定，共 ${names.length} 位`;
};

/* -------- 開始抽姓名（可連續） -------- */
startBtn.onclick = async ()=>{
  if(spinning || !locked) return;

  const remaining = names.filter(n=>!usedNames.includes(n));
  if(remaining.length===0){
    status.innerText =
      `此輪轉盤已完成 ${names.length} 位的紅包抽籤，請按「全部歸零」重新開始。`;
    startBtn.disabled = true;
    return;
  }

  startBtn.disabled = true;
  const winner = remaining[Math.floor(Math.random()*remaining.length)];
  const index = names.indexOf(winner);

  status.innerText = "轉盤抽籤中…";
  await spinToIndex(index);

  usedNames.push(winner);
  logs.push({
    time: new Date().toLocaleString("zh-TW"),
    name: winner
  });

  status.innerText = `第 1 輪完成：抽中「${winner}」`;
  startBtn.disabled = false;
};

/* -------- 全部歸零 -------- */
resetBtn.onclick = ()=>location.reload();

/* -------- PDF 匯出（真正可用） -------- */
pdfBtn.onclick = ()=>{
  if(logs.length===0){
    alert("尚無抽籤紀錄");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt",format:"a4"});

  doc.setFont("Helvetica");
  doc.setFontSize(16);
  doc.text("BlessingCards128 抽籤紀錄",40,40);

  let y=70;
  doc.setFontSize(12);
  logs.forEach(l=>{
    doc.text(`[${l.time}] ${l.name}`,40,y);
    y+=20;
    if(y>760){doc.addPage();y=60;}
  });

  doc.save("BlessingCards128_抽籤紀錄.pdf");
};
</script>

</body>
</html>
