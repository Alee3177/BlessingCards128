<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>祝福經句紅包（BlessingCards128）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    background: #fff9e9;
    font-family: "Noto Sans TC", sans-serif;
    text-align: center;
    padding: 20px;
    color: #5a3d00;
}

h1 {
    font-size: 26px;
    color: #b06b00;
    margin-bottom: 12px;
}

#nameInput {
    width: 260px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #b4843a;
    font-size: 18px;
    margin-bottom: 12px;
}

/* 按鈕樣式 */
.btn {
    background: #f7c86c;
    padding: 12px 22px;
    border-radius: 25px;
    font-size: 18px;
    color: #5a3d00;
    cursor: pointer;
    border: none;
    margin: 6px;
}
.btn:hover { background: #f5b953; }

/* 輪盤外框 */
#wheelContainer {
    position: relative;
    width: 380px;
    height: 380px;
    margin: 25px auto;
}

/* Canvas */
#wheelCanvas {
    width: 380px;
    height: 380px;
}

/* 指針 ▼ */
#wheelPointer {
    position: absolute;
    top: -22px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 40px;
    color: red;
    z-index: 10;
}

#statusText {
    font-size: 20px;
    margin-top: 15px;
    color: #b06b00;
}
</style>
</head>

<body>

<h1>祝福經句紅包（BlessingCards128）</h1>
<img src="logo3524.png" width="120" style="margin-bottom:12px;">

<input id="nameInput" placeholder="請輸入姓名，以「、」隔開多人">

<br>
<button class="btn" onclick="lockList()">鎖定名單</button>
<button class="btn" onclick="startDraw()">開始抽姓名 + 經句</button>
<button class="btn" onclick="resetAll()">全部歸零</button>
<button class="btn" onclick="exportPDF()">抽籤紀錄 PDF</button>

<div id="wheelContainer">
    <div id="wheelPointer">▼</div>
    <canvas id="wheelCanvas" width="380" height="380"></canvas>
</div>

<div id="statusText">請輸入姓名並鎖定名單</div>

<script src="verseRefMap.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


<script>
/* -----------------------------------
   1) 名單處理（不需要新增按鈕、不需要 Enter）
----------------------------------- */
let nameList = [];
let locked = false;

function lockList() {
    const raw = document.getElementById("nameInput").value.trim();

    if(raw === ""){
        alert("請輸入至少 2 位姓名！");
        return;
    }

    // 以「、」或空白或逗號 分隔
    nameList = raw.split(/[,、\s]+/).filter(x => x.trim() !== "");

    if(nameList.length < 2){
        alert("至少需要 2 位姓名才能抽籤！");
        return;
    }

    locked = true;

    document.getElementById("statusText").innerText =
        "名單已鎖定，共 " + nameList.length + " 位。";

    drawWheel(nameList);
}

/* -----------------------------------
   2) 繪製輪盤
----------------------------------- */
const CENTER = 190;
const RADIUS  = 180;
let canvas = document.getElementById("wheelCanvas");
let ctx = canvas.getContext("2d");

function drawWheel(items){
    ctx.clearRect(0,0,380,380);

    if(items.length === 0) return;

    let count = items.length;
    let arc = Math.PI * 2 / count;

    for(let i=0;i<count;i++){
        ctx.beginPath();
        ctx.fillStyle = (i%2===0 ? "#fde7b5" : "#fcdca0");
        ctx.moveTo(CENTER, CENTER);
        ctx.arc(CENTER, CENTER, RADIUS, arc*i, arc*(i+1));
        ctx.fill();

        /* 分隔線 */
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.save();
        ctx.translate(CENTER,CENTER);
        ctx.rotate(arc*i + arc/2);
        ctx.textAlign = "right";
        ctx.font = "22px Noto Sans TC";
        ctx.fillStyle = "#5a3d00";
        ctx.fillText(items[i], RADIUS - 20, 10);
        ctx.restore();
    }
}

function easeOut(t){ return 1 - Math.pow(1 - t, 3); }

/* -----------------------------------
   3) 輪盤動畫（姓名逆時針 / 經句順時針）
----------------------------------- */
function spinWheel(items, clockwise){
    return new Promise(resolve => {
        let count = items.length;
        let arc = Math.PI * 2 / count;
        let base = Math.PI * 8;
        let randomOffset = Math.random()*Math.PI*4;
        let rotation = base + randomOffset;

        if(!clockwise) rotation = -rotation;

        let start = performance.now();

        function animate(now){
            let p = (now-start)/5000;
            if(p>1) p=1;
            let angle = rotation * easeOut(p);

            ctx.save();
            ctx.clearRect(0,0,380,380);
            ctx.translate(CENTER,CENTER);
            ctx.rotate(angle);
            ctx.translate(-CENTER,-CENTER);
            drawWheel(items);
            ctx.restore();

            if(p < 1){
                requestAnimationFrame(animate);
            } else {
                let raw = angle % (2*Math.PI);
                if(raw < 0) raw += 2*Math.PI;
                let idx = Math.floor((count - raw/arc) % count);
                resolve(items[idx]);
            }
        }
        requestAnimationFrame(animate);
    });
}

/* -----------------------------------
   4) 全流程：姓名輪盤 → 經句輪盤
----------------------------------- */
async function startDraw(){

    if(!locked){
        alert("請先鎖定名單！");
        return;
    }

    /* 第 1 輪：姓名 */
    document.getElementById("statusText").innerText =
        "第 1 輪：姓名輪盤抽籤中…";
    drawWheel(nameList);

    let selectedName = await spinWheel(nameList, false);

    document.getElementById("statusText").innerText =
        "第 1 輪完成：抽中「" + selectedName + "」";

    await new Promise(r=>setTimeout(r,5000));

    /* 第 2 輪：經句 */
    let verseList = Object.keys(VERSE_REF_MAP);
    let used = JSON.parse(localStorage.getItem("usedVersesAll") || "[]");

    let available = verseList.filter(v => !used.includes(v));
    if(available.length === 0){
        alert("128 篇經文已抽完！");
        return;
    }

    // 外觀維持姓名輪盤，但不使用姓名，只用數字輪盤
    let wheelDisplay = nameList.map((_,i)=>String(i+1).padStart(3,"0"));

    document.getElementById("statusText").innerText =
        "第 2 輪：祝福經句輪盤（001~128）抽籤中…";

    drawWheel(wheelDisplay);
    await spinWheel(wheelDisplay, true);

    let selectedVerse = available[Math.floor(Math.random()*available.length)];

    document.getElementById("statusText").innerText =
        "第 2 輪完成：抽中經句「" + selectedVerse + "」";

    await new Promise(r=>setTimeout(r,5000));

    saveRecord(selectedName, selectedVerse, "姓名模式");

    window.location =
        `viewer.html?name=${encodeURIComponent(selectedName)}&verse=${selectedVerse}`;
}

/* -----------------------------------
   5) 紀錄保存
----------------------------------- */
function saveRecord(name, verse, mode){
    let now = new Date();
    let ts =
        `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,"0")}/`+
        `${String(now.getDate()).padStart(2,"0")} `+
        `${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}:${String(now.getSeconds()).padStart(2,"0")}`;

    let logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");

    logs.push({
        time: ts,
        name: name,
        verseNo: verse,
        mode: mode
    });

    localStorage.setItem("drawLogs", JSON.stringify(logs));

    let used = JSON.parse(localStorage.getItem("usedVersesAll") || "[]");
    used.push(verse);
    localStorage.setItem("usedVersesAll", JSON.stringify(used));
}

/* -----------------------------------
   6) 重置資料
----------------------------------- */
function resetAll(){
    localStorage.removeItem("usedVersesAll");
    localStorage.removeItem("drawLogs");
    nameList = [];
    locked   = false;
    alert("資料已清空！");
    location.reload();
}

/* -----------------------------------
   7) PDF 輸出（外部字型）
----------------------------------- */
async function loadFont(){
    const res = await fetch("fonts/NotoSansTC-Regular.ttf");
    const buf = await res.arrayBuffer();
    return btoa(
        new Uint8Array(buf).reduce((a,b)=>a+String.fromCharCode(b),"")
    );
}

async function exportPDF(){

    let logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
    if(logs.length === 0){
        alert("目前沒有抽籤紀錄！");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    const fontData = await loadFont();
    doc.addFileToVFS("NotoSansTC.ttf", fontData);
    doc.addFont("NotoSansTC.ttf", "NotoSansTC", "normal");
    doc.setFont("NotoSansTC");

    let y = 40;
    doc.setFontSize(16);
    doc.text(`BlessingCards128 抽籤紀錄（共 ${logs.length} 筆）`, 40, y);
    y += 30;

    doc.setFontSize(14);

    logs.forEach(log =>{
        let ref = VERSE_REF_MAP[log.verseNo] || "";

        let line =
            `[${log.time}] ${log.name}｜${log.mode}｜抽中經句：${log.verseNo}` +
            (ref ? `（${ref}）` : "");

        if(y > 780){
            doc.addPage();
            y = 40;
        }

        doc.text(line, 40, y);
        y += 22;
    });

    doc.save("BlessingCards128_抽籤紀錄.pdf");
}
</script>

</body>
</html>
