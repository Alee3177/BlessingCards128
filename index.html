<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</title>

<!-- è®“ logo å„ªå…ˆè¼‰å…¥ï¼ˆæ”¹å–„å‡ºç¾å¾ˆæ…¢ï¼‰ -->
<link rel="preload" as="image" href="logo3524.png">

<style>
body{
  font-family:"Noto Sans TC",system-ui;
  background:#fbf2df;
  text-align:center;
  margin:0;
  padding:16px;
  color:#5b3a00;
}
.logo{width:220px;margin:10px auto 0;display:block;}

#nameInput{
  width:90%;max-width:480px;padding:10px 14px;
  margin-top:10px;border-radius:10px;border:2px solid #e3c78c;
  font-size:18px;text-align:center;box-sizing:border-box;
}

.btn-row{
  margin-top:8px;
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
}
.btn{
  min-width:110px;
  padding:8px 16px;
  border-radius:999px;
  border:none;
  background:#f4b63a;
  color:#5b3a00;
  font-size:15px;
  font-weight:600;
  box-shadow:0 3px 0 #d59b25;
  cursor:pointer;
}
.btn:disabled{
  background:#f0ddaa;
  cursor:default;
}

.blink-btn{animation:flash .8s infinite alternate;}
@keyframes flash{from{opacity:1}to{opacity:.35}}

#wheel-container{
  position:relative;
  width:360px;
  height:360px;
  margin:16px auto;
}
#wheel{
  width:360px;
  height:360px;
}
#hl-svg{
  position:absolute;
  left:0;
  top:0;
  width:360px;
  height:360px;
  pointer-events:none;
}
#confettiCanvas{
  position:absolute;
  left:0;
  top:0;
  width:360px;
  height:360px;
  pointer-events:none;
}

@keyframes blink{from{opacity:1;}to{opacity:.25;}}
.blink{animation:blink .55s ease-in-out infinite alternate;}

#centerText{
  position:absolute;
  left:0;
  top:0;
  width:360px;
  height:360px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  pointer-events:none;
  font-size:18px;
  font-weight:700;
  white-space:pre-line;
}
#summaryBox{
  margin-top:10px;
  white-space:pre-line;
  font-weight:700;
}
/* PDF å®Œæˆå¯ä¸‹è¼‰ç‹€æ…‹ */
.btn-pdf-ready{
  background:#1976D2 !important;
  color:#fff !important;
  box-shadow:0 3px 0 #0d47a1;
}
/* å…¨éƒ¨æ­¸é›¶ï¼šå®Œæˆæ…‹ï¼ˆå±éšªç‹€æ…‹ï¼‰ */
.btn-reset-danger{
  background:#E53935;
  color:#fff;
  box-shadow:0 3px 0 #B71C1C;
}

/* ===== ä¸»æ§ç‹€æ…‹ç‡ˆ ===== */
.status-bar{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin:8px auto 4px auto;
  font-size:14px;
  font-weight:700;
}

/* ğŸ“¡ ä¸»æ§ç‹€æ…‹ç‡ˆæ•´é«”æ”¾å¤§ 20% */
.status-bar{
  transform: scale(1.2);
  transform-origin: center;
}

.status-bar .dot{
  width:12px;
  height:12px;
  border-radius:50%;
  background:#999;
  box-shadow:0 0 4px rgba(0,0,0,.3);
}

/* ç¶ ï¼šä¸»æ§æ­£å¸¸ */
.status-ok .dot{
  background:#2e7d32;
  box-shadow:0 0 8px rgba(46,125,50,.8);
}

/* é»ƒï¼šæ“ä½œä¸­ */
.status-warn .dot{
  background:#f9a825;
  box-shadow:0 0 8px rgba(249,168,37,.8);
}

/* ç´…ï¼šé–å®š / é›™ä¸»æŒ / éŒ¯èª¤ */
.status-error .dot{
  background:#c62828;
  box-shadow:0 0 8px rgba(198,40,40,.8);
}

/* ===== ä¸»æŒæ©Ÿ / è§€çœ¾ç‹€æ…‹é¢æ¿ ===== */
#hostPanel {
  position: fixed;
  top: 12px;
  right: 12px;
  background: rgba(0,0,0,0.75);
  color: #fff;
  padding: 10px 14px;
  border-radius: 10px;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  z-index: 9999;
  box-shadow: 0 6px 20px rgba(0,0,0,0.35);
}

#hostStatus.ok {
  color: #4caf50;
  font-weight: bold;
}

#hostStatus.warn {
  color: #ffb300;
  font-weight: bold;
}

#viewerStatus.ok {
  color: #03a9f4;
}

#viewerStatus.warn {
  color: #aaa;
}

/* =========================
   ğŸ“± QR Panelï¼ˆç©©å®šåˆä½µç‰ˆï¼‰
========================= */
#qrBox {
  margin-top: 8px;
  text-align: center;
  width: 200px;
  max-width: 200px;
  padding: 10px;
  box-sizing: border-box;
  cursor: pointer;
}

/* QR æœ¬é«”å°ºå¯¸ */
#qrCanvas {
  width: 160px;
  height: 160px;
  margin: 0 auto;
}

/* ä¿è­‰ QR ä¸æœƒæº¢å‡º */
#qrCanvas canvas,
#qrCanvas img {
  max-width: 160px;
  max-height: 160px;
  display: block;
  margin: 0 auto;
  border-radius: 8px;
  background: #fff;
  padding: 6px;
}

.qr-title {
  font-size: 13px;
  margin-bottom: 4px;
  color: #ffd54f;
  font-weight: bold;
}

.qr-hint {
  font-size: 11px;
  opacity: 0.85;
  margin-top: 2px;
}

/* æ‰‹æ©Ÿ QR ç¸®å°æ¨¡å¼ */
@media (max-width: 768px) {
  #hostPanel {
    transform: scale(0.75);
    transform-origin: top right;
  }
}

/* æ”¶åˆç‹€æ…‹ */
#qrBox.collapsed #qrCanvas,
#qrBox.collapsed .qr-hint,
#qrBox.collapsed button {
  display: none;
}

#qrBox.collapsed::after {
  content: "ğŸ“± é»æˆ‘å±•é–‹ QR";
  display: block;
  color: #ffd54f;
  font-size: 12px;
  margin-top: 6px;
}

/* çœ‹ç´…åŒ…é–ƒçˆæç¤º */
.blink-all {
  animation: blinkPulse 1s infinite;
}

@keyframes blinkPulse {
  0%   { box-shadow: 0 0 0 rgba(255,193,7,0.0); }
  50%  { box-shadow: 0 0 14px rgba(255,193,7,0.9); }
  100% { box-shadow: 0 0 0 rgba(255,193,7,0.0); }
}

/* ============================= */
/* çœ‹ç´…åŒ…ï¼šæ¡† + æ–‡å­—ä¸€èµ·é–ƒ */
/* ============================= */
@keyframes blinkAll {
  0% {
    background-color: #f6c453;
    color: #000;
    box-shadow: 0 0 0px rgba(246,196,83,0.0);
  }
  50% {
    background-color: #ffeb99;
    color: #b10000;
    box-shadow: 0 0 12px rgba(255,200,0,0.9);
  }
  100% {
    background-color: #f6c453;
    color: #000;
    box-shadow: 0 0 0px rgba(246,196,83,0.0);
  }
}

.blink-all {
  animation: blinkAll 1s infinite;
}

/* ç®¡ç†åŠŸèƒ½ - å¼·åˆ¶è§£é™¤ä¸»æŒæ©Ÿ */
.danger-btn {
  background: #b00020;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 16px;
  margin-top: 8px;
  cursor: pointer;
  font-weight: bold;
}

.danger-btn:hover {
  background: #d00030;
}

</style>

<script src="verseRefMap.js?v=20260105"></script>

<!-- â‘  jsPDF ä¸»ç¨‹å¼ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- â‘¡ QRCode æœ¬åœ°å¼•æ“ï¼ˆä¸€å®šè¦åœ¨ QR ç¨‹å¼ç¢¼å‰ï¼‰ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

</head>

<body>

<img
  src="logo3524.png"
  class="logo"
  loading="eager"
  decoding="async"
  onerror="this.style.display='none'; console.warn('âš  logo3524.png è¼‰å…¥å¤±æ•—');"
/>

<h2>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h2>

<div id="masterStatus" class="status-bar">
  <span class="dot"></span>
  <span class="label">ç³»çµ±åˆå§‹åŒ–ä¸­</span>
</div>

<input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼Œå¯ç”¨ç©ºç™½æˆ–é€—è™Ÿåˆ†éš”">

<!-- ç¬¬ä¸€è¡Œ -->
<div class="btn-row">
  <button id="lockBtn" class="btn">é–å®šåå–®</button>
  <button id="spinBtn" class="btn" disabled>é–‹å§‹æŠ½å§“åï¼‹ç¶“å¥ï¼ˆç¬¬ä¸€è¼ªï¼‰</button>
</div>

<!-- ç¬¬äºŒè¡Œ -->
<div class="btn-row">
  <button id="viewBtn" class="btn" disabled>çœ‹ç´…åŒ…</button>
  <button id="secondBtn" class="btn" disabled>æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
</div>

<!-- ç¬¬ä¸‰è¡Œ -->
<div class="btn-row">
  <button id="resetBtn" class="btn">å…¨éƒ¨æ­¸é›¶</button>
  <button id="pdfBtn" class="btn" disabled>æŠ½ç±¤ç´€éŒ„ PDF</button>
</div>

<!-- ç®¡ç†åŠŸèƒ½ -->
<div class="btn-row admin-row">
  <button id="btnForceRelease" class="danger-btn">
    ğŸ”“ å¼·åˆ¶è§£é™¤ä¸»æŒæ©Ÿä½”ç”¨
  </button>
</div>

<div id="wheel-container">
  <canvas id="wheel" width="360" height="360"></canvas>
  <canvas id="confettiCanvas" width="360" height="360"></canvas>
  <svg id="hl-svg" viewBox="0 0 360 360"></svg>
  <div id="centerText"></div>
</div>

<div id="status">è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®</div>
<div id="result"></div>
<div id="summaryBox"></div>

<div id="hostPanel">
  <div id="hostStatus">ğŸ¤ ä¸»æŒæ©Ÿé›¢ç·š</div>
  <div id="viewerStatus">ğŸ‘¥ å°šç„¡è§€çœ¾</div>

  <!-- â­ QR Code å€ -->
<div id="qrBox">
  <div class="qr-title">ğŸ“± æƒç¢¼çœ‹ç´…åŒ…</div>
  <div id="qrCanvas"></div>
  <div class="qr-hint">è«‹ç”¨æ‰‹æ©Ÿæƒæ</div>

  <button id="copyViewerLink" class="qr-copy-btn">
    ğŸ“‹ è¤‡è£½çœ‹ç´…åŒ…é€£çµ
  </button>
</div>

<audio id="drum" preload="auto" playsinline>
  <source src="audio/drum.mp3" type="audio/mpeg">
</audio>

<audio id="winSound" preload="auto" playsinline>
  <source src="audio/win.mp3" type="audio/mpeg">
</audio>

<!-- ===============================
  BlessingCards128 Resource Preloader
  é è¼‰ LOGO / éŸ³æ•ˆ / ç´…åŒ…åœ–ç‰‡
================================ -->
<script>
/* ==== ä¸»æ§æ——æ¨™ ==== */
const IS_MASTER = true;

/* ==== é–‹ç™¼ / ç¾å ´æ§åˆ¶ ==== */
const DISABLE_MASTER_LOCK = false;

/* ==== ä¸»æŒæ©Ÿé–å®šè­˜åˆ¥ï¼ˆé˜²å¤šä¸»æŒï¼‰ ==== */
const TAB_ID = Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 6);
const HEARTBEAT_TTL = 5000; // 5 ç§’å…§è¦–ç‚ºã€Œæ´»èºä¸»æŒæ©Ÿã€

const MASTER_KEY = "BLESSING_MASTER";

function claimMaster() {
  const now = Date.now();
  const current = JSON.parse(localStorage.getItem(MASTER_KEY) || "null");

  if (!current || now - current.heartbeat > HEARTBEAT_TTL) {
    localStorage.setItem(MASTER_KEY, JSON.stringify({
      tabId: TAB_ID,
      heartbeat: now
    }));
    return true;
  }

  return current.tabId === TAB_ID;
}

function heartbeatMaster() {
  if (!IS_MASTER) return;
  localStorage.setItem(MASTER_KEY, JSON.stringify({
    tabId: TAB_ID,
    heartbeat: Date.now()
  }));
}

setInterval(heartbeatMaster, 2000);

// ğŸ§¹ é—œé–‰/åˆ·æ–°åˆ†é æ™‚é‡‹æ”¾ä¸»æŒé–ï¼ˆé¿å…é•·æ™‚é–“å¡ä½ï¼‰
window.addEventListener("beforeunload", () => {
  try {
    const cur = JSON.parse(localStorage.getItem(MASTER_KEY) || "null");
    if (cur && cur.tabId === TAB_ID) localStorage.removeItem(MASTER_KEY);
  } catch {}
});

// âœ… åˆ‡åˆ°èƒŒæ™¯ä¹Ÿç¶­æŒå¿ƒè·³ï¼ˆæ‰‹æ©Ÿé–å±å¸¸è¦‹ï¼‰
document.addEventListener("visibilitychange", () => {
  if (!document.hidden) heartbeatMaster();
});

(function preloadResources(){

  console.log("ğŸ”¥ BlessingCards128 è³‡æºæš–æ©Ÿä¸­...");

  /* ===== 1ï¸âƒ£ LOGO ===== */
  const preloadLogo = new Image();
  preloadLogo.onload = () => {
    console.log("âœ… LOGO é è¼‰å®Œæˆ");
  };
  preloadLogo.onerror = () => {
    console.warn("âš  LOGO é è¼‰å¤±æ•—ï¼šlogo3524.png");
  };
  preloadLogo.src = "logo3524.png";

  /* ===== 2ï¸âƒ£ éŸ³æ•ˆ ===== */
  const preloadDrum = new Audio();
  preloadDrum.src = "audio/drum.mp3";
  preloadDrum.load();

  const preloadWin = new Audio();
  preloadWin.src = "audio/win.mp3";
  preloadWin.load();

  /* ===== 3ï¸âƒ£ ç´…åŒ…åœ–ç‰‡ï¼ˆæ‰‹æ©Ÿé™è¼‰ï¼‰===== */
  const MAX_PRELOAD = (window.innerWidth < 768 ? 24 : 128);
  const loaded = { count: 0 };

  for (let i = 1; i <= MAX_PRELOAD; i++) {
    const img = new Image();
    const no = String(i).padStart(3, "0");

    img.onload = () => {
      loaded.count++;
      if (loaded.count === MAX_PRELOAD) {
        console.log(`âœ… ç´…åŒ…åœ–ç‰‡æš–æ©Ÿå®Œæˆï¼ˆ${MAX_PRELOAD} å¼µï¼‰`);
      }
    };

    img.onerror = () => {
      console.warn("âš  ç„¡æ³•é è¼‰åœ–ç‰‡:", "cards/" + no + ".png");
    };

    img.src = "cards/" + no + ".png";
  }

})();

// =============================
// ğŸ“± QR Code è‡ªå‹•ç”¢ç”Ÿï¼ˆä¸»æŒæ©Ÿï½œå•†ç”¨ç©©å®šç‰ˆï¼‰
// =============================
(function initQRCode(){
  let initialized = false;

  function run() {
    if (initialized) return;
    initialized = true;

    const qrImg = document.getElementById("qrImg");
    if (!qrImg) {
      console.warn("âš  æ‰¾ä¸åˆ° qrImgï¼ˆHost Panel å°šæœªæ¸²æŸ“ï¼‰");
      return;
    }

    // GitHub Pages / å­ç›®éŒ„å®‰å…¨è·¯å¾‘
    const base = location.origin + location.pathname.replace(/\/[^\/]*$/, "/");
    const viewerUrl = base + "viewer.html";

    // QR APIï¼ˆé˜²å¿«å– + æ­£ç¢ºåƒæ•¸æ ¼å¼ï¼‰
    const qrApi =
      "https://api.qrserver.com/v1/create-qr-code/" +
      "?cache=0" +
      "&size=200x200" +
      "&margin=8" +
      "&data=" + encodeURIComponent(viewerUrl);

    // é˜²æ­¢é‡è¨­ src é–ƒçˆ
    if (!qrImg.src || !qrImg.src.includes("api.qrserver.com")) {
      qrImg.src = qrApi;
    }

    // ğŸ›Ÿ QR æ›æ‰ä¿å‘½
    qrImg.onerror = () => {
      qrImg.alt = "è«‹æ‰‹å‹•è¼¸å…¥ viewer.html é–‹å•Ÿ";
      console.warn("âš  QR API è¼‰å…¥å¤±æ•—ï¼Œè«‹æ‰‹å‹•é–‹å•Ÿï¼š", viewerUrl);
    };

    console.log("ğŸ“± QR Code ready:", viewerUrl);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", run, { once: true });
  } else {
    run();
  }
})();


(function(){

// =============================
// ğŸ”’ é˜²ä½œå¼Šï¼ˆå®‰å…¨ç‰ˆï¼‰
// =============================
(function lockInputCheat(){
  document.addEventListener("keydown", function(e) {
    // å…è¨± F12 / F5 / ç³»çµ±å¿«æ·éµ
    if (
      e.key === "F12" ||
      e.key === "F5" ||
      e.ctrlKey ||
      e.metaKey
    ) return;

    e.preventDefault();
  }, true);

  document.addEventListener("contextmenu", function(e) {
    e.preventDefault();
  }, true);
})();

// =============================
// ğŸ”’ é˜²ä½œå¼Šï¼šç¦æ­¢éµç›¤ + å³éµ
// =============================
let animId = null;   // requestAnimationFrame æ§åˆ¶ç”¨ï¼ˆé˜²æ­¢å‹•ç•«æ®˜ç•™ / æ­»æ©Ÿï¼‰

/* ==== DOM å…ƒä»¶ ==== */
const wheel = document.getElementById("wheel");
const ctx = wheel ? wheel.getContext("2d") : null;

if (!wheel || !ctx) {
  console.warn("âš  Wheel canvas not ready");
}
const hlSVG = document.getElementById("hl-svg");
const centerText = document.getElementById("centerText");

const confettiCanvas = document.getElementById("confettiCanvas");
const confCtx = confettiCanvas
  ? confettiCanvas.getContext("2d")
  : null;

if (!confettiCanvas || !confCtx) {
  console.warn("âš  Confetti canvas not ready");
}

const lockBtn   = document.getElementById("lockBtn");
const spinBtn   = document.getElementById("spinBtn");
const resetBtn  = document.getElementById("resetBtn");
const secondBtn = document.getElementById("secondBtn");
const viewBtn   = document.getElementById("viewBtn");
const pdfBtn    = document.getElementById("pdfBtn");
const nameInput = document.getElementById("nameInput");

const statusDiv  = document.getElementById("status");
const resultDiv  = document.getElementById("result");
const summaryBox = document.getElementById("summaryBox");

const drum = document.getElementById("drum");
const winSound = document.getElementById("winSound");


// âœ… è¡Œå‹•è£ç½®éŸ³æ•ˆè§£é–ï¼šç¬¬ä¸€æ¬¡é»æ“Šå°±è§£é–ï¼ˆé¿å… drum ç„¡è²ï¼‰
document.addEventListener("pointerdown", unlockAudio, { capture: true });
let audioUnlocked = false;

function unlockAudio() {
  if (audioUnlocked) return;

  try {
    const a1 = document.getElementById("drum");
    const a2 = document.getElementById("winSound");

    if (a1) {
      a1.muted = true;
      a1.play().then(() => {
        a1.pause();
        a1.currentTime = 0;
        a1.muted = false;
        audioUnlocked = true;
        console.log("ğŸ”“ Audio unlocked");
      }).catch(()=>{});
    }

    if (a2) {
      a2.muted = true;
      a2.play().then(() => {
        a2.pause();
        a2.currentTime = 0;
        a2.muted = false;
      }).catch(()=>{});
    }
  } catch (e) {
    console.warn("unlockAudio failed", e);
  }
}

/* ==== ç‹€æ…‹è®Šæ•¸ ==== */
let names = [];
let usedName = new Set();
let verseUsed = new Set();
let round2Started = false; // âœ… ç¬¬äºŒè¼ªæ˜¯å¦å·²ç¶“è¢«æŒ‰é

let rotation = 0;
let rotating = false;
let lastWinnerIndex = null;
let currentVerse = null;

/* ==== PDF è¼ªæ¬¡é˜²å‘†ç‹€æ…‹ ==== */
let pdfRoundSerial = null;   // æœ¬è¼ªä½¿ç”¨çš„æµæ°´è™Ÿï¼ˆ001~999ï¼‰
let pdfRepeatCount = 0;     // æœ¬è¼ªé‡è¤‡ä¸‹è¼‰æ¬¡æ•¸
let pdfDownloadedThisRound = false;

/* ==== ç³»çµ±ç‹€æ…‹æ©Ÿ ==== */
const SYS_STATE = {
  INIT: "INIT",           // åˆå§‹
  READY: "READY",        // åå–®é–å®š
  ROUND1: "ROUND1",      // ç¬¬ä¸€è¼ªæ—‹è½‰ä¸­
  ROUND2: "ROUND2",      // ç¬¬äºŒè¼ªæ—‹è½‰ä¸­
  VIEWER: "VIEWER",      // æŸ¥çœ‹ç´…åŒ…
  FINISHED: "FINISHED"  // å…¨éƒ¨å®Œæˆ
 };
let lastHeartbeat = Date.now();
let systemState = SYS_STATE.INIT;
    nameInput.disabled = false;
let lastActionAt = 0;   // é˜²é€£é»ç¯€æµç”¨

const statusBar = document.getElementById("masterStatus");

// =============================
// ğŸ‘¥ Viewer å³æ™‚çµ±è¨ˆé¡¯ç¤ºï¼ˆä¸»æŒæ©Ÿï¼‰
// =============================
const VIEWER_KEY = "BLESSING_VIEWERS";
const VIEWER_TTL = 30000; // 30 ç§’æ²’å¿ƒè·³å°±è¸¢æ‰

function updateViewerCount() {
  const now = Date.now();
  let viewers = {};
  let count = 0;

  try {
    viewers = JSON.parse(localStorage.getItem(VIEWER_KEY) || "{}");
  } catch {
    viewers = {};
  }

  // æ¸…æ‰éæœŸ viewer
  Object.keys(viewers).forEach(id => {
    if (now - viewers[id] > VIEWER_TTL) {
      delete viewers[id];
    }
  });

  count = Object.keys(viewers).length;
  localStorage.setItem(VIEWER_KEY, JSON.stringify(viewers));

  // æ›´æ–° UI
  const viewerStatus = document.getElementById("viewerStatus");
  if (!viewerStatus) return;

  if (count > 0) {
    viewerStatus.textContent = `ğŸ‘¥ ${count} äººé€£ç·šä¸­`;
    viewerStatus.className = "ok";
  } else {
    viewerStatus.textContent = "ğŸ‘¥ å°šç„¡è§€çœ¾";
    viewerStatus.className = "warn";
  }
}

/* ========= å·¥å…·å‡½å¼ ========= */
// â° æ™‚é–“æ ¼å¼çµ±ä¸€å·¥å…·ï¼ˆPDF / ç´€éŒ„ / UI å…±ç”¨ï¼‰
function formatTime2(date = new Date()) {
  const h = String(date.getHours()).padStart(2, "0");
  const m = String(date.getMinutes()).padStart(2, "0");
  const s = String(date.getSeconds()).padStart(2, "0");

  const isPM = date.getHours() >= 12;
  return `${isPM ? "ä¸‹åˆ" : "ä¸Šåˆ"} ${h}:${m}:${s}`;
}

function setStatusLight(mode, text){
  if(!statusBar) return;

  statusBar.classList.remove("status-ok","status-warn","status-error");

  if(mode === "ok")    statusBar.classList.add("status-ok");
  if(mode === "warn")  statusBar.classList.add("status-warn");
  if(mode === "error") statusBar.classList.add("status-error");

  const label = statusBar.querySelector(".label");
  if(label) label.textContent = text;
}

function canAct(delay = 500) // æ‰€æœ‰æŒ‰éˆ• 500ms å…§åªèƒ½è§¸ç™¼ä¸€æ¬¡ï¼ˆé˜²é›™æ“Šã€æ‰‹æ©Ÿèª¤è§¸ï¼‰
{
const now = Date.now();
if (now - lastActionAt < delay) return false;

lastActionAt = now;

return true;
}

function audit(action, detail = "") // æ¯å€‹æ“ä½œéƒ½å¯è¿½è¹¤ã€å¯åŒ¯å‡ºã€å¯æŸ¥è²¬
{
  if (!IS_MASTER) return;   // ğŸ”’ åªæœ‰ä¸»æ§å°èƒ½å¯«ç¨½æ ¸ç´€éŒ„

  const logs = JSON.parse(localStorage.getItem("auditLogs") || "[]");
logs.push({
  timeISO: new Date().toISOString(),        // ğŸ”’ ç³»çµ±ç¨½æ ¸ç”¨ï¼ˆä¸å¯æ”¹ï¼‰
  timeDisplay: formatTime2(new Date()),    // ğŸ‘ äººé¡å¯è®€ï¼ˆä¸‹åˆ 03:57:30ï¼‰
  session: TAB_ID,
  state: systemState,
  action,
  detail
});
  localStorage.setItem("auditLogs", JSON.stringify(logs));
}

function applyUIState() {
  // =========================
  // 0. ç‹€æ…‹ç‡ˆæœ€é«˜å„ªå…ˆæ¬Š
  // =========================
  if (rotating) {
    setStatusLight("warn", "è½‰ç›¤æ—‹è½‰ä¸­");
  } else {
    switch (systemState) {
      case SYS_STATE.INIT:
        setStatusLight("ok", "ç³»çµ±å¾…å‘½ä¸­");
        break;

      case SYS_STATE.READY:
        setStatusLight("ok", "åå–®å·²é–å®šï¼Œæº–å‚™æŠ½ç±¤");
        break;

      case SYS_STATE.ROUND1:
        setStatusLight("warn", "ç¬¬ä¸€è¼ªæŠ½ç±¤ä¸­");
        break;

      case SYS_STATE.ROUND2:
        setStatusLight("warn", "ç¬¬äºŒè¼ªæŠ½ç´…åŒ…ä¸­");
        break;

      case SYS_STATE.VIEWER:
        setStatusLight("warn", "æŸ¥çœ‹ç´…åŒ…ä¸­");
        break;

      case SYS_STATE.FINISHED:
        setStatusLight("ok", "æœ¬è¼ªå®Œæˆï¼Œå¯ä¸‹è¼‰ PDF æˆ–é‡ç½®");
        break;

      default:
        console.warn("âš ï¸ Unknown systemState:", systemState);
        setStatusLight("error", "ç³»çµ±ç‹€æ…‹ç•°å¸¸");
        break;
    }
  }

  // =========================
  // 1. å®‰å…¨é è¨­ï¼šå…¨éƒ¨é–æ­»
  // =========================
  lockBtn.disabled   = true;
  spinBtn.disabled   = true;
  secondBtn.disabled = true;
  viewBtn.disabled   = true;
  pdfBtn.disabled    = true;

  lockBtn.classList.remove("blink-btn");
  spinBtn.classList.remove("blink-btn");
  secondBtn.classList.remove("blink-btn");
  

  pdfBtn.classList.remove("btn-pdf-ready");
  resetBtn.classList.remove("btn-reset-danger");

  // =========================
  // 2. ç‹€æ…‹ â†’ UI å°æ‡‰
  // =========================
  switch (systemState) {

    case SYS_STATE.INIT:
      lockBtn.disabled = false;
      resetBtn.disabled = false;
      statusDiv.textContent = "è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®";
      break;

    case SYS_STATE.READY:
      spinBtn.disabled = false;
      spinBtn.classList.add("blink-btn");
      statusDiv.textContent = "è«‹é–‹å§‹ç¬¬ä¸€è¼ªæŠ½ç±¤";
      break;

    case SYS_STATE.ROUND1:
      statusDiv.textContent = "æ—‹è½‰ä¸­...";
      break;

case SYS_STATE.ROUND2:
  statusDiv.textContent = "è«‹æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰";

  // åªå…è¨±ã€Œå°šæœªé–‹å§‹ç¬¬äºŒè¼ªã€æ™‚æ‰å¯æŒ‰
  if (!round2Started && !rotating) {
    secondBtn.disabled = false;
    secondBtn.classList.add("blink-btn");
  } else {
    secondBtn.disabled = true;
    secondBtn.classList.remove("blink-btn");
  }
  break;

    case SYS_STATE.VIEWER:
      viewBtn.disabled = false;
      
      statusDiv.textContent = "æŸ¥çœ‹ç´…åŒ…ä¸­";
      break;

case SYS_STATE.FINISHED:

  // âœ… å…è¨±çµæ¡ˆæ“ä½œ
  pdfBtn.disabled = false;
  pdfBtn.classList.add("btn-pdf-ready");

  resetBtn.disabled = false;
  resetBtn.classList.add("btn-reset-danger");

  // âœ… å…è¨±ç›´æ¥é–‹æ–°ä¸€è¼ªï¼ˆæ”¹å â†’ é–å®šåå–®ï¼‰
  lockBtn.disabled = false;

  // ğŸ”’ æ‰€æœ‰æŠ½ç±¤å…¥å£é–æ­»
  spinBtn.disabled   = true;
  secondBtn.disabled = true;
  viewBtn.disabled   = true;

  spinBtn.classList.remove("blink-btn");
  secondBtn.classList.remove("blink-btn");
  

  // ğŸ“¢ æ¸…æ¥šæç¤ºä½¿ç”¨è€…ä¸‹ä¸€æ­¥
  statusDiv.textContent = "æœ¬è¼ªå·²å®Œæˆï¼Œå¯ä¸‹è¼‰ PDF æˆ–ç›´æ¥æ”¹åä¸¦é–å®šåå–®é–‹å§‹æ–°ä¸€è¼ª";

  break;

    default:
      // å·²åœ¨ä¸Šæ–¹ç‹€æ…‹ç‡ˆè™•ç†
      break;
  }
}

const CENTER = 180;
const R      = 150;
const DURATION = 5000;

/* ========= åˆå§‹æ¨£å¼ï¼šå–®åœ“ï¼‹åŠå¾‘ç·š ========= */
function drawInitialWheel(){
  ctx.clearRect(0,0,360,360);

  ctx.beginPath();
  ctx.arc(CENTER,CENTER,R,0,Math.PI*2);
  ctx.fillStyle = "#fcdca0";
  ctx.fill();

  ctx.beginPath();
  ctx.arc(CENTER,CENTER,R,0,Math.PI*2);
  ctx.lineWidth = 3;
  ctx.strokeStyle = "#ffffff";
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(CENTER, CENTER);
  ctx.lineTo(CENTER, CENTER - (R - 2));
  ctx.lineWidth = 3;
  ctx.strokeStyle = "#ffffff";
  ctx.stroke();
}

/* ========= ç•«å§“åè¼ªç›¤ ========= */
function drawWheel(angle){
  ctx.clearRect(0,0,360,360);

  if(!names.length){
    drawInitialWheel();
    return;
  }

  const n   = names.length;
  const arc = 2*Math.PI / n;

  ctx.save();
  ctx.translate(CENTER,CENTER);
  ctx.rotate(angle);
  ctx.translate(-CENTER,-CENTER);

  for(let i=0;i<n;i++){
    const s = i*arc - Math.PI/2 - arc/2;
    const e = s + arc;

    ctx.beginPath();
    ctx.moveTo(CENTER,CENTER);
    ctx.arc(CENTER,CENTER,R,s,e);
    ctx.closePath();

    ctx.fillStyle = (i%2 ? "#fde6b4" : "#fcdca0");
    ctx.fill();

    ctx.lineWidth = 3;
    ctx.strokeStyle = "#ffffff";
    ctx.stroke();

    ctx.save();
    ctx.translate(CENTER,CENTER);
    ctx.rotate(s + arc/2);
    ctx.textAlign = "right";
    ctx.font = "18px Noto Sans TC";
    ctx.fillStyle = "#5b3a00";
    ctx.fillText(names[i], R-14, 6);
    ctx.restore();
  }

  ctx.restore();
}

/* ========= é«˜äº® ========= */
function clearHL(){hlSVG.innerHTML="";}

function showHL(i){
  if(i==null||!names.length)return;

  const n=names.length;
  const arc=2*Math.PI/n;

  const s=i*arc - Math.PI/2 + rotation - arc/2;
  const e=s+arc;

  const x1=CENTER+R*Math.cos(s);
  const y1=CENTER+R*Math.sin(s);
  const x2=CENTER+R*Math.cos(e);
  const y2=CENTER+R*Math.sin(e);

  const p=document.createElementNS("http://www.w3.org/2000/svg","path");
  p.setAttribute("d",`M${CENTER} ${CENTER} L${x1} ${y1} A${R} ${R} 0 0 1 ${x2} ${y2} Z`);
  p.setAttribute("fill","rgba(255,210,50,0.55)");
  p.setAttribute("class","blink");
  hlSVG.appendChild(p);
}

function ease(t){return 1 - Math.pow(1-t,3);}

/* ========= å½©å¸¶ï¼‹é‡‘ç²‰ç‰¹æ•ˆ ========= */
function launchConfetti(){
  const pieces=[];
  const dots=[];
  const colors=["#ffd54f","#ffb300","#ffca28","#ffe082","#fff8e1"];

  for(let i=0;i<120;i++){
    pieces.push({
      x:Math.random()*360,
      y:Math.random()*-80,
      w:4+Math.random()*5,
      h:8+Math.random()*10,
      vx:-1+Math.random()*2,
      vy:2+Math.random()*3,
      r:Math.random()*Math.PI,
      vr:(Math.random()-0.5)*0.2,
      color:colors[Math.floor(Math.random()*colors.length)]
    });
  }
  for(let i=0;i<80;i++){
    dots.push({
      x:180 + (Math.random()-0.5)*200,
      y:140 + (Math.random()-0.5)*80,
      r:1+Math.random()*2.5,
      vy:-0.2-Math.random()*0.5,
      alpha:0.9,
      va:-0.01-Math.random()*0.02
    });
  }

  const start=performance.now();
  const duration=1800;

  function frame(now){
    const t=now-start;
    confCtx.clearRect(0,0,360,360);

    pieces.forEach(p=>{
      p.x+=p.vx;
      p.y+=p.vy;
      p.r+=p.vr;
      confCtx.save();
      confCtx.translate(p.x,p.y);
      confCtx.rotate(p.r);
      confCtx.fillStyle=p.color;
      confCtx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
      confCtx.restore();
    });

    dots.forEach(d=>{
      d.y+=d.vy;
      d.alpha+=d.va;
      if(d.alpha<0)d.alpha=0;
      confCtx.beginPath();
      confCtx.fillStyle=`rgba(255,215,130,${d.alpha})`;
      confCtx.arc(d.x,d.y,d.r,0,Math.PI*2);
      confCtx.fill();
    });

    if(t<duration){
      requestAnimationFrame(frame);
    }else{
      confCtx.clearRect(0,0,360,360);
    }
  }
  requestAnimationFrame(frame);
}

function spin(list, clockwise, callback) {
  if (rotating || !list.length) return;

  // ğŸ”´ å…ˆåœæ‰ä»»ä½•æ®˜ç•™å‹•ç•«
  if (animId) {
    cancelAnimationFrame(animId);
    animId = null;
  }

  rotating = true;
  applyUIState(); // ğŸŸ¡ é»ƒç‡ˆ

  statusDiv.textContent = "æ—‹è½‰ä¸­â€¦â€¦";
  resultDiv.textContent = "";
  centerText.textContent = "";
  summaryBox.textContent = "";

try {
  unlockAudio(); // ğŸ”“ å…ˆå˜—è©¦è§£é–

  drum.currentTime = 0;
  const p = drum.play();

  if (p && typeof p.catch === "function") {
    p.catch(err => {
      console.warn("ğŸ”‡ drum blocked, retry unlock", err);
      unlockAudio(); // ğŸ”“ å†è£œä¸€æ¬¡
    });
  }
} catch (e) {
  console.warn("ğŸ”‡ drum exception", e);
}

  const target = list[Math.floor(Math.random() * list.length)];
  const idx = list.indexOf(target);

  const base = rotation;
  const delta =
    (clockwise ? 1 : -1) *
    (6 * Math.PI + idx * (2 * Math.PI / list.length));
  const end = base + delta;

  const start = performance.now();
  const hardStopAt = start + DURATION + 300; // ğŸ›¡ æœ€çµ‚ä¿éšªçµ²

  let finished = false;

  function finish() {
    if (finished) return;
    finished = true;

    if (animId) {
      cancelAnimationFrame(animId);
      animId = null;
    }

    rotation = end;
    drawWheel(rotation);

    try {
      callback(target, idx);
    } catch (e) {
      console.error("âŒ spin callback crashed:", e);
    }

    rotating = false;
    applyUIState(); // ğŸŸ¢ å›ç¶ ç‡ˆ
    console.log("ğŸŸ¢ spin finished, state =", systemState);
  }

  function frame(now) {
    if (finished) return;

    // ğŸ›¡ ç¡¬åœä¿éšª
    if (now >= hardStopAt) {
      finish();
      return;
    }

    let t = (now - start) / DURATION;
    if (t < 0) t = 0;

    if (t >= 1) {
      finish();
      return;
    }

    rotation = base + delta * ease(t);
    drawWheel(rotation);

    animId = requestAnimationFrame(frame);
  }

  animId = requestAnimationFrame(frame);
}

/* ========= å„²å­˜ç‹€æ…‹ ========= */
function saveState(extra = {}) {
  if (!IS_MASTER) return;      // ğŸ”’ éä¸»æ§é ç¦æ­¢å¯«ç‹€æ…‹ï¼ˆä¸€å®šè¦ç¬¬ä¸€è¡Œï¼‰

  lastHeartbeat = Date.now(); // ğŸ”„ å¿ƒè·³åŒæ­¥ï¼ˆå•†ç”¨ç´šåˆ†é å­˜æ´»æ¨™è¨˜ï¼‰

  const prev = (() => {
    try {
      return JSON.parse(sessionStorage.getItem("spinState")) || {};
    } catch {
      return {};
    }
  })();

  sessionStorage.setItem("spinState", JSON.stringify({
    names,
    usedName: [...usedName],
    verseUsed: [...verseUsed],
    currentVerse,
	round2Started,
    rotation,          // âœ… å¿…å­˜
    lastWinnerIndex,  // âœ… å¿…å­˜
	
    // ===== PDF è¼ªæ¬¡é˜²å‘†ç‹€æ…‹ï¼ˆå¿…å­˜ï¼‰=====	
	pdfRoundSerial,
    pdfRepeatCount,

// âœ… round2Done æ­£ç¢ºç¹¼æ‰¿é‚è¼¯
round2Done:
  typeof extra.round2Done === "boolean"
    ? extra.round2Done
    : !!prev.round2Done,

// ğŸ”’ finished å•†ç”¨ç´šæ§åˆ¶æ¬Šï¼ˆå¯æ‰‹å‹•è¦†å¯«ï¼‰
finished:
  typeof extra.finished === "boolean"
    ? extra.finished
    : (usedName.size === names.length),

// â­ å…ˆå±•é–‹æµç¨‹æ§åˆ¶ï¼ˆå…è¨± round2Done / finished è¢«æ”¹ï¼‰
...extra,

// ğŸ” æœ€å¾Œæ‰å¯«ä¸»æ§æ¬Šï¼ˆæ°¸é ä¸å¯è¢«è¦†è“‹ï¼‰
tabId: TAB_ID,
heartbeat: Date.now(),
  }));
}

/* ========= è¼‰å…¥ç‹€æ…‹ï¼ˆä¸è‡ªå‹•æ—‹è½‰ï¼‰ ========= */
function loadState(){
  rotating = false;   // â˜… å¼·åˆ¶è§£é™¤æ­»é–

  // â­ PATCH A-1ï¼šæ˜¯å¦å¾ viewer å›ä¾†ï¼ˆä¸€å®šè¦åœ¨æœ€å‰é¢ï¼‰
  const cameFromViewer =
    sessionStorage.getItem("showSummaryOnReturn") === "1";

  const raw = sessionStorage.getItem("spinState");

  /* ===== å®Œå…¨æ²’æœ‰ä»»ä½•ç‹€æ…‹ï¼šåˆå§‹ç•«é¢ ===== */
if(!raw){
  clearHL();
  drawInitialWheel();
  statusDiv.textContent = "è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®";
  return;
}

  let s;
  try{
    s = JSON.parse(raw);

// ===== é‚„åŸç³»çµ±ç‹€æ…‹ï¼ˆåªé‚„åŸï¼Œä¸åˆ¤æ–·ï¼‰=====
systemState = s.finished
  ? SYS_STATE.FINISHED
  : (s.round2Done
      ? SYS_STATE.VIEWER
      : (s.lastWinnerIndex >= 0
          ? SYS_STATE.ROUND2
          : (s.names && s.names.length
              ? SYS_STATE.READY
              : SYS_STATE.INIT
            )
        )
    );
	
  }catch(e){
    clearHL();
    drawInitialWheel();
    return;
  }

  /* ===== é‚„åŸæ ¸å¿ƒè³‡æ–™ ===== */
names        = Array.isArray(s.names) ? s.names : [];
usedName     = new Set(s.usedName || []);
verseUsed    = new Set(s.verseUsed || []);
currentVerse = s.currentVerse || null;
rotation     = typeof s.rotation === "number" ? s.rotation : 0;
lastWinnerIndex = (s.lastWinnerIndex ?? -1);
round2Started = !!s.round2Started;

// ===== é‚„åŸ PDF è¼ªæ¬¡é˜²å‘†ç‹€æ…‹ =====
pdfRoundSerial = s.pdfRoundSerial || null;
pdfRepeatCount = s.pdfRepeatCount || 0;
pdfDownloadedThisRound = !!pdfRoundSerial;

const round2Done = !!s.round2Done;

    // === A-3ï¼šé‚„åŸå§“åè¼¸å…¥æ¡†å…§å®¹ ===
  nameInput.value = names.join(" ");

  /* ===== é‡ç•«è½‰ç›¤ï¼ˆåªç•«ä¸€æ¬¡ï¼‰===== */
  clearHL();                 // â˜… å¿…åŠ ï¼šé¿å…æ®˜å½±
  drawWheel(rotation);

  /* ===== è‹¥å·²æœ‰ç¬¬ä¸€è¼ªçµæœï¼Œé¡¯ç¤ºé«˜äº® ===== */
  if(lastWinnerIndex >= 0){
    showHL(lastWinnerIndex);
  }

  /* ===== UI ç‹€æ…‹åŒæ­¥ ===== */
  const total = names.length;
  const drawn = usedName.size;
 
  // ===== å•é¡Œ Bï¼šå–æ¶ˆé«˜äº®é–ƒçˆ =====
  document.querySelectorAll("#hl-svg .blink")
    .forEach(el => el.classList.remove("blink"));
	
	
  /* é–å®šåå–®ï¼šæŠ½ç±¤ä¸­ä¸å¯å†é–ï¼Œå…¨éƒ¨æŠ½å®Œæ‰å¯ */
  lockBtn.disabled = (drawn > 0 && drawn < total);

  /* ç¬¬ä¸€è¼ªï¼šé‚„æ²’å…¨éƒ¨æŠ½å®Œæ‰å¯ */
  spinBtn.disabled = (drawn >= total);

// ===== ç¬¬äºŒè¼ªï¼šåªæœ‰ã€Œå‰›å®Œæˆç¬¬ä¸€è¼ªã€æ‰å¯ç”¨ =====
if (
  lastWinnerIndex >= 0 &&
  !round2Done &&
  rotating === false &&
  !cameFromViewer   // â­ é—œéµï¼šå¾ viewer å›ä¾†ä¸€å¾‹é–æ­»
){
  secondBtn.disabled = false;
  secondBtn.classList.add("blink-btn");
}else{
  secondBtn.disabled = true;
  secondBtn.classList.remove("blink-btn");
}

  /* çœ‹ç´…åŒ…ï¼šå¿…é ˆå®Œæˆç¬¬äºŒè¼ª */
  if(round2Done && currentVerse){
    viewBtn.disabled = false;
    
  }else{
    viewBtn.disabled = true;
    
  }

  /* PDFï¼šå…¨éƒ¨æŠ½å®Œæ‰å¯ */
  pdfBtn.disabled = !(drawn === total);
 
  /* ===== æ¸…é™¤éŒ¯èª¤æ®˜ç•™æ–‡å­— ===== */
  if(resultDiv && resultDiv.textContent.includes("æ—‹è½‰ä¸­")){
    resultDiv.textContent = "";
  }

/* ===== ğŸ”’ FINAL LOCKï¼šå¾ viewer å›ä¾†å¾Œçš„ UIï¼ˆå”¯ä¸€ç‰ˆæœ¬ï¼‰ ===== */

const fromViewer =
  sessionStorage.getItem("showSummaryOnReturn") === "1";
  
  // ğŸ§¹ ä¿è­‰ä¸æœƒæ®˜ç•™ç¬¬ä¸€è¼ªé–ƒçˆï¼ˆé¿å…è·Ÿç¬¬äºŒè¼ªä¸€èµ·é–ƒï¼‰
spinBtn.classList.remove("blink-btn");

if (fromViewer) {

  /* ===== æƒ…æ³ Aï¼šå°šæœªå…¨éƒ¨æŠ½å®Œ ===== */
  if (drawn < total) {

    // è½‰ç›¤ä¸‹æ–¹æç¤º
    statusDiv.textContent = "è«‹ç¹¼çºŒä¸‹ä¸€ä½æŠ½ç¶“å¥ç´…åŒ…";

    // ç¬¬ä¸€è¼ªï¼šå”¯ä¸€å…¥å£ â†’ å•Ÿç”¨ + é–ƒçˆ
    spinBtn.disabled = false;
    spinBtn.classList.add("blink-btn");

    // å…¶ä»–å…¥å£å…¨éƒ¨é–æ­»
    secondBtn.disabled = true;
    secondBtn.classList.remove("blink-btn");
    viewBtn.disabled = true;
    
	
	// ğŸ”’ Viewer å›ä¾†æœŸé–“ï¼šé–å®šåå–® / PDF ä¸€å¾‹é—œé–‰
    lockBtn.disabled = true;
    pdfBtn.disabled = true;
    pdfBtn.classList.remove("btn-pdf-ready");

  }

  /* ===== æƒ…æ³ Bï¼šå…¨éƒ¨äººå·²æŠ½å®Œ ===== */
  else if (total > 0 && drawn === total) {
  systemState = SYS_STATE.FINISHED;
    nameInput.disabled = false;
  applyUIState();
  
  statusDiv.textContent = "";   // âœ… æ¸…é™¤ã€Œè«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®ã€

    // æŒ‡å®šä¸‰è¡Œæç¤º
    summaryBox.textContent =
      `ğŸ‰ æ­¤è¼ªè½‰ç›¤å·²å®Œæˆ ${total} ä½çš„ç´…åŒ…æŠ½ç±¤\n` +
      `ğŸ“„ è«‹æŒ‰ã€ŒæŠ½ç±¤ç´€éŒ„ PDFã€ä¸‹è¼‰ç´€éŒ„ï¼Œæˆ–\n` +
      `ğŸ” è¼¸å…¥æ–°å§“å â†’ æŒ‰ã€Œé–å®šåå–®ã€é–‹å§‹ä¸‹ä¸€è¼ªï¼›ä¹Ÿå¯æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€`;

    // æŠ½ç±¤ç´€éŒ„ PDFï¼šæ•´é¡†è—è‰²
    pdfBtn.disabled = false;
    pdfBtn.classList.add("btn-pdf-ready");

// âœ… å…¨éƒ¨æ­¸é›¶ï¼šæ•´é¡†ç´…è‰²ï¼ˆä¸å¯å†è¢«è¦†è“‹ï¼‰
resetBtn.disabled = false;          // â† å¿…åŠ ï¼Œä¸ç„¶ç´…è‰²åªæ˜¯è£é£¾
resetBtn.classList.add("btn-reset-danger");

    // æ‰€æœ‰æŠ½ç±¤å…¥å£é–æ­»
    spinBtn.disabled   = true;
    secondBtn.disabled = true;
    viewBtn.disabled   = true;

    spinBtn.classList.remove("blink-btn");
    secondBtn.classList.remove("blink-btn");
    
  }

  // âœ… æ‰€æœ‰ fromViewer å°ˆå±¬ UI éƒ½è™•ç†å®Œï¼Œæœ€å¾Œæ‰æ¸…æ——æ¨™
  sessionStorage.removeItem("showSummaryOnReturn");
}
}

/* ========= æŠ½ç±¤ç´€éŒ„å¯«å…¥ localStorage ========= */
function appendLog(name, no, ref){
  let logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
  
  // â° çµ±ä¸€æ™‚é–“æ ¼å¼ï¼ˆä¸‹åˆ 03:57:30ï¼‰
  const timeStr = formatTime2(new Date());
  logs.push({
    time: timeStr,
    name,
    no,
    ref
  });
  localStorage.setItem("drawLogs", JSON.stringify(logs));
}

/* ========= PDF æª”åæµæ°´è™Ÿï¼ˆæ°¸ä¹…ç´¯åŠ ï¼Œä¸å— Reset å½±éŸ¿ï¼‰========= */
function getNextBlessingPdfSerial(){
  let n = parseInt(localStorage.getItem("pdfSerial") || "0", 10);
  n++;
  if (n > 999) n = 1;
  localStorage.setItem("pdfSerial", String(n));
  return String(n).padStart(3, "0");
}

/* ========= é–å®šåå–® ========= */
lockBtn.onclick = () => {
  if (!canAct()) return;
  audit("LOCK_LIST", {
    count: nameInput.value.trim().split(/[\s,ï¼Œã€]+/).filter(Boolean).length
  });
  unlockAudio();

  // ğŸŸ¢ æ–°ä¸€è¼ªå¼·åˆ¶åˆå§‹åŒ–
  systemState = SYS_STATE.INIT;
    nameInput.disabled = false;

  usedName.clear();
  verseUsed.clear();
  currentVerse = null;
  lastWinnerIndex = -1;
  rotation = 0;
  rotating = false;

  pdfRoundSerial = null;
  pdfRepeatCount = 0;
  pdfDownloadedThisRound = false;
  round2Started = false; // â­ æ–°ä¸€è¼ªä¸€å®šè¦é‡ç½®ç¬¬äºŒè¼ªé–

  const arr = nameInput.value
    .split(/[\s,ï¼Œã€]+/)
    .map(x => x.trim())
    .filter(Boolean);

  if (arr.length < 2) {
    alert("è‡³å°‘å…©ä½å§“å");
    return;
  }
  if (new Set(arr).size !== arr.length) {
    alert("Oops, æœ‰å§“åé‡è¤‡è¼¸å…¥äº†å”·!");
    return;
  }

  names = arr;
  usedName.clear();
  verseUsed.clear();
  rotation = 0;
  currentVerse = null;

  clearHL();
  drawWheel(0);

  lockBtn.disabled = true;
  spinBtn.disabled = false;

  summaryBox.textContent = "";

  pdfBtn.classList.remove("btn-pdf-ready");
  resetBtn.classList.remove("btn-reset-danger");

  statusDiv.textContent = "åå–®å·²é–å®šï¼Œè«‹é–‹å§‹æŠ½ç±¤";
  systemState = SYS_STATE.READY;
  applyUIState();

  saveState({
    round2Done: false,
    finished: false
  });
};

/* ========= ç¬¬ä¸€è¼ª ========= */
spinBtn.onclick = () => {
  if (!canAct()) return;
  if (rotating) return;
  unlockAudio();

  spinBtn.disabled = true;
  spinBtn.classList.remove("blink-btn");

  statusDiv.textContent = "æ—‹è½‰ä¸­...";

  secondBtn.disabled = true;
  secondBtn.classList.remove("blink-btn");

  viewBtn.disabled = true;
  

  clearHL();
  centerText.textContent = "";
  summaryBox.textContent = "";

  const remain = names.filter(n => !usedName.has(n));
  if (!remain.length) return;

  audit("ROUND1_START", { remaining: remain.length });
  systemState = SYS_STATE.ROUND1;
  applyUIState();

  pdfBtn.disabled = true;
  lockBtn.disabled = true;

  spin(remain, true, (winner) => {
    usedName.add(winner);
    lastWinnerIndex = names.indexOf(winner);

    clearHL();
    showHL(lastWinnerIndex);

    const drawnCount = usedName.size;
    const totalCount = names.length;

    statusDiv.textContent = "";
    resultDiv.textContent =
      `ğŸ¯ æŠ½ä¸­ã€Œ${winner}ã€\nï¼ˆç¬¬ ${drawnCount} ä½ï¼å…± ${totalCount} ä½ï¼‰`;

    // ğŸŸ¢ é–‹æ”¾ç¬¬äºŒè¼ª
    round2Started = false;
    systemState = SYS_STATE.ROUND2;
    applyUIState();

    secondBtn.disabled = false;
    secondBtn.classList.add("blink-btn");

    saveState({ round2Done: false });
  });
};

/* ========= ç¬¬äºŒè¼ª ========= */
secondBtn.onclick = () => {
  if (!canAct()) return;
  if (rotating) return;
  if (round2Started) return; // ğŸ”’ é˜²é‡è¤‡
  round2Started = true;

  unlockAudio();

  secondBtn.disabled = true;
  secondBtn.classList.remove("blink-btn");

  systemState = SYS_STATE.ROUND2;
  applyUIState();

  clearHL();
  centerText.textContent = "";

  const remain = [...Array(128).keys()]
    .map(i => String(i + 1).padStart(3, "0"))
    .filter(v => !verseUsed.has(v));

  if (!remain.length) {
    systemState = SYS_STATE.FINISHED;
    nameInput.disabled = false;
    applyUIState();
    return;
  }

  audit("ROUND2_START", { remaining: remain.length });

  spin(remain, false, (v) => {
    verseUsed.add(v);
    currentVerse = v;

    const ref =
      (window.VERSE_REF_MAP && window.VERSE_REF_MAP[v])
        ? window.VERSE_REF_MAP[v]
        : "";
		
	// â­ å»£æ’­çµ¦æ‰€æœ‰ Viewerï¼šæœ€å¾ŒæŠ½ä¸­çš„ç¶“å¥
  localStorage.setItem("LAST_VERSE", JSON.stringify({
    verse: v,
    ref: ref,
    time: Date.now()
  }));	

    // UI é¡¯ç¤º
    statusDiv.textContent = "";
    resultDiv.textContent =
      `ç¬¬äºŒè¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ${v}ã€`;

    centerText.textContent =
      `ğŸ“œ æŠ½ä¸­ç¶“å¥ã€Œ${v}ã€\nğŸ“– ${ref}`;

    // ğŸ”Š éŸ³æ•ˆ
    try {
      winSound.currentTime = 0;
      winSound.play();
    } catch (e) {}

    // ğŸ‰ å½©å¸¶
    launchConfetti();

    // ğŸ”’ é–æ­»æŠ½ç±¤éµ
    spinBtn.disabled = true;
    secondBtn.disabled = true;
    spinBtn.classList.remove("blink-btn");
    secondBtn.classList.remove("blink-btn");

    // ğŸ‘ å•Ÿç”¨ Viewer
    viewBtn.disabled = false;
    

    // âœ” ç´€éŒ„
    appendLog(names[lastWinnerIndex], v, ref);

    // ğŸŸ¢ é€² Viewer ç‹€æ…‹
    systemState = SYS_STATE.VIEWER;
    applyUIState();

    saveState({
  round2Done: true,
  currentVerse: currentVerse
});
// ğŸ”” æç¤ºä¸»æŒäººå¯ä»¥çœ‹ç´…åŒ…
if (typeof viewBtn !== "undefined" && viewBtn) {
  viewBtn.classList.add("blink-all");
}
  });
  };

/* ========= çœ‹ç´…åŒ… ========= */
viewBtn.onclick = () => {
  if (!canAct()) return;
  if (!currentVerse) return;

  const winnerName = names[lastWinnerIndex] || "";

  // åƒ…å„²å­˜ç‹€æ…‹ï¼Œä¸è‡ªå‹•è½‰å‹•
  systemState = SYS_STATE.VIEWER;
  applyUIState();
  saveState();

  // ğŸ”• é€² Viewer å‰åœæ­¢é–ƒçˆï¼ˆé˜²å‘†ï¼‰
  if (viewBtn && viewBtn.classList) {
    viewBtn.classList.remove("blink-all");
  }

  window.location.href =
    `viewer.html?no=${currentVerse}&name=${encodeURIComponent(winnerName)}`;
};

/* ========= PDFï¼šä¸‹è¼‰æŠ½ç±¤ç´€éŒ„ï¼ˆCanvas â†’ Image â†’ PDF ç©©å®šç‰ˆï½œå”¯ä¸€ç‰ˆæœ¬ï¼‰ ========= */
pdfBtn.onclick = async () => {
  if (!canAct()) return;   // âœ… å¿…é ˆç¬¬ä¸€è¡Œ

  try {
    const logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
    if (!logs.length) {
      alert("æ²’æœ‰å¯ä¸‹è¼‰çš„æŠ½ç±¤ç´€éŒ„");
      return;
    }

    /* ===== è¼ªæ¬¡é˜²å‘† ===== */
    if (pdfDownloadedThisRound) {
      const ok = confirm(
        "é€™ä¸€è¼ªæ‚¨å·²ç¶“ä¸‹è¼‰éPDFäº†, æ˜¯å¦è¦å†ä¸‹è¼‰ä¸€æ¬¡å‘¢ (Yes or No)?"
      );
      if (!ok) return;
      pdfRepeatCount++;
    } else {
      pdfDownloadedThisRound = true;
      pdfRepeatCount = 0;
    }
    audit("PDF_DOWNLOAD_ATTEMPT", {
      isRepeat: pdfDownloadedThisRound,
      repeatCount: pdfRepeatCount,
      serial: pdfRoundSerial
    });

    /* ===== æµæ°´è™Ÿï¼ˆæœ¬è¼ªåªå–ä¸€æ¬¡ï¼‰ ===== */
    if (!pdfRoundSerial) {
      pdfRoundSerial = getNextBlessingPdfSerial();
    }

    let filename = `Blessing_envelop_${pdfRoundSerial}`;
    if (pdfRepeatCount > 0) {
      filename += `-${pdfRepeatCount}`;
    }
    filename += `.pdf`;

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    /* ===== ç•«å¸ƒå°ºå¯¸èˆ‡ç‰ˆå‹é–æ­»ï¼ˆç­‰åŒ 010.pdfï¼‰ ===== */
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const MARGIN = 60;
    const LINE_H = 32;
    const WIDTH = 1240;

    canvas.width = WIDTH;
    canvas.height = MARGIN * 2 + (logs.length + 6) * LINE_H;

    /* èƒŒæ™¯ */
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    /* æ¨™é¡Œå­—å‹ */
    ctx.fillStyle = "#000000";
    ctx.font = "28px 'Noto Sans TC','PingFang TC','Microsoft JhengHei',Arial,sans-serif";

    let y = MARGIN;

/* ===== æ¨™é¡Œï¼ˆ+25% æ”¾å¤§ + åŠ ç²—ï¼‰ ===== */
ctx.font = "bold 35px 'Noto Sans TC','PingFang TC','Microsoft JhengHei',Arial,sans-serif";
ctx.fillText("ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰", MARGIN, y);
y += LINE_H * 2.2;

/* ===== å°æ¨™ï¼ˆ+10% æ”¾å¤§ + åŠ ç²—ï¼‰ ===== */
ctx.font = "bold 26px 'Noto Sans TC','PingFang TC','Microsoft JhengHei',Arial,sans-serif";
ctx.fillText("æŠ½ç±¤ç´€éŒ„", MARGIN, y);
y += LINE_H * 1.4;

/* ===== å…§å®¹ï¼ˆæ­£å¸¸å­—é‡ï¼‰ ===== */
ctx.font = "22px 'Noto Sans TC','PingFang TC','Microsoft JhengHei',Arial,sans-serif";

logs.slice().reverse().forEach(l => {
  const line = `[${l.time}] ã€Œ${l.name}ã€ â†’ æŠ½ä¸­ç¶“å¥ç´…åŒ…: ${l.ref}`;
  y = wrapText(ctx, line, MARGIN, y, WIDTH - MARGIN * 2, LINE_H);
});

    /* ===== å³ä¸Šè§’é çœ‰ï¼ˆå›ºå®šä½ç½®ï¼‰ ===== */
    ctx.font = "18px Arial";
    ctx.textAlign = "right";
    ctx.fillText(
      "Blessing Envelop System Â© 2026 | Page 1",
      WIDTH - MARGIN,
      40
    );
    ctx.textAlign = "left";

    /* ===== Canvas â†’ PDF ===== */
    const imgData = canvas.toDataURL("image/png");

    const pageWidth = pdf.internal.pageSize.getWidth();
    const imgWidth = pageWidth - 20;
    const imgHeight = (canvas.height / canvas.width) * imgWidth;

    pdf.addImage(imgData, "PNG", 10, 10, imgWidth, imgHeight);
    pdf.save(filename);
	
// âœ… æœ¬è¼ªæ­£å¼çµæ¡ˆ
systemState = SYS_STATE.FINISHED;
    nameInput.disabled = false;
saveState({ finished: true });
audit("ROUND_CLOSED_BY_PDF", { serial: pdfRoundSerial });
applyUIState();

  } catch (e) {
    console.error(e);
    alert("PDF ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹æŸ¥çœ‹ console");
  }
};

/* ===== Canvas è‡ªå‹•æ›è¡Œå·¥å…·ï¼ˆç©©å®šç‰ˆï¼Œæœƒå›å‚³æœ€æ–° yï¼‰ ===== */
function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  let line = "";

  for (let i = 0; i < text.length; i++) {
    const testLine = line + text[i];
    if (ctx.measureText(testLine).width > maxWidth && line) {
      ctx.fillText(line, x, y);
      line = text[i];
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line, x, y);
  return y + lineHeight;
}

/* ========= åˆå§‹åŒ– ========= */
loadState();

if (!claimMaster()) {
  alert("æ­¤è½‰ç›¤ç³»çµ±å·²è¢«å¦ä¸€å°ä¸»æŒæ©Ÿé–å®š");
  setStatusLight("error", "ä¸»æŒæ©Ÿå·²è¢«ä½”ç”¨");
}


function updateHostStatus(){
  const hostStatus = document.getElementById("hostStatus");
  if (!hostStatus) return;
  if (IS_MASTER) {
    hostStatus.textContent = "ğŸ¤ ä¸»æŒæ©Ÿåœ¨ç·š";
    hostStatus.classList.add("ok");
    hostStatus.classList.remove("warn");
  } else {
    hostStatus.textContent = "ğŸ¤ ä¸»æŒæ©Ÿé›¢ç·š";
    hostStatus.classList.add("warn");
    hostStatus.classList.remove("ok");
  }
}
updateHostStatus();
// ==== ä¸»æ§é æ‰å…è¨±é€å¿ƒè·³ ====
if (IS_MASTER) {
  setInterval(() => {
    const raw = sessionStorage.getItem("spinState");
    if (!raw) return;

    try {
      const s = JSON.parse(raw);
      if (s.tabId === TAB_ID) {
        s.heartbeat = Date.now();
        sessionStorage.setItem("spinState", JSON.stringify(s));
      }
    } catch(e) {}
  }, 2000);
}

/* ========= å…¨éƒ¨æ­¸é›¶ï¼ˆæœ€é«˜å„ªå…ˆæ¬Š Reset æ ¸å¿ƒï¼‰ ========= */
resetBtn.onclick = () => {
  if (!canAct()) return;   // âœ… å¿…é ˆç¬¬ä¸€è¡Œ

  const msg =
`è³‡æ–™ç´€éŒ„å°‡è¢«æ¸…ç©º(clear) & æ­¸é›¶(reset)ï¼Œ
éœ€é‡æ–°è¼¸å…¥å§“åä¸¦é–å®šåå–®é–‹å§‹æ–°è½‰ç›¤éŠæˆ²ï¼
æ‚¨ç¢ºå®šè¦åŸ·è¡Œå— (Yes or No)?`;

  // ğŸ”’ é˜²èª¤è§¸
  if (!confirm(msg)) return;

  // ğŸ“‹ ç¨½æ ¸ï¼šè¨˜éŒ„ã€Œé‡ç½®ç™¼ç”Ÿæ™‚çš„ç‹€æ…‹ã€
  audit("ROUND_CLOSED_BY_RESET", { state: systemState });
  audit("SYSTEM_RESET_ATTEMPT", { state: systemState });

  /* ===== 1ï¸âƒ£ æ¸…ç©ºæ ¸å¿ƒè³‡æ–™ ===== */
  names = [];
  usedName.clear();
  verseUsed.clear();
  currentVerse = null;
  lastWinnerIndex = -1;
  rotation = 0;
  rotating = false;

  /* ===== Reset PDF æœ¬è¼ªé˜²å‘†ç‹€æ…‹ ===== */
  pdfRoundSerial = null;
  pdfRepeatCount = 0;
  pdfDownloadedThisRound = false;

  /* ===== 2ï¸âƒ£ ç³»çµ±ç‹€æ…‹æ©Ÿæ­¸é›¶ ===== */
  systemState = SYS_STATE.INIT;
    nameInput.disabled = false;

  /* ===== 3ï¸âƒ£ æ¸… Storage ===== */
  localStorage.removeItem("drawLogs");
  localStorage.removeItem("pdfSerial");
  sessionStorage.removeItem("spinState");
  sessionStorage.removeItem("showSummaryOnReturn");

  /* ===== 4ï¸âƒ£ æ¸…ç•«é¢ ===== */
  clearHL();
  drawInitialWheel();

  nameInput.value = "";
  centerText.textContent = "";
  resultDiv.textContent = "";
  summaryBox.textContent = "";
  statusDiv.textContent = "è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®";

  /* ===== 5ï¸âƒ£ é‚„åŸæ‰€æœ‰æŒ‰éˆ•ç‹€æ…‹ï¼ˆINITï¼‰ ===== */
  lockBtn.disabled = false;
  spinBtn.disabled = true;
  secondBtn.disabled = true;
  viewBtn.disabled = true;
  pdfBtn.disabled = true;

  spinBtn.classList.remove("blink-btn");
  secondBtn.classList.remove("blink-btn");
  

  pdfBtn.classList.remove("btn-pdf-ready");
  resetBtn.classList.remove("btn-reset-danger");

  resetBtn.disabled = false;

  /* ===== 6ï¸âƒ£ UI åŒæ­¥ ===== */
  applyUIState();

  console.log("ğŸ”„ System Reset â†’ INIT");

  /* ===== 7ï¸âƒ£ å­˜ä¹¾æ·¨å¿«ç…§ï¼ˆå”¯ä¸€ä¸€æ¬¡ï¼‰ ===== */
  saveState();
};

})(); 

// ===============================
// ç®¡ç†åŠŸèƒ½ï¼šå¼·åˆ¶è§£é™¤ä¸»æŒæ©Ÿä½”ç”¨
// ===============================
document.addEventListener("DOMContentLoaded", () => {
  const forceBtn = document.getElementById("btnForceRelease");
  if (!forceBtn) return;

  forceBtn.addEventListener("click", () => {
    const ok = confirm("é€™å°‡å¼·åˆ¶é‡‹æ”¾æ‰€æœ‰ä¸»æŒæ¬Šé–å®šï¼Œç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ");
    if (!ok) return;

    localStorage.removeItem("hostLock");
    localStorage.removeItem("hostTimestamp");
    localStorage.removeItem("hostId");

    if (window.BroadcastChannel) {
      const bc = new BroadcastChannel("blessing_host");
      bc.postMessage({ type: "force-release" });
      bc.close();
    }

    alert("ä¸»æŒæ¬Šå·²å¼·åˆ¶é‡‹æ”¾ï¼Œè«‹é‡æ–°æ•´ç†é é¢ä½¿ç”¨");
    location.reload();
  });
});

</script>

<script>
// =============================
// ğŸ“± æœ¬åœ° QR Codeï¼ˆç©©å®šç‰ˆï¼‰
// =============================
(function initLocalQR(){

  function run(){
    if (typeof QRCode !== "function") {
      console.warn("âš  QRCode.js å°šæœªè¼‰å…¥, è·³éQRä¸å½±éŸ¿ç³»çµ±");
      return;
    }

    const box = document.getElementById("qrCanvas");
    if (!box) {
      console.warn("âš  æ‰¾ä¸åˆ° qrCanvas");
      return;
    }

    // GitHub Pages / å­ç›®éŒ„å®‰å…¨è·¯å¾‘
    const base =
      location.origin +
      location.pathname.replace(/\/[^\/]*$/, "/");

    const viewerUrl = base + "viewer.html";

    // æ¸…ç©ºèˆŠ QRï¼ˆé¿å…ç–ŠåŠ ï¼‰
    box.innerHTML = "";

    new QRCode(box, {
      text: viewerUrl,
      width: 140,
      height: 140,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });

    console.log("ğŸ“± Local QR ready:", viewerUrl);
	
	// ğŸ–± é» QR æ”¶åˆ / å±•é–‹
const qrBox = document.getElementById("qrBox");
if (qrBox) {
  qrBox.onclick = () => {
    qrBox.classList.toggle("collapsed");
  };
}
	
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", run, { once: true });
  } else {
    run();
  }

})();
</script>

<script>
// =============================
// ğŸ“‹ è¤‡è£½çœ‹ç´…åŒ…é€£çµï¼ˆå•†ç”¨ç©©å®šç‰ˆï¼‰
// =============================
(function initCopyViewerLink(){

  function run(){
    const btn = document.getElementById("copyViewerLink");
    if (!btn) {
      console.warn("âš  æ‰¾ä¸åˆ° copyViewerLink æŒ‰éˆ•");
      return;
    }

    // GitHub Pages / å­ç›®éŒ„å®‰å…¨è·¯å¾‘
    const base =
      location.origin +
      location.pathname.replace(/\/[^\/]*$/, "/");

    const viewerUrl = base + "viewer.html";

    btn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(viewerUrl);

        const oldText = btn.textContent;
        btn.textContent = "âœ… å·²è¤‡è£½";
        btn.disabled = true;

        setTimeout(() => {
          btn.textContent = "ğŸ“‹ è¤‡è£½çœ‹ç´…åŒ…é€£çµ";
          btn.disabled = false;
        }, 1500);

        console.log("ğŸ“‹ Viewer link copied:", viewerUrl);
      } catch (err) {
        console.warn("âš  è¤‡è£½å¤±æ•—ï¼Œæ”¹ç”¨æç¤ºæ¨¡å¼", err);
        prompt("è«‹æ‰‹å‹•è¤‡è£½é€£çµï¼š", viewerUrl);
      }
    };
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", run, { once: true });
  } else {
    run();
  }

})();
</script>

<script>
// =============================
// ğŸ‘¥ Viewer è¨ˆæ•¸ï¼ˆä¿å‘½ç‰ˆï¼‰
// =============================
if (typeof updateViewerCount !== "function") {
  function updateViewerCount() {
    const KEY = "BLESSING_VIEWERS";
    const TTL = 30000;

    let viewers = {};
    try {
      viewers = JSON.parse(localStorage.getItem(KEY) || "{}");
    } catch {
      viewers = {};
    }

    const now = Date.now();
    let count = 0;

    Object.keys(viewers).forEach(id => {
      if (now - viewers[id] < TTL) {
        count++;
      } else {
        delete viewers[id];
      }
    });

    localStorage.setItem(KEY, JSON.stringify(viewers));

    const el = document.getElementById("viewerStatus");
    if (!el) return;

    if (count > 0) {
      el.textContent = `ğŸ‘¥ è§€çœ¾é€£ç·šä¸­ (${count})`;
      el.className = "ok";
    } else {
      el.textContent = "ğŸ‘¥ å°šç„¡è§€çœ¾";
      el.className = "warn";
    }
  }
}

//æ¯3ç§’æ›´æ–°ä¸€æ¬¡
setInterval(updateViewerCount, 3000);
</script>

</body>
</html>