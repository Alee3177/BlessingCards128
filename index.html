<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BlessingCards128ï½œç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</title>
  <style>
    :root{
      --bg:#fff8e7;
      --text:#5b3a00;
      --gold:#f7c76c;
      --gold2:#f3b84f;
      --line:#ffffff;
      --warn:#c0392b;
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:"Noto Sans TC", system-ui, -apple-system, "PingFang TC", "Microsoft JhengHei", sans-serif;
      text-align:center;
      padding:22px;
    }
    h1{
      margin:10px 0 12px;
      color:#b07500;
      font-size:26px;
      font-weight:800;
    }
    .logo{ width:120px; margin:0 auto 14px; display:block; }
    #nameInput{
      width:280px;
      padding:10px;
      font-size:18px;
      border-radius:8px;
      border:1px solid #bf8a3e;
      outline:none;
      margin-bottom:12px;
      background:#fff;
      color:var(--text);
    }
    .btn{
      background:var(--gold);
      border:none;
      padding:12px 22px;
      border-radius:25px;
      font-size:18px;
      color:var(--text);
      cursor:pointer;
      margin:6px;
      transition:transform .02s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{ background:var(--gold2); }
    .btn:active{ transform:translateY(1px); }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }
    @keyframes blink{0%{opacity:1}50%{opacity:.25}100%{opacity:1}}
    .blinking{ animation:blink 1s infinite; }
    #wheelContainer{
      position:relative;
      width:380px;
      height:380px;
      margin:22px auto 10px;
    }
    #wheelCanvas{ width:380px;height:380px; }
    #wheelPointer{
      position:absolute;
      top:-26px;
      left:50%;
      transform:translateX(-50%);
      font-size:44px;
      color:red;
      z-index:20;
      line-height:1;
      pointer-events:none;
    }
    #statusText{
      font-size:20px;
      margin-top:10px;
      color:#a56b00;
      min-height:28px;
      white-space:pre-line;
    }
    #statusText.error{ color:var(--warn); font-weight:800; }
    #centerOverlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      z-index:10;
    }
    #centerOverlay .box{
      background:rgba(255,255,255,.88);
      border-radius:14px;
      padding:10px 14px;
      box-shadow:0 8px 20px rgba(0,0,0,.12);
      font-weight:800;
      color:var(--text);
      line-height:1.15;
    }
    #centerOverlay .book{ font-size:20px; }
    #centerOverlay .chap{ font-size:18px; margin-top:4px; }
    .row{ display:flex; justify-content:center; flex-wrap:wrap; gap:10px; }
    .row .btn{ margin:6px 0; }
  </style>
</head>

<body>
  <h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h1>
  <img class="logo" src="logo3524.png" alt="logo">

  <input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼ˆç”¨ã€æˆ–ç©ºç™½åˆ†éš”ï¼‰">
  <div class="row">
    <button id="lockBtn" class="btn">é–å®šåå–®</button>
    <button id="startBtn" class="btn" disabled>é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
    <button id="resetBtn" class="btn">å…¨éƒ¨æ­¸é›¶</button>
    <button id="pdfBtn" class="btn">æŠ½ç±¤ç´€éŒ„ PDF</button>
  </div>

  <div class="row">
    <button id="secondBtn" class="btn" style="display:none;">æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
    <button id="viewerBtn" class="btn" style="display:none;">çœ‹ç´…åŒ…å…§å®¹</button>
  </div>

  <div id="wheelContainer">
    <div id="wheelPointer">â–¼</div>
    <canvas id="wheelCanvas" width="380" height="380"></canvas>

    <div id="centerOverlay">
      <div class="box">
        <div class="book" id="ovBook"></div>
        <div class="chap" id="ovChap"></div>
      </div>
    </div>
  </div>

  <div id="statusText">è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®</div>

  <script src="verseRefMap.js"></script>

  <script>
    /***************
     * v8.4.1 åŸºåº•ï¼šåƒ…åŠ é€Ÿ 30%ï¼ˆåœˆæ•¸ 5 â†’ 6.5ï¼‰ï¼Œå…¶é¤˜ä¸å‹•
     ***************/

    const $ = (id)=>document.getElementById(id);

    const canvas = $("wheelCanvas");
    const ctx = canvas.getContext("2d");

    const CENTER = 190;
    const RADIUS = 180;

    const lockBtn = $("lockBtn");
    const startBtn = $("startBtn");
    const resetBtn = $("resetBtn");
    const pdfBtn = $("pdfBtn");
    const secondBtn = $("secondBtn");
    const viewerBtn = $("viewerBtn");
    const statusText = $("statusText");

    const centerOverlay = $("centerOverlay");
    const ovBook = $("ovBook");
    const ovChap = $("ovChap");

    // éŸ³æ•ˆï¼ˆæ²¿ç”¨ v8.4.1ï¼‰
    const drumAudio = new Audio("audio/drum.mp3");
    drumAudio.preload = "auto";
    drumAudio.playsInline = true;

    let drumDurationMs = 5600;
    drumAudio.addEventListener("loadedmetadata", ()=>{
      if (isFinite(drumAudio.duration) && drumAudio.duration>0){
        drumDurationMs = Math.max(1200, Math.floor(drumAudio.duration*1000));
      }
    });

    function playDrum(){
      try{
        drumAudio.currentTime = 0;
        const p = drumAudio.play();
        if(p && p.catch) p.catch(()=>{});
      }catch(e){}
    }

    // ç‹€æ…‹
    let nameList = [];
    let locked = false;

    let usedNames = [];
    let usedVerses = [];

    let selectedName = null;
    let selectedVerse = null;

    let isSpinning = false;
    let phaseLock = false; // ç¬¬ä¸€è¼ªå®Œæˆå¾Œï¼Œå¿…é ˆå…ˆè·‘ç¬¬äºŒè¼ª

    // æ—‹è½‰ç‹€æ…‹
    let currentRotation = 0;

    // ---- å·¥å…· ----
    function setStatus(msg, isErr=false){
      statusText.textContent = msg;
      statusText.classList.toggle("error", !!isErr);
    }
    function pad2(n){ return String(n).padStart(2,"0"); }

    function nowStamp(){
      const d = new Date();
      return `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }

    function parseNames(raw){
      return raw.split(/[,ã€\s]+/).map(s=>s.trim()).filter(Boolean);
    }

    function hasDuplicates(arr){
      const s = new Set();
      for(const x of arr){
        if(s.has(x)) return true;
        s.add(x);
      }
      return false;
    }

    function easeOutCubic(t){
      return 1 - Math.pow(1-t, 3);
    }

    function normalizeAngle(a){
      const TWO = Math.PI*2;
      a = a % TWO;
      if(a<0) a += TWO;
      return a;
    }

    function angleAtPointer(){
      // æŒ‡é‡åœ¨ä¸Šæ–¹æœä¸‹ï¼Œæ‰€ä»¥æŒ‡å‘åœ“ç›¤çš„è§’åº¦åŸºæº–æ˜¯ -90Â°ï¼ˆcanvas ä¸­ä¸Šæ–¹ï¼‰
      return -Math.PI/2;
    }

    // slice i çš„ä¸­å¿ƒè§’ï¼ˆæœªæ—‹è½‰æ™‚ï¼Œä»¥ -90Â° èµ·ç®—ï¼‰
    function sliceCenterAngle(i, count){
      const arc = (Math.PI*2)/count;
      return angleAtPointer() + i*arc + arc/2;
    }

    // è®“ index çš„ sliceCenterAngle è½‰åˆ°æŒ‡é‡è§’åº¦ï¼ˆå³ angleAtPointerï¼‰æ‰€éœ€çš„ base rotation
    function calcTargetRotationForIndex(index, count){
      // æ—‹è½‰å¾Œï¼šsliceCenter + rotation == angleAtPointer  (mod 2pi)
      const want = angleAtPointer();
      const center = sliceCenterAngle(index, count);
      let rot = want - center;
      rot = normalizeAngle(rot);
      return rot;
    }

    // ---- ç•«è¼ªç›¤ï¼ˆå›ºå®šåˆ†éš”ç·šç²—ç´°ã€å›ºå®šå­—é«”ï¼‰----
    function drawWheel(items){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(!items || items.length===0) return;

      const count = items.length;
      const arc = (Math.PI*2)/count;

      for(let i=0;i<count;i++){
        const start = angleAtPointer() + i*arc;
        const end = start + arc;

        ctx.beginPath();
        ctx.fillStyle = (i%2===0) ? "#fde7b5" : "#fcdca0";
        ctx.moveTo(CENTER, CENTER);
        ctx.arc(CENTER, CENTER, RADIUS, start, end);
        ctx.closePath();
        ctx.fill();

        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 2;
        ctx.stroke();

        // æ–‡å­—
        ctx.save();
        ctx.translate(CENTER, CENTER);
        const mid = start + arc/2;
        ctx.rotate(mid);
        ctx.textAlign = "right";
        ctx.font = "22px Noto Sans TC";
        ctx.fillStyle = "#5b3a00";
        ctx.fillText(items[i], RADIUS - 22, 10);
        ctx.restore();
      }
    }

    function renderWithRotation(items, rot){
      ctx.save();
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.translate(CENTER, CENTER);
      ctx.rotate(rot);
      ctx.translate(-CENTER, -CENTER);
      drawWheel(items);
      ctx.restore();
    }

    // ---- æ—‹è½‰åˆ°æŒ‡å®š indexï¼ˆè‡ªç„¶åœæ­¢ï¼›ä¸è½åœ¨ç·šä¸Šï¼‰----
    function spinToIndex(index, clockwise){
      return new Promise((resolve)=>{
        if(isSpinning) return resolve();
        isSpinning=true;
        centerOverlay.style.display='none';

        const count=nameList.length;
        const targetBase=calcTargetRotationForIndex(index,count);

        const spins=6.5,// è½‰é€Ÿ +30% (5*1.3)
         TWO=Math.PI*2, dir=clockwise?1:-1;
        let delta=normalizeAngle(targetBase-currentRotation);
        if(dir===1 && delta<0) delta+=TWO;
        if(dir===-1 && delta>0) delta-=TWO;

        const finalRotation=currentRotation + delta + dir*spins*TWO;
        const startRot=currentRotation;
        const totalDelta=finalRotation-startRot;
        const start=performance.now();

        playDrum();

        const minMs=5200;
        const durationMs=Math.max(drumDurationMs, minMs);

        function step(now){
          const t=Math.min(1,(now-start)/durationMs);
          const eased=easeOutCubic(t);
          const rot=startRot + totalDelta*eased;
          renderWithRotation(nameList, rot);
          if(t<1){
            requestAnimationFrame(step);
          }else{
            currentRotation=normalizeAngle(finalRotation);
            renderWithRotation(nameList, currentRotation);
            isSpinning=false;
            resolve();
          }
        }
        requestAnimationFrame(step);
      });
    }

    // ---- localStorage keys ----
    const K = {
      nameList:"bc_nameList",
      usedNames:"bc_usedNames",
      usedVerses:"bc_usedVerses",
      logs:"bc_drawLogs",
      selectedName:"bc_selectedName",
      selectedVerse:"bc_selectedVerse",
      phaseLock:"bc_phaseLock"
    };

    function saveState(){
      localStorage.setItem(K.nameList, JSON.stringify(nameList));
      localStorage.setItem(K.usedNames, JSON.stringify(usedNames));
      localStorage.setItem(K.usedVerses, JSON.stringify(usedVerses));
      localStorage.setItem(K.selectedName, selectedName ? selectedName : "");
      localStorage.setItem(K.selectedVerse, selectedVerse ? selectedVerse : "");
      localStorage.setItem(K.phaseLock, phaseLock ? "1" : "0");
    }

    function loadState(){
      const nl = localStorage.getItem(K.nameList);
      if(nl){
        try{ nameList = JSON.parse(nl)||[]; }catch(e){ nameList=[]; }
      }
      const un = localStorage.getItem(K.usedNames);
      if(un){
        try{ usedNames = JSON.parse(un)||[]; }catch(e){ usedNames=[]; }
      }
      const uv = localStorage.getItem(K.usedVerses);
      if(uv){
        try{ usedVerses = JSON.parse(uv)||[]; }catch(e){ usedVerses=[]; }
      }
      selectedName = localStorage.getItem(K.selectedName) || null;
      if(selectedName==="") selectedName=null;
      selectedVerse = localStorage.getItem(K.selectedVerse) || null;
      if(selectedVerse==="") selectedVerse=null;

      phaseLock = (localStorage.getItem(K.phaseLock)==="1");

      locked = Array.isArray(nameList) && nameList.length>=2;

      // æ›´æ–° UI
      if(locked){
        $("nameInput").value = nameList.join("ã€");
        setStatus(`åå–®å·²è¼‰å…¥ï¼Œå…± ${nameList.length} ä½`);
        startBtn.disabled = false;
        renderWithRotation(nameList, currentRotation);
      }else{
        setStatus("è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®");
        startBtn.disabled = true;
        drawWheel([]);
      }

      // è‹¥ç¬¬ä¸€è¼ªå‰›å®Œæˆä½†å°šæœªç¬¬äºŒè¼ªï¼Œé–ä½é–‹å§‹éµ
      if(phaseLock){
        startBtn.disabled = true;
        secondBtn.style.display = "inline-block";
        secondBtn.classList.add("blinking");
      }else{
        secondBtn.style.display = "none";
        secondBtn.classList.remove("blinking");
      }

      // è‹¥ç¬¬äºŒè¼ªå®Œæˆï¼Œé–‹å•Ÿçœ‹ç´…åŒ…
      if(selectedName && selectedVerse && !phaseLock){
        viewerBtn.style.display = "inline-block";
      }else{
        viewerBtn.style.display = "none";
      }

      updateFinishedHintIfNeeded(false);
    }

    // ---- è¨˜éŒ„ ----
    function appendLog(entry){
      const logs = getLogs();
      logs.push(entry);
      localStorage.setItem(K.logs, JSON.stringify(logs));
    }
    function getLogs(){
      const raw = localStorage.getItem(K.logs);
      if(!raw) return [];
      try{ return JSON.parse(raw)||[]; }catch(e){ return []; }
    }

    function verseRef(verse){
      if(window.VERSE_REF_MAP && window.VERSE_REF_MAP[verse]) return window.VERSE_REF_MAP[verse];
      return "";
    }

    // ---- å®Œæˆæç¤º + PDF é–ƒçˆ ----
    function isRoundFinished(){
      return locked && usedNames.length>=nameList.length;
    }

    function setPdfBlink(on){
      pdfBtn.classList.toggle("blinking", !!on);
    }

    function updateFinishedHintIfNeeded(forceBlink){
      if(!locked) return;

      if(isRoundFinished()){
        const n = nameList.length;
        setStatus(
`ğŸ‰ æ­¤è¼ªè½‰ç›¤å·²å®Œæˆ ${n} ä½çš„ç´…åŒ…æŠ½ç±¤
ğŸ“„ è«‹æŒ‰ã€ŒæŠ½ç±¤ç´€éŒ„ PDFã€ä¸‹è¼‰ç´€éŒ„ï¼Œæˆ–
ğŸ” è¼¸å…¥æ–°å§“å â†’ æŒ‰ã€Œé–å®šåå–®ã€é–‹å§‹ä¸‹ä¸€è¼ªï¼›ä¹Ÿå¯æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€`
        );
        setPdfBlink(true);
        startBtn.disabled = true;
        secondBtn.style.display = "none";
        viewerBtn.style.display = "none";
      }else{
        if(forceBlink===true){
          setPdfBlink(true);
        }
      }
    }

    // ---- é–å®šåå–® ----
    lockBtn.addEventListener("click", ()=>{
      if(isSpinning) return;

      const raw = $("nameInput").value.trim();
      if(!raw){
        alert("è«‹è¼¸å…¥å§“åï¼");
        return;
      }
      const arr = parseNames(raw);

      if(arr.length < 2){
        alert("è‡³å°‘è¦å…©ä½ï¼");
        return;
      }
      if(hasDuplicates(arr)){
        alert("Oops, æœ‰å§“åé‡è¤‡è¼¸å…¥äº†å”·ï¼");
        return;
      }

      nameList = arr;
      locked = true;

      usedNames = [];
      usedVerses = [];
      selectedName = null;
      selectedVerse = null;
      phaseLock = false;

      currentRotation = 0;
      renderWithRotation(nameList, currentRotation);

      setStatus(`åå–®å·²é–å®šï¼Œå…± ${nameList.length} ä½`);
      startBtn.disabled = false;

      secondBtn.style.display = "none";
      secondBtn.classList.remove("blinking");
      viewerBtn.style.display = "none";

      setPdfBlink(false);

      localStorage.setItem(K.logs, JSON.stringify([]));
      saveState();
    });

    // ---- ç¬¬ä¸€è¼ªï¼šæŠ½å§“å ----
    startBtn.addEventListener("click", async ()=>{
      if(isSpinning) return;
      if(!locked){
        alert("è«‹å…ˆé–å®šåå–®ï¼");
        return;
      }
      if(phaseLock){
        return;
      }
      if(isRoundFinished()){
        updateFinishedHintIfNeeded(false);
        return;
      }

      const remaining = nameList.filter(n => !usedNames.includes(n));
      if(remaining.length===0){
        updateFinishedHintIfNeeded(false);
        return;
      }

      // æŠ½ä¸­å§“å
      const winner = remaining[Math.floor(Math.random()*remaining.length)];
      const idx = nameList.indexOf(winner);

      selectedName = winner;
      selectedVerse = null;

      setStatus("ğŸ¯ ç¬¬ 1 è¼ªï¼šå§“åè¼ªç›¤æŠ½ç±¤ä¸­â€¦");
      viewerBtn.style.display="none";

      startBtn.disabled = true;
      lockBtn.disabled = true;
      resetBtn.disabled = true;
      pdfBtn.disabled = false;

      // é€†æ™‚é‡ï¼ˆclockwise=falseï¼‰
      await spinToIndex(idx, false);

      setStatus(`ğŸ¯ ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${winner}ã€`);
      phaseLock = true;

      // å‡ºç¾ç¬¬äºŒè¼ªæŒ‰éˆ•ï¼ˆé–ƒçˆï¼‰
      secondBtn.style.display = "inline-block";
      secondBtn.classList.add("blinking");

      saveState();

      lockBtn.disabled = false;
      resetBtn.disabled = false;
      // ç¬¬äºŒè¼ªå‰ç¦æ­¢å†æŒ‰é–‹å§‹
    });

    // ---- ç¬¬äºŒè¼ªï¼šæŠ½ç¶“å¥ï¼ˆä½†ç•«é¢ä»åœåœ¨åŒä¸€ä½ï¼‰----
    secondBtn.addEventListener("click", async ()=>{
      if(isSpinning) return;
      if(!selectedName){
        alert("è«‹å…ˆå®Œæˆç¬¬ä¸€è¼ªï¼");
        return;
      }
      if(!phaseLock){
        return;
      }

      secondBtn.classList.remove("blinking");
      secondBtn.style.display = "none";

      // å¾ 001-128 æŠ½ä¸é‡è¤‡
      const all = window.VERSE_REF_MAP ? Object.keys(window.VERSE_REF_MAP) : [];
      const avail = all.filter(v=>!usedVerses.includes(v));
      if(avail.length===0){
        alert("128 å€‹ç¶“å¥éƒ½å·²æŠ½å®Œï¼");
        return;
      }
      selectedVerse = avail[Math.floor(Math.random()*avail.length)];
      usedVerses.push(selectedVerse);

      // æ—‹è½‰ï¼šé †æ™‚é‡ï¼ˆç•«é¢ä»ä»¥æŠ½ä¸­çš„äººç‚ºç›®æ¨™åœä¸‹ï¼‰
      const idx = nameList.indexOf(selectedName);

      setStatus("ğŸ¯ ç¬¬ 2 è¼ªï¼šç¥ç¦ç¶“å¥è¼ªç›¤æŠ½ç±¤ä¸­â€¦");

      startBtn.disabled = true;
      lockBtn.disabled = true;
      resetBtn.disabled = true;

      // å…ˆæ—‹è½‰ï¼ŒçµæŸå¾Œæ‰é¡¯ç¤ºç¶“å¥æ›¸å·ç« ç¯€ï¼ˆé¿å…ã€Œä½œå¼Šæ„Ÿã€ï¼‰
      await spinToIndex(idx, true);

      // ä¸­é–“é¡¯ç¤ºæ›¸å·/ç« ç¯€ï¼ˆå…©è¡Œï¼‰
      const ref = verseRef(selectedVerse);
      let book = "";
      let chap = "";
      if(ref){
        const m = ref.match(/^(.+?)\s+(.+)$/);
        if(m){ book=m[1]; chap=m[2]; }
        else { book=ref; chap=""; }
      }
      if(book || chap){
        ovBook.textContent = book;
        ovChap.textContent = chap;
        centerOverlay.style.display = "flex";
      }

      setStatus(`ğŸ¯ ç¬¬ 2 è¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ${selectedVerse}ã€`);

      // è¨˜éŒ„ logï¼ˆçµ±ä¸€ä¸€è¡Œï¼‰
      appendLog({
        time: nowStamp(),
        mode: "å§“åæ¨¡å¼",
        name: selectedName,
        verse: selectedVerse,
        ref: ref
      });

      // é€™ä½å®Œæˆ
      if(!usedNames.includes(selectedName)) usedNames.push(selectedName);

      // ç¬¬äºŒè¼ªçµæŸï¼šè§£é™¤ phaseLockï¼Œå…è¨±ã€Œçœ‹ç´…åŒ…ã€
      phaseLock = false;

      viewerBtn.style.display = "inline-block";

      // è‹¥å…¨éƒ¨å®Œæˆï¼šä¸è¦ alertï¼›é¡¯ç¤ºä¸‰è¡Œæç¤º + PDF é–ƒçˆ
      if(isRoundFinished()){
        updateFinishedHintIfNeeded(false);
      }else{
        // ä¸‹ä¸€ä½å¯ç¹¼çºŒæŠ½
        startBtn.disabled = true; // ä»éœ€ç”± viewer ä¸‹ä¸€ä½å›ä¾†è§£é–
      }

      saveState();

      lockBtn.disabled = false;
      resetBtn.disabled = false;
    });

    // ---- çœ‹ç´…åŒ… ----
    viewerBtn.addEventListener("click", ()=>{
      if(!selectedName || !selectedVerse) return;

      const ref = verseRef(selectedVerse);
      const qs = new URLSearchParams({
        name:selectedName,
        verse:selectedVerse,
        ref: ref
      });
      window.location = `viewer.html?${qs.toString()}`;
    });

    // ---- å…¨éƒ¨æ­¸é›¶ ----
    resetBtn.addEventListener("click", ()=>{
      localStorage.removeItem(K.nameList);
      localStorage.removeItem(K.usedNames);
      localStorage.removeItem(K.usedVerses);
      localStorage.removeItem(K.logs);
      localStorage.removeItem(K.selectedName);
      localStorage.removeItem(K.selectedVerse);
      localStorage.removeItem(K.phaseLock);
      localStorage.removeItem("bc_pdfDownloaded");
      location.reload();
    });

    // ---- PDF åŒ¯å‡ºï¼šCanvasâ†’åœ–ç‰‡ï¼ˆé¿å…ä¸­æ–‡å­—äº‚ç¢¼ï¼‰----
    async function exportPDF(){
      const logs = getLogs();
      if(!logs.length){
        alert("å°šç„¡ç´€éŒ„");
        return;
      }

      try{
        // å»ºç«‹ä¸€å€‹é›¢å± canvasï¼Œé€è¡Œç•«æ–‡å­—ï¼Œå†è½‰æˆåœ–ç‰‡å¡é€² PDF
        const off = document.createElement("canvas");
        const w = 794;   // 96dpi è¿‘ä¼¼ A4 å¯¬
        const h = 1123;  // 96dpi è¿‘ä¼¼ A4 é«˜
        off.width = w;
        off.height = h;
        const octx = off.getContext("2d");

        // å…ˆè¼‰å…¥å­—é«”ï¼ˆä½¿ç”¨å…§å»ºç³»çµ±å­—é«”å³å¯ï¼›ä½ ç›®å‰é¡¯ç¤ºæ­£å¸¸ï¼‰
        const fontFamily = "Noto Sans TC, Microsoft JhengHei, PingFang TC, sans-serif";

        // ç‰ˆé¢
        const margin = 44;
        const lineH = 28;
        const titleH = 52;

        const pages = [];
        let idx = 0;

        while(idx < logs.length){
          octx.clearRect(0,0,w,h);
          octx.fillStyle = "#ffffff";
          octx.fillRect(0,0,w,h);

          // æ¨™é¡Œ
          octx.fillStyle = "#5b3a00";
          octx.font = `bold 22px ${fontFamily}`;
          octx.fillText("BlessingCards128 æŠ½ç±¤ç´€éŒ„", margin, margin);

          // å…§å®¹
          octx.font = `18px ${fontFamily}`;
          let y = margin + titleH;

          while(idx < logs.length){
            const L = logs[idx];
            const ref = L.ref || L.ref === "" ? L.ref : (VERSE_REF_MAP[L.verse] || "");
            const line = `[${L.time}] ${L.name}ï½œ${L.mode}ï½œæŠ½ä¸­ç¶“å¥ï¼š${L.verse}${ref?`ï¼ˆ${ref}ï¼‰`:""}`;

            // è‡ªå‹•æ›è¡Œï¼ˆç°¡æ˜“ï¼‰
            const maxW = w - margin*2;
            const words = line.split("");
            let cur = "";
            for(const ch of words){
              const t = cur + ch;
              if(octx.measureText(t).width > maxW){
                octx.fillText(cur, margin, y);
                y += lineH;
                cur = ch;
              }else{
                cur = t;
              }
            }
            if(cur){
              octx.fillText(cur, margin, y);
              y += lineH;
            }

            idx++;

            if(y > h - margin - lineH){
              break;
            }
          }

          pages.push(off.toDataURL("image/jpeg", 0.92));
        }

        // ä½¿ç”¨ jsPDFï¼ˆCDNï¼‰
        if(!window.jspdf){
          await new Promise((res,rej)=>{
            const s = document.createElement("script");
            s.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
            s.onload = res;
            s.onerror = rej;
            document.head.appendChild(s);
          });
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit:"pt", format:"a4" });

        pages.forEach((img, i)=>{
          if(i>0) doc.addPage();
          // A4 pt: 595x842
          doc.addImage(img, "JPEG", 0, 0, 595, 842);
        });

        doc.save("BlessingCards128_æŠ½ç±¤ç´€éŒ„.pdf");

        // ä¸‹è¼‰å¾Œåœæ­¢é–ƒçˆ
        setPdfBlink(false);

      }catch(err){
        console.error(err);
        alert("PDF ç”¢ç”Ÿå¤±æ•—ï¼šè«‹æŸ¥çœ‹ Console éŒ¯èª¤è¨Šæ¯ã€‚");
      }
    }

    pdfBtn.addEventListener("click", exportPDF);

    // ---- å›åˆ°æœ¬é ï¼šç”± viewer.htmlã€Œä¸‹ä¸€ä½ã€å›ä¾†æ™‚ï¼Œè§£é™¤é–‹å§‹éµé–å®šï¼ˆä½†ä¸é‡ç•«è¼ªç›¤å…§å®¹ï¼‰----
    (function handleReturnFromViewer(){
      const sp = new URLSearchParams(location.search);
      if(sp.get("from") === "viewer"){
        // åªè§£é™¤ UI é–ï¼Œä¸æ¸…åå–®ã€ä¸é‡ç•«
        if(locked && !phaseLock && !isRoundFinished()){
          startBtn.disabled = false;
          secondBtn.style.display = "none";
          viewerBtn.style.display = "none";
          centerOverlay.style.display = "none";
          setStatus("è«‹æŒ‰ã€Œé–‹å§‹æŠ½å§“å + ç¶“å¥ã€æŠ½ä¸‹ä¸€ä½");
        }else{
          updateFinishedHintIfNeeded(false);
        }
        // æ¸…æ‰ query
        history.replaceState({}, "", location.pathname);
      }
    })();

    // ---- åˆå§‹åŒ– ----
    (function init(){
      loadState();
      // åˆå§‹æ¸²æŸ“
      if(locked){
        renderWithRotation(nameList, currentRotation);
      }else{
        drawWheel([]);
      }
    })();
  </script>
</body>
</html>
