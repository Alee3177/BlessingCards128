<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>BlessingCards128｜祝福經句紅包（v4.8.1）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    background: #fff8e7;
    font-family: "Noto Sans TC", sans-serif;
    text-align: center;
    padding: 22px;
    color: #5b3a00;
}

h1 {
    color: #b07500;
    font-size: 26px;
    margin-bottom: 10px;
}

/* LOGO */
.logo {
    width: 120px;
    margin-bottom: 14px;
}

/* 輸入框 */
#nameInput {
    width: 280px;
    padding: 10px;
    font-size: 18px;
    border-radius: 8px;
    border: 1px solid #bf8a3e;
    margin-bottom: 12px;
}

/* 共用按鈕 */
.btn {
    background: #f7c76c;
    border: none;
    padding: 12px 22px;
    border-radius: 25px;
    font-size: 18px;
    color: #5b3a00;
    cursor: pointer;
    margin: 6px;
}
.btn:hover {
    background: #f3b84f;
}
.btn:disabled {
    opacity: 0.45;
    cursor: not-allowed;
}

/* 第二輪按鈕閃爍 */
@keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.25; }
    100% { opacity: 1; }
}
.blinking {
    animation: blink 1s infinite;
}

/* 轉盤容器 */
#wheelContainer {
    position: relative;
    width: 380px;
    height: 380px;
    margin: 22px auto;
}

/* Canvas */
#wheelCanvas {
    width: 380px;
    height: 380px;
}

/* 指針 ▼（固定在上方，尖端朝下貼齊輪盤外緣） */
#wheelPointer {
    position: absolute;
    top: -26px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 44px;
    color: red;
    z-index: 20;
}

/* 狀態訊息 */
#statusText {
    font-size: 20px;
    margin-top: 8px;
    color: #a56b00;
}
#statusText.error {
    color: #c0392b;
    font-weight: bold;
}
</style>
</head>

<body>

<h1>祝福經句紅包（BlessingCards128）</h1>
<img src="logo3524.png" class="logo" alt="BlessingCards128 Logo">

<!-- 姓名輸入 -->
<input id="nameInput" placeholder="請輸入姓名（用「、」或空白分隔）"><br>

<button class="btn" onclick="lockList()">鎖定名單</button>
<button id="startBtn" class="btn" onclick="startFirstRound()">開始抽姓名 + 經句</button>
<button class="btn" onclick="resetAll()">全部歸零</button>
<button class="btn" onclick="exportPDF()">抽籤紀錄 PDF</button>

<!-- 第二輪按鈕 -->
<button id="secondBtn" class="btn" style="display:none;" onclick="startSecondRound()">抽紅包（第二輪）</button>

<!-- 第三步：看紅包 -->
<button id="viewerBtn" class="btn" style="display:none;" onclick="gotoViewer()">看紅包內容</button>

<!-- 轉盤 -->
<div id="wheelContainer">
    <div id="wheelPointer">▼</div>
    <canvas id="wheelCanvas" width="380" height="380"></canvas>
</div>

<div id="statusText">請輸入姓名並鎖定名單</div>

<script src="verseRefMap.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ------------------------------------
   Global variables
-------------------------------------*/

let nameList = [];
let locked = false;

let selectedName = null;   // 第一輪選到的姓名
let selectedVerse = null;  // 第二輪抽到的經文編號

let usedNames = [];        // 已經抽過的人
let usedVersesAll = [];    // 已抽過的經句（跨姓名 / 分類模式共用）

let roundFinished = false; // 是否全部抽完

const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");

const CENTER = 190;
const RADIUS = 180;

const startBtn = document.getElementById("startBtn");
const secondBtn = document.getElementById("secondBtn");
const viewerBtn = document.getElementById("viewerBtn");
const statusText = document.getElementById("statusText");

/* ------------------------------------
   Drum 音效
-------------------------------------*/
function playDrum(){
    const a = new Audio("audio/drum.mp3");
    a.play().catch(()=>{});
}

/* ------------------------------------
   初始化（載入 localStorage）
-------------------------------------*/
(function init(){
    try{
        const savedList = localStorage.getItem("nameList");
        if(savedList){
            const arr = JSON.parse(savedList);
            if(Array.isArray(arr) && arr.length >= 2){
                nameList = arr;
                locked = true;
                document.getElementById("nameInput").value = nameList.join("、");
                statusText.innerText = `名單已載入，共 ${nameList.length} 位`;
                drawWheel(nameList);
            }
        }

        const usedNamesStr = localStorage.getItem("usedNames");
        if(usedNamesStr){
            const arr2 = JSON.parse(usedNamesStr);
            if(Array.isArray(arr2)){
                usedNames = arr2;
            }
        }

        const usedVersesStr = localStorage.getItem("usedVersesAll");
        if(usedVersesStr){
            const arr3 = JSON.parse(usedVersesStr);
            if(Array.isArray(arr3)){
                usedVersesAll = arr3;
            }
        }

        roundFinished = (localStorage.getItem("roundFinished") === "1");

        if(roundFinished && nameList.length > 0){
            statusText.classList.add("error");
            statusText.innerText = "⚠ 本輪已完成全部抽籤，請按「全部歸零」開始新一輪。";
            startBtn.disabled = true;
        }
    }catch(e){
        console.warn("Init error:", e);
    }
})();

/* ------------------------------------
   鎖定名單
-------------------------------------*/
function lockList(){
    const raw = document.getElementById("nameInput").value.trim();
    if(raw === ""){
        alert("請輸入姓名！");
        return;
    }

    const arr = raw.split(/[,、\s]+/).filter(x => x.trim() !== "");
    if(arr.length < 2){
        alert("至少需要 2 位姓名！");
        return;
    }

    nameList = arr;
    locked = true;

    usedNames = [];
    usedVersesAll = [];
    roundFinished = false;

    localStorage.setItem("nameList", JSON.stringify(nameList));
    localStorage.setItem("usedNames", JSON.stringify(usedNames));
    localStorage.setItem("usedVersesAll", JSON.stringify(usedVersesAll));
    localStorage.setItem("roundFinished", "0");

    statusText.classList.remove("error");
    statusText.innerText = `名單已鎖定，共 ${nameList.length} 位`;
    startBtn.disabled = false;

    drawWheel(nameList);
}

/* ------------------------------------
   畫輪盤（從 -90° 起始 → 指針基準一致）
-------------------------------------*/
function drawWheel(items){
    ctx.clearRect(0,0,380,380);
    if(!items || items.length === 0) return;

    const count = items.length;
    const arc = Math.PI * 2 / count;

    for(let i=0;i<count;i++){
        const start = arc * i - Math.PI/2; // 從正上方開始切
        const end   = start + arc;

        // 背景色
        ctx.beginPath();
        ctx.fillStyle = (i % 2 === 0) ? "#fde7b5" : "#fcdca0";
        ctx.moveTo(CENTER, CENTER);
        ctx.arc(CENTER, CENTER, RADIUS, start, end);
        ctx.closePath();
        ctx.fill();

        // 分隔線
        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 2;
        ctx.stroke();

        // 姓名文字
        ctx.save();
        ctx.translate(CENTER, CENTER);
        const mid = start + arc/2;
        ctx.rotate(mid);
        ctx.textAlign = "right";
        ctx.font = "22px Noto Sans TC";
        ctx.fillStyle = "#5b3a00";
        ctx.fillText(items[i], RADIUS - 22, 10);
        ctx.restore();
    }
}

/* ------------------------------------
   動畫曲線（easeOut）
-------------------------------------*/
function easeOut(t){
    return 1 - Math.pow(1-t, 3);
}

/* ------------------------------------
   核心：精準命中角度計算（v4.8.1）
   - 第一輪／第二輪都用這一套
   - 指針視覺方向：向下（▼）= +90°
-------------------------------------*/
function spinWheel(items, clockwise, forcedIndex){
    return new Promise(resolve => {
        if(!items || items.length === 0){
            resolve(null);
            return;
        }

        playDrum();

        const count = items.length;
        const arc = Math.PI * 2 / count;

        // 強制定義第幾格（例如第二輪固定停在 selectedName）
        const selIndex =
            (typeof forcedIndex === "number" && forcedIndex >= 0 && forcedIndex < count)
            ? forcedIndex
            : Math.floor(Math.random() * count);

        const direction = clockwise ? 1 : -1;
        const spins = 5 + Math.random() * 2; // 5~7 圈

        // drawWheel 以「上方 -90°」為第 0 格起點
        const sliceCenter = arc * (selIndex + 0.5) - Math.PI/2;

        // 指針實際方向：向下（▼），在 canvas 座標是 +90°
        const pointerAngle = Math.PI/2;

        // 要求：sliceCenter + finalAngle ≡ pointerAngle (mod 2π)
        const finalAngle = (pointerAngle - sliceCenter) + direction * spins * 2 * Math.PI;

        const start = performance.now();
        const duration = 5000; // 5 秒

        function animate(now){
            let t = (now - start) / duration;
            if(t > 1) t = 1;

            const eased = easeOut(t);
            const angle = finalAngle * eased;

            ctx.save();
            ctx.clearRect(0,0,380,380);
            ctx.translate(CENTER, CENTER);
            ctx.rotate(angle);
            ctx.translate(-CENTER, -CENTER);
            drawWheel(items);
            ctx.restore();

            if(t < 1){
                requestAnimationFrame(animate);
            } else {
                resolve(items[selIndex]);
            }
        }

        requestAnimationFrame(animate);
    });
}

/* ------------------------------------
   第一輪：抽姓名（逆時針）
-------------------------------------*/
async function startFirstRound(){

    if(roundFinished){
        alert("此輪已完成全部抽籤！請按「全部歸零」開始新一輪。");
        return;
    }

    if(!locked){
        alert("請先鎖定名單！");
        return;
    }

    if(!nameList || nameList.length < 2){
        alert("名單不足，請重新鎖定。");
        return;
    }

    const remaining = nameList.filter(n => !usedNames.includes(n));
    if(remaining.length === 0){
        alert("全部姓名皆已完成紅包抽籤，請按「全部歸零」開始新一輪。");
        roundFinished = true;
        localStorage.setItem("roundFinished", "1");
        statusText.classList.add("error");
        statusText.innerText = "⚠ 本輪已完成全部抽籤，請按「全部歸零」。";
        startBtn.disabled = true;
        return;
    }

    const winner = remaining[Math.floor(Math.random() * remaining.length)];
    const forcedIndex = nameList.indexOf(winner);

    statusText.classList.remove("error");
    statusText.innerText = "第 1 輪：姓名輪盤抽籤中…";
    selectedName = null;
    selectedVerse = null;

    drawWheel(nameList);

    await spinWheel(nameList, false, forcedIndex);

    selectedName = winner;
    statusText.innerText = `第 1 輪完成：抽中「${winner}」`;

    setTimeout(()=>{
        secondBtn.style.display = "inline-block";
        secondBtn.classList.add("blinking");
    }, 1000);
}

/* ------------------------------------
   第二輪：抽經句（順時針）
   ※ 指針仍固定停在「第一輪抽到的人」
-------------------------------------*/
async function startSecondRound(){

    secondBtn.classList.remove("blinking");
    secondBtn.style.display = "none";

    if(!selectedName){
        alert("請先完成第一輪姓名抽籤！");
        return;
    }

    const verseNums = Object.keys(VERSE_REF_MAP || {});
    let available = verseNums.filter(v => !usedVersesAll.includes(v));

    if(available.length === 0){
        alert("128 個經句都已抽完！");
        return;
    }

    statusText.classList.remove("error");
    statusText.innerText = "第 2 輪：祝福經句輪盤抽籤中…";

    const winnerIndex = nameList.indexOf(selectedName);
    if(winnerIndex < 0){
        alert("找不到對應的姓名，請重新鎖定名單。");
        return;
    }

    // 視覺上：仍用姓名輪盤，只是改為順時針，最後停在同一位
    await spinWheel(nameList, true, winnerIndex);

    // 內部真正抽經句（不可重複）
    selectedVerse = available[Math.floor(Math.random() * available.length)];
    usedVersesAll.push(selectedVerse);
    localStorage.setItem("usedVersesAll", JSON.stringify(usedVersesAll));

    statusText.innerText = `第 2 輪完成：抽中經句「${selectedVerse}」`;

    saveRecord(selectedName, selectedVerse);

    setTimeout(()=>{
        viewerBtn.style.display = "inline-block";
    }, 800);
}

/* ------------------------------------
   前往 viewer.html 看紅包內容
-------------------------------------*/
function gotoViewer(){
    if(!selectedName || !selectedVerse){
        alert("請先完成姓名與經句抽籤！");
        return;
    }
    window.location =
        `viewer.html?name=${encodeURIComponent(selectedName)}&verse=${selectedVerse}`;
}

/* ------------------------------------
   儲存抽籤紀錄（姓名模式）
-------------------------------------*/
function saveRecord(name, verse){
    const now = new Date();
    const ts =
        `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,"0")}/`+
        `${String(now.getDate()).padStart(2,"0")} `+
        `${String(now.getHours()).padStart(2,"0")}:`+
        `${String(now.getMinutes()).padStart(2,"0")}:`+
        `${String(now.getSeconds()).padStart(2,"0")}`;

    let logs = [];
    try{
        logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
        if(!Array.isArray(logs)) logs = [];
    }catch(e){
        logs = [];
    }

    logs.push({
        time: ts,
        name: name,
        verseNo: verse,
        mode: "姓名模式"
    });
    localStorage.setItem("drawLogs", JSON.stringify(logs));

    if(!usedNames.includes(name)){
        usedNames.push(name);
        localStorage.setItem("usedNames", JSON.stringify(usedNames));
    }

    if(nameList.length > 0 && usedNames.length >= nameList.length){
        roundFinished = true;
        localStorage.setItem("roundFinished", "1");
        // 不立刻 alert，只在下一次嘗試再抽時提醒
        statusText.classList.add("error");
        statusText.innerText = "⚠ 本輪已完成全部抽籤，請按「全部歸零」。";
        startBtn.disabled = true;
    }
}

/* ------------------------------------
   全部歸零
-------------------------------------*/
function resetAll(){
    localStorage.removeItem("nameList");
    localStorage.removeItem("usedNames");
    localStorage.removeItem("usedVersesAll");
    localStorage.removeItem("drawLogs");
    localStorage.removeItem("roundFinished");
    alert("所有資料已清空！將重新載入。");
    location.reload();
}

/* ------------------------------------
   PDF 匯出（思源黑體 + 一行式紀錄）
-------------------------------------*/
async function exportPDF(){

    let logs;
    try{
        logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
        if(!Array.isArray(logs)) logs = [];
    }catch(e){
        logs = [];
    }

    if(logs.length === 0){
        alert("目前沒有抽籤紀錄，無法產生 PDF！");
        statusText.classList.add("error");
        statusText.innerText = "目前沒有抽籤紀錄，請先完成至少一次抽籤後再產生 PDF。";
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    let fontData;
    try{
        const res = await fetch("fonts/SourceHanSansTC-Regular.ttf");
        if(!res.ok) throw new Error("HTTP " + res.status);
        const buf = await res.arrayBuffer();
        const bytes = new Uint8Array(buf);
        let binary = "";
        for(let i=0;i<bytes.length;i++){
            binary += String.fromCharCode(bytes[i]);
        }
        fontData = btoa(binary);
    }catch(e){
        console.error("載入字型失敗：", e);
        alert("PDF 字型載入失敗，請確認 fonts/SourceHanSansTC-Regular.ttf 是否存在。");
        statusText.classList.add("error");
        statusText.innerText = "PDF 字型載入失敗，請確認 fonts/SourceHanSansTC-Regular.ttf 檔案是否放在 fonts/ 資料夾中。";
        return;
    }

    try{
        doc.addFileToVFS("SourceHanSansTC-Regular.ttf", fontData);
        doc.addFont("SourceHanSansTC-Regular.ttf","SourceHan","normal");
        doc.setFont("SourceHan","normal");
    }catch(e){
        console.error("註冊字型失敗：", e);
        alert("PDF 字型註冊失敗，請稍後再試。");
        statusText.classList.add("error");
        statusText.innerText = "PDF 字型註冊失敗，請檢查 jsPDF 版本或字型檔。";
        return;
    }

    doc.setFontSize(16);
    doc.text(`BlessingCards128 抽籤紀錄（共 ${logs.length} 筆）`, 40, 40);

    let y = 70;
    doc.setFontSize(14);

    logs.forEach(log => {
        const ref = (window.VERSE_REF_MAP && window.VERSE_REF_MAP[log.verseNo]) || "";
        const mode = log.mode || "姓名模式";
        const line =
            `[${log.time}] ${log.name}｜${mode}｜抽中經句：${log.verseNo}` +
            (ref ? `（${ref}）` : "");

        if(y > 780){
            doc.addPage();
            y = 60;
        }
        doc.text(line, 40, y);
        y += 22;
    });

    doc.save("BlessingCards128_抽籤紀錄.pdf");
}
</script>

</body>
</html>
