<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BlessingCards128 â€“ MVP Step3 + B4</title>

<style>
  body{
    font-family: system-ui,-apple-system,"Noto Sans TC",sans-serif;
    background:#fbf2df;
    margin:0;
    padding:16px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }
  h2{margin:4px 0;color:#5b3a00}

  #panel{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
  input{padding:8px;border-radius:8px;border:1px solid #caa26a}
  button{
    padding:8px 14px;
    border-radius:10px;
    border:1px solid #b58b5a;
    background:#fff;
    cursor:pointer;
  }
  button:disabled{opacity:.5;cursor:not-allowed}

  #wrap{position:relative;width:360px}
  canvas{display:block;margin:auto}

  /* æŒ‡é‡ï¼ˆå›ºå®šå‘ä¸‹ï¼‰ */
  #pointer{
    position:absolute;
    left:50%;
    top:54px;
    transform:translateX(-50%);
    width:0;height:0;
    border-left:14px solid transparent;
    border-right:14px solid transparent;
    border-top:22px solid #c40000;
    filter:drop-shadow(0 1px 0 rgba(0,0,0,.2));
    z-index:5;
  }

  #status{
    min-height:1.4em;
    color:#5b3a00;
    font-weight:600;
  }
</style>
</head>

<body>

<h2>BlessingCards128</h2>

<div id="panel">
  <input id="names" placeholder="è¼¸å…¥å§“åï¼ˆä»¥é€—è™Ÿåˆ†éš”ï¼‰" value="1,2,3">
  <button id="lockBtn">é–å®šåå–®</button>
  <button id="spinBtn" disabled>é–‹å§‹æŠ½å§“å</button>
  <button id="round2Btn" disabled>æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
</div>

<div id="wrap">
  <div id="pointer"></div>
  <canvas id="cv" width="360" height="360"></canvas>
</div>

<div id="status"></div>

<audio id="drum" src="drum.mp3" preload="auto"></audio>

<script>
/* ======================
   åŸºæœ¬è¨­å®šï¼ˆStep1â€“3 é–æ­»ï¼‰
====================== */
const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
const W = cv.width, H = cv.height;
const CENTER = W/2;
const RADIUS = 150;

const pointerAngle = -Math.PI/2; // 12é»æ–¹å‘
const SPEED_BOOST = 1.35;
const baseSpins = 4.8;
const spins = baseSpins * SPEED_BOOST;

let items = [];
let locked = false;
let isSpinning = false;
let currentRotation = 0;

let round = 1;
let firstIndex = null;
let secondIndex = null;

const drum = document.getElementById("drum");

function norm(a){
  a %= Math.PI*2;
  if(a<0) a+=Math.PI*2;
  return a;
}
function easeOutQuint(t){return 1-Math.pow(1-t,5);}

/* ======================
   ç¹ªè£½è½‰ç›¤ï¼ˆå§“å or ç©ºï¼‰
====================== */
function drawWheel(rotation, drawText=true){
  ctx.clearRect(0,0,W,H);
  if(items.length===0) return;

  const arc = Math.PI*2/items.length;

  ctx.save();
  ctx.translate(CENTER,CENTER);
  ctx.rotate(rotation);
  ctx.translate(-CENTER,-CENTER);

  for(let i=0;i<items.length;i++){
    const start = i*arc - Math.PI/2 - arc/2;
    const end = start + arc;

    ctx.beginPath();
    ctx.moveTo(CENTER,CENTER);
    ctx.arc(CENTER,CENTER,RADIUS,start,end);
    ctx.closePath();
    ctx.fillStyle = (i%2===0) ? "#fde7b5" : "#fcdca0";
    ctx.fill();

    ctx.strokeStyle="#fff";
    ctx.lineWidth=2;
    ctx.stroke();

    if(drawText){
      ctx.save();
      ctx.translate(CENTER,CENTER);
      ctx.rotate(start+arc/2);
      ctx.textAlign="right";
      ctx.font="20px 'Noto Sans TC'";
      ctx.fillStyle="#5b3a00";
      ctx.fillText(items[i],RADIUS-18,8);
      ctx.restore();
    }
  }
  ctx.restore();
}

/* ======================
   æ ¸å¿ƒæ—‹è½‰ï¼ˆè£æ±ºå”¯ä¸€ä¾†æºï¼‰
====================== */
async function spinToIndex(targetIndex, drawText){
  if(isSpinning) return;
  isSpinning=true;

  const arc = Math.PI*2/items.length;
  const targetCenter = targetIndex*arc - Math.PI/2;
  const desiredMod = norm(pointerAngle - targetCenter);

  const startRot = currentRotation;
  const startMod = norm(startRot);

  let baseDelta = desiredMod - startMod;
  if(baseDelta>Math.PI) baseDelta-=Math.PI*2;
  if(baseDelta<-Math.PI) baseDelta+=Math.PI*2;

  const delta = baseDelta - spins*2*Math.PI;
  const duration = 5200;

  drum.currentTime=0;
  await drum.play();

  const t0 = performance.now();
  function frame(now){
    let t=(now-t0)/duration;
    if(t>1) t=1;
    const rot = startRot + delta*easeOutQuint(t);
    drawWheel(rot,drawText);

    if(t<1){
      requestAnimationFrame(frame);
    }else{
      currentRotation = startRot + delta;
      drawWheel(currentRotation,drawText);
      isSpinning=false;
    }
  }
  requestAnimationFrame(frame);
}

/* ======================
   UI è¡Œç‚º
====================== */
const status = document.getElementById("status");
const namesInput = document.getElementById("names");
const lockBtn = document.getElementById("lockBtn");
const spinBtn = document.getElementById("spinBtn");
const round2Btn = document.getElementById("round2Btn");

lockBtn.onclick=()=>{
  items = namesInput.value.split(",").map(s=>s.trim()).filter(Boolean);
  if(items.length<2){alert("è‡³å°‘éœ€è¦å…©ä½");return;}
  locked=true;
  round=1;
  firstIndex=null;
  secondIndex=null;
  currentRotation=0;
  drawWheel(0,true);
  spinBtn.disabled=false;
  round2Btn.disabled=true;
  status.textContent="åå–®å·²é–å®šï¼Œè«‹é–‹å§‹æŠ½å§“å";
};

spinBtn.onclick=async()=>{
  if(round!==1) return;
  const idx = Math.floor(Math.random()*items.length);
  firstIndex = idx;
  status.textContent="ğŸ¡ ç¬¬ 1 è¼ªï¼šå§“åæŠ½ç±¤ä¸­â€¦";
  await spinToIndex(idx,true);
  status.textContent=`ğŸ¯ ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${items[idx]}ã€`;
  round=2;
  spinBtn.disabled=true;
  round2Btn.disabled=false;
};

round2Btn.onclick=async()=>{
  if(round!==2) return;
  const idx = Math.floor(Math.random()*items.length);
  secondIndex = idx;
  status.textContent="ğŸ ç¬¬ 2 è¼ªï¼šç¥ç¦ç¶“å¥æŠ½ç±¤ä¸­â€¦";
  await spinToIndex(idx,false);
  status.textContent="ğŸ¯ ç¬¬ 2 è¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥";
  round2Btn.disabled=true;
};

/* åˆå§‹ */
drawWheel(0,true);
</script>
</body>
</html>