<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BlessingCards128 - 抽籤首頁</title>

<link rel="stylesheet" href="fonts/fonts.css">

<style>
    body {
        margin:0;
        background:#fff7e6;
        font-family:"NotoSansTC", sans-serif;
        text-align:center;
        color:#8a5500;
    }

    .container {
        max-width:900px;
        margin:auto;
        padding:20px;
    }

    .logo {
        width:120px;
        margin-top:20px;
    }

    h1 {
        font-size:28px;
        color:#b37500;
        margin-top:10px;
    }

    textarea {
        width:90%;
        height:120px;
        padding:10px;
        font-size:18px;
        border-radius:10px;
        border:1px solid #d0a85c;
        resize:none;
        outline:none;
        font-family:"NotoSansTC";
        background:#fff;
    }

    .btn {
        background:#ffcc66;
        border:none;
        padding:12px 22px;
        border-radius:10px;
        font-size:20px;
        cursor:pointer;
        margin-top:12px;
    }
    .btn:hover { background:#ffdd88; }

    #pointer {
        width:0; height:0;
        border-left:18px solid transparent;
        border-right:18px solid transparent;
        border-bottom:32px solid red;
        margin:auto;
        margin-top:15px;
        position:relative;
        z-index:5;
    }

    #nameWheel {
        margin-top:10px;
        max-width:300px;
    }

    #resultArea {
        font-size:26px;
        margin-top:12px;
        min-height:2.5em;
        color:#b37500;
    }

    #verseCount {
        margin-top:10px;
        font-size:16px;
        color:#9a6a00;
    }

    .coin {
        position:fixed;
        top:-50px;
        width:35px;
        pointer-events:none;
        animation:fallCoin linear forwards;
    }

    @keyframes fallCoin {
        from { transform:translateY(-50px); opacity:1; }
        to   { transform:translateY(100vh); opacity:0; }
    }
</style>
</head>

<body>
<div class="container">

    <img src="logo3524.png" class="logo" />
    <h1>飛鷹區 3524 主17小組<br>歡迎來到紅包祝福經句抽籤</h1>

    <textarea id="nameInput" placeholder="請輸入全部組員姓名，用逗號分隔"></textarea>

    <div>
        <button class="btn" onclick="startNameSpin()">開始抽姓名</button>
        <button class="btn" onclick="goCategory()">分類抽籤</button>
    </div>

    <div id="verseCount"></div>

    <div id="pointer"></div>
    <canvas id="nameWheel" width="300" height="300"></canvas>

    <div id="resultArea"></div>

    <button class="btn" onclick="resetAll()">全部歸零</button>

    <!-- 煙火 -->
    <canvas id="fwCanvas" style="position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;"></canvas>

</div>

<script>
let names = [];
let usedNames = [];

let usedVerses = [];
let drumAudio, winAudio;
let audioReady=false;
let isSpinning=false;

const verseTotal = 128;

(function init(){
    let savedV = localStorage.getItem("usedVersesAll");
    if(savedV) usedVerses = JSON.parse(savedV);
    updateVerseCount();

    initAudio();
    drawNameWheel();
})();

function initAudio(){
    if(audioReady) return;
    drumAudio = new Audio("audio/drum.mp3");
    winAudio  = new Audio("audio/win.mp3");
    audioReady=true;
}

function updateVerseCount(){
    document.getElementById("verseCount").textContent =
        `已抽經句：${usedVerses.length} / ${verseTotal}`;
}

function goCategory(){
    window.location = "index_category.html";
}

/* 產生姓名輪盤 */
const canvas = document.getElementById("nameWheel");
const ctx = canvas.getContext("2d");

function drawNameWheel(){
    ctx.clearRect(0,0,300,300);

    names = document.getElementById("nameInput").value
        .split(",")
        .map(s=>s.trim())
        .filter(s=>s.length>0);

    const count = names.length || 1;
    const arc = 2*Math.PI / count;

    for(let i=0;i<count;i++){
        let angle = i*arc;
        ctx.beginPath();
        ctx.moveTo(150,150);
        ctx.fillStyle = i%2===0 ? "#ffe6a1" : "#ffcc66";
        ctx.arc(150,150,150,angle,angle+arc);
        ctx.fill();

        ctx.save();
        ctx.translate(150,150);
        ctx.rotate(angle + arc/2);
        ctx.textAlign="right";
        ctx.font="bold 18px NotoSansTC";
        ctx.fillStyle="#8a5500";
        ctx.fillText(names[i] || " ", 135, 8);
        ctx.restore();
    }
}

/* 抽姓名（不重複） */
function startNameSpin(){
    if(isSpinning) return;

    names = document.getElementById("nameInput").value
        .split(",")
        .map(s=>s.trim())
        .filter(s=>s.length>0);

    if(names.length===0){
        alert("請先輸入姓名");
        return;
    }

    let available = names.filter(n => !usedNames.includes(n));

    if(available.length === 0){
        alert("全部姓名都抽過了！請按「全部歸零」。");
        return;
    }

    drumAudio.play().catch(()=>{});

    isSpinning=true;
    const idx = Math.floor(Math.random()*available.length);
    const winner = available[idx];
    const winnerIdx = names.indexOf(winner);

    const arc = 2*Math.PI / names.length;
    let safe = arc*0.2;

    const base = winnerIdx * arc + arc/2;
    const targetAngle = base + (Math.random()*safe - safe/2);
    const totalRotation = targetAngle + Math.PI*8;

    let startTime=null;
    const duration=3000;

    function animate(ts){
        if(!startTime) startTime=ts;
        const progress = ts - startTime;
        const ease = Math.pow(progress/duration,3);
        const current = ease * totalRotation;

        ctx.save();
        ctx.translate(150,150);
        ctx.rotate(current);
        ctx.translate(-150,-150);
        drawNameWheel();
        ctx.restore();

        if(progress < duration){
            requestAnimationFrame(animate);
        } else {
            finishDrawName(winner);
            isSpinning=false;
        }
    }

    requestAnimationFrame(animate);
}

function finishDrawName(winner){
    winAudio.play().catch(()=>{});
    celebrate();

    usedNames.push(winner);

    document.getElementById("resultArea").innerHTML =
        `抽中：<b>${winner}</b><br><br>
        <button class="btn" onclick="drawVerse()">抽紅包祝福經句</button>`;
}

/* 抽經句（不重複） */
function drawVerse(){
    if(usedVerses.length >= verseTotal){
        alert("128 張經句都已抽完，請歸零再開始！");
        return;
    }

    let remaining = [];
    for(let i=1;i<=verseTotal;i++){
        if(!usedVerses.includes(i)) remaining.push(i);
    }

    const v = remaining[Math.floor(Math.random()*remaining.length)];
    usedVerses.push(v);
    localStorage.setItem("usedVersesAll", JSON.stringify(usedVerses));
    updateVerseCount();

    const padded = v.toString().padStart(3,"0");

    winAudio.play().catch(()=>{});
    celebrate();

    setTimeout(()=>{
        window.location = `viewer.html?no=${padded}`;
    }, 700);
}

function resetAll(){
    if(!confirm("確定全部重置嗎？")) return;
    usedNames=[];
    usedVerses=[];
    localStorage.removeItem("usedVersesAll");
    updateVerseCount();
    document.getElementById("resultArea").textContent="";
}

/* 煙火 + 金幣 */
let fwCanvas=document.getElementById("fwCanvas");
let fwCtx=fwCanvas.getContext("2d");

function resizeFW(){
    fwCanvas.width=window.innerWidth;
    fwCanvas.height=window.innerHeight;
}
resizeFW();
window.addEventListener("resize", resizeFW);

let fireArr=[];
function launchFire(){
    fireArr.push({
        x:Math.random()*fwCanvas.width,
        y:Math.random()*fwCanvas.height*0.5,
        r:2,
        c:`hsl(${Math.random()*360},100%,60%)`,
        life:30+Math.random()*20
    });
}
function drawFire(){
    fwCtx.clearRect(0,0,fwCanvas.width,fwCanvas.height);
    for(let i=fireArr.length-1;i>=0;i--){
        let f=fireArr[i];
        fwCtx.beginPath();
        fwCtx.arc(f.x,f.y,f.r,0,Math.PI*2);
        fwCtx.fillStyle=f.c;
        fwCtx.fill();
        f.r+=2;
        f.life--;
        if(f.life<=0) fireArr.splice(i,1);
    }
    requestAnimationFrame(drawFire);
}
drawFire();
function startFireworks(){
    for(let i=0;i<12;i++) setTimeout(launchFire, i*150);
}
function startCoins(){
    for(let i=0;i<15;i++){
        setTimeout(()=>{
            let coin=document.createElement("img");
            coin.src="https://cdn-icons-png.flaticon.com/512/138/138292.png";
            coin.className="coin";
            coin.style.left=Math.random()*window.innerWidth+"px";
            coin.style.animationDuration=(1.2+Math.random())+"s";
            document.body.appendChild(coin);
            setTimeout(()=>coin.remove(),2500);
        }, i*120);
    }
}
function celebrate(){
    startFireworks();
    startCoins();
}
</script>

</body>
</html>
