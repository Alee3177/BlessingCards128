<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</title>

<style>
body{
  margin:0;
  font-family: system-ui,-apple-system,"Noto Sans TC",sans-serif;
  background:#fbf2df;
  text-align:center;
}
h1{color:#5b3a00;margin:12px 0}

#panel{max-width:420px;margin:auto;padding:12px}
input,button{
  font-size:16px;
  padding:10px;
  margin:4px;
  border-radius:10px;
  border:1px solid #b58b5a;
}
button{background:#f5bc00;color:#5b3a00;cursor:pointer}
button:disabled{opacity:.5;cursor:not-allowed}

#wrap{position:relative;width:360px;margin:10px auto}
canvas{display:block;margin:auto}
#pointer{
  position:absolute;
  left:50%;
  top:40px;
  transform:translateX(-50%);
  width:0;height:0;
  border-left:14px solid transparent;
  border-right:14px solid transparent;
  border-top:22px solid #d60000; /* å€’ä¸‰è§’ */
}

#status{min-height:28px;color:#5b3a00;margin-top:6px}

#centerText{
  position:absolute;
  left:50%;top:50%;
  transform:translate(-50%,-50%);
  font-size:22px;
  color:#5b3a00;
  pointer-events:none;
}
</style>
</head>

<body>
<h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h1>

<div id="panel">
  <input id="namesInput" placeholder="è¼¸å…¥å§“åï¼Œç”¨ç©ºç™½æˆ–é€—è™Ÿåˆ†éš”">
  <br>
  <button id="lockBtn">é–å®šåå–®</button>
  <button id="startBtn" disabled>é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
  <button id="resetBtn">å…¨éƒ¨æ­¸é›¶</button>

  <div id="wrap">
    <div id="pointer"></div>
    <canvas id="cv" width="360" height="360"></canvas>
    <div id="centerText"></div>
  </div>

  <div id="status"></div>

  <button id="pdfBtn">æŠ½ç±¤ç´€éŒ„ PDF</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* =========================
   ç‹€æ…‹
========================= */
let nameList=[];
let usedNames=[];
let drawLogs=[];
let locked=false;
let isSpinning=false;
let currentRotation=0;

const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");
const CENTER=180,RADIUS=150;

const namesInput=document.getElementById("namesInput");
const lockBtn=document.getElementById("lockBtn");
const startBtn=document.getElementById("startBtn");
const resetBtn=document.getElementById("resetBtn");
const statusBox=document.getElementById("status");
const centerText=document.getElementById("centerText");
const pdfBtn=document.getElementById("pdfBtn");

const drum=new Audio("drum.mp3");

/* =========================
   å·¥å…·
========================= */
function norm(a){
  a%=Math.PI*2;
  if(a<0)a+=Math.PI*2;
  return a;
}
function setStatus(t){statusBox.textContent=t}
function showCenter(t){centerText.textContent=t}

/* =========================
   ç¹ªè£½è½‰ç›¤ï¼ˆå·²é©—è­‰æ­£ç¢ºï¼‰
========================= */
function drawWheel(items,rotation){
  ctx.clearRect(0,0,360,360);
  if(!items.length)return;
  const arc=2*Math.PI/items.length;

  ctx.save();
  ctx.translate(CENTER,CENTER);
  ctx.rotate(rotation);
  ctx.translate(-CENTER,-CENTER);

  for(let i=0;i<items.length;i++){
    const start=i*arc - Math.PI/2 - arc/2;
    const end=start+arc;

    ctx.beginPath();
    ctx.moveTo(CENTER,CENTER);
    ctx.arc(CENTER,CENTER,RADIUS,start,end);
    ctx.closePath();
    ctx.fillStyle=i%2?"#fcdca0":"#fde7b5";
    ctx.fill();
    ctx.strokeStyle="#fff";
    ctx.lineWidth=2;
    ctx.stroke();

    ctx.save();
    ctx.translate(CENTER,CENTER);
    ctx.rotate(start+arc/2);
    ctx.textAlign="right";
    ctx.font="22px 'Noto Sans TC'";
    ctx.fillStyle="#5b3a00";
    ctx.fillText(items[i],RADIUS-22,10);
    ctx.restore();
  }
  ctx.restore();
}

/* =========================
   æ—‹è½‰ï¼ˆä¾†è‡ª step2_fixedï¼‰
========================= */
async function spinToIndex(targetIndex){
  if(isSpinning)return;
  isSpinning=true;
  startBtn.disabled=true;

  const arc=2*Math.PI/nameList.length;
  const pointerAngle=-Math.PI/2;
  const targetCenter=targetIndex*arc - Math.PI/2 + arc/2;
  const desired=norm(pointerAngle-targetCenter);

  const SPEED_BOOST=1.35;
  const spins=4.8*SPEED_BOOST;

  const start=currentRotation;
  const base=norm(desired)-norm(start);
  const delta=base - spins*2*Math.PI;

  drum.currentTime=0;
  drum.play();

  const t0=performance.now();
  const duration=5200;

  function frame(now){
    let t=(now-t0)/duration;
    if(t>1)t=1;
    const eased=1-Math.pow(1-t,5);
    const rot=start+delta*eased;
    drawWheel(nameList,rot);

    if(t<1){
      requestAnimationFrame(frame);
    }else{
      currentRotation=start+delta;
      drawWheel(nameList,currentRotation);
      isSpinning=false;
      setTimeout(()=>showCenter(nameList[targetIndex]),200);
      drawLogs.push(nameList[targetIndex]);
      setStatus(`ğŸ¯ æŠ½ä¸­ã€Œ${nameList[targetIndex]}ã€`);
      startBtn.disabled=false;
    }
  }
  requestAnimationFrame(frame);
}

/* =========================
   äº‹ä»¶
========================= */
lockBtn.onclick=()=>{
  const raw=namesInput.value.trim();
  if(!raw)return alert("è«‹è¼¸å…¥å§“å");
  const arr=raw.split(/[\s,]+/);
  if(new Set(arr).size!==arr.length){
    alert("Oops, æœ‰å§“åè¢«é‡è¤‡è¼¸å…¥äº†å”·ï¼");
    return;
  }
  nameList=[...arr];
  usedNames=[];
  locked=true;
  startBtn.disabled=false;
  drawWheel(nameList,0);
  setStatus(`å·²é–å®š ${nameList.length} ä½`);
};

startBtn.onclick=async()=>{
  if(!locked||nameList.length<2)return;
  const remain=nameList.filter(n=>!usedNames.includes(n));
  if(!remain.length)return setStatus("æœ¬è¼ªå·²å®Œæˆ");
  const winner=remain[Math.floor(Math.random()*remain.length)];
  usedNames.push(winner);
  await spinToIndex(nameList.indexOf(winner));
};

resetBtn.onclick=()=>{
  location.reload();
};

/* =========================
   PDFï¼ˆCanvasâ†’åœ–ç‰‡ï¼Œå·²è§£äº‚ç¢¼ï¼‰
========================= */
pdfBtn.onclick=()=>{
  if(!drawLogs.length)return alert("å°šç„¡ç´€éŒ„");
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  let y=20;
  drawLogs.forEach((t,i)=>{
    const c=document.createElement("canvas");
    c.width=800;c.height=60;
    const cctx=c.getContext("2d");
    cctx.fillStyle="#fff";cctx.fillRect(0,0,c.width,c.height);
    cctx.fillStyle="#000";
    cctx.font="32px 'Noto Sans TC'";
    cctx.fillText(`${i+1}. ${t}`,20,40);
    doc.addImage(c.toDataURL(),"PNG",10,y,180,15);
    y+=18;
  });
  doc.save("æŠ½ç±¤ç´€éŒ„.pdf");
};

/* init */
drawWheel([]);
</script>
</body>
</html>