<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BlessingCards128ï½œç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰ v8.5.5</title>

  <!-- ä½ åŸæœ¬çš„æ¨£å¼ä¿ç•™ï¼ˆå«é‡‘è‰²åœ“è§’æŒ‰éˆ•ã€ç‰ˆé¢ç­‰ï¼‰ -->
  <style>
    :root{
      --gold:#f1c76b;
      --gold2:#e3b858;
      --brown:#5b3a00;
      --bg:#fbf2df;
    }
    body{
      font-family: "Noto Sans TC", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      margin:0;
      padding:18px 14px 40px;
      color:var(--brown);
      text-align:center;
    }
    h1{
      margin:10px 0 6px;
      font-size:22px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .sub{
      font-size:14px;
      opacity:.85;
      margin-bottom:10px;
      line-height:1.3;
    }
    .card{
      width:min(420px, 100%);
      margin:0 auto 12px;
      background:#fff;
      border:1px solid #efd6a8;
      border-radius:14px;
      padding:12px;
      box-sizing:border-box;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
    }
    textarea{
      width:100%;
      box-sizing:border-box;
      min-height:64px;
      padding:10px;
      border-radius:12px;
      border:1px solid #e6cfa2;
      font-size:16px;
      outline:none;
      resize:vertical;
    }
    .row{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    button{
      font-size:16px;
      padding:10px 14px;
      border-radius:14px;
      border:1px solid #caa063;
      background:linear-gradient(#ffe1a3, var(--gold));
      color:#5b3a00;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 2px 0 rgba(0,0,0,.06);
      transition:transform .05s ease;
    }
    button:active{ transform:translateY(1px); }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      filter:grayscale(.15);
    }
    .danger{
      background:linear-gradient(#ffe2e2,#ffbdbd);
      border-color:#d88;
    }
    .ghost{
      background:#fff;
    }

    #wrap{
      width:380px;
      margin:0 auto;
      position:relative;
    }
    canvas{
      display:block;
      margin:0 auto;
    }

    /* æŒ‡é‡ï¼šå€’ä¸‰è§’ï¼ˆå‘ä¸‹ï¼‰ */
    #pointer{
      position:absolute;
      left:50%;
      top:18px;
      transform:translateX(-50%);
      width:0;height:0;
      border-left:16px solid transparent;
      border-right:16px solid transparent;
      border-top:26px solid #d60000; /* å‘ä¸‹ */
      filter:drop-shadow(0 2px 0 rgba(0,0,0,.10));
      z-index:10;
      pointer-events:none;
    }

    #status{
      margin:10px auto 0;
      width:min(420px, 100%);
      font-size:15px;
      line-height:1.35;
      white-space:pre-line;
    }

    #centerText{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      width:240px;
      text-align:center;
      font-weight:900;
      color:#4a2d00;
      text-shadow:0 1px 0 rgba(255,255,255,.5);
      pointer-events:none;
      z-index:9;
      line-height:1.1;
      display:none;
    }
    #centerText .line1{ font-size:22px; }
    #centerText .line2{ font-size:20px; margin-top:6px; }

    #badge{
      position:absolute;
      top:12px;
      left:50%;
      transform:translateX(-50%);
      background:#fff;
      padding:6px 14px;
      border-radius:18px;
      font-size:18px;
      display:none;
      z-index:11;
      border:1px solid #efd6a8;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
    }

    .blinking{
      animation: blink 1s infinite;
    }
    @keyframes blink{
      0%,100%{ filter:brightness(1); }
      50%{ filter:brightness(1.2); }
    }

    .tiny{
      font-size:12px;
      opacity:.7;
      margin-top:6px;
    }
  </style>

  <!-- jsPDFï¼ˆä½ åŸæœ¬å°±æœ‰å¼•ç”¨ï¼›é€™è£¡æ²¿ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>

<body>
  <h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h1>
  <div class="sub">v8.5.5 Stable</div>

  <div class="card">
    <textarea id="names" placeholder="è¼¸å…¥å§“åï¼ˆé€—è™Ÿ/é “è™Ÿ/æ›è¡Œ/ç©ºç™½çš†å¯åˆ†éš”ï¼‰&#10;ä¾‹ï¼šå­Ÿæ·‡,ç§€è,åˆæ¦•"></textarea>
    <div class="row">
      <button id="lockBtn">é–å®šåå–®</button>
      <button id="startBtn">é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
      <button id="secondBtn">æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
      <button id="viewerBtn" class="ghost">çœ‹ç´…åŒ…å…§å®¹</button>
      <button id="pdfBtn" class="ghost">æŠ½ç±¤ç´€éŒ„ PDF</button>
      <button id="resetBtn" class="danger">å…¨éƒ¨æ­¸é›¶</button>
    </div>
    <div class="tiny">æç¤ºï¼šåªè¦æœªæŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€ï¼ŒPDF æœƒè·¨è¼ªç´¯ç©ç´€éŒ„ã€‚</div>
  </div>

  <div id="wrap">
    <div id="badge"></div>
    <div id="pointer"></div>
    <div id="centerText"><div class="line1"></div><div class="line2"></div></div>
    <canvas id="wheel" width="380" height="380"></canvas>
  </div>

  <div id="status"></div>

<script>
(() => {
  // ===== åŸºæœ¬ DOM =====
  const namesTa = document.getElementById("names");
  const lockBtn = document.getElementById("lockBtn");
  const startBtn = document.getElementById("startBtn");
  const secondBtn = document.getElementById("secondBtn");
  const viewerBtn = document.getElementById("viewerBtn");
  const pdfBtn = document.getElementById("pdfBtn");
  const resetBtn = document.getElementById("resetBtn");
  const statusEl = document.getElementById("status");
  const badgeEl = document.getElementById("badge");
  const centerEl = document.getElementById("centerText");
  const centerL1 = centerEl.querySelector(".line1");
  const centerL2 = centerEl.querySelector(".line2");

  // ===== Canvas =====
  const canvas = document.getElementById("wheel");
  const ctx = canvas.getContext("2d");

  const CENTER = 190;
  const RADIUS = 170;

  // ===== ç‹€æ…‹ =====
  let locked = false;
  let stage = "idle"; // idle | round1_done_wait_round2 | round2_done_wait_viewer | done
  let nameList = [];
  let usedNames = [];     // æœ¬è¼ªå·²æŠ½éçš„äººï¼ˆæ¯è¼ªæœƒé‡ç½®ï¼‰
  let usedVerses = [];    // å…¨å±€ä¸é‡è¤‡ï¼ˆè·¨è¼ªä¿ç•™ï¼Œç›´åˆ°å…¨éƒ¨æ­¸é›¶ï¼‰
  let drawLogs = [];      // å…¨å±€ç´¯ç©ï¼ˆè·¨è¼ªä¿ç•™ï¼Œç›´åˆ°å…¨éƒ¨æ­¸é›¶ï¼‰
  let currentRotation = 0;  // è¼ªç›¤ç›®å‰è§’åº¦ï¼ˆè·¨ç¬¬ä¸€è¼ª/ ç¬¬äºŒè¼ªå…±ç”¨ï¼‰
  let selectedName = null;
  let selectedVerse = null;

  let isSpinning = false;

  // ===== éŸ³æ•ˆ =====
  const drumAudio = new Audio("drum.mp3");
  drumAudio.preload = "auto";

  async function playDrum(){
    try{
      drumAudio.pause();
      drumAudio.currentTime = 0;
      await drumAudio.play();
    }catch(e){
      // iOS/LINE åŠ åˆ°ä¸»ç•«é¢å¯èƒ½éœ€è¦ä¸€æ¬¡é»æ“Šæ‰å…è¨±æ’­æ”¾
      console.warn("drum play blocked", e);
    }
  }

  // ===== UI Helper =====
  function setStatus(s){ statusEl.textContent = s || ""; }
  function showBadge(s){
    if(!s){ badgeEl.style.display="none"; badgeEl.textContent=""; return; }
    badgeEl.textContent = s;
    badgeEl.style.display="block";
  }
  function showCenterText(line1, line2){
    if(!line1 && !line2){
      centerEl.style.display="none";
      centerL1.textContent = "";
      centerL2.textContent = "";
      return;
    }
    centerL1.textContent = line1 || "";
    centerL2.textContent = line2 || "";
    centerEl.style.display="block";
  }

  function disableAll(disabled){
    // ä¸é–æ­» PDFï¼ˆä½ å¾Œä¾†è¦æ±‚ã€Œæé†’ä½†ä¸è¦é–æ­»ã€ï¼‰
    lockBtn.disabled = disabled;
    startBtn.disabled = disabled;
    secondBtn.disabled = disabled;
    viewerBtn.disabled = disabled;
    resetBtn.disabled = disabled;
    // pdfBtn ä¸åœ¨é€™è£¡ä¸€èµ· disabledï¼ˆä¿ç•™å¯ä¸‹è¼‰ï¼‰
  }

  function normalizeNames(raw){
    return raw
      .replace(/[ï¼Œã€]/g, ",")
      .replace(/\s+/g, " ")
      .split(/[, \n\r\t]+/g)
      .map(s => s.trim())
      .filter(Boolean);
  }

  function hasDuplicate(arr){
    const s = new Set();
    for(const x of arr){
      if(s.has(x)) return true;
      s.add(x);
    }
    return false;
  }

  // ===== ä½ åŸæœ¬çš„ verse è³‡æ–™/é‚è¼¯ï¼ˆæ­¤è™•ç¤ºæ„ï¼›ä¿ç•™ä½ çš„çµæ§‹ï¼‰ =====
  // æ³¨æ„ï¼šå¦‚æœä½ åŸæœ¬ index.html å·²å«å®Œæ•´ verses/åˆ†é¡/ viewer é€£çµç­‰ï¼Œ
  // ä½ å¯ä»¥æŠŠé€™æ®µç¶­æŒåŸæ¨£ï¼›æœ¬ç‰ˆæ ¸å¿ƒä¸»è¦æ›¿æ›ã€Œè½‰ç›¤æ ¸å¿ƒã€èˆ‡ã€ŒPDF åŒ¯å‡ºã€ã€‚
  const VERSES = (window.VERSES || []); // è‹¥ä½ åŸæœ¬æœ‰å¤–æ›/å…§åµŒè³‡æ–™ï¼Œä»å¯æ²¿ç”¨

  function pickVerse(){
    // ä¾ä½ åŸæœ¬è¦å‰‡ï¼šå…¨å±€ä¸é‡è¤‡ï¼ˆusedVersesï¼‰
    const all = VERSES;
    if(!all || all.length === 0){
      return { id:"000", ref:"ï¼ˆè«‹å…ˆè¼‰å…¥ç¶“å¥è³‡æ–™ï¼‰", book:"", chap:"" };
    }
    const remaining = all.filter(v => !usedVerses.includes(v.id));
    const pool = remaining.length ? remaining : all;
    const v = pool[Math.floor(Math.random()*pool.length)];
    if(!usedVerses.includes(v.id)) usedVerses.push(v.id);
    return v;
  }

  function getSpinDurationMs(){
    // ä½ è¦è·Ÿ drum.mp3 æ›´è²¼è¿‘ï¼›é€™è£¡ç¶­æŒç©©å®šå›ºå®šå€¼ï¼ˆå¯å†å¾®èª¿ï¼‰
    return 5200;
  }

  // ====== easingï¼ˆä½ åŸæœ¬ï¼‰ ======
  function easeOutCubic(t){
    return 1 - Math.pow(1 - t, 3);
  }

  // ====== MVP æ ¸å¿ƒè§’åº¦å·¥å…·ï¼ˆv8.5.5ï¼‰ ======
  function normAngle(a){
    a = a % (Math.PI*2);
    if(a < 0) a += Math.PI*2;
    return a;
  }
  function shortestDiff(from, to){
    // from/to in [0, 2Ï€)
    let d = to - from;
    if(d > Math.PI) d -= Math.PI*2;
    if(d < -Math.PI) d += Math.PI*2;
    return d;
  }
  function easeOutQuint(t){
    return 1 - Math.pow(1 - t, 5);
  }

  // ====== âœ… MVP æ ¸å¿ƒæ•´å¡Šæ›¿æ›ï¼šdrawWheel ======
  function drawWheel(items, rotation, drawText=true, highlightIndex=null, highlightAlpha=0){
    ctx.clearRect(0,0,380,380);
    if(!items || items.length === 0) return;

    const count = items.length;
    const arc = (Math.PI*2)/count;

    ctx.save();
    ctx.translate(CENTER, CENTER);
    ctx.rotate(rotation);
    ctx.translate(-CENTER, -CENTER);

    for(let i=0;i<count;i++){
      // âœ… å”¯ä¸€åŸºæº–ï¼šä»¥ã€Œæ‰‡å½¢ä¸­å¿ƒã€ç‚ºæº–ï¼ˆä¸­å¿ƒè§’ = i*arc - PI/2ï¼‰
      const start = i*arc - Math.PI/2 - arc/2;
      const end = start + arc;

      ctx.beginPath();
      ctx.fillStyle = (i % 2 === 0) ? "#fde7b5" : "#fcdca0";
      ctx.moveTo(CENTER, CENTER);
      ctx.arc(CENTER, CENTER, RADIUS, start, end);
      ctx.closePath();
      ctx.fill();

      // é«˜äº®ï¼šè¦†è“‹æ•´å€‹æ‰‡å½¢ï¼ˆå…¨éƒ¨å€åŸŸï¼‰ï¼Œä½†ä¸é®å­—ï¼ˆå…ˆç•«é«˜äº®ã€å†ç•«å­—ï¼‰
      if(highlightIndex === i && highlightAlpha > 0){
        ctx.save();
        ctx.globalAlpha = highlightAlpha;
        ctx.fillStyle = "#f5bc00"; // ä½ æŒ‡å®šçš„æ–°è‰²
        ctx.beginPath();
        ctx.moveTo(CENTER, CENTER);
        ctx.arc(CENTER, CENTER, RADIUS, start, end);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
      }

      // åˆ†éš”ç·šï¼ˆç¶­æŒåŸç²—ç´°ï¼‰
      ctx.strokeStyle = "#ffffff";
      ctx.lineWidth = 2;
      ctx.stroke();

      if(drawText){
        ctx.save();
        ctx.translate(CENTER, CENTER);
        const mid = start + arc/2;
        ctx.rotate(mid);
        ctx.textAlign = "right";
        ctx.font = "22px Noto Sans TC";
        ctx.fillStyle = "#5b3a00";
        ctx.fillText(items[i], RADIUS - 22, 10);
        ctx.restore();
      }
    }

    ctx.restore();
  }

  // ====== âœ… MVP æ ¸å¿ƒæ•´å¡Šæ›¿æ›ï¼šspinToIndex ======
  function spinToIndex(items, targetIndex, clockwise, durationMs){
    return new Promise(async (resolve)=>{
      if(isSpinning) return;
      isSpinning = true;
      disableAll(true);

      showBadge("");
      showCenterText("");

      const count = items.length;
      const arc = (Math.PI*2)/count;

      // âœ… å”¯ä¸€åŸºæº–ï¼šslice ä¸­å¿ƒè§’ = i*arc - PI/2ï¼ˆèˆ‡ drawWheel å®Œå…¨ä¸€è‡´ï¼‰
      const targetCenter = targetIndex * arc - Math.PI/2;

      // æŒ‡é‡æ–¹å‘ï¼š12 é»ï¼ˆcanvas æ¥µåº§æ¨™ = -PI/2ï¼‰
      const pointerAngle = -Math.PI/2;

      // é€Ÿåº¦ï¼šæ²¿ç”¨ä½ å·²é©—è­‰ OK çš„åœˆæ•¸è¨­å®š
      const SPEED_BOOST = 1.35;
      const baseSpins = 4.8;
      const spins = baseSpins * SPEED_BOOST;

      const dir = clockwise ? 1 : -1;

      // æœŸæœ›æœ€çµ‚ rotationï¼ˆmod 2Ï€ï¼‰ï¼šè®“ã€Œè©²æ ¼ä¸­å¿ƒã€å°æº–æŒ‡é‡
      let desiredMod = normAngle(pointerAngle - targetCenter);

      // âœ… é¿å…ã€Œå¡åœ¨åˆ†éš”ç·šã€ï¼šéå¸¸å°çš„å…§ç¸®ï¼ˆä¸æ”¹è®Šå‘½ä¸­æ ¼ï¼‰
      const eps = arc * 0.02; // 2% æ‰‡å½¢å¯¬
      desiredMod = normAngle(desiredMod + eps);

      const startRotation = currentRotation;
      const startMod = normAngle(startRotation);

      // baseDelta èµ°è¼ƒè‡ªç„¶çš„çŸ­è·¯å¾‘ï¼Œå†åŠ å¤šåœˆï¼ˆåŒæ–¹å‘ï¼‰
      const baseDelta = shortestDiff(startMod, desiredMod);
      const deltaRotation = baseDelta + dir * (spins * 2 * Math.PI);

      // æ’­éŸ³æ•ˆï¼ˆèˆ‡å‹•ç•«åŒæ™‚é–‹å§‹ï¼‰ï¼›ä¸åœ¨çµæŸæ™‚å¼·åˆ¶ pauseï¼Œé¿å…æˆªæ–·å°¾éŸ³
      await playDrum();

      const t0 = performance.now();

      function frame(now){
        let t = (now - t0) / durationMs;
        if(t>1) t = 1;

        const eased = easeOutQuint(t);
        const rot = startRotation + deltaRotation*eased;

        drawWheel(items, rot, true);

        if(t < 1){
          requestAnimationFrame(frame);
        }else{
          // âœ… è¨˜ä½çœŸæ­£åœä¸‹ä¾†çš„è§’åº¦ï¼ˆç´¯åŠ ï¼‰
          currentRotation = startRotation + deltaRotation;
          drawWheel(items, currentRotation, true);

          isSpinning = false;
          disableAll(false);
          resolve(currentRotation);
        }
      }

      requestAnimationFrame(frame);
    });
  }

  // ====== ç¬¬ä¸€è¼ªï¼šæŠ½å§“å ======
  async function startRound1(){
    if(isSpinning) return;

    if(!locked || nameList.length < 2){
      alert("è«‹å…ˆè¼¸å…¥å§“åä¸¦é–å®šåå–®ï¼");
      return;
    }

    if(stage === "round1_done_wait_round2"){
      // ç¬¬ä¸€è¼ªæŠ½å®Œæœªé€²ç¬¬äºŒè¼ªå‰ä¸å¯å†æŒ‰
      return;
    }

    // æœ¬è¼ªå‰©é¤˜æœªæŠ½çš„äºº
    const remaining = nameList.filter(n => !usedNames.includes(n));
    if(remaining.length === 0){
      finishRoundHint();
      return;
    }

    const winner = remaining[Math.floor(Math.random()*remaining.length)];
    selectedName = winner;
    selectedVerse = null;

    setStatus("ğŸ¡ ç¬¬ 1 è¼ªï¼šå§“åæŠ½ç±¤ä¸­â€¦");
    secondBtn.style.display = "none";
    viewerBtn.style.display = "none";
    showCenterText("");

    const idx = nameList.indexOf(winner);

    // ç¬¬ä¸€è¼ªï¼šé€†æ™‚é‡
    await spinToIndex(nameList, idx, false, getSpinDurationMs());

    setStatus(`ğŸ¯ ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${winner}ã€`);
    stage = "round1_done_wait_round2";
    saveState();

    // ç¬¬äºŒè¼ªæŒ‰éˆ•é–ƒçˆæé†’
    secondBtn.style.display = "inline-block";
    secondBtn.classList.add("blinking");

    // ç¬¬ä¸€è¼ªçµæŸå¾Œï¼šé–‹å§‹éµä¸å¯æŒ‰ï¼ˆé¿å…é‡è¤‡ï¼‰
    startBtn.disabled = true;
  }

  // ====== ç¬¬äºŒè¼ªï¼šæŠ½ç¶“å¥ ======
  async function startRound2(){
    if(isSpinning) return;

    if(stage !== "round1_done_wait_round2" || !selectedName){
      alert("è«‹å…ˆå®Œæˆç¬¬ 1 è¼ªå§“åæŠ½ç±¤ï¼");
      return;
    }

    setStatus("ğŸ ç¬¬ 2 è¼ªï¼šç¥ç¦ç¶“å¥æŠ½ç±¤ä¸­â€¦");
    secondBtn.classList.remove("blinking");
    secondBtn.disabled = true;

    // æŠ½ verseï¼ˆå…¨å±€ä¸é‡è¤‡ï¼‰
    const v = pickVerse();
    selectedVerse = v;

    // ç¬¬äºŒè¼ªä»ä½¿ç”¨åŒä¸€é¡†è¼ªç›¤ï¼ˆä¸é‡ç•«ä¸åŒåå–®ï¼‰
    // æ­¤è™•ä½ ä¸»ç¨‹å¼åŸå…ˆå¯èƒ½æ˜¯å¦ä¸€å€‹è¼ªç›¤ï¼ˆç¶“å¥è¼ªç›¤ï¼‰ã€‚
    // ç›®å‰ç¤ºç¯„ï¼šä»è®“è¼ªç›¤è½‰ä¸€åœˆï¼ˆè¦–è¦ºæŠ½ç±¤ï¼‰ï¼Œåœä¸‹å¾Œå†é¡¯ç¤ºæ›¸å·/ç« ç¯€ï¼ˆé¿å…ã€Œå…ˆé¡¯ç¤ºåƒä½œå¼Šã€ï¼‰
    const idx = Math.floor(Math.random() * nameList.length);

    // ç¬¬äºŒè¼ªï¼šé †æ™‚é‡ï¼ˆæˆ–ä½ è¦å›ºå®šåŒæ–¹å‘ä¹Ÿå¯ï¼‰
    await spinToIndex(nameList, idx, true, getSpinDurationMs());

    // åœä¸‹å¾Œå†é¡¯ç¤ºï¼ˆç¬¦åˆä½ è¦æ±‚ï¼šåœä¸‹æ‰é¡¯ç¤ºï¼Œä¸åƒä½œå¼Šï¼‰
    const book = v.book || "";
    const chap = v.chap || "";
    showCenterText(book, chap);

    // è¨˜éŒ„ï¼šåŠ å…¥ logsï¼ˆè·¨è¼ªç´¯ç©ï¼‰
    const ts = new Date().toLocaleString("zh-TW", { hour12:false });
    drawLogs.push({
      ts,
      name: selectedName,
      verseId: v.id,
      ref: v.ref || "",
      book,
      chap
    });

    usedNames.push(selectedName);

    setStatus(`ğŸ¯ ç¬¬ 2 è¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ${v.id}ã€`);
    stage = "round2_done_wait_viewer";
    saveState();

    viewerBtn.style.display = "inline-block";
    viewerBtn.disabled = false;

    // PDF ä¸‹è¼‰æé†’ï¼šè‹¥æœ¬è¼ªæŠ½å®Œï¼Œè®“ PDF é–ƒçˆï¼ˆä½†ä¸é–æ­»ï¼‰
    if(nameList.filter(n => !usedNames.includes(n)).length === 0){
      pdfBtn.classList.add("blinking");
      finishRoundHint();
    }
  }

  function finishRoundHint(){
    const total = nameList.length;
    setStatus(
`ğŸ‰ æ­¤è¼ªè½‰ç›¤å·²å®Œæˆ ${total} ä½çš„ç´…åŒ…æŠ½ç±¤
ğŸ“„ è«‹æŒ‰ã€ŒæŠ½ç±¤ç´€éŒ„ PDFã€ä¸‹è¼‰ç´€éŒ„ï¼Œæˆ–
ğŸ” è¼¸å…¥æ–°å§“å â†’ æŒ‰ã€Œé–å®šåå–®ã€é–‹å§‹ä¸‹ä¸€è¼ªï¼›ä¹Ÿå¯æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€`
    );
  }

  // ====== Viewerï¼ˆæ²¿ç”¨ä½ åŸæœ¬å°å‘ï¼‰ ======
  function openViewer(){
    if(!selectedName || !selectedVerse){
      alert("è«‹å…ˆå®Œæˆç¬¬ 2 è¼ªæŠ½ç´…åŒ…ï¼");
      return;
    }
    // ä½ åŸæœ¬ viewer.html çš„æ¥æ³•ï¼šå¯ç”¨ localStorage äº¤æ›è³‡æ–™
    localStorage.setItem("lastDraw", JSON.stringify({
      name: selectedName,
      verse: selectedVerse
    }));
    // å°å‘ viewer.htmlï¼ˆä½ çš„ repo å…§åŒåæª”ï¼‰
    location.href = "viewer.html";
  }

  // ====== ä¸‹ä¸€ä½ï¼ˆå›åˆ°å¯æŒ‰é–‹å§‹éµï¼‰ ======
  function nextPerson(){
    // ç¬¬äºŒè¼ªçœ‹å®Œå›ä¾†ï¼šå…è¨±ä¸‹ä¸€ä½
    stage = "idle";
    selectedName = null;
    selectedVerse = null;
    showCenterText("");
    secondBtn.style.display = "none";
    viewerBtn.style.display = "none";
    secondBtn.disabled = false;

    // è‹¥æœ¬è¼ªé‚„æœ‰å‰©é¤˜ï¼Œé–‹å§‹éµå¯æŒ‰
    const remaining = nameList.filter(n => !usedNames.includes(n));
    if(remaining.length > 0){
      startBtn.disabled = false;
      setStatus("è«‹æŒ‰ã€Œé–‹å§‹æŠ½å§“å + ç¶“å¥ã€é€²è¡Œä¸‹ä¸€ä½");
    }else{
      finishRoundHint();
      startBtn.disabled = true;
    }
    saveState();
  }

  // ====== PDFï¼ˆCanvasâ†’åœ–ç‰‡â†’PDFï¼Œå›ºå®šé»‘è‰²ï¼Œé¿å…äº‚ç¢¼ï¼‰ ======
  async function exportPDF(){
    try{
      if(drawLogs.length === 0){
        alert("å°šç„¡ç´€éŒ„");
        return;
      }

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit:"pt", format:"a4", compress:true });

      // A4 in pt
      const pageW = 595.28;
      const pageH = 841.89;

      // é«˜è§£æç•«å¸ƒï¼ˆé¿å…æ¨¡ç³Šï¼‰ï¼š2x
      const scale = 2;
      const cw = Math.floor(pageW * scale);
      const ch = Math.floor(pageH * scale);

      const canvas = document.createElement("canvas");
      canvas.width = cw;
      canvas.height = ch;
      const cctx = canvas.getContext("2d");

      const margin = 40 * scale;
      const lineH = 22 * scale;

      const lines = [];
      // âœ… å›ºå®šé»‘è‰²å­—é«”ï¼Œé¿å…äº‚ç¢¼ï¼šç›´æ¥ç”¨ Canvas æ–‡å­—ï¼Œå†å¡å…¥ PDF
      lines.push("BlessingCards128 æŠ½ç±¤ç´€éŒ„");
      lines.push("");

      for(const row of drawLogs){
        const name = row.name ?? "";
        const id = row.verseId ?? row.id ?? "";
        const ref = row.ref ?? row.reference ?? "";
        const book = row.book ?? "";
        const chap = row.chap ?? row.chapter ?? "";
        const ts = row.ts ?? row.time ?? "";
        const line1 = ts ? `[${ts}] ${name}` : `${name}`;
        const line2 = id ? `ç·¨è™Ÿã€Œ${id}ã€${ref ? "ï¼ˆ"+ref+"ï¼‰" : ""}` : (ref || "");
        const line3 = (book || chap) ? `${book}${chap}` : "";
        lines.push(line1);
        if(line2) lines.push(line2);
        if(line3) lines.push(line3);
        lines.push("");
      }

      let pageIndex = 0;
      let y = margin;

      function newPage(){
        if(pageIndex > 0) pdf.addPage();
        cctx.clearRect(0,0,cw,ch);
        cctx.fillStyle = "#ffffff";
        cctx.fillRect(0,0,cw,ch);

        // å›ºå®šé»‘è‰²
        cctx.fillStyle = "#000000";
        cctx.font = `${20*scale}px "Noto Sans TC", system-ui, -apple-system, sans-serif`;
        y = margin;
        pageIndex++;
      }

      function wrapText(text, maxWidth){
        const chars = text.split("");
        const out = [];
        let cur = "";
        for(const ch of chars){
          const test = cur + ch;
          if(cctx.measureText(test).width > maxWidth && cur){
            out.push(cur);
            cur = ch;
          }else{
            cur = test;
          }
        }
        if(cur) out.push(cur);
        return out;
      }

      newPage();

      const maxWidth = cw - margin*2;

      for(const raw of lines){
        const txt = String(raw ?? "");
        const wrapped = wrapText(txt, maxWidth);
        for(const line of wrapped){
          if(y + lineH > ch - margin){
            const img = canvas.toDataURL("image/png");
            pdf.addImage(img, "PNG", 0, 0, pageW, pageH);
            newPage();
          }
          cctx.fillText(line, margin, y);
          y += lineH;
        }
      }

      const img = canvas.toDataURL("image/png");
      pdf.addImage(img, "PNG", 0, 0, pageW, pageH);

      pdf.save("draw_logs.pdf");

      // ä¸‹è¼‰å¾Œï¼šåœæ­¢é–ƒçˆ
      pdfBtn.classList.remove("blinking");

    }catch(e){
      console.error(e);
      alert("PDF ç”¢ç”Ÿå¤±æ•—ï¼šè«‹æŸ¥çœ‹ Console éŒ¯èª¤è¨Šæ¯ã€‚");
    }
  }

  // ====== å„²å­˜/è¼‰å…¥ï¼ˆè·¨è¼ªç´¯ç©è¦å‰‡ï¼‰ ======
  function saveState(){
    const st = {
      locked,
      stage,
      nameList,
      usedNames,
      usedVerses,
      drawLogs,
      currentRotation,
      selectedName,
      selectedVerse
    };
    localStorage.setItem("bc128_state", JSON.stringify(st));
  }

  function loadState(){
    try{
      const raw = localStorage.getItem("bc128_state");
      if(!raw) return;
      const st = JSON.parse(raw);

      locked = !!st.locked;
      stage = st.stage || "idle";
      nameList = Array.isArray(st.nameList) ? st.nameList : [];
      usedNames = Array.isArray(st.usedNames) ? st.usedNames : [];
      usedVerses = Array.isArray(st.usedVerses) ? st.usedVerses : [];
      drawLogs = Array.isArray(st.drawLogs) ? st.drawLogs : [];
      currentRotation = typeof st.currentRotation === "number" ? st.currentRotation : 0;
      selectedName = st.selectedName || null;
      selectedVerse = st.selectedVerse || null;

      if(nameList.length){
        drawWheel(nameList, currentRotation, true);
      }else{
        drawWheel(["1","2","3"], 0, true);
      }

      if(locked){
        setStatus(`ğŸ”’ æ–°ä¸€è¼ªåå–®å·²é–å®šï¼Œå…± ${nameList.length} ä½\nè«‹æŒ‰ã€Œé–‹å§‹æŠ½å§“å + ç¶“å¥ã€`);
        secondBtn.style.display = "none";
        viewerBtn.style.display = "none";
        startBtn.disabled = false;
      }else{
        setStatus("è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€");
        startBtn.disabled = false;
      }

      // è‹¥æœ¬è¼ªæŠ½å®Œï¼Œæé†’ä¸‹è¼‰
      if(locked && nameList.length > 0 && nameList.filter(n=>!usedNames.includes(n)).length === 0){
        pdfBtn.classList.add("blinking");
        finishRoundHint();
      }

      // è‹¥åœåœ¨ round1_done_wait_round2ï¼Œé–‹å§‹éµä¿æŒ disabled
      if(stage === "round1_done_wait_round2"){
        startBtn.disabled = true;
        secondBtn.style.display = "inline-block";
      }
      if(stage === "round2_done_wait_viewer"){
        viewerBtn.style.display = "inline-block";
      }

    }catch(e){
      console.warn("loadState failed", e);
    }
  }

  // ====== ç¶å®šäº‹ä»¶ ======
  lockBtn.addEventListener("click", () => {
    const list = normalizeNames(namesTa.value);

    if(list.length < 2){
      alert("è‡³å°‘è¦æœ‰å…©ä½æ‰å¯ä»¥é–‹å§‹å”·ï¼");
      return;
    }
    if(hasDuplicate(list)){
      alert("Oops, æœ‰å§“åé‡è¤‡è¼¸å…¥äº†å”·ï¼");
      return;
    }

    nameList = list;
    locked = true;

    // âœ… è·¨è¼ªç´¯ç©ï¼šé–å®šåå–® = é–‹å§‹æ–°ä¸€è¼ª â†’ åªé‡ç½® usedNamesï¼Œä¸æ¸… logs
    usedNames = [];
    selectedName = null;
    selectedVerse = null;
    stage = "idle";

    // åˆå§‹åŒ–è¼ªç›¤
    currentRotation = 0;
    drawWheel(nameList, 0, true);

    setStatus(`ğŸ”’ æ–°ä¸€è¼ªåå–®å·²é–å®šï¼Œå…± ${nameList.length} ä½\nè«‹æŒ‰ã€Œé–‹å§‹æŠ½å§“å + ç¶“å¥ã€`);
    startBtn.disabled = false;

    secondBtn.style.display = "none";
    viewerBtn.style.display = "none";
    secondBtn.disabled = false;
    pdfBtn.classList.remove("blinking");

    saveState();
  });

  startBtn.addEventListener("click", startRound1);

  secondBtn.addEventListener("click", startRound2);

  viewerBtn.addEventListener("click", openViewer);

  pdfBtn.addEventListener("click", exportPDF);

  resetBtn.addEventListener("click", () => {
    if(confirm("ç¢ºå®šè¦å…¨éƒ¨æ­¸é›¶ï¼Ÿæ‰€æœ‰è³‡æ–™ï¼ˆå«è·¨è¼ªç´€éŒ„ï¼‰éƒ½æœƒæ¸…ç©ºã€‚")){
      localStorage.clear();
      locked = false;
      stage = "idle";
      nameList = [];
      usedNames = [];
      usedVerses = [];
      drawLogs = [];
      currentRotation = 0;
      selectedName = null;
      selectedVerse = null;

      namesTa.value = "";
      drawWheel(["1","2","3"], 0, true);
      setStatus("è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€");

      secondBtn.style.display = "none";
      viewerBtn.style.display = "none";
      pdfBtn.classList.remove("blinking");
    }
  });

  // ä½ åŸæœ¬ viewer.html å›ä¾†å¾Œï¼Œé€šå¸¸æœƒå¸¶ query æˆ– localStorage è¨Šè™Ÿ
  // é€™è£¡æä¾›ã€Œå›ä¾†å°±è‡ªå‹• nextPersonã€çš„ç°¡å–®æ©Ÿåˆ¶ï¼ˆè‹¥ä½ å·²æœ‰æ›´å®Œæ•´é‚è¼¯å¯æ”¹å›ä½ çš„ï¼‰
  window.addEventListener("pageshow", () => {
    // è‹¥å‰›å¾ viewer å›ä¾†ä¸” stage=round2_done_wait_viewerï¼Œæä¾›ä¸‹ä¸€ä½æµç¨‹
    if(stage === "round2_done_wait_viewer"){
      // è‡ªå‹•æŠŠ Viewer æŒ‰éˆ•æ›æˆã€Œä¸‹ä¸€ä½ã€
      viewerBtn.textContent = "ä¸‹ä¸€ä½";
      viewerBtn.onclick = (e) => { e.preventDefault(); viewerBtn.textContent="çœ‹ç´…åŒ…å…§å®¹"; viewerBtn.onclick=null; nextPerson(); };
    }
  });

  // ====== åˆå§‹åŒ– ======
  drawWheel(["1","2","3"], 0, true);
  setStatus("è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€");
  secondBtn.style.display = "none";
  viewerBtn.style.display = "none";
  pdfBtn.classList.remove("blinking");

  loadState();

})();
</script>
</body>
</html>