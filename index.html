<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</title>

<style>
body{
  font-family: "Noto Sans TC", system-ui, -apple-system;
  background:#fbf1d6;
  text-align:center;
  margin:0;
  padding:0;
}

h1{
  color:#9c6b00;
  margin-top:28px;
  margin-bottom:12px;
}

#verseImg{
  width:220px;
  height:auto;
  border-radius:6px;
  box-shadow:0 4px 10px rgba(0,0,0,.25);
  margin:6px auto 10px auto;
}

input{
  width:78%;
  max-width:520px;
  font-size:18px;
  padding:8px 10px;
  border-radius:10px;
  border:2px solid #d9b571;
  outline:none;
  text-align:center;
}

.btn{
  background:#f3c256;
  border:none;
  padding:10px 18px;
  border-radius:20px;
  margin:8px 6px;
  font-size:16px;
  cursor:pointer;
  box-shadow:0 2px 4px rgba(0,0,0,.15);
}

#canvasWrap{
  margin-top:8px;
}

#result{
  font-size:20px;
  margin-top:10px;
}

.flash{
  animation:flash 0.9s infinite;
}

@keyframes flash{
  0%{opacity:1;}
  50%{opacity:.3;}
  100%{opacity:1;}
}
</style>
</head>

<body>

<h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h1>

<img id="verseImg" src="cover.jpg" alt="verse">

<br>

<input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼ˆå¯ç”¨ã€é€—è™Ÿæˆ–ç©ºç™½åˆ†éš”ï¼‰">

<br>

<button class="btn" id="lockBtn">é–å®šåå–®</button>
<button class="btn" id="startBtn">é–‹å§‹æŠ½å§“åï¼‹ç¶“å¥</button>
<button class="btn" id="resetBtn">å…¨éƒ¨æ­¸é›¶</button>
<button class="btn" id="pdfBtn">æŠ½ç±¤ç´€éŒ„ PDF</button>

<div id="canvasWrap">
 <canvas id="wheel" width="360" height="360"></canvas>
</div>

<div id="result"></div>

<script>
/* ---------------- æ ¸å¿ƒç‹€æ…‹ï¼ˆä¿æŒç©©å®šï¼Œä¸æ›´å‹•è¦å‰‡ï¼‰ ---------------- */
let names = [];
let drawn = new Set();
let spinning=false;
let currentRotation=0;
const SPIN_TIME = 7500;   // â‰¥7ç§’
const HIGHLIGHT_TIME = 5500; // 5.5ç§’å‡ºçµæœ

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const r = canvas.width/2;

/* ----------------- ç•«è½‰ç›¤ ----------------- */
function drawWheel(highlightIndex=-1){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(names.length===0) return;

  const n = names.length;
  const arc = 2*Math.PI/n;

  for(let i=0;i<n;i++){
    ctx.beginPath();
    ctx.moveTo(r,r);
    ctx.arc(r,r,r-2,i*arc,(i+1)*arc);
    ctx.closePath();

    ctx.fillStyle = (i===highlightIndex) ? "#ffcc33" : "#f5dca1";
    ctx.fill();

    ctx.strokeStyle="#ffffff";
    ctx.lineWidth=2;
    ctx.stroke();

    ctx.save();
    ctx.translate(r,r);
    ctx.rotate(i*arc+arc/2);
    ctx.textAlign="center";
    ctx.font="18px sans-serif";
    ctx.fillStyle="#5c3b00";
    ctx.fillText(names[i],0,-r*0.65);
    ctx.restore();
  }
}

/* ----------------- æŠ½é¸ ----------------- */
function spinOnce(){

  if(spinning||names.length===0) return;
  spinning=true;

  const n = names.length;
  const arc = 2*Math.PI/n;

  // éš¨æ©ŸæŒ‡åˆ°å…¶ä¸­ä¸€æ ¼
  const winnerIndex = Math.floor(Math.random()*n);

  // ç›®æ¨™è§’åº¦ï¼ˆä¸­å¿ƒï¼‰
  const targetAngle = (Math.PI/2) - (winnerIndex*arc + arc/2);

  const fullTurns = 4 + Math.random()*2;
  const finalRotation = fullTurns*2*Math.PI + targetAngle;

  const start = performance.now();

  let highlightDone=false;
  let winnerName = names[winnerIndex];

  function animate(now){
    const elapsed = now - start;

    // é«˜äº®èˆ‡ ğŸ¯ åŒæ­¥åœ¨ 5.5ç§’
    if(!highlightDone && elapsed>=HIGHLIGHT_TIME){
      drawWheel(winnerIndex);
      document.getElementById("result").innerHTML =
        `ğŸ¯ æŠ½ä¸­ã€Œ${winnerName}ã€<br>âœ… å·²æŠ½å‡º ${drawn.size+1}/${names.length}`;
      highlightDone=true;
    }

    if(elapsed>=SPIN_TIME){
      currentRotation = finalRotation%(2*Math.PI);
      drawWheel(winnerIndex);
      drawn.add(winnerName);

      // å®Œæˆè‡ªå‹•é¡¯ç¤º
      if(drawn.size===names.length){
        document.getElementById("result").innerHTML =
         `ğŸ¯ æŠ½ä¸­ã€Œ${winnerName}ã€<br>
          âœ… å·²æŠ½å‡º ${drawn.size}/${names.length}<br>
          ğŸ‰ æ­¤è¼ªè½‰ç›¤å·²å®Œæˆæ‰€æœ‰å§“åæŠ½ç±¤`;
      }

      spinning=false;
      return;
    }

    const t = elapsed/SPIN_TIME;
    const ease = t<1 ? (--t)*t*t+1 : 1;

    const angle = currentRotation + (finalRotation-currentRotation)*ease;

    ctx.save();
    ctx.translate(r,r);
    ctx.rotate(angle);
    ctx.translate(-r,-r);
    drawWheel(-1);
    ctx.restore();

    requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);
}

/* ----------------- UI æ§åˆ¶ ----------------- */
document.getElementById("lockBtn").onclick=()=>{
  const val = document.getElementById("nameInput").value.trim();

  if(!val){
    alert("è«‹å…ˆè¼¸å…¥å§“å");
    return;
  }

  names = val.replace(/,/g," ").split(/\s+/).filter(x=>x);
  drawn.clear();
  currentRotation=0;
  drawWheel();
  document.getElementById("result").innerHTML="åå–®å·²é–å®šï¼Œè«‹é–‹å§‹æ—‹è½‰";
};

document.getElementById("startBtn").onclick=spinOnce;

document.getElementById("resetBtn").onclick=()=>{
  names=[];
  drawn.clear();
  ctx.clearRect(0,0,360,360);
  document.getElementById("result").innerHTML="å·²å…¨éƒ¨æ­¸é›¶";
};

document.getElementById("pdfBtn").onclick=()=>{
  alert("æ­¤ç‰ˆæœ¬åƒ…ä¿ç•™ UIï¼Œä¸è®Šæ›´æ ¸å¿ƒï¼›PDF å¦ç‰ˆä¿ç•™");
};

</script>
</body>
</html>