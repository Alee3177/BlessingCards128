<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:"Noto Sans TC","Microsoft JhengHei",sans-serif;
  background:#fff7e6;
  text-align:center;
  margin:0;
  padding:20px;
}

h1{
  color:#b23a00;
  margin-bottom:10px;
}

.logo{
  width:120px;
  margin-bottom:10px;
}

input{
  width:80%;
  max-width:420px;
  padding:10px;
  font-size:18px;
  margin-bottom:10px;
}

button{
  font-size:16px;
  padding:10px 14px;
  margin:4px;
  cursor:pointer;
}

button:disabled{
  opacity:.5;
  cursor:not-allowed;
}

#wheelBox{
  position:relative;
  width:320px;
  height:320px;
  margin:20px auto;
}

canvas{
  width:320px;
  height:320px;
}

#pointer{
  position:absolute;
  top:-8px;
  left:50%;
  transform:translateX(-50%);
  font-size:26px;
  color:red;
}

#statusText{
  margin-top:12px;
  font-size:16px;
  line-height:1.6;
  min-height:3em;
}

.blink{
  animation:blink 1s infinite;
}
@keyframes blink{
  0%{opacity:1}
  50%{opacity:.4}
  100%{opacity:1}
}
</style>
</head>

<body>

<h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h1>
<img src="logo3524.png" class="logo">

<br>
<input id="nameInput" placeholder="è¼¸å…¥å§“åï¼ˆå¯ç”¨ç©ºç™½ã€é€—è™Ÿã€é “è™Ÿåˆ†éš”ï¼‰">

<br>
<button onclick="lockList()">é–å®šåå–®</button>
<button id="startBtn" onclick="startRound()">é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
<button id="pdfBtn" onclick="exportPDF()">æŠ½ç±¤ç´€éŒ„PDF</button>
<button onclick="resetAll()">å…¨éƒ¨æ­¸é›¶</button>

<div id="wheelBox">
  <div id="pointer">â–¼</div>
  <canvas id="wheel" width="320" height="320"></canvas>
</div>

<div id="statusText">è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€</div>

<script src="verseRefMap.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ================= ç‹€æ…‹ ================= */
let nameList=[];
let locked=false;
let usedNames=[];
let logs=[];

const wheel=document.getElementById("wheel");
const ctx=wheel.getContext("2d");
const statusText=document.getElementById("statusText");
const startBtn=document.getElementById("startBtn");
const pdfBtn=document.getElementById("pdfBtn");

/* ================= å·¥å…· ================= */
function parseNames(str){
  return [...new Set(
    str.split(/[\s,ã€]+/).map(s=>s.trim()).filter(Boolean)
  )];
}

function drawWheel(names, highlightIndex=null){
  ctx.clearRect(0,0,320,320);
  if(!names.length) return;

  const cx=160, cy=160, r=150;
  const n=names.length;
  const step=2*Math.PI/n;

  for(let i=0;i<n;i++){
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.fillStyle =
      (i===highlightIndex) ? "#ffd28a" :
      (i%2 ? "#ffe7c2" : "#fff0d8");
    ctx.arc(
      cx,cy,r,
      -Math.PI/2+i*step,
      -Math.PI/2+(i+1)*step
    );
    ctx.fill();
    ctx.strokeStyle="#ffffff";
    ctx.stroke();

    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(-Math.PI/2+(i+0.5)*step);
    ctx.textAlign="right";
    ctx.fillStyle="#5a2a00";
    ctx.font="16px sans-serif";
    ctx.fillText(names[i], r-10, 6);
    ctx.restore();
  }
}

/* ================= åˆå§‹åŒ– ================= */
drawWheel([]);

/* ================= è¡Œç‚º ================= */
function lockList(){
  const raw=document.getElementById("nameInput").value;
  const arr=parseNames(raw);

  if(arr.length<2){
    alert("è‡³å°‘éœ€è¦å…©ä½å§“å");
    return;
  }

  nameList=arr;
  usedNames=[];
  logs=[];
  locked=true;

  statusText.innerText =
    `ğŸ”’ æ–°ä¸€è¼ªåå–®å·²é–å®šï¼Œå…± ${nameList.length} ä½\nè«‹æŒ‰ã€Œé–‹å§‹æŠ½å§“å + ç¶“å¥ã€`;

  startBtn.disabled=false;
  pdfBtn.classList.remove("blink");

  drawWheel(nameList);
}

function startRound(){
  if(!locked) return;

  const remain=nameList.filter(n=>!usedNames.includes(n));
  if(remain.length===0){
    const c=nameList.length;
    statusText.innerHTML =
      `ğŸ‰ æ­¤è¼ªè½‰ç›¤å·²å®Œæˆ ${c} ä½çš„ç´…åŒ…æŠ½ç±¤<br>`+
      `ğŸ“„ è«‹æŒ‰ã€ŒæŠ½ç±¤ç´€éŒ„PDFã€ä¸‹è¼‰æˆ–æ˜¯<br>`+
      `ğŸ” è¼¸å…¥æ–°å§“åå¾ŒæŒ‰ã€Œé–å®šåå–®ã€é–‹å§‹ä¸‹ä¸€è¼ªï¼Œ<br>`+
      `ä¹Ÿå¯æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€æ¸…ç©ºè³‡æ–™é‡æ–°é–‹å§‹ã€‚`;
    pdfBtn.classList.add("blink");
    return;
  }

  startBtn.disabled=true;

  const winner=remain[Math.floor(Math.random()*remain.length)];
  const idx=nameList.indexOf(winner);

  drawWheel(nameList, idx);
  statusText.innerText=`ğŸ¯ ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${winner}ã€`;

  logs.push({
    time:new Date().toLocaleString("zh-TW"),
    name:winner,
    verse:"â€”"
  });
  usedNames.push(winner);

  setTimeout(()=>{ startBtn.disabled=false; },600);
}

function exportPDF(){
  if(!logs.length){
    alert("å°šç„¡æŠ½ç±¤ç´€éŒ„");
    return;
  }

  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();

  doc.setFontSize(16);
  doc.text("BlessingCards128 æŠ½ç±¤ç´€éŒ„",20,20);

  let y=36;
  doc.setFontSize(12);
  logs.forEach(l=>{
    doc.text(`[${l.time}] ${l.name}`,20,y);
    y+=8;
    if(y>280){ doc.addPage(); y=20; }
  });

  doc.save("BlessingCards128_æŠ½ç±¤ç´€éŒ„.pdf");
  pdfBtn.classList.remove("blink");
  statusText.innerText="âœ… æŠ½ç±¤ç´€éŒ„å·²ä¸‹è¼‰å®Œæˆ";
}

function resetAll(){
  if(!confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) return;
  nameList=[];
  usedNames=[];
  logs=[];
  locked=false;
  startBtn.disabled=false;
  pdfBtn.classList.remove("blink");
  document.getElementById("nameInput").value="";
  statusText.innerText="è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€";
  drawWheel([]);
}
</script>

</body>
</html>
