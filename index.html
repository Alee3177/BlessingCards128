<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>祝福經句紅包（應許等你拿）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- 預載 Logo，避免顯示過慢 -->
<link rel="preload" as="image" href="logo3524.png">

<style>
body{
  background:#fff8e7;
  font-family:"Noto Sans TC",system-ui,-apple-system,BlinkMacSystemFont;
  text-align:center;
  padding:20px;
  color:#5b3a00;
}
h1{
  color:#b07500;
  font-size:26px;
  margin:10px 0 8px;
}
.logo{
  width:120px;
  margin:10px auto 12px;
  display:block;
}
#nameInput{
  width:280px;
  padding:10px;
  font-size:18px;
  border-radius:8px;
  border:1px solid #bf8a3e;
  margin-bottom:10px;
}
.btn{
  background:#f7c76c;
  border:none;
  padding:12px 20px;
  border-radius:24px;
  font-size:17px;
  color:#5b3a00;
  cursor:pointer;
  margin:5px;
}
.btn:disabled{opacity:.45;cursor:not-allowed;}
#wheelContainer{
  position:relative;
  width:380px;
  height:380px;
  margin:20px auto;
}
#wheelCanvas{
  width:380px;
  height:380px;
}
#wheelPointer{
  position:absolute;
  top:-26px;
  left:50%;
  transform:translateX(-50%);
  font-size:44px;
  color:red;
  z-index:10;
}
#statusText{
  margin-top:10px;
  font-size:18px;
  color:#8a5a00;
}
</style>
</head>

<body>

<h1>祝福經句紅包（應許等你拿）</h1>
<img src="logo3524.png" class="logo" alt="logo">

<input id="nameInput" placeholder="請輸入姓名（用、或空白分隔）"><br>

<button class="btn" id="lockBtn">鎖定名單</button>
<button class="btn" id="startBtn">開始抽姓名 + 經句</button>
<button class="btn" id="resetBtn">全部歸零</button>
<button class="btn" id="pdfBtn">抽籤紀錄 PDF</button>

<div id="wheelContainer">
  <div id="wheelPointer">▼</div>
  <canvas id="wheelCanvas" width="380" height="380"></canvas>
</div>

<div id="statusText">請輸入姓名並鎖定名單</div>

<!-- 經文對照 -->
<script src="verseRefMap.js"></script>
<!-- 字型（Base64） -->
<script src="font_base64.js"></script>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ======================
   全域狀態
====================== */
const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");
const CENTER = 190, RADIUS = 175;

let nameList = [];
let locked = false;
let usedNames = [];
let logs = [];

/* 音效：只在使用者點擊時播放 */
const drumAudio = new Audio("audio/drum.mp3");

/* ======================
   事件綁定
====================== */
document.getElementById("lockBtn").onclick = lockList;
document.getElementById("startBtn").onclick = startDraw;
document.getElementById("resetBtn").onclick = resetAll;
document.getElementById("pdfBtn").onclick = exportPDF;

/* ======================
   工具
====================== */
function drawWheel(items){
  ctx.clearRect(0,0,380,380);
  if(!items.length) return;
  const arc = Math.PI*2/items.length;
  for(let i=0;i<items.length;i++){
    const start = i*arc - Math.PI/2;
    const end = start + arc;
    ctx.beginPath();
    ctx.moveTo(CENTER,CENTER);
    ctx.arc(CENTER,CENTER,RADIUS,start,end);
    ctx.fillStyle = i%2 ? "#fcdca0" : "#fde7b5";
    ctx.fill();
    ctx.strokeStyle="#fff";ctx.lineWidth=2;ctx.stroke();

    ctx.save();
    ctx.translate(CENTER,CENTER);
    ctx.rotate(start+arc/2);
    ctx.textAlign="right";
    ctx.font="22px Noto Sans TC";
    ctx.fillStyle="#5b3a00";
    ctx.fillText(items[i], RADIUS-16, 8);
    ctx.restore();
  }
}

/* 平滑停止，避免停在線上 */
function spinToIndex(items, index){
  drumAudio.currentTime=0;
  drumAudio.play().catch(()=>{});
  const arc = Math.PI*2/items.length;
  const target = index*arc + arc/2;
  const base = Math.PI/2; // 指針向下
  const spins = 4*2*Math.PI;
  const finalAngle = base - target + spins;

  const start = performance.now(), dur=4200;
  function animate(t){
    let p=(t-start)/dur; if(p>1)p=1;
    const e=1-Math.pow(1-p,3);
    ctx.save();
    ctx.clearRect(0,0,380,380);
    ctx.translate(CENTER,CENTER);
    ctx.rotate(finalAngle*e);
    ctx.translate(-CENTER,-CENTER);
    drawWheel(items);
    ctx.restore();
    if(p<1) requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);
}

/* ======================
   行為
====================== */
function lockList(){
  const raw = document.getElementById("nameInput").value.trim();
  if(!raw){alert("請輸入姓名");return;}
  const arr = raw.split(/[,、\s]+/).filter(Boolean);
  if(arr.length<2){alert("至少需要兩位");return;}
  const dup = arr.find((v,i)=>arr.indexOf(v)!==i);
  if(dup){alert("Oops, 有姓名被重複輸入了唷！");return;}

  nameList = arr;
  locked = true;
  usedNames = [];
  logs = [];
  drawWheel(nameList);
  document.getElementById("statusText").innerText =
    `名單已鎖定，共 ${nameList.length} 位`;
}

function startDraw(){
  if(!locked){alert("請先鎖定名單");return;}
  if(usedNames.length>=nameList.length){
    document.getElementById("statusText").innerText =
      `此輪轉盤已完成 ${nameList.length} 位的紅包抽籤，請按「全部歸零」重新開始。`;
    return;
  }
  const remain = nameList.filter(n=>!usedNames.includes(n));
  const winner = remain[Math.floor(Math.random()*remain.length)];
  const idx = nameList.indexOf(winner);
  document.getElementById("statusText").innerText =
    `第 1 輪抽籤中…`;
  spinToIndex(nameList, idx);
  setTimeout(()=>{
    usedNames.push(winner);
    document.getElementById("statusText").innerText =
      `第 1 輪完成：抽中「${winner}」`;
    logs.push({time:new Date(), name:winner});
  },4300);
}

function resetAll(){
  nameList=[];usedNames=[];logs=[];locked=false;
  ctx.clearRect(0,0,380,380);
  document.getElementById("nameInput").value="";
  document.getElementById("statusText").innerText="已全部歸零";
}

function exportPDF(){
  if(!logs.length){alert("尚無抽籤紀錄");return;}
  try{
    const {jsPDF}=window.jspdf;
    const doc=new jsPDF({unit:"pt",format:"a4"});
    doc.addFileToVFS("NotoSansTC.ttf", window.PDF_FONT.normal);
    doc.addFont("NotoSansTC.ttf","NotoSansTC","normal");
    doc.setFont("NotoSansTC","normal");
    doc.setFontSize(16);
    doc.text("BlessingCards128 抽籤紀錄",40,40);
    let y=70;
    doc.setFontSize(12);
    logs.forEach(l=>{
      doc.text(`${l.name}`,40,y);
      y+=20;
    });
    doc.save("BlessingCards128_抽籤紀錄.pdf");
  }catch(e){
    alert("PDF 產生失敗：請查看 Console 錯誤訊息。");
    console.error(e);
  }
}
</script>
</body>
</html>
