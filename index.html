<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>祝福經句紅包（應許等您拿）</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body{
    background:#fff8e7;
    font-family:"Noto Sans TC",system-ui,-apple-system,BlinkMacSystemFont;
    text-align:center;
    padding:20px;
    color:#5b3a00;
  }
  h1{ color:#b07500; margin-bottom:10px; }
  .logo{ width:120px; margin-bottom:10px; }

  input{
    width:280px;
    padding:10px;
    font-size:18px;
    border-radius:8px;
    border:1px solid #bf8a3e;
    margin-bottom:10px;
  }

  .btn{
    background:#f7c76c;
    border:none;
    padding:10px 20px;
    border-radius:22px;
    font-size:16px;
    color:#5b3a00;
    cursor:pointer;
    margin:4px;
  }
  .btn:disabled{ opacity:.45; cursor:not-allowed; }

  #wheelWrap{
    position:relative;
    width:360px;
    height:360px;
    margin:18px auto;
  }
  canvas{ width:360px; height:360px; }

  #pointer{
    position:absolute;
    top:-22px;
    left:50%;
    transform:translateX(-50%);
    font-size:40px;
    color:red;
    z-index:10;
  }

  #status{
    margin-top:10px;
    font-size:18px;
    color:#a56b00;
  }
</style>
</head>

<body>

<h1>祝福經句紅包（應許等您拿）</h1>
<img src="logo3524.png" class="logo" />

<br>
<input id="nameInput" placeholder="請輸入姓名（用 , 或 、 分隔）" />
<br>

<button class="btn" onclick="lockList()">鎖定名單</button>
<button class="btn" onclick="startDraw()" id="startBtn" disabled>開始抽姓名</button>
<button class="btn" onclick="resetAll()">全部歸零</button>

<div id="wheelWrap">
  <div id="pointer">▼</div>
  <canvas id="wheel" width="360" height="360"></canvas>
</div>

<div id="status">請輸入姓名並鎖定名單</div>

<audio id="drum" src="audio/drum.mp3" preload="auto"></audio>

<script>
/* ===============================
   v6.3-stable 核心設計
   - 永不改動 wheelOrder
   - 抽籤只抽 index
   - 轉盤只依 index 精準對齊
================================ */

// Canvas
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const C = 180;
const R = 170;

// 狀態
let wheelOrder = [];          // 永久固定順序
let remainingIndexes = [];   // 尚未抽的 index
let locked = false;
let isSpinning = false;

// 角度狀態
let currentAngle = 0;

// UI
const statusEl = document.getElementById("status");
const startBtn = document.getElementById("startBtn");
const drum = document.getElementById("drum");

// ===== 工具 =====
function shuffleIndexes(n){
  return [...Array(n).keys()];
}
function randomPick(arr){
  return arr[Math.floor(Math.random()*arr.length)];
}

// ===== 畫輪盤（純顯示，無副作用）=====
function drawWheel(){
  ctx.clearRect(0,0,360,360);
  const n = wheelOrder.length;
  if(n===0) return;

  const arc = Math.PI*2/n;

  for(let i=0;i<n;i++){
    const start = i*arc - Math.PI/2;
    const end = start + arc;

    ctx.beginPath();
    ctx.moveTo(C,C);
    ctx.arc(C,C,R,start,end);
    ctx.closePath();
    ctx.fillStyle = i%2 ? "#fde2a7" : "#fce8b8";
    ctx.fill();
    ctx.strokeStyle="#fff";
    ctx.stroke();

    ctx.save();
    ctx.translate(C,C);
    ctx.rotate(start + arc/2);
    ctx.textAlign="right";
    ctx.fillStyle="#5b3a00";
    ctx.font="20px 'Noto Sans TC'";
    ctx.fillText(wheelOrder[i], R-12, 8);
    ctx.restore();
  }
}

// ===== 核心：依 index 計算目標角度 =====
function angleForIndex(index){
  const n = wheelOrder.length;
  const arc = Math.PI*2/n;
  const sliceCenter = index*arc + arc/2;
  const pointerAngle = Math.PI/2; // 指針向下
  return pointerAngle - sliceCenter;
}

// ===== 轉動動畫（自然減速，無 snap）=====
function spinToIndex(index){
  return new Promise(resolve=>{
    const target = angleForIndex(index);
    const spins = 4; // 固定整圈數，穩定
    const startAngle = currentAngle;
    const endAngle = target + spins*2*Math.PI;

    const duration = 4200;
    const startTime = performance.now();

    drum.currentTime = 0;
    drum.play().catch(()=>{});

    function easeOut(t){ return 1-Math.pow(1-t,3); }

    function frame(now){
      const t = Math.min((now-startTime)/duration,1);
      currentAngle = startAngle + (endAngle-startAngle)*easeOut(t);

      ctx.save();
      ctx.clearRect(0,0,360,360);
      ctx.translate(C,C);
      ctx.rotate(currentAngle);
      ctx.translate(-C,-C);
      drawWheel();
      ctx.restore();

      if(t<1){
        requestAnimationFrame(frame);
      }else{
        currentAngle = target; // 精準落點（無重畫）
        ctx.save();
        ctx.clearRect(0,0,360,360);
        ctx.translate(C,C);
        ctx.rotate(currentAngle);
        ctx.translate(-C,-C);
        drawWheel();
        ctx.restore();
        resolve();
      }
    }
    requestAnimationFrame(frame);
  });
}

// ===== 流程 =====
function lockList(){
  if(isSpinning) return;

  const raw = document.getElementById("nameInput").value.trim();
  if(!raw){ alert("請輸入姓名"); return; }

  let names = raw.split(/[,、\s]+/).filter(Boolean);
  const set = new Set(names);
  if(set.size !== names.length){
    alert("Oops, 有姓名被重複輸入了唷！");
    return;
  }
  if(names.length < 2){
    alert("至少需要兩位");
    return;
  }

  wheelOrder = names.slice(); // 永久固定
  remainingIndexes = shuffleIndexes(wheelOrder.length);
  locked = true;
  startBtn.disabled = false;
  statusEl.textContent = `名單已鎖定（${wheelOrder.length} 位）`;

  currentAngle = 0;
  drawWheel();
}

async function startDraw(){
  if(!locked || isSpinning) return;
  if(remainingIndexes.length===0){
    statusEl.textContent = `此輪轉盤已完成 ${wheelOrder.length} 位的紅包抽籤，請按「全部歸零」重新開始。`;
    startBtn.disabled = true;
    return;
  }

  isSpinning = true;
  startBtn.disabled = true;

  const winIndex = randomPick(remainingIndexes);
  remainingIndexes = remainingIndexes.filter(i=>i!==winIndex);
  const winner = wheelOrder[winIndex];

  statusEl.textContent = "轉盤轉動中…";

  await spinToIndex(winIndex);

  statusEl.textContent = `第 1 輪完成：抽中「${winner}」`;
  startBtn.disabled = false;
  isSpinning = false;
}

function resetAll(){
  wheelOrder=[];
  remainingIndexes=[];
  locked=false;
  isSpinning=false;
  currentAngle=0;
  ctx.clearRect(0,0,360,360);
  document.getElementById("nameInput").value="";
  statusEl.textContent="請輸入姓名並鎖定名單";
  startBtn.disabled=true;
}
</script>

</body>
</html>
