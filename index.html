<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC","Segoe UI",sans-serif;
  background:#fbf2df;
  margin:0;
  padding:16px;
  text-align:center;
  color:#5b3a00;
}
h1{margin:8px 0}

input,button{
  font-size:16px;
  padding:8px 12px;
  border-radius:10px;
  border:1px solid #c9a56a;
}
button{
  background:#f5bc00;
  color:#5b3a00;
  cursor:pointer;
}
button:disabled{
  opacity:.5;
  cursor:not-allowed;
}

#panel{margin-bottom:10px}

#wrap{
  position:relative;
  width:360px;
  margin:0 auto;
}
canvas{display:block;margin:0 auto}

#pointer{
  position:absolute;
  left:50%;
  top:18px;
  transform:translateX(-50%);
  width:0;height:0;
  border-left:14px solid transparent;
  border-right:14px solid transparent;
  border-top:22px solid #d60000; /* å€’ä¸‰è§’ï¼Œå‘ä¸‹ */
}

#status{margin:8px 0;min-height:24px}

.blinking{
  animation:blink 1s infinite;
}
@keyframes blink{
  0%,50%,100%{opacity:1}
  25%,75%{opacity:.3}
}
</style>
</head>

<body>

<h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h1>

<div id="panel">
  <input id="nameInput" placeholder="è¼¸å…¥å§“åï¼ˆç©ºç™½åˆ†éš”ï¼‰" size="24">
  <br><br>
  <button id="lockBtn">é–å®šåå–®</button>
  <button id="startBtn">é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
  <button id="secondBtn" style="display:none">æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
  <button id="pdfBtn">æŠ½ç±¤ç´€éŒ„ PDF</button>
  <button id="resetBtn">å…¨éƒ¨æ­¸é›¶</button>
</div>

<div id="wrap">
  <div id="pointer"></div>
  <canvas id="cv" width="360" height="360"></canvas>
</div>

<div id="status"></div>

<script>
/* =========================
   å…¨åŸŸç‹€æ…‹
========================= */
let nameList=[];
let usedNames=[];
let usedVerses=[];
let logs=[];
let locked=false;
let stage="idle";
let selectedName=null;
let selectedVerse=null;

let isSpinning=false;
let currentRotation=0;

const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");
const CENTER=180;
const RADIUS=150;

const drum=new Audio("drum.mp3");

/* =========================
   å·¥å…·
========================= */
const TAU=Math.PI*2;
const easeOutQuint=t=>1-Math.pow(1-t,5);
const setStatus=t=>document.getElementById("status").textContent=t;

/* =========================
   ç•«è½‰ç›¤ï¼ˆå”¯ä¸€åŸºæº–ï¼‰
========================= */
function drawWheel(items, rotation){
  ctx.clearRect(0,0,360,360);
  if(!items.length) return;

  const arc=TAU/items.length;

  ctx.save();
  ctx.translate(CENTER,CENTER);
  ctx.rotate(rotation);
  ctx.translate(-CENTER,-CENTER);

  for(let i=0;i<items.length;i++){
    const start=i*arc - Math.PI/2 - arc/2;
    const end=start+arc;

    ctx.beginPath();
    ctx.moveTo(CENTER,CENTER);
    ctx.arc(CENTER,CENTER,RADIUS,start,end);
    ctx.closePath();
    ctx.fillStyle=i%2? "#fcdca0":"#fde7b5";
    ctx.fill();

    ctx.strokeStyle="#fff";
    ctx.lineWidth=2;
    ctx.stroke();

    ctx.save();
    ctx.translate(CENTER,CENTER);
    ctx.rotate(start+arc/2);
    ctx.textAlign="right";
    ctx.font="22px Noto Sans TC";
    ctx.fillStyle="#5b3a00";
    ctx.fillText(items[i],RADIUS-22,10);
    ctx.restore();
  }
  ctx.restore();
}

/* =========================
   æ ¸å¿ƒæ—‹è½‰ï¼ˆMVP v3ï¼‰
   èª°åœåœ¨æŒ‡é‡ä¸‹ï¼Œèª°ä¸­
========================= */
function spin(items,targetIndex,durationMs,clockwise=false){
  return new Promise(resolve=>{
    if(isSpinning) return;
    isSpinning=true;

    const arc=TAU/items.length;
    const pointerAngle=-Math.PI/2;
    const targetCenter=targetIndex*arc - Math.PI/2;

    const SPEED_BOOST=1.35;
    const baseSpins=4.8;
    const spins=baseSpins*SPEED_BOOST;
    const dir=clockwise?1:-1;

    const delta=(pointerAngle-targetCenter)+dir*(spins*TAU);
    const start=currentRotation;

    drum.currentTime=0;
    drum.play();

    const t0=performance.now();
    function frame(now){
      let t=(now-t0)/durationMs;
      if(t>1) t=1;
      const rot=start+delta*easeOutQuint(t);
      drawWheel(items,rot);

      if(t<1){
        requestAnimationFrame(frame);
      }else{
        currentRotation=start+delta;
        drawWheel(items,currentRotation);
        isSpinning=false;
        resolve();
      }
    }
    requestAnimationFrame(frame);
  });
}

/* =========================
   ç¬¬ä¸€è¼ª
========================= */
async function startRound1(){
  if(!locked||isSpinning) return;

  const remaining=nameList.filter(n=>!usedNames.includes(n));
  if(!remaining.length){
    setStatus(`ğŸ‰ æ­¤è¼ªè½‰ç›¤å·²å®Œæˆ ${usedNames.length} ä½çš„ç´…åŒ…æŠ½ç±¤
ğŸ“„ è«‹æŒ‰ã€ŒæŠ½ç±¤ç´€éŒ„ PDFã€ä¸‹è¼‰ç´€éŒ„ï¼Œæˆ–
ğŸ” è¼¸å…¥æ–°å§“å â†’ æŒ‰ã€Œé–å®šåå–®ã€é–‹å§‹ä¸‹ä¸€è¼ªï¼›ä¹Ÿå¯æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€`);
    document.getElementById("pdfBtn").classList.add("blinking");
    return;
  }

  const winner=remaining[Math.floor(Math.random()*remaining.length)];
  selectedName=winner;
  const idx=nameList.indexOf(winner);

  setStatus("ğŸ¡ ç¬¬ 1 è¼ªï¼šå§“åæŠ½ç±¤ä¸­â€¦");
  document.getElementById("startBtn").disabled=true;

  await spin(nameList,idx,5200,false);

  setStatus(`ğŸ¯ ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${winner}ã€`);
  usedNames.push(winner);
  logs.push({name:winner,verse:null});

  document.getElementById("secondBtn").style.display="inline-block";
  document.getElementById("secondBtn").classList.add("blinking");
}

/* =========================
   ç¬¬äºŒè¼ªï¼ˆç¶“å¥ï¼‰
========================= */
async function startRound2(){
  if(isSpinning||!selectedName) return;

  let v;
  do{
    v=Math.floor(Math.random()*128)+1;
  }while(usedVerses.includes(v));

  usedVerses.push(v);
  selectedVerse=v;

  setStatus("ğŸ ç¬¬ 2 è¼ªï¼šç¥ç¦ç¶“å¥æŠ½ç±¤ä¸­â€¦");
  document.getElementById("secondBtn").classList.remove("blinking");
  document.getElementById("secondBtn").style.display="none";

  await spin(nameList,nameList.indexOf(selectedName),5200,true);

  setStatus(`ğŸ¯ ç¬¬ 2 è¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ${String(v).padStart(3,"0")}ã€`);
  logs[logs.length-1].verse=v;

  document.getElementById("startBtn").disabled=false;
}

/* =========================
   PDFï¼ˆCanvasâ†’Imageï¼‰
========================= */
function exportPDF(){
  if(!logs.length){alert("å°šç„¡ç´€éŒ„");return;}
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();

  logs.forEach((l,i)=>{
    if(i>0) pdf.addPage();
    pdf.setTextColor(0,0,0);
    pdf.text(`${l.name}ï½œæŠ½ä¸­çš„ç¶“å¥ç´…åŒ…`,20,30);
    if(l.verse)
      pdf.text(`ç·¨è™Ÿ ${String(l.verse).padStart(3,"0")}`,20,50);
  });

  pdf.save("BlessingCards128.pdf");
  document.getElementById("pdfBtn").classList.remove("blinking");
}

/* =========================
   UI ç¶å®š
========================= */
document.getElementById("lockBtn").onclick=()=>{
  const raw=document.getElementById("nameInput").value.trim();
  if(!raw) return;
  const arr=raw.split(/\s+/);
  if(new Set(arr).size!==arr.length){
    alert("Oops, æœ‰å§“åè¢«é‡è¤‡è¼¸å…¥äº†å”·ï¼");
    return;
  }
  nameList=arr;
  usedNames=[];
  locked=true;
  drawWheel(nameList,0);
  setStatus(`ğŸ”’ æ–°ä¸€è¼ªåå–®å·²é–å®šï¼Œå…± ${nameList.length} ä½`);
};

document.getElementById("startBtn").onclick=startRound1;
document.getElementById("secondBtn").onclick=startRound2;
document.getElementById("pdfBtn").onclick=exportPDF;
document.getElementById("resetBtn").onclick=()=>location.reload();

/* åˆå§‹ */
drawWheel([],0);
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>