<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans TC",sans-serif;
  background:#fff7e0;
  text-align:center;
  padding:20px;
}
h1{ color:#a86a00; }

input{
  width:300px;
  padding:10px;
  font-size:18px;
  border-radius:8px;
  border:1px solid #c9a14a;
}

button{
  background:#f7c76c;
  border:none;
  padding:12px 20px;
  margin:6px;
  font-size:16px;
  border-radius:22px;
  cursor:pointer;
}
button:disabled{
  opacity:.4;
  cursor:not-allowed;
}

.blink{
  animation:blink 1s infinite;
}
@keyframes blink{
  0%{opacity:1}
  50%{opacity:.3}
  100%{opacity:1}
}

#wheelWrap{
  position:relative;
  width:360px;
  height:360px;
  margin:20px auto;
}
#pointer{
  position:absolute;
  top:-18px;
  left:50%;
  transform:translateX(-50%);
  font-size:40px;
  color:red;
  z-index:10;
}
canvas{ background:#fff; border-radius:50%; }

#centerText{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  font-size:18px;
  color:#7a4a00;
  pointer-events:none;
}

#status{
  margin-top:10px;
  font-size:16px;
  color:#8a5a00;
  line-height:1.6;
}
</style>
</head>

<body>

<h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h1>

<input id="nameInput" placeholder="è¼¸å…¥å§“åï¼Œç”¨ç©ºç™½æˆ–é€—è™Ÿåˆ†éš”"><br>

<button id="lockBtn">é–å®šåå–®</button>
<button id="startBtn">é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
<button id="secondBtn" style="display:none;">æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
<button id="pdfBtn">æŠ½ç±¤ç´€éŒ„ PDF</button>
<button id="resetBtn">å…¨éƒ¨æ­¸é›¶</button>

<div id="wheelWrap">
  <div id="pointer">â–¼</div>
  <canvas id="wheel" width="360" height="360"></canvas>
  <div id="centerText"></div>
</div>

<div id="status">è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* =========================
   å…¨åŸŸç‹€æ…‹
========================= */
const cvs = document.getElementById("wheel");
const ctx = cvs.getContext("2d");
const R = 180, CX = 180, CY = 180;

let nameList=[], usedNames=[];
let selectedName=null;
let logs = JSON.parse(localStorage.getItem("logs")||"[]");

let wheelAngle = 0;
let spinning = false;

const drum = new Audio("audio/drum.mp3");

/* =========================
   å·¥å…·
========================= */
function parseNames(raw){
  const arr = raw.split(/[\s,ã€]+/).filter(Boolean);
  const set = new Set(arr);
  if(set.size !== arr.length) return null;
  return arr;
}

function drawWheel(items){
  ctx.clearRect(0,0,360,360);
  const n = items.length;
  if(!n) return;
  const arc = Math.PI*2/n;
  for(let i=0;i<n;i++){
    const start = i*arc - Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(CX,CY);
    ctx.fillStyle = i%2 ? "#fde2a7" : "#fff0c8";
    ctx.arc(CX,CY,R,start,start+arc);
    ctx.fill();

    ctx.save();
    ctx.translate(CX,CY);
    ctx.rotate(start+arc/2);
    ctx.textAlign="right";
    ctx.fillStyle="#6a3f00";
    ctx.font="18px Noto Sans TC";
    ctx.fillText(items[i], R-12,6);
    ctx.restore();
  }
}

function renderAt(angle){
  ctx.save();
  ctx.clearRect(0,0,360,360);
  ctx.translate(CX,CY);
  ctx.rotate(angle);
  ctx.translate(-CX,-CY);
  drawWheel(nameList);
  ctx.restore();
}

/* =========================
   æ ¸å¿ƒæ—‹è½‰ï¼ˆv8.5.1ï¼‰
========================= */
function spinToIndex(index, duration){
  return new Promise(resolve=>{
    spinning=true;
    const n = nameList.length;
    const arc = Math.PI*2/n;
    const target = - (index*arc + arc/2);

    const spins = Math.PI*2* (6 + n*0.4); // å›ºå®šåœˆæ•¸
    const startAngle = wheelAngle;
    const finalAngle = startAngle + spins + target;

    const t0 = performance.now();
    drum.currentTime=0; drum.play().catch(()=>{});

    function anim(t){
      let p = (t-t0)/duration;
      if(p>1) p=1;

      // ease out
      let eased = p<0.85
        ? 1-Math.pow(1-p,3)
        : p; // å°¾æ®µç·šæ€§ clamp

      wheelAngle = startAngle + (finalAngle-startAngle)*eased;
      renderAt(wheelAngle);

      if(p<1){
        requestAnimationFrame(anim);
      }else{
        // æœ€å¾Œä¸€å¹€ï¼šå¼·åˆ¶é–ä¸­å¿ƒï¼ˆä¸å¯è¦‹ï¼‰
        wheelAngle = finalAngle;
        renderAt(wheelAngle);
        spinning=false;
        resolve();
      }
    }
    requestAnimationFrame(anim);
  });
}

/* =========================
   äº‹ä»¶
========================= */
lockBtn.onclick=()=>{
  const raw = nameInput.value.trim();
  const arr = parseNames(raw);
  if(!arr || arr.length<2){
    alert("Oops, æœ‰å§“åé‡è¤‡è¼¸å…¥äº†å”·ï¼");
    return;
  }
  nameList = arr;
  usedNames = [];
  localStorage.setItem("usedNames","[]");
  drawWheel(nameList);
  status.innerText=`åå–®å·²é–å®šï¼ˆ${arr.length} ä½ï¼‰`;
  startBtn.disabled=false;
};

startBtn.onclick=async()=>{
  if(spinning) return;
  const remain = nameList.filter(n=>!usedNames.includes(n));
  if(!remain.length) return;

  startBtn.disabled=true;
  selectedName = remain[Math.floor(Math.random()*remain.length)];
  const idx = nameList.indexOf(selectedName);

  await spinToIndex(idx, drum.duration*1000*1.3);

  usedNames.push(selectedName);
  localStorage.setItem("usedNames",JSON.stringify(usedNames));
  status.innerText=`ğŸ¯ ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${selectedName}ã€`;

  secondBtn.style.display="inline-block";
};

secondBtn.onclick=()=>{
  secondBtn.style.display="none";
  logs.push({name:selectedName,time:new Date().toLocaleString()});
  localStorage.setItem("logs",JSON.stringify(logs));

  if(usedNames.length===nameList.length){
    status.innerHTML =
`ğŸ‰ æ­¤è¼ªè½‰ç›¤å·²å®Œæˆ ${usedNames.length} ä½çš„ç´…åŒ…æŠ½ç±¤<br>
ğŸ“„ è«‹æŒ‰ã€ŒæŠ½ç±¤ç´€éŒ„ PDFã€ä¸‹è¼‰ç´€éŒ„ï¼Œæˆ–<br>
ğŸ” è¼¸å…¥æ–°å§“å â†’ æŒ‰ã€Œé–å®šåå–®ã€é–‹å§‹ä¸‹ä¸€è¼ªï¼›ä¹Ÿå¯æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€`;
    pdfBtn.classList.add("blink");
  }else{
    startBtn.disabled=false;
  }
};

pdfBtn.onclick=()=>{
  if(!logs.length){ alert("å°šç„¡ç´€éŒ„"); return; }
  pdfBtn.classList.remove("blink");
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  logs.forEach((l,i)=>doc.text(`${i+1}. ${l.time} ${l.name}`,10,20+i*10));
  doc.save("BlessingCards128.pdf");
};

resetBtn.onclick=()=>{
  localStorage.clear();
  location.reload();
};
</script>
</body>
</html>