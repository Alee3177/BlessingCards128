<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>BlessingCards128</title>
<style>
  body {
    font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
    background: #f6e8d3;
    text-align: center;
    margin: 0;
    padding: 20px;
  }
  h2 { margin-bottom: 10px; }
  input {
    width: 70%;
    padding: 8px;
    font-size: 16px;
  }
  button {
    padding: 8px 14px;
    margin: 6px;
    font-size: 15px;
  }
  canvas { margin-top: 20px; }
  #result { margin-top: 16px; font-size: 18px; }
</style>
</head>

<body>

<h2>ğŸ¯ BlessingCards128</h2>

<div>
  <input id="names" value="1 2 3">
</div>

<div>
  <button id="lockBtn">é–å®šåå–®</button>
  <button id="spinBtn" disabled>é–‹å§‹æ—‹è½‰</button>
</div>

<canvas id="cv" width="420" height="420"></canvas>

<div id="result">å°šæœªæŠ½ç±¤</div>

<audio id="drum" src="drum.mp3" preload="auto"></audio>

<script>
/* =========================================================
   BASE LOCKED : mvp_step3_with_input.html
   ç¬¬ä¸€è¼ªæ—‹è½‰æ ¸å¿ƒã€Œå®Œå…¨ä¿ç•™ã€
   ========================================================= */

const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
const drum = document.getElementById("drum");

let names = [];
let locked = false;

let angle = 0;
let spinning = false;
let speed = 0;
let targetAngle = 0;
let winnerIndex = -1;

const CENTER = cv.width / 2;
const R = 180;

/* ---------- å·¥å…· ---------- */
function normInput(str) {
  return str
    .replace(/ï¼Œ/g, ",")
    .replace(/\s+/g, ",")
    .split(",")
    .map(s => s.trim())
    .filter(Boolean);
}

function hasDuplicate(arr) {
  return new Set(arr).size !== arr.length;
}

/* ---------- ç¹ªåœ– ---------- */
function drawWheel(highlightIndex = null) {
  ctx.clearRect(0,0,cv.width,cv.height);
  const n = names.length;
  if (!n) return;

  const step = Math.PI * 2 / n;

  for (let i = 0; i < n; i++) {
    const start = angle + i * step;
    const end = start + step;

    ctx.beginPath();
    ctx.moveTo(CENTER, CENTER);
    ctx.arc(CENTER, CENTER, R, start, end);
    ctx.closePath();

    ctx.fillStyle =
      (i === highlightIndex) ? "#f5bc00" :
      (i % 2 ? "#fde2a7" : "#f9d99a");

    ctx.fill();
    ctx.strokeStyle = "#fff";
    ctx.stroke();

    // æ–‡å­—ï¼ˆæ‰‡å½¢ä¸­å¿ƒï¼‰
    ctx.save();
    ctx.translate(CENTER, CENTER);
    ctx.rotate(start + step / 2);
    ctx.textAlign = "right";
    ctx.fillStyle = "#333";
    ctx.font = "16px sans-serif";
    ctx.fillText(names[i], R - 12, 6);
    ctx.restore();
  }

  // æŒ‡é‡ï¼ˆå€’ä¸‰è§’ï¼Œå›ºå®šï¼‰
  ctx.fillStyle = "#c00";
  ctx.beginPath();
  ctx.moveTo(CENTER - 10, CENTER - R - 5);
  ctx.lineTo(CENTER + 10, CENTER - R - 5);
  ctx.lineTo(CENTER, CENTER - R - 25);
  ctx.closePath();
  ctx.fill();
}

/* ---------- ç¬¬ä¸€è¼ªæ—‹è½‰ï¼ˆé–æ­»æ ¸å¿ƒï¼‰ ---------- */
function spinOnce(onDone) {
  spinning = true;
  speed = 0.35;
  const spins = 5 + Math.random() * 2;

  winnerIndex = Math.floor(Math.random() * names.length);
  const step = Math.PI * 2 / names.length;
  targetAngle = Math.PI * 1.5 - (winnerIndex + 0.5) * step + spins * Math.PI * 2;

  try {
    drum.currentTime = 0;
    drum.play().catch(()=>{});
  } catch(e){}

  function tick() {
    if (!spinning) return;
    angle += speed;
    speed *= 0.985;

    if (angle >= targetAngle) {
      angle = targetAngle;
      spinning = false;

      // ç­‰éŸ³æ•ˆæ’­å®Œå†é«˜äº®
      const wait = drum.duration ? (drum.duration - drum.currentTime) * 1000 : 0;
      setTimeout(() => onDone(winnerIndex), Math.max(wait, 0));
      drawWheel(winnerIndex);
      return;
    }

    drawWheel();
    requestAnimationFrame(tick);
  }
  tick();
}

/* ---------- UI ---------- */
document.getElementById("lockBtn").onclick = () => {
  const arr = normInput(document.getElementById("names").value);
  if (arr.length < 2) {
    alert("è‡³å°‘éœ€è¦å…©å€‹é …ç›®");
    return;
  }
  if (hasDuplicate(arr)) {
    alert("Oops, æœ‰å§“åé‡è¤‡è¼¸å…¥äº†å”·");
    return;
  }
  names = arr;
  locked = true;
  document.getElementById("spinBtn").disabled = false;
  drawWheel();
};

document.getElementById("spinBtn").onclick = () => {
  if (!locked || spinning) return;
  document.getElementById("result").textContent = "æ—‹è½‰ä¸­â€¦";

  spinOnce(idx => {
    document.getElementById("result").textContent =
      `ğŸ¯ æŠ½ä¸­ï¼š${names[idx]}`;
  });
};

/* åˆå§‹ */
drawWheel();
</script>

</body>
</html>