<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆBlessingCards128ï¼‰</title>

<link rel="icon" href="logo3524.png">

<style>
body {
    font-family: "Noto Sans TC", sans-serif;
    text-align: center;
    background: #fffdf7;
    margin: 0;
    padding: 0;
}

.logo {
    width: 180px;
    margin-top: 20px;
}

.title {
    font-size: 28px;
    margin-top: 10px;
    margin-bottom: 20px;
    font-weight: bold;
    color: #5a4635;
}

input {
    width: 320px;
    padding: 10px;
    font-size: 18px;
    margin-bottom: 10px;
    border-radius: 8px;
    border: 1px solid #aaa;
}

button {
    width: 240px;
    padding: 14px;
    font-size: 20px;
    border: none;
    border-radius: 10px;
    margin: 10px;
    cursor: pointer;
    background: linear-gradient(135deg, #fceabb, #f8b500);
    font-weight: bold;
    color: #5a4635;
    transition: 0.25s;
}

button:hover {
    transform: scale(1.05);
    background: linear-gradient(135deg, #ffd57e, #f2a600);
}

#canvasBox {
    margin-top: 30px;
}

#resultName {
    margin-top: 20px;
    font-size: 28px;
    font-weight: bold;
    color: #5a4635;
}
</style>
</head>

<body>

<img src="logo3524.png" class="logo" alt="BlessingCards128 logo">

<div class="title">ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆBlessingCards128ï¼‰</div>

<input id="nameInput" placeholder="è¼¸å…¥æ‰€æœ‰å§“åï¼Œä½¿ç”¨ã€Œ,ã€åˆ†éš”">

<br>
<button onclick="lockNames()">ğŸ”’ é–å®šåå–®</button>
<button onclick="resetAll()">ğŸ”„ å…¨éƒ¨æ­¸é›¶</button>
<br>
<button onclick="startDrawName()">ğŸ¡ é–‹å§‹æŠ½å§“å</button>
<button onclick="goCategory()">ğŸ“š åˆ†é¡æŠ½ç±¤</button>
<br>
<button onclick="exportPDF()">ğŸ“„ æŠ½ç±¤ç´€éŒ„ PDF</button>

<div id="nameListDisplay" style="margin-top:10px; font-size:18px; color:#5a4635;"></div>

<div id="canvasBox">
    <canvas id="wheelCanvas" width="360" height="360"></canvas>
</div>

<div id="resultName"></div>

<!-- ç¶“å¥æ›¸å·ç« ç¯€ -->
<script src="verseRefMap.js"></script>

<!-- jsPDF ä¸»ç¨‹å¼ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// ================== å…¨åŸŸç‹€æ…‹ ==================
let fixedNameList = JSON.parse(localStorage.getItem("fixedNameList") || "[]");
let usedNamesAll  = JSON.parse(localStorage.getItem("usedNamesAll")  || "[]");
let drawLogs      = JSON.parse(localStorage.getItem("drawLogs")      || "[]");

const wheelCanvas = document.getElementById("wheelCanvas");
const ctx         = wheelCanvas.getContext("2d");

updateNameListDisplay();
drawWheelPlaceholder();

// =============== åå–®é–å®š ===============
function lockNames() {
    if (fixedNameList.length > 0) {
        alert("åå–®å·²é–å®šï¼Œè‹¥éœ€ä¿®æ”¹è«‹æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€ã€‚");
        return;
    }

    const raw = document.getElementById("nameInput").value.trim();
    if (!raw) {
        alert("è«‹è¼¸å…¥å§“åï¼ˆä½¿ç”¨ã€Œ,ã€éš”é–‹ï¼‰");
        return;
    }

    const list = raw
        .split(",")
        .map(n => n.trim())
        .filter(n => n);

    if (list.length === 0) {
        alert("åå–®å…§å®¹ç„¡æ•ˆï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚");
        return;
    }

    fixedNameList = list;
    localStorage.setItem("fixedNameList", JSON.stringify(fixedNameList));
    alert("åå–®å·²é–å®šï¼");
    updateNameListDisplay();
}

// =============== åå–®é¡¯ç¤º ===============
function updateNameListDisplay() {
    const el = document.getElementById("nameListDisplay");
    if (!fixedNameList.length) {
        el.textContent = "å°šæœªé–å®šåå–®";
    } else {
        el.textContent = "åå–®ï¼š" + fixedNameList.join("ï¼Œ");
        // ä¹ŸåŒæ­¥æŠŠ input å¡«å›ï¼ˆæ–¹ä¾¿æª¢æŸ¥ï¼‰
        document.getElementById("nameInput").value = fixedNameList.join(", ");
    }
}

// =============== å…¨éƒ¨æ­¸é›¶ ===============
function resetAll() {
    if (!confirm("ç¢ºå®šè¦å…¨éƒ¨æ­¸é›¶å—ï¼Ÿ")) return;

    localStorage.removeItem("fixedNameList");
    localStorage.removeItem("usedNamesAll");
    localStorage.removeItem("drawLogs");
    // è‹¥å…¶ä»–é é¢æœ‰ä½¿ç”¨ç¶“å¥ä½¿ç”¨ç´€éŒ„ï¼Œå¯åœ¨é‚£é‚Šä¾ drawLogs é‡æ–°è¨ˆç®—

    fixedNameList = [];
    usedNamesAll  = [];
    drawLogs      = [];

    alert("å·²å…¨éƒ¨é‡ç½®ï¼");
    location.reload();
}

// =============== å‰å¾€åˆ†é¡æŠ½ç±¤ï¼ˆä¸å†é–æ¨¡å¼ï¼‰ ===============
function goCategory() {
    window.location.href = "index_category.html";
}

// =============== å§“åè¼ªç›¤é‚è¼¯ ===============
function startDrawName() {
    if (!fixedNameList.length) {
        alert("è«‹å…ˆé–å®šåå–®ï¼");
        return;
    }

    const remaining = fixedNameList.filter(n => !usedNamesAll.includes(n));
    if (!remaining.length) {
        alert("æ‰€æœ‰å§“åçš†å·²å®Œæˆè¼ªç›¤æŠ½ç±¤ï¼è«‹æŒ‰ä¸‹ã€Œå…¨éƒ¨æ­¸é›¶ã€ä»¥é‡æ–°é–‹å§‹ã€‚");
        return;
    }

    spinNameWheel(remaining);
}

function drawWheelPlaceholder() {
    ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
    ctx.beginPath();
    ctx.arc(180, 180, 160, 0, 2 * Math.PI);
    ctx.fillStyle = "#fff6d6";
    ctx.fill();
    ctx.fillStyle = "#5a4635";
    ctx.font = "20px Noto Sans TC";
    ctx.textAlign = "center";
    ctx.fillText("è«‹å…ˆé–å®šåå–®å†æŠ½ç±¤", 180, 185);

    // æŒ‡é‡
    ctx.beginPath();
    ctx.moveTo(180, 40);
    ctx.lineTo(168, 70);
    ctx.lineTo(192, 70);
    ctx.closePath();
    ctx.fillStyle = "#d66b00";
    ctx.fill();
}

function drawWheel(names, highlightIndex = -1) {
    const total  = names.length;
    const center = 180;
    const radius = 160;
    const arc    = (2 * Math.PI) / total;

    ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);

    for (let i = 0; i < total; i++) {
        ctx.beginPath();
        ctx.moveTo(center, center);

        ctx.fillStyle = (i === highlightIndex) ? "#ffe8a3" : "#fff6d6";

        ctx.arc(center, center, radius, i * arc, (i + 1) * arc);
        ctx.closePath();
        ctx.fill();

        ctx.save();
        ctx.translate(center, center);
        ctx.rotate(i * arc + arc / 2);
        ctx.textAlign = "right";
        ctx.font = "18px Noto Sans TC";
        ctx.fillStyle = "#5a4635";
        ctx.fillText(names[i], radius - 10, 6);
        ctx.restore();
    }

    // æŒ‡é‡ï¼ˆå‘ä¸‹ï¼‰
    ctx.beginPath();
    ctx.moveTo(center, 40);
    ctx.lineTo(center - 12, 70);
    ctx.lineTo(center + 12, 70);
    ctx.closePath();
    ctx.fillStyle = "#d66b00";
    ctx.fill();
}

function spinNameWheel(availableNames) {
    const total = availableNames.length;
    drawWheel(availableNames);

    const spinDuration = 2500;
    const start = performance.now();

    const drum = new Audio("audio/drum.mp3");
    drum.currentTime = 0;
    drum.play().catch(() => {});

    function animate(now) {
        const elapsed   = now - start;
        const progress  = Math.min(elapsed / spinDuration, 1);
        const eased     = progress * progress; // ç°¡å–® easing
        const index     = Math.floor(eased * total) % total;

        drawWheel(availableNames, index);

        if (progress < 1) {
            requestAnimationFrame(animate);
        } else {
            const finalName = availableNames[index];

            // åŠ å…¥å·²æŠ½åå–®
            if (!usedNamesAll.includes(finalName)) {
                usedNamesAll.push(finalName);
                localStorage.setItem("usedNamesAll", JSON.stringify(usedNamesAll));
            }

            document.getElementById("resultName").innerText =
                "æŠ½ä¸­ï¼šã€Œ" + finalName + "ã€";

            setTimeout(() => {
                // äº¤çµ¦ viewer.html å»è™•ç†æŠ½ç¶“å¥èˆ‡ç´€éŒ„
                window.location.href =
                    "viewer.html?name=" + encodeURIComponent(finalName);
            }, 800);
        }
    }

    requestAnimationFrame(animate);
}

// ================== PDFï¼šå¤–éƒ¨å­—å‹è¼‰å…¥ ==================

// Uint8Array â†’ Base64
function uint8ToBase64(uint8) {
    let binary = "";
    for (let i = 0; i < uint8.byteLength; i++) {
        binary += String.fromCharCode(uint8[i]);
    }
    return window.btoa(binary);
}

// åŒ¯å‡º PDFï¼ˆç”¨ drawLogs + VERSE_REF_MAPï¼‰
async function exportPDF() {
    const { jsPDF } = window.jspdf;

    if (!drawLogs || drawLogs.length === 0) {
        alert("ç›®å‰æ²’æœ‰æŠ½ç±¤ç´€éŒ„ï¼");
        return;
    }

    const doc = new jsPDF({
        unit: "pt",
        format: "a4",
    });

    const fontUrl = "fonts/NotoSansTC-Regular.ttf";

    try {
        const fontBuffer = await fetch(fontUrl).then(res => res.arrayBuffer());
        const fontUint8  = new Uint8Array(fontBuffer);
        const fontBase64 = uint8ToBase64(fontUint8);

        doc.addFileToVFS("NotoSansTC-Regular.ttf", fontBase64);
        doc.addFont("NotoSansTC-Regular.ttf", "NotoSansTC", "normal");
        doc.setFont("NotoSansTC", "normal");
    } catch (e) {
        console.error("å­—å‹è¼‰å…¥å¤±æ•—ï¼š", e);
        alert("PDF å­—å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª fonts/NotoSansTC-Regular.ttf æ˜¯å¦å­˜åœ¨ã€‚");
        return;
    }

    // æ¨™é¡Œ
    let y = 40;
    doc.setFontSize(18);
    doc.text("BlessingCards128 æŠ½ç±¤ç´€éŒ„", 40, y);

    y += 30;
    doc.setFontSize(12);

    drawLogs.forEach(log => {
        const ref = (window.VERSE_REF_MAP && window.VERSE_REF_MAP[log.verseNo]) || "";
        const line =
            `[${log.time}] ${log.name}` +
            (log.category ? `ï½œåˆ†é¡ï¼š${log.category}` : "") +
            `ï½œç¶“å¥ï¼š${log.verseNo}${ref ? `ï¼ˆ${ref}ï¼‰` : ""}`;

        if (y > 800) {
            doc.addPage();
            y = 40;
        }
        doc.text(line, 40, y);
        y += 20;
    });

    doc.save("æŠ½ç±¤ç´€éŒ„.pdf");
}
</script>

</body>
</html>
