<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  background:#fff8e7;
  font-family:"Noto Sans TC",sans-serif;
  text-align:center;
  padding:22px;
  color:#5b3a00;
}
h1{color:#b07500;font-size:26px;margin-bottom:10px;}
.logo{width:120px;margin-bottom:14px;}

#nameInput{
  width:280px;padding:10px;font-size:18px;
  border-radius:8px;border:1px solid #bf8a3e;margin-bottom:12px;
}

.btn{
  background:#f7c76c;border:none;padding:12px 22px;
  border-radius:25px;font-size:18px;color:#5b3a00;
  cursor:pointer;margin:6px;
}
.btn:hover{background:#f3b84f;}
.btn:disabled{opacity:.45;cursor:not-allowed;}

@keyframes blink{0%{opacity:1}50%{opacity:.3}100%{opacity:1}}
.blinking{animation:blink 1s infinite;}

#wheelContainer{position:relative;width:380px;height:380px;margin:22px auto;}
#wheelCanvas{width:380px;height:380px;}
#wheelPointer{
  position:absolute;top:-26px;left:50%;
  transform:translateX(-50%);
  font-size:44px;color:red;z-index:20;
}

#statusText{font-size:20px;margin-top:8px;color:#a56b00;white-space:pre-line}
</style>
</head>

<body>

<h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h1>
<img src="logo3524.png" class="logo">

<input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼ˆç©ºç™½æˆ–ã€åˆ†éš”ï¼‰"><br>

<button class="btn" id="lockBtn">é–å®šåå–®</button>
<button class="btn" id="startBtn">é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
<button class="btn" id="resetBtn">å…¨éƒ¨æ­¸é›¶</button>
<button class="btn" id="pdfBtn">æŠ½ç±¤ç´€éŒ„ PDF</button>

<button class="btn" id="secondBtn" style="display:none;">æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
<button class="btn" id="viewerBtn" style="display:none;">çœ‹ç´…åŒ…å…§å®¹</button>

<div id="wheelContainer">
  <div id="wheelPointer">â–¼</div>
  <canvas id="wheelCanvas" width="380" height="380"></canvas>
</div>

<div id="statusText">è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®</div>

<script src="verseRefMap.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ================== åŸºæœ¬ç‹€æ…‹ ================== */
const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");
const CENTER=190,RADIUS=180;

let nameList=[],usedNames=[],usedVerses=[];
let selectedName=null,selectedVerse=null;
let locked=false,roundFinished=false,animating=false;

const statusText=document.getElementById("statusText");
const startBtn=document.getElementById("startBtn");
const secondBtn=document.getElementById("secondBtn");
const viewerBtn=document.getElementById("viewerBtn");
const pdfBtn=document.getElementById("pdfBtn");

/* ================== éŸ³æ•ˆ ================== */
const drumAudio=new Audio("audio/drum.mp3");

/* ================== å·¥å…· ================== */
function parseNames(raw){
  return raw.split(/[\sã€,]+/).filter(Boolean);
}
function hasDuplicate(arr){
  return new Set(arr).size!==arr.length;
}

/* ================== ç•«è¼ªç›¤ ================== */
function drawWheel(items){
  ctx.clearRect(0,0,380,380);
  const arc=2*Math.PI/items.length;
  items.forEach((name,i)=>{
    const start=i*arc-Math.PI/2;
    const end=start+arc;
    ctx.beginPath();
    ctx.fillStyle=i%2?"#fcdca0":"#fde7b5";
    ctx.moveTo(CENTER,CENTER);
    ctx.arc(CENTER,CENTER,RADIUS,start,end);
    ctx.closePath();ctx.fill();

    ctx.strokeStyle="#fff";ctx.lineWidth=2;ctx.stroke();

    ctx.save();
    ctx.translate(CENTER,CENTER);
    ctx.rotate(start+arc/2);
    ctx.textAlign="right";
    ctx.font="22px Noto Sans TC";
    ctx.fillStyle="#5b3a00";
    ctx.fillText(name,RADIUS-22,10);
    ctx.restore();
  });
}

/* ================== æ—‹è½‰æ ¸å¿ƒï¼ˆv8.4.2ï¼‰ ================== */
function spinToIndex(items,targetIndex,clockwise){
  return new Promise(async resolve=>{
    animating=true;
    drumAudio.currentTime=0;
    await drumAudio.play().catch(()=>{});

    const arc=2*Math.PI/items.length;
    const targetAngle=targetIndex*arc+arc/2;
    const pointerAngle=Math.PI/2;
    const spins=5;
    const dir=clockwise?1:-1;

    const finalAngle=pointerAngle-targetAngle+dir*spins*2*Math.PI;

    // ğŸ”‘ èˆ‡éŸ³æ•ˆåŒæ­¥ï¼Œä¸¦åŠ å¿«ç´„ 30%
    const baseDuration=drumAudio.duration*1000||5200;
    const duration=baseDuration*0.77;

    const start=performance.now();
    function animate(t){
      let p=(t-start)/duration;if(p>1)p=1;
      const ease=1-Math.pow(1-p,3);
      const angle=finalAngle*ease;

      ctx.save();
      ctx.clearRect(0,0,380,380);
      ctx.translate(CENTER,CENTER);
      ctx.rotate(angle);
      ctx.translate(-CENTER,-CENTER);
      drawWheel(items);
      ctx.restore();

      if(p<1) requestAnimationFrame(animate);
      else{
        animating=false;
        resolve();
      }
    }
    requestAnimationFrame(animate);
  });
}

/* ================== é–å®šåå–® ================== */
lockBtn.onclick=()=>{
  const raw=nameInput.value.trim();
  if(!raw)return alert("è«‹è¼¸å…¥å§“åï¼");
  const arr=parseNames(raw);
  if(arr.length<2)return alert("è‡³å°‘éœ€è¦å…©ä½ï¼");
  if(hasDuplicate(arr))return alert("Oops, æœ‰å§“åé‡è¤‡è¼¸å…¥äº†å”·ï¼");
  nameList=[...arr];
  usedNames=[];usedVerses=[];
  locked=true;roundFinished=false;
  localStorage.clear();
  drawWheel(nameList);
  statusText.textContent=`åå–®å·²é–å®šï¼Œå…± ${nameList.length} ä½`;
  startBtn.disabled=false;
};

/* ================== ç¬¬ä¸€è¼ª ================== */
startBtn.onclick=async()=>{
  if(!locked||animating||roundFinished)return;
  const remain=nameList.filter(n=>!usedNames.includes(n));
  if(!remain.length)return;
  selectedName=remain[Math.floor(Math.random()*remain.length)];
  const idx=nameList.indexOf(selectedName);
  statusText.textContent="ç¬¬ 1 è¼ªï¼šå§“åè¼ªç›¤æŠ½ç±¤ä¸­â€¦";
  startBtn.disabled=true;
  await spinToIndex(nameList,idx,false);
  usedNames.push(selectedName);
  statusText.textContent=`ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${selectedName}ã€`;
  secondBtn.style.display="inline-block";
  secondBtn.classList.add("blinking");
};

/* ================== ç¬¬äºŒè¼ª ================== */
secondBtn.onclick=async()=>{
  if(animating)return;
  secondBtn.classList.remove("blinking");
  secondBtn.style.display="none";
  const verses=Object.keys(VERSE_REF_MAP).filter(v=>!usedVerses.includes(v));
  selectedVerse=verses[Math.floor(Math.random()*verses.length)];
  usedVerses.push(selectedVerse);

  const idx=nameList.indexOf(selectedName);
  statusText.textContent="ç¬¬ 2 è¼ªï¼šç¥ç¦ç¶“å¥è¼ªç›¤æŠ½ç±¤ä¸­â€¦";
  await spinToIndex(nameList,idx,true);

  statusText.textContent=`ç¬¬ 2 è¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ${selectedVerse}ã€`;
  viewerBtn.style.display="inline-block";
};

/* ================== Viewer ================== */
viewerBtn.onclick=()=>{
  location.href=`viewer.html?name=${encodeURIComponent(selectedName)}&verse=${selectedVerse}`;
};

/* ================== PDFï¼ˆCanvas â†’ Imageï¼‰ ================== */
pdfBtn.onclick=async()=>{
  const logs=JSON.parse(localStorage.getItem("logs")||"[]");
  if(!logs.length)return alert("å°šç„¡ç´€éŒ„");
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  let y=40;
  for(const l of logs){
    pdf.text(l,20,y);y+=20;
  }
  pdf.save("BlessingCards128.pdf");
};

/* ================== Reset ================== */
resetBtn.onclick=()=>{
  if(confirm("ç¢ºå®šå…¨éƒ¨æ­¸é›¶ï¼Ÿ")){
    localStorage.clear();location.reload();
  }
};
</script>
</body>
</html>
