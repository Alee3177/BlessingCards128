<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰- å–®æ©Ÿç©©å®šAç‰ˆ</title>

<link rel="preload" as="image" href="logo3524.png">

<style>
  :root{
    --bg:#fbf2df;
    --text:#5b3a00;
    --btn:#f4b63a;
    --btnShadow:#d59b25;
    --btnDisabled:#f0ddaa;
    --danger:#E53935;
    --dangerShadow:#B71C1C;
    --blue:#1976D2;
    --blueShadow:#0d47a1;
  }
  body{
    font-family:"Noto Sans TC",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
    background:var(--bg);
    text-align:center;
    margin:0;
    padding:16px;
    color:var(--text);
  }
  .logo{width:220px;margin:10px auto 0;display:block;}
  h2{margin:12px 0 6px 0;}

  #masterStatus{
    display:flex;align-items:center;justify-content:center;gap:8px;
    margin:8px auto 4px auto;font-size:14px;font-weight:800;
  }
  #masterStatus .dot{width:12px;height:12px;border-radius:50%;background:#999;box-shadow:0 0 4px rgba(0,0,0,.25);}
  #masterStatus.ok .dot{background:#2e7d32;box-shadow:0 0 8px rgba(46,125,50,.7);}
  #masterStatus.warn .dot{background:#f9a825;box-shadow:0 0 8px rgba(249,168,37,.7);}
  #masterStatus.error .dot{background:#c62828;box-shadow:0 0 8px rgba(198,40,40,.7);}

  #nameInput{
    width:90%;max-width:520px;padding:10px 14px;
    margin-top:10px;border-radius:12px;border:2px solid #e3c78c;
    font-size:18px;text-align:center;box-sizing:border-box;
    background:#fffdf8;
  }

  .btn-row{margin-top:8px;display:flex;justify-content:center;gap:10px;flex-wrap:wrap;}
  .btn{
    min-width:130px;
    padding:10px 16px;
    border-radius:999px;
    border:none;
    background:var(--btn);
    color:var(--text);
    font-size:15px;
    font-weight:800;
    box-shadow:0 3px 0 var(--btnShadow);
    cursor:pointer;
  }
  .btn:disabled{background:var(--btnDisabled);box-shadow:none;cursor:default;}
  .btn-pdf-ready{background:var(--blue)!important;color:#fff!important;box-shadow:0 3px 0 var(--blueShadow)!important;}
  .btn-reset-danger{background:var(--danger)!important;color:#fff!important;box-shadow:0 3px 0 var(--dangerShadow)!important;}

  @keyframes mainBlink{
    0%{opacity:1;transform:scale(1);}
    50%{opacity:.55;transform:scale(1.05);}
    100%{opacity:1;transform:scale(1);}
  }
  .blink-all{animation:mainBlink 1s infinite;}

  #wheel-container{position:relative;width:360px;height:360px;margin:14px auto 10px;}
  #wheel{width:360px;height:360px;border-radius:50%;background:#fff;box-shadow:0 10px 25px rgba(0,0,0,.12);}
  #confettiCanvas{position:absolute;left:0;top:0;width:360px;height:360px;pointer-events:none;}
  #centerText{
    position:absolute;left:0;top:0;width:360px;height:360px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    pointer-events:none;font-size:18px;font-weight:900;white-space:pre-line;
    padding:26px;box-sizing:border-box;
    text-shadow:0 1px 0 rgba(255,255,255,.55);
  }
  /* pointer */
  #pointer{
    position:absolute;left:50%;top:-6px;transform:translateX(-50%);
    width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:22px solid #b00020;
    filter:drop-shadow(0 2px 2px rgba(0,0,0,.25));
    z-index:5;
  }
  #status{margin-top:8px;font-weight:800;white-space:pre-line;}
  #result{margin-top:8px;white-space:pre-line;font-weight:900;}
  #summaryBox{margin-top:10px;white-space:pre-line;font-weight:800;}

  /* Red envelope panel */
  #redEnvelopePanel{
    display:none;
    margin:18px auto 0;
    max-width:560px;
    padding:12px;
    border:2px solid #f6c453;
    border-radius:12px;
    background:#1a1a1a;
    color:#ffd54f;
    text-align:center;
  }
  #redEnvelopePanel img{
    max-width:100%;
    border-radius:10px;
    background:#fff;
    padding:6px;
  }
</style>

<!-- ç¶“å¥å°ç…§ï¼ˆè‹¥ä¸å­˜åœ¨ä¹Ÿä¸æœƒæ­»ï¼‰ -->
<script src="verseRefMap.js?v=20260105"></script>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
<img src="logo3524.png" class="logo" loading="eager" decoding="async"
     onerror="this.style.display='none'; console.warn('âš  logo3524.png è¼‰å…¥å¤±æ•—');"/>
<h2>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h2>

<div id="masterStatus" class="ok"><span class="dot"></span><span class="label">å–®æ©Ÿç‰ˆå·²å°±ç·’</span></div>

<input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼Œå¯ç”¨ç©ºç™½ / é€—è™Ÿ / æ›è¡Œåˆ†éš”">

<div class="btn-row">
  <button id="lockBtn" class="btn">é–å®šåå–®</button>
  <button id="spinBtn" class="btn" disabled>é–‹å§‹æŠ½å§“åï¼ˆç¬¬ä¸€è¼ªï¼‰</button>
</div>

<div class="btn-row">
  <button id="viewBtn" class="btn" disabled>çœ‹ç´…åŒ…</button>
  <button id="secondBtn" class="btn" disabled>æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
</div>

<div class="btn-row">
  <button id="resetBtn" class="btn">å…¨éƒ¨æ­¸é›¶</button>
  <button id="pdfBtn" class="btn" disabled>æŠ½ç±¤ç´€éŒ„ PDF</button>
</div>

<div id="wheel-container">
  <div id="pointer"></div>
  <canvas id="wheel" width="360" height="360"></canvas>
  <canvas id="confettiCanvas" width="360" height="360"></canvas>
  <div id="centerText"></div>
</div>

<div id="status">è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®</div>
<div id="result"></div>
<div id="summaryBox"></div>

<!-- Red Envelope Panel -->
<div id="redEnvelopePanel">
  <div style="font-weight:900;margin-bottom:6px;">ğŸ æŠ½ä¸­ç´…åŒ…ç¶“å¥ <span id="envelopeVerse"></span></div>
  <div style="font-size:14px;opacity:.9;margin-bottom:8px;" id="envelopeRef"></div>
  <img id="envelopeImg" alt="red envelope"/>
  <div style="margin-top:10px;">
    <button id="downloadEnvelopeBtn" class="btn">ğŸ“¥ ä¸‹è¼‰ç´…åŒ…åœ–ç‰‡</button>
    <button id="nextPersonBtn" class="btn">â¡ ä¸‹ä¸€ä½</button>
  </div>
</div>

<audio id="drum" preload="auto" playsinline src="audio/drum.mp3"></audio>
<audio id="winSound" preload="auto" playsinline src="audio/win.mp3"></audio>

<script>
/* =========================
   å–®æ©Ÿç©©å®šAç‰ˆï¼ˆç„¡ QR / ç„¡ Viewer / ç„¡ ä¸»æŒæ©Ÿé–å®šï¼‰
   - ç¬¬ä¸€è¼ªï¼šæŠ½å§“å
   - ç¬¬äºŒè¼ªï¼šæŠ½ç¶“å¥ï¼ˆ001-128ï¼‰
   - çœ‹ç´…åŒ…ï¼šé¡¯ç¤º cards/###.pngï¼Œæ’­æ”¾ win.mp3
   - PDFï¼šä»¥ Canvas è½‰åœ–ç‰‡åµŒå…¥ PDFï¼ˆé¿å…ä¸­æ–‡å­—äº‚ç¢¼ï¼‰
========================= */

const HISTORY_KEY = "BLESSING_HISTORY_A_V1";

/** å–å¾—ç¶“å¥å¼•ç”¨æ–‡å­—ï¼ˆä¾ä½ ç¾æœ‰ verseRefMap.jsï¼‰ */
function getVerseRef(no){
  try{
    // å¸¸è¦‹å‘½åï¼šverseRefMap["014"] = "..."
    if (typeof verseRefMap === "object" && verseRefMap){
      return verseRefMap[no] || "";
    }
  }catch{}
  return "";
}

/** ç”¢ç”Ÿ 001..128 */
function genVerses(){
  const a=[];
  for(let i=1;i<=128;i++) a.push(String(i).padStart(3,"0"));
  return a;
}

/** å°å·¥å…· */
const $ = (id)=>document.getElementById(id);
function setStatus(mode, text){
  const bar = $("masterStatus");
  bar.className = mode;
  bar.querySelector(".label").textContent = text;
}
function safeAlert(msg){
  try{ alert(msg); }catch{ console.log(msg); }
}

/** Audio unlock: è‡ªå‹•æ’­è¢«æ‰‹æ©Ÿæ“‹æ™‚ï¼Œè‡³å°‘é»ä¸€ä¸‹å°±èƒ½æ’­ */
let audioUnlocked = false;
function unlockAudioOnce(){
  if (audioUnlocked) return;
  audioUnlocked = true;
  const a = $("winSound");
  const b = $("drum");
  [a,b].forEach(x=>{
    if(!x) return;
    try{
      x.muted = true;
      const p = x.play();
      if (p && typeof p.then === "function"){
        p.then(()=>{ x.pause(); x.currentTime = 0; x.muted=false; }).catch(()=>{ x.muted=false; });
      }else{
        x.pause(); x.currentTime=0; x.muted=false;
      }
    }catch{}
  });
}

/** App state */
const SYS = {
  READY:"READY",
  LOCKED:"LOCKED",
  R1_DONE:"R1_DONE",
  R2_DONE:"R2_DONE",
};
let sysState = SYS.READY;

let names = [];
let remainingNames = [];
let remainingVerses = genVerses();
let currentName = null;
let currentVerse = null;

let history = []; // {name, verse, ref, ts}

/** wheel drawing */
const wheel = $("wheel");
const ctx = wheel.getContext("2d");
let rotation = 0; // radians
let wheelItems = []; // current segments labels
let wheelMode = "names"; // "names" | "verses"
let rotating = false;
let selectedIndex = null;

function drawWheel(){
  const w = wheel.width, h = wheel.height;
  const r = Math.min(w,h)/2;
  ctx.clearRect(0,0,w,h);

  // base circle
  ctx.save();
  ctx.translate(w/2,h/2);
  ctx.rotate(rotation);

  const n = Math.max(1, wheelItems.length);
  const step = (Math.PI*2)/n;

  for(let i=0;i<n;i++){
    const start = i*step;
    const end = start+step;

    // alternating colors (do not hardcode fancy palette)
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,r-2,start,end);
    ctx.closePath();
    ctx.fillStyle = (i%2===0) ? "#ffe9b8" : "#fff6dc";
    ctx.fill();
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(91,58,0,.18)";
    ctx.stroke();

    // label
    ctx.save();
    ctx.rotate(start + step/2);
    ctx.textAlign = "right";
    ctx.fillStyle = "#5b3a00";
    ctx.font = (wheelMode==="names") ? "bold 14px 'Noto Sans TC', system-ui" : "bold 13px system-ui";
    const label = wheelItems[i] ?? "";
    ctx.fillText(label, r-14, 5);
    ctx.restore();
  }

  ctx.restore();

  // highlight selected segment at stop (draw overlay at absolute rotation=0)
  if (selectedIndex != null && !rotating){
    drawHighlight(selectedIndex);
  }
}

function drawHighlight(index){
  const w = wheel.width, h = wheel.height;
  const r = Math.min(w,h)/2;
  const n = Math.max(1, wheelItems.length);
  const step = (Math.PI*2)/n;

  // pointer is at top (angle -90Â° in canvas coordinates)
  // convert pointer angle to wheel segment index:
  // pointerAngleWorld = -Math.PI/2
  // segmentIndex = floor( (normalize(pointerAngleWorld - rotation) / step) )
  // But we already computed index; draw overlay wedge for visual.
  ctx.save();
  ctx.translate(w/2,h/2);

  // compute wedge start/end in world coordinates
  const start = index*step + rotation;
  const end = start + step;

  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.arc(0,0,r-2,start,end);
  ctx.closePath();
  ctx.fillStyle = "rgba(255,193,7,.35)";
  ctx.fill();
  ctx.restore();
}

/** Determine which index is under pointer (top) */
function getIndexUnderPointer(){
  const n = Math.max(1, wheelItems.length);
  const step = (Math.PI*2)/n;
  const pointer = -Math.PI/2;

  // angle relative to wheel rotation
  let a = pointer - rotation;
  a = ((a % (Math.PI*2)) + (Math.PI*2)) % (Math.PI*2);
  const idx = Math.floor(a / step);
  return Math.max(0, Math.min(n-1, idx));
}

/** Spin animation */
function spinOnce(onDone){
  if (rotating) return;
  rotating = true;
  selectedIndex = null;
  $("centerText").textContent = "è½‰å‹•ä¸­â€¦";
  setStatus("warn", "è½‰å‹•ä¸­");

  const audio = $("drum");
  try{
    if (audio){
      audio.currentTime = 0;
      audio.play().catch(()=>{ /* ignored */ });
    }
  }catch{}

  const startRot = rotation;
  const extraTurns = 5 + Math.random()*3; // 5~8 turns
  const targetDelta = extraTurns * Math.PI*2 + (Math.random()*Math.PI*2);
  const duration = 4200 + Math.random()*800; // ms
  const t0 = performance.now();

  function easeOutCubic(x){ return 1 - Math.pow(1-x, 3); }

  function tick(t){
    const p = Math.min(1, (t - t0) / duration);
    const e = easeOutCubic(p);
    rotation = startRot + targetDelta * e;
    drawWheel();
    if (p < 1){
      requestAnimationFrame(tick);
    }else{
      rotating = false;
      try{ if (audio) audio.pause(); }catch{}
      const idx = getIndexUnderPointer();
      selectedIndex = idx;
      drawWheel();
      setStatus("ok", "å–®æ©Ÿç‰ˆå·²å°±ç·’");
      if (typeof onDone === "function") onDone(idx);
    }
  }
  requestAnimationFrame(tick);
}

/** UI state */
function applyUI(){
  const lockBtn = $("lockBtn");
  const spinBtn = $("spinBtn");
  const secondBtn = $("secondBtn");
  const viewBtn = $("viewBtn");
  const pdfBtn = $("pdfBtn");
  const resetBtn = $("resetBtn");
  const nameInput = $("nameInput");

  // reset blink
  viewBtn.classList.remove("blink-all");

  // default
  spinBtn.disabled = true;
  secondBtn.disabled = true;
  viewBtn.disabled = true;

  if (sysState === SYS.READY){
    lockBtn.disabled = false;
    nameInput.disabled = false;
    $("status").textContent = "è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®";
  }
  if (sysState === SYS.LOCKED){
    lockBtn.disabled = true;
    nameInput.disabled = true;
    spinBtn.disabled = false;
    $("status").textContent = `å·²é–å®šåå–®ï¼ˆ${remainingNames.length} äººï¼‰\næŒ‰ã€Œé–‹å§‹æŠ½å§“åï¼ˆç¬¬ä¸€è¼ªï¼‰ã€`;
  }
  if (sysState === SYS.R1_DONE){
    lockBtn.disabled = true;
    nameInput.disabled = true;
    spinBtn.disabled = true;
    secondBtn.disabled = false;
    $("status").textContent = `ç¬¬ä¸€è¼ªå®Œæˆï¼š${currentName}\næŒ‰ã€ŒæŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰ã€æŠ½ç¶“å¥`;
  }
  if (sysState === SYS.R2_DONE){
    lockBtn.disabled = true;
    nameInput.disabled = true;
    spinBtn.disabled = true;
    secondBtn.disabled = true;
    viewBtn.disabled = false;
    viewBtn.classList.add("blink-all");
    $("status").textContent = `ç¬¬äºŒè¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ${currentVerse}ã€\nè«‹æŒ‰ã€Œçœ‹ç´…åŒ…ã€`;
  }

  // pdf enable
  pdfBtn.disabled = history.length === 0;
  pdfBtn.classList.toggle("btn-pdf-ready", history.length > 0);

  // reset danger if history exists or locked
  const danger = (history.length>0) || (sysState !== SYS.READY);
  resetBtn.classList.toggle("btn-reset-danger", danger);
}

/** load/save history */
function loadHistory(){
  try{
    const raw = localStorage.getItem(HISTORY_KEY);
    if (!raw) return [];
    const arr = JSON.parse(raw);
    if (Array.isArray(arr)) return arr;
  }catch{}
  return [];
}
function saveHistory(){
  try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); }catch{}
}

/** lock names */
function lockNames(){
  unlockAudioOnce();
  const text = $("nameInput").value || "";
  const parts = text
    .split(/[\n,ï¼Œ\s]+/g)
    .map(s=>s.trim())
    .filter(Boolean);

  // unique preserve order
  const seen = new Set();
  names = [];
  for (const p of parts){
    if (!seen.has(p)){
      seen.add(p);
      names.push(p);
    }
  }
  if (names.length < 1){
    safeAlert("è«‹å…ˆè¼¸å…¥è‡³å°‘ 1 ä½å§“å");
    return;
  }
  remainingNames = names.slice();
  remainingVerses = genVerses();
  currentName = null;
  currentVerse = null;
  sysState = SYS.LOCKED;

  // show names wheel
  wheelMode = "names";
  wheelItems = remainingNames.slice();
  rotation = 0;
  selectedIndex = null;
  $("centerText").textContent = "ç¬¬ä¸€è¼ªï¼šæŠ½å§“å";
  $("result").textContent = "";
  $("summaryBox").textContent = renderHistorySummary();
  drawWheel();
  applyUI();
}

/** round 1: pick name */
function startRound1(){
  unlockAudioOnce();
  if (remainingNames.length === 0){
    safeAlert("åå–®å·²æŠ½å®Œã€‚å¯æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€é‡æ–°é–‹å§‹ã€‚");
    return;
  }
  wheelMode = "names";
  wheelItems = remainingNames.slice();
  selectedIndex = null;
  drawWheel();
  spinOnce((idx)=>{
    currentName = remainingNames[idx];
    // remove name
    remainingNames.splice(idx,1);

    $("result").textContent = `âœ… ç¬¬ä¸€è¼ªï¼šæŠ½ä¸­ã€Œ${currentName}ã€`;
    $("centerText").textContent = `ç¬¬ä¸€è¼ªå®Œæˆ\n${currentName}`;
    sysState = SYS.R1_DONE;
    applyUI();
  });
}

/** round 2: pick verse */
function startRound2(){
  unlockAudioOnce();
  if (!currentName){
    safeAlert("è«‹å…ˆå®Œæˆç¬¬ä¸€è¼ªï¼ˆæŠ½å§“åï¼‰");
    return;
  }
  if (remainingVerses.length === 0){
    safeAlert("ç¶“å¥å·²æŠ½å®Œã€‚å¯æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€é‡æ–°é–‹å§‹ã€‚");
    return;
  }

  wheelMode = "verses";
  wheelItems = remainingVerses.slice();
  selectedIndex = null;
  $("centerText").textContent = "ç¬¬äºŒè¼ªï¼šæŠ½ç¶“å¥";
  drawWheel();

  spinOnce((idx)=>{
    currentVerse = remainingVerses[idx];
    remainingVerses.splice(idx,1);

    const ref = getVerseRef(currentVerse);
    const ts = new Date().toISOString();

    history.push({ name: currentName, verse: currentVerse, ref, ts });
    saveHistory();

    $("result").textContent =
      `âœ… ç¬¬äºŒè¼ªï¼š${currentName} æŠ½ä¸­ç¶“å¥ã€Œ${currentVerse}ã€` +
      (ref ? `\nğŸ“– ${ref}` : "");

    $("centerText").textContent =
      `${currentVerse}\n` + (ref ? ref : "");

    $("summaryBox").textContent = renderHistorySummary();

    sysState = SYS.R2_DONE;
    applyUI();
  });
}

/** show envelope */
function playWin(){
  const win = $("winSound");
  if (!win) return;
  try{
    win.currentTime = 0;
    win.play().catch(()=>{
      // è¢«æ“‹ï¼šæç¤ºä½¿ç”¨è€…é»ä¸€ä¸‹ï¼ˆä½†ä¸è¦è®“æµç¨‹ä¸­æ–·ï¼‰
      $("status").textContent += "\nï¼ˆè‹¥ç„¡è²éŸ³ï¼šè«‹è¼•é»è¢å¹•ä¸€ä¸‹å†æŒ‰ä¸€æ¬¡ã€Œçœ‹ç´…åŒ…ã€ï¼‰";
    });
  }catch{}
}

function showEnvelope(){
  unlockAudioOnce();
  if (!currentVerse){
    safeAlert("å°šæœªæŠ½å‡ºç¶“å¥");
    return;
  }
  const panel = $("redEnvelopePanel");
  const img = $("envelopeImg");
  const label = $("envelopeVerse");
  const refEl = $("envelopeRef");

  const ref = getVerseRef(currentVerse);
  label.textContent = currentVerse;
  refEl.textContent = ref ? `ğŸ“– ${ref}` : "";

  img.onload = ()=>{ panel.style.display = "block"; playWin(); };
  img.onerror = ()=>{ safeAlert("æ‰¾ä¸åˆ°åœ–ç‰‡ï¼šcards/" + currentVerse + ".png"); };
  img.src = "cards/" + currentVerse + ".png";
}

/** download envelope image */
function downloadEnvelope(){
  const img = $("envelopeImg");
  if (!img || !img.complete){
    safeAlert("åœ–ç‰‡å°šæœªè¼‰å…¥å®Œæˆ");
    return;
  }
  const canvas = document.createElement("canvas");
  const c = canvas.getContext("2d");
  canvas.width = img.naturalWidth;
  canvas.height = img.naturalHeight;
  c.drawImage(img, 0, 0);
  canvas.toBlob((blob)=>{
    if (!blob) return;
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `verse_${currentVerse}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
}

/** next person */
function nextPerson(){
  $("redEnvelopePanel").style.display = "none";
  currentName = null;
  currentVerse = null;
  sysState = SYS.LOCKED;

  // back to names wheel for next person
  wheelMode = "names";
  wheelItems = remainingNames.slice();
  selectedIndex = null;
  $("centerText").textContent = "ç¬¬ä¸€è¼ªï¼šæŠ½å§“å";
  $("result").textContent = "";
  drawWheel();
  applyUI();

  if (remainingNames.length === 0){
    $("status").textContent = "âœ… å…¨éƒ¨å§“åå·²æŠ½å®Œã€‚å¯æŒ‰ã€ŒæŠ½ç±¤ç´€éŒ„ PDFã€æˆ–ã€Œå…¨éƒ¨æ­¸é›¶ã€ã€‚";
    $("spinBtn").disabled = true;
  }
}

/** history summary */
function renderHistorySummary(){
  if (!history.length) return "";
  const lines = [];
  lines.push("ğŸ“Œ æŠ½ç±¤ç´€éŒ„");
  history.forEach((h, i)=>{
    const ref = h.ref ? `ï¼ˆ${h.ref}ï¼‰` : "";
    lines.push(`${String(i+1).padStart(2,"0")}. ${h.name} ï¼ ${h.verse} ${ref}`);
  });
  return lines.join("\n");
}

/** PDF export: render to canvas then embed image */
async function exportPDF(){
  unlockAudioOnce();
  if (!history.length){
    safeAlert("ç›®å‰æ²’æœ‰ç´€éŒ„");
    return;
  }
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF){
    safeAlert("PDF å¼•æ“è¼‰å…¥å¤±æ•—ï¼ˆjsPDFï¼‰");
    return;
  }

  setStatus("warn", "PDF ç”¢ç”Ÿä¸­â€¦");

  // canvas render
  const pageW = 1240;
  const pageH = 1754; // approx A4 @150dpi
  const margin = 70;
  const lineH = 42;

  function renderPage(pageIndex, rows){
    const c = document.createElement("canvas");
    c.width = pageW; c.height = pageH;
    const g = c.getContext("2d");

    // bg
    g.fillStyle = "#ffffff";
    g.fillRect(0,0,pageW,pageH);

    // header
    g.fillStyle = "#111";
    g.font = "bold 44px 'Noto Sans TC', system-ui";
    g.fillText("ç¥ç¦ç¶“å¥ç´…åŒ…ï¼æŠ½ç±¤ç´€éŒ„", margin, margin+20);

    g.font = "24px 'Noto Sans TC', system-ui";
    const now = new Date();
    g.fillStyle = "#444";
    g.fillText(`ç”¢ç”Ÿæ™‚é–“ï¼š${now.toLocaleString()}`, margin, margin+65);

    // table header
    let y = margin + 120;
    g.fillStyle = "#000";
    g.font = "bold 28px 'Noto Sans TC', system-ui";
    g.fillText("No.", margin, y);
    g.fillText("å§“å", margin+110, y);
    g.fillText("ç¶“å¥", margin+430, y);
    g.fillText("å¼•ç”¨", margin+560, y);

    // divider
    g.strokeStyle = "rgba(0,0,0,.15)";
    g.lineWidth = 2;
    g.beginPath();
    g.moveTo(margin, y+12);
    g.lineTo(pageW-margin, y+12);
    g.stroke();

    // rows
    y += 55;
    g.font = "26px 'Noto Sans TC', system-ui";
    rows.forEach((h, i)=>{
      const no = pageIndex*rowsPerPage + i + 1;
      const ref = h.ref || "";
      g.fillStyle = "#111";
      g.fillText(String(no), margin, y);
      g.fillText(h.name, margin+110, y);
      g.fillText(h.verse, margin+430, y);

      // ref wrap
      const maxWidth = pageW - (margin+560) - margin;
      const refLines = wrapText(g, ref, maxWidth);
      refLines.slice(0,2).forEach((ln, k)=>{
        g.fillText(ln, margin+560, y + k*30);
      });

      y += lineH;
      if (y > pageH - margin - 60) return;
    });

    // footer
    g.fillStyle = "#666";
    g.font = "22px 'Noto Sans TC', system-ui";
    g.fillText(`é  ${pageIndex+1}`, pageW - margin - 90, pageH - margin);
    return c;
  }

  function wrapText(g, text, maxWidth){
    if (!text) return [""];
    const words = text.split("");
    const lines = [];
    let line = "";
    for (const ch of words){
      const test = line + ch;
      if (g.measureText(test).width > maxWidth && line){
        lines.push(line);
        line = ch;
      }else{
        line = test;
      }
    }
    if (line) lines.push(line);
    return lines;
  }

  const rowsPerPage = 28;
  const totalPages = Math.ceil(history.length / rowsPerPage);

  const pdf = new jsPDF({ orientation:"p", unit:"pt", format:"a4" });

  for (let p=0;p<totalPages;p++){
    const rows = history.slice(p*rowsPerPage, (p+1)*rowsPerPage);
    const canvas = renderPage(p, rows);
    const dataUrl = canvas.toDataURL("image/jpeg", 0.92);
    if (p>0) pdf.addPage();
    // fit A4 in points: 595x842
    pdf.addImage(dataUrl, "JPEG", 0, 0, 595, 842);
  }

  pdf.save("BlessingCards128_Record_A.pdf");
  setStatus("ok", "å–®æ©Ÿç‰ˆå·²å°±ç·’");
}

/** reset */
function resetAll(){
  unlockAudioOnce();
  if (!confirm("ç¢ºå®šè¦å…¨éƒ¨æ­¸é›¶ï¼Ÿï¼ˆå°‡æ¸…é™¤æŠ½ç±¤ç´€éŒ„èˆ‡ç›®å‰ç‹€æ…‹ï¼‰")) return;

  history = [];
  saveHistory();

  names = [];
  remainingNames = [];
  remainingVerses = genVerses();
  currentName = null;
  currentVerse = null;
  sysState = SYS.READY;

  $("nameInput").value = "";
  $("redEnvelopePanel").style.display = "none";
  $("result").textContent = "";
  $("summaryBox").textContent = "";
  $("centerText").textContent = "";
  wheelItems = [];
  rotation = 0;
  selectedIndex = null;
  drawWheel();
  applyUI();
}

/** bind */
document.addEventListener("click", unlockAudioOnce, { once:true });

$("lockBtn").addEventListener("click", lockNames);
$("spinBtn").addEventListener("click", startRound1);
$("secondBtn").addEventListener("click", startRound2);
$("viewBtn").addEventListener("click", showEnvelope);
$("downloadEnvelopeBtn").addEventListener("click", downloadEnvelope);
$("nextPersonBtn").addEventListener("click", nextPerson);
$("pdfBtn").addEventListener("click", exportPDF);
$("resetBtn").addEventListener("click", resetAll);

/** init */
(function init(){
  history = loadHistory();
  $("summaryBox").textContent = renderHistorySummary();

  // initial wheel placeholder
  wheelItems = [];
  rotation = 0;
  $("centerText").textContent = "è«‹å…ˆé–å®šåå–®";
  drawWheel();

  // initial UI
  applyUI();
})();
</script>
</body>
</html>
