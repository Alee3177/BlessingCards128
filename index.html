<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body{
  font-family:"Noto Sans TC",system-ui;
  background:#fbf2df;
  text-align:center;
  margin:0;
  padding:16px;
  color:#5b3a00;
}
.logo{width:220px;margin:10px auto 0;display:block;}

#nameInput{
  width:90%;max-width:480px;padding:10px 14px;
  margin-top:10px;border-radius:10px;border:2px solid #e3c78c;
  font-size:18px;text-align:center;box-sizing:border-box;
}

.btn-row{
  margin-top:8px;
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
}
.btn{
  min-width:110px;
  padding:8px 16px;
  border-radius:999px;
  border:none;
  background:#f4b63a;
  color:#5b3a00;
  font-size:15px;
  font-weight:600;
  box-shadow:0 3px 0 #d59b25;
  cursor:pointer;
}
.btn:disabled{
  background:#f0ddaa;
  cursor:default;
}

.blink-btn{animation:flash .8s infinite alternate;}
@keyframes flash{from{opacity:1}to{opacity:.35}}

#wheel-container{
  position:relative;
  width:360px;
  height:360px;
  margin:16px auto;
}
#wheel{
  width:360px;
  height:360px;
}
#hl-svg{
  position:absolute;
  left:0;
  top:0;
  width:360px;
  height:360px;
  pointer-events:none;
}
#confettiCanvas{
  position:absolute;
  left:0;
  top:0;
  width:360px;
  height:360px;
  pointer-events:none;
}

@keyframes blink{from{opacity:1;}to{opacity:.25;}}
.blink{animation:blink .55s ease-in-out infinite alternate;}

#centerText{
  position:absolute;
  left:0;
  top:0;
  width:360px;
  height:360px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  pointer-events:none;
  font-size:18px;
  font-weight:700;
  white-space:pre-line;
}
#summaryBox{
  margin-top:10px;
  white-space:pre-line;
  font-weight:700;
}
/* PDF å®Œæˆå¯ä¸‹è¼‰ç‹€æ…‹ */
.btn-pdf-ready{
  background:#1976D2 !important;
  color:#fff !important;
  box-shadow:0 3px 0 #0d47a1;
}
/* å…¨éƒ¨æ­¸é›¶ï¼šå®Œæˆæ…‹ï¼ˆå±éšªç‹€æ…‹ï¼‰ */
.btn-reset-danger{
  background:#E53935;
  color:#fff;
  box-shadow:0 3px 0 #B71C1C;
}

/* ===== ä¸»æ§ç‹€æ…‹ç‡ˆ ===== */
.status-bar{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin:8px auto 4px auto;
  font-size:14px;
  font-weight:700;
}

.status-bar .dot{
  width:12px;
  height:12px;
  border-radius:50%;
  background:#999;
  box-shadow:0 0 4px rgba(0,0,0,.3);
}

/* ç¶ ï¼šä¸»æ§æ­£å¸¸ */
.status-ok .dot{
  background:#2e7d32;
  box-shadow:0 0 8px rgba(46,125,50,.8);
}

/* é»ƒï¼šæ“ä½œä¸­ */
.status-warn .dot{
  background:#f9a825;
  box-shadow:0 0 8px rgba(249,168,37,.8);
}

/* ç´…ï¼šé–å®š / é›™ä¸»æŒ / éŒ¯èª¤ */
.status-error .dot{
  background:#c62828;
  box-shadow:0 0 8px rgba(198,40,40,.8);
}

</style>

<script src="verseRefMap.js?v=20260105"></script>

<!-- â‘  jsPDF ä¸»ç¨‹å¼ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>

<body>

<img src="logo3524.png" class="logo" />
<h2>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h2>

<div id="masterStatus" class="status-bar">
  <span class="dot"></span>
  <span class="label">ç³»çµ±åˆå§‹åŒ–ä¸­</span>
</div>

<input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼Œå¯ç”¨ç©ºç™½æˆ–é€—è™Ÿåˆ†éš”">

<!-- ç¬¬ä¸€è¡Œ -->
<div class="btn-row">
  <button id="lockBtn" class="btn">é–å®šåå–®</button>
  <button id="spinBtn" class="btn" disabled>é–‹å§‹æŠ½å§“åï¼‹ç¶“å¥ï¼ˆç¬¬ä¸€è¼ªï¼‰</button>
</div>

<!-- ç¬¬äºŒè¡Œ -->
<div class="btn-row">
  <button id="viewBtn" class="btn" disabled>çœ‹ç´…åŒ…</button>
  <button id="secondBtn" class="btn" disabled>æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
</div>

<!-- ç¬¬ä¸‰è¡Œ -->
<div class="btn-row">
  <button id="resetBtn" class="btn">å…¨éƒ¨æ­¸é›¶</button>
  <button id="pdfBtn" class="btn" disabled>æŠ½ç±¤ç´€éŒ„ PDF</button>
</div>

<div id="wheel-container">
  <canvas id="wheel" width="360" height="360"></canvas>
  <canvas id="confettiCanvas" width="360" height="360"></canvas>
  <svg id="hl-svg" viewBox="0 0 360 360"></svg>
  <div id="centerText"></div>
</div>

<div id="status">è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®</div>
<div id="result"></div>
<div id="summaryBox"></div>

<audio id="drum" preload="auto" playsinline>
  <source src="audio/drum.mp3" type="audio/mpeg">
</audio>

<audio id="winSound" preload="auto" playsinline>
  <source src="audio/win.mp3" type="audio/mpeg">
</audio>

<!-- ===============================
  BlessingCards128 Resource Preloader
  é è¼‰ LOGO / éŸ³æ•ˆ / ç´…åŒ…åœ–ç‰‡
================================ -->
<script>
(function preloadResources(){

  console.log("ğŸ”¥ BlessingCards128 è³‡æºæš–æ©Ÿä¸­...");

  /* ===== 1ï¸âƒ£ LOGO ===== */
  const preloadLogo = new Image();
  preloadLogo.src = "logo3524.png";

  /* ===== 2ï¸âƒ£ éŸ³æ•ˆ ===== */
  const preloadDrum = new Audio();
  preloadDrum.src = "audio/drum.mp3";
  preloadDrum.load();

  const preloadWin = new Audio();
  preloadWin.src = "audio/win.mp3";
  preloadWin.load();

  /* ===== 3ï¸âƒ£ ç´…åŒ…åœ–ç‰‡ï¼ˆ001â€“128ï¼‰===== */
  const MAX_PRELOAD = 128;
  const loaded = { count: 0 };

  for (let i = 1; i <= MAX_PRELOAD; i++) {
    const img = new Image();
    const no = String(i).padStart(3, "0");

    img.onload = () => {
      loaded.count++;
      if (loaded.count === MAX_PRELOAD) {
        console.log("âœ… æ‰€æœ‰ç´…åŒ…åœ–ç‰‡å·²æš–æ©Ÿå®Œæˆï¼ˆ001â€“128ï¼‰");
      }
    };

    img.onerror = () => {
      console.warn("âš  ç„¡æ³•é è¼‰åœ–ç‰‡:", "cards/" + no + ".png");
    };

    img.src = "cards/" + no + ".png";
  }

})();
</script>

<script>
(function(){

/* ==== DOM å…ƒä»¶ ==== */
const wheel = document.getElementById("wheel");
const ctx   = wheel.getContext("2d");
const hlSVG = document.getElementById("hl-svg");
const centerText = document.getElementById("centerText");

const confettiCanvas = document.getElementById("confettiCanvas");
const confCtx = confettiCanvas.getContext("2d");

const lockBtn   = document.getElementById("lockBtn");
const spinBtn   = document.getElementById("spinBtn");
const resetBtn  = document.getElementById("resetBtn");
const secondBtn = document.getElementById("secondBtn");
const viewBtn   = document.getElementById("viewBtn");
const pdfBtn    = document.getElementById("pdfBtn");
const nameInput = document.getElementById("nameInput");

const statusDiv  = document.getElementById("status");
const resultDiv  = document.getElementById("result");
const summaryBox = document.getElementById("summaryBox");

const drum = document.getElementById("drum");
const winSound = document.getElementById("winSound");

/* ==== éŸ³æ•ˆè§£é–ï¼ˆåªéœ€ä¸€æ¬¡ï¼‰ ==== */
let audioUnlocked = false;

function unlockAudio() {
  if (audioUnlocked) return;

  try {
    winSound.muted = true;
    winSound.play().then(() => {
      winSound.pause();
      winSound.currentTime = 0;
      winSound.muted = false;
      audioUnlocked = true;
      console.log("ğŸ”“ Audio unlocked");
    });
  } catch (e) {
    console.log("Audio unlock failed:", e);
  }
}

/* ==== ä¸»æ§æ——æ¨™ ==== */
const IS_MASTER = true;

/* ==== ç‹€æ…‹è®Šæ•¸ ==== */
let names = [];
let usedName = new Set();
let verseUsed = new Set();

/* ==== å•†ç”¨ç´šåˆ†é è­˜åˆ¥ ==== */
const TAB_ID = Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 6);
const HEARTBEAT_TTL = 5000; // 5 ç§’å…§è¦–ç‚ºã€Œæ´»èºåˆ†é ã€

let rotation = 0;
let rotating = false;
let lastWinnerIndex = null;
let currentVerse = null;

/* ==== PDF è¼ªæ¬¡é˜²å‘†ç‹€æ…‹ ==== */
let pdfRoundSerial = null;   // æœ¬è¼ªä½¿ç”¨çš„æµæ°´è™Ÿï¼ˆ001~999ï¼‰
let pdfRepeatCount = 0;     // æœ¬è¼ªé‡è¤‡ä¸‹è¼‰æ¬¡æ•¸
let pdfDownloadedThisRound = false;

/* ==== ç³»çµ±ç‹€æ…‹æ©Ÿ ==== */
const SYS_STATE = {
  INIT: "INIT",           // åˆå§‹
  READY: "READY",        // åå–®é–å®š
  ROUND1: "ROUND1",      // ç¬¬ä¸€è¼ªæ—‹è½‰ä¸­
  ROUND2: "ROUND2",      // ç¬¬äºŒè¼ªæ—‹è½‰ä¸­
  VIEWER: "VIEWER",      // æŸ¥çœ‹ç´…åŒ…
  FINISHED: "FINISHED"  // å…¨éƒ¨å®Œæˆ
 };
let lastHeartbeat = Date.now();
let systemState = SYS_STATE.INIT;
let lastActionAt = 0;   // é˜²é€£é»ç¯€æµç”¨

const statusBar = document.getElementById("masterStatus");

function setStatusLight(mode, text){
  if(!statusBar) return;

  statusBar.classList.remove("status-ok","status-warn","status-error");

  if(mode === "ok")    statusBar.classList.add("status-ok");
  if(mode === "warn")  statusBar.classList.add("status-warn");
  if(mode === "error") statusBar.classList.add("status-error");

  const label = statusBar.querySelector(".label");
  if(label) label.textContent = text;
}

function canAct(delay = 500) // æ‰€æœ‰æŒ‰éˆ• 500ms å…§åªèƒ½è§¸ç™¼ä¸€æ¬¡ï¼ˆé˜²é›™æ“Šã€æ‰‹æ©Ÿèª¤è§¸ï¼‰
{
  setStatusLight("warn","æ“ä½œä¸­â€¦");
  const now = Date.now();
  setStatusLight("ok","ç³»çµ±å¾…å‘½ä¸­");
  if (now - lastActionAt < delay) return false;
  lastActionAt = now;
  return true;
}

function audit(action, detail = "") // æ¯å€‹æ“ä½œéƒ½å¯è¿½è¹¤ã€å¯åŒ¯å‡ºã€å¯æŸ¥è²¬
{
  if (!IS_MASTER) return;   // ğŸ”’ åªæœ‰ä¸»æ§å°èƒ½å¯«ç¨½æ ¸ç´€éŒ„

  const logs = JSON.parse(localStorage.getItem("auditLogs") || "[]");
  logs.push({
    time: new Date().toISOString(),
    session: TAB_ID,
    state: systemState,
    action,
    detail
  });
  localStorage.setItem("auditLogs", JSON.stringify(logs));
}

function applyUIState() // æ‰€æœ‰æŒ‰éˆ•ã€é–ƒçˆã€enable/disableã€ç‹€æ…‹æ–‡å­—ï¼Œåªèƒ½å¾ä¸€å€‹åœ°æ–¹æ”¹
                        // é¿å…ç¾åœ¨é€™ç¨®ã€ŒA æ®µé–‹ã€B æ®µåˆé—œã€C æ®µåˆæ”¹è‰²ã€çš„æ··äº‚ç‹€æ…‹
{

  // ===== ç‹€æ…‹ç‡ˆåŒæ­¥ =====
  switch(systemState){
    case SYS_STATE.INIT:
      setStatusLight("ok","ç³»çµ±å¾…å‘½ä¸­");
      break;
    case SYS_STATE.READY:
      setStatusLight("ok","åå–®å·²é–å®šï¼Œæº–å‚™æŠ½ç±¤");
      break;
    case SYS_STATE.ROUND1:
      setStatusLight("warn","ç¬¬ä¸€è¼ªæŠ½ç±¤ä¸­");
      break;
    case SYS_STATE.ROUND2:
      setStatusLight("warn","ç¬¬äºŒè¼ªæŠ½ç´…åŒ…ä¸­");
      break;
    case SYS_STATE.VIEWER:
      setStatusLight("warn","æŸ¥çœ‹ç´…åŒ…ä¸­");
      break;
    case SYS_STATE.FINISHED:
      setStatusLight("ok","æœ¬è¼ªå®Œæˆï¼Œå¯ä¸‹è¼‰ PDF æˆ–é‡ç½®");
      break;
    default:
      setStatusLight("error","ç³»çµ±ç‹€æ…‹ç•°å¸¸");
  }

  // å…¨éƒ¨å…ˆé–æ­»ï¼ˆå®‰å…¨é è¨­ï¼‰
  lockBtn.disabled   = true;
  spinBtn.disabled   = true;
  secondBtn.disabled = true;
  viewBtn.disabled   = true;
  pdfBtn.disabled    = true;

  lockBtn.classList.remove("blink-btn");
  spinBtn.classList.remove("blink-btn");
  secondBtn.classList.remove("blink-btn");
  viewBtn.classList.remove("blink-btn");

  pdfBtn.classList.remove("btn-pdf-ready");
  resetBtn.classList.remove("btn-reset-danger");

  switch(systemState) {

    case SYS_STATE.INIT:
      lockBtn.disabled = false;
      resetBtn.disabled = false;
      statusDiv.textContent = "è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®";
      break;

    case SYS_STATE.READY:
      spinBtn.disabled = false;
      spinBtn.classList.add("blink-btn");
      statusDiv.textContent = "è«‹é–‹å§‹ç¬¬ä¸€è¼ªæŠ½ç±¤";
      break;

    case SYS_STATE.ROUND1:
      statusDiv.textContent = "æ—‹è½‰ä¸­...";
      break;

    case SYS_STATE.ROUND2:
      statusDiv.textContent = "è«‹æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰";
      secondBtn.disabled = false;
      secondBtn.classList.add("blink-btn");
      break;

    case SYS_STATE.VIEWER:
      viewBtn.disabled = false;
      viewBtn.classList.add("blink-btn");
      break;

    case SYS_STATE.FINISHED:
      pdfBtn.disabled = false;
      pdfBtn.classList.add("btn-pdf-ready");
      resetBtn.classList.add("btn-reset-danger");
      statusDiv.textContent = "";
      break;
  }
}

const CENTER = 180;
const R      = 150;
const DURATION = 5000;

/* ========= åˆå§‹æ¨£å¼ï¼šå–®åœ“ï¼‹åŠå¾‘ç·š ========= */
function drawInitialWheel(){
  ctx.clearRect(0,0,360,360);

  ctx.beginPath();
  ctx.arc(CENTER,CENTER,R,0,Math.PI*2);
  ctx.fillStyle = "#fcdca0";
  ctx.fill();

  ctx.beginPath();
  ctx.arc(CENTER,CENTER,R,0,Math.PI*2);
  ctx.lineWidth = 3;
  ctx.strokeStyle = "#ffffff";
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(CENTER, CENTER);
  ctx.lineTo(CENTER, CENTER - (R - 2));
  ctx.lineWidth = 3;
  ctx.strokeStyle = "#ffffff";
  ctx.stroke();
}

/* ========= ç•«å§“åè¼ªç›¤ ========= */
function drawWheel(angle){
  ctx.clearRect(0,0,360,360);

  if(!names.length){
    drawInitialWheel();
    return;
  }

  const n   = names.length;
  const arc = 2*Math.PI / n;

  ctx.save();
  ctx.translate(CENTER,CENTER);
  ctx.rotate(angle);
  ctx.translate(-CENTER,-CENTER);

  for(let i=0;i<n;i++){
    const s = i*arc - Math.PI/2 - arc/2;
    const e = s + arc;

    ctx.beginPath();
    ctx.moveTo(CENTER,CENTER);
    ctx.arc(CENTER,CENTER,R,s,e);
    ctx.closePath();

    ctx.fillStyle = (i%2 ? "#fde6b4" : "#fcdca0");
    ctx.fill();

    ctx.lineWidth = 3;
    ctx.strokeStyle = "#ffffff";
    ctx.stroke();

    ctx.save();
    ctx.translate(CENTER,CENTER);
    ctx.rotate(s + arc/2);
    ctx.textAlign = "right";
    ctx.font = "18px Noto Sans TC";
    ctx.fillStyle = "#5b3a00";
    ctx.fillText(names[i], R-14, 6);
    ctx.restore();
  }

  ctx.restore();
}

/* ========= é«˜äº® ========= */
function clearHL(){hlSVG.innerHTML="";}

function showHL(i){
  if(i==null||!names.length)return;

  const n=names.length;
  const arc=2*Math.PI/n;

  const s=i*arc - Math.PI/2 + rotation - arc/2;
  const e=s+arc;

  const x1=CENTER+R*Math.cos(s);
  const y1=CENTER+R*Math.sin(s);
  const x2=CENTER+R*Math.cos(e);
  const y2=CENTER+R*Math.sin(e);

  const p=document.createElementNS("http://www.w3.org/2000/svg","path");
  p.setAttribute("d",`M${CENTER} ${CENTER} L${x1} ${y1} A${R} ${R} 0 0 1 ${x2} ${y2} Z`);
  p.setAttribute("fill","rgba(255,210,50,0.55)");
  p.setAttribute("class","blink");
  hlSVG.appendChild(p);
}

function ease(t){return 1 - Math.pow(1-t,3);}

/* ========= å½©å¸¶ï¼‹é‡‘ç²‰ç‰¹æ•ˆ ========= */
function launchConfetti(){
  const pieces=[];
  const dots=[];
  const colors=["#ffd54f","#ffb300","#ffca28","#ffe082","#fff8e1"];

  for(let i=0;i<120;i++){
    pieces.push({
      x:Math.random()*360,
      y:Math.random()*-80,
      w:4+Math.random()*5,
      h:8+Math.random()*10,
      vx:-1+Math.random()*2,
      vy:2+Math.random()*3,
      r:Math.random()*Math.PI,
      vr:(Math.random()-0.5)*0.2,
      color:colors[Math.floor(Math.random()*colors.length)]
    });
  }
  for(let i=0;i<80;i++){
    dots.push({
      x:180 + (Math.random()-0.5)*200,
      y:140 + (Math.random()-0.5)*80,
      r:1+Math.random()*2.5,
      vy:-0.2-Math.random()*0.5,
      alpha:0.9,
      va:-0.01-Math.random()*0.02
    });
  }

  const start=performance.now();
  const duration=1800;

  function frame(now){
    const t=now-start;
    confCtx.clearRect(0,0,360,360);

    pieces.forEach(p=>{
      p.x+=p.vx;
      p.y+=p.vy;
      p.r+=p.vr;
      confCtx.save();
      confCtx.translate(p.x,p.y);
      confCtx.rotate(p.r);
      confCtx.fillStyle=p.color;
      confCtx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
      confCtx.restore();
    });

    dots.forEach(d=>{
      d.y+=d.vy;
      d.alpha+=d.va;
      if(d.alpha<0)d.alpha=0;
      confCtx.beginPath();
      confCtx.fillStyle=`rgba(255,215,130,${d.alpha})`;
      confCtx.arc(d.x,d.y,d.r,0,Math.PI*2);
      confCtx.fill();
    });

    if(t<duration){
      requestAnimationFrame(frame);
    }else{
      confCtx.clearRect(0,0,360,360);
    }
  }
  requestAnimationFrame(frame);
}

/* ========= æ—‹è½‰å‹•ç•« ========= */
function spin(list,clockwise,callback){
  if(rotating||!list.length)return;

  rotating=true;

  statusDiv.textContent="æ—‹è½‰ä¸­â€¦â€¦";
  resultDiv.textContent="";
  centerText.textContent="";
  summaryBox.textContent="";

  try{drum.currentTime=0;drum.play();}catch(e){}

  const target=list[Math.floor(Math.random()*list.length)];
  const idx=list.indexOf(target);

  const base=rotation;
  const end=base+(clockwise?1:-1)*(6*Math.PI+idx*(2*Math.PI/list.length));
  const start=performance.now();

  (function anim(now){
    let t=(now-start)/DURATION;
    if(t>1)t=1;

    rotation=base+(end-base)*ease(t);
    drawWheel(rotation);

if (t < 1) {
  requestAnimationFrame(anim);
} else {
  try {
    callback(target, idx);
  } finally {
    rotating = false;   // â­ ç„¡è«– callback ç™¼ç”Ÿä»€éº¼ï¼Œä¸€å®šè§£é–
  }
}
  })(performance.now());
}

/* ========= å„²å­˜ç‹€æ…‹ ========= */
function saveState(extra = {}) {
  if (!IS_MASTER) return;      // ğŸ”’ éä¸»æ§é ç¦æ­¢å¯«ç‹€æ…‹ï¼ˆä¸€å®šè¦ç¬¬ä¸€è¡Œï¼‰

  lastHeartbeat = Date.now(); // ğŸ”„ å¿ƒè·³åŒæ­¥ï¼ˆå•†ç”¨ç´šåˆ†é å­˜æ´»æ¨™è¨˜ï¼‰

  const prev = (() => {
    try {
      return JSON.parse(sessionStorage.getItem("spinState")) || {};
    } catch {
      return {};
    }
  })();

  sessionStorage.setItem("spinState", JSON.stringify({
    names,
    usedName: [...usedName],
    verseUsed: [...verseUsed],
    currentVerse,
    rotation,          // âœ… å¿…å­˜
    lastWinnerIndex,  // âœ… å¿…å­˜
	
    // ===== PDF è¼ªæ¬¡é˜²å‘†ç‹€æ…‹ï¼ˆå¿…å­˜ï¼‰=====	
	pdfRoundSerial,
    pdfRepeatCount,

    // âœ… round2Done æ­£ç¢ºç¹¼æ‰¿é‚è¼¯
    round2Done:
      typeof extra.round2Done === "boolean"
        ? extra.round2Done
        : !!prev.round2Done,

    finished: (usedName.size === names.length),

  // â­ å•†ç”¨ç´šé›™åˆ†é é˜²è­·ï¼ˆåŠ åœ¨é€™è£¡ï¼‰
  tabId: TAB_ID,
  heartbeat: Date.now(),

    ...extra
  }));
}

/* ========= è¼‰å…¥ç‹€æ…‹ï¼ˆä¸è‡ªå‹•æ—‹è½‰ï¼‰ ========= */
function loadState(){
  rotating = false;   // â˜… å¼·åˆ¶è§£é™¤æ­»é–

  // â­ PATCH A-1ï¼šæ˜¯å¦å¾ viewer å›ä¾†ï¼ˆä¸€å®šè¦åœ¨æœ€å‰é¢ï¼‰
  const cameFromViewer =
    sessionStorage.getItem("showSummaryOnReturn") === "1";

  const raw = sessionStorage.getItem("spinState");

  /* ===== å®Œå…¨æ²’æœ‰ä»»ä½•ç‹€æ…‹ï¼šåˆå§‹ç•«é¢ ===== */
if(!raw){
  clearHL();
  drawInitialWheel();
  statusDiv.textContent = "è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®";
  return;
}

  let s;
  try{
    s = JSON.parse(raw);
	
  }catch(e){
    clearHL();
    drawInitialWheel();
    return;
  }
// ===== å•†ç”¨ç´šä¸»æ§é–ï¼ˆåªé˜²çœŸæ­£é›™ä¸»æŒäººï¼‰ =====
if (IS_MASTER && s.tabId && s.tabId !== TAB_ID) {
  const now = Date.now();
  if (s.heartbeat && now - s.heartbeat < HEARTBEAT_TTL) {
    setStatusLight("error","åµæ¸¬åˆ°å¦ä¸€å°ä¸»æ§è¨­å‚™");
    alert("åµæ¸¬åˆ°å¦ä¸€å°é›»è…¦æ­£åœ¨æ“ä½œæ­¤è½‰ç›¤ç³»çµ±ï¼Œå·²å›åˆ°å®‰å…¨ç‹€æ…‹");
    sessionStorage.removeItem("spinState");
    location.reload();
    return;
  }
}

  /* ===== é‚„åŸæ ¸å¿ƒè³‡æ–™ ===== */
names        = Array.isArray(s.names) ? s.names : [];
usedName     = new Set(s.usedName || []);
verseUsed    = new Set(s.verseUsed || []);
currentVerse = s.currentVerse || null;
rotation     = typeof s.rotation === "number" ? s.rotation : 0;
lastWinnerIndex = (s.lastWinnerIndex ?? -1);

// ===== é‚„åŸ PDF è¼ªæ¬¡é˜²å‘†ç‹€æ…‹ =====
pdfRoundSerial = s.pdfRoundSerial || null;
pdfRepeatCount = s.pdfRepeatCount || 0;
pdfDownloadedThisRound = !!pdfRoundSerial;

const round2Done = !!s.round2Done;

    // === A-3ï¼šé‚„åŸå§“åè¼¸å…¥æ¡†å…§å®¹ ===
  nameInput.value = names.join(" ");

  /* ===== é‡ç•«è½‰ç›¤ï¼ˆåªç•«ä¸€æ¬¡ï¼‰===== */
  clearHL();                 // â˜… å¿…åŠ ï¼šé¿å…æ®˜å½±
  drawWheel(rotation);

  /* ===== è‹¥å·²æœ‰ç¬¬ä¸€è¼ªçµæœï¼Œé¡¯ç¤ºé«˜äº® ===== */
  if(lastWinnerIndex >= 0){
    showHL(lastWinnerIndex);
  }

  /* ===== UI ç‹€æ…‹åŒæ­¥ ===== */
  const total = names.length;
  const drawn = usedName.size;
 
  // ===== å•é¡Œ Bï¼šå–æ¶ˆé«˜äº®é–ƒçˆ =====
  document.querySelectorAll("#hl-svg .blink")
    .forEach(el => el.classList.remove("blink"));
	
	
  /* é–å®šåå–®ï¼šæŠ½ç±¤ä¸­ä¸å¯å†é–ï¼Œå…¨éƒ¨æŠ½å®Œæ‰å¯ */
  lockBtn.disabled = (drawn > 0 && drawn < total);

  /* ç¬¬ä¸€è¼ªï¼šé‚„æ²’å…¨éƒ¨æŠ½å®Œæ‰å¯ */
  spinBtn.disabled = (drawn >= total);

// ===== ç¬¬äºŒè¼ªï¼šåªæœ‰ã€Œå‰›å®Œæˆç¬¬ä¸€è¼ªã€æ‰å¯ç”¨ =====
if (
  lastWinnerIndex >= 0 &&
  !round2Done &&
  rotating === false &&
  !cameFromViewer   // â­ é—œéµï¼šå¾ viewer å›ä¾†ä¸€å¾‹é–æ­»
){
  secondBtn.disabled = false;
  secondBtn.classList.add("blink-btn");
}else{
  secondBtn.disabled = true;
  secondBtn.classList.remove("blink-btn");
}

  /* çœ‹ç´…åŒ…ï¼šå¿…é ˆå®Œæˆç¬¬äºŒè¼ª */
  if(round2Done && currentVerse){
    viewBtn.disabled = false;
    viewBtn.classList.add("blink-btn");
  }else{
    viewBtn.disabled = true;
    viewBtn.classList.remove("blink-btn");
  }

  /* PDFï¼šå…¨éƒ¨æŠ½å®Œæ‰å¯ */
  pdfBtn.disabled = !(drawn === total);
 
  /* ===== æ¸…é™¤éŒ¯èª¤æ®˜ç•™æ–‡å­— ===== */
  if(resultDiv && resultDiv.textContent.includes("æ—‹è½‰ä¸­")){
    resultDiv.textContent = "";
  }

/* ===== ğŸ”’ FINAL LOCKï¼šå¾ viewer å›ä¾†å¾Œçš„ UIï¼ˆå”¯ä¸€ç‰ˆæœ¬ï¼‰ ===== */

const fromViewer =
  sessionStorage.getItem("showSummaryOnReturn") === "1";
  
  // ğŸ§¹ ä¿è­‰ä¸æœƒæ®˜ç•™ç¬¬ä¸€è¼ªé–ƒçˆï¼ˆé¿å…è·Ÿç¬¬äºŒè¼ªä¸€èµ·é–ƒï¼‰
spinBtn.classList.remove("blink-btn");

if (fromViewer) {

  /* ===== æƒ…æ³ Aï¼šå°šæœªå…¨éƒ¨æŠ½å®Œ ===== */
  if (drawn < total) {

    // è½‰ç›¤ä¸‹æ–¹æç¤º
    statusDiv.textContent = "è«‹ç¹¼çºŒä¸‹ä¸€ä½æŠ½ç¶“å¥ç´…åŒ…";

    // ç¬¬ä¸€è¼ªï¼šå”¯ä¸€å…¥å£ â†’ å•Ÿç”¨ + é–ƒçˆ
    spinBtn.disabled = false;
    spinBtn.classList.add("blink-btn");

    // å…¶ä»–å…¥å£å…¨éƒ¨é–æ­»
    secondBtn.disabled = true;
    secondBtn.classList.remove("blink-btn");
    viewBtn.disabled = true;
    viewBtn.classList.remove("blink-btn");
	
	// ğŸ”’ Viewer å›ä¾†æœŸé–“ï¼šé–å®šåå–® / PDF ä¸€å¾‹é—œé–‰
    lockBtn.disabled = true;
    pdfBtn.disabled = true;
    pdfBtn.classList.remove("btn-pdf-ready");

  }

  /* ===== æƒ…æ³ Bï¼šå…¨éƒ¨äººå·²æŠ½å®Œ ===== */
  else if (total > 0 && drawn === total) {
  systemState = SYS_STATE.FINISHED;
  applyUIState();
  
  statusDiv.textContent = "";   // âœ… æ¸…é™¤ã€Œè«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®ã€

    // æŒ‡å®šä¸‰è¡Œæç¤º
    summaryBox.textContent =
      `ğŸ‰ æ­¤è¼ªè½‰ç›¤å·²å®Œæˆ ${total} ä½çš„ç´…åŒ…æŠ½ç±¤\n` +
      `ğŸ“„ è«‹æŒ‰ã€ŒæŠ½ç±¤ç´€éŒ„ PDFã€ä¸‹è¼‰ç´€éŒ„ï¼Œæˆ–\n` +
      `ğŸ” è¼¸å…¥æ–°å§“å â†’ æŒ‰ã€Œé–å®šåå–®ã€é–‹å§‹ä¸‹ä¸€è¼ªï¼›ä¹Ÿå¯æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€`;

    // æŠ½ç±¤ç´€éŒ„ PDFï¼šæ•´é¡†è—è‰²
    pdfBtn.disabled = false;
    pdfBtn.classList.add("btn-pdf-ready");

// âœ… å…¨éƒ¨æ­¸é›¶ï¼šæ•´é¡†ç´…è‰²ï¼ˆä¸å¯å†è¢«è¦†è“‹ï¼‰
resetBtn.disabled = false;          // â† å¿…åŠ ï¼Œä¸ç„¶ç´…è‰²åªæ˜¯è£é£¾
resetBtn.classList.add("btn-reset-danger");

    // æ‰€æœ‰æŠ½ç±¤å…¥å£é–æ­»
    spinBtn.disabled   = true;
    secondBtn.disabled = true;
    viewBtn.disabled   = true;

    spinBtn.classList.remove("blink-btn");
    secondBtn.classList.remove("blink-btn");
    viewBtn.classList.remove("blink-btn");
  }

  // âœ… æ‰€æœ‰ fromViewer å°ˆå±¬ UI éƒ½è™•ç†å®Œï¼Œæœ€å¾Œæ‰æ¸…æ——æ¨™
  sessionStorage.removeItem("showSummaryOnReturn");
}
}

/* ========= æŠ½ç±¤ç´€éŒ„å¯«å…¥ localStorage ========= */
function appendLog(name, no, ref){
  let logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
  const now = new Date();
  const timeStr = now.toLocaleString("zh-TW");
  logs.push({
    time: timeStr,
    name,
    no,
    ref
  });
  localStorage.setItem("drawLogs", JSON.stringify(logs));
}

/* ========= PDF æª”åæµæ°´è™Ÿï¼ˆæ°¸ä¹…ç´¯åŠ ï¼Œä¸å— Reset å½±éŸ¿ï¼‰========= */
function getNextBlessingPdfSerial(){
  let n = parseInt(localStorage.getItem("pdfSerial") || "0", 10);
  n++;
  if (n > 999) n = 1;
  localStorage.setItem("pdfSerial", String(n));
  return String(n).padStart(3, "0");
}

/* ========= é–å®šåå–® ========= */
lockBtn.onclick=()=>{
  if (!canAct()) return;   // âœ… å¿…é ˆç¬¬ä¸€è¡Œ
  audit("LOCK_LIST", { count: nameInput.value.trim().split(/[\s,ï¼Œã€]+/).filter(Boolean).length });
  unlockAudio();   // ğŸ”“ é€™ä¸€è¡Œæ˜¯é—œéµ

  const arr=nameInput.value
    .split(/[\s,ï¼Œã€]+/)
    .map(x=>x.trim())
    .filter(Boolean);

  if(arr.length<2){alert("è‡³å°‘å…©ä½å§“å");return;}
  if(new Set(arr).size!==arr.length){
    alert("Oops, æœ‰å§“åé‡è¤‡è¼¸å…¥äº†å”·!");return;
  }

  names=arr;
  usedName.clear();
  verseUsed.clear();
  rotation=0;
  currentVerse=null;

  clearHL();
  drawWheel(0);

  lockBtn.disabled=true;
  spinBtn.disabled=false;

  // === PATCH A-6ï¼šé–å®šåå–®æ™‚ï¼Œæ¸…é™¤å®Œæˆæç¤ºä¸‰è¡Œ ===
  summaryBox.textContent = "";

pdfBtn.classList.remove("btn-pdf-ready"); // ç§»é™¤ PDF è—è‰²
resetBtn.classList.remove("btn-reset-danger"); // ç§»é™¤ Reset ç´…è‰²

  statusDiv.textContent = "åå–®å·²é–å®šï¼Œè«‹é–‹å§‹æŠ½ç±¤";
  systemState = SYS_STATE.READY;
  applyUIState();
  saveState({ round2Done: false });
};

/* ========= ç¬¬ä¸€è¼ª ========= */
spinBtn.onclick = () => {
  if (!canAct()) return;   // âœ… ç¬¬ä¸€è¡Œ
  unlockAudio();   // ğŸ”“ é€™ä¸€è¡Œæ˜¯é—œéµ

  // â­ 1ï¸âƒ£ ä¸€æŒ‰å°±ç«‹åˆ»é–æ­»è‡ªå·±
  spinBtn.disabled = true;
  spinBtn.classList.remove("blink-btn");

  // â­ 2ï¸âƒ£ ä¸‹æ–¹æ–‡å­—ç«‹åˆ»æ”¹ç‚ºã€Œæ—‹è½‰ä¸­...ã€
  statusDiv.textContent = "æ—‹è½‰ä¸­...";

  // â­ 3ï¸âƒ£ åŒæ™‚ä¿éšªé—œé–‰å…¶ä»–å…¥å£
  secondBtn.disabled = true;
  secondBtn.classList.remove("blink-btn");

  viewBtn.disabled = true;
  viewBtn.classList.remove("blink-btn");

  clearHL();
  centerText.textContent = "";
  summaryBox.textContent = "";

  const remain = names.filter(n => !usedName.has(n));
  if (!remain.length) return;
  
  audit("ROUND1_START", { remaining: remain.length });
  systemState = SYS_STATE.ROUND1;
  applyUIState();
  
   // ğŸ”´ã€3ï¸âƒ£ å¿…åŠ ã€‘ç¬¬ä¸€è¼ªä¸€é–‹å§‹ï¼Œå¼·åˆ¶é—œé–‰ç¬¬äºŒè¼ª
  secondBtn.disabled = true;
  secondBtn.classList.remove("blink-btn");

  viewBtn.disabled = true;
  viewBtn.classList.remove("blink-btn");
  
  // === Patch 1ï¼šç¬¬ä¸€è¼ªé–‹å§‹å³æ¸…ç©º round2Done ===
  saveState({ round2Done: false });
  
  // ğŸ”’ ç¬¬ä¸€è¼ªé–‹å§‹ï¼Œé–æ­» PDF / é–å®šåå–®
  pdfBtn.disabled = true;
  lockBtn.disabled = true;

  // âœ… ç¬¬ä¸€è¼ªä¸€å®šæ˜¯é †æ™‚é‡ï¼ˆtrueï¼‰
  spin(remain, true, (winner) => {

    usedName.add(winner);
    lastWinnerIndex = names.indexOf(winner);

    clearHL();
    showHL(lastWinnerIndex);

    const drawnCount = usedName.size;
    const totalCount = names.length;

    statusDiv.textContent = "";
    resultDiv.textContent =
      `ğŸ¯ æŠ½ä¸­ã€Œ${winner}ã€\nï¼ˆç¬¬ ${drawnCount} ä½ï¼å…± ${totalCount} ä½ï¼‰`;

    secondBtn.disabled = false;
    secondBtn.classList.add("blink-btn");

    saveState();
  });
};

/* ========= ç¬¬äºŒè¼ª ========= */
secondBtn.onclick=()=>{
  if (!canAct()) return;   // âœ… ç¬¬ä¸€è¡Œ
  unlockAudio();   // ğŸ”“ é€™ä¸€è¡Œæ˜¯é—œéµ
  systemState = SYS_STATE.ROUND2;
  applyUIState();
  
  secondBtn.disabled=true;
  secondBtn.classList.remove("blink-btn");

  clearHL();
  centerText.textContent="";

  const remain=[...Array(128).keys()]
    .map(i=>String(i+1).padStart(3,"0"))
    .filter(v=>!verseUsed.has(v));
	
	if (!remain.length) {
  systemState = SYS_STATE.FINISHED;
  return;
}
	
	audit("ROUND2_START", { remaining: remain.length });

  spin(remain,false,(v)=>{

  // âœ…ã€é€™ä¸€è¡Œå°±æ”¾åœ¨é€™è£¡ã€‘
  statusDiv.textContent = "";

    verseUsed.add(v);
    currentVerse=v;

    const ref=(window.VERSE_REF_MAP&&window.VERSE_REF_MAP[v])
      ? window.VERSE_REF_MAP[v]
      : "";


// æœ¬æ¬¡æŠ½ç±¤çµæœ
resultDiv.textContent = `ç¬¬äºŒè¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ${v}ã€`;

// ä¸­å¤®é¡¯ç¤ºï¼ˆè¦–è¦ºï¼‰
centerText.textContent = `ğŸ“œ æŠ½ä¸­ç¶“å¥ã€Œ${v}ã€\nğŸ“– ${ref}`;

    // ğŸ”Š win.mp3ï¼ˆâœ” æ­£ç¢ºã€ä½ç½®ä¹Ÿå°ï¼‰
    try{
      winSound.currentTime = 0;
      winSound.play();
    }catch(e){
      console.log("win mp3 blocked:", e);
    }

    // ğŸ‰ å½©å¸¶ï¼ˆâœ” æœ‰ï¼‰
    launchConfetti();
	
    clearHL();                 // â† å·²æœ‰ï¼Œæ­£ç¢º
    showHL(lastWinnerIndex);

    // === A-1ï¼šçœ‹ç´…åŒ…é–ƒçˆæœŸé–“ï¼Œé–å®šæ‰€æœ‰æŠ½ç±¤æŒ‰éˆ• ===
    spinBtn.disabled = true;
    secondBtn.disabled = true;
    spinBtn.classList.remove("blink-btn");
    secondBtn.classList.remove("blink-btn");

    // å•Ÿç”¨ã€Œçœ‹ç´…åŒ…ã€
    viewBtn.disabled = false;
    viewBtn.classList.add("blink-btn");

    // âœ” å¯«å…¥æŠ½ç±¤ç´€éŒ„
    appendLog(names[lastWinnerIndex], v, ref);

    // âœ” å„²å­˜ç‹€æ…‹ï¼ˆæ³¨æ„ï¼šé€™è£¡æˆ‘ä¹Ÿé †ä¾¿å¹«ä½ ä¿®æ­£ï¼‰
    saveState({ round2Done: true });
  });
};

/* ========= çœ‹ç´…åŒ… ========= */
viewBtn.onclick = () => {
  if (!canAct()) return;   // âœ… ç¬¬ä¸€è¡Œ
  
  if(!currentVerse) return;

  const winnerName = names[lastWinnerIndex] || "";

  // åƒ…å„²å­˜ç‹€æ…‹ï¼Œä¸è‡ªå‹•è½‰å‹•
  systemState = SYS_STATE.VIEWER;
  applyUIState();
  saveState();

  window.location.href =
    `viewer.html?no=${currentVerse}&name=${encodeURIComponent(winnerName)}`;
};

/* ========= PDFï¼šä¸‹è¼‰æŠ½ç±¤ç´€éŒ„ï¼ˆCanvas â†’ Image â†’ PDF ç©©å®šç‰ˆï½œå”¯ä¸€ç‰ˆæœ¬ï¼‰ ========= */
pdfBtn.onclick = async () => {
  if (!canAct()) return;   // âœ… å¿…é ˆç¬¬ä¸€è¡Œ

  try {
    const logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
    if (!logs.length) {
      alert("æ²’æœ‰å¯ä¸‹è¼‰çš„æŠ½ç±¤ç´€éŒ„");
      return;
    }

    /* ===== è¼ªæ¬¡é˜²å‘† ===== */
    if (pdfDownloadedThisRound) {
      const ok = confirm(
        "é€™ä¸€è¼ªæ‚¨å·²ç¶“ä¸‹è¼‰éPDFäº†, æ˜¯å¦è¦å†ä¸‹è¼‰ä¸€æ¬¡å‘¢ (Yes or No)?"
      );
      if (!ok) return;
      pdfRepeatCount++;
    } else {
      pdfDownloadedThisRound = true;
      pdfRepeatCount = 0;
    }
    audit("PDF_DOWNLOAD_ATTEMPT", {
      isRepeat: pdfDownloadedThisRound,
      repeatCount: pdfRepeatCount,
      serial: pdfRoundSerial
    });

    /* ===== æµæ°´è™Ÿï¼ˆæœ¬è¼ªåªå–ä¸€æ¬¡ï¼‰ ===== */
    if (!pdfRoundSerial) {
      pdfRoundSerial = getNextBlessingPdfSerial();
    }

    let filename = `Blessing_envelop_${pdfRoundSerial}`;
    if (pdfRepeatCount > 0) {
      filename += `-${pdfRepeatCount}`;
    }
    filename += `.pdf`;

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    /* ===== ç•«å¸ƒå°ºå¯¸èˆ‡ç‰ˆå‹é–æ­»ï¼ˆç­‰åŒ 010.pdfï¼‰ ===== */
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const MARGIN = 60;
    const LINE_H = 32;
    const WIDTH = 1240;

    canvas.width = WIDTH;
    canvas.height = MARGIN * 2 + (logs.length + 6) * LINE_H;

    /* èƒŒæ™¯ */
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    /* æ¨™é¡Œå­—å‹ */
    ctx.fillStyle = "#000000";
    ctx.font = "28px 'Noto Sans TC','PingFang TC','Microsoft JhengHei',Arial,sans-serif";

    let y = MARGIN;

/* ===== æ¨™é¡Œï¼ˆ+25% æ”¾å¤§ + åŠ ç²—ï¼‰ ===== */
ctx.font = "bold 35px 'Noto Sans TC','PingFang TC','Microsoft JhengHei',Arial,sans-serif";
ctx.fillText("ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰", MARGIN, y);
y += LINE_H * 2.2;

/* ===== å°æ¨™ï¼ˆ+10% æ”¾å¤§ + åŠ ç²—ï¼‰ ===== */
ctx.font = "bold 26px 'Noto Sans TC','PingFang TC','Microsoft JhengHei',Arial,sans-serif";
ctx.fillText("æŠ½ç±¤ç´€éŒ„", MARGIN, y);
y += LINE_H * 1.4;

/* ===== å…§å®¹ï¼ˆæ­£å¸¸å­—é‡ï¼‰ ===== */
ctx.font = "22px 'Noto Sans TC','PingFang TC','Microsoft JhengHei',Arial,sans-serif";

logs.slice().reverse().forEach(l => {
  const line = `[${l.time}] ã€Œ${l.name}ã€ â†’ æŠ½ä¸­ç¶“å¥ç´…åŒ…: ${l.ref}`;
  y = wrapText(ctx, line, MARGIN, y, WIDTH - MARGIN * 2, LINE_H);
});

    /* ===== å³ä¸Šè§’é çœ‰ï¼ˆå›ºå®šä½ç½®ï¼‰ ===== */
    ctx.font = "18px Arial";
    ctx.textAlign = "right";
    ctx.fillText(
      "Blessing Envelop System Â© 2026 | Page 1",
      WIDTH - MARGIN,
      40
    );
    ctx.textAlign = "left";

    /* ===== Canvas â†’ PDF ===== */
    const imgData = canvas.toDataURL("image/png");

    const pageWidth = pdf.internal.pageSize.getWidth();
    const imgWidth = pageWidth - 20;
    const imgHeight = (canvas.height / canvas.width) * imgWidth;

    pdf.addImage(imgData, "PNG", 10, 10, imgWidth, imgHeight);
    pdf.save(filename);

  } catch (e) {
    console.error(e);
    alert("PDF ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹æŸ¥çœ‹ console");
  }
};

/* ===== Canvas è‡ªå‹•æ›è¡Œå·¥å…·ï¼ˆç©©å®šç‰ˆï¼Œæœƒå›å‚³æœ€æ–° yï¼‰ ===== */
function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  let line = "";

  for (let i = 0; i < text.length; i++) {
    const testLine = line + text[i];
    if (ctx.measureText(testLine).width > maxWidth && line) {
      ctx.fillText(line, x, y);
      line = text[i];
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line, x, y);
  return y + lineHeight;
}

/* ========= åˆå§‹åŒ– ========= */
loadState();

// ==== ä¸»æ§é æ‰å…è¨±é€å¿ƒè·³ ====
if (IS_MASTER) {
  setInterval(() => {
    const raw = sessionStorage.getItem("spinState");
    if (!raw) return;

    try {
      const s = JSON.parse(raw);
      if (s.tabId === TAB_ID) {
        s.heartbeat = Date.now();
        sessionStorage.setItem("spinState", JSON.stringify(s));
      }
    } catch(e) {}
  }, 2000);
}

/* ========= å…¨éƒ¨æ­¸é›¶ï¼ˆæœ€é«˜å„ªå…ˆæ¬Š Reset æ ¸å¿ƒï¼‰ ========= */
resetBtn.onclick = () => {
  if (!canAct()) return;   // âœ… å¿…é ˆç¬¬ä¸€è¡Œ

  const msg =
`è³‡æ–™ç´€éŒ„å°‡è¢«æ¸…ç©º(clear) & æ­¸é›¶(reset)ï¼Œ
éœ€é‡æ–°è¼¸å…¥å§“åä¸¦é–å®šåå–®é–‹å§‹æ–°è½‰ç›¤éŠæˆ²ï¼
æ‚¨ç¢ºå®šè¦åŸ·è¡Œå— (Yes or No)?`;

  // ğŸ”’ é˜²èª¤è§¸
  if (!confirm(msg)) return;
  audit("SYSTEM_RESET_ATTEMPT", { state: systemState });

  /* ===== 1ï¸âƒ£ æ¸…ç©ºæ ¸å¿ƒè³‡æ–™ ===== */
  names = [];
  usedName.clear();
  verseUsed.clear();
  currentVerse = null;
  lastWinnerIndex = -1;
  rotation = 0;
  rotating = false;
  
  // ===== Reset PDF æœ¬è¼ªé˜²å‘†ç‹€æ…‹ =====
  pdfRoundSerial = null;
  pdfRepeatCount = 0;
  pdfDownloadedThisRound = false;
  
    // ===== Reset ç³»çµ±ç‹€æ…‹æ©Ÿ =====
  systemState = SYS_STATE.INIT;   // âœ… å¿…åŠ 
  applyUIState();

  /* ===== 2ï¸âƒ£ æ¸… Storage ===== */
  localStorage.removeItem("drawLogs");
  localStorage.removeItem("pdfSerial");
  sessionStorage.removeItem("spinState");
  sessionStorage.removeItem("showSummaryOnReturn");

  /* ===== 3ï¸âƒ£ æ¸…ç•«é¢ ===== */
  clearHL();
  drawInitialWheel();

  nameInput.value = "";
  centerText.textContent = "";
  resultDiv.textContent = "";
  summaryBox.textContent = "";
  statusDiv.textContent = "è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®";

  /* ===== 4ï¸âƒ£ é‚„åŸæ‰€æœ‰æŒ‰éˆ•ç‹€æ…‹ï¼ˆINITï¼‰ ===== */
  lockBtn.disabled = false;
  spinBtn.disabled = true;
  secondBtn.disabled = true;
  viewBtn.disabled = true;
  pdfBtn.disabled = true;

  spinBtn.classList.remove("blink-btn");
  secondBtn.classList.remove("blink-btn");
  viewBtn.classList.remove("blink-btn");

  pdfBtn.classList.remove("btn-pdf-ready");
  resetBtn.classList.remove("btn-reset-danger");

  /* Reset åœ¨ INIT ç‹€æ…‹ä»ç„¶å¯ç”¨ */
  resetBtn.disabled = false;

  console.log("ğŸ”„ System Reset â†’ INIT");
  saveState();   // ğŸ”’ Reset å¾Œç«‹åˆ»è¨»å†Šæœ¬åˆ†é ç‚ºä¸»æ§
  
};

})(); 
</script>
</body>
</html>
