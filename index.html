<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BlessingCards128ï½œç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</title>
<style>
:root{--bg:#fff8e7;--text:#5b3a00;--accent:#f7c76c;--accent2:#f3b84f;--danger:#c0392b;}
body{margin:0;background:var(--bg);font-family:"Noto Sans TC",system-ui,-apple-system,"PingFang TC","Microsoft JhengHei",sans-serif;text-align:center;padding:22px 16px 28px;color:var(--text);}
h1{color:#b07500;font-size:26px;margin:8px 0 10px;font-weight:800;letter-spacing:.5px;}
.logo{width:120px;height:auto;margin:10px 0 12px;display:inline-block;}
#nameInput{width:min(520px,92vw);padding:10px 12px;font-size:18px;border-radius:10px;border:1px solid #bf8a3e;outline:none;background:#fff;box-sizing:border-box;}
.row{margin-top:12px;display:flex;justify-content:center;gap:10px;flex-wrap:wrap;}
.btn{background:var(--accent);border:none;padding:12px 18px;border-radius:999px;font-size:17px;color:var(--text);cursor:pointer;min-width:120px;}
.btn:hover{background:var(--accent2);}
.btn:disabled{opacity:.45;cursor:not-allowed;}
@keyframes blink{0%{opacity:1}50%{opacity:.25}100%{opacity:1}}
.blinking{animation:blink 1s infinite;}
#wheelContainer{position:relative;width:380px;height:380px;margin:18px auto 8px;}
#wheelCanvas{width:380px;height:380px;}
#wheelPointer{position:absolute;top:-22px;left:50%;transform:translateX(-50%);font-size:44px;color:#d40000;z-index:5;user-select:none;}
#centerOverlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.82);border-radius:14px;padding:10px 14px;min-width:160px;max-width:220px;line-height:1.15;display:none;box-shadow:0 6px 16px rgba(0,0,0,.10);color:#6b3e00;user-select:none;}
#centerOverlay .book{font-size:18px;font-weight:800;}
#centerOverlay .chap{font-size:16px;margin-top:4px;font-weight:700;}
#statusText{font-size:18px;margin-top:10px;color:#a56b00;min-height:48px;white-space:pre-line;}
#statusText.error{color:var(--danger);font-weight:800;}
.hint{font-size:13px;color:#9a6a22;margin-top:6px;opacity:.85;}
</style>
</head>
<body>
<h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h1>
<img src="logo3524.png" class="logo" alt="BlessingCards128" loading="eager" decoding="async" fetchpriority="high">
<div><input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼ˆç”¨é€—è™Ÿã€é “è™Ÿã€ç©ºç™½åˆ†éš”ï¼‰" autocomplete="off"></div>
<div class="row">
  <button id="lockBtn" class="btn" onclick="lockList()">é–å®šåå–®</button>
  <button id="startBtn" class="btn" onclick="startFirstRound()" disabled>é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
  <button id="pdfBtn" class="btn" onclick="exportPDF()">æŠ½ç±¤ç´€éŒ„ PDF</button>
  <button id="resetBtn" class="btn" onclick="resetAll()">å…¨éƒ¨æ­¸é›¶</button>
</div>
<div class="row">
  <button id="secondBtn" class="btn" style="display:none" onclick="startSecondRound()">æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
  <button id="viewerBtn" class="btn" style="display:none" onclick="gotoViewer()">çœ‹ç´…åŒ…å…§å®¹</button>
</div>
<div id="wheelContainer">
  <div id="wheelPointer">â–¼</div>
  <canvas id="wheelCanvas" width="380" height="380"></canvas>
  <div id="centerOverlay"><div class="book" id="centerBook"></div><div class="chap" id="centerChap"></div></div>
</div>
<div id="statusText">è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€</div>
<div class="hint">æç¤ºï¼šé™¤éæŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€ï¼Œæœ¬è¼ªåå–®èˆ‡ç´€éŒ„æœƒè¢«è¨˜ä½ã€‚</div>

<script src="verseRefMap.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const nameInput=document.getElementById('nameInput');
const startBtn=document.getElementById('startBtn');
const secondBtn=document.getElementById('secondBtn');
const viewerBtn=document.getElementById('viewerBtn');
const pdfBtn=document.getElementById('pdfBtn');
const statusText=document.getElementById('statusText');
const centerOverlay=document.getElementById('centerOverlay');
const centerBook=document.getElementById('centerBook');
const centerChap=document.getElementById('centerChap');
const canvas=document.getElementById('wheelCanvas');
const ctx=canvas.getContext('2d');

const CENTER=190, RADIUS=180;
const POINTER_ANGLE=-Math.PI/2;

let nameList=[], locked=false;
let usedNames=[], usedVerses=[];
let selectedName=null, selectedVerse=null;
let phase='idle'; // firstReady | firstDone | secondDone | completed
let isSpinning=false;
let currentRotation=0;

const drumAudio=new Audio('audio/drum.mp3');
drumAudio.preload='auto';
let drumDurationMs=5600;
drumAudio.addEventListener('loadedmetadata',()=>{if(isFinite(drumAudio.duration)&&drumAudio.duration>0) drumDurationMs=Math.round(drumAudio.duration*1000);});

function setStatus(msg,isError=false){
  statusText.classList.toggle('error',!!isError);
  statusText.textContent=msg;
}
function clamp01(x){return Math.max(0,Math.min(1,x));}
function easeOutCubic(t){return 1-Math.pow(1-t,3);}
function normalizeAngle(a){
  const TWO=Math.PI*2;
  a=(a%TWO+TWO)%TWO;
  if(a>=Math.PI) a-=TWO;
  return a;
}
function parseNames(raw){
  return (raw||'').trim().split(/[,\sã€]+/g).map(s=>s.trim()).filter(Boolean);
}
function uniqueAndCheckDup(arr){
  const s=new Set();
  for(const x of arr){ if(s.has(x)) return {ok:false}; s.add(x); }
  return {ok:true};
}
function nowTimestamp(){
  const d=new Date();
  const p=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}/${p(d.getMonth()+1)}/${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
}

function drawWheelAt(rot,items){
  ctx.clearRect(0,0,380,380);
  if(!items||!items.length) return;
  const count=items.length, arc=Math.PI*2/count;
  ctx.save();
  ctx.translate(CENTER,CENTER);
  ctx.rotate(rot);
  ctx.translate(-CENTER,-CENTER);

  for(let i=0;i<count;i++){
    const start=i*arc, end=start+arc;
    ctx.beginPath();
    ctx.moveTo(CENTER,CENTER);
    ctx.arc(CENTER,CENTER,RADIUS,start,end);
    ctx.closePath();
    ctx.fillStyle=(i%2===0)?'#fde7b5':'#fcdca0';
    ctx.fill();
    ctx.strokeStyle='#ffffff';
    ctx.lineWidth=2;
    ctx.stroke();

    ctx.save();
    ctx.translate(CENTER,CENTER);
    const mid=start+arc/2;
    ctx.rotate(mid);
    ctx.textAlign='right';
    ctx.font='22px "Noto Sans TC", sans-serif';
    ctx.fillStyle='#5b3a00';
    ctx.fillText(items[i],RADIUS-22,10);
    ctx.restore();
  }

  ctx.restore();
}
function render(){ drawWheelAt(currentRotation,nameList); }

function calcTargetRotationForIndex(index,count){
  const arc=Math.PI*2/count;
  const sliceCenter=(index+0.5)*arc;
  return POINTER_ANGLE - sliceCenter;
}
async function playDrum(){
  try{drumAudio.pause();drumAudio.currentTime=0;await drumAudio.play();}catch(e){}
}

function spinToIndex({index,clockwise,durationMs}){
  return new Promise((resolve)=>{
    if(isSpinning) return resolve();
    isSpinning=true;
    centerOverlay.style.display='none';

    const count=nameList.length;
    const targetBase=calcTargetRotationForIndex(index,count);

    const spins=5, TWO=Math.PI*2, dir=clockwise?1:-1;
    let delta=normalizeAngle(targetBase-currentRotation);
    if(dir===1 && delta<0) delta+=TWO;
    if(dir===-1 && delta>0) delta-=TWO;

    const finalRotation=currentRotation + delta + dir*spins*TWO;
    const startRot=currentRotation;
    const totalDelta=finalRotation-startRot;
    const start=performance.now();

    playDrum();

    function step(now){
      const t=clamp01((now-start)/durationMs);
      const eased=easeOutCubic(t);
      currentRotation=startRot + totalDelta*eased;
      drawWheelAt(currentRotation,nameList);
      if(t<1) requestAnimationFrame(step);
      else{
        currentRotation=targetBase;
        drawWheelAt(currentRotation,nameList);
        isSpinning=false;
        resolve();
      }
    }
    requestAnimationFrame(step);
  });
}

function saveState(){
  localStorage.setItem('bc_nameList',JSON.stringify(nameList));
  localStorage.setItem('bc_usedNames',JSON.stringify(usedNames));
  localStorage.setItem('bc_usedVerses',JSON.stringify(usedVerses));
  localStorage.setItem('bc_selectedName',selectedName||'');
  localStorage.setItem('bc_selectedVerse',selectedVerse||'');
  localStorage.setItem('bc_phase',phase);
  localStorage.setItem('bc_rotation',String(currentRotation));
}
function loadState(){
  try{
    const nl=JSON.parse(localStorage.getItem('bc_nameList')||'[]');
    if(Array.isArray(nl)&&nl.length){nameList=nl;locked=true;nameInput.value=nameList.join('ã€');}
  }catch(e){}
  try{usedNames=JSON.parse(localStorage.getItem('bc_usedNames')||'[]')||[];}catch(e){usedNames=[];}
  try{usedVerses=JSON.parse(localStorage.getItem('bc_usedVerses')||'[]')||[];}catch(e){usedVerses=[];}
  selectedName=(localStorage.getItem('bc_selectedName')||'')||null;
  selectedVerse=(localStorage.getItem('bc_selectedVerse')||'')||null;
  phase=localStorage.getItem('bc_phase')||'idle';
  const rot=parseFloat(localStorage.getItem('bc_rotation')||'0');
  if(Number.isFinite(rot)) currentRotation=rot;
  if(!localStorage.getItem('drawLogs')) localStorage.setItem('drawLogs','[]');
}
function hasLogs(){
  try{const logs=JSON.parse(localStorage.getItem('drawLogs')||'[]');return Array.isArray(logs)&&logs.length>0;}catch(e){return false;}
}
function updateButtons(){
  if(!locked){
    startBtn.disabled=true;
    secondBtn.style.display='none';
    viewerBtn.style.display='none';
    return;
  }
  if(phase==='idle'||phase==='firstReady'){
    startBtn.disabled=false;
    secondBtn.style.display='none';
    viewerBtn.style.display='none';
  }else if(phase==='firstDone'){
    startBtn.disabled=true;
    secondBtn.style.display='inline-block';
    viewerBtn.style.display='none';
  }else if(phase==='secondDone'){
    startBtn.disabled=true;
    secondBtn.style.display='none';
    viewerBtn.style.display='inline-block';
  }else if(phase==='completed'){
    startBtn.disabled=true;
    secondBtn.style.display='none';
    viewerBtn.style.display='none';
  }
  if(phase==='completed' && hasLogs()) pdfBtn.classList.add('blinking'); else pdfBtn.classList.remove('blinking');
}

function lockList(){
  const arr=parseNames(nameInput.value||'');
  if(arr.length<2){alert('è‡³å°‘è¦æœ‰å…©ä½æ‰å¯ä»¥ï¼');return;}
  const dup=uniqueAndCheckDup(arr);
  if(!dup.ok){alert('Oops, æœ‰å§“åé‡è¤‡è¼¸å…¥äº†å”·ï¼');return;}

  nameList=arr;
  locked=true;

  usedNames=[];
  selectedName=null;
  selectedVerse=null;
  phase='firstReady';
  centerOverlay.style.display='none';
  currentRotation=0;

  localStorage.setItem('bc_nameList',JSON.stringify(nameList));
  localStorage.setItem('bc_usedNames',JSON.stringify(usedNames));
  localStorage.setItem('bc_selectedName','');
  localStorage.setItem('bc_selectedVerse','');
  localStorage.setItem('bc_phase',phase);
  localStorage.setItem('bc_rotation','0');

  render();
  setStatus(`åå–®å·²è¼‰å…¥ï¼Œå…± ${nameList.length} ä½`);
  updateButtons();
}

async function startFirstRound(){
  if(isSpinning) return;
  if(!locked){alert('è«‹å…ˆé–å®šåå–®ï¼');return;}
  if(!(phase==='firstReady'||phase==='idle')) return;

  const remaining=nameList.filter(n=>!usedNames.includes(n));
  if(remaining.length===0){
    phase='completed';saveState();showCompletedMessage();updateButtons();return;
  }

  selectedName=remaining[Math.floor(Math.random()*remaining.length)];
  selectedVerse=null;

  const idx=nameList.indexOf(selectedName);
  setStatus('ç¬¬ 1 è¼ªï¼šå§“åè¼ªç›¤æŠ½ç±¤ä¸­â€¦');
  phase='idle';saveState();updateButtons();

  const durationMs=Math.max(drumDurationMs,5200);
  await spinToIndex({index:idx,clockwise:false,durationMs});

  phase='firstDone';saveState();
  setStatus(`ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${selectedName}ã€`);
  secondBtn.classList.add('blinking');
  updateButtons();
}

function pickVerse(){
  const all=[];for(let i=1;i<=128;i++) all.push(String(i).padStart(3,'0'));
  const available=all.filter(v=>!usedVerses.includes(v));
  if(!available.length) return null;
  return available[Math.floor(Math.random()*available.length)];
}
function getVerseRef(verse){
  try{if(typeof VERSE_REF_MAP==='object'&&VERSE_REF_MAP) return VERSE_REF_MAP[verse]||'';}catch(e){}
  return '';
}
function splitRef(ref){
  const s=(ref||'').trim();if(!s) return {book:'',chap:''};
  const m=s.match(/^(.+?)\s+(.+)$/);if(m) return {book:m[1],chap:m[2]};
  return {book:s,chap:''};
}

async function startSecondRound(){
  if(isSpinning) return;
  secondBtn.classList.remove('blinking');

  if(phase!=='firstDone'||!selectedName){alert('è«‹å…ˆå®Œæˆç¬¬ä¸€è¼ªï¼');return;}

  centerOverlay.style.display='none'; // åœä¸‹æ‰é¡¯ç¤ºï¼Œé¿å…â€œä½œå¼Šæ„Ÿâ€
  const v=pickVerse();
  if(!v){alert('128 å€‹ç¶“å¥éƒ½å·²æŠ½å®Œï¼');return;}
  selectedVerse=v;

  setStatus('ç¬¬ 2 è¼ªï¼šç¥ç¦ç¶“å¥è¼ªç›¤æŠ½ç±¤ä¸­â€¦');
  saveState();updateButtons();

  const idx=nameList.indexOf(selectedName); // ç¬¬äºŒè¼ªä»åœåœ¨åŒä¸€å€‹äººï¼ˆåˆ‡ç‰‡å‘½ä¸­ä¸€è‡´ï¼‰
  const durationMs=Math.max(drumDurationMs,5200);
  await spinToIndex({index:idx,clockwise:true,durationMs});

  const ref=getVerseRef(selectedVerse);
  const {book,chap}=splitRef(ref);
  centerBook.textContent=book||'ï¼ˆæ›¸å·ï¼‰';
  centerChap.textContent=chap||ref||'ï¼ˆç« ç¯€ï¼‰';
  centerOverlay.style.display='block';

  usedVerses.push(selectedVerse);
  localStorage.setItem('bc_usedVerses',JSON.stringify(usedVerses));
  saveRecord(selectedName,selectedVerse);

  phase='secondDone';saveState();
  setStatus(`ç¬¬ 2 è¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ${selectedVerse}ã€`);
  updateButtons();
}

function saveRecord(name,verse){
  const logs=JSON.parse(localStorage.getItem('drawLogs')||'[]');
  const ref=getVerseRef(verse);
  logs.push({time:nowTimestamp(),name,verse,ref});
  localStorage.setItem('drawLogs',JSON.stringify(logs));

  if(!usedNames.includes(name)){
    usedNames.push(name);
    localStorage.setItem('bc_usedNames',JSON.stringify(usedNames));
  }

  if(nameList.length && usedNames.length>=nameList.length){
    phase='completed';
    localStorage.setItem('bc_phase','completed');
  }
}

function showCompletedMessage(){
  const n=nameList.length||usedNames.length||0;
  const msg=`ğŸ‰ æ­¤è¼ªè½‰ç›¤å·²å®Œæˆ ${n} ä½çš„ç´…åŒ…æŠ½ç±¤\nğŸ“„ è«‹æŒ‰ã€ŒæŠ½ç±¤ç´€éŒ„ PDFã€ä¸‹è¼‰ç´€éŒ„ï¼Œæˆ–\nğŸ” è¼¸å…¥æ–°å§“å â†’ æŒ‰ã€Œé–å®šåå–®ã€é–‹å§‹ä¸‹ä¸€è¼ªï¼›ä¹Ÿå¯æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€`;
  setStatus(msg,false);
  updateButtons();
}

function gotoViewer(){
  if(!selectedName||!selectedVerse){alert('è«‹å…ˆå®Œæˆç¬¬äºŒè¼ªï¼');return;}
  // å›é¦–é å¾Œå¯ç›´æ¥é–‹å§‹æŠ½ä¸‹ä¸€ä½ï¼ˆä¸å¿…å†é–å®šï¼‰
  localStorage.setItem('bc_phase','firstReady');
  phase='firstReady';
  saveState();updateButtons();
  const url=`viewer.html?name=${encodeURIComponent(selectedName)}&verse=${encodeURIComponent(selectedVerse)}`;
  window.location.href=url;
}

function resetAll(){
  if(!confirm('ç¢ºå®šè¦å…¨éƒ¨æ­¸é›¶å—ï¼Ÿæ‰€æœ‰åå–®/ç´€éŒ„éƒ½æœƒæ¸…ç©ºã€‚')) return;
  localStorage.clear();
  nameList=[];locked=false;usedNames=[];usedVerses=[];selectedName=null;selectedVerse=null;phase='idle';currentRotation=0;
  centerOverlay.style.display='none';
  render();
  setStatus('è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€');
  updateButtons();
}

async function exportPDF(){
  try{
    const ns=window.jspdf;
    if(!ns||!ns.jsPDF){setStatus('PDF ç”¢ç”Ÿå¤±æ•—ï¼šjsPDF è¼‰å…¥å¤±æ•—ã€‚',true);return;}
    const logs=JSON.parse(localStorage.getItem('drawLogs')||'[]');
    if(!Array.isArray(logs)||!logs.length){alert('å°šç„¡æŠ½ç±¤ç´€éŒ„ï¼');return;}

    const {jsPDF}=ns;
    const doc=new jsPDF({unit:'pt',format:'a4'});
    const pageW=doc.internal.pageSize.getWidth();
    const pageH=doc.internal.pageSize.getHeight();

    const scale=2;
    const c=document.createElement('canvas');
    c.width=Math.floor(pageW*scale);
    c.height=Math.floor(pageH*scale);
    const g=c.getContext('2d');

    const margin=40*scale, lineH=22*scale, titleH=28*scale;
    let pageIndex=0, y=margin+titleH;

    function drawHeader(){
      g.fillStyle='#ffffff';g.fillRect(0,0,c.width,c.height);
      g.fillStyle='#4a2f00';
      g.font=`${18*scale}px "Noto Sans TC","Microsoft JhengHei",sans-serif`;
      g.fillText('BlessingCards128 æŠ½ç±¤ç´€éŒ„',margin,margin);
      g.strokeStyle='#e9d2a2';g.lineWidth=2*scale;
      g.beginPath();g.moveTo(margin,margin+10*scale);g.lineTo(c.width-margin,margin+10*scale);g.stroke();
      g.fillStyle='#4a2f00';
      g.font=`${13*scale}px "Noto Sans TC","Microsoft JhengHei",sans-serif`;
    }
    function flushPage(){
      const img=c.toDataURL('image/png');
      if(pageIndex>0) doc.addPage();
      doc.addImage(img,'PNG',0,0,pageW,pageH,undefined,'FAST');
      pageIndex++;
    }
    drawHeader();

    for(const log of logs){
      const ref=log.ref||getVerseRef(log.verse)||'';
      const line=`[${log.time}] ${log.name}ï½œæŠ½ä¸­ç¶“å¥ï¼š${log.verse}${ref?`ï¼ˆ${ref}ï¼‰`:''}`;
      const maxW=c.width-margin*2;
      const chars=Array.from(line);
      let cur='', lines=[];
      for(const ch of chars){
        const t=cur+ch;
        if(g.measureText(t).width>maxW){lines.push(cur);cur=ch;}
        else cur=t;
      }
      if(cur) lines.push(cur);

      for(const ln of lines){
        if(y>c.height-margin){flushPage();drawHeader();y=margin+titleH;}
        g.fillText(ln,margin,y);y+=lineH;
      }
    }
    flushPage();
    doc.save('BlessingCards128_æŠ½ç±¤ç´€éŒ„.pdf');

    pdfBtn.classList.remove('blinking');
    setStatus('PDF å·²ç”¢ç”Ÿä¸¦ä¸‹è¼‰å®Œæˆã€‚');
  }catch(e){
    console.error(e);
    setStatus('PDF ç”¢ç”Ÿå¤±æ•—ï¼šè«‹æŸ¥çœ‹ Console éŒ¯èª¤è¨Šæ¯ã€‚',true);
    alert('PDF ç”¢ç”Ÿå¤±æ•—ï¼šè«‹æŸ¥çœ‹ Console éŒ¯èª¤è¨Šæ¯ã€‚');
  }
}

(function init(){
  loadState();
  render();
  if(locked && nameList.length) setStatus(`åå–®å·²è¼‰å…¥ï¼Œå…± ${nameList.length} ä½`);
  if(locked && nameList.length && usedNames.length>=nameList.length){
    phase='completed';
    localStorage.setItem('bc_phase','completed');
    showCompletedMessage();
  }
  updateButtons();
})();
</script>
</body>
</html>
