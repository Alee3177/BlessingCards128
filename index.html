<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ç¥ç¦ç¶“å¥ç´…åŒ… â€” å–®æ©Ÿæ¥µç°¡ç©©å®šç‰ˆ</title>

<!-- LOGO æœ€é«˜å„ªå…ˆç´šé è¼‰ -->
<link rel="preload" as="image" href="logo3524.png" fetchpriority="high">

<style>
/* ================== UI LOCKED STYLE (DO NOT CHANGE) ================== */
body{
  font-family:"Noto Sans TC",system-ui;
  background:#fbf2df;
  text-align:center;
  margin:0;
  padding:16px;
  color:#5b3a00;
}
.logo{width:220px;margin:10px auto 0;display:block;}

#nameInput{
  width:90%;max-width:480px;padding:10px 14px;
  margin-top:10px;border-radius:10px;border:2px solid #e3c78c;
  font-size:18px;text-align:center;box-sizing:border-box;
}

.btn-row{
  margin-top:8px;
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
}
.btn{
  min-width:110px;
  padding:8px 16px;
  border-radius:999px;
  border:none;
  background:#f4b63a;
  color:#5b3a00;
  font-size:15px;
  font-weight:600;
  box-shadow:0 3px 0 #d59b25;
  cursor:pointer;
}
.btn:disabled{
  background:#f0ddaa;
  cursor:default;
}

.blink-btn{animation:flash .8s infinite alternate;}
@keyframes flash{from{opacity:1}to{opacity:.35}}

#wheel-container{
  position:relative;
  width:360px;
  height:360px;
  margin:16px auto;
}
#wheel{width:360px;height:360px;}
#centerText{
  position:absolute;
  left:0;top:0;width:360px;height:360px;
  display:flex;align-items:center;justify-content:center;
  pointer-events:none;font-size:18px;font-weight:700;white-space:pre-line;
}
#summaryBox{margin-top:10px;white-space:pre-line;font-weight:700;}

.status-bar{
  display:flex;align-items:center;justify-content:center;gap:8px;
  margin:8px auto 4px auto;font-size:14px;font-weight:700;
  transform: scale(1.2);
}
.status-bar .dot{
  width:12px;height:12px;border-radius:50%;background:#999;
  box-shadow:0 0 4px rgba(0,0,0,.3);
}
.status-ok .dot{background:#2e7d32;box-shadow:0 0 8px rgba(46,125,50,.8);}
.status-warn .dot{background:#f9a825;box-shadow:0 0 8px rgba(249,168,37,.8);}
.status-error .dot{background:#c62828;box-shadow:0 0 8px rgba(198,40,40,.8);}
</style>
</head>
<body>

<img id="logo" class="logo"
     src="logo3524.png"
     alt="LOGO"
     loading="eager"
     decoding="sync"
     fetchpriority="high">

<h2>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h2>

<div id="masterStatus" class="status-bar status-ok">
  <span class="dot"></span>
  <span id="status">è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®</span>
</div>

<input id="nameInput" placeholder="è¼¸å…¥å§“åï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰">

<div class="btn-row">
  <button id="lockBtn" class="btn">é–å®šåå–®</button>
  <button id="spinBtn" class="btn" disabled>é–‹å§‹æŠ½å§“å</button>
  <button id="secondBtn" class="btn" disabled>æŠ½ç´…åŒ…</button>
</div>

<div id="wheel-container">
  <canvas id="wheel" width="360" height="360"></canvas>
  <div id="centerText"></div>
</div>

<div id="summaryBox"></div>

<audio id="drum" preload="auto" playsinline src="audio/drum.mp3"></audio>
<audio id="winSound" preload="auto" playsinline src="audio/win.mp3"></audio>

<script>
// =============================
// ğŸ›¡ å–®æ©Ÿæ¥µç°¡ç©©å®šæ ¸å¿ƒ
// =============================

let names = [];
let usedName = new Set();
let rotating = false;
let rotation = 0;
let spinToken = 0;
let animId = null;

const wheel = document.getElementById("wheel");
const ctx = wheel.getContext("2d");
const centerText = document.getElementById("centerText");

const lockBtn = document.getElementById("lockBtn");
const spinBtn = document.getElementById("spinBtn");
const secondBtn = document.getElementById("secondBtn");
const nameInput = document.getElementById("nameInput");
const statusDiv = document.getElementById("status");
const statusBar = document.getElementById("masterStatus");
const summaryBox = document.getElementById("summaryBox");

const drum = document.getElementById("drum");
const winSound = document.getElementById("winSound");

let audioUnlocked = false;

function unlockAudio(){
  if(audioUnlocked) return;
  [drum, winSound].forEach(a=>{
    if(!a) return;
    try{
      a.muted = true;
      a.play().then(()=>{
        a.pause();a.currentTime=0;a.muted=false;
      }).catch(()=>{});
    }catch(e){}
  });
  audioUnlocked = true;
  console.log("ğŸ”“ Audio unlocked");
}

document.addEventListener("pointerdown", unlockAudio, { once:true });

function setStatus(cls, text){
  statusBar.className = "status-bar " + cls;
  statusDiv.textContent = text;
}

function drawWheel(){
  const n = names.length || 1;
  const R = 180;
  ctx.clearRect(0,0,360,360);
  for(let i=0;i<n;i++){
    const a1 = (i/n)*2*Math.PI + rotation;
    const a2 = ((i+1)/n)*2*Math.PI + rotation;
    ctx.beginPath();
    ctx.moveTo(180,180);
    ctx.arc(180,180,R,a1,a2);
    ctx.closePath();
    ctx.fillStyle = i%2 ? "#ffe082" : "#ffd54f";
    ctx.fill();

    ctx.save();
    ctx.translate(180,180);
    ctx.rotate((a1+a2)/2);
    ctx.textAlign = "right";
    ctx.fillStyle = "#5b3a00";
    ctx.font = "14px sans-serif";
    ctx.fillText(names[i] || "", R-10, 5);
    ctx.restore();
  }
}

function spin(list, callback){
  if(!list.length || rotating) return;

  const myToken = ++spinToken;
  if(animId){ cancelAnimationFrame(animId); animId=null; }

  rotating = true;
  setStatus("status-warn","æ—‹è½‰ä¸­...");

  try{
    unlockAudio();
    if(drum){ drum.currentTime=0; drum.play().catch(()=>{}); }
  }catch(e){}

  const target = list[Math.floor(Math.random()*list.length)];
  const idx = list.indexOf(target);

  const base = rotation;
  const delta = 6*Math.PI + idx*(2*Math.PI/list.length);
  const end = base + delta;

  const start = performance.now();
  const DURATION = 3000;

  function frame(now){
    if(myToken !== spinToken) return;
    const t = (now-start)/DURATION;
    if(t>=1){
      rotation = end;
      drawWheel();
      rotating = false;
      callback(target, idx);
      return;
    }
    rotation = base + delta*(1-Math.pow(1-t,3));
    drawWheel();
    animId = requestAnimationFrame(frame);
  }

  animId = requestAnimationFrame(frame);
}

lockBtn.onclick = ()=>{
  const raw = nameInput.value.split(/,|\n/).map(s=>s.trim()).filter(Boolean);
  if(!raw.length) return alert("è«‹è¼¸å…¥å§“å");

  names = raw;
  usedName.clear();

  drawWheel();
  spinBtn.disabled = false;
  spinBtn.classList.add("blink-btn");

  setStatus("status-ok","è«‹é–‹å§‹ç¬¬ä¸€è¼ªæŠ½ç±¤");
};

spinBtn.onclick = ()=>{
  const remain = names.filter(n=>!usedName.has(n));
  if(!remain.length) return alert("å·²æŠ½å®Œ");

  spin(remain, (winner)=>{
    usedName.add(winner);
    centerText.textContent = `ğŸ¯ æŠ½ä¸­ï¼š${winner}`;

    try{
      if(winSound){ winSound.currentTime=0; winSound.play().catch(()=>{}); }
    }catch(e){}

    secondBtn.disabled = false;
    secondBtn.classList.add("blink-btn");
    setStatus("status-ok","è«‹æŠ½ç´…åŒ…");
  });
};

secondBtn.onclick = ()=>{
  centerText.textContent += "\nğŸ“œ è«‹çœ‹ç´…åŒ…åœ–ç‰‡";
  secondBtn.classList.remove("blink-btn");
  setStatus("status-ok","æœ¬ä½å®Œæˆï¼Œè«‹é€²è¡Œä¸‹ä¸€ä½");
};

// =============================
// ğŸš€ å»¶å¾Œé è¼‰ï¼ˆä¸æ¶ LOGO é »å¯¬ï¼‰
// =============================
window.addEventListener("load", ()=>{
  setTimeout(()=>{
    console.log("ğŸ”¥ è³‡æºæš–æ©Ÿä¸­...");

    const p1 = new Audio();
    p1.src = "audio/drum.mp3";

    const p2 = new Audio();
    p2.src = "audio/win.mp3";

    const MAX = (window.innerWidth < 768 ? 12 : 128);
    for(let i=1;i<=MAX;i++){
      const img = new Image();
      img.src = "cards/"+String(i).padStart(3,"0")+".png";
    }
  }, 800);
});

</script>
</body>
</html>
