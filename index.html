<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BlessingCards128ï½œç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰v8.5.4</title>

<style>
  body{
    background:#fff8e7;
    font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    text-align:center;
    padding:22px;
    color:#5b3a00;
  }
  h1{
    color:#b07500;
    font-size:26px;
    margin:0 0 10px 0;
    font-weight:700;
  }
  .logo{
    width:120px;
    margin:8px auto 14px auto;
    display:block;
  }
  #nameInput{
    width:280px;
    padding:10px;
    font-size:18px;
    border-radius:8px;
    border:1px solid #bf8a3e;
    margin-bottom:12px;
    outline:none;
  }
  .btn{
    background:#f7c76c;
    border:none;
    padding:12px 22px;
    border-radius:25px;
    font-size:18px;
    color:#5b3a00;
    cursor:pointer;
    margin:6px;
  }
  .btn:hover{ background:#f3b84f; }
  .btn:disabled{
    opacity:0.45;
    cursor:not-allowed;
  }
  @keyframes blink{
    0%{opacity:1;}
    50%{opacity:0.25;}
    100%{opacity:1;}
  }
  .blinking{ animation:blink 1s infinite; }

  #wheelContainer{
    position:relative;
    width:380px;
    height:380px;
    margin:22px auto 12px auto;
  }
  #wheelCanvas{
    width:380px;
    height:380px;
  }
  #wheelPointer{
    position:absolute;
    top:-26px;
    left:50%;
    transform:translateX(-50%);
    font-size:44px;
    color:red;
    z-index:20;
    line-height:1;
  }

  #statusText{
    font-size:20px;
    margin-top:8px;
    color:#a56b00;
    white-space:pre-line;
  }
  #statusText.error{
    color:#c0392b;
    font-weight:700;
  }

  /* è½‰ç›¤ä¸­é–“é¡¯ç¤ºï¼ˆç¬¬äºŒè¼ªï¼šæ›¸å·/ç« ç¯€ï¼‰ */
  #centerText{
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    text-align:center;
    font-size:20px;
    font-weight:700;
    color:#5b3a00;
    line-height:1.35;
    pointer-events:none;
    white-space:pre-line;
  }
</style>
</head>

<body>
  <h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h1>
  <img src="logo3524.png" class="logo" alt="logo">

  <input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼ˆå¯ç”¨ã€é€—è™Ÿæˆ–ç©ºç™½åˆ†éš”ï¼‰"><br>

  <button id="lockBtn" class="btn" onclick="lockList()">é–å®šåå–®</button>
  <button id="startBtn" class="btn" onclick="startRound1()">é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
  <button id="resetBtn" class="btn" onclick="resetAll()">å…¨éƒ¨æ­¸é›¶</button>
  <button id="pdfBtn" class="btn" onclick="exportPDF()">æŠ½ç±¤ç´€éŒ„ PDF</button>

  <button id="secondBtn" class="btn" style="display:none;" onclick="startRound2()">æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
  <button id="viewerBtn" class="btn" style="display:none;" onclick="gotoViewer()">çœ‹ç´…åŒ…å…§å®¹</button>

  <div id="wheelContainer">
    <div id="wheelPointer">â–¼</div>
    <canvas id="wheelCanvas" width="380" height="380"></canvas>
    <div id="centerText"></div>
  </div>

  <div id="statusText">è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€</div>

  <script src="verseRefMap.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* -------------------------------------------------------
   v8.5.4 Stable Final
   æ ¸å¿ƒä¿®æ­£ï¼š
   1) drawWheel åˆ‡ç‰‡èµ·å§‹è§’ = -PI/2 - arc/2 è®“ã€Œæ¯æ ¼ä¸­å¿ƒã€å°æº–12é»æŒ‡é‡
   2) spinToIndex ç›®æ¨™ä¸­å¿ƒè§’ = targetIndex*arc - PI/2ï¼ˆèˆ‡ drawWheel å®Œå…¨ä¸€è‡´ï¼‰
   3) currentRotation å¿…é ˆè¨˜éŒ„ã€ŒstartRotation + deltaRotationã€ï¼Œé¿å…åç§»ä¸€æ ¼
-------------------------------------------------------- */

const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");
const CENTER = 190;
const RADIUS = 180;

const nameInput = document.getElementById("nameInput");
const lockBtn = document.getElementById("lockBtn");
const startBtn = document.getElementById("startBtn");
const resetBtn = document.getElementById("resetBtn");
const pdfBtn = document.getElementById("pdfBtn");
const secondBtn = document.getElementById("secondBtn");
const viewerBtn = document.getElementById("viewerBtn");
const statusText = document.getElementById("statusText");
const centerText = document.getElementById("centerText");

// ---------------------- ç‹€æ…‹è³‡æ–™ -----------------------
let nameList = [];
let locked = false;

let usedNames = [];     // æœ¬è¼ªå·²æŠ½éçš„äººï¼ˆæ¯è¼ªæœƒé‡ç½®ï¼‰
let usedVerses = [];    // å…¨å±€ä¸é‡è¤‡ï¼ˆè·¨è¼ªä¿ç•™ï¼Œç›´åˆ°å…¨éƒ¨æ­¸é›¶ï¼‰
let drawLogs = [];      // å…¨å±€ç´¯ç©ï¼ˆè·¨è¼ªä¿ç•™ï¼Œç›´åˆ°å…¨éƒ¨æ­¸é›¶ï¼‰

let currentRotation = 0;  // è¼ªç›¤ç›®å‰è§’åº¦ï¼ˆè·¨ç¬¬ä¸€è¼ª/ç¬¬äºŒè¼ªå…±ç”¨ï¼‰
let selectedName = null;
let selectedVerse = null;

let isSpinning = false;
let stage = "idle"; // idle | round1_done_wait_round2 | round2_done_wait_view

// ---------------------- éŸ³æ•ˆ ---------------------------
let drumAudio = null;
async function playDrum(){
  try{
    if(drumAudio){
      drumAudio.pause();
      drumAudio.currentTime = 0;
    }
    drumAudio = new Audio("audio/drum.mp3");
    drumAudio.currentTime = 0;
    await drumAudio.play();
  }catch(e){
    // å¿½ç•¥ autoplay é™åˆ¶
  }
}
function stopDrum(){
  try{
    if(drumAudio){
      drumAudio.pause();
      drumAudio.currentTime = 0;
    }
  }catch(e){}
}

// ---------------------- å·¥å…· ---------------------------
function setStatus(msg, isErr=false){
  statusText.classList.toggle("error", !!isErr);
  statusText.textContent = msg;
}
function showCenterText(msg){
  centerText.textContent = msg || "";
}
function disableAll(disabled){
  lockBtn.disabled = disabled;
  startBtn.disabled = disabled;
  resetBtn.disabled = disabled;
  pdfBtn.disabled = disabled;
  secondBtn.disabled = disabled;
  viewerBtn.disabled = disabled;
  nameInput.disabled = disabled;
}

// cubic ease-out
function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }
function normAngle(a){
  const tau = Math.PI*2;
  a = a % tau;
  if(a < 0) a += tau;
  return a;
}

// ---------------------- è½‰ç›¤ç¹ªåœ– -----------------------
function drawWheel(items, rotation, drawText=true){
  ctx.clearRect(0,0,380,380);
  if(!items || items.length === 0) return;

  const count = items.length;
  const arc = (Math.PI*2)/count;

  ctx.save();
  ctx.translate(CENTER, CENTER);
  ctx.rotate(rotation);
  ctx.translate(-CENTER, -CENTER);

  for(let i=0;i<count;i++){
    // âœ… v8.5.4ï¼šè®“æ¯ä¸€æ ¼ã€Œä¸­å¿ƒã€å°æº– 12 é»æŒ‡é‡
    const start = arc*i - Math.PI/2 - arc/2;
    const end = start + arc;

    ctx.beginPath();
    ctx.fillStyle = (i % 2 === 0) ? "#fde7b5" : "#fcdca0";
    ctx.moveTo(CENTER, CENTER);
    ctx.arc(CENTER, CENTER, RADIUS, start, end);
    ctx.closePath();
    ctx.fill();

    // åˆ†éš”ç·šï¼ˆç¶­æŒåŸç²—ç´°ï¼‰
    ctx.strokeStyle = "#ffffff";
    ctx.lineWidth = 2;
    ctx.stroke();

    if(drawText){
      ctx.save();
      ctx.translate(CENTER, CENTER);
      const mid = start + arc/2;
      ctx.rotate(mid);
      ctx.textAlign = "right";
      ctx.font = "22px Noto Sans TC";
      ctx.fillStyle = "#5b3a00";
      ctx.fillText(items[i], RADIUS - 22, 10);
      ctx.restore();
    }
  }

  ctx.restore();
}

// ---------------------- localStorage -------------------
function loadState(){
  try{
    const saved = localStorage.getItem("nameList");
    if(saved){
      nameList = JSON.parse(saved);
      locked = true;
      nameInput.value = nameList.join("ã€");
    }
    usedNames = JSON.parse(localStorage.getItem("usedNames") || "[]");
    usedVerses = JSON.parse(localStorage.getItem("usedVerses") || "[]");
    drawLogs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
    currentRotation = parseFloat(localStorage.getItem("currentRotation") || "0") || 0;
    selectedName = localStorage.getItem("selectedName") || null;
    selectedVerse = localStorage.getItem("selectedVerse") || null;
    stage = localStorage.getItem("stage") || "idle";
  }catch(e){}
}
function saveState(){
  try{
    localStorage.setItem("nameList", JSON.stringify(nameList));
    localStorage.setItem("usedNames", JSON.stringify(usedNames));
    localStorage.setItem("usedVerses", JSON.stringify(usedVerses));
    localStorage.setItem("drawLogs", JSON.stringify(drawLogs));
    localStorage.setItem("currentRotation", String(currentRotation));
    localStorage.setItem("selectedName", selectedName || "");
    localStorage.setItem("selectedVerse", selectedVerse || "");
    localStorage.setItem("stage", stage);
  }catch(e){}
}

// ---------------------- åå–®é–å®š ------------------------
function lockList(){
  if(isSpinning) return;

  const raw = nameInput.value.trim();
  if(!raw){
    alert("è«‹è¼¸å…¥å§“åï¼");
    return;
  }

  const arr = raw.split(/[,ã€\s]+/).map(s=>s.trim()).filter(Boolean);

  if(arr.length < 2){
    alert("è‡³å°‘è¦å…©ä½æ‰å¯ä»¥ï¼");
    return;
  }

  // é‡è¤‡æª¢æŸ¥ï¼ˆä¸å…è¨±ï¼‰
  const seen = new Set();
  for(const n of arr){
    if(seen.has(n)){
      alert("Oops, æœ‰å§“åè¢«é‡è¤‡è¼¸å…¥äº†å”·ï¼");
      return;
    }
    seen.add(n);
  }

  nameList = arr;
  locked = true;

  // âœ… è·¨è¼ªç´¯ç©ï¼šé–å®šæ–°ä¸€è¼ªåªé‡ç½® usedNames / selected* / stage / currentRotation
  // ä¸æ¸…ç©º drawLogs / usedVersesï¼ˆé™¤éå…¨éƒ¨æ­¸é›¶ï¼‰
  usedNames = [];
  selectedName = null;
  selectedVerse = null;
  stage = "idle";
  currentRotation = 0;

  saveState();

  drawWheel(nameList, currentRotation, true);
  setStatus(`ğŸ”’ æ–°ä¸€è¼ªåå–®å·²é–å®šï¼Œå…± ${nameList.length} ä½\nè«‹æŒ‰ã€Œé–‹å§‹æŠ½å§“å + ç¶“å¥ã€`);
  startBtn.disabled = false;
  secondBtn.style.display = "none";
  viewerBtn.style.display = "none";
  showCenterText("");
}

// ---------------------- æ ¸å¿ƒæ—‹è½‰ ------------------------
function spinToIndex(items, targetIndex, clockwise, durationMs){
  return new Promise(async (resolve)=>{
    if(isSpinning) return;
    isSpinning = true;
    disableAll(true);

    showCenterText("");

    const count = items.length;
    const arc = (Math.PI*2)/count;

    // âœ… v8.5.4ï¼šslice ä¸­å¿ƒè§’ï¼ˆèˆ‡ drawWheel å®Œå…¨ä¸€è‡´ï¼‰
    // drawWheelï¼šstart = i*arc - PI/2 - arc/2ï¼›ä¸­å¿ƒ mid = start + arc/2 = i*arc - PI/2
    // èˆ‡ drawWheel çš„ã€Œmid = start + arc/2ã€å®Œå…¨å°é½Š
    const targetCenter = targetIndex*arc - Math.PI/2 + arc/2;
    const pointerAngle = -Math.PI/2; // æŒ‡é‡æ–¹å‘ï¼š12é»

    const SPEED_BOOST = 1.35; // +35%ï¼ˆä½ å¯¦æ¸¬ OKï¼‰
    const baseSpins = 4.8;
    const spins = baseSpins * SPEED_BOOST;
    const dir = clockwise ? 1 : -1;

    // è®“ã€Œè©²æ ¼ä¸­å¿ƒã€å°æº–æŒ‡é‡
    // éœ€è¦çš„æœ€çµ‚(æ¨¡2Ï€) rotationï¼š pointerAngle = targetCenter + rotation  => rotation = pointerAngle - targetCenter
    const targetRotationMod = normAngle(pointerAngle - targetCenter);

    const startRotation = currentRotation;
    const startMod = normAngle(startRotation);

    // æœ€çŸ­è·¯å¾‘çš„ baseDeltaï¼Œå†åŠ ä¸Šå¤šåœˆï¼ˆåŒæ–¹å‘ï¼‰
    let baseDelta = targetRotationMod - startMod;
    // è½‰æˆ [-Ï€, Ï€]ï¼ˆè¦–è¦ºè¼ƒè‡ªç„¶ï¼‰
    if(baseDelta > Math.PI) baseDelta -= Math.PI*2;
    if(baseDelta < -Math.PI) baseDelta += Math.PI*2;

    const deltaRotation = baseDelta + dir*(spins*2*Math.PI);

    await playDrum();

    const t0 = performance.now();

    function frame(now){
      let t = (now - t0) / durationMs;
      if(t>1) t = 1;

      const eased = easeOutCubic(t);
      const rot = startRotation + deltaRotation*eased;

      drawWheel(items, rot, true);

      if(t < 1){
        requestAnimationFrame(frame);
      }else{
        // âœ… é—œéµï¼šè¨˜ä½ã€ŒçœŸæ­£åœä¸‹ä¾†çš„è§’åº¦ã€
        currentRotation = startRotation + deltaRotation;
        drawWheel(items, currentRotation, true);

        stopDrum();

        isSpinning = false;
        disableAll(false);
        saveState();
        resolve(currentRotation);
      }
    }

    requestAnimationFrame(frame);
  });
}

// ---------------------- ç¬¬ä¸€è¼ª --------------------------
async function startRound1(){
  if(isSpinning) return;

  if(!locked || nameList.length < 2){
    alert("è«‹å…ˆè¼¸å…¥å§“åä¸¦é–å®šåå–®ï¼");
    return;
  }

  if(stage === "round1_done_wait_round2"){
    // é˜²å‘†ï¼šç¬¬ä¸€è¼ªæŠ½å®Œæœªé€²ç¬¬äºŒè¼ªå‰ä¸å¯å†æŒ‰
    return;
  }

  // æœ¬è¼ªå‰©é¤˜æœªæŠ½çš„äºº
  const remaining = nameList.filter(n => !usedNames.includes(n));
  if(remaining.length === 0){
    // æœ¬è¼ªå·²æŠ½å®Œï¼šæç¤ºä¸‹è¼‰/ä¸‹ä¸€è¼ª
    finishRoundHint();
    return;
  }

  // æŠ½å‡ºæœ¬è¼ªçš„ä¸­çè€…
  const winner = remaining[Math.floor(Math.random()*remaining.length)];
  selectedName = winner;
  selectedVerse = null;

  setStatus("ğŸ¡ ç¬¬ 1 è¼ªï¼šå§“åæŠ½ç±¤ä¸­â€¦");
  secondBtn.style.display = "none";
  viewerBtn.style.display = "none";
  showCenterText("");

  const idx = nameList.indexOf(winner);

  // ç¬¬ä¸€è¼ªï¼šé€†æ™‚é‡
  await spinToIndex(nameList, idx, false, getSpinDurationMs());

  setStatus(`ğŸ¯ ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${winner}ã€`);
  stage = "round1_done_wait_round2";
  saveState();

  // ç¬¬äºŒè¼ªæŒ‰éˆ•é–ƒçˆæé†’
  secondBtn.style.display = "inline-block";
  secondBtn.classList.add("blinking");

  // ç¬¬ä¸€è¼ªçµæŸå¾Œï¼šé–‹å§‹éµä¸å¯æŒ‰ï¼ˆé¿å…é‡è¤‡ï¼‰
  startBtn.disabled = true;
}

// ---------------------- ç¬¬äºŒè¼ª --------------------------
async function startRound2(){
  if(isSpinning) return;

  if(stage !== "round1_done_wait_round2" || !selectedName){
    alert("è«‹å…ˆå®Œæˆç¬¬ä¸€è¼ªï¼");
    return;
  }

  secondBtn.classList.remove("blinking");
  secondBtn.style.display = "none";

  setStatus("ğŸ ç¬¬ 2 è¼ªï¼šç¥ç¦ç¶“å¥æŠ½ç±¤ä¸­â€¦");
  viewerBtn.style.display = "none";
  showCenterText("");

  // æŒ‡é‡å¿…é ˆåœåœ¨ç¬¬ä¸€è¼ªçš„é‚£å€‹äººï¼ˆé †æ™‚é‡è½‰ï¼Œä½†ç›®æ¨™ index å›ºå®šï¼‰
  const idx = nameList.indexOf(selectedName);
  await spinToIndex(nameList, idx, true, getSpinDurationMs());

  // å…§éƒ¨æŠ½ 001-128 ç¶“å¥ï¼ˆä¸é‡è¤‡ï¼Œè·¨è¼ªä¿ç•™ï¼‰
  const all = Object.keys(window.VERSE_REF_MAP || {});
  const available = all.filter(v => !usedVerses.includes(v));
  if(available.length === 0){
    alert("128 å€‹ç¶“å¥éƒ½å·²æŠ½å®Œï¼è«‹æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€é‡æ–°é–‹å§‹ã€‚");
    stage = "idle";
    startBtn.disabled = false;
    saveState();
    return;
  }
  selectedVerse = available[Math.floor(Math.random()*available.length)];
  usedVerses.push(selectedVerse);

  // é¡¯ç¤ºæ›¸å·/ç« ç¯€ï¼ˆåœä¸‹ä¾†æ‰é¡¯ç¤ºï¼Œé¿å…ä½œå¼Šæ„Ÿï¼‰
  const ref = (window.VERSE_REF_MAP && window.VERSE_REF_MAP[selectedVerse]) ? window.VERSE_REF_MAP[selectedVerse] : "";
  // ref ä¾‹å¦‚ï¼šç®´è¨€ 10:22
  // åˆ†å…©è¡Œï¼šæ›¸å· / ç« ç¯€
  const parts = ref.split(/\s+/);
  if(parts.length >= 2){
    showCenterText(parts[0] + "\n" + parts.slice(1).join(" "));
  }else{
    showCenterText(ref);
  }

  setStatus(`âœ… ç¬¬ 2 è¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ${selectedVerse}ã€`);

  // å¯«å…¥ç´€éŒ„ï¼ˆè·¨è¼ªç´¯ç©ï¼‰
  pushLog(selectedName, selectedVerse);

  stage = "round2_done_wait_view";
  saveState();

  viewerBtn.style.display = "inline-block";
  // ç¬¬äºŒè¼ªå®Œæˆå¾Œï¼šé–‹å§‹éµä»ä¸å¯æŒ‰ï¼Œå¿…é ˆå…ˆå» viewer æˆ–ä¸‹ä¸€ä½å›ä¾†æ‰è§£é–
}

// ---------------------- viewer -------------------------
function gotoViewer(){
  if(!selectedName || !selectedVerse){
    alert("è«‹å…ˆå®Œæˆç¬¬äºŒè¼ªï¼");
    return;
  }
  saveState();
  const url = `viewer.html?name=${encodeURIComponent(selectedName)}&verse=${encodeURIComponent(selectedVerse)}`;
  window.location.href = url;
}

// ---------------------- logs / round end ---------------
function getNowTS(){
  const now = new Date();
  const pad = (n)=>String(n).padStart(2,"0");
  return `${now.getFullYear()}/${pad(now.getMonth()+1)}/${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
}

function pushLog(name, verse){
  const ref = (window.VERSE_REF_MAP && window.VERSE_REF_MAP[verse]) ? window.VERSE_REF_MAP[verse] : "";
  drawLogs.push({
    time: getNowTS(),
    name,
    verse,
    ref
  });

  // æœ¬è¼ªæŠ½éçš„äººï¼ˆæœ¬è¼ªç”¨ï¼‰
  if(!usedNames.includes(name)) usedNames.push(name);

  saveState();
}

function finishRoundHint(){
  // æœ¬è¼ªå®Œæˆå¾Œçš„ä¸‰è¡Œæç¤ºï¼ˆä¸å† alertï¼‰
  // ä¸¦è®“ PDF æŒ‰éˆ•é–ƒçˆæé†’ä¸‹è¼‰ï¼Œä½†ä¸é–æ­»
  const doneCount = usedNames.length;
  setStatus(
`ğŸ‰ æ­¤è¼ªè½‰ç›¤å·²å®Œæˆ ${doneCount} ä½çš„ç´…åŒ…æŠ½ç±¤
ğŸ“„ è«‹æŒ‰ã€ŒæŠ½ç±¤ç´€éŒ„ PDFã€ä¸‹è¼‰ç´€éŒ„ï¼Œæˆ–
ğŸ” è¼¸å…¥æ–°å§“å â†’ æŒ‰ã€Œé–å®šåå–®ã€é–‹å§‹ä¸‹ä¸€è¼ªï¼›ä¹Ÿå¯æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€`
  );
  pdfBtn.classList.add("blinking");
  startBtn.disabled = true;
  secondBtn.style.display = "none";
  viewerBtn.style.display = "none";
  stage = "idle";
  saveState();
}

// ---------------------- å…¨éƒ¨æ­¸é›¶ ------------------------
function resetAll(){
  if(isSpinning) return;
  try{ localStorage.clear(); }catch(e){}
  alert("æ‰€æœ‰è³‡æ–™å·²æ¸…ç©ºï¼");
  location.reload();
}

// ---------------------- è½‰å‹•æ™‚é–“ï¼ˆåŒæ­¥ drum.mp3 è§€æ„Ÿï¼‰ ----
function getSpinDurationMs(){
  // å›ºå®šå€¼ï¼ˆä½ è¦æ±‚èˆ‡ drum.mp3 æ›´è²¼è¿‘ï¼‰
  // è‹¥ä½ ä¹‹å¾Œè¦æ”¹æˆã€Œè‡ªå‹•æŠ“éŸ³æª”é•·åº¦ã€ï¼Œæˆ‘ä¹Ÿå¯ä»¥å†å¹«ä½ åšï¼Œä½†é€™ç‰ˆå…ˆç¶­æŒç©©å®šã€‚
  return 5200;
}

// ---------------------- PDFï¼ˆCanvasâ†’åœ–ç‰‡å…¥PDFï¼Œé¿å…äº‚ç¢¼ï¼‰ --
async function exportPDF(){
  try{
    if(!drawLogs || drawLogs.length === 0){
      alert("å°šç„¡ç´€éŒ„");
      return;
    }

    // åŒ¯å‡ºå¾Œå–æ¶ˆé–ƒçˆ
    pdfBtn.classList.remove("blinking");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"pt", format:"a4"});

    // ä»¥ canvas æ–¹å¼ç”Ÿæˆæ¯ä¸€è¡Œï¼ˆé¿å…ä¸­æ–‡å­—å‹å•é¡Œï¼‰
    const lineCanvas = document.createElement("canvas");
    const lctx = lineCanvas.getContext("2d");
    const pageW = 595;   // A4 pt
    const pageH = 842;
    const marginX = 36;
    let y = 44;

    // æ¨™é¡Œ
    lctx.font = "18px Noto Sans TC";
    // ç”¨é»‘è‰²ï¼ˆä½ è¦æ±‚å›ºå®šé»‘è‰²ï¼‰
    lctx.fillStyle = "#000000";

    doc.setFontSize(18);
    doc.text("BlessingCards128 æŠ½ç±¤ç´€éŒ„", marginX, y);
    y += 26;

    // å…§å®¹
    const fontSize = 14;
    const lineH = 22;

    // ç‚ºäº†æ¸…æ™°ï¼šç”¨ 2x ç•«å¸ƒæ¯”ä¾‹å†ç¸®å›ï¼ˆé¿å…æ¨¡ç³Šï¼‰
    const scale = 2;
    lineCanvas.width = (pageW - marginX*2) * scale;
    lineCanvas.height = lineH * scale;

    for(const log of drawLogs){
      const text = `[${log.time}] ${log.name}ï½œæŠ½ä¸­ç¶“å¥ï¼š${log.verse}ï¼ˆ${log.ref || ""}ï¼‰`;

      // æ¸…ç•«å¸ƒ
      lctx.setTransform(1,0,0,1,0,0);
      lctx.clearRect(0,0,lineCanvas.width,lineCanvas.height);

      // èƒŒæ™¯é€æ˜
      // æ–‡å­—é»‘è‰²
      lctx.fillStyle = "#000000";
      lctx.font = `${fontSize*scale}px Noto Sans TC`;
      lctx.textBaseline = "middle";
      lctx.fillText(text, 0, (lineCanvas.height/2));

      const imgData = lineCanvas.toDataURL("image/png");

      // è¶…é å°±æ›é 
      if(y + lineH > pageH - 36){
        doc.addPage();
        y = 44;
      }

      // æ”¾å…¥ PDF
      doc.addImage(imgData, "PNG", marginX, y - (lineH-6), pageW - marginX*2, lineH);
      y += lineH;
    }

    doc.save("BlessingCards128_æŠ½ç±¤ç´€éŒ„.pdf");
  }catch(err){
    console.error(err);
    alert("PDF ç”¢ç”Ÿå¤±æ•—ï¼šè«‹æŸ¥çœ‹ Console éŒ¯èª¤è¨Šæ¯ã€‚");
  }
}

// ---------------------- init ----------------------------
(function init(){
  loadState();

  // åˆå§‹ UI
  if(locked && nameList.length >= 2){
    drawWheel(nameList, currentRotation, true);

    // è‹¥ä¸Šæ¬¡åœåœ¨ round1_done_wait_round2ï¼šæ¢å¾©ç¬¬äºŒè¼ªæŒ‰éˆ•é–ƒçˆã€é–‹å§‹éµ disable
    if(stage === "round1_done_wait_round2"){
      setStatus(`ğŸ¯ ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${selectedName || ""}ã€`);
      secondBtn.style.display = "inline-block";
      secondBtn.classList.add("blinking");
      startBtn.disabled = true;
      viewerBtn.style.display = "none";
    }else if(stage === "round2_done_wait_view"){
      setStatus(`âœ… ç¬¬ 2 è¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ${selectedVerse || ""}ã€`);
      viewerBtn.style.display = "inline-block";
      startBtn.disabled = true;
      secondBtn.style.display = "none";
      secondBtn.classList.remove("blinking");
    }else{
      setStatus(`ğŸ”’ åå–®å·²é–å®šï¼Œå…± ${nameList.length} ä½\nè«‹æŒ‰ã€Œé–‹å§‹æŠ½å§“å + ç¶“å¥ã€`);
      startBtn.disabled = false;
      secondBtn.style.display = "none";
      viewerBtn.style.display = "none";
      secondBtn.classList.remove("blinking");
    }

    // è‹¥æœ¬è¼ªå·²æŠ½å®Œï¼šé¡¯ç¤ºæç¤ºä¸¦è®“ PDF é–ƒçˆ
    if(usedNames.length >= nameList.length && nameList.length > 0){
      finishRoundHint();
    }
  }else{
    drawWheel([], 0, true);
    setStatus("è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€");
    startBtn.disabled = false;
    secondBtn.style.display = "none";
    viewerBtn.style.display = "none";
    showCenterText("");
  }
})();
</script>

</body>
</html>