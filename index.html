<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>祝福經句紅包（BlessingCards128）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    background: #fff9e9;
    font-family: "Noto Sans TC", sans-serif;
    text-align: center;
    padding: 20px;
    color: #5a3d00;
}

h1 {
    font-size: 26px;
    color: #b06b00;
    margin-bottom: 12px;
}

/* 輸入框 */
#nameInput {
    width: 250px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #b4843a;
    font-size: 18px;
    margin-bottom: 10px;
}

/* 按鈕 */
.btn {
    background: #f7c86c;
    padding: 12px 22px;
    border-radius: 25px;
    font-size: 18px;
    color: #5a3d00;
    cursor: pointer;
    border: none;
    margin: 6px;
}
.btn:hover { background: #f5b953; }

#wheelContainer {
    position: relative;
    width: 380px;
    height: 380px;
    margin: 20px auto;
}

#wheelCanvas {
    width: 380px;
    height: 380px;
}

/* 指針 ▼ */
#wheelPointer {
    position: absolute;
    top: -22px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 40px;
    color: red;
    z-index: 10;
}

#statusText {
    font-size: 20px;
    margin-top: 12px;
    color: #b06b00;
}

#lockedList { display: none; }
</style>
</head>

<body>

<h1>祝福經句紅包（BlessingCards128）</h1>
<img src="logo3524.png" width="120" style="margin-bottom:15px;">

<input id="nameInput" placeholder="輸入姓名後按新增">

<button class="btn" onclick="addName()">新增</button>
<button class="btn" onclick="lockList()">鎖定名單</button>
<button class="btn" onclick="resetAll()">全部歸零</button>
<button class="btn" onclick="exportPDF()">抽籤紀錄 PDF</button>

<div id="lockedList"></div>

<div id="wheelContainer">
    <div id="wheelPointer">▼</div>
    <canvas id="wheelCanvas" width="380" height="380"></canvas>
</div>

<div id="statusText">請新增姓名並鎖定名單</div>

<script src="verseRefMap.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


<script>
/* -----------------------
   名單管理
----------------------- */
let nameList = [];
let locked = false;

function addName(){
    let val = document.getElementById("nameInput").value.trim();
    if(val==="") return;

    nameList.push(val);
    document.getElementById("nameInput").value = "";
    alert("已加入：「" + val + "」");
}

function lockList(){
    if(nameList.length < 2){
        alert("至少需要 2 位姓名才能抽籤！");
        return;
    }
    locked = true;
    alert("名單已鎖定，共 " + nameList.length + " 位。");
}

function resetAll(){
    localStorage.removeItem("usedVersesAll");
    localStorage.removeItem("drawLogs");
    alert("已全部清除！");
    location.reload();
}

/* -----------------------
   輪盤繪製
----------------------- */
const CENTER = 190;
const RADIUS = 180;

let canvas = document.getElementById("wheelCanvas");
let ctx = canvas.getContext("2d");

function drawWheel(items){
    let count = items.length;
    let arc = Math.PI * 2 / count;

    ctx.clearRect(0,0,380,380);

    for(let i=0;i<count;i++){
        ctx.beginPath();
        ctx.fillStyle = (i%2===0 ? "#fde7b5" : "#fcdca0");
        ctx.moveTo(CENTER, CENTER);
        ctx.arc(CENTER, CENTER, RADIUS, arc*i, arc*(i+1));
        ctx.fill();

        /* 分隔線 */
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.save();
        ctx.translate(CENTER, CENTER);
        ctx.rotate(arc*i + arc/2);
        ctx.textAlign = "right";
        ctx.font = "22px Noto Sans TC";
        ctx.fillStyle = "#5a3d00";
        ctx.fillText(items[i], RADIUS - 20, 10);
        ctx.restore();
    }
}

function easeOut(t){
    return 1 - Math.pow(1 - t, 3);
}

/* 轉動輪盤 */
function spinWheel(items, clockwise){
    return new Promise(resolve => {

        let count = items.length;
        let arc = Math.PI * 2 / count;

        let base = Math.PI * 8;
        let randomOffset = Math.random() * Math.PI * 4;
        let rotation = base + randomOffset;

        if(clockwise === false) rotation = -rotation;

        let start = performance.now();

        function animate(now){
            let progress = (now - start) / 5000;
            if(progress > 1) progress = 1;

            let angle = rotation * easeOut(progress);

            ctx.save();
            ctx.clearRect(0,0,380,380);
            ctx.translate(CENTER, CENTER);
            ctx.rotate(angle);
            ctx.translate(-CENTER,-CENTER);
            drawWheel(items);
            ctx.restore();

            if(progress < 1){
                requestAnimationFrame(animate);
            } else {
                let raw = angle % (2*Math.PI);
                if(raw < 0) raw += 2*Math.PI;
                let index = Math.floor((count - raw/arc) % count);
                resolve(items[index]);
            }
        }

        requestAnimationFrame(animate);
    });
}

/* -----------------------
   全流程：姓名 → 經句
----------------------- */
async function startDraw(){

    if(!locked){
        alert("請先鎖定名單！");
        return;
    }

    if(nameList.length === 0){
        alert("名單為空！");
        return;
    }

    /* 第一輪：姓名 */
    document.getElementById("statusText").innerText =
        "第 1 輪：姓名輪盤抽籤中…";

    drawWheel(nameList);

    let selectedName = await spinWheel(nameList, false); // 逆時針

    document.getElementById("statusText").innerText =
        "第 1 輪完成：抽中「" + selectedName + "」";

    await new Promise(r=>setTimeout(r,5000));

    /* 第二輪：抽 001~128 經文（使用姓名輪盤的外觀） */
    let verseList = Object.keys(VERSE_REF_MAP);
    let usedVerses = JSON.parse(localStorage.getItem("usedVersesAll") || "[]");
    let available = verseList.filter(v => !usedVerses.includes(v));

    if(available.length === 0){
        alert("128 篇經文已全部抽完！");
        return;
    }

    let wheelDisplay = nameList.map((_,i)=>String(i+1).padStart(3,"0"));

    document.getElementById("statusText").innerText =
        "第 2 輪：祝福經句輪盤（001~128）抽籤中…";

    drawWheel(wheelDisplay);
    await spinWheel(wheelDisplay, true);

    let selectedVerse = 
        available[Math.floor(Math.random()*available.length)];

    document.getElementById("statusText").innerText =
        "第 2 輪完成：抽中經句「" + selectedVerse + "」";

    await new Promise(r=>setTimeout(r,5000));

    /* 記錄 */
    saveRecord(selectedName, selectedVerse, "姓名模式");

    /* 跳 viewer.html */
    window.location = 
        `viewer.html?name=${encodeURIComponent(selectedName)}&verse=${selectedVerse}`;
}

/* 點擊輪盤即可抽籤 */
document.getElementById("wheelContainer").onclick = function(){
    if(locked){
        startDraw();
    }
};

/* 記錄抽籤 */
function saveRecord(name, verse, mode){
    let now = new Date();
    let ts =
        `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,"0")}/`+
        `${now.getDate().toString().padStart(2,"0")} `+
        `${now.getHours().toString().padStart(2,"0")}:${now.getMinutes().toString().padStart(2,"0")}:${now.getSeconds().toString().padStart(2,"0")}`;

    let logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");

    logs.push({
        time: ts,
        name: name,
        verseNo: verse,
        mode: mode
    });

    localStorage.setItem("drawLogs", JSON.stringify(logs));

    let used = JSON.parse(localStorage.getItem("usedVersesAll") || "[]");
    used.push(verse);
    localStorage.setItem("usedVersesAll", JSON.stringify(used));
}

/* -----------------------
   PDF：載入字型
----------------------- */
async function loadFont(){
    const res = await fetch("fonts/NotoSansTC-Regular.ttf");
    const buf = await res.arrayBuffer();
    return btoa(
        new Uint8Array(buf).reduce((data, byte)=>data + String.fromCharCode(byte), "")
    );
}

/* -----------------------
   PDF 輸出（單行 + 置頂筆數）
----------------------- */
async function exportPDF(){

    let logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");

    if(logs.length === 0){
        alert("目前沒有抽籤紀錄！");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        unit: "pt",
        format: "a4"
    });

    const fontData = await loadFont();
    doc.addFileToVFS("NotoSansTC.ttf", fontData);
    doc.addFont("NotoSansTC.ttf", "NotoSansTC", "normal");
    doc.setFont("NotoSansTC");

    let y = 40;
    doc.setFontSize(16);

    /* 置頂筆數 */
    doc.text(`BlessingCards128 抽籤紀錄（共 ${logs.length} 筆）`, 40, y);
    y += 30;

    doc.setFontSize(14);

    logs.forEach(log =>{
        let ref = VERSE_REF_MAP[log.verseNo] || "";
        let line =
            `[${log.time}] ${log.name}｜${log.mode}｜抽中經句：${log.verseNo}` +
            (ref ? `（${ref}）` : "");

        if(y > 780){
            doc.addPage();
            y = 40;
        }

        doc.text(line, 40, y);
        y += 22;
    });

    doc.save("BlessingCards128_抽籤紀錄.pdf");
}
</script>

</body>
</html>
