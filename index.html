<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰- å–®æ©Ÿç©©å®šAç‰ˆï¼ˆè¦–è¦ºé‚„åŸï¼‰</title>

<link rel="preload" as="image" href="logo3524.png">

<style>
:root{
  --bg:#fbf2df;
  --text:#5b3a00;
  --btn:#f4b63a;
  --btnShadow:#d59b25;
  --btnDisabled:#f0ddaa;
  --danger:#E53935;
  --dangerShadow:#B71C1C;
  --blue:#1976D2;
  --blueShadow:#0d47a1;
}
body{
  font-family:"Noto Sans TC",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  background:var(--bg);
  text-align:center;
  margin:0;
  padding:16px;
  color:var(--text);
}
.logo{width:220px;margin:10px auto 0;display:block;}
h2{margin:12px 0 6px 0;}

#masterStatus{
  display:flex;align-items:center;justify-content:center;gap:8px;
  margin:8px auto 4px auto;font-size:14px;font-weight:800;
}
#masterStatus .dot{width:12px;height:12px;border-radius:50%;background:#2e7d32;box-shadow:0 0 8px rgba(46,125,50,.7);}

#nameInput{
  width:90%;max-width:520px;padding:10px 14px;
  margin-top:10px;border-radius:12px;border:2px solid #e3c78c;
  font-size:18px;text-align:center;box-sizing:border-box;
  background:#fffdf8;
}

.btn-row{margin-top:8px;display:flex;justify-content:center;gap:10px;flex-wrap:wrap;}
.btn{
  min-width:130px;
  padding:10px 16px;
  border-radius:999px;
  border:none;
  background:var(--btn);
  color:var(--text);
  font-size:15px;
  font-weight:800;
  box-shadow:0 3px 0 var(--btnShadow);
  cursor:pointer;
}
.btn:disabled{background:var(--btnDisabled);box-shadow:none;cursor:default;}
.btn-pdf-ready{background:var(--blue)!important;color:#fff!important;box-shadow:0 3px 0 var(--blueShadow)!important;}
.btn-reset-danger{background:var(--danger)!important;color:#fff!important;box-shadow:0 3px 0 var(--dangerShadow)!important;}

@keyframes mainBlink{
  0%{opacity:1;transform:scale(1);}
  50%{opacity:.55;transform:scale(1.05);}
  100%{opacity:1;transform:scale(1);}
}
.blink-all{animation:mainBlink 1s infinite;}

#wheel-container{position:relative;width:360px;height:360px;margin:14px auto 10px;}
#wheel{width:360px;height:360px;border-radius:50%;background:#fff;box-shadow:0 10px 25px rgba(0,0,0,.12);}
#confettiCanvas{position:absolute;left:0;top:0;width:360px;height:360px;pointer-events:none;}
#centerText{
  position:absolute;left:0;top:0;width:360px;height:360px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  pointer-events:none;font-size:18px;font-weight:900;white-space:pre-line;
  padding:26px;box-sizing:border-box;
  text-shadow:0 1px 0 rgba(255,255,255,.55);
}

#status{margin-top:8px;font-weight:800;white-space:pre-line;}
#result{margin-top:8px;white-space:pre-line;font-weight:900;}
#summaryBox{margin-top:10px;white-space:pre-line;font-weight:800;}

#redEnvelopePanel{
  display:none;
  margin:18px auto 0;
  max-width:560px;
  padding:12px;
  border:2px solid #f6c453;
  border-radius:12px;
  background:#1a1a1a;
  color:#ffd54f;
  text-align:center;
}
#redEnvelopePanel img{
  max-width:100%;
  border-radius:10px;
  background:#fff;
  padding:6px;
}
</style>

<script src="verseRefMap.js?v=20260105"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
<img src="logo3524.png" class="logo" loading="eager" decoding="async"
     onerror="this.style.display='none'; console.warn('âš  logo3524.png è¼‰å…¥å¤±æ•—');"/>
<h2>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h2>

<div id="masterStatus"><span class="dot"></span><span class="label">å–®æ©Ÿç©©å®šæ¨¡å¼</span></div>

<input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼Œå¯ç”¨ç©ºç™½ / é€—è™Ÿ / æ›è¡Œåˆ†éš”">

<div class="btn-row">
  <button id="lockBtn" class="btn">é–å®šåå–®</button>
  <button id="spinBtn" class="btn" disabled>é–‹å§‹æŠ½å§“åï¼ˆç¬¬ä¸€è¼ªï¼‰</button>
</div>

<div class="btn-row">
  <button id="viewBtn" class="btn" disabled>çœ‹ç´…åŒ…</button>
  <button id="secondBtn" class="btn" disabled>æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
</div>

<div class="btn-row">
  <button id="resetBtn" class="btn">å…¨éƒ¨æ­¸é›¶</button>
  <button id="pdfBtn" class="btn" disabled>æŠ½ç±¤ç´€éŒ„ PDF</button>
</div>

<div id="wheel-container">
  <canvas id="wheel" width="360" height="360"></canvas>
  <canvas id="confettiCanvas" width="360" height="360"></canvas>
  <div id="centerText"></div>
</div>

<div id="status">è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®</div>
<div id="result"></div>
<div id="summaryBox"></div>

<div id="redEnvelopePanel">
  <div style="font-weight:900;margin-bottom:6px;">ğŸ æŠ½ä¸­ç´…åŒ…ç¶“å¥ <span id="envelopeVerse"></span></div>
  <div style="font-size:14px;opacity:.9;margin-bottom:8px;" id="envelopeRef"></div>
  <img id="envelopeImg" alt="red envelope"/>
  <div style="margin-top:10px;">
    <button id="downloadEnvelopeBtn" class="btn">ğŸ“¥ ä¸‹è¼‰ç´…åŒ…åœ–ç‰‡</button>
    <button id="nextPersonBtn" class="btn blink-all">â¡ ä¸‹ä¸€ä½</button>
  </div>
</div>

<audio id="drum" preload="auto" playsinline src="audio/drum.mp3"></audio>
<audio id="winSound" preload="auto" playsinline src="audio/win.mp3"></audio>

<script>
const HISTORY_KEY = "BLESSING_HISTORY_A_VISUAL_V1";
const SYS = { READY:"READY", LOCKED:"LOCKED", R1_DONE:"R1_DONE", R2_DONE:"R2_DONE" };

let sysState = SYS.READY;
let names = [];
let remainingNames = [];
let remainingVerses = [];
let currentName = null;
let currentVerse = null;
let history = [];

const wheel = document.getElementById("wheel");
const ctx = wheel.getContext("2d");
let rotation = 0;
let wheelItems = [];
let rotating = false;
let selectedIndex = null;

function $(id){ return document.getElementById(id); }

function getVerseRef(no){
  try{ if (typeof verseRefMap==="object") return verseRefMap[no]||""; }catch{}
  return "";
}

function genVerses(){
  const a=[]; for(let i=1;i<=128;i++) a.push(String(i).padStart(3,"0")); return a;
}

function unlockAudioOnce(){
  document.removeEventListener("click", unlockAudioOnce);
  ["winSound","drum"].forEach(id=>{
    const a=$(id);
    if(!a) return;
    try{
      a.muted=true;
      const p=a.play();
      if(p&&p.then) p.then(()=>{a.pause();a.currentTime=0;a.muted=false;}).catch(()=>{a.muted=false;});
    }catch{}
  });
}

document.addEventListener("click", unlockAudioOnce, { once:true });

function formatTime(ts){
  const d=new Date(ts);
  return d.toLocaleTimeString("zh-TW",{hour12:false});
}

function loadHistory(){
  try{ const r=localStorage.getItem(HISTORY_KEY); if(r) return JSON.parse(r)||[]; }catch{}
  return [];
}
function saveHistory(){ try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); }catch{} }

function renderHistorySummary(){
  if(!history.length) return "";
  const lines=["ğŸ“Œ æŠ½ç±¤ç´€éŒ„"];
  history.forEach((h,i)=>{
    const ref=h.ref?`ï¼ˆ${h.ref}ï¼‰`:"";
    lines.push(`${String(i+1).padStart(2,"0")}. ${h.name} - ${h.verse} ${ref} ${formatTime(h.ts)}`);
  });
  return lines.join("\n");
}

function drawWheel(){
  const w=wheel.width,h=wheel.height;
  const r=w/2;
  ctx.clearRect(0,0,w,h);
  ctx.save();
  ctx.translate(r,r);
  ctx.rotate(rotation);
  const n=Math.max(1,wheelItems.length);
  const step=(Math.PI*2)/n;

  for(let i=0;i<n;i++){
    const s=i*step,e=s+step;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,r-2,s,e);
    ctx.closePath();
    ctx.fillStyle=i%2?"#fff6dc":"#ffe9b8";
    ctx.fill();
    ctx.strokeStyle="rgba(91,58,0,.2)";
    ctx.stroke();

    ctx.save();
    ctx.rotate(s+step/2);
    ctx.textAlign="right";
    ctx.fillStyle="#5b3a00";
    ctx.font="bold 14px system-ui";
    ctx.fillText(wheelItems[i]||"", r-14, 6);
    ctx.restore();
  }
  ctx.restore();

  if(selectedIndex!==null && !rotating){
    highlightSegment(selectedIndex);
  }
}

function highlightSegment(i){
  const w=wheel.width,r=w/2;
  const n=Math.max(1,wheelItems.length);
  const step=(Math.PI*2)/n;
  ctx.save();
  ctx.translate(r,r);
  const s=i*step+rotation,e=s+step;
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.arc(0,0,r-2,s,e);
  ctx.closePath();
  ctx.fillStyle="rgba(255,193,7,.35)";
  ctx.fill();
  ctx.restore();
}

function getIndexUnderPointer(){
  const n=Math.max(1,wheelItems.length);
  const step=(Math.PI*2)/n;
  const pointer=-Math.PI/2;
  let a=pointer-rotation;
  a=((a%(Math.PI*2))+(Math.PI*2))%(Math.PI*2);
  return Math.floor(a/step);
}

function spinOnce(cb){
  if(rotating) return;
  rotating=true;
  selectedIndex=null;
  $("centerText").textContent="è½‰å‹•ä¸­â€¦";

  try{ $("drum").currentTime=0; $("drum").play(); }catch{}

  const start=rotation;
  const delta=(5+Math.random()*3)*Math.PI*2+Math.random()*Math.PI*2;
  const dur=4200+Math.random()*800;
  const t0=performance.now();

  function ease(x){ return 1-Math.pow(1-x,3); }

  function tick(t){
    const p=Math.min(1,(t-t0)/dur);
    rotation=start+delta*ease(p);
    drawWheel();
    if(p<1) requestAnimationFrame(tick);
    else{
      rotating=false;
      try{$("drum").pause();}catch{}
      selectedIndex=getIndexUnderPointer();
      drawWheel();
      if(cb) cb(selectedIndex);
    }
  }
  requestAnimationFrame(tick);
}

function applyUI(){
  $("spinBtn").disabled=true;
  $("secondBtn").disabled=true;
  $("viewBtn").disabled=true;

  $("viewBtn").classList.remove("blink-all");

  if(sysState===SYS.READY){
    $("lockBtn").disabled=false;
    $("nameInput").disabled=false;
    $("status").textContent="è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®";
  }
  if(sysState===SYS.LOCKED){
    $("lockBtn").disabled=true;
    $("nameInput").disabled=true;
    $("spinBtn").disabled=false;
    $("status").textContent=`å·²é–å®šåå–®ï¼ˆ${remainingNames.length} äººï¼‰\næŒ‰ã€Œé–‹å§‹æŠ½å§“åï¼ˆç¬¬ä¸€è¼ªï¼‰ã€`;
  }
  if(sysState===SYS.R1_DONE){
    $("secondBtn").disabled=false;
    $("status").textContent=`ç¬¬ä¸€è¼ªå®Œæˆï¼š${currentName}\nè«‹æŒ‰ã€ŒæŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰ã€`;
  }
  if(sysState===SYS.R2_DONE){
    $("viewBtn").disabled=false;
    $("viewBtn").classList.add("blink-all");
    const ref=getVerseRef(currentVerse);
    $("status").textContent=`ç¬¬äºŒè¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ${currentVerse}ã€\n${ref||""}`;
  }

  $("pdfBtn").disabled=!history.length;
  $("pdfBtn").classList.toggle("btn-pdf-ready",history.length>0);
  $("resetBtn").classList.toggle("btn-reset-danger",history.length>0||sysState!==SYS.READY);
}

function lockNames(){
  unlockAudioOnce();
  const parts=$("nameInput").value.split(/[\n,ï¼Œ\s]+/).map(s=>s.trim()).filter(Boolean);
  const seen=new Set();
  names=[];
  parts.forEach(p=>{ if(!seen.has(p)){seen.add(p);names.push(p);} });
  if(!names.length){ alert("è«‹è‡³å°‘è¼¸å…¥ä¸€ä½å§“å"); return; }

  remainingNames=[...names];
  remainingVerses=genVerses();
  currentName=null;
  currentVerse=null;
  sysState=SYS.LOCKED;

  wheelItems=[...remainingNames];
  rotation=0;
  selectedIndex=null;
  $("centerText").textContent="ç¬¬ä¸€è¼ªï¼šæŠ½å§“å";
  $("result").textContent="";
  $("summaryBox").textContent=renderHistorySummary();
  drawWheel();
  applyUI();
}

function startRound1(){
  unlockAudioOnce();
  wheelItems=[...remainingNames];
  drawWheel();
  spinOnce(i=>{
    currentName=remainingNames[i];
    remainingNames.splice(i,1);
    $("result").textContent=`âœ… ç¬¬ä¸€è¼ªï¼šæŠ½ä¸­ã€Œ${currentName}ã€`;
    $("centerText").textContent=`ç¬¬ä¸€è¼ªå®Œæˆ\n${currentName}`;
    sysState=SYS.R1_DONE;
    applyUI();
  });
}

function startRound2(){
  unlockAudioOnce();
  wheelItems=[...names];
  drawWheel();
  spinOnce(()=>{
    const idx=Math.floor(Math.random()*remainingVerses.length);
    currentVerse=remainingVerses[idx];
    remainingVerses.splice(idx,1);

    const ref=getVerseRef(currentVerse);
    const ts=Date.now();
    history.push({name:currentName,verse:currentVerse,ref,ts});
    saveHistory();

    $("result").textContent="";
    $("summaryBox").textContent=renderHistorySummary();
    sysState=SYS.R2_DONE;
    applyUI();
  });
}

function showEnvelope(){
  $("viewBtn").classList.remove("blink-all");
  const img=$("envelopeImg");
  const ref=getVerseRef(currentVerse);
  $("envelopeVerse").textContent=currentVerse;
  $("envelopeRef").textContent=ref?`ğŸ“– ${ref}`:"";
  img.onload=()=>{ $("redEnvelopePanel").style.display="block"; try{$("winSound").play();}catch{} };
  img.onerror=()=>alert("æ‰¾ä¸åˆ°åœ–ç‰‡ cards/"+currentVerse+".png");
  img.src="cards/"+currentVerse+".png";
}

function downloadEnvelope(){
  const img=$("envelopeImg");
  if(!img.complete){ alert("åœ–ç‰‡å°šæœªè¼‰å…¥å®Œæˆ"); return; }
  const c=document.createElement("canvas");
  c.width=img.naturalWidth;
  c.height=img.naturalHeight;
  c.getContext("2d").drawImage(img,0,0);
  c.toBlob(b=>{
    const a=document.createElement("a");
    a.href=URL.createObjectURL(b);
    a.download="verse_"+currentVerse+".png";
    a.click();
    URL.revokeObjectURL(a.href);
  });
}

function nextPerson(){
  $("redEnvelopePanel").style.display="none";
  currentName=null;
  currentVerse=null;
  sysState=SYS.LOCKED;
  wheelItems=[...remainingNames];
  $("centerText").textContent="ç¬¬ä¸€è¼ªï¼šæŠ½å§“å";
  drawWheel();
  applyUI();
}

function resetAll(){
  if(!confirm("ç¢ºå®šå…¨éƒ¨æ­¸é›¶ï¼Ÿ")) return;
  localStorage.removeItem(HISTORY_KEY);
  history=[];
  names=[];
  remainingNames=[];
  remainingVerses=genVerses();
  currentName=null;
  currentVerse=null;
  sysState=SYS.READY;
  $("nameInput").value="";
  $("summaryBox").textContent="";
  $("result").textContent="";
  $("redEnvelopePanel").style.display="none";
  wheelItems=[];
  drawWheel();
  applyUI();
}

async function exportPDF(){
  const {jsPDF}=window.jspdf||{};
  if(!jsPDF){ alert("PDF å¼•æ“è¼‰å…¥å¤±æ•—"); return; }
  const pdf=new jsPDF();
  pdf.text("BlessingCards128 Record",20,20);
  let y=40;
  history.forEach((h,i)=>{
    const line=`${i+1}. ${h.name} - ${h.verse} ${h.ref||""} ${formatTime(h.ts)}`;
    pdf.text(line,20,y);
    y+=10;
    if(y>270){ pdf.addPage(); y=20; }
  });
  pdf.save("BlessingCards128_Record_A.pdf");
}

$("lockBtn").onclick=lockNames;
$("spinBtn").onclick=startRound1;
$("secondBtn").onclick=startRound2;
$("viewBtn").onclick=showEnvelope;
$("downloadEnvelopeBtn").onclick=downloadEnvelope;
$("nextPersonBtn").onclick=nextPerson;
$("pdfBtn").onclick=exportPDF;
$("resetBtn").onclick=resetAll;

(function init(){
  history=loadHistory();
  $("summaryBox").textContent=renderHistorySummary();
  $("centerText").textContent="è«‹å…ˆé–å®šåå–®";
  drawWheel();
  applyUI();
})();

/* ===============================
   ğŸ† ç…™ç« / å½©å¸¶å‹•ç•«ï¼ˆå–®æ©Ÿç©©å®šç‰ˆï¼‰
   åªåœ¨ä¸­çèˆ‡é¡¯ç¤ºç´…åŒ…æ™‚è§¸ç™¼
=============================== */
const confettiCanvas = document.getElementById("confettiCanvas");
const cctx = confettiCanvas.getContext("2d");
let particles = [];

function resizeConfetti(){
  confettiCanvas.width = confettiCanvas.offsetWidth;
  confettiCanvas.height = confettiCanvas.offsetHeight;
}
window.addEventListener("resize", resizeConfetti);
resizeConfetti();

function spawnConfetti(count = 80){
  particles = [];
  const w = confettiCanvas.width;
  const h = confettiCanvas.height;
  for(let i=0;i<count;i++){
    particles.push({
      x: w/2,
      y: h/2,
      vx: (Math.random()*2-1) * (3+Math.random()*4),
      vy: (Math.random()*2-1) * (3+Math.random()*4),
      size: 4 + Math.random()*4,
      life: 60 + Math.random()*40,
      color: `hsl(${Math.random()*360},90%,60%)`
    });
  }
}

function drawConfetti(){
  cctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  particles.forEach(p=>{
    cctx.fillStyle = p.color;
    cctx.fillRect(p.x, p.y, p.size, p.size);
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.15;
    p.life--;
  });
  particles = particles.filter(p=>p.life>0);
  if(particles.length>0){
    requestAnimationFrame(drawConfetti);
  }
}

// Hook into events
const _origShowEnvelope = showEnvelope;
showEnvelope = function(){
  spawnConfetti(120);
  drawConfetti();
  _origShowEnvelope();
};

const _origStartRound2 = startRound2;
startRound2 = function(){
  _origStartRound2();
  setTimeout(()=>{
    spawnConfetti(60);
    drawConfetti();
  }, 4300);
};

</script>
</body>
</html>
