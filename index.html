<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</title>

<style>
  body{
    background:#fff8e7;
    font-family:"Noto Sans TC","Microsoft JhengHei",sans-serif;
    text-align:center;
    padding:22px;
    color:#5b3a00;
    margin:0;
  }
  h1{
    color:#b07500;
    font-size:26px;
    margin:0 0 10px 0;
  }
  .logo{
    width:120px;
    margin:8px 0 14px 0;
  }

  #nameInput{
    width:280px;
    padding:10px;
    font-size:18px;
    border-radius:8px;
    border:1px solid #bf8a3e;
    margin-bottom:12px;
    outline:none;
  }

  .btn{
    background:#f7c76c;
    border:none;
    padding:12px 22px;
    border-radius:25px;
    font-size:18px;
    color:#5b3a00;
    cursor:pointer;
    margin:6px;
  }
  .btn:hover{ background:#f3b84f; }
  .btn:disabled{
    opacity:.45;
    cursor:not-allowed;
  }

  @keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.25; }
    100% { opacity: 1; }
  }
  .blinking{ animation: blink 1s infinite; }

  #wheelContainer{
    position:relative;
    width:380px;
    height:380px;
    margin:22px auto;
  }
  #wheelCanvas{
    width:380px;
    height:380px;
  }
  #wheelPointer{
    position:absolute;
    top:-26px;
    left:50%;
    transform:translateX(-50%);
    font-size:44px;
    color:red;
    z-index:20;
  }

  #statusText{
    font-size:18px;
    margin-top:10px;
    color:#a56b00;
    white-space:pre-line;
    line-height:1.6;
  }
</style>
</head>

<body>
  <h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h1>
  <img src="logo3524.png" class="logo" alt="logo" />

  <div>
    <input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼ˆå¯ç”¨ç©ºç™½ã€é€—è™Ÿã€é “è™Ÿåˆ†éš”ï¼‰" />
  </div>

  <div>
    <button class="btn" id="lockBtn" onclick="lockList()">é–å®šåå–®</button>
    <button class="btn" id="startBtn" onclick="startFirstRound()">é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
    <button class="btn" id="pdfBtn" onclick="exportPDF()">æŠ½ç±¤ç´€éŒ„ PDF</button>
    <button class="btn" onclick="resetAll()">å…¨éƒ¨æ­¸é›¶</button>
  </div>

  <div id="wheelContainer">
    <div id="wheelPointer">â–¼</div>
    <canvas id="wheelCanvas" width="380" height="380"></canvas>
  </div>

  <div id="statusText">è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€</div>

<script>
/* =========================
   State
========================= */
let nameList = [];
let locked = false;
let usedNames = [];
let drawLogs = [];
let roundFinished = false;

let isSpinning = false;
let currentRotation = 0; // ä¿ç•™ç›®å‰è¼ªç›¤åœä¸‹ä¾†çš„è§’åº¦ï¼ˆé¿å…ä¸‹ä¸€ä½é–‹å§‹æ™‚ç•«é¢ä¸ä¸€è‡´ï¼‰

/* =========================
   Canvas
========================= */
const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");

const CENTER = 190;
const RADIUS = 180;

const lockBtn = document.getElementById("lockBtn");
const startBtn = document.getElementById("startBtn");
const pdfBtn   = document.getElementById("pdfBtn");
const statusText = document.getElementById("statusText");

/* =========================
   Drum éŸ³æ•ˆï¼ˆåªåœ¨çœŸæ­£é–‹è½‰æ™‚æ’­æ”¾ï¼‰
========================= */
let drumAudio = null;
function playDrum(){
  try{
    if(!drumAudio){
      drumAudio = new Audio("audio/drum.mp3");
      drumAudio.preload = "auto";
    }
    drumAudio.currentTime = 0;
    drumAudio.play().catch(()=>{});
  }catch(e){}
}
function stopDrum(){
  try{
    if(drumAudio){
      drumAudio.pause();
      drumAudio.currentTime = 0;
    }
  }catch(e){}
}

/* =========================
   Utils
========================= */
function tokenize(raw){
  return raw.split(/[\s,ã€]+/).map(s=>s.trim()).filter(Boolean);
}

// éœ€æ±‚ï¼šè‹¥æœ‰é‡è¤‡è¼¸å…¥ï¼Œå¿…é ˆ alert ä¸¦é˜»æ­¢é–å®š
function hasDuplicates(arr){
  const s = new Set();
  for(const x of arr){
    if(s.has(x)) return true;
    s.add(x);
  }
  return false;
}

function saveState(){
  localStorage.setItem("bc_nameList", JSON.stringify(nameList));
  localStorage.setItem("bc_locked", locked ? "1" : "0");
  localStorage.setItem("bc_usedNames", JSON.stringify(usedNames));
  localStorage.setItem("bc_drawLogs", JSON.stringify(drawLogs));
  localStorage.setItem("bc_roundFinished", roundFinished ? "1" : "0");
  localStorage.setItem("bc_rotation", String(currentRotation));
}

function loadState(){
  try{
    const nl = localStorage.getItem("bc_nameList");
    if(nl) nameList = JSON.parse(nl) || [];
    locked = localStorage.getItem("bc_locked") === "1";
    usedNames = JSON.parse(localStorage.getItem("bc_usedNames") || "[]");
    drawLogs  = JSON.parse(localStorage.getItem("bc_drawLogs") || "[]");
    roundFinished = localStorage.getItem("bc_roundFinished") === "1";
    currentRotation = parseFloat(localStorage.getItem("bc_rotation") || "0") || 0;
  }catch(e){
    nameList = [];
    locked = false;
    usedNames = [];
    drawLogs = [];
    roundFinished = false;
    currentRotation = 0;
  }
}

function nowTS(){
  const d = new Date();
  const pad = (n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

/* =========================
   Wheel drawing (base, then rotate outside)
   åˆ†éš”ç·šç²—ç´°ï¼šæ¢å¾©ï¼ˆå›ºå®š 2pxï¼‰
========================= */
function drawWheelBase(items){
  ctx.clearRect(0,0,380,380);
  if(!items || items.length === 0) return;

  const count = items.length;
  const arc = Math.PI * 2 / count;

  for(let i=0;i<count;i++){
    const start = arc * i - Math.PI/2;
    const end   = start + arc;

    ctx.beginPath();
    ctx.moveTo(CENTER, CENTER);
    ctx.arc(CENTER, CENTER, RADIUS, start, end);
    ctx.closePath();
    ctx.fillStyle = (i % 2 === 0) ? "#fde7b5" : "#fcdca0";
    ctx.fill();

    ctx.strokeStyle = "#ffffff";
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.save();
    ctx.translate(CENTER, CENTER);
    const mid = start + arc/2;
    ctx.rotate(mid);
    ctx.textAlign = "right";
    ctx.font = "22px Noto Sans TC";
    ctx.fillStyle = "#5b3a00";
    ctx.fillText(items[i], RADIUS - 22, 10);
    ctx.restore();
  }
}

function renderWheel(items, rotation){
  ctx.save();
  ctx.clearRect(0,0,380,380);
  ctx.translate(CENTER, CENTER);
  ctx.rotate(rotation);
  ctx.translate(-CENTER, -CENTER);
  drawWheelBase(items);
  ctx.restore();
}

/* =========================
   Easing
========================= */
function easeOutCubic(t){
  return 1 - Math.pow(1 - t, 3);
}

/* =========================
   æ ¸å¿ƒï¼šé€£çºŒè‡ªç„¶æ—‹è½‰ï¼Œæœ€å¾Œè‡ªç„¶åœåœ¨ä¸­çæ ¼ä¸­å¿ƒ
   ç›®æ¨™ï¼šæŒ‡é‡åœ¨ä¸Šæ–¹ï¼ˆ-90Â°ï¼‰ï¼Œä¸­çæ ¼ä¸­å¿ƒå°æº–æŒ‡é‡
========================= */
function spinToIndex(items, winnerIndex, durationMs, clockwise){
  return new Promise(resolve=>{
    const n = items.length;
    const step = (Math.PI * 2) / n;

    // ä¸­å¿ƒè§’ï¼ˆä»¥è¼ªç›¤æœªæ—‹è½‰ã€ä¸”ç¬¬0æ ¼å¾ä¸Šæ–¹é–‹å§‹çš„è¨­è¨ˆï¼‰
    // drawWheelBase å·²ç¶“ç”¨ start = i*step - PI/2
    // æ‰€ä»¥ç¬¬ i æ ¼ä¸­å¿ƒè§’ = -PI/2 + (i+0.5)*step
    const sliceCenter = -Math.PI/2 + (winnerIndex + 0.5) * step;

    // æŒ‡é‡åœ¨ä¸Šæ–¹ï¼š-PI/2
    // æ—‹è½‰å¾Œï¼šsliceCenter + rotation == -PI/2
    // => rotation = -PI/2 - sliceCenter
    let targetRotation = (-Math.PI/2) - sliceCenter; // è®“ä¸­å¿ƒå°æº–æŒ‡é‡

    // åŠ ä¸Šå¤šåœˆï¼Œè®“å‹•ç•«è‡ªç„¶
    const extraSpins = 5; // å›ºå®šå¤šåœˆæ›´ç©©
    const dir = clockwise ? 1 : -1;
    targetRotation += dir * extraSpins * Math.PI * 2;

    // å¾ currentRotation é–‹å§‹åˆ° targetRotation çµæŸï¼Œä¿æŒé€£çºŒä¸è·³
    const startRot = currentRotation;
    const endRot = targetRotation;

    const startT = performance.now();
    const duration = durationMs;

    playDrum();

    function frame(now){
      const t = Math.min(1, (now - startT) / duration);
      const eased = easeOutCubic(t);
      const rot = startRot + (endRot - startRot) * eased;

      renderWheel(items, rot);

      if(t < 1){
        requestAnimationFrame(frame);
      }else{
        // æœ€çµ‚è§’åº¦ä¿å­˜ï¼ˆé¿å…ä¸‹ä¸€ä½ç•«é¢è¢«é‡ç•«æˆä¸åŒï¼‰
        currentRotation = endRot % (Math.PI * 2);
        renderWheel(items, currentRotation);
        stopDrum();
        resolve();
      }
    }
    requestAnimationFrame(frame);
  });
}

/* =========================
   UI state update
========================= */
function updateUI(){
  // è‹¥æœªé–å®š
  if(!locked){
    startBtn.disabled = false;
    pdfBtn.disabled = false;
    return;
  }

  // å·²é–å®šä½†æœ¬è¼ªå®Œæˆ
  if(roundFinished){
    startBtn.disabled = true;
    // PDF ä¸é–æ­»ï¼Œåªæé†’é–ƒçˆ
    pdfBtn.classList.add("blinking");
    return;
  }

  // æ­£å¸¸å¯æŠ½
  startBtn.disabled = isSpinning;
  pdfBtn.classList.remove("blinking");
}

/* =========================
   lockList
========================= */
function lockList(){
  if(isSpinning) return;

  const raw = document.getElementById("nameInput").value.trim();
  if(!raw){
    alert("è«‹è¼¸å…¥å§“åï¼");
    return;
  }

  const tokens = tokenize(raw);

  // éœ€æ±‚ï¼šæœ‰é‡è¤‡å°± alert ä¸¦åœæ­¢
  if(hasDuplicates(tokens)){
    alert("Oops, æœ‰å§“åè¢«é‡è¤‡è¼¸å…¥äº†å”·ï¼");
    return;
  }

  if(tokens.length < 2){
    alert("è‡³å°‘éœ€è¦å…©ä½æ‰å¯ä»¥");
    return;
  }

  nameList = tokens;
  locked = true;
  usedNames = [];
  roundFinished = false;
  currentRotation = 0;

  // logs ä¸æ¸…ç©ºï¼ˆä½ è¦å¯ä¸‹è¼‰æ­·å²ï¼‰ï¼Œä½†æ–°ä¸€è¼ªæœƒæ¥è‘—è¨˜
  // è‹¥ä½ è¦æ–°ä¸€è¼ªæ¸…ç©º logsï¼Œæ”¹æˆï¼šdrawLogs = [];
  // ç›®å‰ç¶­æŒï¼šåŒä¸€è¼ªé–å®šå¾Œï¼Œé‡ç®—äººåæŠ½ç±¤ï¼ˆç¬¦åˆä½ ä¹‹å‰ç¿’æ…£ï¼‰

  statusText.innerText = `åå–®å·²é–å®šï¼Œå…± ${nameList.length} ä½`;
  renderWheel(nameList, currentRotation);

  saveState();
  updateUI();
}

/* =========================
   ç¬¬ä¸€è¼ªï¼šæŠ½å§“åï¼ˆé€†æ™‚é‡ï¼‰
========================= */
async function startFirstRound(){
  if(isSpinning) return;

  if(!locked){
    alert("è«‹å…ˆé–å®šåå–®ï¼");
    return;
  }

  if(roundFinished){
    // é¡¯ç¤ºå®Œæˆæç¤ºï¼ˆä¸å†è·³ alertï¼‰
    showFinishedText();
    updateUI();
    return;
  }

  const remaining = nameList.filter(n => !usedNames.includes(n));
  if(remaining.length === 0){
    roundFinished = true;
    saveState();
    showFinishedText();
    updateUI();
    return;
  }

  // æŠ½ä¸­è€…
  const winner = remaining[Math.floor(Math.random() * remaining.length)];
  const winnerIndex = nameList.indexOf(winner);

  isSpinning = true;
  updateUI();

  statusText.innerText = "ç¬¬ 1 è¼ªï¼šå§“åè¼ªç›¤æŠ½ç±¤ä¸­â€¦";
  saveState();

  // è½‰ç›¤ç§’æ•¸ï¼šåŠ é•·ï¼Œè®“éŸ³æ•ˆä¸æœƒæ¯”è½‰ç›¤ä¹…ï¼ˆä½  v8.0 æŒ‡å‡ºå•é¡Œï¼‰
  await spinToIndex(nameList, winnerIndex, 4200, false);

  usedNames.push(winner);

  drawLogs.push({
    time: nowTS(),
    name: winner
  });

  // è‹¥é€™æ¬¡æŠ½å®Œå·²ç¶“æ˜¯æœ€å¾Œä¸€ä½ï¼Œä»è¦é¡¯ç¤ºã€Œç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­XXã€
  statusText.innerText = `ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${winner}ã€`;

  if(usedNames.length >= nameList.length){
    roundFinished = true;
    // æç¤ºæ”¹æˆä½ æŒ‡å®šçš„ä¸‰è¡Œå…§å®¹ï¼ˆä¸‹ä¸€æ¬¡ UI update æœƒè®“ PDF é–ƒï¼‰
    setTimeout(()=>{
      showFinishedText();
      updateUI();
      saveState();
    }, 400);
  }

  isSpinning = false;
  saveState();
  updateUI();
}

/* =========================
   å®Œæˆæç¤ºï¼ˆä½ æŒ‡å®šä¸‰è¡Œç‰ˆæœ¬ï¼‰
========================= */
function showFinishedText(){
  const c = nameList.length;
  statusText.innerText =
`ğŸ‰ æ­¤è¼ªè½‰ç›¤å·²å®Œæˆ ${c} ä½çš„ç´…åŒ…æŠ½ç±¤
ğŸ“„ è«‹æŒ‰ã€ŒæŠ½ç±¤ç´€éŒ„ PDFã€ä¸‹è¼‰ç´€éŒ„ï¼Œæˆ–
ğŸ” è¼¸å…¥æ–°å§“å â†’ æŒ‰ã€Œé–å®šåå–®ã€é–‹å§‹ä¸‹ä¸€è¼ªï¼›ä¹Ÿå¯æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€`;
}

/* =========================
   PDFï¼šç”¨ Canvas ç•«å­— â†’ jsPDF ä»¥åœ–ç‰‡è¼¸å‡ºï¼ˆé¿å…ä¸­æ–‡å­—äº‚ç¢¼ï¼‰
   é€™æœƒå¾ˆç©©å®šï¼Œä¸ä¾è³´å­—å‹ cmap
========================= */
async function exportPDF(){
  try{
    if(!drawLogs || drawLogs.length === 0){
      alert("å°šç„¡æŠ½ç±¤ç´€éŒ„ï¼");
      return;
    }

    // å»ºç«‹é«˜è§£æç•«å¸ƒï¼ˆ2xï¼‰ï¼Œæ–‡å­—å°±ä¸æœƒç³Š
    const scale = 2;
    const pageW = 595;   // A4 pt
    const pageH = 842;
    const margin = 30;

    // ä¸€é å¯æ”¾å¤šå°‘è¡Œï¼ˆç”¨ ptï¼‰
    const lineH = 18;
    const titleH = 36;
    const usableH = pageH - margin*2 - titleH;
    const linesPerPage = Math.floor(usableH / lineH);

    const pages = [];
    for(let i=0;i<drawLogs.length;i+=linesPerPage){
      pages.push(drawLogs.slice(i, i+linesPerPage));
    }

    // ç”¨ jsPDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    for(let p=0;p<pages.length;p++){
      if(p>0) doc.addPage();

      // å…ˆæŠŠé€™é å…§å®¹ç•«åˆ° canvas
      const c = document.createElement("canvas");
      c.width = pageW * scale;
      c.height = pageH * scale;
      const g = c.getContext("2d");

      // èƒŒæ™¯ç™½
      g.fillStyle="#ffffff";
      g.fillRect(0,0,c.width,c.height);

      // æ–‡å­—
      g.fillStyle="#000000";
      g.textBaseline="top";
      g.font = `${14*scale}px "Noto Sans TC","Microsoft JhengHei",sans-serif`;
      g.fillText("BlessingCards128 æŠ½ç±¤ç´€éŒ„", margin*scale, margin*scale);

      g.font = `${11*scale}px "Noto Sans TC","Microsoft JhengHei",sans-serif`;

      let y = (margin + 28) * scale;
      for(const row of pages[p]){
        const line = `[${row.time}] ${row.name}`;
        g.fillText(line, margin*scale, y);
        y += lineH * scale;
      }

      // è½‰æˆåœ–ç‰‡æ”¾å…¥ PDF
      const img = c.toDataURL("image/png");
      doc.addImage(img, "PNG", 0, 0, pageW, pageH, undefined, "FAST");
    }

    doc.save("BlessingCards128_æŠ½ç±¤ç´€éŒ„.pdf");

    // ä¸‹è¼‰å¾Œå–æ¶ˆé–ƒçˆï¼ˆç¬¦åˆä½ çš„éœ€æ±‚ï¼‰
    pdfBtn.classList.remove("blinking");

    statusText.innerText = "âœ… æŠ½ç±¤ç´€éŒ„ PDF å·²ä¸‹è¼‰å®Œæˆ";
  }catch(e){
    console.error(e);
    alert("PDF ç”¢ç”Ÿå¤±æ•—ï¼šè«‹æŸ¥çœ‹ Console éŒ¯èª¤è¨Šæ¯ã€‚");
  }
}

/* =========================
   å…¨éƒ¨æ­¸é›¶
========================= */
function resetAll(){
  stopDrum();
  localStorage.clear();

  nameList = [];
  locked = false;
  usedNames = [];
  drawLogs = [];
  roundFinished = false;
  isSpinning = false;
  currentRotation = 0;

  document.getElementById("nameInput").value = "";
  statusText.innerText = "è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€";
  ctx.clearRect(0,0,380,380);

  pdfBtn.classList.remove("blinking");
  updateUI();
}

/* =========================
   Init
========================= */
(function init(){
  loadState();

  // å¦‚æœæœ‰å·²é–å®šåå–®ï¼Œå›å¡«é¡¯ç¤º
  if(locked && nameList.length){
    document.getElementById("nameInput").value = nameList.join("ã€");
    renderWheel(nameList, currentRotation);

    if(roundFinished){
      showFinishedText();
      pdfBtn.classList.add("blinking");
    }else{
      statusText.innerText = `åå–®å·²è¼‰å…¥ï¼Œå…± ${nameList.length} ä½`;
    }
  }else{
    ctx.clearRect(0,0,380,380);
  }

  updateUI();
})();
</script>
</body>
</html>
