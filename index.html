<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BlessingCards128 - æŠ½ç±¤é¦–é </title>

<link rel="stylesheet" href="fonts/fonts.css">

<style>
  body {
    margin:0;
    background:#fff7e6;
    font-family:"NotoSansTC", sans-serif;
    text-align:center;
    color:#8a5500;
  }
  .container {
    max-width:900px;
    margin:auto;
    padding:20px;
  }
  .logo {
    width:120px;
    margin-top:20px;
  }
  h1 {
    font-size:28px;
    color:#b37500;
    margin-top:10px;
  }
  textarea {
    width:90%;
    height:120px;
    padding:10px;
    font-size:18px;
    border-radius:10px;
    border:1px solid #d0a85c;
    resize:none;
    outline:none;
    font-family:"NotoSansTC";
    background:#fff;
  }
  .btn {
    background:#ffcc66;
    border:none;
    padding:12px 22px;
    border-radius:10px;
    font-size:20px;
    cursor:pointer;
    margin-top:12px;
  }
  .btn:hover { background:#ffdd88; }

  .wheel-wrapper {
    position:relative;
    width:300px;
    margin:15px auto 0 auto;
  }

  /* ğŸ”» å€’ä¸‰è§’æŒ‡é‡ï¼ˆA æ¬¾ç´”ç´…ä¿®æ­£ç‰ˆï¼‰ */
  .pointer {
    position:absolute;
    left:50%;
    top:-30px;
    transform:translateX(-50%) rotate(0deg);
    width:0;
    height:0;
    border-left:18px solid transparent;
    border-right:18px solid transparent;
    border-top:32px solid red; /* æœä¸‹ */
    z-index:20;
  }

  #nameWheel {
    display:block;
    width:100%;
    height:auto;
  }

  #resultArea {
    font-size:26px;
    margin-top:12px;
    min-height:2.5em;
    color:#b37500;
  }

  #verseCount {
    margin-top:8px;
    font-size:16px;
    color:#9a6a00;
  }

  .bottom-buttons {
    margin-top:20px;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:center;
  }
</style>
</head>

<body>
<div class="container">
  <img src="logo3524.png" class="logo" alt="logo" />
  <h1>é£›é·¹å€ 3524 ä¸»17å°çµ„<br>æ­¡è¿ä¾†åˆ°ç´…åŒ…ç¥ç¦ç¶“å¥æŠ½ç±¤</h1>

  <textarea id="nameInput"
    placeholder="è«‹è¼¸å…¥å…¨éƒ¨çµ„å“¡å§“åï¼Œç”¨é€—è™Ÿåˆ†éš”"
    oninput="updateNames()"></textarea>

  <div>
    <button class="btn" onclick="startNameSpin()">é–‹å§‹æŠ½å§“å</button>
    <button class="btn" onclick="goCategory()">åˆ†é¡æŠ½ç±¤</button>
  </div>

  <div id="verseCount"></div>

  <div class="wheel-wrapper">
    <div class="pointer"></div>
    <canvas id="nameWheel" width="300" height="300"></canvas>
  </div>

  <div id="resultArea"></div>

  <div class="bottom-buttons">
    <button class="btn" onclick="resetAll()">å…¨éƒ¨æ­¸é›¶</button>
    <button class="btn" onclick="exportPDF()">æŠ½ç±¤ç´€éŒ„ PDF</button>
  </div>
</div>

<script>
const verseTotal = 128;
/* æŒ‡é‡ï¼šå›ºå®šåœ¨ç•«é¢æœ€ä¸Šæ–¹ï¼Œç®­é ­æœä¸‹ï¼ˆâ–¼ï¼‰ï¼Œå°æ‡‰è§’åº¦ -90Â° = -Math.PI/2 */
const POINTER_ANGLE = -Math.PI / 2;

let canvas, ctx;
let names = [];
let usedNamesAll = [];
let usedVersesAll = [];
let isSpinning = false;
let drumAudio;
let currentWinner = "";

/* åˆå§‹åŒ– */
document.addEventListener("DOMContentLoaded", () => {
  canvas = document.getElementById("nameWheel");
  ctx    = canvas.getContext("2d");
  drumAudio = new Audio("audio/drum.mp3");

  try {
    usedNamesAll  = JSON.parse(localStorage.getItem("usedNamesAll")  || "[]");
    usedVersesAll = JSON.parse(localStorage.getItem("usedVersesAll") || "[]");
  } catch(e) {
    usedNamesAll = [];
    usedVersesAll = [];
  }

  updateVerseCount();
  updateNames();  // å…ˆç•«ä¸€åœˆç©ºç›¤
});

/* æ›´æ–°å·²æŠ½ç¶“å¥æ•¸é‡ */
function updateVerseCount(){
  document.getElementById("verseCount").textContent =
    `å·²æŠ½ç¶“å¥ï¼š${usedVersesAll.length} / ${verseTotal}`;
}

/* è®€å– textarea å…§å§“åï¼Œæ›´æ–° names é™£åˆ—ä¸¦é‡ç•«è¼ªç›¤ */
function updateNames(){
  names = document.getElementById("nameInput").value
            .split(",")
            .map(s => s.trim())
            .filter(s => s.length > 0);

  drawNameWheel(0);  // è§’åº¦ 0ï¼Œå…ˆç•«éœæ­¢ç•«é¢
}

/* ç•«å§“åè¼ªç›¤ï¼šangle = æ•´å€‹è¼ªç›¤ç›®å‰çš„æ—‹è½‰è§’åº¦ï¼ˆå¼§åº¦ï¼‰ */
function drawNameWheel(angle){
  if(!ctx) return;

  ctx.save();
  ctx.clearRect(0, 0, 300, 300);

  ctx.translate(150, 150);
  ctx.rotate(angle);           // åªç”¨ angleï¼Œä¸å†é¡å¤– Â±90Â°
  ctx.translate(-150, -150);

  const count = names.length || 1;
  const arc = 2 * Math.PI / count;

  for(let i = 0; i < count; i++){
    const start = i * arc;
    const end   = start + arc;

    // æ‰‡å½¢èƒŒæ™¯
    ctx.beginPath();
    ctx.moveTo(150, 150);
    ctx.arc(150, 150, 150, start, end);
    ctx.closePath();
    ctx.fillStyle = (i % 2 === 0) ? "#ffe6a1" : "#ffcc66";
    ctx.fill();

    // ç™½è‰²åˆ†éš”ç·š
    ctx.strokeStyle = "#ffffff";
    ctx.lineWidth = 2;
    ctx.stroke();

    // å§“åæ–‡å­—
    const name = names[i];
    if(name){
      const centerAngle = start + arc / 2;

      ctx.save();
      ctx.translate(150, 150);
      ctx.rotate(centerAngle);
      ctx.textAlign = "right";
      ctx.font = "bold 18px NotoSansTC";
      ctx.fillStyle = "#8a5500";
      ctx.fillText(name, 135, 8);
      ctx.restore();
    }
  }

  ctx.restore();
}

/* æŠ½å§“å */
function startNameSpin(){
  if(isSpinning) return;

  // ç¢ºä¿ä½¿ç”¨æœ€æ–°çš„å§“åå…§å®¹
  updateNames();

  if(names.length === 0){
    alert("è«‹å…ˆè¼¸å…¥å§“å");
    return;
  }

  const available = names.filter(n => !usedNamesAll.includes(n));
  if(available.length === 0){
    alert("å…¨éƒ¨å§“åéƒ½å·²æŠ½å®Œï¼è«‹æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€ã€‚");
    return;
  }

  // éš¨æ©Ÿé¸å‡ºä¸€ä½ä¸­çè€…
  const winner = available[Math.floor(Math.random() * available.length)];
  currentWinner = winner;

  const count = names.length;
  const arc   = 2 * Math.PI / count;
  const winnerIndex = names.indexOf(winner);

  // winner åœ¨è¼ªç›¤ä¸Šçš„ã€Œä¸­å¿ƒè§’åº¦ã€(ä»¥ 3 é»é˜æ–¹å‘ç‚º 0 èµ·ç®—)
  const winnerCenterAngle = winnerIndex * arc + arc / 2;

  // æˆ‘å€‘å¸Œæœ›æœ€å¾Œï¼šwinner ä¸­å¿ƒ = æŒ‡é‡æ–¹å‘ï¼ˆPOINTER_ANGLE = -90Â°ï¼‰
  // â‡’ angleFinal + winnerCenterAngle = POINTER_ANGLE
  // â‡’ angleFinal = POINTER_ANGLE - winnerCenterAngle
  const spins = 6;  // é¡å¤–å¤šè½‰å¹¾åœˆæ¯”è¼ƒæœ‰æˆ²
  const angleFinal =
    spins * 2 * Math.PI + (POINTER_ANGLE - winnerCenterAngle);

  let startTime = null;
  const duration = 10000;  // 10 ç§’è½‰å®Œ
  isSpinning = true;

  drumAudio.currentTime = 0;
  drumAudio.play().catch(() => {});

  function animate(ts){
    if(!startTime) startTime = ts;
    const t = Math.min((ts - startTime) / duration, 1);
    const ease = 1 - Math.pow(1 - t, 3); // easeOut
    const angle = ease * angleFinal;

    drawNameWheel(angle);

    if(t < 1){
      requestAnimationFrame(animate);
    }else{
      drumAudio.pause();
      drumAudio.currentTime = 0;
      isSpinning = false;

      // ç¢ºèªç´€éŒ„å§“å
      if(!usedNamesAll.includes(winner)){
        usedNamesAll.push(winner);
        localStorage.setItem("usedNamesAll", JSON.stringify(usedNamesAll));
      }

      showWinner(winner);
    }
  }

  requestAnimationFrame(animate);
}

/* é¡¯ç¤ºä¸­çè€…ï¼Œä¸¦æä¾›ã€ŒæŠ½ç¶“å¥ã€æŒ‰éˆ• */
function showWinner(winner){
  document.getElementById("resultArea").innerHTML =
    `æŠ½ä¸­ï¼š<b>${winner}</b><br><br>
     <button class="btn" onclick="drawVerse()">æŠ½ç´…åŒ…ç¥ç¦ç¶“å¥</button>`;
}

/* æŠ½ç´…åŒ…ç¥ç¦ç¶“å¥ï¼ˆä¸é‡è¤‡ï¼Œ1~128ï¼‰ */
function drawVerse(){
  if(!currentWinner){
    alert("è«‹å…ˆæŠ½å§“å");
    return;
  }

  if(usedVersesAll.length >= verseTotal){
    alert("128 å¼µç¶“å¥å·²å…¨æŠ½å®Œï¼");
    return;
  }

  const remain = [];
  for(let i = 1; i <= verseTotal; i++){
    if(!usedVersesAll.includes(i)) remain.push(i);
  }

  const v = remain[Math.floor(Math.random() * remain.length)];
  usedVersesAll.push(v);
  localStorage.setItem("usedVersesAll", JSON.stringify(usedVersesAll));
  updateVerseCount();

  const padded = String(v).padStart(3, "0");
  const n = encodeURIComponent(currentWinner);

  // ä¸€èˆ¬æŠ½ç±¤ï¼Œåˆ†é¡äº¤çµ¦ viewer è‡ªå·±åˆ¤æ–·
  window.location = `viewer.html?no=${padded}&name=${n}`;
}

/* å…¨ç«™ resetï¼šå§“å + ç¶“å¥ + PDF ç´€éŒ„ */
function resetAll(){
  if(!confirm("ç¢ºå®šå…¨éƒ¨é‡ç½®ï¼Ÿ")) return;

  localStorage.setItem("usedNamesAll", "[]");
  localStorage.setItem("usedVersesAll", "[]");
  localStorage.setItem("drawLogs", "[]");

  usedNamesAll = [];
  usedVersesAll = [];
  currentWinner = "";

  updateVerseCount();
  document.getElementById("resultArea").innerHTML = "";
}

/* å‰å¾€åˆ†é¡æŠ½ç±¤ */
function goCategory(){
  window.location = "index_category.html";
}
</script>

<!-- PDFï¼šå…§åµŒ NotoSansTC.ttf Base64 -->
<script>
/* â˜…â˜…â˜…â˜…â˜… è¶…é•· Base64 å­—å‹ï¼Œå·²å£“ç¸® â˜…â˜…â˜…â˜…â˜… */
const notoFontBase64 = `
AAEAAAAQAQAABAAwRFNJRwAAAAEAAA...ï¼ˆå…§å®¹å¤ªé•·ï¼Œåœ¨æ­¤ç•¥ï¼‰...AAA==
`;

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
function exportPDF(){
  let logs=[];
  try{ logs = JSON.parse(localStorage.getItem("drawLogs") || "[]"); }
  catch(e){ logs=[]; }

  if(!logs.length){
    alert("ç›®å‰æ²’æœ‰æŠ½ç±¤ç´€éŒ„ã€‚");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt",format:"a4"});

  /* åŠ å…¥ä¸­æ–‡å­—å‹ */
  doc.addFileToVFS("NotoSansTC.ttf", notoFontBase64);
  doc.addFont("NotoSansTC.ttf","NotoSansTC","normal");
  doc.setFont("NotoSansTC");

  doc.setFontSize(20);
  doc.text("BlessingCards128 æŠ½ç±¤ç´€éŒ„",40,40);

  doc.setFontSize(12);
  doc.text("ï¼ˆè‡ªå‹•ç”¢ç”Ÿï¼‰",40,60);
  doc.line(40,70,555,70);

  let y = 90;
  const lineHeight=18;

  logs.forEach(log=>{
    const t = `[${log.time}] ã€Œ${log.name}ã€ åœ¨ã€Œ${log.category}ã€æŠ½åˆ° â†’ ${log.verseRef}ï¼ˆ${String(log.verseNo).padStart(3,"0")}.pngï¼‰`;
    const parts = doc.splitTextToSize(t,515);

    parts.forEach(p=>{
      if(y>780){
        doc.addPage();
        doc.setFont("NotoSansTC");
        y=40;
      }
      doc.text(p,40,y);
      y+=lineHeight;
    });
  });

  doc.save("æŠ½ç±¤ç´€éŒ„.pdf");
}
</script>

</body>
</html>
