<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BlessingCards128 - 抽籤首頁</title>

<link rel="stylesheet" href="fonts/fonts.css">

<style>
    body {
        margin:0;
        background:#fff7e6;
        font-family:"NotoSansTC", sans-serif;
        text-align:center;
        color:#8a5500;
    }

    .container {
        max-width:900px;
        margin:auto;
        padding:20px;
    }

    .logo {
        width:120px;
        margin-top:20px;
    }

    h1 {
        font-size:28px;
        color:#b37500;
        margin-top:10px;
    }

    textarea {
        width:90%;
        height:120px;
        padding:10px;
        font-size:18px;
        border-radius:10px;
        border:1px solid #d0a85c;
        resize:none;
        outline:none;
        font-family:"NotoSansTC";
        background:#fff;
    }

    .btn {
        background:#ffcc66;
        border:none;
        padding:12px 22px;
        border-radius:10px;
        font-size:20px;
        cursor:pointer;
        margin-top:12px;
    }
    .btn:hover { background:#ffdd88; }

    /* 紅色朝下箭頭（指標） */
    #pointer {
        width:0; height:0;
        border-left:18px solid transparent;
        border-right:18px solid transparent;
        border-top:none;
        border-bottom:32px solid red;  /* 朝下 */
        margin:auto;
        margin-top:15px;
        position:relative;
        z-index:5;
    }

    #nameWheel {
        margin-top:10px;
        max-width:300px;
    }

    #resultArea {
        font-size:26px;
        margin-top:12px;
        min-height:2.5em;
        color:#b37500;
    }

    #verseCount {
        margin-top:10px;
        font-size:16px;
        color:#9a6a00;
    }
</style>
</head>

<body>
<div class="container">

    <img src="logo3524.png" class="logo" />
    <h1>飛鷹區 3524 主17小組<br>歡迎來到紅包祝福經句抽籤</h1>

    <textarea id="nameInput" placeholder="請輸入全部組員姓名，用逗號分隔"></textarea>

    <div>
        <button class="btn" onclick="startNameSpin()">開始抽姓名</button>
        <button class="btn" onclick="goCategory()">分類抽籤</button>
    </div>

    <div id="verseCount"></div>

    <div id="pointer"></div>
    <canvas id="nameWheel" width="300" height="300"></canvas>

    <div id="resultArea"></div>
    <button class="btn" onclick="resetAll()">全部歸零</button>
    <button class="btn" onclick="exportPDF()">抽籤紀錄 PDF</button>

</div>

<script>
/* -----------------------------------------------------------
   全域變數
----------------------------------------------------------- */
let lastWinner = "";   // 新增：記住最後抽中的姓名
let names = [];
let usedNames = [];
let usedVerses = [];

let drumAudio, winAudio;
let audioReady = false;
let isSpinning = false;

const verseTotal = 128;

/* -----------------------------------------------------------
   Canvas 與 ctx（必須在 init() 之前先取得）
----------------------------------------------------------- */
const canvas = document.getElementById("nameWheel");
const ctx = canvas.getContext("2d");

/* 指標角度（畫面上的紅色箭頭在正上方，朝下） */
const POINTER_ANGLE = -Math.PI / 2;  // 12 點鐘方向

/* -----------------------------------------------------------
   更新已抽經句數量
----------------------------------------------------------- */
function updateVerseCount(){
    document.getElementById("verseCount").textContent =
        `已抽經句：${usedVerses.length} / ${verseTotal}`;
}

/* -----------------------------------------------------------
   畫姓名輪盤
----------------------------------------------------------- */
function drawNameWheel(){
    ctx.clearRect(0,0,300,300);

    names = document.getElementById("nameInput").value
        .split(",")
        .map(s=>s.trim())
        .filter(s=>s.length>0);

    const count = names.length || 1;
    const arc = 2*Math.PI / count;

    for(let i=0;i<count;i++){
        let angle = i*arc;
        ctx.beginPath();
        ctx.moveTo(150,150);
        ctx.fillStyle = i%2===0 ? "#ffe6a1" : "#ffcc66";
        ctx.arc(150,150,150,angle,angle+arc);
        ctx.fill();

        ctx.save();
        ctx.translate(150,150);
        ctx.rotate(angle + arc/2);
        ctx.textAlign="right";
        ctx.font="bold 18px NotoSansTC";
        ctx.fillStyle="#8a5500";
        ctx.fillText(names[i] || " ", 135, 8);
        ctx.restore();
    }
}

/* -----------------------------------------------------------
   初始化
----------------------------------------------------------- */
(function init(){
    let savedV = localStorage.getItem("usedVersesAll");
    if(savedV) usedVerses = JSON.parse(savedV);
    updateVerseCount();
    initAudio();
    drawNameWheel();
})();

/* -----------------------------------------------------------
   音效初始化
----------------------------------------------------------- */
function initAudio(){
    if(audioReady) return;
    drumAudio = new Audio("audio/drum.mp3");
    winAudio  = new Audio("audio/win.mp3"); // 只提供給 drawVerse 使用
    audioReady = true;
}

/* -----------------------------------------------------------
   前往分類頁
----------------------------------------------------------- */
function goCategory(){
    window.location = "index_category.html";
}

/* -----------------------------------------------------------
   開始抽姓名（10 秒旋轉，指針對準得獎者）
----------------------------------------------------------- */
function startNameSpin(){
    if(isSpinning) return;

    names = document.getElementById("nameInput").value
        .split(",")
        .map(s=>s.trim())
        .filter(s=>s.length>0);

    if(names.length===0){
        alert("請先輸入姓名");
        return;
    }

    let available = names.filter(n => !usedNames.includes(n));
    if(available.length === 0){
        alert("全部姓名都抽過了！請按「全部歸零」。");
        return;
    }

    // 播放鼓聲（單獨）
    initAudio();
    drumAudio.currentTime = 0;
    drumAudio.play().catch(()=>{});

    isSpinning = true;

    const idx = Math.floor(Math.random()*available.length);
    const winner = available[idx];
    const winnerIdx = names.indexOf(winner);

    const count = names.length;
    const arc = 2*Math.PI / count;

    // 該姓名所在的區塊中心角度（以原始輪盤座標為基準）
    const centerAngle = winnerIdx * arc + arc/2;

    // 在該區塊內加一點隨機誤差，避免每次停在完全相同位置
    const offset = (Math.random() - 0.5) * arc * 0.4; // ±0.2 個區塊

    // 指針固定在畫面上方（POINTER_ANGLE），
    // 所以最後的旋轉角度要讓「該區塊中心 + 旋轉量 = POINTER_ANGLE」
    // => rotation = POINTER_ANGLE - centerAngle + offset
    const baseRotation = POINTER_ANGLE - centerAngle + offset;

    const spins = 5; // 額外多轉幾圈
    const totalRotation = spins * 2*Math.PI + baseRotation;

    const duration = 10000; // 10 秒
    let startTime = null;

    function animate(ts){
        if(!startTime) startTime = ts;
        const progress = ts - startTime;
        const t = Math.min(progress / duration, 1);
        // 緩動（立方加速減速）
        const ease = t*t*t;
        const current = ease * totalRotation;

        ctx.save();
        ctx.translate(150,150);
        ctx.rotate(current);
        ctx.translate(-150,-150);
        drawNameWheel();
        ctx.restore();

        if(progress < duration){
            requestAnimationFrame(animate);
        } else {
            // 停止鼓聲
            drumAudio.pause();
            drumAudio.currentTime = 0;
            finishDrawName(winner);
            isSpinning = false;
        }
    }

    requestAnimationFrame(animate);
}

/* -----------------------------------------------------------
   抽姓名完成：只顯示中獎者＋抽經句按鈕（不放 win 音效）
----------------------------------------------------------- */
function finishDrawName(winner){
    usedNames.push(winner);
    lastWinner = winner;   // ★ 新增：記住這次抽中的人名

    document.getElementById("resultArea").innerHTML =
        `抽中：<b>${winner}</b><br><br>
        <button class="btn" onclick="drawVerse()">抽紅包祝福經句</button>`;
}

/* -----------------------------------------------------------
   抽紅包經句（只做邏輯與跳轉，音效交給 viewer.html 處理）
----------------------------------------------------------- */
function drawVerse(){
    if(usedVerses.length >= verseTotal){
        alert("128 張經句都已抽完，請歸零再開始！");
        return;
    }

    let remaining = [];
    for(let i=1;i<=verseTotal;i++){
        if(!usedVerses.includes(i)) remaining.push(i);
    }

    const v = remaining[Math.floor(Math.random()*remaining.length)];
    usedVerses.push(v);
    localStorage.setItem("usedVersesAll", JSON.stringify(usedVerses));
    updateVerseCount();

    const padded = v.toString().padStart(3,"0");

    // ★ 把姓名帶進 URL 參數 name
    const nameParam = encodeURIComponent(lastWinner || "");

    window.location = `viewer.html?no=${padded}&name=${nameParam}`;
}

/* -----------------------------------------------------------
   全部歸零
----------------------------------------------------------- */
function resetAll(){
    if(!confirm("確定全部重置嗎？")) return;
    usedNames = [];
    usedVerses = [];
    localStorage.removeItem("usedVersesAll");
    updateVerseCount();
    document.getElementById("resultArea").textContent = "";
}
</script>
<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
function exportPDF(){
    const raw = localStorage.getItem("drawLogs") || "[]";
    let logs;
    try {
        logs = JSON.parse(raw);
    } catch(e){
        logs = [];
    }

    if(!logs.length){
        alert("目前沒有任何抽籤紀錄可以匯出。");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt" });

    doc.setFont("Helvetica", "normal");
    doc.setFontSize(16);
    doc.text("BlessingCards128 抽籤紀錄", 40, 40);
    doc.setFontSize(12);
    doc.text("（由系統自動產生）", 40, 60);
    doc.line(40, 70, 555, 70);

    let y = 90;
    const lineHeight = 18;

    logs.forEach(log => {
        const line = `[${log.time}] 「${log.name}」 在「${log.category}」中抽到 → ${log.verseRef}（${String(log.verseNo).padStart(3,"0")}.png）`;
        const { jsPDF } = window.jspdf;
        const split = doc.splitTextToSize(line, 515);
        split.forEach(part => {
            if (y > 780) {
                doc.addPage();
                y = 40;
            }
            doc.text(part, 40, y);
            y += lineHeight;
        });
    });

    doc.save("抽籤紀錄.pdf");
}
</script>


</body>
</html>
