<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BlessingCards128ï½œç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰ v8.5.2</title>

<style>
  body{
    background:#fff8e7;
    font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    text-align:center;
    padding:22px;
    color:#5b3a00;
  }
  h1{
    color:#b07500;
    font-size:26px;
    margin:10px 0 8px;
  }
  .logo{ width:120px; margin:10px auto 14px; display:block; }

  #nameInput{
    width:280px;
    padding:10px;
    font-size:18px;
    border-radius:8px;
    border:1px solid #bf8a3e;
    margin:10px 0 12px;
    outline:none;
  }

  .btn{
    background:#f7c76c;
    border:none;
    padding:12px 22px;
    border-radius:25px;
    font-size:18px;
    color:#5b3a00;
    cursor:pointer;
    margin:6px;
  }
  .btn:hover{ background:#f3b84f; }
  .btn:disabled{ opacity:.45; cursor:not-allowed; }

  @keyframes blink { 0%{opacity:1} 50%{opacity:.25} 100%{opacity:1} }
  .blinking{ animation:blink 1s infinite; }

  #wheelContainer{
    position:relative;
    width:380px;
    height:380px;
    margin:22px auto;
  }
  #wheelCanvas{ width:380px; height:380px; }
  #wheelPointer{
    position:absolute;
    top:-28px;
    left:50%;
    transform:translateX(-50%);
    font-size:44px;
    color:#d40000;
    z-index:30;
    line-height:1;
    user-select:none;
  }

  #statusText{
    font-size:20px;
    margin-top:8px;
    color:#a56b00;
    white-space:pre-line;
    min-height:56px;
  }
  #statusText.error{ color:#c0392b; font-weight:700; }

  /* ä¸­å¤®å…©è¡Œï¼ˆç¬¬äºŒè¼ªæŠ½ä¸­å¾Œæ‰é¡¯ç¤ºï¼‰ */
  #centerText{
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    width:260px;
    pointer-events:none;
    display:none;
    color:#5b3a00;
    text-align:center;
    font-weight:700;
  }
  #centerText .line1{ font-size:22px; margin-bottom:6px; }
  #centerText .line2{ font-size:22px; }

  /* ç¬¬äºŒè¼ªæŒ‡é‡ä¸‹æ–¹é¡¯ç¤ºã€Œç·¨è™Ÿã€ */
  #badge{
    position:absolute;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    background:#fff;
    padding:6px 14px;
    border-radius:18px;
    font-size:18px;
    display:none;
    box-shadow:0 2px 10px rgba(0,0,0,.06);
    color:#5b3a00;
    pointer-events:none;
    z-index:25;
  }
</style>
</head>

<body>
  <h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h1>
  <img src="logo3524.png" class="logo" alt="logo" />

  <input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼ˆå¯ç”¨ç©ºç™½/é€—è™Ÿ/é “è™Ÿåˆ†éš”ï¼‰" />

  <div>
    <button id="lockBtn" class="btn">é–å®šåå–®</button>
    <button id="startBtn" class="btn">é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
    <button id="resetBtn" class="btn">å…¨éƒ¨æ­¸é›¶</button>
    <button id="pdfBtn" class="btn">æŠ½ç±¤ç´€éŒ„ PDF</button>
  </div>

  <div>
    <button id="secondBtn" class="btn" style="display:none;">æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
    <button id="viewerBtn" class="btn" style="display:none;">çœ‹ç´…åŒ…å…§å®¹</button>
  </div>

  <div id="wheelContainer">
    <div id="wheelPointer">â–¼</div>
    <div id="badge"></div>
    <canvas id="wheelCanvas" width="380" height="380"></canvas>
    <div id="centerText">
      <div class="line1"></div>
      <div class="line2"></div>
    </div>
  </div>

  <div id="statusText">è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€</div>

  <!-- ç¶“æ–‡å°ç…§è¡¨ -->
  <script src="verseRefMap.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* =========================================================
   v8.5.2 Stable 
   - ä¿®å¾©ï¼šåˆ†éš”ç·š/ç‹€æ…‹å­—ä¸è¦‹ã€å°¾æ®µå¤šè·‘ã€ç¬¬äºŒè¼ªé‡ç½®ã€PDF æ­£å¸¸ã€è·¨è¼ªç´¯ç©
   - åƒ…åšé€Ÿåº¦é«”æ„Ÿï¼šè§’é€Ÿåº¦ +30%ï¼ˆåŒ drum é•·åº¦ï¼Œè½‰æ›´å¤šåœˆï¼‰

---> v8.5.3 +é«”æ„Ÿå‡ç´š(2025/12/19)
 * ğŸ”’ STABLE CORE â€” DO NOT MODIFY (v8.5.x)
 *
 * èªªæ˜ï¼š
 * - æŒ‡é‡å‘½ä¸­å·² 100% æ­£ç¢º
 * - ç¬¬ä¸€è¼ª / ç¬¬äºŒè¼ªè¦–è¦ºèˆ‡çµæœä¸€è‡´
 * - ä¸å¯å†æ”¹è§’åº¦å…¬å¼
 * - ä¸å¯å†åŠ  snap / é‡ç•« / è£œè½‰
 * - ä¸å¯åœ¨å‹•ç•«çµå°¾åšä»»ä½• setTimeout ä¿®æ­£
 *
 * å¦‚éœ€å„ªåŒ–ï¼š
 * âœ… åªå…è¨±èª¿æ•´ spins æ•¸å€¼ï¼ˆè½‰é€Ÿï¼‰
 * âŒ ç¦æ­¢å‹• duration æ¯”ä¾‹æˆ– angle è¨ˆç®—
========================================================= */

const $ = (id)=>document.getElementById(id);

const canvas = $("wheelCanvas");
const ctx = canvas.getContext("2d");

const CENTER = 190;
const RADIUS = 180;

const statusText = $("statusText");
const lockBtn = $("lockBtn");
const startBtn = $("startBtn");
const secondBtn = $("secondBtn");
const viewerBtn = $("viewerBtn");
const resetBtn = $("resetBtn");
const pdfBtn = $("pdfBtn");
const badge = $("badge");

const centerText = $("centerText");
const centerLine1 = centerText.querySelector(".line1");
const centerLine2 = centerText.querySelector(".line2");

let nameList = [];
let locked = false;

let usedNames = [];     // æœ¬è¼ªå·²æŠ½éçš„äººï¼ˆæ¯è¼ªæœƒé‡ç½®ï¼‰
let usedVerses = [];    // å…¨å±€ä¸é‡è¤‡ï¼ˆè·¨è¼ªä¿ç•™ï¼Œç›´åˆ°å…¨éƒ¨æ­¸é›¶ï¼‰
let drawLogs = [];      // å…¨å±€ç´¯ç©ï¼ˆè·¨è¼ªä¿ç•™ï¼Œç›´åˆ°å…¨éƒ¨æ­¸é›¶ï¼‰

let selectedName = null;
let selectedVerse = null;

let phase = "idle";     // idle | round1_done_wait_round2 | round2_done_wait_view
let isSpinning = false;

// é€Ÿåº¦é«”æ„Ÿï¼šè§’é€Ÿåº¦ +30%ï¼ˆåŒä¸€æ®µæ™‚é–“è½‰æ›´å¤šåœˆï¼‰
const SPEED_BOOST = 1.30;

// drum éŸ³æ•ˆï¼ˆåªåœ¨çœŸæ­£é–‹å§‹æ—‹è½‰æ™‚æ’­æ”¾ï¼›é¿å…ã€Œæ¸¸æ¨™æ”¾é€²å»å°±è‡ªå‹•æ’­ã€ï¼‰
const drumAudio = new Audio("audio/drum.mp3");
drumAudio.preload = "auto";
drumAudio.playsInline = true;

function setStatus(msg, isErr=false){
  statusText.classList.toggle("error", !!isErr);
  statusText.textContent = msg;
}

function showCenterText(book="", versePart=""){
  if(!book && !versePart){
    centerText.style.display = "none";
    centerLine1.textContent = "";
    centerLine2.textContent = "";
    return;
  }
  centerLine1.textContent = book;
  centerLine2.textContent = versePart;
  centerText.style.display = "block";
}

function showBadge(text=""){
  if(!text){
    badge.style.display = "none";
    badge.textContent = "";
    return;
  }
  badge.textContent = text;
  badge.style.display = "inline-block";
}

function disableAll(disabled){
  // æ³¨æ„ï¼šä¸è¦æŠŠã€Œå…¨éƒ¨æ­¸é›¶ / PDFã€é–æ­»ï¼ˆä½ è¦æ±‚æé†’ä½†ä¸é–æ­»ï¼‰
  lockBtn.disabled = disabled;
  startBtn.disabled = disabled;
  secondBtn.disabled = disabled;
  viewerBtn.disabled = disabled;
}

function saveState(){
  localStorage.setItem("BC128_nameList", JSON.stringify(nameList));
  localStorage.setItem("BC128_locked", locked ? "1" : "0");
  localStorage.setItem("BC128_usedNames", JSON.stringify(usedNames));
  localStorage.setItem("BC128_usedVerses", JSON.stringify(usedVerses));
  localStorage.setItem("BC128_drawLogs", JSON.stringify(drawLogs));
}

function loadState(){
  nameList = JSON.parse(localStorage.getItem("BC128_nameList") || "[]");
  locked = localStorage.getItem("BC128_locked") === "1";
  usedNames = JSON.parse(localStorage.getItem("BC128_usedNames") || "[]");
  usedVerses = JSON.parse(localStorage.getItem("BC128_usedVerses") || "[]");
  drawLogs = JSON.parse(localStorage.getItem("BC128_drawLogs") || "[]");

  if(locked && nameList.length >= 2){
    $("nameInput").value = nameList.join("ã€");
    drawWheel(nameList, 0, true);
    setStatus(`ğŸ”’ æ–°ä¸€è¼ªåå–®å·²é–å®šï¼Œå…± ${nameList.length} ä½\nè«‹æŒ‰ã€Œé–‹å§‹æŠ½å§“å + ç¶“å¥ã€`);
    startBtn.disabled = false;

    // è‹¥æœ¬è¼ªå·²å…¨éƒ¨æŠ½å®Œï¼šé¡¯ç¤ºä¸‰è¡Œæç¤ºï¼ŒPDF é–ƒçˆ
    if(usedNames.length >= nameList.length){
      showRoundDoneHint();
    }
  }else{
    drawWheel([], 0, true);
    setStatus("è«‹è¼¸å…¥å§“åä¸¦æŒ‰ã€Œé–å®šåå–®ã€");
    startBtn.disabled = true;
  }
}

function normalizeNames(raw){
  // æ”¯æ´ï¼šç©ºç™½ã€é€—è™Ÿã€é “è™Ÿã€å…¨å½¢é€—è™Ÿ
  return raw
    .trim()
    .split(/[\s,ï¼Œã€]+/)
    .map(s=>s.trim())
    .filter(Boolean);
}

function hasDuplicates(arr){
  const seen = new Set();
  for(const x of arr){
    if(seen.has(x)) return true;
    seen.add(x);
  }
  return false;
}

/* --------------------------
   ç•«è¼ªç›¤ï¼ˆå«åˆ†éš”ç·šï¼‰
-------------------------- */
function drawWheel(items, rotation=0, drawText=true){
  ctx.clearRect(0,0,380,380);
  if(!items || items.length === 0) return;

  const count = items.length;
  const arc = Math.PI * 2 / count;

  ctx.save();
  ctx.translate(CENTER, CENTER);
  ctx.rotate(rotation);
  ctx.translate(-CENTER, -CENTER);

  for(let i=0;i<count;i++){
    const start = arc*i - Math.PI/2; // 12é»ç‚ºèµ·é»
    const end = start + arc;

    // slice èƒŒæ™¯
    ctx.beginPath();
    ctx.moveTo(CENTER, CENTER);
    ctx.arc(CENTER, CENTER, RADIUS, start, end);
    ctx.closePath();
    ctx.fillStyle = (i%2===0) ? "#fde7b5" : "#fcdca0";
    ctx.fill();

    // åˆ†éš”ç·šï¼ˆå›ºå®šç™½ç·šã€ç²—ç´°å›ºå®šï¼‰
    ctx.beginPath();
    ctx.moveTo(CENTER, CENTER);
    ctx.arc(CENTER, CENTER, RADIUS, start, end);
    ctx.closePath();
    ctx.strokeStyle = "#ffffff";
    ctx.lineWidth = 2;
    ctx.stroke();

    // æ–‡å­—
    if(drawText){
      ctx.save();
      ctx.translate(CENTER, CENTER);
      const mid = start + arc/2;
      ctx.rotate(mid);
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "#5b3a00";
      ctx.font = "22px Noto Sans TC";
      ctx.fillText(items[i], RADIUS - 22, 0);
      ctx.restore();
    }
  }

  ctx.restore();
}

/* --------------------------
   è‡ªç„¶æ¸›é€Ÿæ›²ç·š
-------------------------- */
function easeOutCubic(t){
  return 1 - Math.pow(1-t, 3);
}

/* --------------------------
   æ’­æ”¾ drumï¼šåªåœ¨ spin é–‹å§‹å‘¼å«
-------------------------- */
async function playDrum(){
  try{
    drumAudio.pause();
    drumAudio.currentTime = 0;
    await drumAudio.play();
  }catch(e){
    // iOS/ç€è¦½å™¨å¯èƒ½éœ€è¦æ‰‹å‹¢ï¼›ä¸é˜»å¡æµç¨‹
  }
}

/* --------------------------
   å–å¾— drum é•·åº¦ï¼ˆæ¯«ç§’ï¼‰
-------------------------- */
function getDrumDurationMs(){
  const d = drumAudio.duration;
  if(Number.isFinite(d) && d > 0.2) return Math.round(d*1000);
  // fallbackï¼šä½ ç›®å‰é«”æ„Ÿæœ€æ¥è¿‘çš„å€é–“ï¼ˆå¯å†å¾®èª¿ï¼‰
  return 5200;
}

/* --------------------------
   æ ¸å¿ƒæ—‹è½‰ï¼šä¿è­‰å‘½ä¸­ index çš„ä¸­å¿ƒï¼Œä¸æœƒå¡ç·š
   - duration = drum é•·åº¦ï¼ˆåŒæ­¥çµæŸï¼‰
   - SPEED_BOOSTï¼šåŒæ™‚é–“è½‰æ›´å¤šåœˆï¼ˆè§’é€Ÿåº¦æå‡ï¼‰
-------------------------- */
function spinToIndex(items, targetIndex, clockwise, durationMs){
  return new Promise(async (resolve)=>{
    if(isSpinning) return;
    isSpinning = true;
    disableAll(true);

    showBadge("");
    showCenterText("");

    const count = items.length;
    const arc = (Math.PI*2)/count;

    // ç›®æ¨™ï¼šè©² slice çš„ã€Œä¸­å¿ƒã€
    const targetCenter = targetIndex*arc + arc/2;

    // æŒ‡é‡åœ¨ã€Œæ­£ä¸Šæ–¹ã€(12é»)ã€‚æˆ‘å€‘çš„ slice è§’åº¦ä¹Ÿä»¥ 12é»èµ·ç®—ï¼Œå› æ­¤ï¼š
    // è®“ targetCenter æ—‹è½‰åˆ° 0 (æŒ‡é‡æ–¹å‘) å³å¯
    const pointerAngle = 0;

    // è½‰å¹¾åœˆï¼šåŸºç¤åœˆæ•¸ä¾äººæ•¸åšå¾®èª¿ï¼Œä¸¦å¥—ç”¨ SPEED_BOOST
    const SPEED_BOOST= 1.35; // +35%
    const baseSpins = 4.8;                 // ä½ è¦ºå¾—è‡ªç„¶çš„åŸºåº•
    const spins = baseSpins * SPEED_BOOST; // è§’é€Ÿåº¦ +30% â‡’ åœˆæ•¸ +30%
    const dir = clockwise ? 1 : -1;

    // æœ€çµ‚è§’åº¦ï¼ˆç²¾æº–å‘½ä¸­ï¼‰
    const finalRotation = (pointerAngle - targetCenter) + dir*(spins*2*Math.PI);

    // å¾ç•¶å‰è§’åº¦é–‹å§‹ï¼ˆæ¯æ¬¡éƒ½å¾ 0 èµ·ï¼Œé¿å…ä½ èªªçš„ã€Œé‡ç•«ä½ç½®ä¸åŒã€ï¼‰
    const startRotation = 0;

    // æ’­éŸ³æ•ˆï¼ˆèˆ‡å‹•ç•«åŒæ™‚é–‹å§‹ï¼‰
    await playDrum();

    const t0 = performance.now();

    function frame(now){
      let t = (now - t0) / durationMs;
      if(t>1) t = 1;

      const eased = easeOutCubic(t);
      const rot = startRotation + finalRotation*eased;

      drawWheel(items, rot, true);

      if(t < 1){
        requestAnimationFrame(frame);
      }else{
        // å‹•ç•«çµæŸï¼šç¢ºä¿ç•«é¢åœåœ¨æœ€çµ‚è§’åº¦ï¼ˆä¸åšã€ŒäºŒæ¬¡é‡ç•«è·³å‹•ã€ï¼‰
        drawWheel(items, finalRotation, true);

        // åœæ‰ drumï¼ˆé¿å… drum æ¯”å‹•ç•«é•·/çŸ­é€ æˆä¸ä¸€è‡´ï¼‰
        try{ drumAudio.pause(); }catch(e){}

        isSpinning = false;
        disableAll(false);
        resolve(finalRotation);
      }
    }

    requestAnimationFrame(frame);
  });
}

/* --------------------------
   ç¬¬ä¸€è¼ªï¼šæŠ½å§“åï¼ˆé€†æ™‚é‡ï¼‰
-------------------------- */
async function startRound1(){
  if(!locked){
    alert("è«‹å…ˆé–å®šåå–®ï¼");
    return;
  }
  if(isSpinning) return;

  // æœ¬è¼ªå‰©é¤˜äºº
  const remaining = nameList.filter(n => !usedNames.includes(n));
  if(remaining.length === 0){
    showRoundDoneHint();
    return;
  }

  // é˜²å‘†ï¼šç¬¬ä¸€è¼ªçµæŸåˆ°ç¬¬äºŒè¼ªå‰ï¼Œä¸å…è¨±å†æŒ‰é–‹å§‹ï¼ˆä½ è¦ disableï¼‰
  if(phase === "round1_done_wait_round2"){
    return;
  }

  setStatus("ğŸ² ç¬¬ 1 è¼ªï¼šå§“åè¼ªç›¤æŠ½ç±¤ä¸­â€¦");

  const winner = remaining[Math.floor(Math.random()*remaining.length)];
  const idx = nameList.indexOf(winner);

  // åŒæ­¥ drum é•·åº¦
  const dur = getDrumDurationMs();

  selectedName = null;
  selectedVerse = null;

  await spinToIndex(nameList, idx, false, dur);

  selectedName = winner;
  phase = "round1_done_wait_round2";

  setStatus(`ğŸ¯ ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${winner}ã€`);

  // é¡¯ç¤ºç¬¬äºŒè¼ªæŒ‰éˆ•ï¼ˆé–ƒçˆï¼‰
  secondBtn.style.display = "inline-block";
  secondBtn.classList.add("blinking");

  // ç¬¬ä¸€è¼ªå®Œæˆå¾Œï¼šé–‹å§‹éµå…ˆ disableï¼ˆé¿å…ä½ èªªçš„é‡è¤‡/è·³äººï¼‰
  startBtn.disabled = true;

  saveState();
}

/* --------------------------
   ç¬¬äºŒè¼ªï¼šæŠ½ç´…åŒ…ï¼ˆé †æ™‚é‡ï¼‰
   - å¤–è§€ä»æ˜¯å§“åè¼ªç›¤
   - è½‰å®Œæ‰é¡¯ç¤ºæ›¸å·/ç« ç¯€ï¼ˆé¿å…ã€Œå…ˆå‡ºç¾åƒä½œå¼Šã€ï¼‰
   - æŒ‡é‡åœé»ï¼šä»æ˜¯ã€Œç¬¬ä¸€è¼ªä¸­çè€…ã€é‚£ä¸€æ ¼ï¼ˆç©©å®šä¸€è‡´ï¼‰
-------------------------- */
async function startRound2(){
  if(!selectedName){
    alert("è«‹å…ˆå®Œæˆç¬¬ä¸€è¼ªï¼");
    return;
  }
  if(isSpinning) return;

  // é—œé–‰ç¬¬äºŒè¼ªæŒ‰éˆ•é–ƒçˆ
  secondBtn.classList.remove("blinking");
  secondBtn.style.display = "none";

  setStatus("ğŸ ç¬¬ 2 è¼ªï¼šç¥ç¦ç¶“å¥æŠ½ç±¤ä¸­â€¦");
  showCenterText(""); // é–‹å§‹è½‰æ™‚ä¸é¡¯ç¤º
  showBadge("");      // é–‹å§‹è½‰æ™‚ä¸é¡¯ç¤º

  // æŠ½æœªç”¨éçš„ç¶“å¥ï¼ˆè·¨è¼ªä¸é‡è¤‡ï¼‰
  const allVerses = Object.keys(window.VERSE_REF_MAP || {}).sort();
  const available = allVerses.filter(v => !usedVerses.includes(v));
  if(available.length === 0){
    alert("128 å€‹ç¶“å¥éƒ½å·²æŠ½å®Œï¼è«‹æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€é‡æ–°é–‹å§‹ã€‚");
    return;
  }

  selectedVerse = available[Math.floor(Math.random()*available.length)];
  const ref = window.VERSE_REF_MAP?.[selectedVerse] || "";

  // è§£ææ›¸å·/ç« ç¯€ï¼šä»¥æœ€å¾Œä¸€å€‹ç©ºç™½åˆ†å‰²ï¼ˆå¦‚ï¼šè©©ç¯‡ 118:24ï¼‰
  let book = ref;
  let chap = "";
  const m = ref.match(/^(.+?)\s+(\S+)$/);
  if(m){ book = m[1]; chap = m[2]; }

  // ç¬¬äºŒè¼ªï¼šæŒ‡é‡ä»è¦åœåœ¨ selectedName çš„é‚£æ ¼
  const idx = nameList.indexOf(selectedName);
  const dur = getDrumDurationMs();

  await spinToIndex(nameList, idx, true, dur);

  // è½‰å®Œæ‰é¡¯ç¤ºï¼ˆä½ è¦æ±‚çš„é †åºï¼‰
  showCenterText(book, chap);
  showBadge(`ç·¨è™Ÿã€Œ${selectedVerse}ã€`);

  setStatus(`ğŸ‰ ç¬¬ 2 è¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ${selectedVerse}ã€`);

  // è¨˜éŒ„
  usedVerses.push(selectedVerse);
  saveLog(selectedName, selectedVerse);

  // é¡¯ç¤ºçœ‹ç´…åŒ…
  viewerBtn.style.display = "inline-block";
  phase = "round2_done_wait_view";

  saveState();
}

/* --------------------------
   å„²å­˜æŠ½ç±¤ç´€éŒ„ï¼ˆè·¨è¼ªç´¯ç©ï¼‰
-------------------------- */
function nowStamp(){
  const d = new Date();
  const y = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  const ss = String(d.getSeconds()).padStart(2,"0");
  return `${y}/${mm}/${dd} ${hh}:${mi}:${ss}`;
}

function saveLog(name, verse){
  drawLogs.push({ time: nowStamp(), name, verse });

  // æœ¬è¼ªå·²æŠ½éçš„äºº
  if(!usedNames.includes(name)) usedNames.push(name);

  saveState();
}

/* --------------------------
   çœ‹ç´…åŒ…å…§å®¹ï¼ˆè·³ viewer.htmlï¼‰
-------------------------- */
function gotoViewer(){
  if(!selectedName || !selectedVerse) return;
  // viewer.html ç”±ä½ ç¾æœ‰ç‰ˆæœ¬è™•ç†å³å¯
  location.href = `viewer.html?name=${encodeURIComponent(selectedName)}&verse=${encodeURIComponent(selectedVerse)}`;
}

/* --------------------------
   æœ¬è¼ªå®Œæˆæç¤ºï¼ˆä¸‰è¡Œï¼ŒPDF é–ƒçˆä½†ä¸é–æ­»ï¼‰
-------------------------- */
function showRoundDoneHint(){
  const n = nameList.length;
  setStatus(
`ğŸ‰ æ­¤è¼ªè½‰ç›¤å·²å®Œæˆ ${n} ä½çš„ç´…åŒ…æŠ½ç±¤
ğŸ“„ è«‹æŒ‰ã€ŒæŠ½ç±¤ç´€éŒ„ PDFã€ä¸‹è¼‰ç´€éŒ„ï¼Œæˆ–
ğŸ” è¼¸å…¥æ–°å§“å â†’ æŒ‰ã€Œé–å®šåå–®ã€é–‹å§‹ä¸‹ä¸€è¼ªï¼›ä¹Ÿå¯æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€ã€‚`
  );

  // PDF é–ƒçˆæé†’ï¼ˆä½†ä¸é–æ­»ï¼‰
  pdfBtn.classList.add("blinking");

  // éš±è—ç¬¬äºŒè¼ª/çœ‹ç´…åŒ…
  secondBtn.style.display = "none";
  secondBtn.classList.remove("blinking");
  viewerBtn.style.display = "none";

  // å…è¨±ä¸‹ä¸€è¼ªï¼šä½¿ç”¨è€…ç›´æ¥è¼¸å…¥æ–°åå–®â†’æŒ‰é–å®šåå–®å³å¯ï¼ˆä½ è¦çš„ UXï¼‰
  startBtn.disabled = true;
  phase = "idle";
}

/* --------------------------
   é–å®šåå–®ï¼ˆé–‹å§‹ã€Œæ–°ä¸€è¼ªã€ï¼‰
   è¦å‰‡ï¼šåªæ¸…æœ¬è¼ª usedNames/selectedName/phaseï¼Œä¸æ¸… logs/usedVerses
-------------------------- */
function lockList(){
  if(isSpinning) return;

  const raw = $("nameInput").value;
  const arr = normalizeNames(raw);

  if(arr.length < 2){
    alert("è‡³å°‘è¦æœ‰å…©ä½æ‰å¯ä»¥ï¼");
    return;
  }
  if(hasDuplicates(arr)){
    alert("Oops, æœ‰å§“åé‡è¤‡è¼¸å…¥äº†å”·ï¼");
    return;
  }

  // æ–°ä¸€è¼ª
  nameList = arr;
  locked = true;

  // åªé‡ç½®æœ¬è¼ªç‹€æ…‹
  usedNames = [];
  selectedName = null;
  selectedVerse = null;
  phase = "idle";

  // UI reset
  showCenterText("");
  showBadge("");
  viewerBtn.style.display = "none";
  secondBtn.style.display = "none";
  secondBtn.classList.remove("blinking");

  // PDF ä¸å†é–ƒçˆï¼ˆæ–°ä¸€è¼ªé–‹å§‹æ™‚å…ˆé—œæ‰ï¼›å®Œæˆæ™‚å†äº®ï¼‰
  pdfBtn.classList.remove("blinking");

  drawWheel(nameList, 0, true);
  setStatus(`ğŸ”’ æ–°ä¸€è¼ªåå–®å·²é–å®šï¼Œå…± ${nameList.length} ä½\nè«‹æŒ‰ã€Œé–‹å§‹æŠ½å§“å + ç¶“å¥ã€`);

  startBtn.disabled = false;

  saveState();
}

/* --------------------------
   å…¨éƒ¨æ­¸é›¶ï¼ˆå…¨æ¸…ï¼‰
-------------------------- */
function resetAll(){
  if(isSpinning) return;
  localStorage.removeItem("BC128_nameList");
  localStorage.removeItem("BC128_locked");
  localStorage.removeItem("BC128_usedNames");
  localStorage.removeItem("BC128_usedVerses");
  localStorage.removeItem("BC128_drawLogs");
  location.reload();
}

/* --------------------------
   PDFï¼šCanvas â†’ åœ–ç‰‡ â†’ PDFï¼ˆä¸­æ–‡ä¸äº‚ç¢¼ï¼‰
   - ä¸‹è¼‰å¾Œåœæ­¢é–ƒçˆ
-------------------------- */
async function exportPDF(){
  try{
    if(!drawLogs.length){
      alert("å°šç„¡æŠ½ç±¤ç´€éŒ„ï¼");
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    // ä»¥ Canvas ç•«å­—ï¼ˆé¿å…å­—å‹äº‚ç¢¼ï¼‰
    const pageW = 595;  // A4 pt
    const pageH = 842;

    const padX = 40;
    const padY = 50;
    const lineH = 26;

    const pageCanvas = document.createElement("canvas");
    pageCanvas.width = pageW;
    pageCanvas.height = pageH;
    const pctx = pageCanvas.getContext("2d");

    function drawPage(lines){
      pctx.clearRect(0,0,pageW,pageH);
      // èƒŒæ™¯ç™½
      pctx.fillStyle = "#ffffff";
      pctx.fillRect(0,0,pageW,pageH);

      // æ¨™é¡Œ
      pctx.fillStyle = "#000";
      pctx.font = "bold 18px Noto Sans TC, Arial";
      pctx.fillText("BlessingCards128 æŠ½ç±¤ç´€éŒ„", padX, padY);

      pctx.font = "16px Noto Sans TC, Arial";
      let y = padY + 34;

      for(const s of lines){
        pctx.fillText(s, padX, y);
        y += lineH;
      }

      const img = pageCanvas.toDataURL("image/png", 1.0);
      doc.addImage(img, "PNG", 0, 0, pageW, pageH);
    }

    // çµ„è¡Œ
    const allLines = drawLogs.map(log=>{
      const ref = window.VERSE_REF_MAP?.[log.verse] || "";
      return `[${log.time}] ${log.name}ï½œæŠ½ä¸­ç¶“å¥ï¼š${log.verse}ï¼ˆ${ref}ï¼‰`;
    });

    // åˆ†é 
    const maxLinesPerPage = Math.floor((pageH - (padY + 80)) / lineH);
    let i = 0;
    let first = true;
    while(i < allLines.length){
      const chunk = allLines.slice(i, i + maxLinesPerPage);
      if(!first) doc.addPage();
      drawPage(chunk);
      first = false;
      i += maxLinesPerPage;
    }

    doc.save("BlessingCards128_æŠ½ç±¤ç´€éŒ„.pdf");

    // ä¸‹è¼‰å¾Œåœæ­¢é–ƒçˆ
    pdfBtn.classList.remove("blinking");
  }catch(e){
    alert("PDF ç”¢ç”Ÿå¤±æ•—ï¼šè«‹æŸ¥çœ‹ Console éŒ¯èª¤è¨Šæ¯ã€‚");
    console.error(e);
  }
}

/* --------------------------
   æŒ‰éµç¶å®š
-------------------------- */
lockBtn.addEventListener("click", lockList);
startBtn.addEventListener("click", startRound1);
secondBtn.addEventListener("click", startRound2);
viewerBtn.addEventListener("click", gotoViewer);
resetBtn.addEventListener("click", resetAll);
pdfBtn.addEventListener("click", exportPDF);

/* --------------------------
   åˆå§‹åŒ–
-------------------------- */
(function init(){
  // é¿å…ä½ èªªçš„ã€Œæ¸¸æ¨™æ”¾é€²å»å°±æ’­æ”¾ drumã€ï¼š
  // é€™è£¡å®Œå…¨ä¸æ’­æ”¾ä»»ä½•éŸ³æ•ˆï¼Œåª preload
  startBtn.disabled = true;

  loadState();

  // å¦‚æœæœ‰é–å®šä¸”æœªå®Œæˆæœ¬è¼ªï¼Œç¢ºä¿å¯æŒ‰ start
  if(locked && nameList.length >= 2 && usedNames.length < nameList.length){
    startBtn.disabled = false;
  }

  // è‹¥æœ¬è¼ªå·²æŠ½å®Œï¼Œé¡¯ç¤ºå®Œæˆæç¤º
  if(locked && nameList.length >= 2 && usedNames.length >= nameList.length){
    showRoundDoneHint();
  }
})();
</script>
</body>
</html>