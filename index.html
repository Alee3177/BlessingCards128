<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆBlessingCards128 v4.5ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    background: #fff9e9;
    font-family: "Noto Sans TC", sans-serif;
    text-align: center;
    padding: 20px;
    color: #5a3d00;
}

h1 {
    font-size: 26px;
    color: #b06b00;
    margin-bottom: 12px;
}

/* å§“åè¼¸å…¥æ¡† */
#nameInput {
    width: 280px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #b4843a;
    font-size: 18px;
    margin-bottom: 12px;
}

/* é€šç”¨æŒ‰éˆ• */
.btn {
    background: #f7c86c;
    padding: 12px 22px;
    border-radius: 25px;
    font-size: 18px;
    color: #5a3d00;
    cursor: pointer;
    border: none;
    margin: 6px;
}
.btn:hover { background: #f5b953; }

/* è½‰ç›¤å®¹å™¨ */
#wheelContainer {
    position: relative;
    width: 380px;
    height: 380px;
    margin: 25px auto;
}

#wheelCanvas {
    width: 380px;
    height: 380px;
}

/* æŒ‡é‡ â–¼ */
#wheelPointer {
    position: absolute;
    top: -22px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 42px;
    color: red;
    z-index: 10;
}

#statusText {
    font-size: 20px;
    margin-top: 15px;
    color: #b06b00;
}

/* ç¬¬äºŒéšæ®µæŒ‰éˆ•ï¼ˆæŠ½ç´…åŒ… / çœ‹ç´…åŒ…å…§å®¹ï¼‰ */
#stage2Btn {
    display: none;
    margin-top: 15px;
}
#stage3Btn {
    display: none;
    margin-top: 15px;
}
</style>
</head>

<body>

<h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆBlessingCards128ï¼‰</h1>
<img src="logo3524.png" width="120" style="margin-bottom:12px;">


<!-- å§“åè¼¸å…¥ï¼ˆä»¥ ã€ æˆ– , æˆ–ç©ºç™½ åˆ†éš”å¤šäººï¼‰ -->
<input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼Œä»¥ã€Œã€ã€éš”é–‹å¤šäºº">

<br>
<button class="btn" onclick="lockList()">é–å®šåå–®</button>
<button class="btn" onclick="startFirstRound()">é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
<button class="btn" onclick="resetAll()">å…¨éƒ¨æ­¸é›¶</button>
<button class="btn" onclick="exportPDF()">æŠ½ç±¤ç´€éŒ„ PDF</button>

<!-- éšæ®µæŒ‰éˆ• -->
<button id="stage2Btn" class="btn" onclick="startSecondRound()">æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
<button id="stage3Btn" class="btn" onclick="gotoViewer()">çœ‹ç´…åŒ…å…§å®¹</button>


<div id="wheelContainer">
    <div id="wheelPointer">â–¼</div>
    <canvas id="wheelCanvas" width="380" height="380"></canvas>
</div>

<div id="statusText">è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®</div>


<script src="verseRefMap.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


<script>
/* -------------------------------
   0. åå–®åˆå§‹åŒ–ï¼ˆlocalStorageï¼‰
------------------------------- */
let nameList = [];
let locked = false;

/* è‹¥ä¸Šä¸€è¼ªé‚„æ²’çµæŸï¼ˆviewer å›é¦–é ï¼‰ï¼Œè‡ªå‹•è¼‰å…¥åå–® */
if(localStorage.getItem("nameList")){
    nameList = JSON.parse(localStorage.getItem("nameList"));
    locked = true;
    document.getElementById("statusText").innerText =
        "åå–®å·²è¼‰å…¥ï¼Œå…± " + nameList.length + " ä½ã€‚";
    drawWheel(nameList);
}


/* -------------------------------
   1. é–å®šåå–®ï¼ˆä¸éœ€è¦æ–°å¢æŒ‰éˆ•ï¼‰
------------------------------- */
function lockList(){
    const input = document.getElementById("nameInput").value.trim();

    if(input === ""){
        alert("è«‹è¼¸å…¥è‡³å°‘ 2 ä½å§“åï¼");
        return;
    }

    nameList = input.split(/[,ã€\s]+/).filter(x => x.trim() !== "");

    if(nameList.length < 2){
        alert("è‡³å°‘éœ€è¦ 2 ä½å§“åï¼");
        return;
    }

    locked = true;
    localStorage.setItem("nameList", JSON.stringify(nameList));

    document.getElementById("statusText").innerText =
        "åå–®å·²é–å®šï¼Œå…± " + nameList.length + " ä½ã€‚";

    drawWheel(nameList);
}


/* -------------------------------
   2. ç•«è¼ªç›¤
------------------------------- */
const CENTER = 190;
const RADIUS = 180;
let canvas = document.getElementById("wheelCanvas");
let ctx = canvas.getContext("2d");

function drawWheel(items){
    ctx.clearRect(0,0,380,380);
    if(items.length === 0) return;

    let count = items.length;
    let arc = Math.PI * 2 / count;

    for(let i=0;i<count;i++){
        ctx.beginPath();
        ctx.fillStyle = (i%2===0 ? "#fde7b5" : "#fcdca0");
        ctx.moveTo(CENTER,CENTER);
        ctx.arc(CENTER,CENTER,RADIUS, arc*i - Math.PI/2, arc*(i+1) - Math.PI/2);
        ctx.fill();

        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.save();
        ctx.translate(CENTER,CENTER);
        ctx.rotate(arc*i + arc/2 - Math.PI/2);
        ctx.textAlign = "right";
        ctx.font = "22px Noto Sans TC";
        ctx.fillStyle = "#5a3d00";
        ctx.fillText(items[i], RADIUS - 20, 10);
        ctx.restore();
    }
}


/* -------------------------------
   Drum éŸ³æ•ˆï¼ˆv4.5 æ–°å¢ï¼‰
------------------------------- */
function playDrum(){
    const s = new Audio("audio/drum.mp3");
    s.play().catch(()=>{});
}


/* -------------------------------
   3. è¼ªç›¤å‹•ç•«ï¼ˆåŠ å…¥æŒ‡é‡æ ¡æ­£ï¼‰
------------------------------- */
function easeOut(t){ return 1 - Math.pow(1 - t, 3); }

function spinWheel(items, clockwise){
    return new Promise(resolve => {

        playDrum();  // æ¯è¼ªé–‹å§‹æ’­æ”¾ drum.mp3

        let count = items.length;
        let arc = Math.PI * 2 / count;

        let base = Math.PI * 8;
        let rand = Math.random()*Math.PI*4;
        let rot = base + rand;

        if(!clockwise) rot = -rot;

        let start = performance.now();

        function animate(now){
            let p = (now - start)/5000;
            if(p>1) p=1;

            let angle = rot * easeOut(p);

            ctx.save();
            ctx.clearRect(0,0,380,380);
            ctx.translate(CENTER,CENTER);
            ctx.rotate(angle);
            ctx.translate(-CENTER,-CENTER);
            drawWheel(items);
            ctx.restore();

            if(p < 1){
                requestAnimationFrame(animate);
            } else {

                // ğŸ”¥ ä¿®æ­£æŒ‡é‡è§’åº¦ï¼ˆèˆ‡é¡¯ç¤ºä¸€è‡´ï¼‰
                let raw = angle % (2*Math.PI);
                if(raw < 0) raw += 2*Math.PI;

                // å°‡ã€Œä¸Šæ–¹æŒ‡é‡ã€è¦–ç‚º index 0
                raw = (raw + Math.PI/2) % (2*Math.PI);

                let idx = Math.floor(raw / arc);
                resolve(items[idx]);
            }
        }
        requestAnimationFrame(animate);
    });
}


/* -------------------------------
   4. ç¬¬ä¸€è¼ªï¼šå§“åè¼ªç›¤
------------------------------- */
let selectedName = null;
let selectedVerse = null;

async function startFirstRound(){

    if(!locked){
        alert("è«‹å…ˆé–å®šåå–®ï¼");
        return;
    }

    document.getElementById("stage2Btn").style.display = "none";
    document.getElementById("stage3Btn").style.display = "none";

    document.getElementById("statusText").innerText =
        "ç¬¬ 1 è¼ªï¼šå§“åè¼ªç›¤æŠ½ç±¤ä¸­â€¦";

    drawWheel(nameList);

    selectedName = await spinWheel(nameList, false);

    document.getElementById("statusText").innerText =
        "ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ" + selectedName + "ã€";

    setTimeout(()=>{
        document.getElementById("stage2Btn").style.display = "inline-block";
    }, 1200);
}


/* -------------------------------
   5. ç¬¬äºŒè¼ªï¼šç¶“å¥è¼ªç›¤ï¼ˆå¤–è§€åŒå§“åè¼ªç›¤ï¼‰
------------------------------- */
async function startSecondRound(){

    document.getElementById("stage2Btn").style.display = "none";

    let verseList = Object.keys(VERSE_REF_MAP);
    let used = JSON.parse(localStorage.getItem("usedVersesAll") || "[]");
    let available = verseList.filter(v => !used.includes(v));

    if(available.length === 0){
        alert("128 ç¯‡å·²å…¨éƒ¨æŠ½å®Œï¼");
        return;
    }

    // å¤–è§€ä»ä½¿ç”¨å§“åè¼ªç›¤ï¼Œä½†å…§å®¹ç„¡é—œ
    let wheelItems = nameList.map((_,i)=>String(i+1).padStart(3,"0"));

    document.getElementById("statusText").innerText =
        "ç¬¬ 2 è¼ªï¼šç¥ç¦ç¶“å¥è¼ªç›¤æŠ½ç±¤ä¸­â€¦";

    drawWheel(wheelItems);
    await spinWheel(wheelItems, true);

    selectedVerse = available[Math.floor(Math.random()*available.length)];

    document.getElementById("statusText").innerText =
        "ç¬¬ 2 è¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ" + selectedVerse + "ã€";

    // å¯«å…¥ç´€éŒ„
    saveRecord(selectedName, selectedVerse);

    setTimeout(()=>{
        document.getElementById("stage3Btn").style.display = "inline-block";
    }, 1200);
}


/* -------------------------------
   6. è·³ viewer.html
------------------------------- */
function gotoViewer(){
    window.location =
        `viewer.html?name=${encodeURIComponent(selectedName)}&verse=${selectedVerse}`;
}


/* -------------------------------
   7. å„²å­˜ç´€éŒ„ï¼ˆå§“åæ¨¡å¼ï¼‰
------------------------------- */
function saveRecord(name, verse){

    let now = new Date();
    let ts =
        `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,"0")}/`+
        `${String(now.getDate()).padStart(2,"0")} `+
        `${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}:${String(now.getSeconds()).padStart(2,"0")}`;

    let logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");

    logs.push({
        time: ts,
        name: name,
        verseNo: verse,
        mode: "å§“åæ¨¡å¼"
    });

    localStorage.setItem("drawLogs", JSON.stringify(logs));

    // é¿å…ç¶“å¥é‡è¤‡
    let used = JSON.parse(localStorage.getItem("usedVersesAll") || "[]");
    used.push(verse);
    localStorage.setItem("usedVersesAll", JSON.stringify(used));
}


/* -------------------------------
   8. é‡ç½®ï¼ˆå¼·åˆ¶æ¸…ç©ºåå–® + ç´€éŒ„ï¼‰
------------------------------- */
function resetAll(){
    localStorage.removeItem("usedVersesAll");
    localStorage.removeItem("drawLogs");
    localStorage.removeItem("nameList");
    alert("æ‰€æœ‰è³‡æ–™å·²æ¸…ç©ºï¼");
    location.reload();
}


/* -------------------------------
   9. PDF åŒ¯å‡ºï¼ˆå¤–éƒ¨å­—å‹ï¼‰
------------------------------- */
async function loadFont(){
    const res = await fetch("fonts/NotoSansTC-Regular.ttf");
    const buf = await res.arrayBuffer();
    return btoa(String.fromCharCode(...new Uint8Array(buf)));
}

async function exportPDF(){

    let logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
    if(logs.length === 0){
        alert("ç›®å‰æ²’æœ‰æŠ½ç±¤ç´€éŒ„ï¼");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    const fontData = await loadFont();
    doc.addFileToVFS("NotoSansTC.ttf", fontData);
    doc.addFont("NotoSansTC.ttf","NotoSansTC","normal");
    doc.setFont("NotoSansTC");

    let y = 40;
    doc.setFontSize(16);
    doc.text(`BlessingCards128 æŠ½ç±¤ç´€éŒ„ï¼ˆå…± ${logs.length} ç­†ï¼‰`, 40, y);
    y += 30;

    doc.setFontSize(14);

    logs.forEach(log =>{
        let ref = VERSE_REF_MAP[log.verseNo] || "";

        let line =
            `[${log.time}] ${log.name}ï½œ${log.mode}ï½œæŠ½ä¸­ç¶“å¥ï¼š${log.verseNo}` +
            (ref ? `ï¼ˆ${ref}ï¼‰` : "");

        if(y > 780){
            doc.addPage();
            y = 40;
        }
        doc.text(line, 40, y);
        y += 22;
    });

    doc.save("BlessingCards128_æŠ½ç±¤ç´€éŒ„.pdf");
}
</script>

</body>
</html>
