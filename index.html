<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BlessingCards128 - 抽籤首頁</title>

<link rel="stylesheet" href="fonts/fonts.css">

<style>
    body {
        margin:0;
        background:#fff7e6;
        font-family:"NotoSansTC", sans-serif;
        text-align:center;
        color:#8a5500;
    }

    .container {
        max-width:900px;
        margin:auto;
        padding:20px;
    }

    .logo {
        width:120px;
        margin-top:20px;
    }

    h1 {
        font-size:28px;
        color:#b37500;
        margin-top:10px;
    }

    textarea {
        width:90%;
        height:120px;
        padding:10px;
        font-size:18px;
        border-radius:10px;
        border:1px solid #d0a85c;
        resize:none;
        outline:none;
        font-family:"NotoSansTC";
        background:#fff;
    }

    .btn {
        background:#ffcc66;
        border:none;
        padding:12px 22px;
        border-radius:10px;
        font-size:20px;
        cursor:pointer;
        margin-top:12px;
    }
    .btn:hover { background:#ffdd88; }

    /* 朝下紅色指針 */
    #pointer {
        width:0; height:0;
        border-left:18px solid transparent;
        border-right:18px solid transparent;
        border-top:32px solid red; /* ←朝下 */
        margin:auto;
        margin-top:15px;
        position:relative;
        z-index:5;
        transform: translateY(8px);
    }

    #nameWheel {
        margin-top:0;
        max-width:300px;
    }

    #resultArea {
        font-size:26px;
        margin-top:12px;
        min-height:2.5em;
        color:#b37500;
    }

    #verseCount {
        margin-top:8px;
        font-size:16px;
        color:#9a6a00;
    }

    .bottom-buttons {
        margin-top:20px;
        display:flex;
        flex-direction:column;
        gap:10px;
        align-items:center;
    }
</style>
</head>

<body>
<div class="container">

    <img src="logo3524.png" class="logo" />
    <h1>飛鷹區 3524 主17小組<br>歡迎來到紅包祝福經句抽籤</h1>

    <textarea id="nameInput"
        placeholder="請輸入全部組員姓名，用逗號分隔"
        oninput="updateNames()"></textarea>

    <div>
        <button class="btn" onclick="startNameSpin()">開始抽姓名</button>
        <button class="btn" onclick="goCategory()">分類抽籤</button>
    </div>

    <div id="verseCount"></div>

    <div id="pointer"></div>
    <canvas id="nameWheel" width="300" height="300"></canvas>

    <div id="resultArea"></div>

    <div class="bottom-buttons">
        <button class="btn" onclick="resetAll()">全部歸零</button>
        <button class="btn" onclick="exportPDF()">抽籤紀錄 PDF</button>
    </div>

</div>

<script>
/* -----------------------------------------------------------
   全域資料
----------------------------------------------------------- */
const verseTotal = 128;
const POINTER_ANGLE = -Math.PI/2; // 指針朝下

let canvas, ctx;
let names = [];
let usedNamesAll = [];
let usedVersesAll = [];
let isSpinning = false;
let drumAudio;
let currentWinner = "";

/* -----------------------------------------------------------
   初始化
----------------------------------------------------------- */
document.addEventListener("DOMContentLoaded", () => {
    canvas = document.getElementById("nameWheel");
    ctx = canvas.getContext("2d");
    drumAudio = new Audio("audio/drum.mp3");

    loadUsedNames();
    loadUsedVerses();
    updateVerseCount();
    updateNames();
});

/* -----------------------------------------------------------
   localStorage：姓名 & 經句
----------------------------------------------------------- */
function loadUsedNames(){
    try{
        usedNamesAll = JSON.parse(localStorage.getItem("usedNamesAll")) || [];
    }catch(e){
        usedNamesAll = [];
    }
}
function saveUsedNames(){
    localStorage.setItem("usedNamesAll", JSON.stringify(usedNamesAll));
}

function loadUsedVerses(){
    try{
        usedVersesAll = JSON.parse(localStorage.getItem("usedVersesAll")) || [];
    }catch(e){
        usedVersesAll = [];
    }
}
function saveUsedVerses(){
    localStorage.setItem("usedVersesAll", JSON.stringify(usedVersesAll));
}

function updateVerseCount(){
    document.getElementById("verseCount").textContent =
        `已抽經句：${usedVersesAll.length} / ${verseTotal}`;
}

/* -----------------------------------------------------------
   繪製輪盤
----------------------------------------------------------- */
function updateNames(){
    const input = document.getElementById("nameInput").value;
    names = input
        .split(",")
        .map(s => s.trim())
        .filter(s => s.length > 0);
    drawNameWheel();
}

function drawNameWheel(){
    ctx.clearRect(0,0,300,300);

    const count = names.length || 1;
    const arc = 2 * Math.PI / count;

    for(let i=0; i<count; i++){
        const start = i * arc;
        const end   = start + arc;

        ctx.beginPath();
        ctx.moveTo(150,150);
        ctx.arc(150,150,150,start,end);
        ctx.closePath();
        ctx.fillStyle = (i % 2 === 0) ? "#ffe6a1" : "#ffcc66";
        ctx.fill();

        ctx.lineWidth = 2;
        ctx.strokeStyle = "#ffffff";
        ctx.stroke();

        if(names[i]){
            ctx.save();
            ctx.translate(150,150);
            ctx.rotate(start + arc/2);
            ctx.textAlign="right";
            ctx.font = "bold 18px NotoSansTC";
            ctx.fillStyle="#8a5500";
            ctx.fillText(names[i],135,8);
            ctx.restore();
        }
    }
}

/* -----------------------------------------------------------
   抽姓名（只有 drum.mp3，無特效）
----------------------------------------------------------- */
function startNameSpin(){
    if(isSpinning) return;

    updateNames();
    if(names.length === 0){
        alert("請先輸入姓名");
        return;
    }

    const available = names.filter(n => !usedNamesAll.includes(n));
    if(available.length === 0){
        alert("全部姓名都抽過了！請按「全部歸零」。");
        return;
    }

    const winner = available[Math.floor(Math.random()*available.length)];
    currentWinner = winner;

    const count = names.length;
    const arc = 2*Math.PI / count;
    const winnerIdx = names.indexOf(winner);

    const baseCenter = winnerIdx * arc + arc/2;
    const offset = (Math.random()-0.5) * arc * 0.3;

    const targetCenter = baseCenter + offset;
    const spins = 5;

    const totalRotation =
        spins * 2*Math.PI + (POINTER_ANGLE - targetCenter);

    const duration = 10000; // 10 秒
    let startTime = null;
    isSpinning = true;

    drumAudio.currentTime = 0;
    drumAudio.play().catch(()=>{});

    function animate(ts){
        if(!startTime) startTime = ts;
        const t = Math.min((ts - startTime) / duration, 1);
        const ease = 1 - Math.pow(1-t, 3);
        const angle = ease * totalRotation;

        ctx.save();
        ctx.translate(150,150);
        ctx.rotate(angle);
        ctx.translate(-150,-150);
        drawNameWheel();
        ctx.restore();

        if(t < 1){
            requestAnimationFrame(animate);
        }else{
            drumAudio.pause();
            drumAudio.currentTime = 0;
            isSpinning = false;

            if(!usedNamesAll.includes(winner)){
                usedNamesAll.push(winner);
                saveUsedNames();
            }

            showWinner(winner);
        }
    }

    requestAnimationFrame(animate);
}

/* -----------------------------------------------------------
   顯示抽中姓名（不觸發特效）
----------------------------------------------------------- */
function showWinner(winner){
    document.getElementById("resultArea").innerHTML =
        `抽中：<b>${winner}</b><br><br>
         <button class="btn" onclick="drawVerse()">抽紅包祝福經句</button>`;
}

/* -----------------------------------------------------------
   抽經句（跳轉 viewer.html，特效由 viewer 處理）
----------------------------------------------------------- */
function drawVerse(){
    if(!currentWinner){
        alert("請先抽姓名");
        return;
    }

    if(usedVersesAll.length >= verseTotal){
        alert("128 張經句都已抽完，請按「全部歸零」再開始！");
        return;
    }

    const remain=[];
    for(let i=1; i<=verseTotal; i++){
        if(!usedVersesAll.includes(i)) remain.push(i);
    }

    const v = remain[Math.floor(Math.random()*remain.length)];
    usedVersesAll.push(v);
    saveUsedVerses();
    updateVerseCount();

    const padded = String(v).padStart(3,"0");
    const nameParam = encodeURIComponent(currentWinner);

    window.location = `viewer.html?no=${padded}&name=${nameParam}`;
}

/* -----------------------------------------------------------
   歸零
----------------------------------------------------------- */
function resetAll(){
    if(!confirm("確定全部重置？姓名與經句紀錄都會清空！")) return;

    usedNamesAll=[];
    usedVersesAll=[];
    currentWinner="";
    saveUsedNames();
    saveUsedVerses();

    updateVerseCount();
    document.getElementById("resultArea").innerHTML="";
}

/* -----------------------------------------------------------
   跳至分類抽籤
----------------------------------------------------------- */
function goCategory(){
    window.location="index_category.html";
}

/* -----------------------------------------------------------
   匯出 PDF（讀取 viewer.html 寫入的 drawLogs）
----------------------------------------------------------- */
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

function exportPDF(){
    let logs=[];
    try{
        logs = JSON.parse(localStorage.getItem("drawLogs")) || [];
    }catch(e){
        logs = [];
    }

    if(!logs.length){
        alert("目前沒有任何抽籤紀錄可以匯出。");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"pt"});

    doc.setFont("Helvetica","normal");
    doc.setFontSize(18);
    doc.text("BlessingCards128 抽籤紀錄",40,40);
    doc.setFontSize(12);
    doc.text("（由系統自動產生）",40,60);
    doc.line(40,70,555,70);

    let y=90;
    logs.forEach(log=>{
        const line =
          `[${log.time}] 「${log.name}」 在「${log.category}」中抽到 → ${log.verseRef}（${String(log.verseNo).padStart(3,"0")}.png）`;

        const parts = doc.splitTextToSize(line,515);

        parts.forEach(part=>{
            if(y>780){
                doc.addPage();
                y=40;
            }
            doc.text(part,40,y);
            y+=18;
        });
    });

    doc.save("抽籤紀錄.pdf");
}
</script>

</body>
</html>
