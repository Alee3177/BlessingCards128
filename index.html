<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆBlessingCards128ï¼‰</title>
<link rel="icon" href="logo3524.png">

<style>
body {
    font-family: "Noto Sans TC", sans-serif;
    text-align: center;
    background: #fffdf7;
    margin: 0;
    padding: 0;
    color: #5a4635;
}

/* LOGO */
.logo {
    width: 180px;
    margin-top: 18px;
}

/* æ¨™é¡Œ */
.title {
    font-size: 28px;
    margin-top: 8px;
    font-weight: bold;
    color: #5a4635;
}

/* è¼¸å…¥æ¡† */
input {
    width: 320px;
    padding: 10px;
    font-size: 18px;
    margin-bottom: 10px;
    border-radius: 8px;
    border: 1px solid #aaa;
}

/* æŒ‰éˆ• */
button {
    width: 260px;
    padding: 14px;
    font-size: 20px;
    border: none;
    border-radius: 10px;
    margin: 8px;
    cursor: pointer;
    background: linear-gradient(135deg, #fceabb, #f8b500);
    font-weight: bold;
    color: #5a4635;
    transition: 0.25s;
}
button:hover {
    transform: scale(1.05);
    background: linear-gradient(135deg, #ffd57e, #f2a600);
}

/* é–å®šåå–®å¾Œä¸é¡¯ç¤ºå§“åæ¸…å–® */
#nameListDisplay {
    display: none !important;
}
.name-item {
    padding: 4px 0;
    font-weight: bold;
}
.name-line {
    width: 60%;
    height: 1px;
    background: #d2b48c;
    margin: 4px auto 6px;
}

/* Canvas å€ */
#canvasBox {
    margin-top: 25px;
    position: relative;
    display: inline-block;
}
#wheelCanvas {
    background: transparent;
}

/* æŒ‡é‡ï¼ˆå›ºå®šï¼‰ */
.pointer {
    position: absolute;
    top: -18px;      /* ç²¾æº–è²¼ä½è¼ªç›¤å¤–ç·£ */
    left: 50%;
    transform: translateX(-50%);
    font-size: 42px;
    color: red;
    user-select: none;
}

#statusText {
    margin-top: 15px;
    font-size: 20px;
    white-space: pre-line;
}

#resultName {
    margin-top: 12px;
    font-size: 26px;
    font-weight: bold;
}
</style>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- VERSE REF MAP -->
<script src="verseRefMap.js"></script>

</head>

<body>

<img src="logo3524.png" class="logo" alt="logo">

<div class="title">ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆBlessingCards128ï¼‰</div>

<!-- å§“åè¼¸å…¥ + æŒ‰éˆ• -->
<input id="nameInput" placeholder="è¼¸å…¥æ‰€æœ‰å§“åï¼Œç”¨ã€Œ,ã€åˆ†éš”"><br>

<button onclick="lockNames()">ğŸ”’ é–å®šåå–®</button>
<button onclick="resetAll()">ğŸ”„ å…¨éƒ¨æ­¸é›¶</button><br>

<button onclick="startDrawSequence()">ğŸ¡ é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
<button onclick="goCategory()">ğŸ“š åˆ†é¡æŠ½ç±¤</button><br>

<button onclick="exportPDF()">ğŸ“„ æŠ½ç±¤ç´€éŒ„ PDF</button>

<!-- åå–®å‘ˆç¾ï¼ˆæœ‰åˆ†éš”ç·šï¼‰ -->
<div id="nameListDisplay"></div>

<!-- å›ºå®šç´…è‰²å€’ä¸‰è§’æŒ‡é‡ï¼ˆâ–¼ï¼‰ -->
<div class="pointer">â–¼</div>

<!-- è½‰ç›¤ Canvas -->
<div id="canvasBox">
    <canvas id="wheelCanvas" width="360" height="360"></canvas>
</div>

<div id="statusText"></div>
<div id="resultName"></div>

<script>
// ================== å…¨åŸŸè®Šæ•¸ ==================
let fixedNameList   = JSON.parse(localStorage.getItem("fixedNameList")   || "[]");
let usedNamesAll    = JSON.parse(localStorage.getItem("usedNamesAll")    || "[]");
let usedVersesAll   = JSON.parse(localStorage.getItem("usedVersesAll")   || "[]");
let drawLogs        = JSON.parse(localStorage.getItem("drawLogs")        || "[]");

const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");

let currentName  = null;
let currentVerse = null;
let isSpinning   = false;

// é é¢è¼‰å…¥æ™‚ï¼šé¡¯ç¤ºåå–® + ç•«è¼ªç›¤æˆ–å ä½ç›¤
updateNameListDisplay();
if (fixedNameList.length) {
    drawWheel(fixedNameList, 0);  // âœ… ä¸€é€²ä¾†å°±é¡¯ç¤ºå§“åè¼ªç›¤
} else {
    drawWheelPlaceholder();
}

// ================== åå–®é–å®š ==================
function lockNames(){
    if(fixedNameList.length > 0){
        alert("åå–®å·²é–å®šï¼Œå¦‚éœ€ä¿®æ”¹è«‹æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€ã€‚");
        return;
    }
    const raw = document.getElementById("nameInput").value.trim();
    if(!raw){
        alert("è«‹è¼¸å…¥å§“åï¼ˆç”¨ , éš”é–‹ï¼‰");
        return;
    }
    const list = raw.split(",").map(n=>n.trim()).filter(n=>n);
    if(!list.length){
        alert("æ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚");
        return;
    }
    fixedNameList = list;
    localStorage.setItem("fixedNameList", JSON.stringify(list));
    updateNameListDisplay();
    drawWheel(fixedNameList, 0);  // âœ… é–å®šå¾Œç«‹å³ç•«å‡ºå§“åè¼ªç›¤
    alert("åå–®å·²é–å®šï¼");
}

function updateNameListDisplay(){// ä¸å†é¡¯ç¤ºå§“åæ¸…å–®
    const el = document.getElementById("nameListDisplay");
    el.innerHTML = "";

    if(!fixedNameList.length){
        el.textContent = "å°šæœªé–å®šåå–®";
        return;
    }

    fixedNameList.forEach((n,idx)=>{
        const div = document.createElement("div");
        div.className = "name-item";
        div.textContent = n;
        el.appendChild(div);

        if(idx < fixedNameList.length - 1){
            const line = document.createElement("div");
            line.className = "name-line";
            el.appendChild(line);
        }
    });
}

function resetAll(){
    if(!confirm("ç¢ºå®šè¦å…¨éƒ¨æ­¸é›¶ï¼Ÿ")) return;

    localStorage.removeItem("fixedNameList");
    localStorage.removeItem("usedNamesAll");
    localStorage.removeItem("usedVersesAll");
    localStorage.removeItem("drawLogs");

    fixedNameList = [];
    usedNamesAll  = [];
    usedVersesAll = [];
    drawLogs      = [];

    alert("å·²å…¨éƒ¨é‡ç½®ï¼");
    location.reload();
}

function goCategory(){
    window.location = "index_category.html";
}

// ================== å·¥å…· ==================
function wait(ms){
    return new Promise(resolve => setTimeout(resolve, ms));
}

function spinWheelPromise(items, isSecondWheel){
    return new Promise(resolve => {
        spinWheel(items, resolve, isSecondWheel);
    });
}

// ================== ä¸»æµç¨‹ï¼šé–‹å§‹æŠ½å§“å + ç¶“å¥ ==================
async function startDrawSequence(){
    if(isSpinning) return;
    if(!fixedNameList.length){
        alert("è«‹å…ˆé–å®šåå–®ï¼");
        return;
    }

    const remaining = fixedNameList.filter(n => !usedNamesAll.includes(n));
    if(!remaining.length){
        alert("æ‰€æœ‰å§“åçš†å·²æŠ½éï¼è«‹æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€é‡ä¾†ã€‚");
        return;
    }

    isSpinning = true;
    document.getElementById("statusText").innerText = "ç¬¬ 1 è¼ªï¼šæŠ½å§“åä¸­â€¦";
    document.getElementById("resultName").innerText = "";

    // ç¬¬ä¸€è¼ªï¼ˆå§“åè¼ªç›¤ â†’ é€†æ™‚é‡ï¼‰
    const selectedName = await spinWheelPromise(remaining, false);
    currentName = selectedName;

    if(!usedNamesAll.includes(selectedName)){
        usedNamesAll.push(selectedName);
        localStorage.setItem("usedNamesAll", JSON.stringify(usedNamesAll));
    }

    document.getElementById("statusText").innerText =
        `ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ${selectedName}ã€`;
    document.getElementById("resultName").innerText =
        `æŠ½ä¸­å§“åï¼šã€Œ${selectedName}ã€`;

    await wait(5000);

    // ç¬¬äºŒè¼ªï¼ˆç¶“å¥è¼ªç›¤ â†’ é †æ™‚é‡ï¼‰
    await startVerseWheel();

    isSpinning = false;
}

// ================== æŠ½ç±¤ç´€éŒ„ ==================
function addLogEntry(name, verseNo){
    const now = new Date();
    const timeString =
        `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,"0")}/${now.getDate().toString().padStart(2,"0")} ` +
        `${now.getHours().toString().padStart(2,"0")}:${now.getMinutes().toString().padStart(2,"0")}:${now.getSeconds().toString().padStart(2,"0")}`;

    const record = {
        time: timeString,
        name: name,
        verseNo: verseNo
    };

    drawLogs.push(record);
    localStorage.setItem("drawLogs", JSON.stringify(drawLogs));
}

// ================== ç¬¬äºŒè¼ªç¶“å¥è¼ªç›¤ ==================
async function startVerseWheel(){
    // ç”¨å§“åè¼ªç›¤å¤–è§€ï¼ˆä¾å§“åæ•¸é‡åˆ‡ç‰‡ï¼‰
    const wheelItems = fixedNameList;

    document.getElementById("statusText").innerText =
        "ç¬¬ 2 è¼ªï¼šç¥ç¦ç¶“å¥æŠ½ç±¤ä¸­â€¦";
    document.getElementById("resultName").innerText = "";

    const dummyResult = await spinWheelPromise(wheelItems, true);

    // çœŸæ­£æŠ½å–æœªæŠ½éçš„ç¶“å¥ï¼ˆ1~128ï¼‰
    const allVerses = [];
    for(let i=1;i<=128;i++){
        allVerses.push(i.toString().padStart(3,"0"));
    }
    const available = allVerses.filter(v => !usedVersesAll.includes(v));

    const selectedVerse = available[Math.floor(Math.random()*available.length)];
    currentVerse = selectedVerse;

    usedVersesAll.push(selectedVerse);
    localStorage.setItem("usedVersesAll", JSON.stringify(usedVersesAll));

    const ref = window.VERSE_REF_MAP[selectedVerse] || "";

    document.getElementById("statusText").innerText =
        `ç¬¬ 2 è¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ç·¨è™Ÿã€Œ${selectedVerse}ã€ï¼ˆ${ref}ï¼‰`;
    document.getElementById("resultName").innerText =
        `æŠ½ä¸­å§“åï¼šã€Œ${currentName}ã€`;

    addLogEntry(currentName, selectedVerse);

    await wait(5000);

    showGoViewerButton();
}

// ================== é¡¯ç¤º viewer æŒ‰éˆ• ==================
function showGoViewerButton(){
    let btn = document.getElementById("viewButton");
    if(!btn){
        btn = document.createElement("button");
        btn.id = "viewButton";
        btn.textContent = "ğŸ çœ‹ç´…åŒ…å…§å®¹";
        btn.style.marginTop = "20px";
        btn.onclick = ()=> goViewer();
        document.body.appendChild(btn);
    }
}

// ================== è·³ viewer.html ==================
function goViewer(){
    const url =
        "viewer.html?name="  + encodeURIComponent(currentName) +
        "&verse=" + encodeURIComponent(currentVerse);
    window.location = url;
}

// ================== è¼ªç›¤ç•«é¢ ==================
function drawWheelPlaceholder(){
    const c = canvas;
    const center = 180;
    const radius = 160;

    ctx.clearRect(0,0,c.width,c.height);
    ctx.beginPath();
    ctx.arc(center,center,radius,0,Math.PI*2);
    ctx.fillStyle = "#fff6d6";
    ctx.fill();

    ctx.fillStyle = "#5a4635";
    ctx.font = "18px Noto Sans TC";
    ctx.textAlign = "center";
    ctx.fillText("è«‹é–å®šåå–®å¾Œ", center, center - 5);
    ctx.fillText("æŒ‰ã€Œé–‹å§‹æŠ½å§“å + ç¶“å¥ã€", center, center + 20);
}

function drawWheel(items, rotation=0){
    const total  = items.length;
    const center = 180;
    const radius = 160;
    const arc    = (2 * Math.PI) / total;

    ctx.clearRect(0,0,canvas.width,canvas.height);

    for(let i=0;i<total;i++){
        const start = i*arc + rotation;
        const end   = start + arc;

        // æ‰‡å½¢åº•è‰²
        ctx.beginPath();
        ctx.moveTo(center,center);
        ctx.arc(center,center,radius,start,end);
        ctx.closePath();
        ctx.fillStyle = "#fff6d6";
        ctx.fill();

        // âœ… åˆ†éš”ç·šï¼ˆç™½è‰²ç´°ç·šï¼‰
        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 1;
        ctx.stroke();

        // æ–‡å­—
        ctx.save();
        ctx.translate(center,center);
        ctx.rotate(start + arc/2);
        ctx.textAlign = "right";
        ctx.font = "18px Noto Sans TC";
        ctx.fillStyle = "#5a4635";
        ctx.fillText(items[i], radius-14, 6);
        ctx.restore();
    }
}

// çœŸæ­£æ—‹è½‰å‹•ç•«
function spinWheel(items, onDone, isSecondWheel){
    const total = items.length;
    const arc   = (2*Math.PI) / total;

    const selectedIndex = Math.floor(Math.random()*total);
    const pointerAngle  = -Math.PI/2;

    const sliceCenter   = selectedIndex*arc + arc/2;
    const baseAngle     = pointerAngle - sliceCenter;

    const extra = 4;

    let finalAngle =
        isSecondWheel
        ? baseAngle + extra * 2*Math.PI   // ç¬¬äºŒè¼ªé †æ™‚é‡
        : baseAngle - extra * 2*Math.PI;  // ç¬¬ä¸€è¼ªé€†æ™‚é‡

    const duration  = 5000; // â˜… 5 ç§’
    const startTime = performance.now();

    const drum = new Audio("audio/drum.mp3");
    drum.currentTime = 0;
    drum.play().catch(()=>{});

    function animate(now){
        const t     = Math.min((now - startTime)/duration, 1);
        const eased = 1 - Math.pow(1-t, 3);
        const angle = finalAngle * eased;

        drawWheel(items, angle);

        if(t < 1){
            requestAnimationFrame(animate);
        } else {
            onDone(items[selectedIndex]);
        }
    }
    requestAnimationFrame(animate);
}

// ================== Uint8 â†’ Base64 ==================
function uint8ToBase64(uint8){
    let binary = "";
    for(let i=0;i<uint8.byteLength;i++){
        binary += String.fromCharCode(uint8[i]);
    }
    return window.btoa(binary);
}

// ================== PDF åŒ¯å‡º ==================
async function exportPDF(){
    const { jsPDF } = window.jspdf;

    drawLogs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
    if(!drawLogs.length){
        alert("ç›®å‰æ²’æœ‰æŠ½ç±¤ç´€éŒ„ï¼");
        return;
    }

    const doc = new jsPDF({ unit: "pt", format: "a4" });

    const fontUrl = "fonts/NotoSansTC-Regular.ttf";

    try{
        const fontBuffer = await fetch(fontUrl).then(r => r.arrayBuffer());
        const fontUint8  = new Uint8Array(fontBuffer);
        const fontBase64 = uint8ToBase64(fontUint8);

        doc.addFileToVFS("NotoSansTC-Regular.ttf", fontBase64);
        doc.addFont("NotoSansTC-Regular.ttf", "NotoSansTC", "normal");
        doc.setFont("NotoSansTC", "normal");

    }catch(e){
        alert("PDF å­—å‹è¼‰å…¥å¤±æ•—ï¼");
        return;
    }

    let y = 40;
    doc.setFontSize(20);
    doc.text("BlessingCards128 æŠ½ç±¤ç´€éŒ„", 40, y);

    y += 40;
    doc.setFontSize(13);

    drawLogs.forEach(log => {
        const ref = window.VERSE_REF_MAP[log.verseNo] || "";
        const line =
            `[${log.time}] ${log.name}ï½œç¶“å¥ï¼š${log.verseNo}` +
            (ref ? `ï¼ˆ${ref}ï¼‰` : "");

        if(y > 780){
            doc.addPage();
            y = 40;
        }
        doc.text(line, 40, y);
        y += 22;
    });

    doc.save("æŠ½ç±¤ç´€éŒ„.pdf");
}
</script>

</body>
</html>
