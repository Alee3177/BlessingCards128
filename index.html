<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Blessing Cards 128 - 姓名抽籤（強化版）</title>

<!-- Base64 內嵌字型 -->
<script src="fonts_base64.js"></script>

<!-- 匯出 PDF 用套件 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body {
        margin: 0;
        padding: 0;
        background: #fff7e6;
        font-family: "Noto Sans TC", sans-serif;
        color: #8a5500;
        text-align: center;
    }

    .container {
        max-width: 900px;
        margin: auto;
        padding: 20px;
    }

    .logo {
        width: 120px;
        margin-top: 20px;
    }

    h1 {
        font-size: 32px;
        margin-top: 10px;
        color: #b37500;
    }

    .input-area {
        background: #fff3d6;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
    }

    textarea {
        width: 90%;
        height: 80px;
        font-size: 18px;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #e0c288;
    }

    button {
        background: #ffcc66;
        border: none;
        padding: 12px 22px;
        border-radius: 10px;
        font-size: 20px;
        cursor: pointer;
        margin-top: 12px;
    }

    button:hover {
        background: #ffdd88;
    }

    .switch-btn {
        background: #ffd27f;
    }

    /* 固定 12 點方向的紅色三角指針 */
    #pointer {
        width: 0;
        height: 0;
        border-left: 18px solid transparent;
        border-right: 18px solid transparent;
        border-bottom: 32px solid red;
        margin: auto;
        margin-top: -10px;
        position: relative;
        z-index: 5;
    }

    canvas {
        margin-top: 20px;
        max-width: 300px;
    }

    /* 全部歸零按鈕 */
    #resetBtn {
        background: #ff6666;
        color: white;
        margin-top: 25px;
    }

    #resetBtn:hover {
        background: #ff8888;
    }

    #nameResult {
        font-size: 24px;
        margin-top: 10px;
        min-height: 2em;
    }

    /* 金幣動畫 */
    .coin {
        position: fixed;
        top: -50px;
        width: 35px;
        pointer-events: none;
        animation: fallCoin linear forwards;
    }

    @keyframes fallCoin {
        from {
            transform: translateY(-50px);
            opacity: 1;
        }
        to {
            transform: translateY(100vh);
            opacity: 0;
        }
    }
</style>
</head>

<body>
<div class="container">

    <!-- LOGO -->
    <img src="logo3524.png" class="logo" />

    <h1>飛鷹區 3524 主17小組 - 姓名抽籤</h1>

    <!-- 姓名輸入（只需輸入一次，之後會記住＋鎖定） -->
    <div class="input-area">
        <p>請輸入全部姓名（用逗號分隔，空格可有可無）</p>

        <textarea id="nameInput" placeholder="例：小芳, 阿強, 子瑄, 思恩"></textarea>
        <br />
        <button onclick="saveNamesAndStart()">開始抽姓名</button>

        <br />
        <button class="switch-btn" onclick="window.location='index_category.html'">
            ➤ 切換到「分類抽籤」模式
        </button>

        <br />
        <button id="resetBtn" onclick="resetAll()">
            全部歸零（清除名單＋經句紀錄）
        </button>

        <br />
        <button style="margin-top: 12px;" onclick="exportPDF()">
            匯出 PDF 報告
        </button>
    </div>

    <!-- 固定指針 -->
    <div id="pointer"></div>

    <!-- 姓名輪盤 -->
    <canvas id="nameWheel" width="300" height="300"></canvas>

    <p id="nameResult"></p>

    <!-- 煙火畫布 -->
    <canvas id="fwCanvas" style="position: fixed; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
</div>

<script>
/* ----------------------------
   全域變數
----------------------------- */
let usedVersesAll = [];   // ✅ 經句不重複抽取紀錄（1~128）

let nameList = [];        // 全部名字
let usedNames = [];       // 已抽過名字
let isSpinning = false;   // 是否正在轉動

let drumAudio, winAudio;  // 音效
let audioReady = false;


/* ----------------------------
   初始化：載入 localStorage
----------------------------- */
(function initFromStorage() {
    let savedNames   = localStorage.getItem("nameList");
    let savedUsed    = localStorage.getItem("usedNames");
    let savedVerses  = localStorage.getItem("usedVersesAll");

    if (savedNames) {
        nameList = JSON.parse(savedNames);
        const input = document.getElementById("nameInput");
        input.value = nameList.join(", ");
        input.disabled = true;
    }

    if (savedUsed) {
        usedNames = JSON.parse(savedUsed);
    }

    if (savedVerses) {
        usedVersesAll = JSON.parse(savedVerses);
    }

    initAudioIfNeeded();
    drawNameWheel();
})();


/* ----------------------------
   音效初始化
----------------------------- */
function initAudioIfNeeded() {
    if (audioReady) return;
    drumAudio = new Audio("audio/drum.mp3");
    winAudio  = new Audio("audio/win.mp3");
    audioReady = true;
}


/* ----------------------------
   開始抽姓名
----------------------------- */
function saveNamesAndStart() {

    // 若尚未有名單 → 第一次輸入
    if (nameList.length === 0) {
        const raw = document.getElementById("nameInput").value.trim();
        if (!raw) {
            alert("請先輸入至少一個姓名！");
            return;
        }

        nameList = raw
            .split(",")
            .map(s => s.trim())
            .filter(s => s.length > 0);

        if (nameList.length === 0) {
            alert("請確認姓名格式是否正確（以逗號分隔）！");
            return;
        }

        localStorage.setItem("nameList", JSON.stringify(nameList));
        const input = document.getElementById("nameInput");
        input.value = nameList.join(", ");
    }

    // 鎖住輸入框
    document.getElementById("nameInput").disabled = true;

    // 如果所有人都已抽過一輪
    if (usedNames.length >= nameList.length) {
        alert("全部人都已輪過一次！\n請按「全部歸零」重新開始。");
        return;
    }

    initAudioIfNeeded();
    drumAudio.currentTime = 0;
    drumAudio.play().catch(()=>{});

    if (!isSpinning) {
        isSpinning = true;
        drawNameWheel();
        spinNameWheel();
    }
}


/* ----------------------------
   全部歸零
----------------------------- */
function resetAll() {
    if (!confirm("確定要清除姓名與經句抽籤紀錄並重新開始嗎？")) return;

    localStorage.removeItem("nameList");
    localStorage.removeItem("usedNames");
    localStorage.removeItem("usedVersesAll");

    nameList = [];
    usedNames = [];
    usedVersesAll = [];

    location.reload();
}


/* ----------------------------
   繪製姓名輪盤
----------------------------- */
const canvas = document.getElementById("nameWheel");
const ctx = canvas.getContext("2d");

function drawNameWheel() {
    ctx.clearRect(0, 0, 300, 300);

    if (nameList.length === 0) {
        // 沒有名單時顯示提示
        ctx.save();
        ctx.translate(150, 150);
        ctx.fillStyle = "#e0c288";
        ctx.beginPath();
        ctx.arc(0, 0, 120, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "#8a5500";
        ctx.font = "bold 18px NotoSansTC";
        ctx.textAlign = "center";
        ctx.fillText("請先輸入姓名", 0, 0);
        ctx.restore();
        return;
    }

    const count = nameList.length;
    const arc = (2 * Math.PI) / count;

    for (let i = 0; i < count; i++) {
        const angle = i * arc;

        ctx.beginPath();
        ctx.moveTo(150, 150);
        ctx.fillStyle = i % 2 === 0 ? "#ffe6a1" : "#ffcc66";
        ctx.arc(150, 150, 150, angle, angle + arc);
        ctx.fill();

        ctx.save();
        ctx.translate(150, 150);
        ctx.rotate(angle + arc / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#8a5500";
        ctx.font = "bold 18px NotoSansTC";
        ctx.fillText(nameList[i], 135, 8);
        ctx.restore();
    }
}


/* ----------------------------
   取得不落在邊界線的安全角度
----------------------------- */
function randomSafeAngle() {
    const count = nameList.length;
    const arc = (2 * Math.PI) / count;
    const safe = arc * 0.2;  // 中間 ±10%

    // 隨機挑未抽過的人
    let idx = Math.floor(Math.random() * count);
    while (usedNames.includes(nameList[idx])) {
        idx = Math.floor(Math.random() * count);
    }

    const base = idx * arc + arc / 2;
    const angle = base + (Math.random() * safe - safe / 2);

    return { idx, angle };
}


/* ----------------------------
   輪盤旋轉動畫
----------------------------- */
function spinNameWheel() {
    const { idx, angle } = randomSafeAngle();
    const finalIndex = idx;

    const totalRotation = angle + Math.PI * 8;
    const duration = 3000;
    let start = null;

    function animate(ts) {
        if (!start) start = ts;
        const progress = ts - start;
        const ease = Math.pow(progress / duration, 3);
        const current = ease * totalRotation;

        ctx.save();
        ctx.translate(150, 150);
        ctx.rotate(current);
        ctx.translate(-150, -150);

        drawNameWheel();
        ctx.restore();

        if (progress < duration) {
            requestAnimationFrame(animate);
        } else {
            isSpinning = false;
            finishNameDraw(finalIndex);
        }
    }

    requestAnimationFrame(animate);
}


/* ----------------------------
   抽姓名完成
----------------------------- */
function finishNameDraw(index) {
    const name = nameList[index];

    if (!usedNames.includes(name)) {
        usedNames.push(name);
        localStorage.setItem("usedNames", JSON.stringify(usedNames));
    }

    winAudio.currentTime = 0;
    winAudio.play().catch(()=>{});
    celebrate();

    document.getElementById("nameResult").innerHTML =
        `抽中：<b>${name}</b><br><br>
         <button onclick="drawBlessingVerse()">抽紅包祝福經句</button>`;
}


/* ----------------------------
   第二階段：抽紅包經句（1~128，不重複）
----------------------------- */
function drawBlessingVerse() {

    // 128 張都抽過 → 不再抽
    if (usedVersesAll.length >= 128) {
        alert("128 張紅包祝福經句已全部抽完！\n請按「全部歸零」後再開始。");
        return;
    }

    // 建立全集 1~128
    const all = Array.from({ length: 128 }, (_, i) => i + 1);

    // 篩選出尚未抽過的
    const available = all.filter(v => !usedVersesAll.includes(v));

    // 從未抽過裡面抽一張
    const verseNo = available[Math.floor(Math.random() * available.length)];

    // 記錄
    usedVersesAll.push(verseNo);
    localStorage.setItem("usedVersesAll", JSON.stringify(usedVersesAll));

    const padded = verseNo.toString().padStart(3, "0");

    winAudio.currentTime = 0;
    winAudio.play().catch(()=>{});
    celebrate();

    setTimeout(() => {
        window.location = `viewer.html?no=${padded}`;
    }, 750);
}
</script>

<script>
/* ---------------- 煙火 ---------------- */
let fwCanvas = document.getElementById("fwCanvas");
let fwCtx = fwCanvas.getContext("2d");

function resizeFW() {
    fwCanvas.width = window.innerWidth;
    fwCanvas.height = window.innerHeight;
}
resizeFW();
window.addEventListener("resize", resizeFW);

let fireArr = [];

function launchFirework() {
    const x = Math.random() * fwCanvas.width;
    const y = Math.random() * fwCanvas.height * 0.5;

    fireArr.push({
        x,
        y,
        radius: 2,
        color: `hsl(${Math.random() * 360}, 100%, 60%)`,
        life: 30 + Math.random() * 20,
    });
}

function drawFireworks() {
    fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);

    for (let i = fireArr.length - 1; i >= 0; i--) {
        const fw = fireArr[i];
        fwCtx.beginPath();
        fwCtx.arc(fw.x, fw.y, fw.radius, 0, Math.PI * 2);
        fwCtx.fillStyle = fw.color;
        fwCtx.fill();

        fw.radius += 2;
        fw.life--;

        if (fw.life <= 0) fireArr.splice(i, 1);
    }

    requestAnimationFrame(drawFireworks);
}
drawFireworks();

function startFireworks() {
    for (let i = 0; i < 12; i++) {
        setTimeout(launchFirework, i * 150);
    }
}

/* ---------------- 金幣 ---------------- */
function startCoins() {
    for (let i = 0; i < 15; i++) {
        setTimeout(() => {
            let coin = document.createElement("img");
            coin.src =
                "https://cdn-icons-png.flaticon.com/512/138/138292.png";
            coin.classList.add("coin");
            coin.style.left =
                Math.random() * window.innerWidth + "px";
            coin.style.animationDuration =
                1.2 + Math.random() + "s";
            document.body.appendChild(coin);
            setTimeout(() => coin.remove(), 2500);
        }, i * 120);
    }
}

function celebrate() {
    startFireworks();
    startCoins();
}

/* ---------------- 匯出 PDF ---------------- */
async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "mm", "a4");

    const target = document.querySelector(".container");
    if (!target) {
        alert("找不到要匯出的區塊！");
        return;
    }

    const canvas = await html2canvas(target, { scale: 2 });
    const imgData = canvas.toDataURL("image/jpeg", 0.95);

    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
    const pageHeight = pdf.internal.pageSize.getHeight();

    let heightLeft = pdfHeight;
    let position = 0;

    pdf.addImage(imgData, "JPEG", 0, position, pdfWidth, pdfHeight);
    heightLeft -= pageHeight;

    while (heightLeft > 0) {
        position -= pageHeight;
        pdf.addPage();
        pdf.addImage(imgData, "JPEG", 0, position, pdfWidth, pdfHeight);
        heightLeft -= pageHeight;
    }

    pdf.save("BlessingCards_Report.pdf");
}
</script>

</body>
</html>
