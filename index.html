<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BlessingCards128 â€” Stable A</title>

  <!-- è®“ LOGO å„ªå…ˆè¼‰å…¥ -->
  <link rel="preload" as="image" href="logo3524.png">

  <style>
    :root{ --gold:#d7a21b; --gold2:#f1d48b; --bg:#f7eedb; --text:#4b3a20; }
    body{ margin:0; font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
          background:var(--bg); color:var(--text); }
    .wrap{ max-width:760px; margin:0 auto; padding:18px 14px 28px; text-align:center; }
    #logo{ display:block; max-width:220px; width:56vw; margin:12px auto 10px; border-radius:10px; }
    h2{ margin:8px 0 10px; font-weight:800; letter-spacing:1px; }
    .statusRow{ display:flex; align-items:center; justify-content:center; gap:10px; margin:6px 0 10px; }
    .dot{ width:10px; height:10px; border-radius:50%; background:#999; }
    .dot.ok{ background:#2ea043; }
    .dot.warn{ background:#f59e0b; }
    .dot.bad{ background:#ef4444; }
    #status{ font-weight:700; }
    input{ width:min(92vw,520px); padding:10px 12px; border-radius:10px; border:2px solid #d9c08a; background:#fff; font-size:16px; }
    .btnRow{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:10px 0; }
    button{ border:none; cursor:pointer; padding:10px 14px; border-radius:18px;
            background:linear-gradient(#f6d890,#e8b545); color:#3c2a12; font-weight:800; box-shadow:0 3px 0 #c08c1f; }
    button:disabled{ opacity:.45; cursor:not-allowed; box-shadow:none; }
    .ghost{ background:#f1e3c5; box-shadow:none; border:2px solid #d9c08a; }
    .danger{ background:#ef4444; color:#fff; box-shadow:none; }
    .blink{ animation: blink 1s infinite; }
    @keyframes blink { 0%,100%{ filter:brightness(1); } 50%{ filter:brightness(1.25); } }
    #wheelWrap{ margin:14px auto 8px; width:min(92vw,520px); }
    canvas{ width:100%; height:auto; background:transparent; }
    .hint{ margin-top:10px; font-size:13px; opacity:.8; line-height:1.35; }
    #result{ margin:10px 0 0; font-weight:800; }
    #summaryBox{ margin:6px auto 0; max-width:620px; white-space:pre-line; font-size:13px; line-height:1.35; opacity:.9; }
  </style>
</head>

<body>
<div class="wrap">
  <img id="logo" src="logo3524.png" alt="LOGO" loading="eager" decoding="async" />

  <h2>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h2>

  <div class="statusRow">
    <span id="dot" class="dot"></span>
    <div id="status">ç³»çµ±åˆå§‹åŒ–ä¸­</div>
  </div>

  <input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼Œå¯ç”¨ç©ºç™½æˆ–é€—è™Ÿåˆ†éš”" autocomplete="off"/>

  <div class="btnRow">
    <button id="lockBtn">é–å®šåå–®</button>
    <button id="spinBtn">é–‹å§‹æŠ½å§“åï¼‹ç¶“å¥ï¼ˆç¬¬ä¸€è¼ªï¼‰</button>
  </div>

  <div class="btnRow">
    <button id="viewBtn" class="ghost">çœ‹ç´…åŒ…</button>
    <button id="secondBtn">æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
  </div>

  <div class="btnRow">
    <button id="resetBtn" class="ghost">å…¨éƒ¨æ­¸é›¶</button>
    <button id="pdfBtn" class="ghost">æŠ½ç±¤ç´€éŒ„ PDF</button>
  </div>

  <div class="btnRow">
    <button id="hardResetBtn" class="danger">å¼·åˆ¶è§£é™¤å¡æ­»</button>
  </div>

  <div id="wheelWrap">
    <canvas id="wheel" width="520" height="520"></canvas>
  </div>

  <div id="result"></div>
  <div id="summaryBox"></div>

  <!-- éŸ³æ•ˆå…ƒç´ ï¼ˆè¡Œå‹•è£ç½®éœ€è§£é–ï¼‰ -->
  <audio id="drum" preload="auto" src="audio/drum.mp3"></audio>
  <audio id="winSound" preload="auto" src="audio/win.mp3"></audio>

  <div class="hint">
    ä½¿ç”¨æµç¨‹ï¼š<br/>
    1) è¼¸å…¥å§“å â†’ã€Œé–å®šåå–®ã€<br/>
    2) ã€Œç¬¬ä¸€è¼ªã€æŠ½åˆ°å§“å + ç¶“å¥ç·¨è™Ÿ<br/>
    3) ã€Œç¬¬äºŒè¼ªã€æŠ½ç´…åŒ…ï¼ˆç¢ºèªç¶“å¥ï¼‰â†’ã€Œçœ‹ç´…åŒ…ã€<br/>
    4) viewer é»ã€Œä¸‹ä¸€ä½ã€å›ä¾†å¾Œï¼Œæœƒå›åˆ°ç¬¬ä¸€è¼ªä¸¦é–ƒçˆæç¤º
  </div>
</div>

<script>
/* =========================================================
   BlessingCards128 â€” Stable A (Production Build)
   ç›®æ¨™ï¼šä¸æ­»æ©Ÿã€ç‹€æ…‹å¯å›å¾©ã€æ‰‹æ©ŸéŸ³æ•ˆå¯è§£é–ã€ç„¡ QR ä¾è³´
========================================================= */

/* -------------------------
   0) Base pathï¼ˆå­ç›®éŒ„å®‰å…¨ï¼‰
------------------------- */
const BASE_PATH = (() => {
  // e.g. /BlessingCards128/index.html -> /BlessingCards128
  const base = location.pathname.replace(/\/[^\/]*$/, "");
  return base || "";
})();
const ASSET = (p) => `${BASE_PATH}/${p}`.replace(/\/{2,}/g,"/");

/* -------------------------
   1) DOM
------------------------- */
const el = {
  wheel: document.getElementById("wheel"),
  ctx: null,
  logo: document.getElementById("logo"),
  dot: document.getElementById("dot"),
  status: document.getElementById("status"),
  result: document.getElementById("result"),
  summary: document.getElementById("summaryBox"),
  nameInput: document.getElementById("nameInput"),
  lockBtn: document.getElementById("lockBtn"),
  spinBtn: document.getElementById("spinBtn"),
  secondBtn: document.getElementById("secondBtn"),
  viewBtn: document.getElementById("viewBtn"),
  resetBtn: document.getElementById("resetBtn"),
  pdfBtn: document.getElementById("pdfBtn"),
  hardResetBtn: document.getElementById("hardResetBtn"),
  drum: document.getElementById("drum"),
  win: document.getElementById("winSound"),
};
el.ctx = el.wheel ? el.wheel.getContext("2d") : null;

/* -------------------------
   2) å…¨åŸŸä¿å‘½è®Šæ•¸ï¼ˆå”¯ä¸€ä¾†æºï¼‰
------------------------- */
let animId = null;
let spinToken = 0;
let rotating = false;
let rotation = 0;

/* -------------------------
   3) ç‹€æ…‹æ©Ÿ
------------------------- */
const SYS = {
  INIT: "INIT",           // å°šæœªé–åå–®
  READY: "READY",         // å·²é–åå–®ï¼Œç­‰å¾…ç¬¬ä¸€è¼ª
  ROUND1: "ROUND1",       // ç¬¬ä¸€è¼ªæ—‹è½‰ä¸­
  ROUND2_READY: "ROUND2_READY", // ç¬¬ä¸€è¼ªå®Œæˆï¼Œç­‰å¾…ç¬¬äºŒè¼ª
  ROUND2: "ROUND2",       // ç¬¬äºŒè¼ªæ—‹è½‰ä¸­
  VIEWER_READY: "VIEWER_READY", // ç¬¬äºŒè¼ªå®Œæˆï¼Œå¯çœ‹ç´…åŒ…
  FINISHED: "FINISHED",   // å…¨éƒ¨å®Œæˆ
};

const STORE_KEY = "BC_STATE_V1";   // sessionStorage
const LOG_KEY   = "drawLogs";      // localStorage (æ—¢æœ‰)

const state = {
  systemState: SYS.INIT,
  names: [],
  idx: 0,                  // ç›®å‰æŠ½åˆ°ç¬¬å¹¾ä½ï¼ˆnames çš„ indexï¼‰
  currentName: null,
  currentVerseNo: null,     // "007"
  finished: false,
};

function saveState(extra = {}) {
  const payload = { ...state, ...extra };
  sessionStorage.setItem(STORE_KEY, JSON.stringify(payload));
}

function loadState() {
  // å¼·åˆ¶è§£é™¤å¯èƒ½æ®˜ç•™çš„æ—‹è½‰é–
  rotating = false;
  spinToken++;
  if (animId) { cancelAnimationFrame(animId); animId = null; }

  const raw = sessionStorage.getItem(STORE_KEY);
  if (!raw) return;

  try {
    const s = JSON.parse(raw);
    if (!s || typeof s !== "object") return;

    // åƒ…æ¡ç”¨ç™½åå–®æ¬„ä½ï¼Œé˜²æ­¢èˆŠç‰ˆæ±¡æŸ“
    state.systemState = Object.values(SYS).includes(s.systemState) ? s.systemState : SYS.INIT;
    state.names = Array.isArray(s.names) ? s.names : [];
    state.idx = Number.isFinite(s.idx) ? s.idx : 0;
    state.currentName = s.currentName || null;
    state.currentVerseNo = s.currentVerseNo || null;
    state.finished = !!s.finished;

  } catch(e) {
    console.warn("âš  loadState failed:", e);
  }
}

// å”¯ä¸€æ”¹ç‹€æ…‹å‡ºå£
function setState(next, extra = {}) {
  state.systemState = next;
  Object.assign(state, extra);
  saveState();
  applyUI();
  // console.log("STATE â†’", next, JSON.parse(JSON.stringify(state)));
}

/* -------------------------
   4) éŸ³æ•ˆè§£é–ï¼ˆè¡Œå‹•è£ç½®ï¼‰
------------------------- */
let audioUnlocked = false;

function unlockAudioOnce() {
  if (audioUnlocked) return;
  try {
    [el.drum, el.win].forEach(a => {
      if (!a) return;
      a.muted = true;
      const p = a.play();
      if (p && typeof p.then === "function") {
        p.then(() => {
          a.pause();
          a.currentTime = 0;
          a.muted = false;
        }).catch(()=>{});
      }
    });
    audioUnlocked = true;
    console.log("ğŸ”“ Audio unlocked");
  } catch(e){}
}

// ä¸€å®šæœƒé»çš„åœ°æ–¹ç¶ä¸€æ¬¡
["pointerdown","touchstart","click"].forEach(evt=>{
  document.addEventListener(evt, unlockAudioOnce, { once:true, passive:true });
});
el.lockBtn.addEventListener("click", unlockAudioOnce, { once:true });
el.spinBtn.addEventListener("click", unlockAudioOnce, { once:true });
el.secondBtn.addEventListener("click", unlockAudioOnce, { once:true });
el.viewBtn.addEventListener("click", unlockAudioOnce, { once:true });

/* -------------------------
   5) é è¼‰ï¼ˆä¸å½±éŸ¿ä¸»æµç¨‹ï¼‰
------------------------- */
(function preload(){
  // ä¿®æ­£è³‡æºè·¯å¾‘ï¼ˆå­ç›®éŒ„ï¼‰
  el.logo.src = ASSET("logo3524.png");

  // LOGO warm
  const img = new Image();
  img.src = ASSET("logo3524.png");

  // éŸ³æ•ˆ warmï¼ˆä½†ä¸è‡ªå‹•æ’­æ”¾ï¼‰
  if (el.drum) el.drum.src = ASSET("audio/drum.mp3");
  if (el.win)  el.win.src  = ASSET("audio/win.mp3");

  // ç´…åŒ…åœ–ç‰‡ warm
  const MAX = (window.innerWidth < 768 ? 24 : 128);
  let ok = 0;
  for (let i=1;i<=MAX;i++){
    const n = String(i).padStart(3,"0");
    const im = new Image();
    im.onload = () => { ok++; if (ok===MAX) console.log("âœ… ç´…åŒ…åœ–ç‰‡æš–æ©Ÿå®Œæˆï¼ˆ"+MAX+" å¼µï¼‰"); };
    im.src = ASSET("cards/"+n+".png");
  }
})();

/* -------------------------
   6) è½‰ç›¤ç¹ªè£½
------------------------- */
function resizeCanvasForDPR() {
  if (!el.wheel || !el.ctx) return;
  const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  const css = Math.min(window.innerWidth * 0.92, 520);
  el.wheel.style.width = css + "px";
  el.wheel.style.height = css + "px";
  el.wheel.width  = Math.floor(css * dpr);
  el.wheel.height = Math.floor(css * dpr);
  el.ctx.setTransform(dpr,0,0,dpr,0,0);
  drawWheel(rotation);
}
window.addEventListener("resize", () => resizeCanvasForDPR(), { passive:true });

function drawWheel(angle=0, labels=null){
  if (!el.ctx || !el.wheel) return;
  const ctx = el.ctx;
  const w = parseFloat(el.wheel.style.width || "520");
  const cx = w/2, cy = w/2;
  const r = w/2 - 6;

  ctx.clearRect(0,0,w,w);

  // background circle
  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(angle);

  const list = labels || ["1","2","3"]; // placeholder
  const N = Math.max(1, list.length);

  for (let i=0;i<N;i++){
    const a0 = (i/N) * Math.PI*2;
    const a1 = ((i+1)/N)* Math.PI*2;

    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,r,a0,a1);
    ctx.closePath();
    ctx.fillStyle = (i%2===0) ? "#f6d890" : "#f1d48b";
    ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.9)";
    ctx.lineWidth = 3;
    ctx.stroke();

    // text
    ctx.save();
    ctx.rotate((a0+a1)/2);
    ctx.textAlign="right";
    ctx.textBaseline="middle";
    ctx.fillStyle="#4b3a20";
    ctx.font="18px system-ui";
    ctx.fillText(String(list[i]), r-14, 0);
    ctx.restore();
  }

  ctx.restore();

  // pointer
  ctx.save();
  ctx.translate(cx,cy);
  ctx.beginPath();
  ctx.moveTo(0,-r-2);
  ctx.lineTo(-8,-r+18);
  ctx.lineTo(8,-r+18);
  ctx.closePath();
  ctx.fillStyle="#ffffff";
  ctx.fill();
  ctx.strokeStyle="#d9c08a";
  ctx.lineWidth=2;
  ctx.stroke();
  ctx.restore();
}

/* -------------------------
   7) Spinï¼ˆä¿å‘½ç‰ˆï¼‰
------------------------- */
const DURATION = 2600;

function ease(t){
  // easeOutCubic
  return 1 - Math.pow(1-t, 3);
}

function spin(list, clockwise, onDone){
  if (!Array.isArray(list) || list.length === 0) return;

  // ä½œå»¢èˆŠå‹•ç•«
  const myToken = ++spinToken;

  // å¼·åˆ¶åœèˆŠ rAF
  if (animId) { cancelAnimationFrame(animId); animId = null; }

  rotating = true;

  // é¡¯ç¤º UI
  el.result.textContent = "";
  el.summary.textContent = "";

  // æ’­ drumï¼ˆè¢«é˜»æ“‹ä¹Ÿä¸å ±éŒ¯ï¼‰
  try{
    unlockAudioOnce();
    if (el.drum){
      el.drum.currentTime = 0;
      const p = el.drum.play();
      if (p && typeof p.catch === "function") p.catch(()=>{});
    }
  }catch(e){}

  const target = list[Math.floor(Math.random()*list.length)];
  const idx = list.indexOf(target);

  const base = rotation;
  const N = list.length;
  const slice = (Math.PI*2)/N;
  // æŒ‡é‡åœ¨ä¸Šæ–¹ï¼ˆ-pi/2ï¼‰ï¼Œæ—‹è½‰è®“ idx å°åˆ°æŒ‡é‡ï¼šå¤šè½‰ 5~6 åœˆ
  const rounds = 5 + Math.random(); // 5~6
  const sign = clockwise ? 1 : -1;
  const end = base + sign*(rounds*Math.PI*2 + idx*slice);

  const start = performance.now();
  const hardStopAt = start + DURATION + 350;
  let finished = false;

  const failSafeId = setTimeout(()=>{
    if (myToken !== spinToken) return;
    if (finished) return;
    console.warn("ğŸ§¯ spin failsafe fired");
    finish();
  }, DURATION + 1400);

  function finish(){
    if (myToken !== spinToken) return;
    if (finished) return;
    finished = true;
    clearTimeout(failSafeId);

    if (animId) { cancelAnimationFrame(animId); animId = null; }

    rotation = end;
    drawWheel(rotation, list);

    rotating = false;
    try { onDone(target, idx); } catch(e){ console.error("spin callback crashed:", e); }
    applyUI();
  }

  function frame(now){
    if (myToken !== spinToken) return; // èˆŠå‹•ç•«è‡ªæ®º
    if (finished) return;

    if (now >= hardStopAt) { finish(); return; }

    let t = (now - start) / DURATION;
    if (t < 0) t = 0;
    if (t >= 1) { finish(); return; }

    rotation = base + (end - base) * ease(t);
    drawWheel(rotation, list);
    animId = requestAnimationFrame(frame);
  }

  drawWheel(rotation, list);
  animId = requestAnimationFrame(frame);
}

/* -------------------------
   8) UI å°æ‡‰
------------------------- */
function setDot(kind){
  el.dot.className = "dot " + (kind || "");
}

function applyUI(){
  // reset blink
  [el.spinBtn, el.secondBtn, el.viewBtn].forEach(b=>b.classList.remove("blink"));

  // default disable
  el.spinBtn.disabled = true;
  el.secondBtn.disabled = true;
  el.viewBtn.disabled = true;
  el.pdfBtn.disabled = false;
  el.lockBtn.disabled = false;

  if (!state.names.length) {
    setDot("warn");
    el.status.textContent = "è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®";
    el.lockBtn.disabled = false;
    return;
  }

  switch(state.systemState){
    case SYS.INIT:
      setDot("warn");
      el.status.textContent = "è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®";
      el.lockBtn.disabled = false;
      break;

    case SYS.READY:
      setDot("ok");
      el.status.textContent = "åå–®å·²é–å®šï¼Œè«‹é–‹å§‹ç¬¬ä¸€è¼ªæŠ½ç±¤";
      el.spinBtn.disabled = false;
      el.spinBtn.classList.add("blink");
      break;

    case SYS.ROUND1:
      setDot("warn");
      el.status.textContent = "ç¬¬ä¸€è¼ªæ—‹è½‰ä¸­â€¦";
      break;

    case SYS.ROUND2_READY:
      setDot("ok");
      el.status.textContent = "ç¬¬ä¸€è¼ªå®Œæˆï¼Œè«‹æŒ‰ç¬¬äºŒè¼ªæŠ½ç´…åŒ…";
      el.secondBtn.disabled = false;
      el.secondBtn.classList.add("blink");
      break;

    case SYS.ROUND2:
      setDot("warn");
      el.status.textContent = "ç¬¬äºŒè¼ªæ—‹è½‰ä¸­â€¦";
      break;

    case SYS.VIEWER_READY:
      setDot("ok");
      el.status.textContent = "ç¬¬äºŒè¼ªå®Œæˆï¼šå¯çœ‹ç´…åŒ…ï¼Œæˆ–ä¸‹ä¸€ä½";
      el.viewBtn.disabled = false;
      el.viewBtn.classList.add("blink");
      // è‹¥ä½ ä»è¦å…è¨±é‡æŠ½ç¬¬äºŒè¼ªï¼Œå¯æ‰“é–‹ secondBtn
      el.secondBtn.disabled = true;
      break;

    case SYS.FINISHED:
      setDot("ok");
      el.status.textContent = "æœ¬è¼ªå®Œæˆï¼Œå¯ä¸‹è¼‰ PDF æˆ–é‡ç½®";
      el.pdfBtn.disabled = false;
      el.lockBtn.disabled = false;
      break;

    default:
      setDot("bad");
      el.status.textContent = "ç³»çµ±ç‹€æ…‹ç•°å¸¸ï¼Œè«‹æŒ‰ã€Œå¼·åˆ¶è§£é™¤å¡æ­»ã€";
      el.hardResetBtn.classList.add("blink");
      break;
  }
}

/* -------------------------
   9) ä¸»è¦æµç¨‹
------------------------- */
function parseNames(input){
  return input
    .split(/[\s,ï¼Œ]+/g)
    .map(s=>s.trim())
    .filter(Boolean);
}

function appendLog(name, verseNo, refText){
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,"0");
  const mm = String(now.getMinutes()).padStart(2,"0");
  const ss = String(now.getSeconds()).padStart(2,"0");
  const time = `${hh}:${mm}:${ss}`;

  let logs = [];
  try { logs = JSON.parse(localStorage.getItem(LOG_KEY) || "[]"); } catch {}
  if (!Array.isArray(logs)) logs = [];
  logs.push({ time, name, no: verseNo, ref: refText || verseNo });
  localStorage.setItem(LOG_KEY, JSON.stringify(logs));
}

function hardResetToReady(){
  // å®Œæ•´è§£é™¤æ—‹è½‰/å‹•ç•«/ç‹€æ…‹
  rotating = false;
  spinToken++;
  if (animId) { cancelAnimationFrame(animId); animId=null; }
  rotation = 0;
  state.currentName = null;
  state.currentVerseNo = null;
  setState(state.names.length ? SYS.READY : SYS.INIT);
  drawWheel(rotation, state.names.length ? state.names : ["1","2","3"]);
  el.result.textContent = "";
  el.summary.textContent = "";
  console.warn("ğŸ§¯ HARD RESET executed");
}

function advanceIndex(){
  state.idx = Math.min(state.idx + 1, state.names.length);
  state.currentName = null;
  state.currentVerseNo = null;

  if (state.idx >= state.names.length){
    setState(SYS.FINISHED, { finished:true });
  } else {
    setState(SYS.READY);
  }
}

// è®€å– viewer å›æµæ——æ¨™ï¼šåªåšä¸€æ¬¡ï¼Œé¿å…æ®˜ç•™
(function handleViewerReturn(){
  const flag = sessionStorage.getItem("BC_RETURN");
  if (!flag) return;
  sessionStorage.removeItem("BC_RETURN");

  if (flag === "NEXT") {
    // viewer æŒ‰äº†ã€Œä¸‹ä¸€ä½ã€
    console.log("ğŸ”„ Viewer return â†’ NEXT");
    advanceIndex();
  } else if (flag === "BACK") {
    // viewer åªæ˜¯è¿”å›ï¼ˆä¸å‰é€²ï¼‰
    console.log("ğŸ”„ Viewer return â†’ BACK");
    setState(SYS.VIEWER_READY);
  }
})();

/* -------------------------
   10) Buttons
------------------------- */
el.lockBtn.onclick = () => {
  unlockAudioOnce();
  const list = parseNames(el.nameInput.value);

  if (!list.length){
    alert("è«‹å…ˆè¼¸å…¥è‡³å°‘ä¸€å€‹å§“å");
    return;
  }
  state.names = list;
  state.idx = 0;
  state.currentName = null;
  state.currentVerseNo = null;
  state.finished = false;

  saveState();
  setState(SYS.READY);

  drawWheel(rotation, state.names);
};

el.spinBtn.onclick = () => {
  if (rotating) return;
  if (!state.names.length) return;

  // ç¬¬ä¸€è¼ªï¼šæŠ½å§“å + ç¶“å¥ç·¨è™Ÿï¼ˆé€™è£¡ç”¨ã€Œç¶“å¥ç·¨è™Ÿã€å…ˆæŠ½å‡ºï¼‰
  setState(SYS.ROUND1);

  spin(state.names, true, (namePicked, idx)=>{
    // æŠ½åˆ°å§“åï¼šå›ºå®šæˆç•¶å‰
    state.currentName = namePicked;

    // æŠ½ç¶“å¥ç·¨è™Ÿ 001-128ï¼ˆé¿å…é‡è¦†ï¼šé  localStorage logs çš„ no å»æ’é™¤ï¼‰
    let used = new Set();
    try{
      const logs = JSON.parse(localStorage.getItem(LOG_KEY) || "[]");
      if (Array.isArray(logs)) logs.forEach(l => l && l.no && used.add(String(l.no)));
    }catch(e){}
    let tries = 0;
    let no = null;
    while(tries < 500){
      tries++;
      const r = String(Math.floor(Math.random()*128)+1).padStart(3,"0");
      if (!used.has(r)) { no = r; break; }
    }
    no = no || String(Math.floor(Math.random()*128)+1).padStart(3,"0");
    state.currentVerseNo = no;

    el.result.textContent = `ğŸ¯ æŠ½ä¸­å§“åï¼šã€Œ${namePicked}ã€`;
    el.summary.textContent = `ğŸ“– ç¶“å¥ç´…åŒ…ç·¨è™Ÿï¼š${no}\nï¼ˆè«‹æŒ‰ç¬¬äºŒè¼ªç¢ºèªä¸¦å¯çœ‹ç´…åŒ…ï¼‰`;

    setState(SYS.ROUND2_READY);
  });
};

el.secondBtn.onclick = () => {
  if (rotating) return;
  if (!state.currentName || !state.currentVerseNo) {
    alert("è«‹å…ˆå®Œæˆç¬¬ä¸€è¼ªï¼ˆå§“åï¼‹ç¶“å¥ç·¨è™Ÿï¼‰");
    return;
  }

  setState(SYS.ROUND2);

  // ç¬¬äºŒè¼ªï¼šç›´æ¥ã€Œç¢ºèªç¶“å¥ã€â€”â€”é€™è£¡æˆ‘å€‘è®“è½‰ç›¤è½‰ä¸€ä¸‹åšå„€å¼æ„Ÿï¼Œä½†çµæœå›ºå®šæ˜¯ currentVerseNo
  const list = ["A","B","C","D","E","F"]; // åªæ˜¯æ•ˆæœï¼Œä¸å½±éŸ¿çµæœ
  spin(list, false, ()=>{
    const no = state.currentVerseNo;
    const name = state.currentName;

    // è¨˜éŒ„æŠ½ç±¤ï¼ˆref å…ˆç”¨ noï¼Œviewer å†é¡¯ç¤ºåœ–ç‰‡ï¼‰
    appendLog(name, no, no);

    el.result.textContent = `ğŸ‰ æŠ½ä¸­ç¶“å¥ã€Œ${no}ã€`;
    el.summary.textContent = `â¡ï¸ è«‹æŒ‰ã€Œçœ‹ç´…åŒ…ã€æŸ¥çœ‹åœ–ç‰‡\nâœ… çœ‹å®ŒæŒ‰ viewer çš„ã€Œä¸‹ä¸€ä½ã€å›ä¾†ç¹¼çºŒ`;

    setState(SYS.VIEWER_READY);
  });
};

el.viewBtn.onclick = () => {
  if (!state.currentVerseNo) {
    alert("å°šæœªç”¢ç”Ÿç¶“å¥ç·¨è™Ÿ");
    return;
  }
  // é€² viewer
  const no = state.currentVerseNo;
  saveState();
  window.location.href = `viewer.html?no=${encodeURIComponent(no)}`;
};

el.resetBtn.onclick = () => {
  if (!confirm("ç¢ºå®šè¦å…¨éƒ¨æ­¸é›¶ï¼Ÿï¼ˆåå–®ã€ç‹€æ…‹ã€æ—‹è½‰é–æœƒæ¸…ç©ºï¼›æŠ½ç±¤ç´€éŒ„ä¸æœƒæ¸…ï¼‰")) return;
  sessionStorage.removeItem(STORE_KEY);
  state.systemState = SYS.INIT;
  state.names = [];
  state.idx = 0;
  state.currentName = null;
  state.currentVerseNo = null;
  state.finished = false;
  rotating = false;
  spinToken++;
  if (animId) { cancelAnimationFrame(animId); animId=null; }
  rotation = 0;

  el.nameInput.value = "";
  drawWheel(rotation, ["1","2","3"]);
  applyUI();
};

el.hardResetBtn.onclick = () => hardResetToReady();

/* PDFï¼šé€™è£¡åªä¿ç•™å…¥å£ï¼Œé¿å…ä½ çš„èˆŠç‰ˆ null.fillStyle å´©æ½°
   è‹¥ä½ è¦æ¢å¾© pdfmake ç‰ˆï¼Œæˆ‘å†æŠŠã€Œå·²ç¢ºèªå¯ç”¨ã€çš„ pdf æ¨¡çµ„å–®ç¨æ¥å›ä¾† */
el.pdfBtn.onclick = () => {
  alert("PDF æ¨¡çµ„ç›®å‰æœªç¶å®šï¼ˆé¿å…å´©æ½°ï¼‰ã€‚\nè‹¥ä½ è¦æˆ‘æ¥å› pdfmake ç‰ˆæœ¬ï¼Œæˆ‘æœƒç”¨ã€Œå›ºå®šä»‹é¢ + å¯é¸è¼‰å…¥ã€æ–¹å¼æ•´åˆã€‚");
};

/* -------------------------
   11) å•Ÿå‹•
------------------------- */
loadState();

// é¦–æ¬¡è‹¥é‚„æ²’åå–®ï¼Œçµ¦ placeholderï¼›æœ‰åå–®å‰‡ç•«åå–®
drawWheel(rotation, state.names.length ? state.names : ["1","2","3"]);
applyUI();

</script>
</body>
</html>
