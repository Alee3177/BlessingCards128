<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰- å–®æ©Ÿç©©å®šAç‰ˆï¼ˆè¦–è¦ºé‚„åŸï¼‰</title>

<link rel="preload" as="image" href="logo3524.png">

<style>
:root{
  --bg:#fbf2df;
  --text:#5b3a00;
  --btn:#f4b63a;
  --btnShadow:#d59b25;
  --btnDisabled:#f0ddaa;
  --danger:#E53935;
  --dangerShadow:#B71C1C;
  --blue:#1976D2;
  --blueShadow:#0d47a1;
}
body{
  font-family:"Noto Sans TC",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  background:var(--bg);
  text-align:center;
  margin:0;
  padding:16px;
  color:var(--text);
}
.logo{width:220px;margin:10px auto 0;display:block;}
h2{margin:12px 0 6px 0;}

#masterStatus{
  display:flex;align-items:center;justify-content:center;gap:8px;
  margin:8px auto 4px auto;font-size:14px;font-weight:800;
}
#masterStatus .dot{width:12px;height:12px;border-radius:50%;background:#2e7d32;box-shadow:0 0 8px rgba(46,125,50,.7);}

#nameInput{
  width:90%;max-width:520px;padding:10px 14px;
  margin-top:10px;border-radius:12px;border:2px solid #e3c78c;
  font-size:18px;text-align:center;box-sizing:border-box;
  background:#fffdf8;
}

.btn-row{margin-top:8px;display:flex;justify-content:center;gap:10px;flex-wrap:wrap;}
.btn{
  min-width:130px;
  padding:10px 16px;
  border-radius:999px;
  border:none;
  background:var(--btn);
  color:var(--text);
  font-size:15px;
  font-weight:800;
  box-shadow:0 3px 0 var(--btnShadow);
  cursor:pointer;
}
.btn:disabled{background:var(--btnDisabled);box-shadow:none;cursor:default;}
.btn-pdf-ready{background:var(--blue)!important;color:#fff!important;box-shadow:0 3px 0 var(--blueShadow)!important;}
.btn-reset-danger{background:var(--danger)!important;color:#fff!important;box-shadow:0 3px 0 var(--dangerShadow)!important;}

@keyframes mainBlink{
  0%{opacity:1;transform:scale(1);}
  50%{opacity:.55;transform:scale(1.05);}
  100%{opacity:1;transform:scale(1);}
}
.blink-all{animation:mainBlink 1s infinite;}

#wheel-container{position:relative;width:360px;height:360px;margin:14px auto 10px;}
#wheel{width:360px;height:360px;border-radius:50%;background:#fff;box-shadow:0 10px 25px rgba(0,0,0,.12);}
#confettiCanvas{position:absolute;left:0;top:0;width:360px;height:360px;pointer-events:none;}
#centerText{
  position:absolute;left:0;top:0;width:360px;height:360px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  pointer-events:none;font-size:18px;font-weight:900;white-space:pre-line;
  padding:26px;box-sizing:border-box;
  text-shadow:0 1px 0 rgba(255,255,255,.55);
}

#status{margin-top:8px;font-weight:800;white-space:pre-line;}
#result{margin-top:8px;white-space:pre-line;font-weight:900;}
#summaryBox{margin-top:10px;white-space:pre-line;font-weight:800;}

#redEnvelopePanel{
  display:none;
  margin:18px auto 0;
  max-width:560px;
  padding:12px;
  border:2px solid #f6c453;
  border-radius:12px;
  background:#1a1a1a;
  color:#ffd54f;
  text-align:center;
}
#redEnvelopePanel img{
  max-width:100%;
  border-radius:10px;
  background:#fff;
  padding:6px;
}
<<<<<<< HEAD

/* ç¶ ï¼šä¸»æ§æ­£å¸¸ */
.status-ok .dot{
  background:#2e7d32;
  box-shadow:0 0 8px rgba(46,125,50,.8);
}

/* é»ƒï¼šæ“ä½œä¸­ */
.status-warn .dot{
  background:#f9a825;
  box-shadow:0 0 8px rgba(249,168,37,.8);
}

/* ç´…ï¼šé–å®š / é›™ä¸»æŒ / éŒ¯èª¤ */
.status-error .dot{
  background:#c62828;
  box-shadow:0 0 8px rgba(198,40,40,.8);
}

=======
>>>>>>> 406dfd9ed4110734e54e08c4ec3a4f2240d29c62
</style>

<script src="verseRefMap.js?v=20260105"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<<<<<<< HEAD

</head>

<body>

<img src="logo3524.png" class="logo" />
=======
</head>

<body>
<img src="logo3524.png" class="logo" loading="eager" decoding="async"
     onerror="this.style.display='none'; console.warn('âš  logo3524.png è¼‰å…¥å¤±æ•—');"/>
>>>>>>> 406dfd9ed4110734e54e08c4ec3a4f2240d29c62
<h2>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h2>

<div id="masterStatus"><span class="dot"></span><span class="label">å–®æ©Ÿç©©å®šæ¨¡å¼</span></div>

<input id="nameInput" placeholder="è«‹è¼¸å…¥å§“åï¼Œå¯ç”¨ç©ºç™½ / é€—è™Ÿ / æ›è¡Œåˆ†éš”">

<div class="btn-row">
  <button id="lockBtn" class="btn">é–å®šåå–®</button>
  <button id="spinBtn" class="btn" disabled>é–‹å§‹æŠ½å§“åï¼ˆç¬¬ä¸€è¼ªï¼‰</button>
</div>

<div class="btn-row">
  <button id="viewBtn" class="btn" disabled>çœ‹ç´…åŒ…</button>
  <button id="secondBtn" class="btn" disabled>æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
</div>

<div class="btn-row">
  <button id="resetBtn" class="btn">å…¨éƒ¨æ­¸é›¶</button>
  <button id="pdfBtn" class="btn" disabled>æŠ½ç±¤ç´€éŒ„ PDF</button>
</div>

<div id="wheel-container">
  <canvas id="wheel" width="360" height="360"></canvas>
  <canvas id="confettiCanvas" width="360" height="360"></canvas>
  <div id="centerText"></div>
</div>

<div id="status">è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®</div>
<div id="result"></div>
<div id="summaryBox"></div>

<<<<<<< HEAD
<audio id="drum" preload="auto" playsinline>
  <source src="audio/drum.mp3" type="audio/mpeg">
</audio>

<audio id="winSound" preload="auto" playsinline>
  <source src="audio/win.mp3" type="audio/mpeg">
</audio>

<!-- ===============================
  BlessingCards128 Resource Preloader
  é è¼‰ LOGO / éŸ³æ•ˆ / ç´…åŒ…åœ–ç‰‡
================================ -->
<script>
(function preloadResources(){

  console.log("ğŸ”¥ BlessingCards128 è³‡æºæš–æ©Ÿä¸­...");

  /* ===== 1ï¸âƒ£ LOGO ===== */
  const preloadLogo = new Image();
  preloadLogo.src = "logo3524.png";

  /* ===== 2ï¸âƒ£ éŸ³æ•ˆ ===== */
  const preloadDrum = new Audio();
  preloadDrum.src = "audio/drum.mp3";
  preloadDrum.load();

  const preloadWin = new Audio();
  preloadWin.src = "audio/win.mp3";
  preloadWin.load();

  /* ===== 3ï¸âƒ£ ç´…åŒ…åœ–ç‰‡ï¼ˆ001â€“128ï¼‰===== */
  const MAX_PRELOAD = 128;
  const loaded = { count: 0 };

  for (let i = 1; i <= MAX_PRELOAD; i++) {
    const img = new Image();
    const no = String(i).padStart(3, "0");

    img.onload = () => {
      loaded.count++;
      if (loaded.count === MAX_PRELOAD) {
        console.log("âœ… æ‰€æœ‰ç´…åŒ…åœ–ç‰‡å·²æš–æ©Ÿå®Œæˆï¼ˆ001â€“128ï¼‰");
      }
    };

    img.onerror = () => {
      console.warn("âš  ç„¡æ³•é è¼‰åœ–ç‰‡:", "cards/" + no + ".png");
    };

    img.src = "cards/" + no + ".png";
  }

})();
</script>

<script>
(function(){

let animId = null;   // requestAnimationFrame æ§åˆ¶ç”¨ï¼ˆé˜²æ­¢å‹•ç•«æ®˜ç•™ / æ­»æ©Ÿï¼‰

/* ==== DOM å…ƒä»¶ ==== */
const wheel = document.getElementById("wheel");
const ctx   = wheel.getContext("2d");
const hlSVG = document.getElementById("hl-svg");
const centerText = document.getElementById("centerText");

const confettiCanvas = document.getElementById("confettiCanvas");
const confCtx = confettiCanvas.getContext("2d");

const lockBtn   = document.getElementById("lockBtn");
const spinBtn   = document.getElementById("spinBtn");
const resetBtn  = document.getElementById("resetBtn");
const secondBtn = document.getElementById("secondBtn");
const viewBtn   = document.getElementById("viewBtn");
const pdfBtn    = document.getElementById("pdfBtn");
const nameInput = document.getElementById("nameInput");

const statusDiv  = document.getElementById("status");
const resultDiv  = document.getElementById("result");
const summaryBox = document.getElementById("summaryBox");

const drum = document.getElementById("drum");
const winSound = document.getElementById("winSound");

/* ==== éŸ³æ•ˆè§£é–ï¼ˆåªéœ€ä¸€æ¬¡ï¼‰ ==== */
let audioUnlocked = false;

function unlockAudio() {
  if (audioUnlocked) return;

  try {
    winSound.muted = true;
    winSound.play().then(() => {
      winSound.pause();
      winSound.currentTime = 0;
      winSound.muted = false;
      audioUnlocked = true;
      console.log("ğŸ”“ Audio unlocked");
    });
  } catch (e) {
    console.log("Audio unlock failed:", e);
  }
}

/* ==== ä¸»æ§æ——æ¨™ ==== */
const IS_MASTER = true;

/* ==== é–‹ç™¼ / ç¾å ´æ§åˆ¶ ==== */
const DISABLE_MASTER_LOCK = true;

/* ==== ç‹€æ…‹è®Šæ•¸ ==== */
let names = [];
let usedName = new Set();
let verseUsed = new Set();
let round2Started = false; // âœ… ç¬¬äºŒè¼ªæ˜¯å¦å·²ç¶“è¢«æŒ‰é

/* ==== å•†ç”¨ç´šåˆ†é è­˜åˆ¥ ==== */
const TAB_ID = Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 6);
const HEARTBEAT_TTL = 5000; // 5 ç§’å…§è¦–ç‚ºã€Œæ´»èºåˆ†é ã€

let rotation = 0;
let rotating = false;
let lastWinnerIndex = null;
=======
<div id="redEnvelopePanel">
  <div style="font-weight:900;margin-bottom:6px;">ğŸ æŠ½ä¸­ç´…åŒ…ç¶“å¥ <span id="envelopeVerse"></span></div>
  <div style="font-size:14px;opacity:.9;margin-bottom:8px;" id="envelopeRef"></div>
  <img id="envelopeImg" alt="red envelope"/>
  <div style="margin-top:10px;">
    <button id="downloadEnvelopeBtn" class="btn">ğŸ“¥ ä¸‹è¼‰ç´…åŒ…åœ–ç‰‡</button>
    <button id="nextPersonBtn" class="btn blink-all">â¡ ä¸‹ä¸€ä½</button>
  </div>
</div>

<audio id="drum" preload="auto" playsinline src="audio/drum.mp3"></audio>
<audio id="winSound" preload="auto" playsinline src="audio/win.mp3"></audio>

<script>
const HISTORY_KEY = "BLESSING_HISTORY_A_VISUAL_V1";
const SYS = { READY:"READY", LOCKED:"LOCKED", R1_DONE:"R1_DONE", R2_DONE:"R2_DONE" };

let sysState = SYS.READY;
let names = [];
let remainingNames = [];
let remainingVerses = [];
let currentName = null;
>>>>>>> 406dfd9ed4110734e54e08c4ec3a4f2240d29c62
let currentVerse = null;
let history = [];

const wheel = document.getElementById("wheel");
const ctx = wheel.getContext("2d");
let rotation = 0;
let wheelItems = [];
let rotating = false;
let selectedIndex = null;

<<<<<<< HEAD
/* ==== ç³»çµ±ç‹€æ…‹æ©Ÿ ==== */
const SYS_STATE = {
  INIT: "INIT",           // åˆå§‹
  READY: "READY",        // åå–®é–å®š
  ROUND1: "ROUND1",      // ç¬¬ä¸€è¼ªæ—‹è½‰ä¸­
  ROUND2: "ROUND2",      // ç¬¬äºŒè¼ªæ—‹è½‰ä¸­
  VIEWER: "VIEWER",      // æŸ¥çœ‹ç´…åŒ…
  FINISHED: "FINISHED"  // å…¨éƒ¨å®Œæˆ
 };
let lastHeartbeat = Date.now();
let systemState = SYS_STATE.INIT;
let lastActionAt = 0;   // é˜²é€£é»ç¯€æµç”¨
=======
function $(id){ return document.getElementById(id); }
>>>>>>> 406dfd9ed4110734e54e08c4ec3a4f2240d29c62

function getVerseRef(no){
  try{ if (typeof verseRefMap==="object") return verseRefMap[no]||""; }catch{}
  return "";
}

<<<<<<< HEAD
/* ========= å·¥å…·å‡½å¼ ========= */
// â° æ™‚é–“æ ¼å¼çµ±ä¸€å·¥å…·ï¼ˆPDF / ç´€éŒ„ / UI å…±ç”¨ï¼‰
function formatTime2(date = new Date()) {
  const h = String(date.getHours()).padStart(2, "0");
  const m = String(date.getMinutes()).padStart(2, "0");
  const s = String(date.getSeconds()).padStart(2, "0");
=======
function genVerses(){
  const a=[]; for(let i=1;i<=128;i++) a.push(String(i).padStart(3,"0")); return a;
}

function unlockAudioOnce(){
  document.removeEventListener("click", unlockAudioOnce);
  ["winSound","drum"].forEach(id=>{
    const a=$(id);
    if(!a) return;
    try{
      a.muted=true;
      const p=a.play();
      if(p&&p.then) p.then(()=>{a.pause();a.currentTime=0;a.muted=false;}).catch(()=>{a.muted=false;});
    }catch{}
  });
}

document.addEventListener("click", unlockAudioOnce, { once:true });
>>>>>>> 406dfd9ed4110734e54e08c4ec3a4f2240d29c62

function formatTime(ts){
  const d=new Date(ts);
  return d.toLocaleTimeString("zh-TW",{hour12:false});
}

function loadHistory(){
  try{ const r=localStorage.getItem(HISTORY_KEY); if(r) return JSON.parse(r)||[]; }catch{}
  return [];
}
function saveHistory(){ try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); }catch{} }

function renderHistorySummary(){
  if(!history.length) return "";
  const lines=["ğŸ“Œ æŠ½ç±¤ç´€éŒ„"];
  history.forEach((h,i)=>{
    const ref=h.ref?`ï¼ˆ${h.ref}ï¼‰`:"";
    lines.push(`${String(i+1).padStart(2,"0")}. ${h.name} - ${h.verse} ${ref} ${formatTime(h.ts)}`);
  });
  return lines.join("\n");
}

<<<<<<< HEAD
function canAct(delay = 500) // æ‰€æœ‰æŒ‰éˆ• 500ms å…§åªèƒ½è§¸ç™¼ä¸€æ¬¡ï¼ˆé˜²é›™æ“Šã€æ‰‹æ©Ÿèª¤è§¸ï¼‰
{
const now = Date.now();
if (now - lastActionAt < delay) return false;

lastActionAt = now;

return true;
}

function audit(action, detail = "") // æ¯å€‹æ“ä½œéƒ½å¯è¿½è¹¤ã€å¯åŒ¯å‡ºã€å¯æŸ¥è²¬
{
  if (!IS_MASTER) return;   // ğŸ”’ åªæœ‰ä¸»æ§å°èƒ½å¯«ç¨½æ ¸ç´€éŒ„

  const logs = JSON.parse(localStorage.getItem("auditLogs") || "[]");
logs.push({
  timeISO: new Date().toISOString(),        // ğŸ”’ ç³»çµ±ç¨½æ ¸ç”¨ï¼ˆä¸å¯æ”¹ï¼‰
  timeDisplay: formatTime2(new Date()),    // ğŸ‘ äººé¡å¯è®€ï¼ˆä¸‹åˆ 03:57:30ï¼‰
  session: TAB_ID,
  state: systemState,
  action,
  detail
});
  localStorage.setItem("auditLogs", JSON.stringify(logs));
}

function applyUIState() {
  // =========================
  // 0. ç‹€æ…‹ç‡ˆæœ€é«˜å„ªå…ˆæ¬Š
  // =========================
  if (rotating) {
    setStatusLight("warn", "è½‰ç›¤æ—‹è½‰ä¸­");
  } else {
    switch (systemState) {
      case SYS_STATE.INIT:
        setStatusLight("ok", "ç³»çµ±å¾…å‘½ä¸­");
        break;

      case SYS_STATE.READY:
        setStatusLight("ok", "åå–®å·²é–å®šï¼Œæº–å‚™æŠ½ç±¤");
        break;

      case SYS_STATE.ROUND1:
        setStatusLight("warn", "ç¬¬ä¸€è¼ªæŠ½ç±¤ä¸­");
        break;

      case SYS_STATE.ROUND2:
        setStatusLight("warn", "ç¬¬äºŒè¼ªæŠ½ç´…åŒ…ä¸­");
        break;

      case SYS_STATE.VIEWER:
        setStatusLight("warn", "æŸ¥çœ‹ç´…åŒ…ä¸­");
        break;

      case SYS_STATE.FINISHED:
        setStatusLight("ok", "æœ¬è¼ªå®Œæˆï¼Œå¯ä¸‹è¼‰ PDF æˆ–é‡ç½®");
        break;

      default:
        console.warn("âš ï¸ Unknown systemState:", systemState);
        setStatusLight("error", "ç³»çµ±ç‹€æ…‹ç•°å¸¸");
        break;
    }
  }

  // =========================
  // 1. å®‰å…¨é è¨­ï¼šå…¨éƒ¨é–æ­»
  // =========================
  lockBtn.disabled   = true;
  spinBtn.disabled   = true;
  secondBtn.disabled = true;
  viewBtn.disabled   = true;
  pdfBtn.disabled    = true;

  lockBtn.classList.remove("blink-btn");
  spinBtn.classList.remove("blink-btn");
  secondBtn.classList.remove("blink-btn");
  viewBtn.classList.remove("blink-btn");

  pdfBtn.classList.remove("btn-pdf-ready");
  resetBtn.classList.remove("btn-reset-danger");

  // =========================
  // 2. ç‹€æ…‹ â†’ UI å°æ‡‰
  // =========================
  switch (systemState) {

    case SYS_STATE.INIT:
      lockBtn.disabled = false;
      resetBtn.disabled = false;
      statusDiv.textContent = "è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®";
      break;

    case SYS_STATE.READY:
      spinBtn.disabled = false;
      spinBtn.classList.add("blink-btn");
      statusDiv.textContent = "è«‹é–‹å§‹ç¬¬ä¸€è¼ªæŠ½ç±¤";
      break;

    case SYS_STATE.ROUND1:
      statusDiv.textContent = "æ—‹è½‰ä¸­...";
      break;

case SYS_STATE.ROUND2:
  statusDiv.textContent = "è«‹æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰";

  // åªå…è¨±ã€Œå°šæœªé–‹å§‹ç¬¬äºŒè¼ªã€æ™‚æ‰å¯æŒ‰
  if (!round2Started && !rotating) {
    secondBtn.disabled = false;
    secondBtn.classList.add("blink-btn");
  } else {
    secondBtn.disabled = true;
    secondBtn.classList.remove("blink-btn");
  }
  break;

    case SYS_STATE.VIEWER:
      viewBtn.disabled = false;
      viewBtn.classList.add("blink-btn");
      statusDiv.textContent = "æŸ¥çœ‹ç´…åŒ…ä¸­";
      break;

case SYS_STATE.FINISHED:

  // âœ… å…è¨±çµæ¡ˆæ“ä½œ
  pdfBtn.disabled = false;
  pdfBtn.classList.add("btn-pdf-ready");

  resetBtn.disabled = false;
  resetBtn.classList.add("btn-reset-danger");

  // âœ… å…è¨±ç›´æ¥é–‹æ–°ä¸€è¼ªï¼ˆæ”¹å â†’ é–å®šåå–®ï¼‰
  lockBtn.disabled = false;

  // ğŸ”’ æ‰€æœ‰æŠ½ç±¤å…¥å£é–æ­»
  spinBtn.disabled   = true;
  secondBtn.disabled = true;
  viewBtn.disabled   = true;

  spinBtn.classList.remove("blink-btn");
  secondBtn.classList.remove("blink-btn");
  viewBtn.classList.remove("blink-btn");

  // ğŸ“¢ æ¸…æ¥šæç¤ºä½¿ç”¨è€…ä¸‹ä¸€æ­¥
  statusDiv.textContent = "æœ¬è¼ªå·²å®Œæˆï¼Œå¯ä¸‹è¼‰ PDF æˆ–ç›´æ¥æ”¹åä¸¦é–å®šåå–®é–‹å§‹æ–°ä¸€è¼ª";

  break;

    default:
      // å·²åœ¨ä¸Šæ–¹ç‹€æ…‹ç‡ˆè™•ç†
      break;
  }
}

const CENTER = 180;
const R      = 150;
const DURATION = 5000;

/* ========= åˆå§‹æ¨£å¼ï¼šå–®åœ“ï¼‹åŠå¾‘ç·š ========= */
function drawInitialWheel(){
  ctx.clearRect(0,0,360,360);

  ctx.beginPath();
  ctx.arc(CENTER,CENTER,R,0,Math.PI*2);
  ctx.fillStyle = "#fcdca0";
  ctx.fill();

  ctx.beginPath();
  ctx.arc(CENTER,CENTER,R,0,Math.PI*2);
  ctx.lineWidth = 3;
  ctx.strokeStyle = "#ffffff";
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(CENTER, CENTER);
  ctx.lineTo(CENTER, CENTER - (R - 2));
  ctx.lineWidth = 3;
  ctx.strokeStyle = "#ffffff";
  ctx.stroke();
}

/* ========= ç•«å§“åè¼ªç›¤ ========= */
function drawWheel(angle){
  ctx.clearRect(0,0,360,360);

  if(!names.length){
    drawInitialWheel();
    return;
  }

  const n   = names.length;
  const arc = 2*Math.PI / n;

=======
function drawWheel(){
  const w=wheel.width,h=wheel.height;
  const r=w/2;
  ctx.clearRect(0,0,w,h);
>>>>>>> 406dfd9ed4110734e54e08c4ec3a4f2240d29c62
  ctx.save();
  ctx.translate(r,r);
  ctx.rotate(rotation);
  const n=Math.max(1,wheelItems.length);
  const step=(Math.PI*2)/n;

  for(let i=0;i<n;i++){
    const s=i*step,e=s+step;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,r-2,s,e);
    ctx.closePath();
    ctx.fillStyle=i%2?"#fff6dc":"#ffe9b8";
    ctx.fill();
    ctx.strokeStyle="rgba(91,58,0,.2)";
    ctx.stroke();

    ctx.save();
    ctx.rotate(s+step/2);
    ctx.textAlign="right";
    ctx.fillStyle="#5b3a00";
    ctx.font="bold 14px system-ui";
    ctx.fillText(wheelItems[i]||"", r-14, 6);
    ctx.restore();
  }
  ctx.restore();

  if(selectedIndex!==null && !rotating){
    highlightSegment(selectedIndex);
  }
}

function highlightSegment(i){
  const w=wheel.width,r=w/2;
  const n=Math.max(1,wheelItems.length);
  const step=(Math.PI*2)/n;
  ctx.save();
  ctx.translate(r,r);
  const s=i*step+rotation,e=s+step;
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.arc(0,0,r-2,s,e);
  ctx.closePath();
  ctx.fillStyle="rgba(255,193,7,.35)";
  ctx.fill();
  ctx.restore();
}

function getIndexUnderPointer(){
  const n=Math.max(1,wheelItems.length);
  const step=(Math.PI*2)/n;
  const pointer=-Math.PI/2;
  let a=pointer-rotation;
  a=((a%(Math.PI*2))+(Math.PI*2))%(Math.PI*2);
  return Math.floor(a/step);
}

function spinOnce(cb){
  if(rotating) return;
  rotating=true;
  selectedIndex=null;
  $("centerText").textContent="è½‰å‹•ä¸­â€¦";

  try{ $("drum").currentTime=0; $("drum").play(); }catch{}

  const start=rotation;
  const delta=(5+Math.random()*3)*Math.PI*2+Math.random()*Math.PI*2;
  const dur=4200+Math.random()*800;
  const t0=performance.now();

  function ease(x){ return 1-Math.pow(1-x,3); }

  function tick(t){
    const p=Math.min(1,(t-t0)/dur);
    rotation=start+delta*ease(p);
    drawWheel();
    if(p<1) requestAnimationFrame(tick);
    else{
      rotating=false;
      try{$("drum").pause();}catch{}
      selectedIndex=getIndexUnderPointer();
      drawWheel();
      if(cb) cb(selectedIndex);
    }
  }
  requestAnimationFrame(tick);
}

function applyUI(){
  $("spinBtn").disabled=true;
  $("secondBtn").disabled=true;
  $("viewBtn").disabled=true;

  $("viewBtn").classList.remove("blink-all");

  if(sysState===SYS.READY){
    $("lockBtn").disabled=false;
    $("nameInput").disabled=false;
    $("status").textContent="è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®";
  }
  if(sysState===SYS.LOCKED){
    $("lockBtn").disabled=true;
    $("nameInput").disabled=true;
    $("spinBtn").disabled=false;
    $("status").textContent=`å·²é–å®šåå–®ï¼ˆ${remainingNames.length} äººï¼‰\næŒ‰ã€Œé–‹å§‹æŠ½å§“åï¼ˆç¬¬ä¸€è¼ªï¼‰ã€`;
  }
  if(sysState===SYS.R1_DONE){
    $("secondBtn").disabled=false;
    $("status").textContent=`ç¬¬ä¸€è¼ªå®Œæˆï¼š${currentName}\nè«‹æŒ‰ã€ŒæŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰ã€`;
  }
  if(sysState===SYS.R2_DONE){
    $("viewBtn").disabled=false;
    $("viewBtn").classList.add("blink-all");
    const ref=getVerseRef(currentVerse);
    $("status").textContent=`ç¬¬äºŒè¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ${currentVerse}ã€\n${ref||""}`;
  }

<<<<<<< HEAD
  rotating = true;
  applyUIState(); // ğŸŸ¡ é»ƒç‡ˆ

  statusDiv.textContent = "æ—‹è½‰ä¸­â€¦â€¦";
  resultDiv.textContent = "";
  centerText.textContent = "";
  summaryBox.textContent = "";

  try {
    drum.currentTime = 0;
    drum.play();
  } catch (e) {}
=======
  $("pdfBtn").disabled=!history.length;
  $("pdfBtn").classList.toggle("btn-pdf-ready",history.length>0);
  $("resetBtn").classList.toggle("btn-reset-danger",history.length>0||sysState!==SYS.READY);
}
>>>>>>> 406dfd9ed4110734e54e08c4ec3a4f2240d29c62

function lockNames(){
  unlockAudioOnce();
  const parts=$("nameInput").value.split(/[\n,ï¼Œ\s]+/).map(s=>s.trim()).filter(Boolean);
  const seen=new Set();
  names=[];
  parts.forEach(p=>{ if(!seen.has(p)){seen.add(p);names.push(p);} });
  if(!names.length){ alert("è«‹è‡³å°‘è¼¸å…¥ä¸€ä½å§“å"); return; }

  remainingNames=[...names];
  remainingVerses=genVerses();
  currentName=null;
  currentVerse=null;
  sysState=SYS.LOCKED;

  wheelItems=[...remainingNames];
  rotation=0;
  selectedIndex=null;
  $("centerText").textContent="ç¬¬ä¸€è¼ªï¼šæŠ½å§“å";
  $("result").textContent="";
  $("summaryBox").textContent=renderHistorySummary();
  drawWheel();
  applyUI();
}

<<<<<<< HEAD
/* ========= å„²å­˜ç‹€æ…‹ ========= */
function saveState(extra = {}) {
  if (!IS_MASTER) return;      // ğŸ”’ éä¸»æ§é ç¦æ­¢å¯«ç‹€æ…‹ï¼ˆä¸€å®šè¦ç¬¬ä¸€è¡Œï¼‰

  lastHeartbeat = Date.now(); // ğŸ”„ å¿ƒè·³åŒæ­¥ï¼ˆå•†ç”¨ç´šåˆ†é å­˜æ´»æ¨™è¨˜ï¼‰

  const prev = (() => {
    try {
      return JSON.parse(sessionStorage.getItem("spinState")) || {};
    } catch {
      return {};
    }
  })();

  sessionStorage.setItem("spinState", JSON.stringify({
    names,
    usedName: [...usedName],
    verseUsed: [...verseUsed],
    currentVerse,
    rotation,          // âœ… å¿…å­˜
    lastWinnerIndex,  // âœ… å¿…å­˜
	
    // ===== PDF è¼ªæ¬¡é˜²å‘†ç‹€æ…‹ï¼ˆå¿…å­˜ï¼‰=====	
	pdfRoundSerial,
    pdfRepeatCount,

// âœ… round2Done æ­£ç¢ºç¹¼æ‰¿é‚è¼¯
round2Done:
  typeof extra.round2Done === "boolean"
    ? extra.round2Done
    : !!prev.round2Done,

// ğŸ”’ finished å•†ç”¨ç´šæ§åˆ¶æ¬Šï¼ˆå¯æ‰‹å‹•è¦†å¯«ï¼‰
finished:
  typeof extra.finished === "boolean"
    ? extra.finished
    : (usedName.size === names.length),

// â­ å…ˆå±•é–‹æµç¨‹æ§åˆ¶ï¼ˆå…è¨± round2Done / finished è¢«æ”¹ï¼‰
...extra,

// ğŸ” æœ€å¾Œæ‰å¯«ä¸»æ§æ¬Šï¼ˆæ°¸é ä¸å¯è¢«è¦†è“‹ï¼‰
tabId: TAB_ID,
heartbeat: Date.now(),
  }));
}

/* ========= è¼‰å…¥ç‹€æ…‹ï¼ˆä¸è‡ªå‹•æ—‹è½‰ï¼‰ ========= */
function loadState(){
  rotating = false;   // â˜… å¼·åˆ¶è§£é™¤æ­»é–

  // â­ PATCH A-1ï¼šæ˜¯å¦å¾ viewer å›ä¾†ï¼ˆä¸€å®šè¦åœ¨æœ€å‰é¢ï¼‰
  const cameFromViewer =
    sessionStorage.getItem("showSummaryOnReturn") === "1";

  const raw = sessionStorage.getItem("spinState");

  /* ===== å®Œå…¨æ²’æœ‰ä»»ä½•ç‹€æ…‹ï¼šåˆå§‹ç•«é¢ ===== */
if(!raw){
  clearHL();
  drawInitialWheel();
  statusDiv.textContent = "è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®";
  return;
}

  let s;
  try{
    s = JSON.parse(raw);

// ===== é‚„åŸç³»çµ±ç‹€æ…‹ï¼ˆåªé‚„åŸï¼Œä¸åˆ¤æ–·ï¼‰=====
systemState = s.finished
  ? SYS_STATE.FINISHED
  : (s.round2Done
      ? SYS_STATE.VIEWER
      : (s.lastWinnerIndex >= 0
          ? SYS_STATE.ROUND2
          : (s.names && s.names.length
              ? SYS_STATE.READY
              : SYS_STATE.INIT
            )
        )
    );
	
  }catch(e){
    clearHL();
    drawInitialWheel();
    return;
  }
// ===== å•†ç”¨ç´šä¸»æ§é–ï¼ˆåªæ“‹ã€Œæ´»è‘—çš„å¦ä¸€å°è¨­å‚™ã€ï¼‰ï¼ˆç›®å‰å…ˆåœç”¨ï¼‰=====
if (!DISABLE_MASTER_LOCK && IS_MASTER && s.tabId && s.tabId !== TAB_ID) {
  const now = Date.now();

  // åªæœ‰åœ¨å°æ–¹å¿ƒè·³ä»æ´»è‘—æ™‚æ‰é–
  if (s.heartbeat && now - s.heartbeat < HEARTBEAT_TTL) {
    setStatusLight("error", "åµæ¸¬åˆ°å¦ä¸€å°ä¸»æŒè¨­å‚™");
    alert("åµæ¸¬åˆ°å¦ä¸€å°é›»è…¦æ­£åœ¨ä¸»æŒæœ¬å ´æ´»å‹•ï¼Œç³»çµ±å·²é€²å…¥å®‰å…¨æ¨¡å¼");
    sessionStorage.removeItem("spinState");
    location.reload();
    return;
  }
  // å¦å‰‡è¦–ç‚ºèˆŠè¨­å‚™ / é‡æ•´ / viewer å›æµ â†’ æ”¾è¡Œ
}

  /* ===== é‚„åŸæ ¸å¿ƒè³‡æ–™ ===== */
names        = Array.isArray(s.names) ? s.names : [];
usedName     = new Set(s.usedName || []);
verseUsed    = new Set(s.verseUsed || []);
currentVerse = s.currentVerse || null;
rotation     = typeof s.rotation === "number" ? s.rotation : 0;
lastWinnerIndex = (s.lastWinnerIndex ?? -1);

// ===== é‚„åŸ PDF è¼ªæ¬¡é˜²å‘†ç‹€æ…‹ =====
pdfRoundSerial = s.pdfRoundSerial || null;
pdfRepeatCount = s.pdfRepeatCount || 0;
pdfDownloadedThisRound = !!pdfRoundSerial;

const round2Done = !!s.round2Done;

    // === A-3ï¼šé‚„åŸå§“åè¼¸å…¥æ¡†å…§å®¹ ===
  nameInput.value = names.join(" ");

  /* ===== é‡ç•«è½‰ç›¤ï¼ˆåªç•«ä¸€æ¬¡ï¼‰===== */
  clearHL();                 // â˜… å¿…åŠ ï¼šé¿å…æ®˜å½±
  drawWheel(rotation);

  /* ===== è‹¥å·²æœ‰ç¬¬ä¸€è¼ªçµæœï¼Œé¡¯ç¤ºé«˜äº® ===== */
  if(lastWinnerIndex >= 0){
    showHL(lastWinnerIndex);
  }

  /* ===== UI ç‹€æ…‹åŒæ­¥ ===== */
  const total = names.length;
  const drawn = usedName.size;
 
  // ===== å•é¡Œ Bï¼šå–æ¶ˆé«˜äº®é–ƒçˆ =====
  document.querySelectorAll("#hl-svg .blink")
    .forEach(el => el.classList.remove("blink"));
	
	
  /* é–å®šåå–®ï¼šæŠ½ç±¤ä¸­ä¸å¯å†é–ï¼Œå…¨éƒ¨æŠ½å®Œæ‰å¯ */
  lockBtn.disabled = (drawn > 0 && drawn < total);

  /* ç¬¬ä¸€è¼ªï¼šé‚„æ²’å…¨éƒ¨æŠ½å®Œæ‰å¯ */
  spinBtn.disabled = (drawn >= total);

// ===== ç¬¬äºŒè¼ªï¼šåªæœ‰ã€Œå‰›å®Œæˆç¬¬ä¸€è¼ªã€æ‰å¯ç”¨ =====
if (
  lastWinnerIndex >= 0 &&
  !round2Done &&
  rotating === false &&
  !cameFromViewer   // â­ é—œéµï¼šå¾ viewer å›ä¾†ä¸€å¾‹é–æ­»
){
  secondBtn.disabled = false;
  secondBtn.classList.add("blink-btn");
}else{
  secondBtn.disabled = true;
  secondBtn.classList.remove("blink-btn");
}

  /* çœ‹ç´…åŒ…ï¼šå¿…é ˆå®Œæˆç¬¬äºŒè¼ª */
  if(round2Done && currentVerse){
    viewBtn.disabled = false;
    viewBtn.classList.add("blink-btn");
  }else{
    viewBtn.disabled = true;
    viewBtn.classList.remove("blink-btn");
  }

  /* PDFï¼šå…¨éƒ¨æŠ½å®Œæ‰å¯ */
  pdfBtn.disabled = !(drawn === total);
 
  /* ===== æ¸…é™¤éŒ¯èª¤æ®˜ç•™æ–‡å­— ===== */
  if(resultDiv && resultDiv.textContent.includes("æ—‹è½‰ä¸­")){
    resultDiv.textContent = "";
  }

/* ===== ğŸ”’ FINAL LOCKï¼šå¾ viewer å›ä¾†å¾Œçš„ UIï¼ˆå”¯ä¸€ç‰ˆæœ¬ï¼‰ ===== */

const fromViewer =
  sessionStorage.getItem("showSummaryOnReturn") === "1";
  
  // ğŸ§¹ ä¿è­‰ä¸æœƒæ®˜ç•™ç¬¬ä¸€è¼ªé–ƒçˆï¼ˆé¿å…è·Ÿç¬¬äºŒè¼ªä¸€èµ·é–ƒï¼‰
spinBtn.classList.remove("blink-btn");

if (fromViewer) {

  /* ===== æƒ…æ³ Aï¼šå°šæœªå…¨éƒ¨æŠ½å®Œ ===== */
  if (drawn < total) {

    // è½‰ç›¤ä¸‹æ–¹æç¤º
    statusDiv.textContent = "è«‹ç¹¼çºŒä¸‹ä¸€ä½æŠ½ç¶“å¥ç´…åŒ…";

    // ç¬¬ä¸€è¼ªï¼šå”¯ä¸€å…¥å£ â†’ å•Ÿç”¨ + é–ƒçˆ
    spinBtn.disabled = false;
    spinBtn.classList.add("blink-btn");

    // å…¶ä»–å…¥å£å…¨éƒ¨é–æ­»
    secondBtn.disabled = true;
    secondBtn.classList.remove("blink-btn");
    viewBtn.disabled = true;
    viewBtn.classList.remove("blink-btn");
	
	// ğŸ”’ Viewer å›ä¾†æœŸé–“ï¼šé–å®šåå–® / PDF ä¸€å¾‹é—œé–‰
    lockBtn.disabled = true;
    pdfBtn.disabled = true;
    pdfBtn.classList.remove("btn-pdf-ready");

  }

  /* ===== æƒ…æ³ Bï¼šå…¨éƒ¨äººå·²æŠ½å®Œ ===== */
  else if (total > 0 && drawn === total) {
  systemState = SYS_STATE.FINISHED;
  applyUIState();
  
  statusDiv.textContent = "";   // âœ… æ¸…é™¤ã€Œè«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®ã€

    // æŒ‡å®šä¸‰è¡Œæç¤º
    summaryBox.textContent =
      `ğŸ‰ æ­¤è¼ªè½‰ç›¤å·²å®Œæˆ ${total} ä½çš„ç´…åŒ…æŠ½ç±¤\n` +
      `ğŸ“„ è«‹æŒ‰ã€ŒæŠ½ç±¤ç´€éŒ„ PDFã€ä¸‹è¼‰ç´€éŒ„ï¼Œæˆ–\n` +
      `ğŸ” è¼¸å…¥æ–°å§“å â†’ æŒ‰ã€Œé–å®šåå–®ã€é–‹å§‹ä¸‹ä¸€è¼ªï¼›ä¹Ÿå¯æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€`;

    // æŠ½ç±¤ç´€éŒ„ PDFï¼šæ•´é¡†è—è‰²
    pdfBtn.disabled = false;
    pdfBtn.classList.add("btn-pdf-ready");

// âœ… å…¨éƒ¨æ­¸é›¶ï¼šæ•´é¡†ç´…è‰²ï¼ˆä¸å¯å†è¢«è¦†è“‹ï¼‰
resetBtn.disabled = false;          // â† å¿…åŠ ï¼Œä¸ç„¶ç´…è‰²åªæ˜¯è£é£¾
resetBtn.classList.add("btn-reset-danger");

    // æ‰€æœ‰æŠ½ç±¤å…¥å£é–æ­»
    spinBtn.disabled   = true;
    secondBtn.disabled = true;
    viewBtn.disabled   = true;

    spinBtn.classList.remove("blink-btn");
    secondBtn.classList.remove("blink-btn");
    viewBtn.classList.remove("blink-btn");
  }

  // âœ… æ‰€æœ‰ fromViewer å°ˆå±¬ UI éƒ½è™•ç†å®Œï¼Œæœ€å¾Œæ‰æ¸…æ——æ¨™
  sessionStorage.removeItem("showSummaryOnReturn");
}
}

/* ========= æŠ½ç±¤ç´€éŒ„å¯«å…¥ localStorage ========= */
function appendLog(name, no, ref){
  let logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
  
  // â° çµ±ä¸€æ™‚é–“æ ¼å¼ï¼ˆä¸‹åˆ 03:57:30ï¼‰
  const timeStr = formatTime2(new Date());
  logs.push({
    time: timeStr,
    name,
    no,
    ref
=======
function startRound1(){
  unlockAudioOnce();
  wheelItems=[...remainingNames];
  drawWheel();
  spinOnce(i=>{
    currentName=remainingNames[i];
    remainingNames.splice(i,1);
    $("result").textContent=`âœ… ç¬¬ä¸€è¼ªï¼šæŠ½ä¸­ã€Œ${currentName}ã€`;
    $("centerText").textContent=`ç¬¬ä¸€è¼ªå®Œæˆ\n${currentName}`;
    sysState=SYS.R1_DONE;
    applyUI();
>>>>>>> 406dfd9ed4110734e54e08c4ec3a4f2240d29c62
  });
}

function startRound2(){
  unlockAudioOnce();
  wheelItems=[...names];
  drawWheel();
  spinOnce(()=>{
    const idx=Math.floor(Math.random()*remainingVerses.length);
    currentVerse=remainingVerses[idx];
    remainingVerses.splice(idx,1);

    const ref=getVerseRef(currentVerse);
    const ts=Date.now();
    history.push({name:currentName,verse:currentVerse,ref,ts});
    saveHistory();

    $("result").textContent="";
    $("summaryBox").textContent=renderHistorySummary();
    sysState=SYS.R2_DONE;
    applyUI();
  });
}

<<<<<<< HEAD
  // ğŸŸ¢ æ–°ä¸€è¼ªå¼·åˆ¶åˆå§‹åŒ–
  systemState = SYS_STATE.INIT;
=======
function showEnvelope(){
  $("viewBtn").classList.remove("blink-all");
  const img=$("envelopeImg");
  const ref=getVerseRef(currentVerse);
  $("envelopeVerse").textContent=currentVerse;
  $("envelopeRef").textContent=ref?`ğŸ“– ${ref}`:"";
  img.onload=()=>{ $("redEnvelopePanel").style.display="block"; try{$("winSound").play();}catch{} };
  img.onerror=()=>alert("æ‰¾ä¸åˆ°åœ–ç‰‡ cards/"+currentVerse+".png");
  img.src="cards/"+currentVerse+".png";
}
>>>>>>> 406dfd9ed4110734e54e08c4ec3a4f2240d29c62

function downloadEnvelope(){
  const img=$("envelopeImg");
  if(!img.complete){ alert("åœ–ç‰‡å°šæœªè¼‰å…¥å®Œæˆ"); return; }
  const c=document.createElement("canvas");
  c.width=img.naturalWidth;
  c.height=img.naturalHeight;
  c.getContext("2d").drawImage(img,0,0);
  c.toBlob(b=>{
    const a=document.createElement("a");
    a.href=URL.createObjectURL(b);
    a.download="verse_"+currentVerse+".png";
    a.click();
    URL.revokeObjectURL(a.href);
  });
}

<<<<<<< HEAD
/* ========= ç¬¬ä¸€è¼ª ========= */
spinBtn.onclick = () => {
  if (!canAct()) return;
  if (rotating) return;
  unlockAudio();
=======
function nextPerson(){
  $("redEnvelopePanel").style.display="none";
  currentName=null;
  currentVerse=null;
  sysState=SYS.LOCKED;
  wheelItems=[...remainingNames];
  $("centerText").textContent="ç¬¬ä¸€è¼ªï¼šæŠ½å§“å";
  drawWheel();
  applyUI();
}
>>>>>>> 406dfd9ed4110734e54e08c4ec3a4f2240d29c62

function resetAll(){
  if(!confirm("ç¢ºå®šå…¨éƒ¨æ­¸é›¶ï¼Ÿ")) return;
  localStorage.removeItem(HISTORY_KEY);
  history=[];
  names=[];
  remainingNames=[];
  remainingVerses=genVerses();
  currentName=null;
  currentVerse=null;
  sysState=SYS.READY;
  $("nameInput").value="";
  $("summaryBox").textContent="";
  $("result").textContent="";
  $("redEnvelopePanel").style.display="none";
  wheelItems=[];
  drawWheel();
  applyUI();
}

<<<<<<< HEAD
  statusDiv.textContent = "æ—‹è½‰ä¸­...";

  secondBtn.disabled = true;
  secondBtn.classList.remove("blink-btn");

  viewBtn.disabled = true;
  viewBtn.classList.remove("blink-btn");

  clearHL();
  centerText.textContent = "";
  summaryBox.textContent = "";

  const remain = names.filter(n => !usedName.has(n));
  if (!remain.length) return;

  audit("ROUND1_START", { remaining: remain.length });
  systemState = SYS_STATE.ROUND1;
  applyUIState();

  pdfBtn.disabled = true;
  lockBtn.disabled = true;

  spin(remain, true, (winner) => {
    usedName.add(winner);
    lastWinnerIndex = names.indexOf(winner);

    clearHL();
    showHL(lastWinnerIndex);

    const drawnCount = usedName.size;
    const totalCount = names.length;

    statusDiv.textContent = "";
    resultDiv.textContent =
      `ğŸ¯ æŠ½ä¸­ã€Œ${winner}ã€\nï¼ˆç¬¬ ${drawnCount} ä½ï¼å…± ${totalCount} ä½ï¼‰`;

    // ğŸŸ¢ é–‹æ”¾ç¬¬äºŒè¼ª
    round2Started = false;
    systemState = SYS_STATE.ROUND2;
    applyUIState();

    secondBtn.disabled = false;
    secondBtn.classList.add("blink-btn");

    saveState({ round2Done: false });
  });
};

/* ========= ç¬¬äºŒè¼ª ========= */
secondBtn.onclick = () => {
  if (!canAct()) return;
  if (rotating) return;
  if (round2Started) return; // ğŸ”’ é˜²é‡è¤‡
  round2Started = true;

  unlockAudio();

  secondBtn.disabled = true;
  secondBtn.classList.remove("blink-btn");

  systemState = SYS_STATE.ROUND2;
  applyUIState();

  clearHL();
  centerText.textContent = "";

  const remain = [...Array(128).keys()]
    .map(i => String(i + 1).padStart(3, "0"))
    .filter(v => !verseUsed.has(v));

  if (!remain.length) {
    systemState = SYS_STATE.FINISHED;
    applyUIState();
    return;
  }

  audit("ROUND2_START", { remaining: remain.length });

  spin(remain, false, (v) => {
    verseUsed.add(v);
    currentVerse = v;

    const ref =
      (window.VERSE_REF_MAP && window.VERSE_REF_MAP[v])
        ? window.VERSE_REF_MAP[v]
        : "";

    // UI é¡¯ç¤º
    statusDiv.textContent = "";
    resultDiv.textContent =
      `ç¬¬äºŒè¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ã€Œ${v}ã€`;

    centerText.textContent =
      `ğŸ“œ æŠ½ä¸­ç¶“å¥ã€Œ${v}ã€\nğŸ“– ${ref}`;

    // ğŸ”Š éŸ³æ•ˆ
    try {
      winSound.currentTime = 0;
      winSound.play();
    } catch (e) {}

    // ğŸ‰ å½©å¸¶
    launchConfetti();

    // ğŸ”’ é–æ­»æŠ½ç±¤éµ
    spinBtn.disabled = true;
    secondBtn.disabled = true;
    spinBtn.classList.remove("blink-btn");
    secondBtn.classList.remove("blink-btn");

    // ğŸ‘ å•Ÿç”¨ Viewer
    viewBtn.disabled = false;
    viewBtn.classList.add("blink-btn");

    // âœ” ç´€éŒ„
    appendLog(names[lastWinnerIndex], v, ref);

    // ğŸŸ¢ é€² Viewer ç‹€æ…‹
    systemState = SYS_STATE.VIEWER;
    applyUIState();

    saveState({ round2Done: true });
  });
  };

/* ========= çœ‹ç´…åŒ… ========= */
viewBtn.onclick = () => {
  if (!canAct()) return;   // âœ… ç¬¬ä¸€è¡Œ
  
  if(!currentVerse) return;

  const winnerName = names[lastWinnerIndex] || "";

  // åƒ…å„²å­˜ç‹€æ…‹ï¼Œä¸è‡ªå‹•è½‰å‹•
  systemState = SYS_STATE.VIEWER;
  applyUIState();
  saveState();

  window.location.href =
    `viewer.html?no=${currentVerse}&name=${encodeURIComponent(winnerName)}`;
};

/* ========= PDFï¼šä¸‹è¼‰æŠ½ç±¤ç´€éŒ„ï¼ˆCanvas â†’ Image â†’ PDF ç©©å®šç‰ˆï½œå”¯ä¸€ç‰ˆæœ¬ï¼‰ ========= */
pdfBtn.onclick = async () => {
  if (!canAct()) return;   // âœ… å¿…é ˆç¬¬ä¸€è¡Œ

  try {
    const logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
    if (!logs.length) {
      alert("æ²’æœ‰å¯ä¸‹è¼‰çš„æŠ½ç±¤ç´€éŒ„");
      return;
    }

    /* ===== è¼ªæ¬¡é˜²å‘† ===== */
    if (pdfDownloadedThisRound) {
      const ok = confirm(
        "é€™ä¸€è¼ªæ‚¨å·²ç¶“ä¸‹è¼‰éPDFäº†, æ˜¯å¦è¦å†ä¸‹è¼‰ä¸€æ¬¡å‘¢ (Yes or No)?"
      );
      if (!ok) return;
      pdfRepeatCount++;
    } else {
      pdfDownloadedThisRound = true;
      pdfRepeatCount = 0;
    }
    audit("PDF_DOWNLOAD_ATTEMPT", {
      isRepeat: pdfDownloadedThisRound,
      repeatCount: pdfRepeatCount,
      serial: pdfRoundSerial
    });

    /* ===== æµæ°´è™Ÿï¼ˆæœ¬è¼ªåªå–ä¸€æ¬¡ï¼‰ ===== */
    if (!pdfRoundSerial) {
      pdfRoundSerial = getNextBlessingPdfSerial();
    }

    let filename = `Blessing_envelop_${pdfRoundSerial}`;
    if (pdfRepeatCount > 0) {
      filename += `-${pdfRepeatCount}`;
    }
    filename += `.pdf`;

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    /* ===== ç•«å¸ƒå°ºå¯¸èˆ‡ç‰ˆå‹é–æ­»ï¼ˆç­‰åŒ 010.pdfï¼‰ ===== */
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const MARGIN = 60;
    const LINE_H = 32;
    const WIDTH = 1240;

    canvas.width = WIDTH;
    canvas.height = MARGIN * 2 + (logs.length + 6) * LINE_H;

    /* èƒŒæ™¯ */
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    /* æ¨™é¡Œå­—å‹ */
    ctx.fillStyle = "#000000";
    ctx.font = "28px 'Noto Sans TC','PingFang TC','Microsoft JhengHei',Arial,sans-serif";

    let y = MARGIN;

/* ===== æ¨™é¡Œï¼ˆ+25% æ”¾å¤§ + åŠ ç²—ï¼‰ ===== */
ctx.font = "bold 35px 'Noto Sans TC','PingFang TC','Microsoft JhengHei',Arial,sans-serif";
ctx.fillText("ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰", MARGIN, y);
y += LINE_H * 2.2;

/* ===== å°æ¨™ï¼ˆ+10% æ”¾å¤§ + åŠ ç²—ï¼‰ ===== */
ctx.font = "bold 26px 'Noto Sans TC','PingFang TC','Microsoft JhengHei',Arial,sans-serif";
ctx.fillText("æŠ½ç±¤ç´€éŒ„", MARGIN, y);
y += LINE_H * 1.4;

/* ===== å…§å®¹ï¼ˆæ­£å¸¸å­—é‡ï¼‰ ===== */
ctx.font = "22px 'Noto Sans TC','PingFang TC','Microsoft JhengHei',Arial,sans-serif";

logs.slice().reverse().forEach(l => {
  const line = `[${l.time}] ã€Œ${l.name}ã€ â†’ æŠ½ä¸­ç¶“å¥ç´…åŒ…: ${l.ref}`;
  y = wrapText(ctx, line, MARGIN, y, WIDTH - MARGIN * 2, LINE_H);
});

    /* ===== å³ä¸Šè§’é çœ‰ï¼ˆå›ºå®šä½ç½®ï¼‰ ===== */
    ctx.font = "18px Arial";
    ctx.textAlign = "right";
    ctx.fillText(
      "Blessing Envelop System Â© 2026 | Page 1",
      WIDTH - MARGIN,
      40
    );
    ctx.textAlign = "left";

    /* ===== Canvas â†’ PDF ===== */
    const imgData = canvas.toDataURL("image/png");

    const pageWidth = pdf.internal.pageSize.getWidth();
    const imgWidth = pageWidth - 20;
    const imgHeight = (canvas.height / canvas.width) * imgWidth;

    pdf.addImage(imgData, "PNG", 10, 10, imgWidth, imgHeight);
    pdf.save(filename);
	
// âœ… æœ¬è¼ªæ­£å¼çµæ¡ˆ
systemState = SYS_STATE.FINISHED;
saveState({ finished: true });
audit("ROUND_CLOSED_BY_PDF", { serial: pdfRoundSerial });
applyUIState();

  } catch (e) {
    console.error(e);
    alert("PDF ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹æŸ¥çœ‹ console");
  }
};

/* ===== Canvas è‡ªå‹•æ›è¡Œå·¥å…·ï¼ˆç©©å®šç‰ˆï¼Œæœƒå›å‚³æœ€æ–° yï¼‰ ===== */
function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  let line = "";

  for (let i = 0; i < text.length; i++) {
    const testLine = line + text[i];
    if (ctx.measureText(testLine).width > maxWidth && line) {
      ctx.fillText(line, x, y);
      line = text[i];
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line, x, y);
  return y + lineHeight;
=======
async function exportPDF(){
  const {jsPDF}=window.jspdf||{};
  if(!jsPDF){ alert("PDF å¼•æ“è¼‰å…¥å¤±æ•—"); return; }
  const pdf=new jsPDF();
  pdf.text("BlessingCards128 Record",20,20);
  let y=40;
  history.forEach((h,i)=>{
    const line=`${i+1}. ${h.name} - ${h.verse} ${h.ref||""} ${formatTime(h.ts)}`;
    pdf.text(line,20,y);
    y+=10;
    if(y>270){ pdf.addPage(); y=20; }
  });
  pdf.save("BlessingCards128_Record_A.pdf");
>>>>>>> 406dfd9ed4110734e54e08c4ec3a4f2240d29c62
}

$("lockBtn").onclick=lockNames;
$("spinBtn").onclick=startRound1;
$("secondBtn").onclick=startRound2;
$("viewBtn").onclick=showEnvelope;
$("downloadEnvelopeBtn").onclick=downloadEnvelope;
$("nextPersonBtn").onclick=nextPerson;
$("pdfBtn").onclick=exportPDF;
$("resetBtn").onclick=resetAll;

<<<<<<< HEAD
// ==== ä¸»æ§é æ‰å…è¨±é€å¿ƒè·³ ====
if (IS_MASTER) {
  setInterval(() => {
    const raw = sessionStorage.getItem("spinState");
    if (!raw) return;

    try {
      const s = JSON.parse(raw);
      if (s.tabId === TAB_ID) {
        s.heartbeat = Date.now();
        sessionStorage.setItem("spinState", JSON.stringify(s));
      }
    } catch(e) {}
  }, 2000);
}

/* ========= å…¨éƒ¨æ­¸é›¶ï¼ˆæœ€é«˜å„ªå…ˆæ¬Š Reset æ ¸å¿ƒï¼‰ ========= */
resetBtn.onclick = () => {
  if (!canAct()) return;   // âœ… å¿…é ˆç¬¬ä¸€è¡Œ

  const msg =
`è³‡æ–™ç´€éŒ„å°‡è¢«æ¸…ç©º(clear) & æ­¸é›¶(reset)ï¼Œ
éœ€é‡æ–°è¼¸å…¥å§“åä¸¦é–å®šåå–®é–‹å§‹æ–°è½‰ç›¤éŠæˆ²ï¼
æ‚¨ç¢ºå®šè¦åŸ·è¡Œå— (Yes or No)?`;

  // ğŸ”’ é˜²èª¤è§¸
  if (!confirm(msg)) return;

  // ğŸ“‹ ç¨½æ ¸ï¼šè¨˜éŒ„ã€Œé‡ç½®ç™¼ç”Ÿæ™‚çš„ç‹€æ…‹ã€
  audit("ROUND_CLOSED_BY_RESET", { state: systemState });
  audit("SYSTEM_RESET_ATTEMPT", { state: systemState });

  /* ===== 1ï¸âƒ£ æ¸…ç©ºæ ¸å¿ƒè³‡æ–™ ===== */
  names = [];
  usedName.clear();
  verseUsed.clear();
  currentVerse = null;
  lastWinnerIndex = -1;
  rotation = 0;
  rotating = false;

  /* ===== Reset PDF æœ¬è¼ªé˜²å‘†ç‹€æ…‹ ===== */
  pdfRoundSerial = null;
  pdfRepeatCount = 0;
  pdfDownloadedThisRound = false;

  /* ===== 2ï¸âƒ£ ç³»çµ±ç‹€æ…‹æ©Ÿæ­¸é›¶ ===== */
  systemState = SYS_STATE.INIT;

  /* ===== 3ï¸âƒ£ æ¸… Storage ===== */
  localStorage.removeItem("drawLogs");
  localStorage.removeItem("pdfSerial");
  sessionStorage.removeItem("spinState");
  sessionStorage.removeItem("showSummaryOnReturn");

  /* ===== 4ï¸âƒ£ æ¸…ç•«é¢ ===== */
  clearHL();
  drawInitialWheel();

  nameInput.value = "";
  centerText.textContent = "";
  resultDiv.textContent = "";
  summaryBox.textContent = "";
  statusDiv.textContent = "è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®";

  /* ===== 5ï¸âƒ£ é‚„åŸæ‰€æœ‰æŒ‰éˆ•ç‹€æ…‹ï¼ˆINITï¼‰ ===== */
  lockBtn.disabled = false;
  spinBtn.disabled = true;
  secondBtn.disabled = true;
  viewBtn.disabled = true;
  pdfBtn.disabled = true;

  spinBtn.classList.remove("blink-btn");
  secondBtn.classList.remove("blink-btn");
  viewBtn.classList.remove("blink-btn");

  pdfBtn.classList.remove("btn-pdf-ready");
  resetBtn.classList.remove("btn-reset-danger");

  resetBtn.disabled = false;

  /* ===== 6ï¸âƒ£ UI åŒæ­¥ ===== */
  applyUIState();

  console.log("ğŸ”„ System Reset â†’ INIT");

  /* ===== 7ï¸âƒ£ å­˜ä¹¾æ·¨å¿«ç…§ï¼ˆå”¯ä¸€ä¸€æ¬¡ï¼‰ ===== */
  saveState();
};

})(); 
=======
(function init(){
  history=loadHistory();
  $("summaryBox").textContent=renderHistorySummary();
  $("centerText").textContent="è«‹å…ˆé–å®šåå–®";
  drawWheel();
  applyUI();
})();

/* ===============================
   ğŸ† ç…™ç« / å½©å¸¶å‹•ç•«ï¼ˆå–®æ©Ÿç©©å®šç‰ˆï¼‰
   åªåœ¨ä¸­çèˆ‡é¡¯ç¤ºç´…åŒ…æ™‚è§¸ç™¼
=============================== */
const confettiCanvas = document.getElementById("confettiCanvas");
const cctx = confettiCanvas.getContext("2d");
let particles = [];

function resizeConfetti(){
  confettiCanvas.width = confettiCanvas.offsetWidth;
  confettiCanvas.height = confettiCanvas.offsetHeight;
}
window.addEventListener("resize", resizeConfetti);
resizeConfetti();

function spawnConfetti(count = 80){
  particles = [];
  const w = confettiCanvas.width;
  const h = confettiCanvas.height;
  for(let i=0;i<count;i++){
    particles.push({
      x: w/2,
      y: h/2,
      vx: (Math.random()*2-1) * (3+Math.random()*4),
      vy: (Math.random()*2-1) * (3+Math.random()*4),
      size: 4 + Math.random()*4,
      life: 60 + Math.random()*40,
      color: `hsl(${Math.random()*360},90%,60%)`
    });
  }
}

function drawConfetti(){
  cctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  particles.forEach(p=>{
    cctx.fillStyle = p.color;
    cctx.fillRect(p.x, p.y, p.size, p.size);
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.15;
    p.life--;
  });
  particles = particles.filter(p=>p.life>0);
  if(particles.length>0){
    requestAnimationFrame(drawConfetti);
  }
}

// Hook into events
const _origShowEnvelope = showEnvelope;
showEnvelope = function(){
  spawnConfetti(120);
  drawConfetti();
  _origShowEnvelope();
};

const _origStartRound2 = startRound2;
startRound2 = function(){
  _origStartRound2();
  setTimeout(()=>{
    spawnConfetti(60);
    drawConfetti();
  }, 4300);
};

>>>>>>> 406dfd9ed4110734e54e08c4ec3a4f2240d29c62
</script>
</body>
</html>
