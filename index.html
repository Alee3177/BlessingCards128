<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆBlessingCards128ï¼‰</title>

<link rel="icon" href="logo3524.png">

<style>
body {
    font-family: "Noto Sans TC", sans-serif;
    text-align: center;
    background: #fffdf7;
    margin: 0;
    padding: 0;
}

.logo {
    width: 180px;
    margin-top: 20px;
}

.title {
    font-size: 28px;
    margin-top: 10px;
    margin-bottom: 20px;
    font-weight: bold;
    color: #5a4635;
}

input {
    width: 320px;
    padding: 10px;
    font-size: 18px;
    margin-bottom: 10px;
    border-radius: 8px;
    border: 1px solid #aaa;
}

button {
    width: 240px;
    padding: 14px;
    font-size: 20px;
    border: none;
    border-radius: 10px;
    margin: 10px;
    cursor: pointer;
    background: linear-gradient(135deg, #fceabb, #f8b500);
    font-weight: bold;
    color: #5a4635;
    transition: 0.25s;
}

button:hover {
    transform: scale(1.05);
    background: linear-gradient(135deg, #ffd57e, #f2a600);
}

#canvasBox {
    margin-top: 30px;
}

#statusText {
    margin-top: 10px;
    font-size: 20px;
    color: #5a4635;
    white-space: pre-line;
}

#resultName {
    margin-top: 20px;
    font-size: 28px;
    font-weight: bold;
    color: #5a4635;
}
</style>
</head>

<body>

<img src="logo3524.png" class="logo" alt="BlessingCards128 logo">

<div class="title">ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆBlessingCards128ï¼‰</div>

<input id="nameInput" placeholder="è¼¸å…¥æ‰€æœ‰å§“åï¼Œä½¿ç”¨ã€Œ,ã€åˆ†éš”">

<br>
<button onclick="lockNames()">ğŸ”’ é–å®šåå–®</button>
<button onclick="resetAll()">ğŸ”„ å…¨éƒ¨æ­¸é›¶</button>
<br>
<button onclick="startDrawSequence()">ğŸ¡ é–‹å§‹æŠ½å§“å + ç¶“å¥</button>
<button onclick="goCategory()">ğŸ“š åˆ†é¡æŠ½ç±¤</button>
<br>
<button onclick="exportPDF()">ğŸ“„ æŠ½ç±¤ç´€éŒ„ PDF</button>

<div id="nameListDisplay" style="margin-top:10px; font-size:18px; color:#5a4635;"></div>

<div id="canvasBox">
    <canvas id="wheelCanvas" width="360" height="360"></canvas>
</div>

<div id="statusText"></div>
<div id="resultName"></div>

<!-- ç¶“å¥æ›¸å·ç« ç¯€ -->
<script src="verseRefMap.js"></script>

<!-- jsPDF ä¸»ç¨‹å¼ï¼ˆPDF åŒ¯å‡ºç”¨ï¼‰ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// ================== å…¨åŸŸç‹€æ…‹ ==================
let fixedNameList   = JSON.parse(localStorage.getItem("fixedNameList")   || "[]");
let usedNamesAll    = JSON.parse(localStorage.getItem("usedNamesAll")    || "[]");
let usedVersesAll   = JSON.parse(localStorage.getItem("usedVersesAll")   || "[]");
let drawLogs        = JSON.parse(localStorage.getItem("drawLogs")        || "[]");

const wheelCanvas   = document.getElementById("wheelCanvas");
const ctx           = wheelCanvas.getContext("2d");

let currentName     = null;   // ç¬¬ä¸€è¼ªæŠ½åˆ°çš„å§“å
let isSpinning      = false;  // é¿å…é€£æŒ‰

updateNameListDisplay();
drawWheelPlaceholder();

// =============== åå–®é–å®š ===============
function lockNames() {
    if (fixedNameList.length > 0) {
        alert("åå–®å·²é–å®šï¼Œè‹¥éœ€ä¿®æ”¹è«‹æŒ‰ã€Œå…¨éƒ¨æ­¸é›¶ã€ã€‚");
        return;
    }

    const raw = document.getElementById("nameInput").value.trim();
    if (!raw) {
        alert("è«‹è¼¸å…¥å§“åï¼ˆä½¿ç”¨ã€Œ,ã€éš”é–‹ï¼‰");
        return;
    }

    const list = raw
        .split(",")
        .map(n => n.trim())
        .filter(n => n);

    if (list.length === 0) {
        alert("åå–®å…§å®¹ç„¡æ•ˆï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚");
        return;
    }

    fixedNameList = list;
    localStorage.setItem("fixedNameList", JSON.stringify(fixedNameList));
    alert("åå–®å·²é–å®šï¼");
    updateNameListDisplay();
}

// =============== åå–®é¡¯ç¤º ===============
function updateNameListDisplay() {
    const el = document.getElementById("nameListDisplay");
    if (!fixedNameList.length) {
        el.textContent = "å°šæœªé–å®šåå–®";
        document.getElementById("nameInput").value = "";
    } else {
        el.textContent = "åå–®ï¼š" + fixedNameList.join("ï¼Œ");
        document.getElementById("nameInput").value = fixedNameList.join(", ");
    }
}

// =============== å…¨éƒ¨æ­¸é›¶ ===============
function resetAll() {
    if (!confirm("ç¢ºå®šè¦å…¨éƒ¨æ­¸é›¶å—ï¼Ÿ")) return;

    localStorage.removeItem("fixedNameList");
    localStorage.removeItem("usedNamesAll");
    localStorage.removeItem("usedVersesAll");
    localStorage.removeItem("drawLogs");

    fixedNameList = [];
    usedNamesAll  = [];
    usedVersesAll = [];
    drawLogs      = [];

    alert("å·²å…¨éƒ¨é‡ç½®ï¼");
    location.reload();
}

// =============== å‰å¾€åˆ†é¡æŠ½ç±¤ ===============
function goCategory() {
    window.location.href = "index_category.html";
}

// =============== é–‹å§‹é›™è¼ªç›¤æŠ½ç±¤æµç¨‹ ===============
function startDrawSequence() {
    if (isSpinning) return; // é¿å…é€£é»

    if (!fixedNameList.length) {
        alert("è«‹å…ˆé–å®šåå–®ï¼");
        return;
    }

    const remainingNames = fixedNameList.filter(n => !usedNamesAll.includes(n));
    if (!remainingNames.length) {
        alert("æ‰€æœ‰å§“åçš†å·²å®Œæˆè¼ªç›¤æŠ½ç±¤ï¼è«‹æŒ‰ä¸‹ã€Œå…¨éƒ¨æ­¸é›¶ã€ä»¥é‡æ–°é–‹å§‹ã€‚");
        return;
    }

    document.getElementById("statusText").innerText = "ç¬¬ 1 è¼ªï¼šæŠ½å§“åä¸­â€¦";
    document.getElementById("resultName").innerText = "";
    isSpinning = true;

    spinWheel(remainingNames, (selectedName) => {
        // ç¬¬ä¸€è¼ªçµæœï¼šå§“å
        currentName = selectedName;

        if (!usedNamesAll.includes(selectedName)) {
            usedNamesAll.push(selectedName);
            localStorage.setItem("usedNamesAll", JSON.stringify(usedNamesAll));
        }

        document.getElementById("statusText").innerText =
            "ç¬¬ 1 è¼ªå®Œæˆï¼šæŠ½ä¸­ã€Œ" + selectedName + "ã€\nå³å°‡é€²å…¥ç¬¬ 2 è¼ªï¼šç¥ç¦ç¶“å¥è¼ªç›¤â€¦";
        document.getElementById("resultName").innerText =
            "æŠ½ä¸­å§“åï¼šã€Œ" + selectedName + "ã€";

        // ç­‰ä¸€ä¸‹å†é–‹å•Ÿç¬¬ 2 è¼ª
        setTimeout(startVerseWheel, 1000);
    });
}

// =============== ç¬¬ 2 è¼ªï¼šç¶“å¥è¼ªç›¤ (001~128) ===============
function startVerseWheel() {
    const allVerses = [];
    for (let i = 1; i <= 128; i++) {
        allVerses.push(i.toString().padStart(3, "0"));
    }

    const availableVerses = allVerses.filter(v => !usedVersesAll.includes(v));

    if (!availableVerses.length) {
        alert("128 ç¯‡ç¥ç¦ç¶“å¥å·²å…¨æ•¸æŠ½å®Œï¼");
        isSpinning = false;
        return;
    }

    document.getElementById("statusText").innerText =
        "ç¬¬ 2 è¼ªï¼šç¥ç¦ç¶“å¥è¼ªç›¤ï¼ˆ001~128ï¼‰æŠ½ç±¤ä¸­â€¦";

    spinWheel(availableVerses, (selectedVerse) => {
        // ç¬¬äºŒè¼ªçµæœï¼šç¶“å¥ç·¨è™Ÿ
        if (!usedVersesAll.includes(selectedVerse)) {
            usedVersesAll.push(selectedVerse);
            localStorage.setItem("usedVersesAll", JSON.stringify(usedVersesAll));
        }

        const ref = (window.VERSE_REF_MAP && window.VERSE_REF_MAP[selectedVerse]) || "";
        document.getElementById("statusText").innerText =
            "ç¬¬ 2 è¼ªå®Œæˆï¼šæŠ½ä¸­ç¶“å¥ç·¨è™Ÿã€Œ" + selectedVerse + "ã€" +
            (ref ? "ï¼ˆ" + ref + "ï¼‰" : "") +
            "\nå³å°‡é¡¯ç¤ºç´…åŒ…ç¶“å¥ç•«é¢â€¦";
        document.getElementById("resultName").innerText =
            "æŠ½ä¸­å§“åï¼šã€Œ" + (currentName || "") + "ã€ï½œç¶“å¥ï¼š" +
            selectedVerse + (ref ? "ï¼ˆ" + ref + "ï¼‰" : "");

        // æœ€å¾Œè·³åˆ° viewer.htmlï¼ˆç”± viewer æ’­æ”¾ win.mp3ã€é¡¯ç¤º PNGã€å¯« PDF ç´€éŒ„ï¼‰
        setTimeout(() => {
            isSpinning = false;
            const url = "viewer.html?mode=name"
                + "&name="  + encodeURIComponent(currentName || "")
                + "&verse=" + encodeURIComponent(selectedVerse);
            window.location.href = url;
        }, 1200);
    });
}

// =============== é€šç”¨è¼ªç›¤ç¹ªè£½èˆ‡å‹•ç•« ===============
function drawWheelPlaceholder() {
    const center = 180;
    const radius = 160;

    ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
    ctx.beginPath();
    ctx.arc(center, center, radius, 0, 2 * Math.PI);
    ctx.fillStyle = "#fff6d6";
    ctx.fill();

    ctx.fillStyle = "#5a4635";
    ctx.font = "18px Noto Sans TC";
    ctx.textAlign = "center";
    ctx.fillText("è«‹é–å®šåå–®å¾Œ", center, center - 5);
    ctx.fillText("æŒ‰ã€Œé–‹å§‹æŠ½å§“å + ç¶“å¥ã€", center, center + 20);

    // ç´…è‰²å€’ä¸‰è§’æŒ‡é‡ï¼ˆæœä¸‹ï¼‰
    ctx.beginPath();
    ctx.moveTo(center, 70);       // å°–ç«¯åœ¨ä¸‹
    ctx.lineTo(center - 12, 40);  // å·¦ä¸Š
    ctx.lineTo(center + 12, 40);  // å³ä¸Š
    ctx.closePath();
    ctx.fillStyle = "#ff0000";
    ctx.fill();
}

function drawWheel(items, rotation = 0) {
    const total  = items.length;
    const center = 180;
    const radius = 160;
    const arc    = (2 * Math.PI) / total;

    ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);

    for (let i = 0; i < total; i++) {
        const startAngle = i * arc + rotation;
        const endAngle   = startAngle + arc;

        ctx.beginPath();
        ctx.moveTo(center, center);
        ctx.fillStyle = "#fff6d6";
        ctx.arc(center, center, radius, startAngle, endAngle);
        ctx.closePath();
        ctx.fill();

        // æ–‡å­—
        ctx.save();
        ctx.translate(center, center);
        ctx.rotate(startAngle + arc / 2);
        ctx.textAlign = "right";
        ctx.font = "18px Noto Sans TC";
        ctx.fillStyle = "#5a4635";
        ctx.fillText(items[i], radius - 10, 6);
        ctx.restore();
    }

    // ç´…è‰²å€’ä¸‰è§’æŒ‡é‡ï¼ˆå›ºå®šåœ¨ä¸Šæ–¹ï¼‰
    ctx.beginPath();
    ctx.moveTo(center, 70);       // å°–ç«¯åœ¨ä¸‹
    ctx.lineTo(center - 12, 40);  // å·¦ä¸Š
    ctx.lineTo(center + 12, 40);  // å³ä¸Š
    ctx.closePath();
    ctx.fillStyle = "#ff0000";
    ctx.fill();
}

/**
 * é€šç”¨è½‰ç›¤å‹•ç•«
 * items: é™£åˆ—ï¼ˆå§“å or ç¶“å¥ç·¨è™Ÿï¼‰
 * onDone: (selectedItem) => {}
 */
function spinWheel(items, onDone) {
    const total = items.length;
    if (!total) {
        alert("è³‡æ–™ä¸è¶³ï¼Œç„¡æ³•è½‰å‹•è¼ªç›¤");
        isSpinning = false;
        return;
    }

    const arc = (2 * Math.PI) / total;

    // éš¨æ©Ÿé¸ä¸€å€‹é …ç›®
    const selectedIndex = Math.floor(Math.random() * total);

    // æŒ‡é‡åœ¨ä¸Šæ–¹ï¼Œè§’åº¦ -90Â°
    const pointerAngle = -Math.PI / 2;
    const sliceCenter  = selectedIndex * arc + arc / 2;
    const baseAngle    = pointerAngle - sliceCenter;

    // å¤šè½‰å¹¾åœˆï¼ˆé€™è£¡å¤šè½‰ 4 åœˆï¼‰
    const extraSpins   = 4;
    const finalAngle   = baseAngle - extraSpins * 2 * Math.PI;

    const duration = 3000; // 3 ç§’
    const start    = performance.now();

    const drum = new Audio("audio/drum.mp3");
    drum.currentTime = 0;
    drum.play().catch(() => {});

    function animate(now) {
        const elapsed  = now - start;
        const t        = Math.min(elapsed / duration, 1);
        const eased    = 1 - Math.pow(1 - t, 3); // ease-out
        const angle    = finalAngle * eased;

        drawWheel(items, angle);

        if (t < 1) {
            requestAnimationFrame(animate);
        } else {
            // å‹•ç•«çµæŸ
            const selectedItem = items[selectedIndex];
            onDone(selectedItem);
        }
    }

    requestAnimationFrame(animate);
}

// ================== PDFï¼šå¤–éƒ¨å­—å‹è¼‰å…¥ ==================

// Uint8Array â†’ Base64
function uint8ToBase64(uint8) {
    let binary = "";
    for (let i = 0; i < uint8.byteLength; i++) {
        binary += String.fromCharCode(uint8[i]);
    }
    return window.btoa(binary);
}

// åŒ¯å‡º PDFï¼ˆç”¨ drawLogs + VERSE_REF_MAPï¼‰
async function exportPDF() {
    const { jsPDF } = window.jspdf;

    // é‡æ–°å¾ localStorage å–ä¸€æ¬¡æœ€æ–°ç´€éŒ„
    drawLogs = JSON.parse(localStorage.getItem("drawLogs") || "[]");

    if (!drawLogs || drawLogs.length === 0) {
        alert("ç›®å‰æ²’æœ‰æŠ½ç±¤ç´€éŒ„ï¼");
        return;
    }

    const doc = new jsPDF({
        unit: "pt",
        format: "a4",
    });

    const fontUrl = "fonts/NotoSansTC-Regular.ttf";

    try {
        const fontBuffer = await fetch(fontUrl).then(res => res.arrayBuffer());
        const fontUint8  = new Uint8Array(fontBuffer);
        const fontBase64 = uint8ToBase64(fontUint8);

        doc.addFileToVFS("NotoSansTC-Regular.ttf", fontBase64);
        doc.addFont("NotoSansTC-Regular.ttf", "NotoSansTC", "normal");
        doc.setFont("NotoSansTC", "normal");
    } catch (e) {
        console.error("å­—å‹è¼‰å…¥å¤±æ•—ï¼š", e);
        alert("PDF å­—å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª fonts/NotoSansTC-Regular.ttf æ˜¯å¦å­˜åœ¨ã€‚");
        return;
    }

    // æ¨™é¡Œ
    let y = 40;
    doc.setFontSize(18);
    doc.text("BlessingCards128 æŠ½ç±¤ç´€éŒ„", 40, y);

    y += 30;
    doc.setFontSize(12);

    drawLogs.forEach(log => {
        const ref = (window.VERSE_REF_MAP && window.VERSE_REF_MAP[log.verseNo]) || "";
        const line =
            `[${log.time}] ${log.name}` +
            (log.category ? `ï½œåˆ†é¡ï¼š${log.category}` : "") +
            `ï½œç¶“å¥ï¼š${log.verseNo}${ref ? `ï¼ˆ${ref}ï¼‰` : ""}`;

        if (y > 800) {
            doc.addPage();
            y = 40;
        }
        doc.text(line, 40, y);
        y += 20;
    });

    doc.save("æŠ½ç±¤ç´€éŒ„.pdf");
}
</script>

</body>
</html>
