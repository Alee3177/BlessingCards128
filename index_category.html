<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BlessingCards128 - åˆ†é¡æŠ½ç±¤</title>

<link rel="stylesheet" href="fonts/fonts.css">

<style>
  body {
    margin:0;
    background:#fff7e6;
    font-family:"NotoSansTC", sans-serif;
    text-align:center;
    color:#8a5500;
  }
  .container {
    max-width:900px;
    margin:auto;
    padding:20px;
  }
  .logo {
    width:120px;
    margin-top:20px;
  }
  h1 {
    font-size:28px;
    color:#b37500;
    margin-top:10px;
  }

  select, textarea {
    width:90%;
    padding:10px;
    font-size:18px;
    border-radius:10px;
    border:1px solid #d0a85c;
    outline:none;
    margin-top:12px;
    font-family:"NotoSansTC";
    background:#fff;
  }

  .btn {
    background:#ffcc66;
    border:none;
    padding:12px 22px;
    border-radius:10px;
    font-size:20px;
    cursor:pointer;
    margin-top:12px;
  }
  .btn:hover { background:#ffdd88; }

  .wheel-wrapper {
    position:relative;
    width:300px;
    margin:15px auto 0 auto;
    display:none;
  }

  /* ğŸ”» å€’ä¸‰è§’æŒ‡é‡ï¼ˆA æ¬¾ç´”ç´…ï¼‰ */
  .pointer {
    position:absolute;
    left:50%;
    top:-30px;
    transform:translateX(-50%);
    width:0;
    height:0;
    border-left:18px solid transparent;
    border-right:18px solid transparent;
    border-top:32px solid red; /* æœä¸‹ */
    z-index:20;
  }

  #categoryWheel {
    display:block;
    width:100%;
    height:auto;
  }

  #resultArea {
    font-size:26px;
    margin-top:16px;
    min-height:2.5em;
    color:#b37500;
  }

  .bottom-buttons {
    margin-top:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:center;
  }
</style>
</head>

<body>
<div class="container">
  <img src="logo3524.png" class="logo" alt="logo" />
  <h1>åˆ†é¡æŠ½ç±¤</h1>

  <select id="categorySelect" onchange="onCategorySelected()">
    <option value="">è«‹é¸æ“‡åˆ†é¡</option>
  </select>

  <textarea id="nameInput" style="display:none"
    placeholder="è«‹è¼¸å…¥æ­¤åˆ†é¡è¦æŠ½ç±¤çš„å§“åï¼ˆé€—è™Ÿåˆ†éš”ï¼‰"
    oninput="updateNames()"></textarea>

  <div class="bottom-buttons">
    <button id="startBtn" class="btn" style="display:none" onclick="startNameSpin()">
      é–‹å§‹æŠ½å§“å
    </button>
    <button id="resetBtn" class="btn" style="display:none" onclick="resetAll()">
      å…¨éƒ¨æ­¸é›¶
    </button>
  </div>

  <div class="wheel-wrapper" id="wheelWrapper">
    <div class="pointer"></div>
    <canvas id="categoryWheel" width="300" height="300"></canvas>
  </div>

  <div id="resultArea"></div>

  <button class="btn" onclick="goHome()">å›é¦–é </button>
</div>

<script>
/* æŒ‡é‡ï¼šå›ºå®šåœ¨ç•«é¢æœ€ä¸Šæ–¹ï¼Œç®­é ­æœä¸‹ï¼ˆâ–¼ï¼‰ï¼Œå°æ‡‰è§’åº¦ -90Â° = -Math.PI/2 */
const POINTER_ANGLE = -Math.PI / 2;

/* 1~128 å°æ‡‰åˆ†é¡ï¼ˆæ²¿ç”¨ä½ åŸæœ¬çš„å°ç…§è¡¨ï¼‰ */
const categoryMap = [
  "",
  "å¹³å®‰èˆ‡ä¿è­·","å…¶ä»–","ç›¼æœ›èˆ‡åŠ›é‡","æ©å…¸èˆ‡æ†æ†«","å¹³å®‰èˆ‡ä¿è­·","ä¾›æ‡‰èˆ‡è±ç››","å…¶ä»–","å…¶ä»–",
  "ç›¼æœ›èˆ‡åŠ›é‡","ç›¼æœ›èˆ‡åŠ›é‡","å¹³å®‰èˆ‡ä¿è­·","ç›¼æœ›èˆ‡åŠ›é‡","å¹³å®‰èˆ‡ä¿è­·","å…¶ä»–","å¹³å®‰èˆ‡ä¿è­·",
  "å…¶ä»–","å…¶ä»–","å¹³å®‰èˆ‡ä¿è­·","å¹³å®‰èˆ‡ä¿è­·","å¹³å®‰èˆ‡ä¿è­·","å–œæ¨‚èˆ‡æ„Ÿæ©","å¹³å®‰èˆ‡ä¿è­·",
  "ä¿¡å¿ƒèˆ‡é †æœ","æ™ºæ…§èˆ‡å¼•å°","å¹³å®‰èˆ‡ä¿è­·","æ™ºæ…§èˆ‡å¼•å°","æ™ºæ…§èˆ‡å¼•å°","æ©å…¸èˆ‡æ†æ†«",
  "å–œæ¨‚èˆ‡æ„Ÿæ©","å¹³å®‰èˆ‡ä¿è­·","å¹³å®‰èˆ‡ä¿è­·","ç›¼æœ›èˆ‡åŠ›é‡","å¹³å®‰èˆ‡ä¿è­·","ä¿¡å¿ƒèˆ‡é †æœ",
  "ç›æœ›èˆ‡åŠ›é‡","ç›æœ›èˆ‡åŠ›é‡","æ©å…¸èˆ‡æ†æ†«","æ©å…¸èˆ‡æ†æ†«","ä¿¡å¿ƒèˆ‡é †æœ","ä¿¡å¿ƒèˆ‡é †æœ",
  "æ™ºæ…§èˆ‡å¼•å°","å…¶ä»–","å–œæ¨‚èˆ‡æ„Ÿæ©","å–œæ¨‚èˆ‡æ„Ÿæ©","æ©å…¸èˆ‡æ†æ†«","å…¶ä»–","ä¿¡å¿ƒèˆ‡é †æœ",
  "å…¶ä»–","ç›¼æœ›èˆ‡åŠ›é‡","ç›¼æœ›èˆ‡åŠ›é‡","å¹³å®‰èˆ‡ä¿è­·","å…¶ä»–","æ©å…¸èˆ‡æ†æ†«","æ©å…¸èˆ‡æ†æ†«",
  "å¹³å®‰èˆ‡ä¿è­·","å¹³å®‰èˆ‡ä¿è­·","å…¶ä»–","æ©å…¸èˆ‡æ†æ†«","æ©å…¸èˆ‡æ†æ†«","ä¿¡å¿ƒèˆ‡é †æœ","ä¿¡å¿ƒèˆ‡é †æœ",
  "å…¶ä»–","ä¿¡å¿ƒèˆ‡é †æœ","å¹³å®‰èˆ‡ä¿è­·","å–œæ¨‚èˆ‡æ„Ÿæ©","å…¶ä»–","å…¶ä»–","å¹³å®‰èˆ‡ä¿è­·","ä¿¡å¿ƒèˆ‡é †æœ",
  "å…¶ä»–","å…¶ä»–","å…¶ä»–","å…¶ä»–","å…¶ä»–","ç›æœ›èˆ‡åŠ›é‡","æ©å…¸èˆ‡æ†æ†«","å¹³å®‰èˆ‡ä¿è­·","ä¿¡å¿ƒèˆ‡é †æœ",
  "å¹³å®‰èˆ‡ä¿è­·","å¹³å®‰èˆ‡ä¿è­·","æ™ºæ…§èˆ‡å¼•å°","å…¶ä»–","å¹³å®‰èˆ‡ä¿è­·","å…¶ä»–","å–œæ¨‚èˆ‡æ„Ÿæ©",
  "å…¶ä»–","å…¶ä»–","ä¿¡å¿ƒèˆ‡é †æœ","å…¶ä»–","å…¶ä»–","å…¶ä»–","å…¶ä»–","å…¶ä»–","å…¶ä»–","å…¶ä»–",
  "æ™ºæ…§èˆ‡å¼•å°","ç›æœ›èˆ‡åŠ›é‡","å…¶ä»–","å¹³å®‰èˆ‡ä¿è­·","å…¶ä»–","å…¶ä»–","å…¶ä»–","å…¶ä»–","å…¶ä»–",
  "ä¿¡å¿ƒèˆ‡é †æœ","å…¶ä»–","å¹³å®‰èˆ‡ä¿è­·","å…¶ä»–","å¹³å®‰èˆ‡ä¿è­·","æ™ºæ…§èˆ‡å¼•å°","å…¶ä»–","å…¶ä»–",
  "å…¶ä»–","æ©å…¸èˆ‡æ†æ†«","å…¶ä»–","å¹³å®‰èˆ‡ä¿è­·","å…¶ä»–","ç›æœ›èˆ‡åŠ›é‡","ä¾›æ‡‰èˆ‡è±ç››","ä¾›æ‡‰èˆ‡è±ç››",
  "å–œæ¨‚èˆ‡æ„Ÿæ©","å…¶ä»–","ç›æœ›èˆ‡åŠ›é‡","å…¶ä»–","å…¶ä»–","å…¶ä»–","å…¶ä»–","å…¶ä»–"
];

let canvas, ctx;
let names = [];
let selectedCategory = "";
let usedNamesAll = [];
let usedVersesAll = [];
let isSpinning = false;

let drumAudio = new Audio("audio/drum.mp3");

document.addEventListener("DOMContentLoaded", () => {
  try{
    usedNamesAll  = JSON.parse(localStorage.getItem("usedNamesAll")  || "[]");
    usedVersesAll = JSON.parse(localStorage.getItem("usedVersesAll") || "[]");
  }catch(e){
    usedNamesAll = [];
    usedVersesAll = [];
  }

  canvas = document.getElementById("categoryWheel");
  ctx    = canvas.getContext("2d");

  buildCategoryOptions();
});

/* å»ºç«‹åˆ†é¡ä¸‹æ‹‰é¸å–® */
function buildCategoryOptions(){
  const counts = {};
  for(let i = 1; i < categoryMap.length; i++){
    const c = categoryMap[i] || "æœªåˆ†é¡";
    counts[c] = (counts[c] || 0) + 1;
  }
  const sel = document.getElementById("categorySelect");
  Object.keys(counts).forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = `${cat}ï¼ˆå…± ${counts[cat]} ç¯€ï¼‰`;
    sel.appendChild(opt);
  });
}

/* é¸æ“‡åˆ†é¡å¾Œï¼Œé¡¯ç¤ºå§“åè¼¸å…¥ï¼‹è¼ªç›¤ */
function onCategorySelected(){
  selectedCategory = document.getElementById("categorySelect").value;
  const show = !!selectedCategory;

  document.getElementById("nameInput").style.display    = show ? "block" : "none";
  document.getElementById("startBtn").style.display     = show ? "block" : "none";
  document.getElementById("resetBtn").style.display     = show ? "block" : "none";
  document.getElementById("wheelWrapper").style.display = show ? "block" : "none";

  document.getElementById("resultArea").textContent = "";
  if(show) updateNames();
}

/* æ›´æ–° names é™£åˆ—ä¸¦é‡æ–°ç•«è¼ªç›¤ */
function updateNames(){
  names = document.getElementById("nameInput").value
    .split(",")
    .map(s => s.trim())
    .filter(s => s.length > 0);

  drawWheel(0);
}

/* ç•«åˆ†é¡è¼ªç›¤ï¼šangle = æ•´å€‹è¼ªç›¤ç›®å‰çš„æ—‹è½‰è§’åº¦ï¼ˆå¼§åº¦ï¼‰ */
function drawWheel(angle){
  if(!ctx) return;

  ctx.save();
  ctx.clearRect(0, 0, 300, 300);

  ctx.translate(150, 150);
  ctx.rotate(angle);
  ctx.translate(-150, -150);

  const count = names.length || 1;
  const arc   = 2 * Math.PI / count;

  for(let i = 0; i < count; i++){
    const start = i * arc;
    const end   = start + arc;

    ctx.beginPath();
    ctx.moveTo(150, 150);
    ctx.arc(150, 150, 150, start, end);
    ctx.closePath();
    ctx.fillStyle = (i % 2 === 0) ? "#ffe6a1" : "#ffcc66";
    ctx.fill();

    ctx.strokeStyle = "#ffffff";
    ctx.lineWidth   = 2;
    ctx.stroke();

    const name = names[i];
    if(name){
      const centerAngle = start + arc / 2;

      ctx.save();
      ctx.translate(150, 150);
      ctx.rotate(centerAngle);
      ctx.textAlign = "right";
      ctx.font      = "bold 18px NotoSansTC";
      ctx.fillStyle = "#8a5500";
      ctx.fillText(name, 135, 8);
      ctx.restore();
    }
  }

  ctx.restore();
}

/* é–‹å§‹æŠ½å§“åï¼ˆåˆ†é¡æ¨¡å¼ï¼‰ */
function startNameSpin(){
  if(isSpinning) return;

  if(!selectedCategory){
    alert("è«‹å…ˆé¸æ“‡åˆ†é¡");
    return;
  }

  updateNames();

  if(names.length === 0){
    alert("è«‹å…ˆè¼¸å…¥å§“å");
    return;
  }

  const available = names.filter(n => !usedNamesAll.includes(n));
  if(!available.length){
    alert("å…¨éƒ¨å§“åéƒ½å·²æŠ½å®Œï¼");
    return;
  }

  const winner = available[Math.floor(Math.random() * available.length)];

  const count = names.length;
  const arc   = 2 * Math.PI / count;
  const idx   = names.indexOf(winner);

  const winnerCenterAngle = idx * arc + arc / 2;
  const spins = 6;
  const angleFinal =
    spins * 2 * Math.PI + (POINTER_ANGLE - winnerCenterAngle);

  isSpinning = true;
  drumAudio.currentTime = 0;
  drumAudio.play().catch(() => {});

  let startTime = null;
  const duration = 10000;

  function animate(ts){
    if(!startTime) startTime = ts;
    const t = Math.min((ts - startTime) / duration, 1);
    const ease = 1 - Math.pow(1 - t, 3);
    const angle = ease * angleFinal;

    drawWheel(angle);

    if(t < 1){
      requestAnimationFrame(animate);
    }else{
      drumAudio.pause();
      drumAudio.currentTime = 0;
      isSpinning = false;

      if(!usedNamesAll.includes(winner)){
        usedNamesAll.push(winner);
        localStorage.setItem("usedNamesAll", JSON.stringify(usedNamesAll));
      }

      showWinner(winner);
    }
  }

  requestAnimationFrame(animate);
}

/* é¡¯ç¤ºä¸­çè€…ï¼Œä¸¦æä¾›ã€ŒæŠ½åˆ†é¡ç¶“å¥ã€æŒ‰éˆ• */
function showWinner(name){
  document.getElementById("resultArea").innerHTML =
    `æŠ½ä¸­ï¼š<b>${name}</b><br><br>
     <button class="btn" onclick="drawCategoryVerse('${name}')">
       æŠ½ç´…åŒ…ç¥ç¦ç¶“å¥
     </button>`;
}

/* åœ¨æ‰€é¸åˆ†é¡ä¸­æŠ½ä¸€ç¯€å°šæœªæŠ½éçš„ç¶“å¥ */
function drawCategoryVerse(name){
  if(!selectedCategory){
    alert("è«‹å…ˆé¸æ“‡åˆ†é¡");
    return;
  }

  const remain = [];
  for(let i = 1; i < categoryMap.length; i++){
    if(categoryMap[i] === selectedCategory &&
       !usedVersesAll.includes(i)){
      remain.push(i);
    }
  }

  if(!remain.length){
    alert("æ­¤åˆ†é¡çš„ç¶“å¥å·²æŠ½å®Œï¼");
    return;
  }

  const v = remain[Math.floor(Math.random() * remain.length)];
  usedVersesAll.push(v);
  localStorage.setItem("usedVersesAll", JSON.stringify(usedVersesAll));

  const padded = String(v).padStart(3, "0");
  const n = encodeURIComponent(name);
  const c = encodeURIComponent(selectedCategory);

  window.location = `viewer.html?no=${padded}&name=${n}&cat=${c}`;
}

/* é‡ç½®å…¨éƒ¨ç´€éŒ„ï¼ˆå…±ç”¨èˆ‡é¦–é ç›¸åŒçš„ usedNamesAll / usedVersesAll / drawLogsï¼‰ */
function resetAll(){
  if(!confirm("ç¢ºå®šé‡ç½®å…¨éƒ¨ç´€éŒ„ï¼Ÿ")) return;

  usedNamesAll  = [];
  usedVersesAll = [];
  localStorage.setItem("usedNamesAll", "[]");
  localStorage.setItem("usedVersesAll", "[]");
  localStorage.setItem("drawLogs", "[]");

  document.getElementById("resultArea").textContent = "";
}

/* å›é¦–é  */
function goHome(){
  window.location = "index.html";
}
</script>

</body>
</html>
