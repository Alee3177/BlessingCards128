<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>BlessingCards128 - 分類抽籤</title>

<style>
:root {
  --bg: #fff7e6;
  --brown-text: #8a5500;
  --brown-title: #b37500;
  --gold-light: #ffe9a3;
  --gold-mid: #ffd166;
  --gold-dark: #e8a838;
}

body {
  margin: 0;
  background: var(--bg);
  font-family: "NotoSansTC", sans-serif;
  text-align: center;
  color: var(--brown-text);
}

.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px 16px 40px;
}

h1 {
  font-size: 26px;
  margin: 12px 0;
  color: var(--brown-title);
}

textarea,
select {
  width: 100%;
  max-width: 520px;
  padding: 12px;
  font-size: 16px;
  border-radius: 12px;
  border: 1px solid #d0a85c;
  font-family: "NotoSansTC";
  background: white;
  margin-top: 10px;
}

.btn {
  min-width: 180px;
  padding: 12px 20px;
  margin: 8px;
  border: none;
  border-radius: 999px;
  background: linear-gradient(180deg, var(--gold-light), var(--gold-mid));
  font-size: 18px;
  font-weight: 600;
  color: var(--brown-text);
  box-shadow: 0 3px 6px rgba(0,0,0,0.18);
  cursor: pointer;
}

.btn:hover {
  background: linear-gradient(180deg, var(--gold-mid), var(--gold-dark));
}

#wheelWrapper {
  margin-top: 40px;
  position: relative;
  width: 320px;
  margin-left: auto;
  margin-right: auto;
}

.pointer {
  position: absolute;
  left: 50%;
  top: -32px;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 18px solid transparent;
  border-right: 18px solid transparent;
  border-top: 32px solid red;
  z-index: 10;
}

canvas {
  width: 100%;
  height: auto;
}

#resultArea {
  margin-top: 20px;
  font-size: 22px;
  min-height: 2.5em;
}
</style>

</head>
<body>

<div class="container">

  <h1>分類抽籤（BlessingCards128）</h1>

  <select id="categorySelect" onchange="onCategorySelected()">
    <option value="">請選擇分類</option>
  </select>

  <textarea id="nameInput" placeholder="請輸入姓名，以逗號分隔" style="display:none;"></textarea>

  <div id="buttonsArea" style="display:none;">
    <button class="btn" onclick="startNameSpin()">開始抽姓名</button>
    <button class="btn" onclick="resetAll()">全部歸零</button>
  </div>

  <div id="wheelWrapper" style="display:none;">
    <div class="pointer"></div>
    <canvas id="categoryWheel" width="320" height="320"></canvas>
  </div>

  <div id="resultArea"></div>

  <button class="btn" onclick="goHome()">回首頁</button>

</div>

<script>
/* ===========================
      分類資料（照你原本邏輯）
========================== */
const categoryMap = [
  "",
  "平安與保護","其他","盼望與力量","恩典與憐憫","平安與保護","供應與豐盛","其他","其他",
  "盼望與力量","盼望與力量","平安與保護","盼望與力量","平安與保護","其他","平安與保護",
  "其他","其他","平安與保護","平安與保護","平安與保護","喜樂與感恩","平安與保護",
  "信心與順服","智慧與引導","平安與保護","智慧與引導","智慧與引導","恩典與憐憫",
  "喜樂與感恩","平安與保護","平安與保護","盼望與力量","平安與保護","信心與順服",
  "盞望與力量","盞望與力量","恩典與憐憫","恩典與憐憫","信心與順服","信心與順服",
  "智慧與引導","其他","喜樂與感恩","喜樂與感恩","恩典與憐憫","其他","信心與順服",
  "其他","盼望與力量","盼望與力量","平安與保護","其他","恩典與憐憫","恩典與憐憫",
  "平安與保護","平安與保護","其他","恩典與憐憫","恩典與憐憫","信心與順服","信心與順服",
  "其他","信心與順服","平安與保護","喜樂與感恩","其他","其他","平安與保護","信心與順服",
  "其他","其他","其他","其他","其他","盞望與力量","恩典與憐憫","平安與保護","信心與順服",
  "平安與保護","平安與保護","智慧與引導","其他","平安與保護","其他","喜樂與感恩",
  "其他","其他","信心與順服","其他","其他","其他","其他","其他","其他","其他",
  "智慧與引導","盞望與力量","其他","平安與保護","其他","其他","其他","其他","其他",
  "信心與順服","其他","平安與保護","其他","平安與保護","智慧與引導","其他","其他",
  "其他","恩典與憐憫","其他","平安與保護","其他","盞望與力量","供應與豐盛","供應與豐盛",
  "喜樂與感恩","其他","盞望與力量","其他","其他","其他","其他","其他"
];

/* ===========================
      初始化
========================== */
let names = [];
let usedNames = [];
let usedVerses = [];
let selectedCategory = "";
let spinning = false;

let canvas, ctx;

document.addEventListener("DOMContentLoaded", () => {
  usedNames = JSON.parse(localStorage.getItem("usedNamesAll") || "[]");
  usedVerses = JSON.parse(localStorage.getItem("usedVersesAll") || "[]");

  canvas = document.getElementById("categoryWheel");
  ctx = canvas.getContext("2d");

  buildCategoryOptions();
});

/* ===========================
   建立分類下拉選單
========================== */
function buildCategoryOptions(){
  const counts = {};
  for(let i=1; i<categoryMap.length; i++){
    const c = categoryMap[i];
    counts[c] = (counts[c]||0) + 1;
  }

  const sel = document.getElementById("categorySelect");

  Object.keys(counts).forEach(cat=>{
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = `${cat}（${counts[cat]} 節）`;
    sel.appendChild(opt);
  });
}

/* ===========================
   選擇分類
========================== */
function onCategorySelected(){
  selectedCategory = document.getElementById("categorySelect").value;
  const show = !!selectedCategory;

  document.getElementById("nameInput").style.display = show ? "block" : "none";
  document.getElementById("buttonsArea").style.display = show ? "block" : "none";
  document.getElementById("wheelWrapper").style.display = show ? "block" : "none";

  names = [];
  drawWheel(0);
}

/* ===========================
   更新姓名
========================== */
function updateNames(){
  names = document.getElementById("nameInput").value
    .split(",")
    .map(s => s.trim())
    .filter(s => s.length > 0);

  drawWheel(0);
}

/* ===========================
   畫輪盤
========================== */
const POINTER_ANGLE = -Math.PI / 2;

function drawWheel(angle){
  ctx.clearRect(0,0,320,320);
  ctx.save();

  ctx.translate(160,160);
  ctx.rotate(angle);
  ctx.translate(-160,-160);

  const count = names.length || 1;
  const arc = 2 * Math.PI / count;

  for(let i=0; i<count; i++){
    const start = i * arc;
    const end = start + arc;

    ctx.beginPath();
    ctx.moveTo(160,160);
    ctx.arc(160,160,160,start,end);
    ctx.closePath();

    ctx.fillStyle = i % 2 === 0 ? "#ffe6a1" : "#ffd48a";
    ctx.fill();

    if(names[i]){
      const mid = start + arc/2;
      ctx.save();
      ctx.translate(160,160);
      ctx.rotate(mid);
      ctx.font = "bold 18px NotoSansTC";
      ctx.textAlign = "right";
      ctx.fillStyle = "#8a5500";
      ctx.fillText(names[i], 145, 5);
      ctx.restore();
    }
  }

  ctx.restore();
}

/* ===========================
     抽姓名
========================== */
function startNameSpin(){
  if(!selectedCategory){
    alert("請先選擇分類");
    return;
  }
  if(spinning) return;

  updateNames();
  if(names.length === 0){
    alert("請輸入姓名");
    return;
  }

  const available = names.filter(n => !usedNames.includes(n));
  if(available.length === 0){
    alert("所有姓名已抽完！");
    return;
  }

  const winner = available[Math.floor(Math.random()*available.length)];
  const count = names.length;
  const arc = 2*Math.PI / count;
  const index = names.indexOf(winner);
  const mid = index*arc + arc/2;

  const spins = 6;
  const angleFinal = spins*2*Math.PI + (POINTER_ANGLE - mid);

  spinning = true;
  let start=null;
  const duration=8000;

  function animate(ts){
    if(!start) start=ts;
    const t=(ts-start)/duration;
    const eased=1-Math.pow(1-t,3);
    const angle=eased*angleFinal;

    drawWheel(angle);

    if(t<1){
      requestAnimationFrame(animate);
    }else{
      spinning=false;
      finalizeWinner(winner);
    }
  }
  requestAnimationFrame(animate);
}

/* ===========================
      顯示中獎者
========================== */
function finalizeWinner(winner){
  if(!usedNames.includes(winner)){
    usedNames.push(winner);
    localStorage.setItem("usedNamesAll", JSON.stringify(usedNames));
  }

  document.getElementById("resultArea").innerHTML =
    `抽中：<b>${winner}</b><br>
     <button class="btn" onclick="drawCategoryVerse('${winner}')">抽經句</button>`;
}

/* ===========================
    抽分類經句
========================== */
function drawCategoryVerse(name){
  const remaining = [];
  for(let i=1;i<categoryMap.length;i++){
    if(categoryMap[i]===selectedCategory && !usedVerses.includes(i)){
      remaining.push(i);
    }
  }

  if(remaining.length===0){
    alert("此分類的經句已抽完！");
    return;
  }

  const verse = remaining[Math.floor(Math.random()*remaining.length)];
  usedVerses.push(verse);
  localStorage.setItem("usedVersesAll", JSON.stringify(usedVerses));

  const no = String(verse).padStart(3,"0");
  const n = encodeURIComponent(name);
  const c = encodeURIComponent(selectedCategory);

  window.location = `viewer.html?no=${no}&name=${n}&cat=${c}`;
}

/* ===========================
      全部歸零
=========================
