<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>祝福經句紅包（分類抽籤）</title>

<style>
:root {
  --bg: #fff7e6;
  --brown-text: #8a5500;
  --brown-title: #b37500;
  --gold-light: #ffe9a3;
  --gold-mid: #ffd166;
  --gold-dark: #e8a838;
}

body {
  margin: 0;
  background: var(--bg);
  font-family: "NotoSansTC", sans-serif;
  text-align: center;
  color: var(--brown-text);
}

.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px 16px 60px;
}

/* logo */
.logo-box {
  width: 100%;
  text-align: center;
  margin-top: 10px;
}
.logo {
  width: 180px;
  height: auto;
  margin-bottom: 10px;
}

h1 {
  font-size: 26px;
  margin: 12px 0;
  color: var(--brown-title);
}

/* 下拉選單 */
select {
  padding: 12px;
  font-size: 18px;
  border-radius: 12px;
  border: 1px solid #d0a85c;
  background: white;
  margin-top: 10px;
  font-family: "NotoSansTC";
}

/* 按鈕 */
.btn {
  min-width: 180px;
  padding: 12px 22px;
  margin: 10px;
  border: none;
  border-radius: 999px;
  background: linear-gradient(180deg, var(--gold-light), var(--gold-mid));
  font-size: 18px;
  font-weight: 600;
  color: var(--brown-text);
  box-shadow: 0 3px 6px rgba(0,0,0,0.18);
  cursor: pointer;
}
.btn:hover {
  background: linear-gradient(180deg, var(--gold-mid), var(--gold-dark));
}

/* 轉盤 */
#wheelWrapper {
  margin-top: 40px;
  position: relative;
  width: 320px;
  margin-left: auto;
  margin-right: auto;
}
.pointer {
  position: absolute;
  left: 50%;
  top: -32px;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 18px solid transparent;
  border-right: 18px solid transparent;
  border-top: 32px solid red;
  z-index: 10;
}
canvas {
  width: 100%;
  height: auto;
}

/* 顯示結果 */
#resultArea {
  margin-top: 20px;
  font-size: 22px;
  min-height: 2.5em;
}
</style>

<!-- 字型 + 經文參照 -->
<script src="font_base64.js"></script>
<script src="verseRefMap.js"></script>

<!-- PDF 套件（供首頁使用）-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>

<!-- logo -->
<div class="logo-box">
  <img src="logo3524.png" class="logo" alt="logo">
</div>

<!-- 音效 -->
<audio id="drumroll" src="audio/drum.mp3" preload="auto"></audio>

<div class="container">

<h1>分類抽籤（祝福經句紅包）</h1>

<!-- 8 種分類 -->
<div>
  <select id="categorySelect">
    <option value="平安與保護">平安與保護</option>
    <option value="供應與豐盛">供應與豐盛</option>
    <option value="其他">其他</option>
    <option value="信心與順服">信心與順服</option>
    <option value="盼望與力量">盼望與力量</option>
    <option value="恩典與憐憫">恩典與憐憫</option>
    <option value="喜樂與感恩">喜樂與感恩</option>
    <option value="智慧與引導">智慧與引導</option>
  </select>
</div>

<div>
  <button class="btn" onclick="startCategorySpin()">抽分類</button>
  <button class="btn" onclick="goHome()">回首頁</button>
</div>

<div id="wheelWrapper">
  <div class="pointer"></div>
  <canvas id="catWheel" width="320" height="320"></canvas>
</div>

<div id="resultArea"></div>

</div>

<script>
/* ======================================
       全域狀態
====================================== */

const POINTER_ANGLE = -Math.PI/2;
let canvas, ctx;
let categories = [
  "平安與保護",
  "供應與豐盛",
  "其他",
  "信心與順服",
  "盼望與力量",
  "恩典與憐憫",
  "喜樂與感恩",
  "智慧與引導"
];

let spinning = false;
let drumrollSound;

let usedNames = [];   // 與首頁同步
let usedVerses = [];  // 與首頁同步
let currentCategory = "";

/* ======================================
       初始化
====================================== */
document.addEventListener("DOMContentLoaded", ()=>{
  canvas = document.getElementById("catWheel");
  ctx    = canvas.getContext("2d");
  drumrollSound = document.getElementById("drumroll");

  usedNames = JSON.parse(localStorage.getItem("usedNamesAll") || "[]");
  loadUsedVerses();

  drawWheel(0);
});

/* 抽籤紀錄中的經句 → usedVerses */
function loadUsedVerses(){
  const logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
  const set  = new Set();
  logs.forEach(log => set.add(parseInt(log.verseNo,10)));
  usedVerses = Array.from(set);
}

/* ======================================
      畫分類轉盤
====================================== */
function drawWheel(angle){
  ctx.clearRect(0,0,320,320);

  ctx.save();
  ctx.translate(160,160);
  ctx.rotate(angle);
  ctx.translate(-160,-160);

  const count = categories.length;
  const arc   = 2*Math.PI / count;

  for(let i=0; i<count; i++){
    const start = i*arc;
    const end   = start+arc;

    ctx.beginPath();
    ctx.moveTo(160,160);
    ctx.arc(160,160,160,start,end);
    ctx.closePath();

    ctx.fillStyle = i%2===0 ? "#ffe6a1" : "#ffd48a";
    ctx.fill();

    // 白色分隔線
    ctx.strokeStyle = "white";
    ctx.lineWidth   = 2;
    ctx.beginPath();
    ctx.moveTo(160,160);
    ctx.lineTo(160+160*Math.cos(start),160+160*Math.sin(start));
    ctx.stroke();

    // 類別文字
    const mid = start + arc/2;
    ctx.save();
    ctx.translate(160,160);
    ctx.rotate(mid);
    ctx.font = "bold 18px NotoSansTC";
    ctx.fillStyle = "#8a5500";
    ctx.textAlign = "right";
    ctx.fillText(categories[i], 145, 5);
    ctx.restore();
  }

  ctx.restore();
}

/* ======================================
      抽分類
====================================== */
function startCategorySpin(){
  if(spinning) return;

  const selected = document.getElementById("categorySelect").value;
  currentCategory = selected;

  const index = categories.indexOf(selected);
  const count = categories.length;
  const arc   = 2*Math.PI / count;
  const mid   = index*arc + arc/2;

  const spins = 6;
  const angleFinal = spins*2*Math.PI + (POINTER_ANGLE - mid);

  spinning = true;
  let startTs = null;
  const duration = 8000;

  drumrollSound.currentTime = 0;
  drumrollSound.play().catch(()=>{});

  function animate(ts){
    if(!startTs) startTs = ts;
    const t  = (ts-startTs)/duration;
    const e  = 1 - Math.pow(1-t,3);
    const ag = e * angleFinal;

    drawWheel(ag);

    if(t<1){
      requestAnimationFrame(animate);
    } else {
      spinning = false;
      drumrollSound.pause();
      setTimeout(()=> finalizeCategory(selected),100);
    }
  }

  requestAnimationFrame(animate);
}

/* ======================================
      顯示抽中的分類
====================================== */
function finalizeCategory(cat){
  document.getElementById("resultArea").innerHTML =
    `【${cat}】<br>
     <button class="btn" onclick="drawVerse()">抽經句</button>`;
}

/* ======================================
      抽經句（分類抽籤）
====================================== */
function drawVerse(){
  if(!currentCategory){
    alert("請先抽分類");
    return;
  }

  if(usedVerses.length >= 128){
    alert("所有經句已抽完！");
    return;
  }

  const remaining = [];
  for(let i=1; i<=128; i++){
    if(!usedVerses.includes(i)) remaining.push(i);
  }

  if(!remaining.length){
    alert("所有經句已抽完！");
    return;
  }

  const verse = remaining[Math.floor(Math.random()*remaining.length)];
  usedVerses.push(verse);

  const no = String(verse).padStart(3,"0");

  addLogEntry(currentCategory, no);

  window.location = `viewer.html?no=${no}&name=${encodeURIComponent(currentCategory)}`;
}

/* ======================================
      寫入抽籤紀錄
====================================== */
function addLogEntry(category, verseNo){
  let logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");

  logs.push({
    time: new Date().toLocaleString(),
    name: category,        // 顯示分類
    category,
    verseNo
  });

  localStorage.setItem("drawLogs", JSON.stringify(logs));
}

/* ======================================
      回首頁
====================================== */
function goHome(){
  window.location = "index.html";
}

</script>

</body>
</html>
