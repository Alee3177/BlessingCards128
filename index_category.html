<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>分類抽籤 - BlessingCards128</title>

<link rel="stylesheet" href="fonts/fonts.css">

<style>
    body {
        margin:0;
        background:#fff7e6;
        font-family:"NotoSansTC", sans-serif;
        text-align:center;
        color:#8a5500;
    }

    .container {
        max-width:900px;
        margin:auto;
        padding:20px;
    }

    .logo {
        width:120px;
        margin-top:20px;
    }

    h1 {
        font-size:26px;
        color:#b37500;
        margin-top:10px;
    }

    textarea {
        width:90%;
        height:140px;
        padding:10px;
        font-size:18px;
        border-radius:10px;
        border:1px solid #d0a85c;
        resize:none;
        outline:none;
        font-family:"NotoSansTC";
        background:#fff;
    }

    .btn {
        background:#ffcc66;
        border:none;
        padding:12px 22px;
        border-radius:10px;
        font-size:20px;
        cursor:pointer;
        margin-top:12px;
    }
    .btn:hover { background:#ffdd88; }

    /* ★ 指針向下 */
    #pointer {
        width:0; height:0;
        border-left:18px solid transparent;
        border-right:18px solid transparent;
        border-top:32px solid red;
        margin:auto;
        margin-top:15px;
        position:relative;
        z-index:5;
        transform: translateY(4px);
    }

    #categoryWheel {
        margin-top:10px;
        max-width:300px;
    }

    #resultArea {
        font-size:26px;
        margin-top:16px;
        min-height:2.6em;
        color:#b37500;
    }

    /* 用於抽姓名（分類之後的第二階段） */
    #nameWheel {
        margin-top:10px;
        max-width:300px;
    }
</style>
</head>

<body>
<div class="container">

    <img src="logo3524.png" class="logo" />
    <h1>分類抽籤</h1>

    <!-- ★ 使用者輸入分類名稱（逗號分隔） -->
    <textarea id="categoryInput" placeholder="請輸入各分類名稱，用逗號分隔"></textarea>

    <div>
        <button class="btn" onclick="startCategorySpin()">開始抽分類</button>
        <button class="btn" onclick="goHome()">回首頁</button>
    </div>

    <div id="pointer"></div>

    <!-- ★ 分類輪盤 -->
    <canvas id="categoryWheel" width="300" height="300"></canvas>

    <!-- 抽到分類後，顯示：分類名稱 + 開始抽姓名按鈕 -->
    <div id="resultArea"></div>

</div>
<script>
/* ============================================================
   全域變數
============================================================ */
let categories = [];
let usedCats = [];
let selectedCategory = "";     // ★ 抽到的分類
let names = [];                // ★ 第二階段抽姓名使用
let usedNames = [];            // ★ 姓名不重複

let drumAudio, winAudio;
let audioReady = false;
let isSpinning = false;

/* ============================================================
   Canvas for category wheel
============================================================ */
const canvas = document.getElementById("categoryWheel");
const ctx = canvas.getContext("2d");

/* ============================================================
   初始化
============================================================ */
(function init(){
    initAudio();
    drawCategoryWheel();
})();

/* ============================================================
   音效
============================================================ */
function initAudio(){
    if(audioReady) return;
    drumAudio = new Audio("audio/drum.mp3");
    winAudio  = new Audio("audio/win.mp3");
    audioReady = true;
}

/* ============================================================
   畫分類輪盤
============================================================ */
function drawCategoryWheel(){
    ctx.clearRect(0,0,300,300);

    categories = document.getElementById("categoryInput").value
        .split(",").map(s=>s.trim()).filter(s=>s.length>0);

    const count = categories.length || 1;
    const arc = 2 * Math.PI / count;

    for(let i=0; i<count; i++){
        let angle = i * arc;
        ctx.beginPath();
        ctx.moveTo(150,150);
        ctx.fillStyle = (i%2===0) ? "#ffe6a1" : "#ffcc66";
        ctx.arc(150,150,150,angle,angle+arc);
        ctx.fill();

        /* 分隔線 */
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 2;
        ctx.stroke();

        /* 文字 */
        ctx.save();
        ctx.translate(150,150);
        ctx.rotate(angle + arc/2);
        ctx.textAlign="right";
        ctx.font="bold 18px NotoSansTC";
        ctx.fillStyle="#8a5500";
        ctx.fillText(categories[i] || " ", 135, 8);
        ctx.restore();
    }
}

/* ============================================================
   抽分類（不重複）
============================================================ */
function startCategorySpin(){
    if(isSpinning) return;

    categories = document.getElementById("categoryInput").value
        .split(",").map(s=>s.trim()).filter(s=>s.length>0);

    if(categories.length === 0){
        alert("請先輸入分類名稱");
        return;
    }

    let available = categories.filter(c => !usedCats.includes(c));
    if(available.length === 0){
        alert("所有分類都已抽過！");
        return;
    }

    drumAudio.play().catch(()=>{}); // 姓名/分類抽籤只用 drum.mp3

    isSpinning = true;
    const idx = Math.floor(Math.random() * available.length);
    const winner = available[idx];
    const winnerIdx = categories.indexOf(winner);

    const arc = 2 * Math.PI / categories.length;
    const safe = arc * 0.2;

    const base = winnerIdx * arc + arc/2;
    const targetAngle = base + (Math.random()*safe - safe/2);

    /* ★ 10秒轉動 */
    const totalRotation = targetAngle + Math.PI * 16;
    let startTime = null;
    const duration = 10000;

    function animate(ts){
        if(!startTime) startTime = ts;
        const progress = ts - startTime;
        const ease = Math.pow(progress/duration, 3);
        const current = ease * totalRotation;

        ctx.save();
        ctx.translate(150,150);
        ctx.rotate(current);
        ctx.translate(-150,-150);
        drawCategoryWheel();
        ctx.restore();

        if(progress < duration){
            requestAnimationFrame(animate);
        } else {
            finishCategory(winner);
            isSpinning = false;
        }
    }

    requestAnimationFrame(animate);
}

/* ============================================================
   抽分類後
============================================================ */
function finishCategory(winner){

    selectedCategory = winner;
    usedCats.push(winner);

    document.getElementById("resultArea").innerHTML = `
        抽中分類：<b>${winner}</b><br><br>
        <button class="btn" onclick="inputNames()">開始抽姓名</button>
    `;
}
/* ============================================================
   第二階段：開始抽姓名（在抽完分類後）
============================================================ */
function inputNames(){
    document.getElementById("resultArea").innerHTML = `
        <textarea id="nameInput" placeholder="請輸入本分類的全部姓名，用逗號分隔"></textarea>
        <br>
        <button class="btn" onclick="drawNameWheel(); startNameSpin();">開始抽姓名</button>
    `;
}

/* ============================================================
   姓名輪盤（第二階段）
============================================================ */
function drawNameWheel(){

    const wheelDiv = document.getElementById("resultArea");
    if(!wheelDiv) return;

    /* 建立姓名輪盤（如果不存在） */
    if(!document.getElementById("nameWheel")){
        const c = document.createElement("canvas");
        c.id = "nameWheel";
        c.width = 300;
        c.height = 300;
        c.style.marginTop = "10px";
        wheelDiv.appendChild(c);
    }

    const wheel = document.getElementById("nameWheel");
    const nctx = wheel.getContext("2d");

    nctx.clearRect(0,0,300,300);

    names = document.getElementById("nameInput").value
        .split(",").map(s=>s.trim()).filter(s=>s.length > 0);

    const count = names.length || 1;
    const arc = 2 * Math.PI / count;

    for(let i=0;i<count;i++){
        let angle = i * arc;
        nctx.beginPath();
        nctx.moveTo(150,150);
        nctx.fillStyle = (i%2===0) ? "#ffe6a1" : "#ffcc66";
        nctx.arc(150,150,150,angle,angle+arc);
        nctx.fill();

        /* 分隔線 */
        nctx.strokeStyle = "#fff";
        nctx.lineWidth = 2;
        nctx.stroke();

        /* 姓名文字 */
        nctx.save();
        nctx.translate(150,150);
        nctx.rotate(angle + arc/2);
        nctx.textAlign="right";
        nctx.font="bold 18px NotoSansTC";
        nctx.fillStyle="#8a5500";
        nctx.fillText(names[i] || " ", 135, 8);
        nctx.restore();
    }
}

/* ============================================================
   抽姓名（不重複）
============================================================ */
function startNameSpin(){
    if(isSpinning) return;

    names = document.getElementById("nameInput").value
        .split(",").map(s=>s.trim()).filter(s=>s.length > 0);

    if(names.length === 0){
        alert("請先輸入姓名");
        return;
    }

    let available = names.filter(n => !usedNames.includes(n));
    if(available.length === 0){
        alert("這個分類的所有姓名都已抽過！");
        return;
    }

    drumAudio.play().catch(()=>{});   // 只有抽姓名使用鼓聲

    isSpinning = true;
    const idx = Math.floor(Math.random() * available.length);
    const winner = available[idx];
    const winnerIdx = names.indexOf(winner);

    const arc = 2 * Math.PI / names.length;
    const safe = arc * 0.2;

    const base = winnerIdx * arc + arc/2;
    const targetAngle = base + (Math.random()*safe - safe/2);

    /* ★ 10秒抽轉盤（與 index.html 同步） */
    const totalRotation = targetAngle + Math.PI * 16;
    let startTime = null;
    const duration = 10000;

    const wheel = document.getElementById("nameWheel");
    const nctx = wheel.getContext("2d");

    function animate(ts){
        if(!startTime) startTime = ts;
        const progress = ts - startTime;
        const ease = Math.pow(progress/duration, 3);
        const current = ease * totalRotation;

        nctx.save();
        nctx.translate(150,150);
        nctx.rotate(current);
        nctx.translate(-150,-150);
        drawNameWheel();
        nctx.restore();

        if(progress < duration){
            requestAnimationFrame(animate);
        } else {
            finishCategoryName(winner);
            isSpinning = false;
        }
    }

    requestAnimationFrame(animate);
}

/* ============================================================
   抽姓名結果（第二階段）
============================================================ */
function finishCategoryName(winner){

    usedNames.push(winner);

    document.getElementById("resultArea").innerHTML = `
        抽中：<b>${winner}</b>（分類：${selectedCategory}）<br><br>
        <button class="btn" onclick="drawVerse()">抽紅包祝福經句</button>
    `;
}
/* ============================================================
   抽紅包祝福經句（不重複）
============================================================ */
let usedVerses = [];
const verseTotal = 128;

/* 載入已使用的經句 */
(function loadVerses(){
    let saved = localStorage.getItem("usedVersesAll");
    if(saved) usedVerses = JSON.parse(saved);
})();

function drawVerse(){
    if(usedVerses.length >= verseTotal){
        alert("128 張經句都已抽完，請歸零再開始！");
        return;
    }

    let remaining = [];
    for(let i=1;i<=verseTotal;i++){
        if(!usedVerses.includes(i)) remaining.push(i);
    }

    const v = remaining[Math.floor(Math.random()*remaining.length)];
    usedVerses.push(v);
    localStorage.setItem("usedVersesAll", JSON.stringify(usedVerses));

    const padded = v.toString().padStart(3,"0");

    /* 抽經句才播放勝利聲音 */
    winAudio.play().catch(()=>{});

    /* 特效 */
    celebrate();

    setTimeout(()=>{
        window.location = `viewer.html?no=${padded}`;
    }, 700);
}

/* ============================================================
   煙火 + 金幣效果
============================================================ */
function startFireworks(){
    for(let i=0;i<12;i++){
        setTimeout(()=>{
            let fire = document.createElement("div");
        }, i*150);
    }
}

function startCoins(){
    for(let i=0;i<15;i++){
        setTimeout(()=>{
            let coin = document.createElement("img");
            coin.src = "https://cdn-icons-png.flaticon.com/512/138/138292.png";
            coin.className = "coin";
            coin.style.left = Math.random()*window.innerWidth + "px";
            coin.style.position = "fixed";
            coin.style.top = "-50px";
            coin.style.width = "35px";
            coin.style.animation = "fallCoin 1.2s linear forwards";
            document.body.appendChild(coin);
            setTimeout(()=>coin.remove(),2500);
        }, i*120);
    }
}

function celebrate(){
    startFireworks();
    startCoins();
}

/* ============================================================
   PDF 匯出（含中文字型）
============================================================ */
function exportPDF(){
    const raw = localStorage.getItem("drawLogs") || "[]";
    let logs;
    try { logs = JSON.parse(raw); }
    catch(e){ logs = []; }

    if(!logs.length){
        alert("目前沒有抽籤紀錄可以匯出");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt" });

    /* ★★★ 中文字型載入 ★★★ */
    doc.addFileToVFS("NotoSansTC-Regular.ttf", window.PDF_FONT.normal);
    doc.addFont("NotoSansTC-Regular.ttf", "NotoSansTC", "normal");
    doc.setFont("NotoSansTC");

    doc.setFontSize(18);
    doc.text("BlessingCards128 抽籤紀錄（分類模式）", 40, 40);

    doc.setFontSize(12);
    doc.text("（由系統自動產生）", 40, 60);
    doc.line(40, 70, 555, 70);

    let y = 90;
    const lineHeight = 18;

    logs.forEach(log => {
        const line =
            `[${log.time}] 「${log.name}」 在「${log.category}」中抽到 → ` +
            `${log.verseRef}（${String(log.verseNo).padStart(3,"0")}.png）`;

        const wrapped = doc.splitTextToSize(line, 515);
        wrapped.forEach(part=>{
            if(y > 780){
                doc.addPage();
                doc.setFont("NotoSansTC");
                y = 40;
            }
            doc.text(part, 40, y);
            y += lineHeight;
        });
    });

    doc.save("抽籤紀錄（分類模式）.pdf");
}

/* ============================================================
   返回首頁
============================================================ */
function goHome(){
    window.location = "index.html";
}
</script>

<!-- jsPDF & 字型載入（必須放在最後） -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="font_base64.js"></script>

</body>
</html>
