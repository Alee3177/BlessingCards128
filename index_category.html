<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>分類抽籤 - BlessingCards128</title>

<link rel="stylesheet" href="fonts/fonts.css">

<style>
    body {
        margin:0;
        background:#fff7e6;
        font-family:"NotoSansTC", sans-serif;
        text-align:center;
        color:#8a5500;
    }

    .container {
        max-width:900px;
        margin:auto;
        padding:20px;
    }

    .logo {
        width:120px;
        margin-top:20px;
    }

    h1 {
        font-size:26px;
        color:#b37500;
        margin-top:10px;
    }

    textarea {
        width:90%;
        height:140px;
        padding:10px;
        font-size:18px;
        border-radius:10px;
        border:1px solid #d0a85c;
        resize:none;
        outline:none;
        font-family:"NotoSansTC";
        background:#fff;
    }

    .btn {
        background:#ffcc66;
        border:none;
        padding:12px 22px;
        border-radius:10px;
        font-size:20px;
        cursor:pointer;
        margin-top:12px;
    }
    .btn:hover { background:#ffdd88; }

    #pointer {
        width:0; height:0;
        border-left:18px solid transparent;
        border-right:18px solid transparent;
        border-bottom:32px solid red;
        margin:auto;
        margin-top:15px;
        position:relative;
        z-index:5;
    }

    #categoryWheel {
        margin-top:10px;
        max-width:300px;
    }

    #resultArea {
        font-size:26px;
        margin-top:16px;
        min-height:2.6em;
        color:#b37500;
    }

</style>
</head>

<body>
<div class="container">

    <img src="logo3524.png" class="logo" />
    <h1>分類抽籤</h1>

    <textarea id="categoryInput" placeholder="請輸入各分類名稱，用逗號分隔"></textarea>

    <div>
        <button class="btn" onclick="startCategorySpin()">開始抽分類</button>
        <button class="btn" onclick="goHome()">回首頁</button>
    </div>

    <div id="pointer"></div>
    <canvas id="categoryWheel" width="300" height="300"></canvas>

    <div id="resultArea"></div>

</div>

<script>
/* -----------------------------------------------------------
   全域變數
----------------------------------------------------------- */
let categories = [];
let usedCats = [];

let drumAudio, winAudio;
let audioReady = false;
let isSpinning = false;

/* -----------------------------------------------------------
   Canvas 與 ctx (必須最先宣告)
----------------------------------------------------------- */
const canvas = document.getElementById("categoryWheel");
const ctx = canvas.getContext("2d");

/* -----------------------------------------------------------
   初始化
----------------------------------------------------------- */
(function init(){
    initAudio();
    drawCategoryWheel();    // ctx 已初始化，安全
})();

/* -----------------------------------------------------------
   音效初始化
----------------------------------------------------------- */
function initAudio(){
    if(audioReady) return;
    drumAudio = new Audio("audio/drum.mp3");
    winAudio  = new Audio("audio/win.mp3");
    audioReady=true;
}

/* -----------------------------------------------------------
   畫分類輪盤
----------------------------------------------------------- */
function drawCategoryWheel(){
    ctx.clearRect(0,0,300,300);

    categories = document.getElementById("categoryInput").value
        .split(",")
        .map(s=>s.trim())
        .filter(s=>s.length>0);

    const count = categories.length || 1;
    const arc = 2*Math.PI / count;

    for(let i=0;i<count;i++){
        let angle = i*arc;
        ctx.beginPath();
        ctx.moveTo(150,150);
        ctx.fillStyle = i%2===0 ? "#ffe6a1" : "#ffcc66";
        ctx.arc(150,150,150,angle,angle+arc);
        ctx.fill();

        ctx.save();
        ctx.translate(150,150);
        ctx.rotate(angle + arc/2);
        ctx.textAlign="right";
        ctx.font="bold 18px NotoSansTC";
        ctx.fillStyle="#8a5500";
        ctx.fillText(categories[i] || " ", 135, 8);
        ctx.restore();
    }
}

/* -----------------------------------------------------------
   抽分類
----------------------------------------------------------- */
function startCategorySpin(){
    if(isSpinning) return;

    categories = document.getElementById("categoryInput").value
        .split(",")
        .map(s=>s.trim())
        .filter(s=>s.length>0);

    if(categories.length===0){
        alert("請先輸入分類名稱");
        return;
    }

    let available = categories.filter(n => !usedCats.includes(n));

    if(available.length === 0){
        alert("全部分類都抽過了！");
        return;
    }

    drumAudio.play().catch(()=>{});

    isSpinning=true;
    const idx = Math.floor(Math.random()*available.length);
    const winner = available[idx];
    const winnerIdx = categories.indexOf(winner);

    const arc = 2*Math.PI / categories.length;
    const safe = arc*0.2;

    const base = winnerIdx * arc + arc/2;
    const targetAngle = base + (Math.random()*safe - safe/2);
    const totalRotation = targetAngle + Math.PI*8;

    let startTime=null;
    const duration=3000;

    function animate(ts){
        if(!startTime) startTime=ts;
        const progress = ts - startTime;
        const ease = Math.pow(progress/duration,3);
        const current = ease * totalRotation;

        ctx.save();
        ctx.translate(150,150);
        ctx.rotate(current);
        ctx.translate(-150,-150);
        drawCategoryWheel();
        ctx.restore();

        if(progress < duration){
            requestAnimationFrame(animate);
        } else {
            finishCategory(winner);
            isSpinning=false;
        }
    }

    requestAnimationFrame(animate);
}

/* -----------------------------------------------------------
   抽分類後行為
----------------------------------------------------------- */
function finishCategory(winner){
    winAudio.play().catch(()=>{});

    usedCats.push(winner);

    document.getElementById("resultArea").innerHTML =
        `抽中分類：<b>${winner}</b>`;
}

/* -----------------------------------------------------------
   返回首頁
----------------------------------------------------------- */
function goHome(){
    window.location = "index.html";
}

</script>

</body>
</html>
