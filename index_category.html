<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>BlessingCards128 åˆ†é¡æŠ½ç±¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    background: #fff9e9;
    font-family: "Noto Sans TC", sans-serif;
    text-align: center;
    padding: 20px;
    color: #5a3d00;
}

/* æ¨™é¡Œ */
h1 {
    font-size: 26px;
    margin-bottom: 15px;
    color: #b06b00;
}

/* æŒ‰éˆ• */
.btn {
    background: #f7c86c;
    padding: 12px 22px;
    border-radius: 25px;
    font-size: 18px;
    color: #5a3d00;
    cursor: pointer;
    border: none;
    margin: 8px;
}
.btn:hover { background: #f5b953; }

/* è¼ªç›¤ container */
#wheelContainer {
    position: relative;
    width: 380px;
    height: 380px;
    margin: 20px auto;
}

#wheelCanvas {
    width: 380px;
    height: 380px;
}

/* æŒ‡é‡ â–¼ */
#wheelPointer {
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 38px;
    color: red;
    z-index: 10;
}

/* æ–‡å­—å€ */
#statusText {
    font-size: 20px;
    margin-top: 15px;
    color: #b06b00;
}
</style>
</head>

<body>

<h1>BlessingCards128 åˆ†é¡æŠ½ç±¤</h1>

<button class="btn" onclick="startCategoryDraw()">ğŸ¡ é–‹å§‹æŠ½åˆ†é¡ç¶“å¥</button>
<button class="btn" onclick="goHome()">ğŸ  å›é¦–é </button>
<button class="btn" onclick="exportPDF()">ğŸ“„ æŠ½ç±¤ç´€éŒ„ PDF</button>

<!-- è¼ªç›¤ -->
<div id="wheelContainer">
    <div id="wheelPointer">â–¼</div>
    <canvas id="wheelCanvas" width="380" height="380"></canvas>
</div>

<div id="statusText">æŒ‰ã€Œé–‹å§‹æŠ½åˆ†é¡ç¶“å¥ã€é–‹å§‹æŠ½ç±¤</div>

<script src="verseRefMap.js"></script>

<script>
/* -------------------------
   åˆ†é¡åˆ—è¡¨ï¼ˆä½ å¯ä¿®æ”¹ï¼‰
------------------------- */
const categories = [
    "å¹³å®‰èˆ‡ä¿è­·",
    "ä¾›æ‡‰èˆ‡è±ç››",
    "ä¿¡å¿ƒèˆ‡é †æœ",
    "å–œæ¨‚èˆ‡æ„Ÿæ©",
    "ç¦±å‘Šèˆ‡å€šé ",
    "æ„›èˆ‡é¥’æ•",
    "æ‡‰è¨±èˆ‡ç›¼æœ›",
    "ç¥ç¦èˆ‡æ©å…¸"
];

let usedVerses = JSON.parse(localStorage.getItem("usedVersesAll") || "[]");
let drawLogs   = JSON.parse(localStorage.getItem("drawLogs") || "[]");

let canvas = document.getElementById("wheelCanvas");
let ctx     = canvas.getContext("2d");

let spinning = false;

/* -------------------------
   ç•«è¼ªç›¤
------------------------- */
function drawWheel(items){
    let count = items.length;
    let arc = Math.PI * 2 / count;

    ctx.clearRect(0,0,380,380);

    for (let i = 0; i < count; i++) {
        ctx.beginPath();
        ctx.fillStyle = (i % 2 === 0 ? "#fde7b5" : "#fcdca0");
        ctx.moveTo(190, 190);
        ctx.arc(190, 190, 180, arc * i, arc * (i + 1));
        ctx.fill();

        /* åˆ†éš”ç·š */
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.save();
        ctx.translate(190,190);
        ctx.rotate(arc * i + arc / 2);
        ctx.textAlign = "right";
        ctx.font = "20px Noto Sans TC";
        ctx.fillStyle = "#5a3d00";
        ctx.fillText(items[i], 160, 6);
        ctx.restore();
    }
}

drawWheel(categories);

/* -------------------------
   easing
------------------------- */
function easeOut(t){ return 1 - Math.pow(1 - t, 3); }

/* -------------------------
   è½‰å‹•è¼ªç›¤
------------------------- */
function spinWheel(list){
    return new Promise(resolve => {

        let count = list.length;
        let arc = Math.PI * 2 / count;

        let rotation = Math.random() * Math.PI * 4 + Math.PI * 6; // å¤šåœˆ
        let start = performance.now();

        function animate(now){
            let progress = (now - start) / 5000;
            if (progress >= 1) progress = 1;

            let angle = rotation * easeOut(progress);

            ctx.save();
            ctx.clearRect(0,0,380,380);
            ctx.translate(190,190);
            ctx.rotate(angle);
            ctx.translate(-190,-190);
            drawWheel(list);
            ctx.restore();

            if (progress < 1){
                requestAnimationFrame(animate);
            } else {
                let index = Math.floor((count - (angle % (2*Math.PI)) / arc) % count);
                resolve(list[index]);
            }
        }

        requestAnimationFrame(animate);
    });
}

/* -------------------------
   é–‹å§‹åˆ†é¡æŠ½ç±¤
------------------------- */
async function startCategoryDraw(){
    if (spinning) return;
    spinning = true;

    document.getElementById("statusText").innerText =
        "åˆ†é¡æŠ½ç±¤ä¸­â€¦";

    let category = await spinWheel(categories);

    document.getElementById("statusText").innerText =
        `æŠ½ä¸­åˆ†é¡ï¼šã€Œ${category}ã€`;

    /* ---- ä¾åˆ†é¡æŠ½å‡ºä¸€ç¯€ç¶“æ–‡ ---- */
    await new Promise(r=>setTimeout(r,1500));

    let verseList = Object.keys(VERSE_REF_MAP);
    let available = verseList.filter(v => !usedVerses.includes(v));

    let verse = available[Math.floor(Math.random()*available.length)];
    usedVerses.push(verse);
    localStorage.setItem("usedVersesAll", JSON.stringify(usedVerses));

    let ref = VERSE_REF_MAP[verse];

    document.getElementById("statusText").innerText =
        `æŠ½ä¸­ç¶“å¥ç·¨è™Ÿï¼šã€Œ${verse}ã€\n${ref}`;

    /* ---- è¨˜éŒ„ ---- */
    saveRecord(category, verse);

    await new Promise(r=>setTimeout(r,2000));

    /* ---- è·³ viewer.html ---- */
    window.location =
        `viewer.html?name=${encodeURIComponent(category)}&verse=${verse}`;
    
    spinning = false;
}

/* -------------------------
   å„²å­˜ç´€éŒ„
------------------------- */
function saveRecord(category, verse){
    let now = new Date();
    let ts =
        `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,"0")}/${now.getDate().toString().padStart(2,"0")} `+
        `${now.getHours().toString().padStart(2,"0")}:${now.getMinutes().toString().padStart(2,"0")}:${now.getSeconds().toString().padStart(2,"0")}`;

    drawLogs.push({
        time: ts,
        name: category,
        verseNo: verse
    });

    localStorage.setItem("drawLogs", JSON.stringify(drawLogs));
}

/* -------------------------
   PDF å‡ºåŠ›
------------------------- */
function exportPDF(){
    alert("PDF åŠŸèƒ½èˆ‡ index.html ç›¸åŒï¼Œå°šå¾…ä½ æä¾›å¤–éƒ¨å­—å‹ TTF å¾Œå…¨ç«™å•Ÿç”¨ã€‚");
}

/* -------------------------
   å›é¦–é 
------------------------- */
function goHome(){
    window.location = "index.html";
}
</script>

</body>
</html>
