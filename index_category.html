<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <script src="fonts_base64.js"></script> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blessing Cards 128 - åˆ†é¡æŠ½ç±¤</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #fff7e6; /* é‡‘é»ƒ */
            font-family: "Noto Sans TC", sans-serif;
            color: #8a5500;
        }

        .container {
            max-width: 900px;
            margin: auto;
            padding: 20px;
            text-align: center;
        }

        .logo {
            width: 120px;
            margin-top: 20px;
        }

        h1 {
            margin-top: 10px;
            color: #b37500;
            font-size: 32px;
        }

        select {
            font-size: 20px;
            padding: 8px 12px;
            margin-top: 20px;
            border-radius: 10px;
            border: 1px solid #d2a55c;
            background: #fff3d6;
        }

        button {
            background: #ffcc66;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
            margin-top: 15px;
        }
        button:hover {
            background: #ffdd88;
        }

        .switch-btn {
            background: #ffd27f;
        }

        canvas {
            margin-top: 30px;
            max-width: 300px;
        }

        #result {
            font-size: 26px;
            margin-top: 15px;
        }
    </style>
</head>

<body>
<div class="container">

    <!-- LOGO -->
    <img src="logo3524.png" class="logo" />

    <h1>Blessing Cards 128<br>åˆ†é¡æŠ½ç±¤</h1>

    <!-- è¿”å›æŠ½å§“åæŠ½ç±¤ -->
    <button class="switch-btn" onclick="window.location='index_full.html'">
        â¤ è¿”å›æŠ½å§“åæŠ½ç±¤
    </button>

    <!-- åˆ†é¡é¸å–® -->
    <p style="margin-top:20px; font-size: 20px;">è«‹é¸æ“‡åˆ†é¡ï¼š</p>

    <select id="categorySelect">
        <option value="">-- è«‹é¸æ“‡åˆ†é¡ --</option>
        <option value="å®‰æ…°é¼“å‹µ">å®‰æ…°é¼“å‹µ</option>
        <option value="é†«æ²»æ¢å¾©">é†«æ²»æ¢å¾©</option>
        <option value="ç¥ç¦æ‡‰è¨±">ç¥ç¦æ‡‰è¨±</option>
        <option value="æ™ºæ…§æŒ‡å¼•">æ™ºæ…§æŒ‡å¼•</option>
        <option value="åŠ›é‡ä¿¡å¿ƒ">åŠ›é‡ä¿¡å¿ƒ</option>
        <option value="ç›¼æœ›ç­‰å€™">ç›¼æœ›ç­‰å€™</option>
        <option value="ä¿è­·çœ‹é¡§">ä¿è­·çœ‹é¡§</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
    </select>

    <br>
    <button onclick="startCategoryDraw()">é–‹å§‹æŠ½ç±¤</button>

    <!-- è½‰ç›¤ -->
    <div>
        <canvas id="catWheel" width="300" height="300"></canvas>
        <p id="result"></p>
    </div>
<script>
/* ----------------------------------------------------
   â‘  åˆ†é¡ â†’ ç¶“å¥ç·¨è™Ÿæ¸…å–®ï¼ˆä¾ Excel æœ€çµ‚åˆ†é¡ï¼‰
---------------------------------------------------- */
/*  
   ä½  Excel çš„ã€Œåˆ†é¡æ¬„ã€å…§å®¹å·²çµ±ä¸€æ ¼å¼ï¼Œå› æ­¤åˆ†é¡åˆ†çµ„å¦‚ä¸‹ï¼š

   âœ” å®‰æ…°é¼“å‹µ
   âœ” é†«æ²»æ¢å¾©
   âœ” ç¥ç¦æ‡‰è¨±
   âœ” æ™ºæ…§æŒ‡å¼•
   âœ” åŠ›é‡ä¿¡å¿ƒ
   âœ” ç›¼æœ›ç­‰å€™
   âœ” ä¿è­·çœ‹é¡§
   âœ” å…¶ä»–

   â˜… æ³¨æ„ï¼šä»¥ä¸‹çš„ mapping ç¤ºä¾‹æ˜¯å‡è¨­ç‰ˆã€‚
   â˜… æˆ‘éœ€è¦ä½ æä¾›ã€Œåˆ†é¡ â†’ ç·¨è™Ÿæ¸…å–®ã€ï¼Œæˆ‘æ‰èƒ½æ”¾å…¥æ­£å¼è³‡æ–™ã€‚

   ç›®å‰å…ˆç”¨å ä½è³‡æ–™ï¼ˆä½ å¯ä¸Šå‚³ä½ çš„ EXCELï¼Œæˆ‘å¯è‡ªå‹•ç”ŸæˆçœŸæ­£æ¸…å–®ï¼‰ã€‚
*/

const categoryMap = {
    "å®‰æ…°é¼“å‹µ": [1, 5, 9, 15, 22, 30], 
    "é†«æ²»æ¢å¾©": [2, 6, 10, 18, 28],
    "ç¥ç¦æ‡‰è¨±": [3, 7, 14, 20, 33],
    "æ™ºæ…§æŒ‡å¼•": [4, 8, 12, 25, 40],
    "åŠ›é‡ä¿¡å¿ƒ": [11, 16, 21, 35, 42],
    "ç›¼æœ›ç­‰å€™": [13, 17, 24, 31, 50],
    "ä¿è­·çœ‹é¡§": [19, 23, 26, 32, 60],
    "å…¶ä»–":      [27, 29, 34, 36, 45]
};

/* â˜…â˜…â˜… é‡é»ï¼šä½ åªè¦æŠŠçœŸæ­£çš„æ¸…å–®çµ¦æˆ‘ï¼Œæˆ‘æœƒæ›¿ä½ æ›æ‰ä¸Šé¢é‚£æ®µã€‚ */

/* ----------------------------------------------------
   â‘¡ æ¸…å–®è³‡æ–™å­˜æ”¾
---------------------------------------------------- */
let selectedCategory = "";
let verseList = [];      // è©²åˆ†é¡çš„æ‰€æœ‰ç¶“å¥ç·¨è™Ÿ
let usedCatVerses = [];  // å·²æŠ½éï¼ˆé¿å…é‡è¤‡ï¼‰

/* ----------------------------------------------------
   â‘¢ é»é¸åˆ†é¡å¾Œ â†’ ç”¢ç”Ÿç¶“å¥æ¸…å–®
---------------------------------------------------- */
function prepareCategoryList() {
    selectedCategory = document.getElementById("categorySelect").value;

    if (!selectedCategory) {
        alert("è«‹å…ˆé¸æ“‡åˆ†é¡ï¼");
        return false;
    }

    verseList = categoryMap[selectedCategory] || [];

    if (verseList.length === 0) {
        alert("æ­¤åˆ†é¡æ²’æœ‰ç¶“å¥ï¼");
        return false;
    }

    // å»é™¤é‡è¤‡ & æ’åº
    verseList = [...new Set(verseList)].sort((a,b)=>a-b);

    // è‹¥åˆ†é¡å·²æŠ½å®Œ â†’ é‡ç½®
    if (usedCatVerses.length >= verseList.length) {
        usedCatVerses = [];
    }

    return true;
}
</script>
<script>
/* ----------------------------------------------------
   â‘£ åˆ†é¡è½‰ç›¤ç¹ªè£½
---------------------------------------------------- */
let cCanvas = document.getElementById("catWheel");
let cctx = cCanvas.getContext("2d");

function drawCategoryWheel() {
    if (verseList.length === 0) return;

    let arc = (2 * Math.PI) / verseList.length;
    cctx.clearRect(0,0,300,300);

    for (let i = 0; i < verseList.length; i++) {
        let angle = i * arc;

        cctx.fillStyle = i % 2 === 0 ? "#ffe6a1" : "#ffcc66";
        cctx.beginPath();
        cctx.moveTo(150,150);
        cctx.arc(150,150,150, angle, angle + arc);
        cctx.closePath();
        cctx.fill();

        // ç·¨è™Ÿæ–‡å­—
        cctx.save();
        cctx.translate(150,150);
        cctx.rotate(angle + arc / 2);
        cctx.fillStyle = "#8a5500";
        cctx.font = "bold 18px sans-serif";
        cctx.textAlign = "right";
        cctx.fillText(verseList[i], 135, 8);
        cctx.restore();
    }
}

/* ----------------------------------------------------
   â‘¤ éš¨æ©Ÿå®‰å…¨è§’åº¦ï¼ˆé¿å…è½åœ¨é‚Šç•Œï¼‰
---------------------------------------------------- */
function randomSafeAngleCat() {
    let arc = (2 * Math.PI) / verseList.length;
    let safeOffset = arc * 0.1;

    let idx = Math.floor(Math.random() * verseList.length);
    let angle = idx * arc + arc/2 + (Math.random()*safeOffset - safeOffset/2);

    return { idx, angle };
}

/* ----------------------------------------------------
   â‘¥ é–‹å§‹åˆ†é¡æŠ½ç±¤
---------------------------------------------------- */
let catSpinning = false;

function startCategoryDraw() {
    if (!prepareCategoryList()) return;
    drawCategoryWheel();

    if (catSpinning) return;
    catSpinning = true;

    spinCategoryWheel();
}

/* ----------------------------------------------------
   â‘¦ åˆ†é¡è½‰ç›¤å‹•ç•«
---------------------------------------------------- */
function spinCategoryWheel() {
    let { idx, angle } = randomSafeAngleCat();

    // é¿å…é‡è¤‡æŠ½ç±¤
    while (usedCatVerses.includes(verseList[idx])) {
        let tmp = randomSafeAngleCat();
        idx = tmp.idx;
        angle = tmp.angle;
    }

    let chosen = verseList[idx];
    usedCatVerses.push(chosen);

    let totalRot = angle + Math.PI * 10;
    let duration = 3300;
    let start = null;

    function animate(ts) {
        if (!start) start = ts;
        let progress = ts - start;

        let ease = Math.pow(progress / duration, 3);
        let current = ease * totalRot;

        cctx.save();
        cctx.translate(150,150);
        cctx.rotate(current);
        cctx.translate(-150,-150);

        drawCategoryWheel();
        cctx.restore();

        if (progress < duration) {
            requestAnimationFrame(animate);
        } else {
            finishCategoryDraw(chosen);
            catSpinning = false;
        }
    }

    requestAnimationFrame(animate);
}

/* ----------------------------------------------------
   â‘§ åˆ†é¡æŠ½ç±¤å®Œæˆ â†’ é¡¯ç¤ºçµæœ
---------------------------------------------------- */
function finishCategoryDraw(no) {
    let padded = no.toString().padStart(3,"0");

    document.getElementById("result").innerHTML =
        `æŠ½ä¸­ç¶“å¥ï¼š<b>${padded}</b>`;

    document.getElementById("result").style.animation = "pop 0.5s";

    // 0.5ç§’ä¹‹å¾Œè·³ viewer
    setTimeout(()=>{
        window.location = `viewer.html?no=${padded}`;
    },600);
}
</script>
<!-- ----------------------------------------------------
     ğŸ† ç…™ç«å‹•ç•« (Canvas Fireworks)
---------------------------------------------------- -->
<canvas id="fireCatCanvas"
        style="position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none;">
</canvas>

<script>
let fw2 = document.getElementById("fireCatCanvas");
let fw2ctx = fw2.getContext("2d");

function resizeFW2() {
    fw2.width = window.innerWidth;
    fw2.height = window.innerHeight;
}
resizeFW2();
window.addEventListener("resize", resizeFW2);

let fireworks2 = [];

function launchFW2() {
    let x = Math.random() * fw2.width;
    let y = Math.random() * fw2.height * 0.5;

    fireworks2.push({
        x, y, radius: 2,
        color: `hsl(${Math.random()*360}, 100%, 60%)`,
        life: 30 + Math.random()*20
    });
}

function drawFW2() {
    fw2ctx.clearRect(0,0,fw2.width,fw2.height);

    fireworks2.forEach((fw,i)=>{
        fw2ctx.beginPath();
        fw2ctx.arc(fw.x, fw.y, fw.radius, 0, Math.PI * 2);
        fw2ctx.fillStyle = fw.color;
        fw2ctx.fill();

        fw.radius += 2;
        fw.life--;

        if (fw.life <= 0) fireworks2.splice(i,1);
    });

    requestAnimationFrame(drawFW2);
}
drawFW2();

/* è§¸ç™¼ç…™ç« */
function startFireworks2() {
    for (let i = 0; i < 12; i++) {
        setTimeout(launchFW2, i * 150);
    }
}
</script>

<!-- ----------------------------------------------------
     ğŸª™ é‡‘å¹£æ‰è½å‹•ç•« (Coins)
---------------------------------------------------- -->
<style>
.coin {
    position: fixed;
    top: -50px;
    width: 35px;
    pointer-events: none;
    animation: fallCoin linear forwards;
}

@keyframes fallCoin {
    from { transform: translateY(-50px); opacity: 1; }
    to   { transform: translateY(100vh); opacity: 0; }
}
</style>

<script>
function startCoins2() {
    for (let i = 0; i < 15; i++) {
        setTimeout(()=>{
            let coin = document.createElement("img");
            coin.src = "https://cdn-icons-png.flaticon.com/512/138/138292.png";
            coin.classList.add("coin");
            coin.style.left = Math.random()*window.innerWidth + "px";
            coin.style.animationDuration = (1.5+Math.random()) + "s";
            document.body.appendChild(coin);

            setTimeout(()=>coin.remove(), 2500);
        }, i*120);
    }
}

/* æ•´åˆæ…¶ç¥å‹•ç•« */
function celebrate2() {
    startFireworks2();
    startCoins2();
}
</script>

<!-- ----------------------------------------------------
     ğŸ‰ åŒ¯å…¥æ…¶ç¥å‹•ç•«åˆ°æŠ½ç±¤æµç¨‹
---------------------------------------------------- -->
<script>
/* è¦†å¯« finishCategoryDraw() */
function finishCategoryDraw(no) {
    let padded = no.toString().padStart(3,"0");

    document.getElementById("result").innerHTML =
        `æŠ½ä¸­ç¶“å¥ï¼š<b>${padded}</b>`;
    document.getElementById("result").style.animation = "pop 0.5s";

    celebrate2(); // â˜… æŠ½åˆ†é¡é€²è¡Œæ…¶ç¥å‹•ç•«

    setTimeout(()=>{
        window.location = `viewer.html?no=${padded}`;
    },600);
}
</script>

<!-- ----------------------------------------------------
     é é¢çµå°¾
---------------------------------------------------- -->
</div>
</body>
</html>
