<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>分類抽籤 - BlessingCards128</title>

<link rel="stylesheet" href="fonts/fonts.css">

<style>
    body{
        margin:0;
        background:#fff7e6;
        font-family:"NotoSansTC", sans-serif;
        text-align:center;
        color:#8a5500;
    }

    .container{
        max-width:900px;
        margin:auto;
        padding:20px;
    }

    .logo{
        width:120px;
        margin-top:20px;
    }

    h1{
        font-size:26px;
        color:#b37500;
        margin-top:10px;
    }

    textarea{
        width:90%;
        height:120px;
        padding:10px;
        font-size:18px;
        border-radius:10px;
        border:1px solid #d0a85c;
        resize:none;
        outline:none;
        font-family:"NotoSansTC";
        background:#fff;
    }

    .btn{
        background:#ffcc66;
        border:none;
        padding:12px 22px;
        border-radius:10px;
        font-size:20px;
        cursor:pointer;
        margin-top:12px;
    }
    .btn:hover{
        background:#ffdd88;
    }

    /* 指針向下 */
    #pointer{
        width:0;height:0;
        border-left:18px solid transparent;
        border-right:18px solid transparent;
        border-top:32px solid red;
        margin:auto;
        margin-top:15px;
        position:relative;
        z-index:5;
        transform:translateY(4px);
    }

    #wheel{
        margin-top:10px;
        max-width:300px;
    }

    #resultArea{
        font-size:26px;
        margin-top:16px;
        min-height:2.6em;
        color:#b37500;
    }

    .coin{
        position:fixed;
        top:-50px;
        width:35px;
        animation:fallCoin linear forwards;
        pointer-events:none;
    }

    @keyframes fallCoin{
        from{transform:translateY(-50px); opacity:1;}
        to{transform:translateY(100vh); opacity:0;}
    }
</style>
</head>

<body>
<div class="container">

    <img src="logo3524.png" class="logo">
    <h1>分類抽籤</h1>

    <!-- 下拉分類選單 -->
    <div style="margin-top:10px;">
        <label>選擇分類：</label>
        <select id="categorySelect" style="font-size:20px;padding:6px 10px;">
        </select>
    </div>

    <div>
        <button class="btn" onclick="startNameSpin()">開始抽姓名</button>
        <button class="btn" onclick="goHome()">回首頁</button>
    </div>

    <div id="pointer"></div>
    <canvas id="wheel" width="300" height="300"></canvas>

    <div id="resultArea"></div>

    <button class="btn" onclick="exportPDF()">抽籤紀錄 PDF</button>

    <!-- 煙火 -->
    <canvas id="fwCanvas" style="position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;"></canvas>

</div>

<script>
/* -------------------- */
/* Canvas 初始化         */
/* -------------------- */
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");

/* -------------------- */
/* 全域變數              */
/* -------------------- */
let names = [];
let usedNames = [];

let usedVerses = [];
let isSpinning = false;

let drumAudio, winAudio;
let audioReady = false;

const verseTotal = 128;

/* 128 筆分類資料 → 依你提供的表 */
const verseCategory = {
    1:"平安與保護",2:"其他",3:"盼望與力量",4:"恩典與憐憫",5:"平安與保護",
    6:"供應與豐盛",7:"其他",8:"其他",9:"盼望與力量",10:"盼望與力量",
    11:"平安與保護",12:"盼望與力量",13:"平安與保護",14:"其他",15:"平安與保護",
    16:"其他",17:"其他",18:"平安與保護",19:"平安與保護",20:"平安與保護",
    21:"喜樂與感恩",22:"平安與保護",23:"信心與順服",24:"智慧與引導",
    25:"平安與保護",26:"智慧與引導",27:"智慧與引導",28:"恩典與憐憫",
    29:"喜樂與感恩",30:"平安與保護",31:"平安與保護",32:"盼望與力量",
    33:"平安與保護",34:"信心與順服",35:"盼望與力量",36:"盼望與力量",
    37:"恩典與憐憫",38:"恩典與憐憫",39:"信心與順服",40:"信心與順服",
    41:"智慧與引導",42:"其他",43:"喜樂與感恩",44:"喜樂與感恩",
    45:"恩典與憐憫",46:"其他",47:"信心與順服",48:"其他",49:"盼望與力量",
    50:"盼望與力量",51:"平安與保護",52:"其他",53:"恩典與憐憫",
    54:"恩典與憐憫",55:"平安與保護",56:"平安與保護",57:"其他",58:"恩典與憐憫",
    59:"恩典與憐憫",60:"信心與順服",61:"信心與順服",62:"其他",63:"信心與順服",
    64:"平安與保護",65:"喜樂與感恩",66:"其他",67:"其他",68:"平安與保護",
    69:"信心與順服",70:"其他",71:"其他",72:"其他",73:"其他",74:"其他",
    75:"盼望與力量",76:"恩典與憐憫",77:"平安與保護",78:"信心與順服",
    79:"平安與保護",80:"平安與保護",81:"智慧與引導",82:"其他",
    83:"平安與保護",84:"其他",85:"喜樂與感恩",86:"其他",87:"其他",
    88:"信心與順服",89:"其他",90:"其他",91:"其他",92:"其他",93:"其他",
    94:"其他",95:"其他",96:"智慧與引導",97:"盼望與力量",98:"其他",
    99:"平安與保護",100:"其他",101:"其他",102:"其他",103:"其他",104:"其他",
    105:"信心與順服",106:"其他",107:"平安與保護",108:"其他",109:"平安與保護",
    110:"智慧與引導",111:"其他",112:"其他",113:"其他",114:"恩典與憐憫",
    115:"其他",116:"平安與保護",117:"其他",118:"盼望與力量",119:"供應與豐盛",
    120:"供應與豐盛",121:"喜樂與感恩",122:"其他",123:"盼望與力量",
    124:"其他",125:"其他",126:"其他",127:"其他",128:"其他"
};

/* 自動統計分類筆數 → 組成下拉選單 */
const categoryCount = {};
Object.values(verseCategory).forEach(cat=>{
    categoryCount[cat] = (categoryCount[cat]||0)+1;
});

const categorySelect = document.getElementById("categorySelect");
Object.keys(categoryCount).forEach(cat=>{
    let opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = `${cat}（共 ${categoryCount[cat]} 節）`;
    categorySelect.appendChild(opt);
});

/* ------------------- */
/* Audio 初始化         */
/* ------------------- */
function initAudio(){
    if(audioReady) return;
    drumAudio = new Audio("audio/drum.mp3");
    winAudio  = new Audio("audio/win.mp3");
    audioReady=true;
}
initAudio();

/* ------------------- */
/* 輪盤繪製             */
/* ------------------- */
function drawWheel(list){
    ctx.clearRect(0,0,300,300);

    let count = list.length || 1;
    let arc = 2*Math.PI / count;

    for(let i=0;i<count;i++){
        let angle = i*arc;

        ctx.beginPath();
        ctx.moveTo(150,150);
        ctx.fillStyle = (i%2===0) ? "#ffe6a1" : "#ffcc66";
        ctx.arc(150,150,150,angle,angle+arc);
        ctx.fill();

        ctx.save();
        ctx.translate(150,150);
        ctx.rotate(angle + arc/2);
        ctx.textAlign="right";
        ctx.font="bold 18px NotoSansTC";
        ctx.fillStyle="#8a5500";
        ctx.fillText(list[i] || " ",135,8);
        ctx.restore();
    }
}

/* ------------------- */
/* 抽姓名（分類模式）    */
/* ------------------- */
function startNameSpin(){
    if(isSpinning) return;

    let selected = categorySelect.value;
    if(!selected){
        alert("請選擇分類");
        return;
    }

    // 從使用者輸入取得全部姓名
    names = document.getElementById("categorySelect").value;
    names = document.getElementById("nameInput") ?
        document.getElementById("nameInput").value.split(",").map(s=>s.trim()).filter(s=>s)
        : [];

    if(names.length===0){
        alert("請先輸入姓名（回首頁輸入）");
        return;
    }

    let available = names.filter(n => !usedNames.includes(n));
    if(available.length===0){
        alert("全部姓名已抽過！");
        return;
    }

    drawWheel(names);
    drumAudio.play().catch(()=>{});
    isSpinning=true;

    let count = names.length;
    let arc = 2*Math.PI / count;

    let winner = available[Math.floor(Math.random()*available.length)];
    let idx = names.indexOf(winner);

    let mid = idx*arc + arc/2;
    let totalRotation = mid + Math.PI*8;

    let start = null;
    let duration = 10000;

    function anim(ts){
        if(!start) start = ts;
        let p = (ts-start)/duration;
        if(p>1) p=1;

        let ease = Math.pow(p,3);
        let ang = ease*totalRotation;

        ctx.save();
        ctx.translate(150,150);
        ctx.rotate(ang);
        ctx.translate(-150,-150);
        drawWheel(names);
        ctx.restore();

        if(p<1){
            requestAnimationFrame(anim);
        }else{
            finishName(winner, selected);
            isSpinning=false;
        }
    }

    requestAnimationFrame(anim);
}

/* ------------------- */
/* 抽完姓名 → 顯示按鈕   */
/* ------------------- */
function finishName(winner, cat){
    usedNames.push(winner);

    document.getElementById("resultArea").innerHTML =
        `抽中姓名：<b>${winner}</b><br><br>
         <button class="btn" onclick="drawVerse('${winner}','${cat}')">抽紅包祝福經句</button>`;
}

/* ------------------- */
/* 抽經句（分類模式）    */
/* ------------------- */
let drawLogs = [];
(function(){
    let raw = localStorage.getItem("drawLogs");
    if(raw){
        try{ drawLogs = JSON.parse(raw); }
        catch(e){ drawLogs=[]; }
    }
})();

let savedV = localStorage.getItem("usedVersesAll");
if(savedV){
    try{ usedVerses = JSON.parse(savedV); }
    catch(e){ usedVerses = []; }
}

function drawVerse(winner, selectedCat){
    if(usedVerses.length>=verseTotal){
        alert("經句 128 張已抽完！");
        return;
    }

    // 從該分類挑選剩下的經句
    let pool=[];
    for(let i=1;i<=128;i++){
        if(verseCategory[i]===selectedCat && !usedVerses.includes(i))
            pool.push(i);
    }

    if(pool.length===0){
        alert("此分類已抽完全部經句！");
        return;
    }

    let v = pool[Math.floor(Math.random()*pool.length)];
    usedVerses.push(v);
    localStorage.setItem("usedVersesAll",JSON.stringify(usedVerses));

    let log = {
        time:new Date().toLocaleString(),
        name:winner,
        category:selectedCat,
        verseNo:v,
        verseRef:"-"
    };
    drawLogs.push(log);
    localStorage.setItem("drawLogs",JSON.stringify(drawLogs));

    winAudio.play().catch(()=>{});
    celebrate();

    let padded=v.toString().padStart(3,"0");
    setTimeout(()=>window.location=`viewer.html?no=${padded}`,700);
}

/* ------------------- */
/* 亮片與煙火            */
/* ------------------- */
let fwCanvas=document.getElementById("fwCanvas");
let fwCtx=fwCanvas.getContext("2d");

function resizeFW(){
    fwCanvas.width=window.innerWidth;
    fwCanvas.height=window.innerHeight;
}
resizeFW();
window.addEventListener("resize",resizeFW);

let fireArr=[];
function launchFire(){
    fireArr.push({
        x:Math.random()*fwCanvas.width,
        y:Math.random()*fwCanvas.height*0.5,
        r:2,
        c:`hsl(${Math.random()*360},100%,60%)`,
        life:30+Math.random()*20
    });
}
function drawFire(){
    fwCtx.clearRect(0,0,fwCanvas.width,fwCanvas.height);
    for(let i=fireArr.length-1;i>=0;i--){
        let f=fireArr[i];
        fwCtx.beginPath();
        fwCtx.arc(f.x,f.y,f.r,0,Math.PI*2);
        fwCtx.fillStyle=f.c;
        fwCtx.fill();
        f.r+=2;
        f.life--;
        if(f.life<=0) fireArr.splice(i,1);
    }
    requestAnimationFrame(drawFire);
}
drawFire();

function celebrate(){
    for(let i=0;i<12;i++) setTimeout(launchFire,i*150);
    for(let i=0;i<15;i++){
        setTimeout(()=>{
            let coin=document.createElement("img");
            coin.src="https://cdn-icons-png.flaticon.com/512/138/138292.png";
            coin.className="coin";
            coin.style.left=Math.random()*window.innerWidth+"px";
            coin.style.animationDuration=(1.2+Math.random())+"s";
            document.body.appendChild(coin);
            setTimeout(()=>coin.remove(),2500);
        },i*120);
    }
}

/* ------------------- */
/* PDF 匯出              */
/* ------------------- */
function exportPDF(){
    let raw=localStorage.getItem("drawLogs")||"[]";
    let logs;
    try{ logs=JSON.parse(raw);}catch(e){logs=[];}

    if(!logs.length){
        alert("目前沒有任何抽籤紀錄可以匯出。");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"pt"});

    doc.addFileToVFS("NotoSansTC.ttf", PDF_FONT.normal);
    doc.addFont("NotoSansTC.ttf","NotoSansTC","normal");
    doc.setFont("NotoSansTC");

    doc.setFontSize(16);
    doc.text("BlessingCards128 抽籤紀錄",40,40);
    doc.setFontSize(12);
    doc.text("(由系統自動產生)",40,60);

    let y=90,lineH=18;
    logs.forEach(l=>{
        let str=`[${l.time}] 「${l.name}」 在「${l.category}」中抽到 → 紅包經句 ${String(l.verseNo).padStart(3,"0")}`;
        if(y>780){doc.addPage(); y=40;}
        doc.text(str,40,y);
        y+=lineH;
    });

    doc.save("抽籤紀錄.pdf");
}

/* ------------------- */
/* 回首頁                */
/* ------------------- */
function goHome(){
    window.location="index.html";
}
</script>

<!-- PDF + 字型 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="font_base64.js"></script>

</body>
</html>
