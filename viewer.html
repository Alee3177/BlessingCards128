<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç¥ç¦ç¶“å¥ç´…åŒ…</title>

<style>
body{
  font-family:"Noto Sans TC",system-ui;
  background:#fbf2df;
  text-align:center;
  margin:0;
  padding:16px;
  color:#5b3a00;
}

/* é¡¯ç¤ºæ¨™é¡Œå€åŸŸ */
#infoBox{
  font-size:18px;
  white-space:pre-line;
  margin-bottom:10px;
}

/* ç¶“å¥åœ–ç‰‡ï¼ˆå«é‡‘é‚Šï¼‰ */
#imgVerse{
  /* è‡ªå‹•é©æ‡‰è£ç½®å°ºå¯¸ï¼ˆæ¡Œæ©Ÿ / æ‰‹æ©Ÿï¼‰ */
  width: min(98vw, 720px);   /* åŸæœ¬ 520px â†’ æ”¾å¤§ç´„ 30% */
  max-height: 92vh;         /* åŸæœ¬ 72vh â†’ æ”¾å¤§é¡¯ç¤ºé«˜åº¦ */
  object-fit: contain;      /* â† é—œéµ: å®Œæ•´é¡¯ç¤ºã€ä¸è£åˆ‡ */
  border-radius:18px;
  display:block;
  margin:16px auto;
  border:6px solid gold;
}

/* é‡‘é‚Šç™¼å…‰ï¼‹å½ˆè·³ */
@keyframes glow{
  0%{ box-shadow:0 0 10px gold; }
  50%{ box-shadow:0 0 32px gold; }
  100%{ box-shadow:0 0 10px gold; }
}
@keyframes jump{
  0%{ transform:scale(.8); opacity:.2; }
  40%{ transform:scale(1.05); opacity:1;}
  80%{ transform:scale(1.0);}
  100%{ transform:scale(1.0);}
}
.animate{
  animation:glow 2.2s infinite, jump 1.2s ease-out;
}

/* æŒ‰éˆ•æ¨£å¼èˆ‡ index ä¸€è‡´ */
.btn{
  min-width:110px;
  padding:8px 16px;
  border-radius:999px;
  border:none;
  background:#f4b63a;
  color:#5b3a00;
  font-size:15px;
  font-weight:600;
  box-shadow:0 3px 0 #d59b25;
  cursor:pointer;
  margin:10px 6px 0 6px;
}
.btn:disabled{
  background:#f0ddaa;
  cursor:default;
}

/* æŠ½ç±¤ç´€éŒ„æ¡† */
#recordBox{
  margin-top:18px;
  max-width:560px;
  margin-left:auto;
  margin-right:auto;
  text-align:left;
  padding:10px 12px;
  border-radius:12px;
  background:#ffffff;
  box-shadow:0 0 10px rgba(0,0,0,.15);
  font-size:14px;
}

/* å½©å¸¶ï¼‹é‡‘ç²‰ç•«å¸ƒï¼ˆå…¨ç•«é¢ï¼‰ */
#fxCanvas{
  position:fixed;
  left:0;
  top:0;
  width:100%;
  height:100%;
  pointer-events:none;
}

#loading{
  margin: 12px 0;
  font-size: 15px;
  color: #8a5a00;
}

/* ğŸ“± æ‰‹æ©Ÿå°ˆç”¨æ”¾å¤§æ¨¡å¼ */
@media (max-width: 768px) {
  #imgVerse{
    width: 98vw;
    max-height: 90vh;
  }
}

</style>

<script src="verseRefMap.js?v=20260105"></script>

<!-- PATCH-2ï¼šç…™ç« / å½©å¸¶ï¼ˆcanvas-confettiï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

</head>

<body>

<h2>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h2>

<div id="infoBox"></div>

<canvas id="fxCanvas"></canvas>

<!-- âœ… æ–°å¢ï¼šåœ–ç‰‡è¼‰å…¥æç¤º -->
<div id="loading">ç¶“å¥åœ–ç‰‡è¼‰å…¥ä¸­â€¦â€¦</div>

<img id="imgVerse" src="" alt="ç¶“å¥åœ–ç‰‡è¼‰å…¥ä¸­â€¦â€¦">

<div>
  <button id="btnDownload" class="btn">ä¸‹è¼‰ç¶“å¥åœ–ç‰‡</button>
  <button id="btnNext" class="btn">ä¸‹ä¸€ä½</button>
</div>

<div id="recordBox">
  <b>ğŸ“œ æŠ½ç±¤ç´€éŒ„</b>
  <div id="logText"></div>
</div>

<script>

/* ==== ä¸»æ§æ——æ¨™ ==== */
const IS_MASTER = false;

// =============================
// ğŸ“± Viewer éŸ³æ•ˆè§£é–ï¼ˆä¿éšªæ©Ÿåˆ¶ï¼‰
// =============================
// =============================
// ğŸ“± Viewer éŸ³æ•ˆè§£é–ï¼ˆå”¯ä¸€ä¸€æ¬¡ï½œä¿å‘½ç‰ˆï¼‰
// =============================
let viewerAudioUnlocked = false;
function viewerUnlockAudioOnce(){
  if (viewerAudioUnlocked) return;
  viewerAudioUnlocked = true;
  try {
    const a1 = document.getElementById("drum");
    const a2 = document.getElementById("winSound");
    [a1, a2].forEach(a => {
      if (!a) return;
      a.muted = true;
      a.play().then(() => {
        a.pause();
        a.currentTime = 0;
        a.muted = false;
      }).catch(()=>{});
    });
    console.log("ğŸ”“ viewer audio unlocked");
  } catch(e){
    console.warn("viewer unlockAudio failed", e);
  }
}
document.addEventListener("pointerdown", viewerUnlockAudioOnce, { once:true, capture:true });
document.addEventListener("touchstart",  viewerUnlockAudioOnce, { once:true, capture:true });
document.addEventListener("click",       viewerUnlockAudioOnce, { once:true, capture:true });

// ==== viewer åœ–ç‰‡ä¸‹è¼‰é˜²é‡è¤‡ç‹€æ…‹ ====
let imageDownloadedThisView = false;
let imageRepeatCount = 0;
let lastVerseNo = null; // âœ… è¨˜ä½ç›®å‰é¡¯ç¤ºçš„ç¶“å¥ç·¨è™Ÿï¼Œé˜²æ­¢è·¨ç¶“å¥èª¤åˆ¤é‡è¤‡ä¸‹è¼‰
let downloading = false; // âœ… é˜²æ­¢é€£çºŒç‹‚é»ä¸‹è¼‰

// =============================
// ğŸ‘¥ Viewer å¿ƒè·³å›å ±ä¸»æŒæ©Ÿ
// =============================
const VIEWER_KEY = "BLESSING_VIEWERS";
const VIEWER_ID = Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,6);
const VIEWER_TTL = 30000; // 30 ç§’å­˜æ´»

function heartbeatViewer() {
  const now = Date.now();
  let viewers = {};

  try {
    viewers = JSON.parse(localStorage.getItem(VIEWER_KEY) || "{}");
  } catch {
    viewers = {};
  }

  viewers[VIEWER_ID] = now;
  localStorage.setItem(VIEWER_KEY, JSON.stringify(viewers));
}

// =============================
// ğŸ‘¥ Viewer å¿ƒè·³æ’ç¨‹ï¼ˆç©©å®šç‰ˆ PATCH Fï¼‰
// =============================

// ä¿è­‰åªæœƒæœ‰ä¸€å€‹å¿ƒè·³è¨ˆæ™‚å™¨
if (window.__viewerHeartbeatTimer) {
  clearInterval(window.__viewerHeartbeatTimer);
}

// ç«‹å³å ±åˆ°ä¸€æ¬¡
heartbeatViewer();

// æ¯ 5 ç§’å ±åˆ°ä¸€æ¬¡
window.__viewerHeartbeatTimer = setInterval(heartbeatViewer, 5000);

// åˆ†é é—œé–‰ / åˆ‡èƒŒæ™¯ â†’ ä¸»å‹•ä¸‹ç·š
window.addEventListener("pagehide", () => {
  try {
    const KEY = "BLESSING_VIEWERS";
    const viewers = JSON.parse(localStorage.getItem(KEY) || "{}");
    delete viewers[VIEWER_ID];
    localStorage.setItem(KEY, JSON.stringify(viewers));
  } catch {}
});

// æ‰‹æ©Ÿé–å± / åˆ‡å›å‰æ™¯ â†’ ç«‹åˆ»è£œä¸€æ¬¡å¿ƒè·³
document.addEventListener("visibilitychange", () => {
  if (!document.hidden) {
    heartbeatViewer();
  }
});

// =============================
// ğŸ”’ é˜²ä½œå¼Šï¼ˆå®‰å…¨ç‰ˆï¼‰
// =============================
(function lockInputCheat(){
  document.addEventListener("keydown", function(e) {
    // âœ… å…è¨±ç³»çµ±å¿«æ·éµ / ä¸‹è¼‰
    if (
      e.ctrlKey || e.metaKey || e.altKey ||
      e.key === "F5" || e.key === "Escape" || e.key === "Tab" ||
      e.key === "F12" ||
      (e.ctrlKey && e.shiftKey && ["I","J","C"].includes((e.key||"").toUpperCase()))
    ) {
      return;
    }

    // âœ… ä¸å¹²æ“¾æŒ‰éˆ•ï¼ˆEnter/Spaceï¼‰
    if (e.key === "Enter" || e.key === " ") return;

    e.preventDefault();
  }, true);

  document.addEventListener("contextmenu", function(e) {
    e.preventDefault();
  }, true);
})();

const ENABLE_DUN_SOUND = false;   // â† æ”¹æˆ true å°±å…¨éƒ¨æ¢å¾©

// â­ æ–°å¢ï¼šé€²å ´éŸ³æ•ˆé¸æ“‡
// å¯é¸ï¼š"dun" | "dun1" | "dun2"
const DUN_SOUND_VARIANT = "dun";   // â† æ”¹é€™ä¸€è¡Œå°±å¥½

/* å–å¾— URL åƒæ•¸ */
function getParam(n){
  const u = new URL(window.location.href);
  return u.searchParams.get(n);
}

// =============================
// ğŸ›¡ Viewer é¡¯ç¤ºä¿å‘½æ©Ÿåˆ¶ï¼ˆé˜²é–ƒ / é˜²é‡åˆ·ï¼‰
// =============================
let currentShownVerse = null;

function showVerseSafe(verse, ref) {
  if (!verse) return;

  // ğŸ”’ åŒä¸€å¼µåœ–å°±ä¸é‡åˆ·
  if (currentShownVerse === verse) return;
  currentShownVerse = verse;

  const img = document.getElementById("imgVerse");
  if (!img) return;

  // é‡ç½® onload ä¿éšªé–
  delete img.dataset.loaded;

  const src = "cards/" + verse + ".png";

// ğŸ”’ å¦‚æœç›®å‰é¡¯ç¤ºçš„å°±æ˜¯é€™ä¸€å¼µï¼Œä¸é‡åˆ·ï¼ˆé˜²é–ƒçˆï¼‰
if (img.src && img.src.includes(verse + ".png")) return;

  img.src = src;

  // æ›´æ–°æ¨™é¡Œè³‡è¨Š
  const infoBox = document.getElementById("infoBox");
  if (infoBox) {
    infoBox.textContent =
      `æŠ½ä¸­çš„ç¶“å¥ç´…åŒ…\nğŸ“œ ${verse}ï½œğŸ“– ${ref || ""}`;
  }
}

// ===== ç¶“å¥ç·¨è™Ÿï¼ˆURL â†’ ä¸»æŒæ©ŸåŒæ­¥ä¿å‘½ï¼‰=====
let verseNo = getParam("no");

// ğŸ›Ÿ å¦‚æœç¶²å€æ²’å¸¶ noï¼Œå°±å¾ä¸»æŒæ©ŸåŒæ­¥æ‹¿
if (!verseNo) {
  try {
    const raw = localStorage.getItem("LAST_VERSE");
    if (raw) {
      const data = JSON.parse(raw);
      verseNo = data.verse;
    }
  } catch (e) {
    console.warn("LAST_VERSE parse failed", e);
  }
}

// ===== ä½¿ç”¨è€…åç¨± =====
const userName = getParam("name") || "";

// ğŸ§  é è¼‰ç´…åŒ…åœ–ç‰‡ï¼Œé¿å…é¡¯ç¤ºå»¶é²
const preload = new Image();
preload.src = "cards/" + verseNo + ".png";

/*======== æ‰¾å‡ºæ›¸å·ï¼‹ç« ç¯€ï¼ˆç”¨ VERSE_REF_MAPï¼‰ ========*/
let refText = "";
if (window.VERSE_REF_MAP && window.VERSE_REF_MAP[verseNo]) {
  refText = window.VERSE_REF_MAP[verseNo];
}

/*======== ä¸Šæ–¹å…©è¡Œé¡¯ç¤º ========*/
document.getElementById("infoBox").textContent =
`ã€Œ${userName}ã€ï½œæŠ½ä¸­çš„ç¶“å¥ç´…åŒ…
ğŸ“œ ç¶“å¥ç·¨è™Ÿ: ${verseNo}ï½œğŸ“– ${refText}`;

/*======== å½©å¸¶ï¼‹é‡‘ç²‰ç‰¹æ•ˆ ========*/
const fxCanvas = document.getElementById("fxCanvas");
const fxCtx = fxCanvas.getContext("2d");

function resizeFx(){
  fxCanvas.width = window.innerWidth;
  fxCanvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeFx);
resizeFx();

function launchFx(){
  const pieces=[];
  const dots=[];
  const colors=["#ffd54f","#ffb300","#ffca28","#ffe082","#fff8e1"];

  for(let i=0;i<150;i++){
    pieces.push({
      x:Math.random()*fxCanvas.width,
      y:Math.random()*-80,
      w:6+Math.random()*6,
      h:12+Math.random()*10,
      vx:-1+Math.random()*2,
      vy:2+Math.random()*3,
      r:Math.random()*Math.PI,
      vr:(Math.random()-0.5)*0.25,
      color:colors[Math.floor(Math.random()*colors.length)]
    });
  }
  for(let i=0;i<90;i++){
    dots.push({
      x:fxCanvas.width/2 + (Math.random()-0.5)*260,
      y:fxCanvas.height/2 + (Math.random()-0.5)*120,
      r:1+Math.random()*2.8,
      vy:-0.3-Math.random()*0.6,
      alpha:0.9,
      va:-0.012-Math.random()*0.02
    });
  }

  const start=performance.now();
  const duration=2000;

  function frame(now){
    const t = now-start;
    fxCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height);

    pieces.forEach(p=>{
      p.x+=p.vx;
      p.y+=p.vy;
      p.r+=p.vr;
      fxCtx.save();
      fxCtx.translate(p.x,p.y);
      fxCtx.rotate(p.r);
      fxCtx.fillStyle=p.color;
      fxCtx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
      fxCtx.restore();
    });

    dots.forEach(d=>{
      d.y+=d.vy;
      d.alpha+=d.va;
      if(d.alpha<0)d.alpha=0;
      fxCtx.beginPath();
      fxCtx.fillStyle=`rgba(255,215,130,${d.alpha})`;
      fxCtx.arc(d.x,d.y,d.r,0,Math.PI*2);
      fxCtx.fill();
    });

    if(t<duration){
      requestAnimationFrame(frame);
    }else{
      fxCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
    }
  }
  requestAnimationFrame(frame);
}

/*======== å–å¾— img å…ƒä»¶ ========*/
const img = document.getElementById("imgVerse");

/* ğŸ”’ å¿…é ˆå…ˆè¨­å®šï¼Œå¦å‰‡ canvas æœƒè¢«æ±¡æŸ“ */
img.crossOrigin = "anonymous";

/*======== è¨­å®šåœ–ç‰‡ä¾†æº ========*/
showVerseSafe(verseNo, refText);

/*======== åœ–ç‰‡è®€å–å®Œæˆ ========*/
img.onload = () => {

  // ğŸ›¡ é˜²æ­¢ onload è¢«è§¸ç™¼å…©æ¬¡ï¼ˆå¿«å– / src é‡è¨­ï¼‰
  if (img.dataset.loaded === "1") return;
  img.dataset.loaded = "1";

// ğŸ”„ æ›æ–°ç¶“å¥ â†’ é‡ç½®ä¸‹è¼‰é˜²å‘†
imageDownloadedThisView = false;
imageRepeatCount = 0;
lastVerseNo = verseNo;

  /* â‘  é—œé–‰ loadingï¼ˆä¸€å®šè¦å…ˆåšï¼‰ */
  const loading = document.getElementById("loading");
  if (loading) {
    loading.style.display = "none";
  }

  /* â‘¡ é¡¯ç¤ºåœ–ç‰‡æœ¬é«”ï¼ˆä¿åº•ï¼‰ */
  img.style.display = "block";
  
  // ğŸ“± è‡ªå‹•æœ€ä½³åŒ–é¡¯ç¤ºæ¯”ä¾‹ï¼ˆæ‰‹æ©Ÿç‰¹åŒ–ï¼‰
if (window.innerWidth < 768) {
  const vw = window.innerWidth;
  const ratio = img.naturalWidth / img.naturalHeight;

  if (ratio < 0.8) {
    // ç›´å¼åœ– â†’ é«˜åº¦å„ªå…ˆ
    img.style.maxHeight = "95vh";
    img.style.width = "auto";
  } else {
    // æ©«å¼æˆ–æ–¹å½¢ â†’ å¯¬åº¦å„ªå…ˆ
    img.style.width = "98vw";
    img.style.maxHeight = "90vh";
  }
}

  /* â‘¢ é‡‘é‚Šé–ƒçˆ */
if (!img.classList.contains("animate")) {
  img.classList.add("animate");
}

  /* â‘£ æ¸…ä¸€æ¬¡ confetti ç‹€æ…‹ï¼ˆåªä¸€æ¬¡ï¼‰ */
  if (typeof confetti === "function") {
    confetti.reset();
  }

  /* â‘¤ ä½ åŸæœ¬çš„ canvas é‡‘ç²‰ï¼‹å½©å¸¶ */
  launchFx();

  /* â‘¥ ç…™ç« â†’ å½©å¸¶ï¼ˆç¯€å¥åŠ å¿«ç‰ˆï¼‰ */
  if (typeof confetti === "function") {

    confetti({
      particleCount: 120,
      spread: 360,
      startVelocity: 60,
      gravity: 0.7,
      ticks: 180,
      origin: { x: 0.5, y: 0.32 }
    });

    setTimeout(() => {
      confetti({
        particleCount: 160,
        spread: 100,
        startVelocity: 50,
        gravity: 1.3,
        ticks: 260,
        origin: { x: 0.5, y: -0.15 }
      });
    }, 200);
  }

// ğŸ”Š viewer é€²å ´éŸ³æ•ˆï¼ˆdun / dun1 / dun2ï¼‰
if (ENABLE_DUN_SOUND) {
  try {
    const dun = document.getElementById("dunSound");
    if (dun) {

// â­ å‹•æ…‹é¸æ“‡éŸ³æ•ˆæª”ï¼ˆé˜²å‘†ï¼šé¿å…è®Šæ•¸æœªå®šç¾©ç‚¸æ‰ï¼‰
const variant = window.DUN_SOUND_VARIANT || "dun";
dun.src = `${variant}.mp3`;

      dun.currentTime = 0;

      // ç­‰åœ–ç‰‡ decode å®Œå†æ’­ï¼ˆä½ åŸæœ¬çš„è¨­è¨ˆï¼‰
      if (img.decode) {
        img.decode().then(() => {
          dun.play();
        }).catch(() => {
          dun.play();
        });
      } else {
        dun.play();
      }
    }
  } catch (e) {
    console.warn("dun sound blocked:", e);
  }
}

};

/*======== åœ–ç‰‡è¼‰å…¥å¤±æ•— ========*/
img.onerror = () => {
  const v = new URLSearchParams(location.search).get("no") || "unknown";

  const loading = document.getElementById("loading");
  if (loading) {
    loading.textContent = "âš  æ‰¾ä¸åˆ°åœ–ç‰‡ cards/" + v + ".png";
  }

  img.alt = "âš  æ‰¾ä¸åˆ°åœ–ç‰‡ cards/" + v + ".png";

  // ğŸ›¡ å…è¨±ä¸‹æ¬¡æˆåŠŸè¼‰å…¥æ™‚ onload é‡æ–°åŸ·è¡Œ
  delete img.dataset.loaded;
};

/*======== PATCH-B2ï¼šå¼·åˆ¶ä¸‹è¼‰ PNGï¼ˆé›¢ç·šä¹Ÿç©© + é˜²é‡è¤‡ + å‘½åè¦å‰‡ï¼‰ ========*/

// =============================
// ğŸ§© å”¯ä¸€ä¸‹è¼‰å…¥å£ï¼ˆå°è£ï¼‰
// =============================
async function handleDownloadClick() {
  try {
    // ğŸ”’ é˜²æ­¢ç‹‚é»ï¼ˆ500ms å…§åªèƒ½é€²ä¾†ä¸€æ¬¡ï¼‰
    if (downloading) return;
    downloading = true;

    const params = new URLSearchParams(window.location.search);
    const verseNo = params.get("no");
    const name = params.get("name") || "Blessing";

    if (!verseNo) {
      alert("ç¶“å¥ç·¨è™Ÿéºå¤±ï¼Œè«‹è¿”å›é‡æ–°æ‰“é–‹ç´…åŒ…");
      downloading = false;
      return;
    }

    // ===== 0ï¸âƒ£ é˜²é‡è¤‡ä¸‹è¼‰ï¼ˆåªæ“‹ã€ŒåŒä¸€ç¶“å¥ã€=====
    if (lastVerseNo === verseNo && imageDownloadedThisView) {
      const ok = confirm(
        "æ‚¨å·²ç¶“ä¸‹è¼‰éåœ–ç‰‡äº†, æ˜¯å¦è¦å†ä¸‹è¼‰ä¸€æ¬¡å‘¢ (Yes or No)?"
      );
      if (!ok) {
        downloading = false;
        return;
      }
      imageRepeatCount++;
    } else {
      imageDownloadedThisView = true;
      imageRepeatCount = 0;
      lastVerseNo = verseNo;
    }

    // ===== 1ï¸âƒ£ æ‰¾åˆ°åœ–ç‰‡å…ƒç´  =====
    // å¦‚æœä½ ç”¨çš„æ˜¯ id="cardImage"ï¼Œè«‹æ”¹æˆï¼š
    // const img = document.getElementById("cardImage");
    const img = document.getElementById("imgVerse");

if (!img || !img.complete || img.naturalWidth === 0) {
  alert("åœ–ç‰‡å°šæœªè¼‰å…¥å®Œæˆæˆ–è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å€™å†è©¦");
  downloading = false;
  return;
}

    // ===== 2ï¸âƒ£ Canvas è½‰ PNG =====
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;

    if (img.decode) {
      await img.decode();
    }
    ctx.drawImage(img, 0, 0);

    // ===== 3ï¸âƒ£ çµ„æª”åï¼ˆæ··åˆè¦å‰‡ï¼‰=====
    const safeName = name.replace(/[^\w\u4e00-\u9fa5]+/g, "_");
    const repeatTag = imageRepeatCount > 0 ? `_R${imageRepeatCount}` : "";

    // åŒæ™‚ä¿ç•™ä½ åŸæœ¬çš„ verse_no é¢¨æ ¼
    const filename = `${safeName}_verse_no_${verseNo}${repeatTag}.png`;

    // ===== 4ï¸âƒ£ å¼·åˆ¶ä¸‹è¼‰ =====
const blob = await new Promise((resolve, reject) => {
  canvas.toBlob(b => {
    if (!b) reject("toBlob failed");
    else resolve(b);
  }, "image/png", 1.0);
});

    if (!blob) {
      alert("ç€è¦½å™¨ä¸æ”¯æ´åœ–ç‰‡ä¸‹è¼‰ï¼Œè«‹æ”¹ç”¨æˆªåœ–");
      downloading = false;
      return;
    }

    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);

    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    URL.revokeObjectURL(url);

    console.log("ğŸ“¥ PNG downloaded:", filename);
  } catch (e) {
    console.error("âŒ PNG download failed:", e);
    alert("åœ–ç‰‡ä¸‹è¼‰å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ console");
  } finally {
    setTimeout(() => {
      downloading = false;
    }, 500);
  }
}

// =============================
// ğŸ‘‡ æŒ‰éˆ•åªè² è²¬å‘¼å«å…¥å£
// =============================
document.getElementById("btnDownload").onclick = () => {
  handleDownloadClick();
};

/*======== ä¸‹ä¸€ä½ï¼šå›é¦–é ï¼›ç”± index è‡ªå·±æ ¹æ“šç‹€æ…‹åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºä¸‰è¡Œ ========*/
document.getElementById("btnNext").onclick = ()=>{

  // æ¨™è¨˜ï¼šå¾ viewer å›åˆ°é¦–é 
  sessionStorage.setItem("showSummaryOnReturn","1");
  window.location.href = "index.html";
};

/*======== æŠ½ç±¤ç´€éŒ„é¡¯ç¤ºï¼ˆPatch 5ï¼‰ ========*/
/* ä¾†æºï¼šindex.html çš„ appendLog() å¯«å…¥ drawLogs */
const logBox = document.getElementById("logText");

let logs;
try{
  logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
  if(!Array.isArray(logs)) logs = [];
}catch(e){
  logs = [];
}

/* é¡¯ç¤ºè¦å‰‡ï¼š
   - æœ€æ–°ä¸€ç­†æ”¾æœ€ä¸Šé¢
   - æ ¼å¼å›ºå®š
*/
/* é¡¯ç¤ºæ ¼å¼ï¼š
   [æ™‚é–“] ã€Œå§“åã€ â†’ æŠ½ä¸­ç¶“å¥ç´…åŒ…: æ›¸å·ç« ç¯€
*/
logBox.innerHTML = logs
  .slice()          // ä¸å‹•åŸè³‡æ–™
  .reverse()        // æœ€æ–°åœ¨æœ€ä¸Š
  .map(l =>
    `[${l.time}] ã€Œ${l.name}ã€ â†’ æŠ½ä¸­ç¶“å¥ç´…åŒ…: ${l.ref}`
  )
  .join("<br>"); 
  
// =============================
// ğŸ” èˆ‡ä¸»æŒæ©ŸåŒæ­¥ï¼ˆéœæ…‹ç«™åœç”¨ï¼‰
// =============================
function syncFromMaster() {
  // GitHub Pages ç‚ºå”¯è®€éœæ…‹ç’°å¢ƒ
  // è·¨è£ç½®åŒæ­¥ä¸€å¾‹æ”¹ç”¨ QR Code URL (?no=...&ts=...)
  return;
}
// ä¸å† setInterval
  
</script>

<!-- PATCH-1ï¼šviewer å°ˆç”¨éŸ³æ•ˆ -->
<audio id="drum" src="audio/drum.mp3" preload="auto"></audio>
<audio id="winSound" src="audio/win.mp3" preload="auto"></audio>

</audio>

</body>
</html>
