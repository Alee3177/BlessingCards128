<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>抽中的祝福經句紅包</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    background: #fffdf7;
    font-family: "Noto Sans TC", sans-serif;
    text-align: center;
    padding: 20px;
    color: #5a4635;
}

/* 上方兩行紀錄顯示 */
#fullRecord {
    font-size: 19px;
    margin-top: 10px;
    margin-bottom: 18px;
    white-space: pre-line;
    line-height: 1.6;
    font-weight: bold;
}

/* 圖片中央資訊（舊版兩行保留） */
#titleName {
    font-size: 22px;
    font-weight: bold;
    margin-top: 16px;
}
#titleVerse {
    font-size: 20px;
    margin-top: 6px;
}

/* 經句圖片 */
#verseImage {
    width: 320px;
    border-radius: 12px;
    margin-top: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.18);
}

/* 按鈕 */
.btn {
    background: #f7c86c;
    padding: 14px 24px;
    border-radius: 25px;
    font-size: 18px;
    color: #5a3d00;
    cursor: pointer;
    border: none;
    margin-top: 18px;
}
.btn:hover {
    background: #f5b953;
}
</style>

<!-- Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

<!-- 經句對照表 -->
<script src="verseRefMap.js"></script>

</head>

<body>

<!-- 上方完整紀錄（置中） -->
<div id="fullRecord"></div>

<!-- 圖片中央的兩行原始資訊 -->
<div id="titleName"></div>
<div id="titleVerse"></div>

<!-- 經句 PNG -->
<img id="verseImage" src="" alt="verse">

<!-- 按鈕 -->
<br>
<button class="btn" onclick="downloadImage()">⬇ 下載經句圖片</button><br>
<button class="btn" onclick="nextPerson()">下一位</button><br>
<button class="btn" onclick="goHome()">回首頁</button>

<script>
/* 取得 URL 參數 */
function getParam(key){
    let url = new URL(window.location.href);
    return url.searchParams.get(key);
}

window.onload = function(){

    const name  = getParam("name")  || "???";
    const verse = getParam("verse") || "001";

    /* timestamp（由 viewer.js 自動生成） */
    const now = new Date();
    const ts =
        `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,"0")}/${String(now.getDate()).padStart(2,"0")} ` +
        `${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}:${String(now.getSeconds()).padStart(2,"0")}`;

    const ref = window.VERSE_REF_MAP[verse] || "";

    /* -----------------------------
       第一段（在下載按鈕上方）
    ----------------------------- */
    const fullText =
        `[${ts}] ${name}｜抽中的經句紅包\n` +
        `編號「${verse}」${ref ? `（${ref}）` : ""}`;

    document.getElementById("fullRecord").innerText = fullText;

    /* -----------------------------
       圖片中央的兩行顯示（舊版保留）
    ----------------------------- */
    document.getElementById("titleName").innerText =
        `${name}｜抽中的經句紅包`;

    document.getElementById("titleVerse").innerText =
        `編號「${verse}」${ref ? `（${ref}）` : ""}`;

    /* -----------------------------
       經句 PNG 顯示
    ----------------------------- */
    document.getElementById("verseImage").src = `cards/${verse}.png`;

    /* -----------------------------
       播放中獎音效
    ----------------------------- */
    const win = new Audio("audio/win.mp3");
    win.play().catch(()=>{});

    /* -----------------------------
       Confetti 特效
    ----------------------------- */
    confetti({
        particleCount: 200,
        spread: 90,
        origin: { y: 0.3 }
    });
}

/* -----------------------------
   PNG 下載
----------------------------- */
function downloadImage(){
    const verse = getParam("verse");
    const a = document.createElement("a");
    a.href = `cards/${verse}.png`;
    a.download = `BlessingCard_${verse}.png`;
    a.click();
}

/* -----------------------------
   下一位 ＝ 回到 index.html 等待下一位
----------------------------- */
function nextPerson(){
    window.location = "index.html";
}

/* -----------------------------
   回首頁
----------------------------- */
function goHome(){
    window.location = "index.html";
}
</script>

</body>
</html>
