<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>BlessingCards128｜祝福經句紅包內容（v5.3.1）</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body {
    background: #fff8e7;
    font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
    text-align: center;
    padding: 22px;
    color: #5b3a00;
}
h2 {
    font-size: 22px;
    margin: 6px 0;
}
h3 {
    font-size: 20px;
    margin: 4px 0 14px 0;
}
.btn {
    background: #f7c76c;
    border: none;
    padding: 10px 20px;
    border-radius: 22px;
    font-size: 18px;
    color: #5b3a00;
    cursor: pointer;
    margin: 6px;
}
.btn:hover {
    background: #f3b84f;
}
#cardImg {
    max-width: 90vw;
    width: 360px;
    margin-top: 10px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}
</style>
</head>
<body>

<h1>祝福經句紅包內容</h1>

<div id="infoLine1"></div>
<div id="infoLine2"></div>

<img id="cardImg" src="" alt="經句紅包圖片" />

<div style="margin-top:16px;">
    <button class="btn" onclick="downloadPNG()">下載經句圖片</button>
    <button class="btn" onclick="goNext()">下一位 / 回首頁</button>
</div>

<script src="verseRefMap.js"></script>
<script>
/* 解析 URL 參數 */
function getQueryParam(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name) || "";
}

const nameParam  = getQueryParam("name");
const verseParam = getQueryParam("verse");
const timeParam  = getQueryParam("time");

const verseMap = window.VERSE_REF_MAP || {};
const verseRef = verseMap[verseParam] || "";

/* 頁面顯示（不含時間） */
const line1Page = `${nameParam}｜抽中的經句紅包`;
const line2Page = verseRef
    ? `編號「${verseParam}」（${verseRef}）`
    : `編號「${verseParam}」`;

document.getElementById("infoLine1").innerHTML = `<h2>${line1Page}</h2>`;
document.getElementById("infoLine2").innerHTML = `<h3>${line2Page}</h3>`;

/* PNG 內文字（保留時間） */
const line1PNG = timeParam
    ? `[${timeParam}] ${nameParam}｜抽中的經句紅包`
    : `${nameParam}｜抽中的經句紅包`;

const line2PNG = verseRef
    ? `編號「${verseParam}」（${verseRef}）`
    : `編號「${verseParam}」`;

/* 設定卡片圖片路徑（cards/NNN.png） */
const cardImg = document.getElementById("cardImg");
let imgSrc = "";
if (verseParam && /^\d{3}$/.test(verseParam)){
    imgSrc = `cards/${verseParam}.png`;
} else {
    imgSrc = `cards/${verseParam}.png`;
}
cardImg.src = imgSrc;

/* 下載 PNG（整張背景統一顏色） */
function downloadPNG(){
    if (!cardImg.complete){
        alert("圖片尚未載入完成，請稍候再試。");
        return;
    }

    // 建立 canvas，預留上方文字區
    const padding   = 20;
    const textAreaH = 60;  // 給兩行文字使用

    const imgW = cardImg.naturalWidth  || 360;
    const imgH = cardImg.naturalHeight || 540;

    const canvas = document.createElement("canvas");
    const ctx    = canvas.getContext("2d");

    canvas.width  = imgW + padding*2;
    canvas.height = textAreaH + imgH + padding*2;

    // 底色：統一使用白色（整張一個顏色）
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // 繪製文字（PNG 版使用含時間的版本）
    ctx.font      = "18px Noto Sans TC";
    ctx.fillStyle = "#5b3a00";
    ctx.textAlign = "center";

    const centerX = canvas.width / 2;
    let textY = padding + 22;
    ctx.fillText(line1PNG, centerX, textY);
    textY += 24;
    ctx.fillText(line2PNG, centerX, textY);

    // 繪製經句圖片
    const imgX = padding;
    const imgY = padding + textAreaH;
    ctx.drawImage(cardImg, imgX, imgY, imgW, imgH);

    // 下載
    const a = document.createElement("a");
    a.href = canvas.toDataURL("image/png");
    a.download = `BlessingCards128_${nameParam || "經句"}_${verseParam || ""}.png`;
    a.click();
}

/* 回首頁 / 下一位 */
function goNext(){
    window.location.href = "index.html";
}
</script>
</body>
</html>
