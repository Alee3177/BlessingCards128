<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>祝福經句紅包 - 經句顯示</title>

<style>
:root {
  --bg: #fff7e6;
  --brown-text: #8a5500;
  --brown-title: #b37500;
  --gold-light: #ffe9a3;
  --gold-mid: #ffd166;
  --gold-dark: #e8a838;
}

body {
  margin: 0;
  background: var(--bg);
  font-family: "NotoSansTC", sans-serif;
  text-align: center;
  color: var(--brown-text);
}

.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px 16px 60px;
}

/* logo */
.logo-box {
  width: 100%;
  text-align: center;
  margin-top: 10px;
}
.logo {
  width: 180px;
  height: auto;
  margin-bottom: 10px;
}

h1 {
  font-size: 24px;
  margin: 10px 0 20px;
  color: var(--brown-title);
}

.info {
  font-size: 18px;
  margin-bottom: 10px;
}

.verseRef {
  font-size: 20px;
  color: #8a5500;
  font-weight: 700;
  margin-bottom: 20px;
}

.cardImg {
  width: 85%;
  max-width: 480px;
  border-radius: 14px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  margin-top: 20px;
}

.btn {
  min-width: 220px;
  padding: 12px 20px;
  margin: 10px auto;
  border: none;
  border-radius: 999px;
  background: linear-gradient(180deg, var(--gold-light), var(--gold-mid));
  font-size: 18px;
  font-weight: 600;
  color: var(--brown-text);
  box-shadow: 0 3px 6px rgba(0,0,0,0.18);
  cursor: pointer;
}
.btn:hover {
  background: linear-gradient(180deg, var(--gold-mid), var(--gold-dark));
}
</style>

<!-- 字型 & 經文對照 -->
<script src="font_base64.js"></script>
<script src="verseRefMap.js"></script>

<!-- confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

</head>
<body>

<!-- logo -->
<div class="logo-box">
  <img src="logo3524.png" class="logo" alt="logo">
</div>

<!-- 音效 -->
<audio id="winSound" src="audio/win.mp3" preload="auto"></audio>

<div class="container">

  <h1>祝福經句紅包</h1>

  <div class="info" id="nameField"></div>
  <div class="verseRef" id="verseRef"></div>

  <img id="verseImg" class="cardImg" src="" alt="經句圖片">

  <button class="btn" onclick="downloadImage()">下載經句圖片</button>
  <button class="btn" onclick="goNext()">下一位</button>
  <button class="btn" onclick="goHome()">回首頁</button>

</div>

<script>
/* ============ 解析 URL ============ */
function getQuery(key){
  return new URLSearchParams(window.location.search).get(key);
}

const verseNo = getQuery("no");
const name    = getQuery("name") ? decodeURIComponent(getQuery("name")) : "";

/* ============ 顯示姓名 + 經文 ============ */
document.getElementById("nameField").textContent =
  name ? `抽中： ${name}` : "";

let verseRef = "";
if(window.VERSE_REF_MAP){
  verseRef = window.VERSE_REF_MAP[verseNo] || "";
}

document.getElementById("verseRef").textContent =
  verseRef ? `（${verseRef}）` : "";

/* ============ 顯示圖片 ============ */
const img = document.getElementById("verseImg");
img.src = `cards/${verseNo}.png`;

/* ============ 取得抽籤紀錄中屬於本次的完整資訊 ============ */
function getLatestLog(){
  const logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
  if(!logs.length) return "";
  
  // 依照 time 最新排序（保險）
  logs.sort((a,b)=> new Date(b.time) - new Date(a.time));

  const log = logs[0];  // 最新的一筆
  const ref = window.VERSE_REF_MAP[log.verseNo] || "";

  return `[${log.time}] ${log.name}｜經句：${log.verseNo}（${ref}）`;
}

const fullLogLine = getLatestLog();

/* ============ 播放 win ============ */
const winSound = document.getElementById("winSound");
winSound.currentTime = 0;
winSound.play().catch(()=>{});

/* ============ confetti ============ */
setTimeout(()=>{
  confetti({
    particleCount: 140,
    spread: 90,
    origin: { y: 0.25 }
  });
}, 300);

/* ============ 下載 PNG（含文字） ============ */
function downloadImage(){
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  const w = img.naturalWidth;
  const h = img.naturalHeight + 160; // 預留上方文字區域
  canvas.width  = w;
  canvas.height = h;

  // 背景白色
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,w,h);

  // 字體樣式（與底部分類字體一致）
  ctx.font = "28px NotoSansTC";
  ctx.fillStyle = "#333";
  ctx.textAlign = "center";

  // 第一行：完整紀錄（置中）
  ctx.fillText(fullLogLine, w/2, 50);

  // 第二行：標題
  ctx.fillText("抽中的祝福經句紅包", w/2, 100);

  // 原 PNG 圖片
  ctx.drawImage(img, 0, 160, w, img.naturalHeight);

  // 下載
  const link = document.createElement("a");
  link.href = canvas.toDataURL("image/png");
  link.download = `blessing_${verseNo}.png`;
  link.click();
}

/* ============ 下一位、回首頁 ============ */
function goNext(){
  window.location = "index.html";
}
function goHome(){
  window.location = "index.html";
}
</script>

</body>
</html>
