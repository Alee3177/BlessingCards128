<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>BlessingCards128｜紅包內容（v5.1）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    background: #fff8e7;
    font-family: "Noto Sans TC", sans-serif;
    text-align: center;
    padding: 22px;
    color: #5b3a00;
}

h1 {
    font-size: 26px;
    color: #b07500;
    margin-bottom: 10px;
}

.info-line {
    font-size: 22px;
    margin: 6px 0;
}

#verseImg {
    width: 88%;
    max-width: 450px;
    margin-top: 20px;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(0,0,0,0.15);
}

/* 按鈕 */
.btn {
    background: #f7c76c;
    border: none;
    padding: 10px 22px;
    border-radius: 22px;
    font-size: 18px;
    color: #5b3a00;
    cursor: pointer;
    margin: 8px;
}
.btn:hover {
    background: #f3b84f;
}

</style>
</head>

<body>

<h1>抽中紅包內容</h1>

<div id="displayName" class="info-line"></div>
<div id="displayVerse" class="info-line"></div>
<div id="displayRef" class="info-line"></div>

<img id="verseImg" src="" alt="verse image">

<br>

<button class="btn" onclick="downloadPNG()">下載經句圖片</button>
<button class="btn" onclick="nextOrHome()">下一位／回首頁</button>

<script src="verseRefMap.js"></script>

<script>
/* -------------------------------------------------------
   取得網址參數：name（抽到的人），verse（經句編號），time（抽籤時間）
--------------------------------------------------------*/
const url = new URL(window.location.href);
const name = url.searchParams.get("name") || "（無資料）";
const verse = url.searchParams.get("verse") || "";
const time = url.searchParams.get("time") || "";  // v5.1 新增：從 index.html 帶入



/* -------------------------------------------------------
   顯示內容
--------------------------------------------------------*/
const ref = VERSE_REF_MAP[verse] || "";
document.getElementById("displayName").innerText = `抽中者：${name}`;
document.getElementById("displayVerse").innerText = `經句編號：${verse}`;
document.getElementById("displayRef").innerText = `${ref}`;

document.getElementById("verseImg").src = `cards/${verse}.png`;


/* -------------------------------------------------------
   下載 PNG：包含兩行文字 + 原經句圖
--------------------------------------------------------*/
async function downloadPNG(){

    const img = document.getElementById("verseImg");

    // 等待圖片載入完成
    await img.decode().catch(()=>{});

    // 建立 Canvas
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const w = img.naturalWidth;
    const h = img.naturalHeight + 160;   // 上方加 2 行空間

    canvas.width = w;
    canvas.height = h;

    ctx.fillStyle = "#fff8e7";
    ctx.fillRect(0, 0, w, h);

    ctx.textAlign = "center";
    ctx.fillStyle = "#5b3a00";

    ctx.font = "28px Noto Sans TC";
    ctx.fillText(`[${time}] ${name}｜抽中的經句紅包`, w/2, 45);

    ctx.font = "26px Noto Sans TC";
    ctx.fillText(`編號「${verse}」（${ref}）`, w/2, 95);

    // 畫原本經句圖片
    ctx.drawImage(img, 0, 160, w, img.naturalHeight);

    // 產生下載
    const link = document.createElement("a");
    link.download = `Blessing_${name}_${verse}.png`;
    link.href = canvas.toDataURL("image/png");
    link.click();
}


/* -------------------------------------------------------
   下一位／回首頁
   - 若姓名模式未抽完下一位 → 回 index.html
   - 若姓名全部抽完 → 顯示警告後回首頁
--------------------------------------------------------*/
function nextOrHome(){

    const usedNames = JSON.parse(localStorage.getItem("usedNames") || "[]");
    const nameList = JSON.parse(localStorage.getItem("nameList") || "[]");

    if(!nameList || nameList.length === 0){
        location.href = "index.html";
        return;
    }

    if(usedNames.length >= nameList.length){
        alert("本輪全部姓名已完成抽籤，將返回首頁！");
        location.href = "index.html";
        return;
    }

    // 尚未抽完 → 回首頁繼續下一位
    location.href = "index.html";
}

</script>

</body>
</html>
