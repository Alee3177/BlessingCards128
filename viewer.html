<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BlessingCards128｜祝福經句紅包</title>
<style>
  body{
    background:#fff8e7;
    font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    color:#5b3a00;
    text-align:center;
    padding:18px;
  }
  h1{
    margin:10px 0 6px;
    color:#b07500;
    font-size:22px;
    font-weight:700;
  }
  #line1,#line2{
    font-size:18px;
    margin:4px 0;
    text-align:center;
  }
  #cardImg{
    margin:12px auto 10px;
    width:min(92vw, 520px);
    height:auto;
    display:block;
    border-radius:14px;
    box-shadow:0 6px 18px rgba(0,0,0,.12);
    background:#fff; /* 避免圖片載入前閃動 */
  }
  .btn{
    background:#f7c76c;
    border:none;
    padding:12px 18px;
    border-radius:22px;
    font-size:18px;
    color:#5b3a00;
    cursor:pointer;
    margin:8px 6px;
  }
  .btn:hover{ background:#f3b84f; }
  #err{
    margin-top:10px;
    color:#c0392b;
    font-weight:700;
    display:none;
    white-space:pre-wrap;
  }
</style>
</head>
<body>

<h1>祝福經句紅包（應許等您拿）</h1>

<div id="line1"></div>
<div id="line2"></div>

<img id="cardImg" alt="Blessing Card">

<div>
  <button class="btn" id="downloadBtn">下載經句圖片</button>
  <button class="btn" id="nextBtn">下一位</button>
</div>

<div id="err"></div>

<script src="verseRefMap.js"></script>
<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const name = (qs.get('name') || '').trim();
  let verse = (qs.get('verse') || '').trim();

  const line1El = document.getElementById('line1');
  const line2El = document.getElementById('line2');
  const img = document.getElementById('cardImg');
  const err = document.getElementById('err');

  function pad3(v){
    const n = String(v).replace(/\D/g,'');
    return n.padStart(3,'0');
  }
  verse = pad3(verse);

  const ref = (window.VERSE_REF_MAP && window.VERSE_REF_MAP[verse]) ? window.VERSE_REF_MAP[verse] : '';
  line1El.textContent = `${name}｜抽中的經句紅包`;
  line2El.textContent = `編號「${verse}」${ref ? `（${ref}）` : ''}`;

  // PNG 路徑：同 repo 根目錄下 cards/001.png
  img.src = `cards/${verse}.png`;
  img.onerror = () => {
    err.style.display = 'block';
    err.textContent = `PNG 載入失敗：cards/${verse}.png\n請確認 cards 目錄與檔名(001~128).png 存在。`;
  };

  // 下載：把「兩行」疊在同一張 PNG 上方，並確保背景色一致（以原 PNG 為底）
  document.getElementById('downloadBtn').addEventListener('click', async () => {
    try{
      // 確保圖片載入完成
      await img.decode();

      const w = img.naturalWidth;
      const h = img.naturalHeight;

      // 上方加一塊文字區（高度依字級給固定值，避免不同手機不一致）
      const topPad = Math.round(h * 0.16); // 16% 作為文字區
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h + topPad;

      const ctx = canvas.getContext('2d');

      // 先鋪底：取 PNG 左上角像素色作為底色，避免與卡片底色不一致
      ctx.drawImage(img, 0, 0);
      const px = ctx.getImageData(2,2,1,1).data;
      ctx.clearRect(0,0,canvas.width, canvas.height);
      ctx.fillStyle = `rgb(${px[0]},${px[1]},${px[2]})`;
      ctx.fillRect(0,0,canvas.width, canvas.height);

      // 再畫 PNG 本體（往下位移）
      ctx.drawImage(img, 0, topPad);

      // 文字
      ctx.fillStyle = '#5b3a00';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      // 字體大小：跟卡片底部分類字差不多的視覺（依圖片寬度自動縮放）
      const font1 = Math.max(26, Math.round(w * 0.045));
      const font2 = Math.max(24, Math.round(w * 0.040));

      ctx.font = `700 ${font1}px "Noto Sans TC", sans-serif`;
      ctx.fillText(line1El.textContent, w/2, topPad*0.42);

      ctx.font = `700 ${font2}px "Noto Sans TC", sans-serif`;
      ctx.fillText(line2El.textContent, w/2, topPad*0.74);

      // 下載
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = `${verse}_${name || 'Blessing'}_card.png`;
      a.click();
    }catch(e){
      err.style.display = 'block';
      err.textContent = '下載失敗：' + (e && e.message ? e.message : e);
    }
  });

  document.getElementById('nextBtn').addEventListener('click', () => {
    location.href = 'index.html';
  });
})();
</script>
</body>
</html>
