<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç¥ç¦ç¶“å¥ç´…åŒ…</title>

<style>
body{
  font-family:"Noto Sans TC",system-ui;
  background:#fbf2df;
  text-align:center;
  margin:0;
  padding:16px;
  color:#5b3a00;
}

/* é¡¯ç¤ºæ¨™é¡Œå€åŸŸ */
#infoBox{
  font-size:18px;
  white-space:pre-line;
  margin-bottom:10px;
}

/* ç¶“å¥åœ–ç‰‡ï¼ˆå«é‡‘é‚Šï¼‰ */
#imgVerse{
  max-width:420px;
  width:90%;
  border-radius:18px;
  display:block;
  margin:12px auto;
  border:6px solid gold;
}

/* é‡‘é‚Šç™¼å…‰ï¼‹å½ˆè·³ */
@keyframes glow{
  0%{ box-shadow:0 0 10px gold; }
  50%{ box-shadow:0 0 32px gold; }
  100%{ box-shadow:0 0 10px gold; }
}
@keyframes jump{
  0%{ transform:scale(.8); opacity:.2; }
  40%{ transform:scale(1.05); opacity:1;}
  80%{ transform:scale(1.0);}
  100%{ transform:scale(1.0);}
}
.animate{
  animation:glow 2.2s infinite, jump 1.2s ease-out;
}

/* æŒ‰éˆ•æ¨£å¼èˆ‡ index ä¸€è‡´ */
.btn{
  min-width:110px;
  padding:8px 16px;
  border-radius:999px;
  border:none;
  background:#f4b63a;
  color:#5b3a00;
  font-size:15px;
  font-weight:600;
  box-shadow:0 3px 0 #d59b25;
  cursor:pointer;
  margin:10px 6px 0 6px;
}
.btn:disabled{
  background:#f0ddaa;
  cursor:default;
}

/* æŠ½ç±¤ç´€éŒ„æ¡† */
#recordBox{
  margin-top:18px;
  max-width:560px;
  margin-left:auto;
  margin-right:auto;
  text-align:left;
  padding:10px 12px;
  border-radius:12px;
  background:#ffffff;
  box-shadow:0 0 10px rgba(0,0,0,.15);
  font-size:14px;
}

/* å½©å¸¶ï¼‹é‡‘ç²‰ç•«å¸ƒï¼ˆå…¨ç•«é¢ï¼‰ */
#fxCanvas{
  position:fixed;
  left:0;
  top:0;
  width:100%;
  height:100%;
  pointer-events:none;
}

#loading{
  margin: 12px 0;
  font-size: 15px;
  color: #8a5a00;
}
</style>

<script src="verseRefMap.js?v=20260105"></script>

<!-- PATCH-2ï¼šç…™ç« / å½©å¸¶ï¼ˆcanvas-confettiï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

</head>

<body>

<h2>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h2>

<div id="infoBox"></div>

<canvas id="fxCanvas"></canvas>

<!-- âœ… æ–°å¢ï¼šåœ–ç‰‡è¼‰å…¥æç¤º -->
<div id="loading">ç¶“å¥åœ–ç‰‡è¼‰å…¥ä¸­â€¦â€¦</div>

<img id="imgVerse" src="" alt="ç¶“å¥åœ–ç‰‡è¼‰å…¥ä¸­â€¦â€¦">

<div>
  <button id="btnDownload" class="btn">ä¸‹è¼‰ç¶“å¥åœ–ç‰‡</button>
  <button id="btnNext" class="btn">ä¸‹ä¸€ä½</button>
</div>

<div id="recordBox">
  <b>ğŸ“œ æŠ½ç±¤ç´€éŒ„</b>
  <div id="logText"></div>
</div>

<script>

// ==== viewer åœ–ç‰‡ä¸‹è¼‰é˜²é‡è¤‡ç‹€æ…‹ ====
let imageDownloadedThisView = false;
let imageRepeatCount = 0;

const ENABLE_DUN_SOUND = false;   // â† æ”¹æˆ true å°±å…¨éƒ¨æ¢å¾©

// â­ æ–°å¢ï¼šé€²å ´éŸ³æ•ˆé¸æ“‡
// å¯é¸ï¼š"dun" | "dun1" | "dun2"
const DUN_SOUND_VARIANT = "dun";   // â† æ”¹é€™ä¸€è¡Œå°±å¥½

/* å–å¾— URL åƒæ•¸ */
function getParam(n){
  const u = new URL(window.location.href);
  return u.searchParams.get(n);
}

const verseNo = getParam("no");
const userName = getParam("name") || "";

/*======== æ‰¾å‡ºæ›¸å·ï¼‹ç« ç¯€ï¼ˆç”¨ VERSE_REF_MAPï¼‰ ========*/
let refText = "";
if (window.VERSE_REF_MAP && window.VERSE_REF_MAP[verseNo]) {
  refText = window.VERSE_REF_MAP[verseNo];
}

/*======== ä¸Šæ–¹å…©è¡Œé¡¯ç¤º ========*/
document.getElementById("infoBox").textContent =
`ã€Œ${userName}ã€ï½œæŠ½ä¸­çš„ç¶“å¥ç´…åŒ…
ğŸ“œ ç¶“å¥ç·¨è™Ÿ: ${verseNo}ï½œğŸ“– ${refText}`;

/*======== å½©å¸¶ï¼‹é‡‘ç²‰ç‰¹æ•ˆ ========*/
const fxCanvas = document.getElementById("fxCanvas");
const fxCtx = fxCanvas.getContext("2d");

function resizeFx(){
  fxCanvas.width = window.innerWidth;
  fxCanvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeFx);
resizeFx();

function launchFx(){
  const pieces=[];
  const dots=[];
  const colors=["#ffd54f","#ffb300","#ffca28","#ffe082","#fff8e1"];

  for(let i=0;i<150;i++){
    pieces.push({
      x:Math.random()*fxCanvas.width,
      y:Math.random()*-80,
      w:6+Math.random()*6,
      h:12+Math.random()*10,
      vx:-1+Math.random()*2,
      vy:2+Math.random()*3,
      r:Math.random()*Math.PI,
      vr:(Math.random()-0.5)*0.25,
      color:colors[Math.floor(Math.random()*colors.length)]
    });
  }
  for(let i=0;i<90;i++){
    dots.push({
      x:fxCanvas.width/2 + (Math.random()-0.5)*260,
      y:fxCanvas.height/2 + (Math.random()-0.5)*120,
      r:1+Math.random()*2.8,
      vy:-0.3-Math.random()*0.6,
      alpha:0.9,
      va:-0.012-Math.random()*0.02
    });
  }

  const start=performance.now();
  const duration=2000;

  function frame(now){
    const t = now-start;
    fxCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height);

    pieces.forEach(p=>{
      p.x+=p.vx;
      p.y+=p.vy;
      p.r+=p.vr;
      fxCtx.save();
      fxCtx.translate(p.x,p.y);
      fxCtx.rotate(p.r);
      fxCtx.fillStyle=p.color;
      fxCtx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
      fxCtx.restore();
    });

    dots.forEach(d=>{
      d.y+=d.vy;
      d.alpha+=d.va;
      if(d.alpha<0)d.alpha=0;
      fxCtx.beginPath();
      fxCtx.fillStyle=`rgba(255,215,130,${d.alpha})`;
      fxCtx.arc(d.x,d.y,d.r,0,Math.PI*2);
      fxCtx.fill();
    });

    if(t<duration){
      requestAnimationFrame(frame);
    }else{
      fxCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
    }
  }
  requestAnimationFrame(frame);
}

/*======== å–å¾— img å…ƒä»¶ ========*/
const img = document.getElementById("imgVerse");

/* ğŸ”’ å¿…é ˆå…ˆè¨­å®šï¼Œå¦å‰‡ canvas æœƒè¢«æ±¡æŸ“ */
img.crossOrigin = "anonymous";

/*======== è¨­å®šåœ–ç‰‡ä¾†æº ========*/
img.src = "cards/" + verseNo + ".png";

/*======== åœ–ç‰‡è®€å–å®Œæˆ ========*/
img.onload = () => {

  // ğŸ›¡ é˜²æ­¢ onload è¢«è§¸ç™¼å…©æ¬¡ï¼ˆå¿«å– / src é‡è¨­ï¼‰
  if (img.dataset.loaded === "1") return;
  img.dataset.loaded = "1";

  /* â‘  é—œé–‰ loadingï¼ˆä¸€å®šè¦å…ˆåšï¼‰ */
  const loading = document.getElementById("loading");
  if (loading) {
    loading.style.display = "none";
  }

  /* â‘¡ é¡¯ç¤ºåœ–ç‰‡æœ¬é«”ï¼ˆä¿åº•ï¼‰ */
  img.style.display = "block";

  /* â‘¢ é‡‘é‚Šé–ƒçˆ */
  img.classList.add("animate");

  /* â‘£ æ¸…ä¸€æ¬¡ confetti ç‹€æ…‹ï¼ˆåªä¸€æ¬¡ï¼‰ */
  if (typeof confetti === "function") {
    confetti.reset();
  }

  /* â‘¤ ä½ åŸæœ¬çš„ canvas é‡‘ç²‰ï¼‹å½©å¸¶ */
  launchFx();

  /* â‘¥ ç…™ç« â†’ å½©å¸¶ï¼ˆç¯€å¥åŠ å¿«ç‰ˆï¼‰ */
  if (typeof confetti === "function") {

    confetti({
      particleCount: 120,
      spread: 360,
      startVelocity: 60,
      gravity: 0.7,
      ticks: 180,
      origin: { x: 0.5, y: 0.32 }
    });

    setTimeout(() => {
      confetti({
        particleCount: 160,
        spread: 100,
        startVelocity: 50,
        gravity: 1.3,
        ticks: 260,
        origin: { x: 0.5, y: -0.15 }
      });
    }, 200);
  }

// ğŸ”Š viewer é€²å ´éŸ³æ•ˆï¼ˆdun / dun1 / dun2ï¼‰
if (ENABLE_DUN_SOUND) {
  try {
    const dun = document.getElementById("dunSound");
    if (dun) {

// â­ å‹•æ…‹é¸æ“‡éŸ³æ•ˆæª”ï¼ˆé˜²å‘†ï¼šé¿å…è®Šæ•¸æœªå®šç¾©ç‚¸æ‰ï¼‰
const variant = window.DUN_SOUND_VARIANT || "dun";
dun.src = `${variant}.mp3`;

      dun.currentTime = 0;

      // ç­‰åœ–ç‰‡ decode å®Œå†æ’­ï¼ˆä½ åŸæœ¬çš„è¨­è¨ˆï¼‰
      if (img.decode) {
        img.decode().then(() => {
          dun.play();
        }).catch(() => {
          dun.play();
        });
      } else {
        dun.play();
      }
    }
  } catch (e) {
    console.warn("dun sound blocked:", e);
  }
}

};

/*======== åœ–ç‰‡è¼‰å…¥å¤±æ•— ========*/
img.onerror = ()=>{
  // è‹¥æœ‰ç…™ç«ï¼Œå…ˆæ¸…æ‰

  const loading = document.getElementById("loading");
  if(loading){
    loading.textContent = "âš  æ‰¾ä¸åˆ°åœ–ç‰‡ cards/" + verseNo + ".png";
  }

  img.alt = "âš  æ‰¾ä¸åˆ°åœ–ç‰‡ cards/" + verseNo + ".png";
  
  // ğŸ›¡ å…è¨±ä¸‹æ¬¡æˆåŠŸè¼‰å…¥æ™‚ onload é‡æ–°åŸ·è¡Œ
  delete img.dataset.loaded;
};

/*======== PATCH-B2ï¼šå¼·åˆ¶ä¸‹è¼‰ PNGï¼ˆé›¢ç·šä¹Ÿç©© + é˜²é‡è¤‡ + å‘½åè¦å‰‡ï¼‰ ========*/
document.getElementById("btnDownload").onclick = async ()=>{
  try{

    // ===== 0ï¸âƒ£ é˜²é‡è¤‡ä¸‹è¼‰ï¼ˆåŒä¸€ç•«é¢ï¼‰=====
    if (imageDownloadedThisView) {
      const ok = confirm(
        "æ‚¨å·²ç¶“ä¸‹è¼‰éåœ–ç‰‡äº†, æ˜¯å¦è¦å†ä¸‹è¼‰ä¸€æ¬¡å‘¢ (Yes or No)?"
      );
      if (!ok) return;
      imageRepeatCount++;
    } else {
      imageDownloadedThisView = true;
      imageRepeatCount = 0;
    }

    // ===== 1ï¸âƒ£ åœ–ç‰‡å¿…é ˆå·²è¼‰å…¥æˆåŠŸ =====
    if(!img || !img.complete || img.naturalWidth === 0){
      alert("åœ–ç‰‡å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡");
      return;
    }

    // ===== 2ï¸âƒ£ ç”¨ canvas å–å¾—åŒä¸€å¼µåœ–çš„ blob =====
    const cvs = document.createElement("canvas");
    cvs.width = img.naturalWidth;
    cvs.height = img.naturalHeight;

    const c2d = cvs.getContext("2d");
    c2d.drawImage(img, 0, 0);

    const blob = await new Promise((resolve)=> cvs.toBlob(resolve, "image/png"));
    if(!blob){
      alert("åœ–ç‰‡ä¸‹è¼‰å¤±æ•—ï¼ˆtoBlob å¤±æ•—ï¼‰");
      return;
    }

    // ===== 3ï¸âƒ£ æª”åè¦å‰‡ =====
    // verse_no_001.png ~ verse_no_128.png
    let baseName = `verse_no_${String(verseNo).padStart(3, "0")}`;

    // é‡è¤‡ä¸‹è¼‰ â†’ åŠ  -1, -2, -3...
    let finalName = baseName;
    if (imageRepeatCount > 0) {
      finalName = `${baseName}-${imageRepeatCount}`;
    }

    const blobUrl = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = blobUrl;
    a.download = `${finalName}.png`;
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(blobUrl);

  }catch(e){
    alert("åœ–ç‰‡ä¸‹è¼‰å¤±æ•—ï¼ˆä¾‹å¤–ï¼‰");
    console.error(e);
  }
};

/*======== ä¸‹ä¸€ä½ï¼šå›é¦–é ï¼›ç”± index è‡ªå·±æ ¹æ“šç‹€æ…‹åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºä¸‰è¡Œ ========*/
document.getElementById("btnNext").onclick = ()=>{

  // æ¨™è¨˜ï¼šå¾ viewer å›åˆ°é¦–é 
  sessionStorage.setItem("showSummaryOnReturn","1");
  window.location.href = "index.html";
};

/*======== æŠ½ç±¤ç´€éŒ„é¡¯ç¤ºï¼ˆPatch 5ï¼‰ ========*/
/* ä¾†æºï¼šindex.html çš„ appendLog() å¯«å…¥ drawLogs */
const logBox = document.getElementById("logText");

let logs;
try{
  logs = JSON.parse(localStorage.getItem("drawLogs") || "[]");
  if(!Array.isArray(logs)) logs = [];
}catch(e){
  logs = [];
}

/* é¡¯ç¤ºè¦å‰‡ï¼š
   - æœ€æ–°ä¸€ç­†æ”¾æœ€ä¸Šé¢
   - æ ¼å¼å›ºå®š
*/
/* é¡¯ç¤ºæ ¼å¼ï¼š
   [æ™‚é–“] ã€Œå§“åã€ â†’ æŠ½ä¸­ç¶“å¥ç´…åŒ…: æ›¸å·ç« ç¯€
*/
logBox.innerHTML = logs
  .slice()          // ä¸å‹•åŸè³‡æ–™
  .reverse()        // æœ€æ–°åœ¨æœ€ä¸Š
  .map(l =>
    `[${l.time}] ã€Œ${l.name}ã€ â†’ æŠ½ä¸­ç¶“å¥ç´…åŒ…: ${l.ref}`
  )
  .join("<br>"); 
</script>

<!-- PATCH-1ï¼šviewer å°ˆç”¨éŸ³æ•ˆï¼ˆæ–°å¢ï¼Œä¸å–ä»£ä»»ä½•æ—¢æœ‰éŸ³æ•ˆï¼‰ -->
<audio id="dunSound" preload="auto">

</audio>

</body>
</html>
