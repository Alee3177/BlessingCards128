<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>看紅包</title>
  <style>
    body{ margin:0; font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
          background:#f7eedb; color:#4b3a20; text-align:center; }
    #logo{ display:none; }
    h2{ margin:14px 0 8px; font-weight:900; }
    #imgVerse{
      width: min(98vw, 720px);
      max-height: 92vh;
      object-fit: contain;
      border-radius:18px;
      display:block;
      margin:16px auto;
      border:6px solid gold;
      background:#fff;
    }
    .btnRow{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:8px 0 18px; }
    button{ border:none; cursor:pointer; padding:10px 14px; border-radius:18px;
            background:linear-gradient(#f6d890,#e8b545); color:#3c2a12; font-weight:800; box-shadow:0 3px 0 #c08c1f; }
    .ghost{ background:#f1e3c5; box-shadow:none; border:2px solid #d9c08a; }
    #logBox{ max-width:740px; margin:0 auto 20px; padding:0 12px; text-align:left; font-size:13px; line-height:1.35; opacity:.9; }
    .small{ font-size:12px; opacity:.75; margin-bottom:10px; }
  </style>
</head>
<body>
  <h2>看紅包</h2>
  <img id="imgVerse" alt="經句紅包" />

  <div class="btnRow">
    <button id="btnNext">下一位</button>
    <button id="btnBack" class="ghost">返回（不前進）</button>
    <button id="btnDownload" class="ghost">下載 PNG</button>
  </div>

  <div id="logBox"></div>

<script>
/* 子目錄安全路徑 */
const BASE_PATH = (() => {
  const base = location.pathname.replace(/\/[^\/]*$/, "");
  return base || "";
})();
const ASSET = (p) => `${BASE_PATH}/${p}`.replace(/\/{2,}/g,"/");

const img = document.getElementById("imgVerse");
const params = new URLSearchParams(location.search);
const no = params.get("no");

if (!no) {
  alert("缺少經句編號（no），請返回重新打開紅包");
} else {
  img.src = ASSET("cards/" + String(no).padStart(3,"0") + ".png");
}

/* 手機音效解鎖（viewer 這裡只做一次，不會自動播放） */
document.body.addEventListener("pointerdown", () => {
  const a = new Audio(ASSET("audio/win.mp3"));
  a.muted = true;
  a.play().then(()=>{ a.pause(); a.currentTime=0; }).catch(()=>{});
}, { once:true });

/* 下一位：通知 index 前進 */
document.getElementById("btnNext").onclick = () => {
  sessionStorage.setItem("BC_RETURN", "NEXT");
  window.location.href = "index.html";
};

/* 返回不前進：回到 index 保持 VIEWER_READY */
document.getElementById("btnBack").onclick = () => {
  sessionStorage.setItem("BC_RETURN", "BACK");
  window.location.href = "index.html";
};

/* 下載 PNG（保命版） */
let downloading = false;
document.getElementById("btnDownload").onclick = async () => {
  if (downloading) return;
  downloading = true;

  try {
    if (!img.complete) await new Promise(res => { img.onload = res; img.onerror = res; });

    const canvas = document.createElement("canvas");
    const w = img.naturalWidth || 720;
    const h = img.naturalHeight || 1280;
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, w, h);

    const filename = `Blessing_${String(no).padStart(3,"0")}.png`;

    canvas.toBlob(blob => {
      if (!blob) { alert("瀏覽器不支援圖片下載，請改用截圖"); downloading=false; return; }
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      downloading = false;
    });
  } catch(e){
    console.error(e);
    alert("圖片下載失敗，請查看 console");
    downloading = false;
  }
};

/* 抽籤紀錄顯示（最新在上） */
const logBox = document.getElementById("logBox");
let logs = [];
try{ logs = JSON.parse(localStorage.getItem("drawLogs") || "[]"); }catch(e){}
if (!Array.isArray(logs)) logs = [];

logBox.innerHTML = `
  <div class="small">抽籤紀錄（最新在上）：</div>
  ${logs.slice().reverse().map(l => `[${l.time}] 「${l.name}」 → 抽中經句紅包: ${l.no}`).join("<br>")}
`;
</script>
</body>
</html>
