<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans TC",system-ui;
  background:#fbf2df;
  text-align:center;
  margin:0;
  padding:16px;
  color:#5b3a00;
}

/* ===== ä¸Šæ–¹ Logo ===== */
.logo{
  width:220px;
  margin:10px auto 0;
  display:block;
}

/* ===== å§“åè¼¸å…¥ & æŒ‰éˆ•åˆ— ===== */
#nameInput{
  width:90%;
  max-width:480px;
  padding:10px 14px;
  margin-top:10px;
  border-radius:10px;
  border:2px solid #e3c78c;
  font-size:18px;
  text-align:center;
  box-sizing:border-box;
  outline:none;
}
#nameInput:focus{
  box-shadow:0 0 0 3px rgba(227,199,140,0.6);
}

.btn-row{
  margin-top:10px;
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
}

.btn{
  min-width:110px;
  padding:8px 16px;
  border-radius:999px;
  border:none;
  background:#f4b63a;
  color:#5b3a00;
  font-size:15px;
  font-weight:600;
  box-shadow:0 3px 0 #d59b25;
  cursor:pointer;
}
.btn:active{
  transform:translateY(1px);
  box-shadow:0 1px 0 #d59b25;
}
.btn:disabled{
  background:#f0ddaa;
  box-shadow:0 3px 0 #d3c18a;
  color:#a08c60;
  cursor:not-allowed;
}

/* ===== è½‰ç›¤å€ ===== */
#wheel-container{
  position:relative;
  width:360px;
  height:360px;
  margin:18px auto 4px;
}

#wheel{
  width:360px;
  height:360px;
  border-radius:50%;
}

#hl-svg{
  position:absolute;
  left:0;
  top:0;
  width:360px;
  height:360px;
  pointer-events:none;
}

/* é«˜äº®é–ƒçˆ */
.blink{
  animation:blink .55s ease-in-out infinite alternate;
}
@keyframes blink{
  from{opacity:1;}
  to{opacity:.25;}
}

/* ç‹€æ…‹èˆ‡çµæœ */
#status{
  margin-top:4px;
  font-size:14px;
  color:#666;
}

#result{
  white-space:pre-line;
  margin-top:6px;
  font-size:16px;
}
</style>
</head>

<body>

<img src="logo3524.png" class="logo" alt="cover">

<h2>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆæ‡‰è¨±ç­‰æ‚¨æ‹¿ï¼‰</h2>

<input id="nameInput" type="text"
       placeholder="è«‹è¼¸å…¥å§“å, å¯ç”¨ç©ºç™½æˆ–é€—è™Ÿåˆ†éš”">

<div class="btn-row">
  <button id="lockBtn"  class="btn">é–å®šåå–®</button>
  <button id="spinBtn"  class="btn" disabled>é–‹å§‹æŠ½å§“åï¼‹ç¶“å¥</button>
  <button id="resetBtn" class="btn">å…¨éƒ¨æ­¸é›¶</button>
  <button id="pdfBtn"   class="btn">æŠ½ç±¤ç´€éŒ„ PDF</button>
</div>

<div id="wheel-container">
  <canvas id="wheel" width="360" height="360"></canvas>
  <svg id="hl-svg" viewBox="0 0 360 360"></svg>
</div>

<!-- ç‹€æ…‹é¡¯ç¤ºï¼šè½‰ç›¤ä¸‹æ–¹ -->
<div id="status">è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®</div>

<!-- æŠ½ä¸­çµæœé¡¯ç¤ºåœ¨æœ€åº•ä¸‹ -->
<div id="result"></div>

<audio id="drum" preload="auto">
  <source src="drum.mp3" type="audio/mpeg">
</audio>

<script>
(function(){

const canvas   = document.getElementById("wheel");
const ctx      = canvas.getContext("2d");
const hlSVG    = document.getElementById("hl-svg");
const drum     = document.getElementById("drum");
const statusEl = document.getElementById("status");
const resultEl = document.getElementById("result");

const CENTER = 180;
const RADIUS = 150;

let names  = [];
let used   = new Set();
let rotation = 0;
let locked   = false;
let spinning = false;

const DURATION   = 7500;
function easeOut(t){ return 1 - Math.pow(1 - t, 3); }

/* ---------- é«˜äº®æ§åˆ¶ï¼šé›¶æ®˜å½± ---------- */
function clearHighlight(){
  hlSVG.innerHTML = "";
  hlSVG.classList.remove("blink");
}

function showHighlight(index){
  if(index == null || names.length === 0) return;

  hlSVG.innerHTML = "";

  const arc    = 2 * Math.PI / names.length;
  const mid    = index * arc + rotation - Math.PI / 2;
  const startA = mid - arc / 2;
  const endA   = mid + arc / 2;

  const x1 = CENTER + RADIUS * Math.cos(startA);
  const y1 = CENTER + RADIUS * Math.sin(startA);
  const x2 = CENTER + RADIUS * Math.cos(endA);
  const y2 = CENTER + RADIUS * Math.sin(endA);

  const p = document.createElementNS("http://www.w3.org/2000/svg","path");
  p.setAttribute("d",
    `M${CENTER} ${CENTER} L${x1} ${y1} A${RADIUS} ${RADIUS} 0 0 1 ${x2} ${y2} Z`);

  /* é«˜äº®é¡è‰²ï¼ˆé–å®šç‚ºæ›´äº®é‡‘è‰²ï¼‰ */
  p.setAttribute("fill","rgba(255,200,0,0.55)");

  hlSVG.appendChild(p);

  setTimeout(()=>hlSVG.classList.add("blink"),30);
}

/* ---------- ç•«è½‰ç›¤ ---------- */
function drawWheel(angle){
  ctx.clearRect(0,0,360,360);

  const n   = names.length || 1;
  const arc = 2 * Math.PI / n;

  ctx.save();
  ctx.translate(CENTER, CENTER);
  ctx.rotate(angle);
  ctx.translate(-CENTER, -CENTER);

  for(let i = 0; i < n; i++){
    const startA = i * arc - Math.PI/2 - arc/2;
    const endA   = startA + arc;

    ctx.beginPath();
    ctx.moveTo(CENTER, CENTER);
    ctx.arc(CENTER, CENTER, RADIUS, startA, endA);
    ctx.closePath();
    ctx.fillStyle = i % 2 ? "#fde6b4" : "#fcdca0";
    ctx.fill();

    ctx.lineWidth = 3;
    ctx.strokeStyle = "#ffffff";
    ctx.stroke();

    ctx.save();
    ctx.translate(CENTER, CENTER);
    ctx.rotate(startA + arc/2);
    ctx.textAlign = "right";
    ctx.font = "18px Noto Sans TC";
    ctx.fillStyle = "#5b3a00";
    ctx.fillText(names[i] || "", RADIUS - 14, 6);
    ctx.restore();
  }

  ctx.restore();
}

/* ---------- æ—‹è½‰é‚è¼¯ ---------- */
function spin(){
  if(!locked){
    alert("è«‹å…ˆé–å®šåå–®");
    return;
  }
  if(spinning) return;

  if(used.size === names.length){
    const total = names.length;
    resultEl.textContent =
      `âœ… å·²æŠ½å‡º ${total}/${total}\n` +
      `ğŸ‰æ­¤è¼ªè½‰ç›¤å·²å®Œæˆæ‰€æœ‰å§“åæŠ½ç±¤`;
    statusEl.textContent = "æœ¬è¼ªå·²å®ŒæˆæŠ½ç±¤";
    return;
  }

  spinning = true;
  statusEl.textContent = "æ—‹è½‰ä¸­â€¦â€¦";

  clearHighlight();

  const remaining = names.filter(n => !used.has(n));
  const winner    = remaining[Math.floor(Math.random() * remaining.length)];
  const idx       = names.indexOf(winner);

  const base   = rotation;
  const spins  = 4.8;
  const arc    = 2 * Math.PI / names.length;
  const delta  = spins * 2 * Math.PI + idx * arc;
  const endRot = base + delta;

  const startTime = performance.now();

  try{
    drum.currentTime = 0;
    drum.play();
  }catch(e){}

  function frame(now){
    let t = (now - startTime) / DURATION;
    if(t > 1) t = 1;

    rotation = base + (endRot - base) * easeOut(t);
    drawWheel(rotation);

    if(t < 1){
      requestAnimationFrame(frame);
    }else{
      rotation = endRot;
      drawWheel(rotation);

      used.add(winner);

      clearHighlight();
      showHighlight(idx);

      const done  = used.size;
      const total = names.length;

      if(done === total){
        resultEl.textContent =
          `ğŸ¯ æŠ½ä¸­ã€Œ${winner}ã€, âœ… å·²æŠ½å‡º ${done}/${total}\n` +
          `ğŸ‰æ­¤è¼ªè½‰ç›¤å·²å®Œæˆæ‰€æœ‰å§“åæŠ½ç±¤`;
        statusEl.textContent = "æœ¬è¼ªå·²å®ŒæˆæŠ½ç±¤";
      }else{
        resultEl.textContent =
          `ğŸ¯ æŠ½ä¸­ã€Œ${winner}ã€, âœ… å·²æŠ½å‡º ${done}/${total}`;
        statusEl.textContent = "åå–®å·²é–å®šï¼Œè«‹é–‹å§‹æŠ½ç±¤";
      }

      spinning = false;
    }
  }

  requestAnimationFrame(frame);
}

/* ---------- UI ---------- */
const nameInput = document.getElementById("nameInput");
const lockBtn   = document.getElementById("lockBtn");
const spinBtn   = document.getElementById("spinBtn");
const resetBtn  = document.getElementById("resetBtn");
const pdfBtn    = document.getElementById("pdfBtn");

lockBtn.onclick = () => {
  const arr = nameInput.value
    .split(/[\s,ï¼Œã€]+/)
    .map(s => s.trim())
    .filter(Boolean);

  if(arr.length < 2){
    alert("è‡³å°‘éœ€è¦ 2 ä½å§“å");
    return;
  }

  const set = new Set(arr);
  if(set.size !== arr.length){
    alert("Oopsï¼Œæœ‰å§“åé‡è¤‡è¼¸å…¥äº†å”·");
    return;
  }

  names  = arr;
  used   = new Set();
  locked = true;
  rotation = 0;

  clearHighlight();
  drawWheel(0);

  spinBtn.disabled = false;
  statusEl.textContent = "åå–®å·²é–å®šï¼Œè«‹é–‹å§‹æŠ½ç±¤";
  resultEl.textContent = "";
};

spinBtn.onclick = spin;

resetBtn.onclick = () => location.reload();

pdfBtn.onclick = () => alert("PDF åŒ¯å‡ºåŠŸèƒ½å°‡åœ¨ä¸‹ä¸€æ­¥åŠ å…¥ã€‚");

drawWheel(0);

})();
</script>

</body>
</html>