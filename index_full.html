<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <script src="fonts_base64.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blessing Cards 128 - æŠ½å§“å & ç¶“å¥</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #fff7e6; /* é‡‘é»ƒç¥ç¦è‰²ç³» */
            font-family: "Noto Sans TC", sans-serif;
            color: #8a5500;
        }

        .container {
            max-width: 900px;
            margin: auto;
            padding: 20px;
            text-align: center;
        }

        .logo {
            width: 120px;
            margin-top: 20px;
        }

        h1 {
            font-size: 32px;
            margin-top: 10px;
            color: #b37500;
        }

        .input-area {
            margin-top: 20px;
            background: #fff3d6;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 0 8px rgba(0,0,0,0.1);
        }

        textarea {
            width: 90%;
            height: 80px;
            font-size: 18px;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #e0c288;
        }

        button {
            background: #ffcc66;
            border: none;
            padding: 12px 22px;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
            margin-top: 12px;
        }
        button:hover {
            background: #ffdd88;
        }

        .switch-btn {
            margin-top: 15px;
            background: #ffd27f;
        }

        .wheel-container {
            margin-top: 35px;
        }

        canvas {
            margin-top: 20px;
            max-width: 300px;
        }
    </style>
</head>
<body>
<div class="container">

    <!-- å°çµ„ LOGO -->
    <img src="logo3524.png" class="logo" alt="3524å°çµ„ Logo" />

    <h1>Blessing Cards 128<br>å§“åæŠ½ç±¤</h1>

    <!-- å§“åè¼¸å…¥å€ -->
    <div class="input-area">
        <p>è«‹è¼¸å…¥å§“åï¼ˆä½¿ç”¨é€—è™Ÿåˆ†éš”ï¼Œç©ºæ ¼å¯æœ‰å¯ç„¡ï¼‰</p>
        <textarea id="nameInput" placeholder="ä¾‹ï¼šå°èŠ³,é˜¿å¼·, å­ç‘„,æ€æ©,Andy"></textarea>
        <br>
        <button onclick="startNameDraw()">é–‹å§‹æŠ½å§“å</button>

        <!-- åˆ‡æ›è‡³åˆ†é¡æŠ½ç±¤ -->
        <br>
        <button class="switch-btn" onclick="window.location='index_category.html'">
            â¤ åˆ‡æ›åˆ°åˆ†é¡æŠ½ç±¤æ¨¡å¼
        </button>
    </div>

    <!-- è½‰ç›¤å€ -->
    <div class="wheel-container">
        <canvas id="nameWheel" width="300" height="300"></canvas>
        <p id="nameResult" style="font-size: 24px; margin-top: 10px;"></p>
    </div>
<script>
/* ----------------------------------------------------
   å§“åè¼¸å…¥è™•ç†
---------------------------------------------------- */
let nameList = [];
let usedNames = [];

function parseNames() {
    const raw = document.getElementById("nameInput").value;

    nameList = raw
        .split(",")               // ä»¥é€—è™Ÿåˆ‡å‰²
        .map(n => n.trim())       // å»é™¤ç©ºç™½
        .filter(n => n.length > 0); // ç§»é™¤ç©ºå­—ä¸²

    // å»é™¤é‡è¤‡å§“å
    nameList = [...new Set(nameList)];
}

/* ----------------------------------------------------
   å§“åè½‰ç›¤è¨­å®š
---------------------------------------------------- */
let canvas = document.getElementById("nameWheel");
let ctx = canvas.getContext("2d");

function drawNameWheel() {
    if (nameList.length === 0) return;

    let arc = (2 * Math.PI) / nameList.length;
    ctx.clearRect(0, 0, 300, 300);

    for (let i = 0; i < nameList.length; i++) {
        let angle = i * arc;

        // æ¯æ ¼äº¤æ›¿é¡è‰²
        ctx.fillStyle = i % 2 === 0 ? "#ffcc66" : "#ffe6a1";
        ctx.beginPath();
        ctx.moveTo(150, 150);
        ctx.arc(150, 150, 150, angle, angle + arc);
        ctx.closePath();
        ctx.fill();

        // å§“åæ–‡å­—
        ctx.save();
        ctx.translate(150,150);
        ctx.rotate(angle + arc / 2);
        ctx.fillStyle = "#8a5500";
        ctx.font = "bold 18px sans-serif";
        ctx.textAlign = "right";
        ctx.fillText(nameList[i], 135, 8);
        ctx.restore();
    }
}

/* ----------------------------------------------------
   æŠ½å§“åæŒ‰éˆ•ï¼ˆä¸»ç¨‹å¼ï¼‰
---------------------------------------------------- */
let isSpinning = false;

function startNameDraw() {
    parseNames();

    if (nameList.length === 0) {
        alert("è«‹å…ˆè¼¸å…¥å§“åï¼");
        return;
    }

    // é‡è¨­å·²ä½¿ç”¨æ¸…å–®
    if (usedNames.length >= nameList.length) {
        usedNames = [];
    }

    drawNameWheel();

    if (isSpinning) return;
    isSpinning = true;

    spinNameWheel();
}

/* ----------------------------------------------------
   éš¨æ©Ÿè§’åº¦ï¼ˆé¿é–‹å‰›å¥½è½åœ¨åˆ†ç•Œç·šï¼‰
---------------------------------------------------- */
function randomSafeAngle(count) {
    let arc = (2 * Math.PI) / count;
    let safeOffset = arc * 0.1;  // é¿å…è²¼è¿‘åˆ†ç•Œç·š

    let index = Math.floor(Math.random() * count);
    let angle = index * arc + (arc / 2) + (Math.random() * safeOffset - safeOffset / 2);

    return { index, angle };
}

/* ----------------------------------------------------
   è½‰å‹•ç•«é¢
---------------------------------------------------- */
function spinNameWheel() {
    let { index, angle } = randomSafeAngle(nameList.length);

    // é¿å…é‡è¤‡æŠ½åˆ°
    while (usedNames.includes(nameList[index])) {
        let tmp = randomSafeAngle(nameList.length);
        index = tmp.index;
        angle = tmp.angle;
    }

    usedNames.push(nameList[index]);

    let totalRotation = angle + Math.PI * 12; // å¤šè½‰å¹¾åœˆ
    let duration = 3300;
    let start = null;

    function animate(ts) {
        if (!start) start = ts;
        let progress = ts - start;

        let ease = Math.pow(progress / duration, 3);
        let current = ease * totalRotation;

        ctx.save();
        ctx.translate(150,150);
        ctx.rotate(current);
        ctx.translate(-150,-150);

        drawNameWheel();
        ctx.restore();

        if (progress < duration) {
            requestAnimationFrame(animate);
        } else {
            finishNameDraw(index);
            isSpinning = false;
        }
    }
    requestAnimationFrame(animate);
}

/* ----------------------------------------------------
   å®Œæˆå§“åæŠ½ç±¤
---------------------------------------------------- */
function finishNameDraw(index) {
    let name = nameList[index];
    document.getElementById("nameResult").innerText =
        "æŠ½ä¸­ï¼š" + name + "ï¼";

    // æ¥è‘—é€²å…¥æŠ½ã€Œç¶“å¥ã€è½‰ç›¤ï¼ˆä¸‹ä¸€æ®µæœƒåŠ å…¥ï¼‰
}
</script>
<script>
/* ----------------------------------------------------
   ç¶“å¥æŠ½ç±¤ï¼ˆ128 PNGï¼š001.png ~ 128.pngï¼‰
---------------------------------------------------- */

let usedVerses = [];   // å·²æŠ½éçš„ç¶“å¥ç·¨è™Ÿï¼ˆé¿å…é‡è¤‡ï¼‰
let totalCards = 128;  // å›ºå®š 128 å¼µå¡ç‰‡

function startVerseDraw() {
    if (usedVerses.length >= totalCards) {
        usedVerses = []; // å…¨éƒ¨æŠ½é â†’ è‡ªå‹•é‡ç½®
    }

    spinVerseWheel();
}

/* ----------------------------------------------------
   ç”¢ç”Ÿ 128 æ ¼æŠ½ç±¤è¼ªç›¤
---------------------------------------------------- */
let verseCanvas = document.createElement("canvas");
verseCanvas.width = 300;
verseCanvas.height = 300;
let vctx = verseCanvas.getContext("2d");

function drawVerseWheel() {
    let arc = (2 * Math.PI) / totalCards;

    for (let i = 0; i < totalCards; i++) {
        let angle = i * arc;

        vctx.fillStyle = i % 2 === 0 ? "#ffe6a1" : "#ffcc66";
        vctx.beginPath();
        vctx.moveTo(150,150);
        vctx.arc(150,150,150, angle, angle + arc);
        vctx.closePath();
        vctx.fill();
    }
}

/* ----------------------------------------------------
   ç¶“å¥æŠ½ç±¤éš¨æ©Ÿè§’åº¦ï¼ˆåŒæ¨£é¿å…è½åˆ†ç•Œç·šï¼‰
---------------------------------------------------- */
function randomSafeVerseAngle() {
    let arc = (2 * Math.PI) / totalCards;
    let safe = arc * 0.1;
    let idx = Math.floor(Math.random() * totalCards);
    let ang = idx * arc + arc/2 + (Math.random()*safe - safe/2);

    return { idx, ang };
}

/* ----------------------------------------------------
   ç¶“å¥è½‰ç›¤å‹•ç•«
---------------------------------------------------- */
function spinVerseWheel() {
    drawVerseWheel();

    let { idx, ang } = randomSafeVerseAngle();

    // é¿å…æŠ½ä¸­å·²æŠ½é
    while (usedVerses.includes(idx+1)) {
        let t = randomSafeVerseAngle();
        idx = t.idx;
        ang = t.ang;
    }

    usedVerses.push(idx+1);

    let totalRot = ang + Math.PI * 10;
    let duration = 3200;
    let start = null;

    function animate(ts) {
        if (!start) start = ts;
        let progress = ts - start;

        let ease = Math.pow(progress / duration, 3);
        let currentRot = ease * totalRot;

        ctx.save();
        ctx.translate(150,150);
        ctx.rotate(currentRot);
        ctx.translate(-150,-150);
        drawVerseWheel();
        ctx.restore();

        if (progress < duration) {
            requestAnimationFrame(animate);
        } else {
            finishVerseDraw(idx+1);
        }
    }
    requestAnimationFrame(animate);
}

/* ----------------------------------------------------
   ç¶“å¥æŠ½ç±¤å®Œæˆ â†’ é¡¯ç¤ºå¡ç‰‡
---------------------------------------------------- */
function finishVerseDraw(no) {
    let padded = no.toString().padStart(3, "0");
    let imgPath = "cards/" + padded + ".png";

    // é¡¯ç¤ºæ–‡å­—æ•ˆæœ
    document.getElementById("nameResult").innerHTML =
        `æŠ½ä¸­ç¶“å¥ï¼š<b>${padded}</b>`;

    // åŠ å…¥å½ˆè·³å‹•ç•«ï¼ˆè®“çµæœæœ‰è·³å‡ºæ•ˆæœï¼‰
    document.getElementById("nameResult").style.animation = "pop 0.5s";

    // 0.5ç§’å¾Œæ‰“é–‹ viewer.html
    setTimeout(() => {
        window.location = `viewer.html?no=${padded}`;
    }, 600);
}

/* ----------------------------------------------------
   CSS å‹•ç•«ï¼šå½ˆè·³ pop
---------------------------------------------------- */
const style = document.createElement("style");
style.innerHTML = `
@keyframes pop {
    0%   { transform: scale(0.5); opacity: 0; }
    70%  { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); }
}
`;
document.head.appendChild(style);

/* ----------------------------------------------------
   é»æ“Šåç¨±æŠ½ç±¤å¾Œ â†’ è‡ªå‹•å‡ºç¾ã€ŒæŠ½ç¶“å¥ã€æŒ‰éˆ•
---------------------------------------------------- */
function finishNameDraw(index) {
    let name = nameList[index];

    document.getElementById("nameResult").innerHTML =
        "æŠ½ä¸­ï¼š" + name + "ï¼";

    // é¡¯ç¤ºæŠ½ç¶“å¥æŒ‰éˆ•
    showVerseButton();
}

/* ----------------------------------------------------
   é¡¯ç¤ºæŠ½ç¶“å¥æŒ‰éˆ•
---------------------------------------------------- */
function showVerseButton() {
    if (!document.getElementById("verseBtn")) {
        let btn = document.createElement("button");
        btn.id = "verseBtn";
        btn.innerText = "é–‹å§‹æŠ½ç¶“å¥";
        btn.style.marginTop = "20px";
        btn.onclick = startVerseDraw;
        document.querySelector(".wheel-container").appendChild(btn);
    }
}
</script>
<!-- ----------------------------------------------------
     ğŸ† ç…™ç«å‹•ç•«ï¼ˆCanvas Fireworksï¼‰
---------------------------------------------------- -->
<canvas id="fireworksCanvas"
        style="position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none;">
</canvas>

<script>
let fwCanvas = document.getElementById("fireworksCanvas");
let fwCtx = fwCanvas.getContext("2d");

function resizeFireworks() {
    fwCanvas.width = window.innerWidth;
    fwCanvas.height = window.innerHeight;
}
resizeFireworks();
window.addEventListener("resize", resizeFireworks);

let fireworks = [];

function launchFirework() {
    let x = Math.random() * fwCanvas.width;
    let y = Math.random() * fwCanvas.height * 0.5;

    fireworks.push({
        x, y, radius: 2,
        color: `hsl(${Math.random()*360}, 100%, 60%)`,
        life: 30 + Math.random()*20
    });
}

function drawFireworks() {
    fwCtx.clearRect(0,0,fwCanvas.width,fwCanvas.height);

    fireworks.forEach((fw, i) => {
        fwCtx.beginPath();
        fwCtx.arc(fw.x, fw.y, fw.radius, 0, Math.PI * 2);
        fwCtx.fillStyle = fw.color;
        fwCtx.fill();

        fw.radius += 2;
        fw.life--;

        if (fw.life <= 0) fireworks.splice(i,1);
    });

    requestAnimationFrame(drawFireworks);
}
drawFireworks();

/* å•Ÿå‹•ç…™ç« */
function startFireworks() {
    for (let i = 0; i < 12; i++) {
        setTimeout(launchFirework, i * 150);
    }
}
</script>

<!-- ----------------------------------------------------
     ğŸª™ é‡‘å¹£æ‰è½å‹•ç•«ï¼ˆCoinsï¼‰
---------------------------------------------------- -->
<style>
.coin {
    position: fixed;
    top: -50px;
    width: 35px;
    pointer-events: none;
    animation: fallCoin linear forwards;
}

@keyframes fallCoin {
    from { transform: translateY(-50px); opacity: 1; }
    to   { transform: translateY(100vh); opacity: 0; }
}
</style>

<script>
function startCoins() {
    for (let i = 0; i < 15; i++) {
        setTimeout(() => {
            let coin = document.createElement("img");
            coin.src = "https://cdn-icons-png.flaticon.com/512/138/138292.png";
            coin.classList.add("coin");
            coin.style.left = Math.random() * window.innerWidth + "px";
            coin.style.animationDuration = (1.5 + Math.random()) + "s";

            document.body.appendChild(coin);

            setTimeout(() => coin.remove(), 2500);
        }, i * 120);
    }
}

/* å•Ÿå‹•æ‰€æœ‰æ…¶ç¥å‹•ç•« */
function celebrate() {
    startFireworks();
    startCoins();
}
</script>

<!-- ----------------------------------------------------
     ğŸ‰ å°‡æ…¶ç¥å‹•ç•«åŠ å…¥æŠ½ç±¤æµç¨‹
---------------------------------------------------- -->

<script>
/* ä¿®æ”¹å§“åæŠ½ç±¤å®Œæˆ */
function finishNameDraw(index) {
    let name = nameList[index];
    document.getElementById("nameResult").innerHTML =
        "æŠ½ä¸­ï¼š" + name + "ï¼";

    celebrate(); // â˜… åŠ å…¥æ…¶ç¥å‹•ç•«

    showVerseButton();
}

/* ä¿®æ”¹ç¶“å¥æŠ½ç±¤å®Œæˆ */
function finishVerseDraw(no) {
    let padded = no.toString().padStart(3, "0");

    document.getElementById("nameResult").innerHTML =
        `æŠ½ä¸­ç¶“å¥ï¼š<b>${padded}</b>`;
    document.getElementById("nameResult").style.animation = "pop 0.5s";

    celebrate(); // â˜… åŠ å…¥æ…¶ç¥å‹•ç•«

    // è·³è½‰ viewer
    setTimeout(() => {
        window.location = `viewer.html?no=${padded}`;
    }, 600);
}
</script>

<!-- ----------------------------------------------------
     é é¢çµå°¾
---------------------------------------------------- -->
</div>
</body>
</html>
