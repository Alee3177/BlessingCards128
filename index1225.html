<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æŠ½ç±¤è½‰ç›¤</title>

<style>
body{
  font-family:"Noto Sans TC",system-ui,-apple-system,sans-serif;
  background:#fbf2df;
  margin:0;
  padding:18px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}
#wrap{position:relative;width:380px}
canvas{display:block;background:#fff0}

button{
  padding:8px 14px;
  border-radius:12px;
  border:1px solid #b58b5a;
  background:white;
}
#namesView{color:#5b3a00}
#result{font-size:18px;color:#8b4b00}
#hint{color:#aa0000;font-size:15px}
</style>
</head>

<body>

<h2>æŠ½ç±¤è½‰ç›¤</h2>

<div>
  <input id="nameInput" style="width:260px" placeholder="è¼¸å…¥å§“åï¼ˆé€—è™Ÿ æˆ– ç©ºç™½åˆ†éš”ï¼‰">
  <button id="lockBtn">é–å®šåå–®</button>
</div>

<div id="namesView"></div>
<div id="hint"></div>

<div id="wrap">
  <canvas id="cv" width="360" height="360"></canvas>
</div>

<button id="spinBtn" disabled>é–‹å§‹æ—‹è½‰</button>

<div id="result"></div>

<audio id="drum" src="drum.mp3"></audio>

<script>
(() => {

// ====== åŸºæœ¬å…ƒä»¶ ======
const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
const CENTER = cv.width/2;
const RADIUS = 150;

let nameList = [];
let locked = false;

let usedNames = [];        // â­ æœ¬è¼ªå·²æŠ½éï¼ˆä¸é‡è¤‡ï¼‰
let isSpinning = false;
let currentRotation = 0;

let selectedIndex = null;
let revealShown = false;
let blinkPhase = 0;

const nameInput = document.getElementById("nameInput");
const lockBtn = document.getElementById("lockBtn");
const namesView = document.getElementById("namesView");
const resultBox = document.getElementById("result");
const spinBtn = document.getElementById("spinBtn");
const hint = document.getElementById("hint");
const drum = document.getElementById("drum");

// ====== è½‰ç›¤ç¹ªè£½ ======
function drawWheel(rotation){
  ctx.clearRect(0,0,cv.width,cv.height);

  if(nameList.length===0) return;

  const count = nameList.length;
  const arc = (Math.PI*2)/count;

  ctx.save();
  ctx.translate(CENTER,CENTER);
  ctx.rotate(rotation);
  ctx.translate(-CENTER,-CENTER);

  for(let i=0;i<count;i++){

    const start = i*arc - Math.PI/2 - arc/2;
    const end = start + arc;

    ctx.beginPath();
    ctx.moveTo(CENTER,CENTER);
    ctx.arc(CENTER,CENTER,RADIUS,start,end);
    ctx.closePath();

    ctx.fillStyle = (i%2===0) ? "#fde7b5" : "#fcdca0";
    ctx.fill();

    ctx.strokeStyle = "#ffffff";
    ctx.lineWidth = 2;
    ctx.stroke();

    // â­ é«˜äº®æ‰‡å½¢ï¼ˆæŒçºŒé–ƒçˆï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡æ—‹è½‰ï¼‰
    if(revealShown && selectedIndex === i){
      const alpha = 0.35 + 0.35*Math.sin(blinkPhase);
      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.fillStyle = "#f5bc00";
      ctx.beginPath();
      ctx.moveTo(CENTER,CENTER);
      ctx.arc(CENTER,CENTER,RADIUS,start,end);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }

    // æ–‡å­—
    ctx.save();
    ctx.translate(CENTER,CENTER);
    const mid = start + arc/2;
    ctx.rotate(mid);
    ctx.textAlign = "right";
    ctx.font = "20px 'Noto Sans TC'";
    ctx.fillStyle = "#5b3a00";
    ctx.fillText(nameList[i], RADIUS-20, 8);
    ctx.restore();
  }

  ctx.restore();
}

// ====== é–ƒçˆå‹•ç•« ======
function animate(){
  if(revealShown){
    blinkPhase += 0.08;
    drawWheel(currentRotation);
  }
  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

// ====== easing ======
function easeOutCubic(t){
  return 1 - Math.pow(1 - t, 3);
}

// ====== é–å®šåå–® ======
lockBtn.onclick = ()=>{

  if(locked){
    // è§£é™¤é–å®š = é‡ç½®
    locked = false;
    nameList=[];
    usedNames=[];
    spinBtn.disabled=true;
    nameInput.disabled=false;
    revealShown=false;

    hint.textContent="";
    resultBox.textContent="";
    namesView.textContent="";
    drawWheel(0);
    return;
  }

  let raw = nameInput.value.trim();
  if(!raw){
    alert("è«‹è¼¸å…¥å§“å");
    return;
  }

  nameList = raw
    .split(/[,ï¼Œ\s]+/)
    .map(s=>s.trim())
    .filter(s=>s);

  // â­ é‡è¤‡å§“åæª¢æŸ¥
  const s = new Set(nameList);
  if(s.size !== nameList.length){
    alert("Oops, æœ‰å§“åé‡è¤‡è¼¸å…¥äº†å”·");
    return;
  }

  locked = true;
  usedNames = []; // â­ æ–°ä¸€è¼ª
  nameInput.disabled = true;

  namesView.textContent="åå–®ï¼š" + nameList.join("ã€");
  hint.textContent="åå–®å·²é–å®šï¼Œè«‹æŒ‰ã€Œé–‹å§‹æ—‹è½‰ã€ã€‚";

  drawWheel(0);
  spinBtn.disabled=false;
};

// ====== æ ¸å¿ƒï¼šæ—‹è½‰ ======
async function spinOnce(){

  if(!locked){
    alert("è«‹å…ˆé–å®šåå–®");
    return;
  }

  if(nameList.length===0){
    alert("æ²’æœ‰åå–®å¯æŠ½");
    return;
  }

  if(isSpinning) return;

  // â­ æœ¬è¼ªæ˜¯å¦å·²æŠ½å®Œ
  if(usedNames.length === nameList.length){
    alert("æœ¬è¼ªå·²å…¨éƒ¨æŠ½å®Œï¼Œè«‹é‡æ–°é–å®šåå–®é–‹å§‹æ–°ä¸€è¼ªã€‚");
    return;
  }

  isSpinning = true;
  revealShown = false;
  resultBox.textContent="æ—‹è½‰ä¸­â€¦";

  // å‰©é¤˜å¯æŠ½
  const pool = nameList.filter(n => !usedNames.includes(n));

  const winner = pool[Math.floor(Math.random()*pool.length)];
  selectedIndex = nameList.indexOf(winner);

  usedNames.push(winner);

  // ===== é¼“è² =====
  drum.currentTime = 0;
  drum.play().catch(()=>{});

  // ===== é«˜äº®èˆ‡çµæœé¡¯ç¤ºæ–¼ 5.5 ç§’ =====
  setTimeout(()=>{
    revealShown = true;
    resultBox.textContent = "ğŸ¯ æŠ½ä¸­ã€Œ" + winner + "ã€";

    // â­ ä¸€è¼ªæŠ½å®Œè‡ªå‹•æç¤º
    if(usedNames.length === nameList.length){
      hint.textContent = "æœ¬è¼ªå·²å®Œæˆï¼Œå…¨éƒ¨äººéƒ½æŠ½éäº†ã€‚";
    }else{
      hint.textContent = "";
    }

  }, 5500);

  // ====== æ—‹è½‰å‹•ç•« ======
  const count = nameList.length;
  const arc = (Math.PI*2)/count;

  const pointerAngle = -Math.PI/2;
  const targetCenter = selectedIndex*arc - Math.PI/2;

  const SPEED_BOOST = 1.35;
  const spins = 4.8 * SPEED_BOOST;

  const desired = pointerAngle - targetCenter + spins*2*Math.PI;

  const start = currentRotation;
  const delta = desired;

  const duration = 7500; // ä½ è¦æ±‚è‡³å°‘ 7 ç§’ä»¥ä¸Š
  const t0 = performance.now();

  function frame(now){
    let t = (now - t0)/duration;
    if(t>1) t=1;

    const eased = easeOutCubic(t);
    const rot = start + delta*eased;

    drawWheel(rot);

    if(t<1){
      requestAnimationFrame(frame);
    }else{
      currentRotation = rot;
      isSpinning = false;
    }
  }

  requestAnimationFrame(frame);
}

spinBtn.onclick = spinOnce;

// åˆå§‹
drawWheel(0);

})();
</script>
</body>
</html>