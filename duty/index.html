<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æŠ½å€¼æ—¥ç”Ÿè¼ªç›¤</title>
  <style>
    :root{
      --bg:#F4F6F7;
      --card:#FFFFFF;
      --ink:#1F2D3D;
      --muted:#607080;
      --line:#E5E9EF;
      --accent:#48C9B0;
      --accent2:#5DADE2;
      --danger:#E74C3C;
      --btn:#2C3E50;
      --btn2:#3B5166;
      --shadow: 0 10px 30px rgba(31,45,61,.10);
      --radius:16px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      color: var(--ink);
    }
    .wrap{
      max-width: 1080px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }
    .header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
    }
    .title{
      display:flex; flex-direction:column; gap:4px;
    }
    h1{font-size:20px; margin:0; letter-spacing:.5px;}
    .sub{font-size:13px; color:var(--muted);}
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
    }
    @media (max-width: 940px){
      .grid{grid-template-columns:1fr;}
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .row > *{flex:0 0 auto;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: #fbfcfd;
      font-size: 13px;
      color: var(--muted);
    }
    .pill strong{color:var(--ink); font-weight:700;}
    textarea{
      width: 100%;
      min-height: 88px;
      resize: vertical;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      outline: none;
      background: #fbfcfd;
      font-size: 14px;
      line-height: 1.4;
    }
    textarea:focus{border-color: rgba(93,173,226,.7); box-shadow: 0 0 0 3px rgba(93,173,226,.15);}
    label{
      display:block;
      font-size: 13px;
      color: var(--muted);
      margin: 4px 0 6px;
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: var(--btn);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
      transition: transform .06s ease, background .15s ease, opacity .15s ease;
    }
    .btn:hover{background: var(--btn2);}
    .btn:active{transform: scale(.98);}
    .btn.secondary{
      background: #fff;
      color: var(--ink);
      border-color: var(--line);
    }
    .btn.secondary:hover{background:#f7f9fb;}
    .btn.danger{
      background: var(--danger);
    }
    .btn:disabled{
      opacity: .45;
      cursor: not-allowed;
      transform:none;
    }
    .toggle{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .radio{
      display:inline-flex; align-items:center; gap:8px;
      padding: 9px 10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background:#fbfcfd;
      cursor:pointer;
      user-select:none;
      font-size:14px;
      color:var(--ink);
    }
    .radio input{accent-color: var(--accent2);}
    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    .wheels{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 940px){
      .wheels{grid-template-columns:1fr;}
    }
    .wheelCard{
      background:#fff;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .wheelHead{
      display:flex; align-items:center; justify-content:space-between;
      gap: 8px;
      margin-bottom: 8px;
    }
    .wheelHead .name{
      font-weight:800;
      letter-spacing:.3px;
    }
    .wheelHead .meta{
      font-size: 12px;
      color: var(--muted);
    }
    canvas{
      width: 100%;
      height: auto;
      display:block;
      border-radius: 14px;
      background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
      border: 1px solid var(--line);
    }

    .status{
      margin-top: 12px;
      background: #ffffff;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }
    .status .big{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .4px;
      color: var(--ink);
    }
    .status .small{
      font-size: 12px;
      color: var(--muted);
    }
    .status .right{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .chip{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(72,201,176,.12);
      color: #136f61;
      border: 1px solid rgba(72,201,176,.25);
      font-size: 12px;
      font-weight: 700;
    }

    .logCard{
      margin-top: 12px;
      background:#fff;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .logHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .logHead .ttl{font-weight:900;}
    table{
      width:100%;
      border-collapse:collapse;
      font-size: 13px;
    }
    th,td{
      border-bottom: 1px solid var(--line);
      padding: 8px 6px;
      text-align:left;
      vertical-align:top;
    }
    th{color:var(--muted); font-weight:800; font-size:12px;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    .muted{color:var(--muted);}
    .empty{
      padding: 10px 0;
      color: var(--muted);
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>æŠ½å€¼æ—¥ç”Ÿè¼ªç›¤</h1>
        <div class="sub">é›™è¼ªç›¤ï¼ˆäºº / æ—¥æœŸï¼‰ï½œæ‰‹å‹•ï¼‹è‡ªå‹•ï¼ˆå¯ä¸­é€”åˆ‡æ›ä½†æ—‹è½‰ä¸­é–å®šï¼‰ï½œæ—¥æœŸç”¨å®Œå³å®Œæˆ</div>
      </div>
      <div class="row">
        <span class="pill">æ—¥æœŸç¸½æ•¸ï¼š<strong id="dateTotal">21</strong></span>
        <span class="pill">å‰©é¤˜æ—¥æœŸï¼š<strong id="dateLeft">0</strong></span>
        <span class="pill">äººæ± ç‹€æ…‹ï¼š<strong id="memberLeft">0</strong></span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div class="toggle" id="modeToggle">
            <label class="radio" title="æ‰‹å‹•ï¼šæ¯æ¬¡æŒ‰éˆ•æŠ½äººâ†’æŠ½æ—¥æœŸ">
              <input type="radio" name="mode" value="manual" checked />
              æ‰‹å‹•æ¨¡å¼
            </label>
            <label class="radio" title="è‡ªå‹•ï¼šæŒ‰è‡ªå‹•é–‹å§‹å¾Œï¼Œå‰©é¤˜æ—¥æœŸå¿«é€Ÿè·‘å®Œ">
              <input type="radio" name="mode" value="auto" />
              è‡ªå‹•æ¨¡å¼ï¼ˆå¿«é€Ÿå‹•ç•«ï¼‰
            </label>
          </div>
          <div class="row">
            <button class="btn secondary" id="btnReset">é‡ç½®ï¼ˆæ¸…ç©ºç´€éŒ„ï¼‰</button>
            <button class="btn danger" id="btnUnlockAudio" title="è‹¥æ‰‹æ©Ÿ/LINEé˜»æ“‹éŸ³æ•ˆï¼Œå…ˆé»æ­¤è§£é–">è§£é–éŸ³æ•ˆ</button>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>ğŸ‘¤ å§“ååå–®ï¼ˆæ¯è¡Œä¸€å€‹ / é€—è™Ÿåˆ†éš”çš†å¯ï¼‰</label>
          <textarea id="inputMembers" placeholder="ä¾‹ï¼š
å°æ˜
å°è¯
å°ç¾"></textarea>
          <div class="hint">é–å®šå¾Œæ‰å¯é–‹å§‹æŠ½ã€‚äººæ•¸å°‘æ–¼æ—¥æœŸæ™‚ï¼ŒæŠ½å®Œä¸€è¼ªæœƒè‡ªå‹•é‡ç½®äººæ± ï¼ˆæ—¥æœŸä¸æœƒé‡ç½®ï¼‰ã€‚</div>
        </div>

        <div style="margin-top:10px;">
          <label>ğŸ“… å€¼æ—¥ç”Ÿæ—¥æœŸï¼ˆå›ºå®š 21 æ¬¡ï¼›ä¸€èˆ¬ä¸ç”¨æ”¹ï¼‰</label>
          <textarea id="inputDates"></textarea>
          <div class="hint">ç¬¬äºŒè¼ªæ—¥æœŸè¼ªç›¤åªé¡¯ç¤ºã€Œå‰©é¤˜æ—¥æœŸã€ã€‚</div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="btnLock">é–å®šåå–®</button>
          <button class="btn secondary" id="btnUnlock">è§£é™¤é–å®š</button>

          <span class="pill">ç‹€æ…‹ï¼š<strong id="sysState">INIT</strong></span>
          <span class="pill">æ¨¡å¼ï¼š<strong id="modeState">manual</strong></span>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="pill">ä½¿ç”¨æ–¹å¼ï¼š<strong>æ‰‹å‹•</strong>ï¼šæŠ½å§“åâ†’æŠ½æ—¥æœŸï¼›<strong>è‡ªå‹•</strong>ï¼šåˆ‡åˆ°è‡ªå‹•å¾Œå†æŒ‰ã€Œè‡ªå‹•é–‹å§‹ã€</div>
            <div class="hint">ä½ å¯ä»¥å…ˆæ‰‹å‹•æŠ½å¹¾æ¬¡ï¼ˆä¾‹å¦‚ 6 æ¬¡ï¼‰ï¼Œå†åˆ‡è‡ªå‹•ï¼ŒæŒ‰ã€Œè‡ªå‹•é–‹å§‹ã€æŠŠå‰©ä¸‹çš„è·‘å®Œã€‚</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="btnSpinMember">æŠ½å§“å</button>
          <button class="btn" id="btnSpinDate">æŠ½æ—¥æœŸ</button>
          <button class="btn" id="btnAutoStart">è‡ªå‹•é–‹å§‹</button>
          <button class="btn secondary" id="btnPdf">æŠ½ç±¤ç´€éŒ„ PDF</button>
        </div>

        <div class="status">
          <div>
            <div class="big" id="resultText">å°šæœªé–‹å§‹</div>
            <div class="small" id="resultSub">è«‹å…ˆé–å®šåå–®</div>
          </div>
          <div class="right">
            <span class="chip" id="chipLocked">æœªé–å®š</span>
            <span class="chip" id="chipAuto">è‡ªå‹•æœªåŸ·è¡Œ</span>
          </div>
        </div>

        <div class="hint" style="margin-top:10px;">
          PDF ç”¢å‡ºä½¿ç”¨ã€Œç€è¦½å™¨åˆ—å°ã€æ–¹å¼ï¼ˆé¿å…ä¸­æ–‡å­—å‹äº‚ç¢¼ï¼‰ã€‚æŒ‰ä¸‹å¾Œæœƒé–‹æ–°è¦–çª—ï¼Œä½ é¸æ“‡ã€Œåˆ—å° / å¦å­˜ç‚º PDFã€å³å¯ã€‚
        </div>
      </div>
    </div>

    <div class="wheels">
      <div class="wheelCard">
        <div class="wheelHead">
          <div class="name">ğŸ‘¤ äººè¼ªç›¤</div>
          <div class="meta">åˆ‡åˆ†ï¼š<span id="memberSlices">0</span>ï½œç›®å‰é¸ä¸­ï¼š<span id="memberPick" class="mono muted">-</span></div>
        </div>
        <canvas id="memberCanvas" width="600" height="600"></canvas>
      </div>

      <div class="wheelCard">
        <div class="wheelHead">
          <div class="name">ğŸ“… æ—¥æœŸè¼ªç›¤</div>
          <div class="meta">åˆ‡åˆ†ï¼š<span id="dateSlices">0</span>ï½œç›®å‰é¸ä¸­ï¼š<span id="datePick" class="mono muted">-</span></div>
        </div>
        <canvas id="dateCanvas" width="600" height="600"></canvas>
      </div>
    </div>

    <div class="logCard">
      <div class="logHead">
        <div class="ttl">æŠ½ç±¤ç´€éŒ„</div>
        <div class="row">
          <span class="pill">ç´€éŒ„ç­†æ•¸ï¼š<strong id="logCount">0</strong></span>
        </div>
      </div>

      <div id="logEmpty" class="empty">å°šç„¡ç´€éŒ„</div>
      <div style="overflow:auto;">
        <table id="logTable" style="display:none;">
          <thead>
            <tr>
              <th style="min-width:120px;">æ™‚é–“</th>
              <th style="min-width:140px;">å§“å</th>
              <th style="min-width:140px;">å€¼æ—¥ç”Ÿæ—¥æœŸ</th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  å›ºå®šæ—¥æœŸï¼ˆç´…å­—ç‰ˆï¼Œ21 æ¬¡ï¼‰
 *  ========================= */
const DUTY_DATES = [
  "2/22",
  "3/15","3/29",
  "4/12","4/26",
  "5/3","5/17",
  "6/7","6/21",
  "7/5","7/19",
  "8/2","8/16",
  "9/6","9/20",
  "10/4","10/18",
  "11/1","11/15",
  "12/6","12/20"
];

/** =========================
 *  å·¥å…·
 *  ========================= */
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

function parseLines(text){
  const raw = (text||"").replace(/\r/g,"\n");
  const parts = raw.split(/[\n,ï¼Œ]+/).map(s=>s.trim()).filter(Boolean);
  // å»é‡ï¼ˆä¿æŒé †åºï¼‰
  const seen = new Set();
  const out = [];
  for (const p of parts){
    if(!seen.has(p)){
      seen.add(p);
      out.push(p);
    }
  }
  return out;
}

function nowStamp(){
  const now = new Date();
  const hh = now.getHours();
  const mm = String(now.getMinutes()).padStart(2,"0");
  const ss = String(now.getSeconds()).padStart(2,"0");
  const period = hh < 12 ? "ä¸Šåˆ" : "ä¸‹åˆ";
  const hour12 = hh % 12 === 0 ? 12 : hh % 12;
  return `${period} ${hour12}:${mm}:${ss}`;
}

function canSwitchMode(){
  return ["READY_MEMBER","READY_DATE","FINISHED","INIT"].includes(state.system);
}

function isBusy(){
  return ["SPIN_MEMBER","SPIN_DATE","AUTO_RUNNING"].includes(state.system);
}

/** =========================
 *  éŸ³æ•ˆï¼ˆå¯é¸ï¼‰ï¼šdun.mp3
 *  ========================= */
let audioUnlocked = false;
let dunAudio = null;

function ensureDun(){
  if(!dunAudio){
    // è‹¥ä½ æ”¾åœ¨ duty/ ä¸‹ï¼Œå°±ç”¨ "dun.mp3"
    // è‹¥æ”¾ repo æ ¹ç›®éŒ„ audio/ï¼Œå°±æ”¹æˆ "../audio/dun.mp3"
    dunAudio = new Audio("dun.mp3");
    dunAudio.preload = "auto";
  }
  return dunAudio;
}

async function unlockAudio(){
  try{
    const a = ensureDun();
    // ä»¥æ¥µçŸ­æ’­æ”¾æ–¹å¼è§£é–ï¼ˆéƒ¨åˆ†ç€è¦½å™¨ä»å¯èƒ½é˜»æ“‹ï¼Œä½†å¤šæ•¸å¯è¡Œï¼‰
    a.volume = 0.001;
    await a.play();
    a.pause();
    a.currentTime = 0;
    a.volume = 1.0;
    audioUnlocked = true;
    setResultSub("éŸ³æ•ˆå·²è§£é–ï¼ˆè‹¥ä»ç„¡è²ï¼Œè«‹å†é»ä¸€æ¬¡ï¼‰");
  }catch(e){
    audioUnlocked = false;
    setResultSub("éŸ³æ•ˆä»å¯èƒ½è¢«é˜»æ“‹ï¼ˆè«‹åœ¨åŒé é¢å†é»ä¸€æ¬¡ï¼‰");
  }
}

function playDun(){
  try{
    const a = ensureDun();
    a.currentTime = 0;
    a.play().catch(()=>{});
  }catch(e){}
}

/** =========================
 *  ç‹€æ…‹
 *  ========================= */
const state = {
  locked: false,
  mode: "manual",
  system: "INIT",

  members: [],
  availableMembers: [],
  dates: [],
  availableDates: [],

  selectedMember: null,
  selectedDate: null,

  logs: [],

  memberWheel: { angle: 0, spinning: false },
  dateWheel:   { angle: 0, spinning: false },

  autoRequested: false
};

/** =========================
 *  DOM
 *  ========================= */
const el = {
  dateTotal: document.getElementById("dateTotal"),
  dateLeft: document.getElementById("dateLeft"),
  memberLeft: document.getElementById("memberLeft"),

  inputMembers: document.getElementById("inputMembers"),
  inputDates: document.getElementById("inputDates"),

  btnLock: document.getElementById("btnLock"),
  btnUnlock: document.getElementById("btnUnlock"),
  btnReset: document.getElementById("btnReset"),
  btnUnlockAudio: document.getElementById("btnUnlockAudio"),

  btnSpinMember: document.getElementById("btnSpinMember"),
  btnSpinDate: document.getElementById("btnSpinDate"),
  btnAutoStart: document.getElementById("btnAutoStart"),
  btnPdf: document.getElementById("btnPdf"),

  sysState: document.getElementById("sysState"),
  modeState: document.getElementById("modeState"),

  chipLocked: document.getElementById("chipLocked"),
  chipAuto: document.getElementById("chipAuto"),

  resultText: document.getElementById("resultText"),
  resultSub: document.getElementById("resultSub"),

  memberCanvas: document.getElementById("memberCanvas"),
  dateCanvas: document.getElementById("dateCanvas"),

  memberSlices: document.getElementById("memberSlices"),
  dateSlices: document.getElementById("dateSlices"),
  memberPick: document.getElementById("memberPick"),
  datePick: document.getElementById("datePick"),

  logCount: document.getElementById("logCount"),
  logEmpty: document.getElementById("logEmpty"),
  logTable: document.getElementById("logTable"),
  logBody: document.getElementById("logBody"),

  modeToggle: document.getElementById("modeToggle")
};

el.inputDates.value = DUTY_DATES.join("\n");
el.dateTotal.textContent = String(DUTY_DATES.length);

/** =========================
 *  UI æ›´æ–°
 *  ========================= */
function setSystem(s){
  state.system = s;
  el.sysState.textContent = s;
  updateButtons();
}

function setMode(m){
  state.mode = m;
  el.modeState.textContent = m;
  el.chipAuto.textContent = (m === "auto") ? "è‡ªå‹•æ¨¡å¼å·²é¸æ“‡" : "è‡ªå‹•æœªåŸ·è¡Œ";
}

function setLocked(v){
  state.locked = v;
  el.chipLocked.textContent = v ? "å·²é–å®š" : "æœªé–å®š";
  el.chipLocked.style.background = v ? "rgba(93,173,226,.12)" : "rgba(231,76,60,.10)";
  el.chipLocked.style.borderColor = v ? "rgba(93,173,226,.25)" : "rgba(231,76,60,.22)";
  el.chipLocked.style.color = v ? "#1c5b86" : "#a03a2d";
  updateButtons();
}

function setResult(text){
  el.resultText.textContent = text;
}
function setResultSub(text){
  el.resultSub.textContent = text;
}

function updateCounters(){
  el.dateLeft.textContent = String(state.availableDates.length);
  el.memberLeft.textContent = String(state.availableMembers.length);

  el.memberSlices.textContent = String(state.availableMembers.length);
  el.dateSlices.textContent = String(state.availableDates.length);

  el.memberPick.textContent = state.selectedMember ?? "-";
  el.datePick.textContent = state.selectedDate ?? "-";
}

function updateButtons(){
  const locked = state.locked;
  const busy = isBusy();

  // mode radios
  const radios = el.modeToggle.querySelectorAll('input[type="radio"]');
  radios.forEach(r => {
    r.disabled = !canSwitchMode(); // æ—‹è½‰ä¸­ä¸å¯åˆ‡
  });

  el.btnLock.disabled = busy;
  el.btnUnlock.disabled = busy;

  el.btnSpinMember.disabled = !locked || busy || state.availableMembers.length === 0 || state.availableDates.length === 0 || state.system !== "READY_MEMBER";
  el.btnSpinDate.disabled   = !locked || busy || state.selectedMember == null || state.availableDates.length === 0 || state.system !== "READY_DATE";

  // è‡ªå‹•é–‹å§‹ï¼šå¿…é ˆé¸ auto ä¸”åœ¨å¯é–‹å§‹ç‹€æ…‹
  const canAutoStart = locked && !busy && state.mode === "auto" && state.availableDates.length > 0 && ["READY_MEMBER","READY_DATE"].includes(state.system);
  el.btnAutoStart.disabled = !canAutoStart;

  // PDFï¼šæœ‰ç´€éŒ„æ‰å¯
  el.btnPdf.disabled = state.logs.length === 0 || busy;

  // Resetï¼šå¿™ç¢Œæ™‚ä¸çµ¦æŒ‰
  el.btnReset.disabled = busy;
}

function renderLogs(){
  el.logCount.textContent = String(state.logs.length);
  if(state.logs.length === 0){
    el.logEmpty.style.display = "block";
    el.logTable.style.display = "none";
    return;
  }
  el.logEmpty.style.display = "none";
  el.logTable.style.display = "table";
  el.logBody.innerHTML = "";
  for(const it of state.logs){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${escapeHtml(it.time)}</td>
      <td>ã€Œ${escapeHtml(it.member)}ã€</td>
      <td>ã€Œ${escapeHtml(it.date)}ã€</td>
    `;
    el.logBody.appendChild(tr);
  }
}

function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** =========================
 *  Wheel drawing
 *  ========================= */
function getCtx(canvas){
  const ctx = canvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;
  // ä¿æŒ canvas æ¸…æ™°
  const cssW = canvas.clientWidth;
  const cssH = canvas.clientWidth; // æ­£æ–¹
  const size = Math.min(cssW, cssH);
  canvas.style.height = size + "px";
  canvas.width  = Math.round(size * dpr);
  canvas.height = Math.round(size * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return ctx;
}

function drawWheel(canvas, labels, angle, theme){
  const ctx = canvas.getContext("2d");
  const W = canvas.clientWidth;
  const H = canvas.clientWidth;
  const cx = W/2, cy = H/2;
  const r = Math.min(W,H) * 0.46;

  // clear
  ctx.clearRect(0,0,W,H);

  // base circle
  ctx.beginPath();
  ctx.arc(cx,cy,r+8,0,Math.PI*2);
  ctx.fillStyle = "rgba(31,45,61,.04)";
  ctx.fill();

  // no data
  if(!labels || labels.length === 0){
    ctx.beginPath();
    ctx.arc(cx,cy,r,0,Math.PI*2);
    ctx.fillStyle = "#ffffff";
    ctx.fill();
    ctx.strokeStyle = "rgba(96,112,128,.25)";
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.fillStyle = "rgba(96,112,128,.8)";
    ctx.font = "700 16px system-ui, -apple-system, 'Noto Sans TC', sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("ï¼ˆç„¡è³‡æ–™ï¼‰", cx, cy);
    drawPointer(ctx, cx, cy, r);
    return;
  }

  const n = labels.length;
  const step = Math.PI*2 / n;

  // slices
  for(let i=0;i<n;i++){
    const a0 = angle + i*step;
    const a1 = a0 + step;

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,a0,a1,false);
    ctx.closePath();

    const color = (i%2===0) ? theme.c1 : theme.c2;
    ctx.fillStyle = color;
    ctx.fill();

    ctx.strokeStyle = "rgba(255,255,255,.65)";
    ctx.lineWidth = 1;
    ctx.stroke();

    // text
    const mid = (a0+a1)/2;
    const tx = cx + Math.cos(mid) * (r*0.70);
    const ty = cy + Math.sin(mid) * (r*0.70);

    ctx.save();
    ctx.translate(tx,ty);
    ctx.rotate(mid + Math.PI/2);

    ctx.fillStyle = theme.text;
    ctx.font = "700 14px system-ui, -apple-system, 'Noto Sans TC', sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    let t = labels[i];
    // å¤ªé•·å°±æˆªæ–·
    if(t.length > 10) t = t.slice(0,10) + "â€¦";
    ctx.fillText(t, 0, 0);

    ctx.restore();
  }

  // center
  ctx.beginPath();
  ctx.arc(cx,cy,r*0.18,0,Math.PI*2);
  ctx.fillStyle = "#ffffff";
  ctx.fill();
  ctx.strokeStyle = "rgba(96,112,128,.25)";
  ctx.lineWidth = 2;
  ctx.stroke();

  // center label
  ctx.fillStyle = "rgba(31,45,61,.75)";
  ctx.font = "800 14px system-ui, -apple-system, 'Noto Sans TC', sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(theme.center, cx, cy);

  drawPointer(ctx, cx, cy, r);
}

function drawPointer(ctx, cx, cy, r){
  // pointer at top (12 o'clock), pointing inward
  const px = cx;
  const py = cy - r - 10;

  ctx.save();
  // small shadow
  ctx.beginPath();
  ctx.moveTo(px, py + 6);
  ctx.lineTo(px - 14, py + 34);
  ctx.lineTo(px + 14, py + 34);
  ctx.closePath();
  ctx.fillStyle = "rgba(31,45,61,.12)";
  ctx.fill();

  // pointer
  ctx.beginPath();
  ctx.moveTo(px, py);
  ctx.lineTo(px - 14, py + 28);
  ctx.lineTo(px + 14, py + 28);
  ctx.closePath();
  ctx.fillStyle = "#ffffff";
  ctx.fill();
  ctx.strokeStyle = "rgba(96,112,128,.35)";
  ctx.lineWidth = 1.5;
  ctx.stroke();
  ctx.restore();
}

const THEME_MEMBER = {
  c1: "rgba(93,173,226,.85)",
  c2: "rgba(72,201,176,.80)",
  text: "#ffffff",
  center: "äºº"
};
const THEME_DATE = {
  c1: "rgba(93,173,226,.55)",
  c2: "rgba(244,246,247,1)",
  text: "rgba(31,45,61,.85)",
  center: "æ—¥"
};

function resizeCanvases(){
  // è®“ canvas ä»¥ clientWidth è¨­å®šç¹ªåœ–åº§æ¨™ï¼ˆæˆ‘å€‘ç”¨ CSS å¤§å°ä½œç‚ºç¹ªåœ–åº§æ¨™ï¼‰
  [el.memberCanvas, el.dateCanvas].forEach(c=>{
    const ctx = c.getContext("2d");
    const dpr = window.devicePixelRatio || 1;
    const size = Math.min(c.clientWidth, c.clientWidth);
    c.style.height = size + "px";
    c.width  = Math.round(size * dpr);
    c.height = Math.round(size * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  });
}

function redrawAll(){
  resizeCanvases();

  // é‡è¦ï¼šæˆ‘å€‘ä½¿ç”¨ canvas çš„ã€ŒCSSåº§æ¨™ã€ä½œç‚ºç¹ªåœ–åº§æ¨™ï¼ˆtransform å·²è¨­å®šç‚º dprï¼‰
  // æ‰€ä»¥åœ¨ drawWheel å…§ç”¨ clientWidth ç•¶ W/Hã€‚
  drawWheel(
    el.memberCanvas,
    state.availableMembers,
    state.memberWheel.angle,
    THEME_MEMBER
  );
  drawWheel(
    el.dateCanvas,
    state.availableDates,
    state.dateWheel.angle,
    THEME_DATE
  );
}

window.addEventListener("resize", ()=>{
  redrawAll();
});

let rafId = null;
function tick(){
  // è½‰å‹•ï¼ˆè‹¥æ—‹è½‰ä¸­ï¼‰
  if(state.memberWheel.spinning){
    state.memberWheel.angle += state.memberWheel.v;
    state.memberWheel.v *= state.memberWheel.friction;
  }
  if(state.dateWheel.spinning){
    state.dateWheel.angle += state.dateWheel.v;
    state.dateWheel.v *= state.dateWheel.friction;
  }

  redrawAll();
  rafId = requestAnimationFrame(tick);
}

/** =========================
 *  é¸å– indexï¼ˆæŒ‡é‡åœ¨ 12 é»æ–¹å‘ï¼‰
 *  ========================= */
function pickIndex(labels, angle){
  const n = labels.length;
  if(n <= 0) return -1;
  const step = Math.PI * 2 / n;

  // æŒ‡é‡æ–¹å‘ = -90degï¼ˆ12é»ï¼‰
  // æˆ‘å€‘è¦æ‰¾æŒ‡é‡è½åœ¨å“ªå€‹ sliceï¼šæŠŠæŒ‡é‡è§’åº¦æ›åˆ°è¼ªç›¤è§’åº¦åº§æ¨™
  // slice i ç¯„åœï¼š[angle + i*step, angle+(i+1)*step)
  // æŒ‡é‡è§’åº¦ç‚º -PI/2ï¼Œå› æ­¤æ±‚ (pointerAngle - angle) / step
  const pointer = -Math.PI/2;

  let x = (pointer - angle) / step;
  // è½‰ç‚º 0..n-1 çš„ index
  let idx = Math.floor((x % n + n) % n);
  // ä¿®æ­£ï¼šæˆ‘å€‘ slice æ˜¯ä»¥ angle + i*step èµ°ï¼Œidx å³ç‚ºé¸ä¸­ i
  return idx;
}

/** =========================
 *  Spin æ§åˆ¶ï¼ˆrAFï¼‰
 *  ========================= */
async function spinMember(durationMs=600){
  if(!state.locked) return;
  if(state.system !== "READY_MEMBER") return;
  if(state.availableMembers.length === 0) return;
  if(state.availableDates.length === 0) return;

  setSystem("SPIN_MEMBER");
  state.memberWheel.spinning = true;
  state.memberWheel.v = 0.38 + Math.random()*0.20;
  state.memberWheel.friction = 0.985;

  // å›ºå®šæ™‚é–“å¾Œåœæ­¢
  await sleep(durationMs);
  state.memberWheel.spinning = false;

  // å–çµæœ
  const idx = pickIndex(state.availableMembers, state.memberWheel.angle);
  state.selectedMember = state.availableMembers[idx] ?? null;
  updateCounters();

  // é€²å…¥ä¸‹ä¸€æ­¥
  setSystem("READY_DATE");
  setResult(`æŠ½ä¸­ã€Œ${state.selectedMember}ã€`);
  setResultSub("è«‹æŠ½æ—¥æœŸ");
}

async function spinDate(durationMs=600){
  if(!state.locked) return;
  if(state.system !== "READY_DATE") return;
  if(state.availableDates.length === 0) return;
  if(!state.selectedMember) return;

  setSystem("SPIN_DATE");
  state.dateWheel.spinning = true;
  state.dateWheel.v = 0.38 + Math.random()*0.20;
  state.dateWheel.friction = 0.985;

  await sleep(durationMs);
  state.dateWheel.spinning = false;

  // å–çµæœ
  const idx = pickIndex(state.availableDates, state.dateWheel.angle);
  state.selectedDate = state.availableDates[idx] ?? null;
  updateCounters();

  // å®Œæˆä¸€æ¬¡åˆ†é…
  finalizeAssignment(state.selectedMember, state.selectedDate);
}

/** =========================
 *  å®Œæˆä¸€æ¬¡ï¼šè¨˜éŒ„ + ç§»é™¤ + ç‹€æ…‹åˆ¤æ–·
 *  ========================= */
function finalizeAssignment(member, date){
  if(!member || !date) {
    setResult("çµæœç•°å¸¸ï¼ˆmember/date ç‚ºç©ºï¼‰");
    setResultSub("è«‹é‡ç½®å¾Œå†è©¦");
    setSystem("READY_MEMBER");
    return;
  }

  // é¡¯ç¤ºä¸­å¤®çµæœï¼ˆæŒ‡å®šï¼šåªé¡¯ç¤ºä¸€è¡Œã€Œå€¼æ—¥ç”Ÿã€Œæ—¥æœŸã€ã€ï¼‰
  setResult(`å€¼æ—¥ç”Ÿã€Œ${date}ã€`);
  setResultSub(`å§“åï¼š${member}`);

  // éŸ³æ•ˆï¼ˆå¯é¸ï¼‰
  playDun();

  // è¨˜éŒ„
  const time = nowStamp();
  state.logs.push({ time, member, date });
  renderLogs();

  // ç§»é™¤äºº
  state.availableMembers = state.availableMembers.filter(n => n !== member);

  // ç§»é™¤æ—¥æœŸ
  state.availableDates = state.availableDates.filter(d => d !== date);

  // æ¸…ç©ºæš«å­˜é¸ä¸­
  state.selectedMember = null;
  state.selectedDate = null;

  updateCounters();

  // å®Œæˆåˆ¤æ–·
  if(state.availableDates.length === 0){
    setSystem("FINISHED");
    setResult("ğŸ‰ å…¨å¹´åº¦å€¼æ—¥ç”Ÿåˆ†é…å®Œæˆ");
    setResultSub("å¯ä¸‹è¼‰ PDFï¼Œæˆ–æŒ‰é‡ç½®é‡æ–°é–‹å§‹");
    el.chipAuto.textContent = "å®Œæˆ";
    updateButtons();
    return;
  }

  // è‹¥äººæ± ç”¨å®Œ â†’ é‡ç½®
  if(state.availableMembers.length === 0){
    state.availableMembers = [...state.members];
  }

  // å›åˆ°ç¬¬ä¸€è¼ª
  setSystem("READY_MEMBER");
  setResult("è«‹æŠ½å§“å");
  setResultSub("æ‰‹å‹•ï¼šæŒ‰æŠ½å§“åï¼›è‡ªå‹•ï¼šåˆ‡åˆ°è‡ªå‹•å¾ŒæŒ‰è‡ªå‹•é–‹å§‹");
}

/** =========================
 *  è‡ªå‹•æ¨¡å¼ï¼ˆé›™è¼ªç›¤å¿«é€Ÿå‹•ç•«ï¼‰
 *  ========================= */
async function runAuto(){
  if(!state.locked) return;
  if(state.mode !== "auto") return;
  if(isBusy()) return;
  if(state.availableDates.length === 0) return;

  // åªèƒ½å¾ READY_MEMBER / READY_DATE é–‹å§‹
  if(!["READY_MEMBER","READY_DATE"].includes(state.system)) return;

  setSystem("AUTO_RUNNING");
  el.chipAuto.textContent = "è‡ªå‹•åŸ·è¡Œä¸­â€¦";
  updateButtons();

  // è‹¥åœ¨ READY_DATEï¼ˆä»£è¡¨å·²æŠ½åˆ°äººä½†å°šæœªæŠ½æ—¥æœŸï¼‰â€”â€”
  // æˆç†Ÿåšæ³•ï¼šå…ˆè£œæŠ½æ—¥æœŸä¸€æ¬¡ï¼Œç„¶å¾Œå†é€² while
  if(state.system === "AUTO_RUNNING"){
    // nothing
  }

  // è‡ªå‹•å¾ªç’°ï¼šæ¯æ¬¡è¦æŠ½ã€Œä¸€å€‹äºº + ä¸€å€‹æ—¥æœŸã€
  while(state.availableDates.length > 0){

    // è‹¥äººæ± ç©º â†’ é‡ç½®
    if(state.availableMembers.length === 0){
      state.availableMembers = [...state.members];
    }

    // è‹¥ç›®å‰ä¸åœ¨ READY_MEMBERï¼Œå¼·åˆ¶å›åˆ° READY_MEMBERï¼ˆä¿è­·ï¼‰
    if(state.system !== "AUTO_RUNNING"){
      // ç†è«–ä¸Šä¸æœƒç™¼ç”Ÿï¼›ä¿è­·ç”¨
      setSystem("AUTO_RUNNING");
    }

    // Step 1: spin member
    // è‡ªå‹•æ¨¡å¼ä¹Ÿè¦é¡¯ç¤ºè¼ªç›¤å‹•ä½œï¼Œå› æ­¤æˆ‘å€‘ç›´æ¥èµ° spinMember å…§çš„æ—‹è½‰æ–¹å¼ï¼Œ
    // ä½†ä¸èµ°å®ƒçš„ç‹€æ…‹æ©Ÿï¼ˆæˆ‘å€‘ç”¨ AUTO_RUNNINGï¼‰
    // => æ‰‹å‹• spinMember æœƒåˆ‡ç‹€æ…‹åˆ° READY_DATEï¼Œé€™è£¡ä¸é©ç”¨ï¼Œæ‰€ä»¥åšä¸€å€‹ autoSpinMember
    await autoSpinMember(550);

    // Step 2: spin date
    await autoSpinDate(550);

    // Step 3: finalize
    finalizeAssignment(state.selectedMember, state.selectedDate);

    // finalize æœƒæŠŠ system è¨­ç‚º READY_MEMBER æˆ– FINISHED
    // æˆ‘å€‘åœ¨è‡ªå‹•æ¨¡å¼è¦ä¿æŒ AUTO_RUNNING ç‹€æ…‹ç›´åˆ°çµæŸ
    if(state.availableDates.length === 0){
      break;
    }

    // æŠŠ system æ‹‰å› AUTO_RUNNINGï¼ˆé¿å… finalize è¨­ READY_MEMBERï¼‰
    state.system = "AUTO_RUNNING";
    el.sysState.textContent = "AUTO_RUNNING";
    updateButtons();

    await sleep(350);
  }

  // çµæŸ
  setSystem("FINISHED");
  el.chipAuto.textContent = "å®Œæˆ";
  updateButtons();
}

async function autoSpinMember(durationMs=550){
  state.memberWheel.spinning = true;
  state.memberWheel.v = 0.42 + Math.random()*0.18;
  state.memberWheel.friction = 0.985;
  await sleep(durationMs);
  state.memberWheel.spinning = false;

  const idx = pickIndex(state.availableMembers, state.memberWheel.angle);
  state.selectedMember = state.availableMembers[idx] ?? null;
  el.memberPick.textContent = state.selectedMember ?? "-";
}

async function autoSpinDate(durationMs=550){
  state.dateWheel.spinning = true;
  state.dateWheel.v = 0.42 + Math.random()*0.18;
  state.dateWheel.friction = 0.985;
  await sleep(durationMs);
  state.dateWheel.spinning = false;

  const idx = pickIndex(state.availableDates, state.dateWheel.angle);
  state.selectedDate = state.availableDates[idx] ?? null;
  el.datePick.textContent = state.selectedDate ?? "-";
}

/** =========================
 *  Lock / Reset / PDF
 *  ========================= */
function lockLists(){
  const members = parseLines(el.inputMembers.value);
  const dates = parseLines(el.inputDates.value);

  if(members.length < 1){
    setResult("è«‹å…ˆè¼¸å…¥å§“ååå–®");
    setResultSub("æ¯è¡Œä¸€å€‹å§“å");
    return;
  }
  if(dates.length < 1){
    setResult("æ—¥æœŸæ¸…å–®ç‚ºç©º");
    setResultSub("è«‹å¡«å…¥æ—¥æœŸ");
    return;
  }

  state.members = members;
  state.availableMembers = [...members];

  state.dates = dates;
  state.availableDates = [...dates];

  state.logs = [];
  state.selectedMember = null;
  state.selectedDate = null;

  setLocked(true);
  setMode(state.mode || "manual");

  setSystem("READY_MEMBER");
  setResult("è«‹æŠ½å§“å");
  setResultSub("æ‰‹å‹•ï¼šæŒ‰æŠ½å§“åï¼›è‡ªå‹•ï¼šåˆ‡åˆ°è‡ªå‹•å¾ŒæŒ‰è‡ªå‹•é–‹å§‹");

  renderLogs();
  updateCounters();
  redrawAll();
}

function unlockLists(){
  setLocked(false);
  state.system = "INIT";
  el.sysState.textContent = "INIT";
  setResult("å°šæœªé–‹å§‹");
  setResultSub("è«‹å…ˆé–å®šåå–®");
  updateButtons();
  updateCounters();
  redrawAll();
}

function resetAll(){
  if(isBusy()) return;
  // æ¸…ç©ºç´€éŒ„ï¼Œä½†ä¿ç•™è¼¸å…¥æ¡†å…§å®¹
  state.logs = [];
  state.selectedMember = null;
  state.selectedDate = null;

  // é‡ç½®æ± ï¼ˆè‹¥å·²é–å®šï¼‰
  if(state.locked){
    state.availableMembers = [...state.members];
    state.availableDates = [...state.dates];
    setSystem("READY_MEMBER");
    setResult("è«‹æŠ½å§“å");
    setResultSub("æ‰‹å‹•ï¼šæŒ‰æŠ½å§“åï¼›è‡ªå‹•ï¼šåˆ‡åˆ°è‡ªå‹•å¾ŒæŒ‰è‡ªå‹•é–‹å§‹");
  }else{
    setSystem("INIT");
    setResult("å°šæœªé–‹å§‹");
    setResultSub("è«‹å…ˆé–å®šåå–®");
  }
  el.chipAuto.textContent = (state.mode === "auto") ? "è‡ªå‹•æ¨¡å¼å·²é¸æ“‡" : "è‡ªå‹•æœªåŸ·è¡Œ";

  renderLogs();
  updateCounters();
  redrawAll();
}

function exportPdfViaPrint(){
  // ä½¿ç”¨ç€è¦½å™¨åˆ—å°ï¼ˆæœ€ç©©ï¼Œé¿å…ä¸­æ–‡å­—äº‚ç¢¼ï¼‰
  const title = "æŠ½å€¼æ—¥ç”Ÿè¼ªç›¤_æŠ½ç±¤ç´€éŒ„";
  const rows = state.logs.map(it => `
    <tr>
      <td>${escapeHtml(it.time)}</td>
      <td>ã€Œ${escapeHtml(it.member)}ã€</td>
      <td>ã€Œ${escapeHtml(it.date)}ã€</td>
    </tr>
  `).join("");

  const html = `
<!doctype html><html><head>
<meta charset="utf-8"/>
<title>${title}</title>
<style>
  body{font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif; padding:24px;}
  h1{font-size:20px;margin:0 0 10px;}
  .meta{color:#607080;font-size:12px;margin-bottom:14px;}
  table{border-collapse:collapse;width:100%;}
  th,td{border:1px solid #d9e1ea;padding:8px;font-size:13px;text-align:left;}
  th{background:#f3f6f9;}
</style>
</head><body>
<h1>${title}</h1>
<div class="meta">å…± ${state.logs.length} ç­†ï½œåˆ—å°æ™‚é¸æ“‡ã€Œå¦å­˜ç‚º PDFã€å³å¯</div>
<table>
  <thead><tr><th>æ™‚é–“</th><th>å§“å</th><th>å€¼æ—¥ç”Ÿæ—¥æœŸ</th></tr></thead>
  <tbody>${rows}</tbody>
</table>
<script>window.onload=()=>{ setTimeout(()=>window.print(), 250); };<\/script>
</body></html>`;

  const w = window.open("", "_blank");
  if(!w){
    setResultSub("å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹ï¼šè«‹å…è¨±å½ˆå‡ºè¦–çª—å¾Œé‡è©¦");
    return;
  }
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/** =========================
 *  äº‹ä»¶ç¶å®š
 *  ========================= */
el.btnLock.onclick = lockLists;
el.btnUnlock.onclick = unlockLists;
el.btnReset.onclick = resetAll;

el.btnSpinMember.onclick = ()=> spinMember(650);
el.btnSpinDate.onclick = ()=> spinDate(650);

el.btnAutoStart.onclick = ()=> runAuto();

el.btnPdf.onclick = exportPdfViaPrint;

el.btnUnlockAudio.onclick = unlockAudio;

// æ¨¡å¼åˆ‡æ›ï¼ˆå¯ä¸­é€”ï¼Œä½†å¿™ç¢Œ/æ—‹è½‰ä¸­ç¦æ­¢ï¼‰
el.modeToggle.addEventListener("change", (e)=>{
  const t = e.target;
  if(!(t && t.name==="mode")) return;

  if(!canSwitchMode()){
    // å›å¾© UI
    const radios = el.modeToggle.querySelectorAll('input[type="radio"]');
    radios.forEach(r => r.checked = (r.value === state.mode));
    setResultSub("æ—‹è½‰ä¸­ä¸å¯åˆ‡æ›æ¨¡å¼");
    return;
  }

  setMode(t.value);

  // åˆ‡æ›æ¨¡å¼å¾Œä¸è‡ªå‹•é–‹å§‹ï¼ˆä½ é¸ Bï¼‰
  if(state.mode === "auto"){
    setResultSub("å·²åˆ‡æ›è‡ªå‹•æ¨¡å¼ï¼šè«‹æŒ‰ã€Œè‡ªå‹•é–‹å§‹ã€æ‰æœƒåŸ·è¡Œ");
  }else{
    setResultSub("å·²åˆ‡æ›æ‰‹å‹•æ¨¡å¼ï¼šè«‹æŒ‰ã€ŒæŠ½å§“åã€â†’ã€ŒæŠ½æ—¥æœŸã€");
  }
  updateButtons();
});

// åˆå§‹
function init(){
  setMode("manual");
  setLocked(false);
  updateCounters();
  renderLogs();
  redrawAll();
  if(!rafId) rafId = requestAnimationFrame(tick);
}
init();
</script>
</body>
</html>