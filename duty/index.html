<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æŠ½å€¼æ—¥ç”Ÿè¼ªç›¤</title>
  <style>
    :root{
      --bg:#F4F6F7;
      --card:#FFFFFF;
      --ink:#1F2D3D;
      --muted:#607080;
      --line:#E5E9EF;
      --accent:#48C9B0;
      --accent2:#5DADE2;
      --danger:#E74C3C;
      --btn:#2C3E50;
      --btn2:#3B5166;
      --shadow: 0 10px 30px rgba(31,45,61,.10);
      --radius:16px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      color: var(--ink);
    }
    .wrap{
      max-width: 1080px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }
    .header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom: 12px;
    }
    .title{display:flex; flex-direction:column; gap:4px;}
    h1{font-size:24px; margin:0; letter-spacing:.5px;}
    .sub{font-size:14px; color:var(--muted);}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: #fbfcfd;
      font-size: 14px;
      color: var(--muted);
    }
    .pill strong{color:var(--ink); font-weight:800;}
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
    }
    @media (max-width: 940px){
      .grid{grid-template-columns:1fr;}
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    label{
      display:block;
      font-size: 14px;
      color: var(--muted);
      margin: 4px 0 6px;
    }
    textarea{
      width: 100%;
      min-height: 88px;
      resize: vertical;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      outline: none;
      background: #fbfcfd;
      font-size: 14px;
      line-height: 1.4;
    }
    textarea:focus{border-color: rgba(93,173,226,.7); box-shadow: 0 0 0 3px rgba(93,173,226,.15);}
    .hint{
      font-size: 14px;
      color: var(--muted);
      margin-top: 6px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: var(--btn);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
      transition: transform .06s ease, background .15s ease, opacity .15s ease;
    }
    .btn:hover{background: var(--btn2);}
    .btn:active{transform: scale(.98);}
    .btn.secondary{
      background: #fff;
      color: var(--ink);
      border-color: var(--line);
    }
    .btn.secondary:hover{background:#f7f9fb;}
    .btn.danger{background: var(--danger);}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none;}
    .toggle{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .radio{
      display:inline-flex; align-items:center; gap:8px;
      padding: 9px 10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background:#fbfcfd;
      cursor:pointer;
      user-select:none;
      font-size:14px;
      color:var(--ink);
    }
    .radio input{accent-color: var(--accent2);}

    .wheels{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 940px){
      .wheels{grid-template-columns:1fr;}
    }
    .wheelCard{
      background:#fff;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .wheelHead{
      display:flex; align-items:center; justify-content:space-between;
      gap: 8px; margin-bottom: 8px;
    }
    .wheelHead .name{font-weight:900; letter-spacing:.3px;}
    .wheelHead .meta{font-size: 14px; color: var(--muted);}
    canvas{
      width: 100%;
      height: auto;
      display:block;
      border-radius: 14px;
      background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
      border: 1px solid var(--line);
    }

    .status{
      margin-top: 12px;
      background: #ffffff;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }
    .status .big{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .4px;
      color: var(--ink);
    }
    .status .small{
      font-size: 14px;
      color: var(--muted);
    }
    .chip{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(72,201,176,.12);
      color: #136f61;
      border: 1px solid rgba(72,201,176,.25);
      font-size: 14px;
      font-weight: 800;
    }

    .logCard{
      margin-top: 12px;
      background:#fff;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .logHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .logHead .ttl{font-weight:900;}
    table{
      width:100%;
      border-collapse:collapse;
      font-size: 14px;
    }
    th,td{
      border-bottom: 1px solid var(--line);
      padding: 8px 6px;
      text-align:left;
      vertical-align:top;
    }
    th{color:var(--muted); font-weight:900; font-size:14px;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    .empty{padding: 10px 0; color: var(--muted); font-size: 14px;}
  

    .btn.success{background:var(--ok); color:white;}
    .btn.success:hover{filter:brightness(.98);}
    #sysState.finished{color:var(--danger); font-weight:900;}
    .btn.pdfReady{background:var(--accent); color:var(--danger); font-weight:900;}
    .blink{animation:blink 1s steps(1,end) infinite;}
    @keyframes blink{50%{filter:brightness(1.25);} }
    

#resultText{font-size:18px; font-weight:800;}
#resultSub{font-size:14px;}
</style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

</head>

<body>
<div class="wrap">
  <div class="header">
    <div class="title">
      <h1>æŠ½å€¼æ—¥ç”Ÿè¼ªç›¤</h1>
      <div class="sub"></div>
    </div>
    <div class="row">
      <span class="pill">æ—¥æœŸç¸½æ•¸ï¼š<strong id="dateTotal">21</strong></span>
      <span class="pill">å‰©é¤˜æ—¥æœŸï¼š<strong id="dateLeft">0</strong></span>
      <span class="pill">å€¼æ—¥ç”Ÿæ± ï¼š<strong id="memberLeft">0</strong></span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="toggle" id="modeToggle">
          <label class="radio">
            <input type="radio" name="mode" value="manual" checked />
            æ‰‹å‹•æ¨¡å¼
          </label>
          <label class="radio">
            <input type="radio" name="mode" value="auto" />
            è‡ªå‹•æ¨¡å¼ï¼ˆå¿«é€Ÿå‹•ç•«ï¼‰
          </label>
        </div>
        <div class="row">
          <button class="btn danger" id="btnReset">é‡ç½®ï¼ˆæ¸…ç©ºç´€éŒ„ï¼‰</button>
          <button class="btn success" id="btnUnlockAudio" title="è‹¥æ‰‹æ©Ÿ/LINEé˜»æ“‹éŸ³æ•ˆï¼Œå…ˆé»æ­¤è§£é–">è§£é–éŸ³æ•ˆ</button>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>â­ å€¼æ—¥ç”Ÿåå–®ï¼ˆæ¯è¡Œä¸€å€‹ / é€—è™Ÿåˆ†éš”çš†å¯ï¼‰</label>
        <textarea id="inputMembers" placeholder="ä¾‹ï¼šå°æ˜ John éˆ´æœ¨ã•ã‚“"></textarea>
        <div class="hint">äººæ•¸å°‘æ–¼æ—¥æœŸæ™‚ï¼ŒæŠ½å®Œä¸€è¼ªæœƒè‡ªå‹•é‡ç½®å€¼æ—¥ç”Ÿæ± ï¼ˆæ—¥æœŸä¸é‡ç½®ï¼‰ã€‚</div>
      </div>

      <div style="margin-top:10px;">
        <label>ğŸ“… å€¼æ—¥ç”Ÿæ—¥æœŸ </label>
        <textarea id="inputDates"></textarea>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" id="btnLock">é–å®šåå–®</button>
        <button class="btn success" id="btnUnlock">è§£é™¤é–å®š</button>
        <span class="pill">ç‹€æ…‹ï¼š<strong id="sysState">INIT</strong></span>
        <span class="pill">æ¨¡å¼ï¼š<strong id="modeState">manual</strong></span>
      </div>
    </div>

    <div class="card">
      <div class="row" style="margin-top:2px;">
        <span class="pill">æ‰‹å‹•ï¼šæŠ½å€¼æ—¥ç”Ÿ â†’ æŠ½æ—¥æœŸï¼ˆå…©è¼ªçš†é‡‘è‰²é–ƒçˆï¼‰</span>
        <span class="pill">è‡ªå‹•ï¼šæŒ‰ã€Œè‡ªå‹•é–‹å§‹ã€è·‘å®Œï¼ˆéœéŸ³ï¼‹ä¸é–ƒçˆï¼‰</span>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" id="btnSpinMember">æŠ½å€¼æ—¥ç”Ÿ</button>
        <button class="btn" id="btnSpinDate">æŠ½æ—¥æœŸ</button>
        <button class="btn" id="btnAutoStart">è‡ªå‹•é–‹å§‹æˆ–ä¸­æ–·</button>
        <button class="btn secondary" id="btnPdf">æŠ½ç±¤ç´€éŒ„ PDF</button>
      </div>

      <div class="status">
        <div>
          <div class="big" id="resultText">å°šæœªé–‹å§‹</div>
          <div class="small" id="resultSub">è«‹å…ˆé–å®šåå–®</div>
        </div>
        <div class="row">
          <span class="chip" id="chipLocked">æœªé–å®š</span>
          <span class="chip" id="chipAuto">è‡ªå‹•æœªåŸ·è¡Œ</span>
        </div>
      </div>

      <div class="hint" style="margin-top:10px;">
        PDF ä½¿ç”¨ã€Œç€è¦½å™¨åˆ—å°ã€ï¼šé¿å…ä¸­æ–‡å­—äº‚ç¢¼ï¼ˆæœƒé–‹æ–°è¦–çª—ï¼Œé¸æ“‡ã€Œå¦å­˜ç‚º PDFã€ï¼‰ã€‚
      </div>
    </div>
  </div>

  <div class="wheels">
    <div class="wheelCard">
      <div class="wheelHead">
        <div class="name">â­ å€¼æ—¥ç”Ÿè¼ªç›¤</div>
        <div class="meta">åˆ‡åˆ†ï¼š<span id="memberSlices">0</span>ï½œé¸ä¸­ï¼š<span id="memberPick" class="mono">-</span></div>
      </div>
      <canvas id="memberCanvas" width="600" height="600"></canvas>
    </div>

    <div class="wheelCard">
      <div class="wheelHead">
        <div class="name">ğŸ“… æ—¥æœŸè¼ªç›¤</div>
        <div class="meta">åˆ‡åˆ†ï¼š<span id="dateSlices">0</span>ï½œé¸ä¸­ï¼š<span id="datePick" class="mono">-</span></div>
      </div>
      <canvas id="dateCanvas" width="600" height="600"></canvas>
    </div>
  </div>

  <div class="logCard">
    <div class="logHead">
      <div class="ttl">æŠ½ç±¤ç´€éŒ„</div>
      <div class="row">
        <span class="pill">ç´€éŒ„ç­†æ•¸ï¼š<strong id="logCount">0</strong></span>
      </div>
    </div>
    <div id="logEmpty" class="empty">å°šç„¡ç´€éŒ„</div>
    <div style="overflow:auto;">
      <table id="logTable" style="display:none;">
        <thead>
          <tr>
            <th style="min-width:120px;">æ™‚é–“</th>
            <th style="min-width:140px;">å€¼æ—¥ç”Ÿ</th>
            <th style="min-width:140px;">æ—¥æœŸ</th>
          </tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/** =========================
 *  å›ºå®šæ—¥æœŸï¼ˆç´…å­—ç‰ˆ 21 æ¬¡ï¼‰
 *  ========================= */
const DUTY_DATES = [
  "2/22",
  "3/15","3/29",
  "4/12","4/26",
  "5/3","5/17",
  "6/7","6/21",
  "7/5","7/19",
  "8/2","8/16",
  "9/6","9/20",
  "10/4","10/18",
  "11/1","11/15",
  "12/6","12/20"
];

/** =========================
 *  å·¥å…·
 *  ========================= */
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

function parseLines(text){
  const raw = (text||"").replace(/\r/g,"\n");
  // æ”¯æ´ï¼šæ›è¡Œ / é€—è™Ÿ / ä¸­æ–‡é€—è™Ÿ / ç©ºæ ¼
  const parts = raw.split(/[\n,ï¼Œ\s]+/).map(s=>s.trim()).filter(Boolean);
  const seen = new Set(), out = [];
  for (const p of parts){
    if(!seen.has(p)){ seen.add(p); out.push(p); }
  }
  return out;
}

function nowStamp(){
  const now = new Date();
  const hh = now.getHours();
  const mm = String(now.getMinutes()).padStart(2,"0");
  const ss = String(now.getSeconds()).padStart(2,"0");
  const period = hh < 12 ? "ä¸Šåˆ" : "ä¸‹åˆ";
  const hour12 = hh % 12 === 0 ? 12 : hh % 12;
  return `${period} ${hour12}:${mm}:${ss}`;
}

function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function canSwitchMode(){
  // å…è¨±åœ¨ AUTO_RUNNING ä¸­åˆ‡æ›ï¼ˆç”¨ä¾†ä¸­é€”æ‰“æ–·è‡ªå‹•ï¼‰ï¼Œä½†æ—‹è½‰ä¸­ï¼ˆSPIN_*ï¼‰ç¦æ­¢
  return !["SPIN_MEMBER","SPIN_DATE"].includes(state.system);
}
function isBusy(){
  return ["SPIN_MEMBER","SPIN_DATE","AUTO_RUNNING"].includes(state.system);
}

/** =========================
 *  éŸ³æ•ˆï¼ˆåŒå§“åæŠ½ç±¤è¼ªç›¤è·¯å¾‘ï¼‰
 *  BlessingCards128/audio/
 *  duty/ æ˜¯å­è³‡æ–™å¤¾ï¼Œæ‰€ä»¥ç”¨ ../audio/xxx.mp3
 *  ========================= */
let audioUnlocked = false;
let drumAudio = null;
let dunAudio = null;
let audioStopTimer = null;

function ensureAudio(){
  if(!drumAudio){
    drumAudio = new Audio("../audio/drum.mp3");
    drumAudio.preload = "auto";
  }
  if(!dunAudio){
    dunAudio = new Audio("../audio/dun.mp3");
    dunAudio.preload = "auto";
  }
}

function stopAllAudio(){
  try{
    if(audioStopTimer){ clearTimeout(audioStopTimer); audioStopTimer = null; }
    if(drumAudio){ drumAudio.pause(); drumAudio.currentTime = 0; }
    if(dunAudio){ dunAudio.pause(); dunAudio.currentTime = 0; }
  }catch(e){}
}

async function unlockAudio(){
  try{
    ensureAudio();
    // ç”¨æ¥µçŸ­æ’­æ”¾è§£é–ï¼ˆå…©å€‹éƒ½è§£é–ï¼‰
    drumAudio.volume = 0.001;
    await drumAudio.play();
    drumAudio.pause(); drumAudio.currentTime = 0;
    drumAudio.volume = 1;

    dunAudio.volume = 0.001;
    await dunAudio.play();
    dunAudio.pause(); dunAudio.currentTime = 0;
    dunAudio.volume = 1;

    audioUnlocked = true;
    setResultSub("éŸ³æ•ˆå·²è§£é–ï¼ˆè‹¥ä»ç„¡è²ï¼Œè«‹å†é»ä¸€æ¬¡ï¼‰");
  }catch(e){
    audioUnlocked = false;
    setResultSub("éŸ³æ•ˆä»å¯èƒ½è¢«é˜»æ“‹ï¼ˆè«‹åœ¨åŒé é¢å†é»ä¸€æ¬¡ï¼‰");
  }
}

function playAudioLimited(which, ms){
  // è‡ªå‹•æ¨¡å¼ï¼šå¿…é ˆéœéŸ³
  if(state.mode === "auto") return;
  ensureAudio();
  stopAllAudio();

  const a = which === "drum" ? drumAudio : dunAudio;
  try{
    a.currentTime = 0;
    a.play().catch(()=>{});
    audioStopTimer = setTimeout(()=>{
      try{ a.pause(); a.currentTime = 0; }catch(e){}
      audioStopTimer = null;
    }, ms);
  }catch(e){}
}

/** =========================
 *  ç‹€æ…‹
 *  ========================= */
const state = {
  locked: false,
  mode: "manual",
  system: "INIT",

  // å›ºå®šæ¸…å–®ï¼ˆä¸åˆªé™¤ï¼›ç”¨ used* ä¾†åšç°åŒ–èˆ‡é¿å…é‡è¤‡æŠ½å–ï¼‰
  members: [],
  dates: [],

  usedMembers: new Set(),   // æœ¬è¼ªå·²æŠ½éçš„å€¼æ—¥ç”Ÿ
  usedDates: new Set(),     // å·²åˆ†é…éçš„æ—¥æœŸï¼ˆ21 æ¬¡ï¼‰

  selectedMember: null,
  selectedDate: null,

  // è‡ªå‹•æµç¨‹ä¸­æ–·æ——æ¨™ï¼ˆå…è¨±ä¸­é€”æ‰“æ–·ï¼‰
  autoAbort: false,
  pdfDownloaded: false,

  logs: [],

  memberWheel: {
    angle: 0,
    anim: null,
    selectedIndex: -1,
    highlight: false,
    blink: true
  },
  dateWheel: {
    angle: 0,
    anim: null,
    selectedIndex: -1,
    highlight: false,
    blink: true
  }
};

/** =========================
 *  DOM
 *  ========================= */
const el = {
  dateTotal: document.getElementById("dateTotal"),
  dateLeft: document.getElementById("dateLeft"),
  memberLeft: document.getElementById("memberLeft"),

  inputMembers: document.getElementById("inputMembers"),
  inputDates: document.getElementById("inputDates"),

  btnLock: document.getElementById("btnLock"),
  btnUnlock: document.getElementById("btnUnlock"),
  btnReset: document.getElementById("btnReset"),
  btnUnlockAudio: document.getElementById("btnUnlockAudio"),

  btnSpinMember: document.getElementById("btnSpinMember"),
  btnSpinDate: document.getElementById("btnSpinDate"),
  btnAutoStart: document.getElementById("btnAutoStart"),
  btnPdf: document.getElementById("btnPdf"),

  sysState: document.getElementById("sysState"),
  modeState: document.getElementById("modeState"),
  chipLocked: document.getElementById("chipLocked"),
  chipAuto: document.getElementById("chipAuto"),

  resultText: document.getElementById("resultText"),
  resultSub: document.getElementById("resultSub"),

  memberCanvas: document.getElementById("memberCanvas"),
  dateCanvas: document.getElementById("dateCanvas"),

  memberSlices: document.getElementById("memberSlices"),
  dateSlices: document.getElementById("dateSlices"),
  memberPick: document.getElementById("memberPick"),
  datePick: document.getElementById("datePick"),

  logCount: document.getElementById("logCount"),
  logEmpty: document.getElementById("logEmpty"),
  logTable: document.getElementById("logTable"),
  logBody: document.getElementById("logBody"),

  modeToggle: document.getElementById("modeToggle")
};

el.inputDates.value = DUTY_DATES.join("\n");
el.dateTotal.textContent = String(DUTY_DATES.length);

/** =========================
 *  UI helpers
 *  ========================= */
function setResult(t){ el.resultText.textContent = t; }
function setResultSub(t){ el.resultSub.textContent = t; }

function setSystem(s){
  state.system = s;
  el.sysState.textContent = s;
  if(s === "FINISHED") el.sysState.classList.add("finished");
  else el.sysState.classList.remove("finished");
  updateButtons();
}

function setMode(m){
  state.mode = m;
  el.modeState.textContent = m;
  el.chipAuto.textContent = (m === "auto") ? "è‡ªå‹•æ¨¡å¼å·²é¸æ“‡" : "è‡ªå‹•æœªåŸ·è¡Œ";

  // è‡ªå‹•æ¨¡å¼ï¼šç«‹å³éœéŸ³ï¼‹é—œé–‰é–ƒçˆ
  if(m === "auto"){
    stopAllAudio();
    state.memberWheel.blink = false;
    state.dateWheel.blink = false;
  }else{
    state.memberWheel.blink = true;
    state.dateWheel.blink = true;
  }
  updateButtons();
}

function setLocked(v){
  state.locked = v;
  el.chipLocked.textContent = v ? "å·²é–å®š" : "æœªé–å®š";
  el.chipLocked.style.background = v ? "rgba(93,173,226,.12)" : "rgba(231,76,60,.10)";
  el.chipLocked.style.borderColor = v ? "rgba(93,173,226,.25)" : "rgba(231,76,60,.22)";
  el.chipLocked.style.color = v ? "#1c5b86" : "#a03a2d";
  updateButtons();
}

function updateCounters(){
  const dateLeft = Math.max(0, state.dates.length - state.usedDates.size);
  const memberLeft = Math.max(0, state.members.length - state.usedMembers.size);

  el.dateLeft.textContent = String(dateLeft);
  el.memberLeft.textContent = String(memberLeft);

  // åˆ‡åˆ†å›ºå®šé¡¯ç¤ºï¼ˆä¸å› ç°åŒ–è€Œæ”¹è®Šï¼‰
  el.memberSlices.textContent = String(state.members.length);
  el.dateSlices.textContent = String(state.dates.length);

  el.memberPick.textContent = state.selectedMember ?? "-";
  el.datePick.textContent = state.selectedDate ?? "-";
}

function updateButtons(){
  const locked = state.locked;
  const busy = isBusy();

  const dateLeft = state.dates.length - state.usedDates.size;

  // mode radiosï¼šæ—‹è½‰ä¸­ï¼ˆSPIN_*ï¼‰ç¦æ­¢ï¼›AUTO_RUNNING å¯åˆ‡æ›ï¼ˆç”¨ä¾†ä¸­é€”æ‰“æ–·ï¼‰
  const radios = el.modeToggle.querySelectorAll('input[type="radio"]');
  radios.forEach(r => { r.disabled = !canSwitchMode(); });

  el.btnLock.disabled = busy;
  el.btnUnlock.disabled = busy;
  el.btnReset.disabled = busy;
  el.btnUnlockAudio.disabled = busy;

  // æ‰‹å‹•æŠ½ï¼šéœ€é–å®šã€ä¸”åœ¨ READY_* æ‰å¯æŒ‰
  el.btnSpinMember.disabled = busy || !locked || state.system !== "READY_MEMBER";
  el.btnSpinDate.disabled   = busy || !locked || state.system !== "READY_DATE";

  // è‡ªå‹•ï¼šåªåœ¨ auto æ¨¡å¼ + é–å®šæ™‚å¯æŒ‰ï¼›AUTO_RUNNING ä¹Ÿå…è¨±æŒ‰ï¼ˆè®Šæˆä¸­æ–·ï¼‰
  el.btnAutoStart.disabled  = busy || !locked || state.mode !== "auto";

  // PDFï¼šå¹³å¸¸ç¦ç”¨ï¼›åªæœ‰ FINISHED æ‰å¯ç”¨ï¼ˆä¸”æœªä¸‹è¼‰éï¼‰
  const canPdf = (state.system === "FINISHED") && state.logs.length > 0 && !state.pdfDownloaded;
  el.btnPdf.disabled = !canPdf;

  if(canPdf){
    el.btnPdf.classList.add("pdfReady", "blink");
  }else{
    el.btnPdf.classList.remove("pdfReady", "blink");
  }
}


function renderLogs(){
  el.logCount.textContent = String(state.logs.length);
  if(state.logs.length === 0){
    el.logEmpty.style.display = "block";
    el.logTable.style.display = "none";
    return;
  }
  el.logEmpty.style.display = "none";
  el.logTable.style.display = "table";
  el.logBody.innerHTML = "";
  for(const it of state.logs){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${escapeHtml(it.time)}</td>
      <td>ã€Œ${escapeHtml(it.member)}ã€</td>
      <td>ã€Œ${escapeHtml(it.date)}ã€</td>
    `;
    el.logBody.appendChild(tr);
  }
}

/** =========================
 *  Canvas resize + draw
 *  ========================= */
function resizeCanvas(canvas){
  const ctx = canvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;
  const size = Math.min(canvas.clientWidth, canvas.clientWidth);
  canvas.style.height = size + "px";
  canvas.width  = Math.round(size * dpr);
  canvas.height = Math.round(size * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

const THEME_MEMBER = {
  c1: "rgba(93,173,226,.85)",
  c2: "rgba(72,201,176,.80)",
  text: "#ffffff",
  center: "å€¼æ—¥ç”Ÿ"
};
const THEME_DATE = {
  c1: "rgba(93,173,226,.55)",
  c2: "rgba(244,246,247,1)",
  text: "rgba(31,45,61,.85)",
  center: "æ—¥æœŸ"
};

function drawWheel(canvas, labels, angle, theme, wheelState, nowMs){
  const ctx = canvas.getContext("2d");
  const size = canvas.clientWidth; // å·²ç”± resizeCanvas() å¼·åˆ¶æˆæ­£æ–¹å½¢
  const cx = size/2, cy = size/2;
  const r  = size * 0.46;          // ç•™é‚Šè·ï¼Œé¿å…çœ‹èµ·ä¾†ã€Œä¸åœ“/è¢«åƒé‚Šã€

  ctx.clearRect(0,0,size,size);

  // ===== ç©ºè³‡æ–™ï¼šå–®ä¸€åœ“(åº•è‰²#5DADE2)ï¼‹å…§åˆ‡ç·šï¼ˆ3px ç™½ç·šï¼‰=====
  if(!labels || labels.length === 0){
    // å¤–åœˆæ·¡é™°å½±
    ctx.beginPath();
    ctx.arc(cx,cy,r+10,0,Math.PI*2);
    ctx.fillStyle = "rgba(31,45,61,.04)";
    ctx.fill();

    // ä¸»åœ“
    ctx.beginPath();
    ctx.arc(cx,cy,r,0,Math.PI*2);
    ctx.fillStyle = "#5DADE2";
    ctx.fill();

    // å…§åˆ‡ç·šï¼ˆç™½è‰² 3pxï¼‰
    ctx.beginPath();
    ctx.moveTo(cx - r, cy);
    ctx.lineTo(cx + r, cy);
    ctx.strokeStyle = "rgba(255,255,255,1)";
    ctx.lineWidth = 3;
    ctx.stroke();

    // ä¸­å¿ƒåœ“
    ctx.beginPath();
    ctx.arc(cx,cy,r*0.14,0,Math.PI*2);
    ctx.fillStyle = "#ffffff";
    ctx.fill();
    ctx.strokeStyle = "rgba(96,112,128,.25)";
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.fillStyle = "rgba(31,45,61,.75)";
    ctx.font = "900 14px system-ui, -apple-system, 'Noto Sans TC', sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(theme.center, cx, cy);
    return;
  }

  const n = labels.length;
  const step = Math.PI*2 / n;

  // blink factorï¼ˆåªå½±éŸ¿æ‰‹å‹•ï¼šwheelState.blink=trueï¼‰
  let blinkAlpha = 1;
  if(wheelState.highlight && wheelState.blink){
    const s = Math.sin(nowMs / 120);
    blinkAlpha = 0.55 + 0.45 * (s*0.5 + 0.5);
  }

  // å¤–åœˆæ·¡é™°å½±
  ctx.beginPath();
  ctx.arc(cx,cy,r+10,0,Math.PI*2);
  ctx.fillStyle = "rgba(31,45,61,.04)";
  ctx.fill();

  for(let i=0;i<n;i++){
    const a0 = angle + i*step;
    const a1 = a0 + step;

    const label = labels[i];

    const isDate = (theme === THEME_DATE);
    const isUsed = isDate ? state.usedDates.has(label) : state.usedMembers.has(label);

    // slice
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,a0,a1,false);
    ctx.closePath();

    if(isUsed){
      ctx.fillStyle = "#E0E0E0"; // æ•´æ ¼ç°è‰²
    }else{
      ctx.fillStyle = (i%2===0) ? theme.c1 : theme.c2;
    }
    ctx.fill();

    // å…§åˆ‡ç™½ç·šï¼ˆ3pxï¼‰
    ctx.strokeStyle = "rgba(255,255,255,.90)";
    ctx.lineWidth = 3;
    ctx.stroke();

    // label
    const mid = (a0+a1)/2;
    const tx = cx + Math.cos(mid) * (r*0.70);
    const ty = cy + Math.sin(mid) * (r*0.70);

    ctx.save();
    ctx.translate(tx,ty);
    ctx.rotate(mid + Math.PI/2);

    ctx.fillStyle = isUsed ? "rgba(31,45,61,.35)" : theme.text; // æ–‡å­—æ·¡åŒ–
    ctx.font = "800 14px system-ui, -apple-system, 'Noto Sans TC', sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    let t = label;
    if(t.length > 10) t = t.slice(0,10) + "â€¦";
    ctx.fillText(t, 0, 0);

    ctx.restore();

    // highlightï¼šé‡‘è‰²å¤–æ¡†ï¼‹ï¼ˆæ‰‹å‹•ï¼‰é–ƒçˆ
    if(wheelState.highlight && i === wheelState.selectedIndex){
      ctx.save();
      ctx.globalAlpha = blinkAlpha;

      ctx.shadowColor = "rgba(255,215,0,.85)";
      ctx.shadowBlur = 18;

      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,a0,a1,false);
      ctx.closePath();

      ctx.lineWidth = 6;
      ctx.strokeStyle = "rgba(255,215,0,1)";
      ctx.stroke();

      ctx.shadowBlur = 0;
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(255,235,140,1)";
      ctx.stroke();

      ctx.restore();
    }
  }

  // center
  ctx.beginPath();
  ctx.arc(cx,cy,r*0.14,0,Math.PI*2);
  ctx.fillStyle = "#ffffff";
  ctx.fill();
  ctx.strokeStyle = "rgba(96,112,128,.25)";
  ctx.lineWidth = 2;
  ctx.stroke();

  ctx.fillStyle = "rgba(31,45,61,.75)";
  ctx.font = "900 14px system-ui, -apple-system, 'Noto Sans TC', sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(theme.center, cx, cy);
}

function redrawAll(nowMs){
  resizeCanvas(el.memberCanvas);
  resizeCanvas(el.dateCanvas);

  drawWheel(el.memberCanvas, state.members, state.memberWheel.angle, THEME_MEMBER, state.memberWheel, nowMs);
  drawWheel(el.dateCanvas, state.dates, state.dateWheel.angle, THEME_DATE, state.dateWheel, nowMs);
}

window.addEventListener("resize", ()=> redrawAll(performance.now()) );

/** =========================
 *  ç„¡æŒ‡é‡ï¼Œä½†ä»éœ€ã€Œé¸ä¸­åƒè€ƒç·šã€
 *  å…§éƒ¨æ¡ç”¨ 12 é»æ–¹å‘ç‚ºé¸ä¸­ç·šï¼ˆä¸å¯è¦‹ï¼‰
 *  ========================= */
function angleForIndexAtTop(index, n){
  const step = Math.PI * 2 / n;
  const top = -Math.PI/2;
  return top - (index + 0.5) * step;
}

function chooseRandomIndex(n){
  return Math.floor(Math.random() * n);
}

/** =========================
 *  çµ²æ»‘åœè½‰å‹•ç•«ï¼ˆç›®æ¨™è§’åº¦æ³•ï¼‰
 *  ========================= */
function chooseRandomIndexFrom(indices){
  const k = Math.floor(Math.random() * indices.length);
  return indices[k];
}

function startSpinToIndex(wheel, labels, durationMs, extraTurns, allowedIndices){
  const n = labels.length;
  if(n <= 0) return;

  const pool = (Array.isArray(allowedIndices) && allowedIndices.length>0)
    ? allowedIndices
    : Array.from({length:n}, (_,i)=>i);

  const idx = chooseRandomIndexFrom(pool);

  const baseTarget = angleForIndexAtTop(idx, n);
  const start = wheel.angle;

  // è®“å®ƒé †æ™‚é‡è½‰å¤šåœˆ
  const twoPi = Math.PI * 2;
  let end = baseTarget + extraTurns * twoPi;

  // ç¢ºä¿ end åœ¨ start ä¹‹å¾Œï¼ˆé¿å…åå‘ï¼‰
  while(end <= start + twoPi){
    end += twoPi;
  }

  wheel.anim = {
    startAngle: start,
    endAngle: end,
    startTime: performance.now(),
    duration: durationMs,
    idx
  };
}

function updateWheelAnim(wheel, nowMs){
  const a = wheel.anim;
  if(!a) return false;

  const t = Math.min(1, (nowMs - a.startTime) / a.duration);

  // è‡ªç„¶ easeOutCubic æ…£æ€§åœæ­¢ï¼ˆä¸€è·¯ä¸€æ¢æ›²ç·šï¼‰
  const k = 1 - Math.pow(1 - t, 3);
  wheel.angle = a.startAngle + (a.endAngle - a.startAngle) * k;

  if(t >= 1){
    wheel.angle = a.endAngle;
    wheel.selectedIndex = a.idx;
    wheel.anim = null;
    return true;
  }
  return false;
}

/** =========================
 *  é«˜äº®è¦å‰‡
 *  - æ‰‹å‹•ï¼šå…©è¼ªæŠ½ä¸­éƒ½è¦é‡‘è‰²é–ƒçˆï¼Œç›´åˆ°ã€Œä¸‹ä¸€æ¬¡æŠ½å€¼æ—¥ç”Ÿã€æ‰æ¸…é™¤
 *  - è‡ªå‹•ï¼šä¸é–ƒçˆï¼ˆblink=falseï¼‰ï¼Œå¯ä¿ç•™åŸºæœ¬é«˜äº®ï¼ˆå¤–æ¡†ä¸é–ƒï¼‰
 *  ========================= */
function clearHighlights(){
  state.memberWheel.highlight = false;
  state.dateWheel.highlight = false;
  state.memberWheel.selectedIndex = -1;
  state.dateWheel.selectedIndex = -1;
}

/** =========================
 *  ä¸»å¾ªç’°
 *  ========================= */
let rafId = null;
function tick(nowMs){
  // anim update
  const mDone = updateWheelAnim(state.memberWheel, nowMs);
  const dDone = updateWheelAnim(state.dateWheel, nowMs);

  // ç¬¬ä¸€è¼ªåœä¸‹ï¼ˆå€¼æ—¥ç”Ÿï¼‰
  if(mDone && state.system === "SPIN_MEMBER"){
    const idx = state.memberWheel.selectedIndex;
    state.selectedMember = state.members[idx] ?? null;
    el.memberPick.textContent = state.selectedMember ?? "-";

    // æ‰‹å‹•ï¼šç¬¬ä¸€è¼ªæŠ½ä¸­è¦é«˜äº®é–ƒçˆï¼›è‡ªå‹•ï¼šä¸é–ƒï¼ˆblink=falseï¼‰
    state.memberWheel.highlight = true;
    state.memberWheel.blink = (state.mode === "manual");
    setSystem("READY_DATE");
    setResult(`æŠ½ä¸­å€¼æ—¥ç”Ÿã€Œ${state.selectedMember}ã€`);
    setResultSub("è«‹æŠ½æ—¥æœŸ");
    updateCounters();
  }

  // ç¬¬äºŒè¼ªåœä¸‹ï¼ˆæ—¥æœŸï¼‰
  if(dDone && state.system === "SPIN_DATE"){
    const idx = state.dateWheel.selectedIndex;
    state.selectedDate = state.dates[idx] ?? null;
    el.datePick.textContent = state.selectedDate ?? "-";

    state.dateWheel.highlight = true;
    state.dateWheel.blink = false;
    finalizeAssignment(state.selectedMember, state.selectedDate);
  }

  redrawAll(nowMs);
  rafId = requestAnimationFrame(tick);
}

/** =========================
 *  æŠ½å–æµç¨‹
 *  ========================= */
async function spinMember(){
  if(!state.locked) return;
  if(state.system !== "READY_MEMBER") return;

  const dateLeft = state.dates.length - state.usedDates.size;
  if(dateLeft <= 0){
    setSystem("FINISHED");
    setResult("ğŸ‰ å…¨å¹´åº¦å€¼æ—¥ç”Ÿåˆ†é…å®Œæˆï¼ˆ21 / 21ï¼‰");
    setResultSub("å¯ä¸‹è¼‰ PDFï¼Œæˆ–æŒ‰é‡ç½®é‡æ–°é–‹å§‹");
    stopAllAudio();
    return;
  }

  // äººæ± ç”¨å®Œï¼šè‡ªå‹•é‡ç½®ï¼ˆåªå½±éŸ¿ç°åŒ–ï¼Œä¸å½±éŸ¿æ—¥æœŸï¼‰
  if(state.members.length > 0 && state.usedMembers.size >= state.members.length){
    state.usedMembers.clear();
  }

  // å¯æŠ½çš„å€¼æ—¥ç”Ÿç´¢å¼•ï¼ˆæ’é™¤æœ¬è¼ªå·²æŠ½éï¼‰
  const allowed = [];
  for(let i=0;i<state.members.length;i++){
    if(!state.usedMembers.has(state.members[i])) allowed.push(i);
  }
  if(allowed.length === 0){
    state.usedMembers.clear();
    for(let i=0;i<state.members.length;i++) allowed.push(i);
  }

  // ä¸‹ä¸€ä½é–‹å§‹ï¼šæ¸…é™¤å…©è¼ªé«˜äº® + åœæ­¢éŸ³æ•ˆ
  clearHighlights();
  stopAllAudio();

  setSystem("SPIN_MEMBER");

  // è½‰ 8~10 åœˆï¼Œ7 ç§’ï¼ˆèˆ‡ drum åŒæ­¥ï¼‰
  const turns = 8 + Math.floor(Math.random()*3);

  if(state.mode === "manual"){
    ensureAudio();
    try{
      drumAudio.currentTime = 0;
      await drumAudio.play(); // ğŸ‘ˆ ç­‰éŸ³æª”çœŸçš„é–‹å§‹æ’­æ”¾
    }catch(e){}
    startSpinToIndex(state.memberWheel, state.members, 7000, turns, allowed);
  }else{
    startSpinToIndex(state.memberWheel, state.members, 7000, turns, allowed);
  }
}

async function spinDate(){
  if(!state.locked) return;
  if(state.system !== "READY_DATE") return;

  // å¯æŠ½æ—¥æœŸç´¢å¼•ï¼ˆæ’é™¤å·²ç”¨ï¼‰
  const allowed = [];
  for(let i=0;i<state.dates.length;i++){
    if(!state.usedDates.has(state.dates[i])) allowed.push(i);
  }
  if(allowed.length === 0){
    setSystem("FINISHED");
    setResult("ğŸ‰ å…¨å¹´åº¦å€¼æ—¥ç”Ÿåˆ†é…å®Œæˆï¼ˆ21 / 21ï¼‰");
    setResultSub("å¯ä¸‹è¼‰ PDFï¼Œæˆ–æŒ‰é‡ç½®é‡æ–°é–‹å§‹");
    stopAllAudio();
    return;
  }

  stopAllAudio();

  setSystem("SPIN_DATE");

  // è½‰ 6~8 åœˆï¼Œ4 ç§’ï¼ˆèˆ‡ dun åŒæ­¥ï¼‰
  const turns = 6 + Math.floor(Math.random()*3);

  if(state.mode === "manual"){
    ensureAudio();
    try{
      dunAudio.currentTime = 0;
      await dunAudio.play();
    }catch(e){}
    startSpinToIndex(state.dateWheel, state.dates, 4000, turns, allowed);
  }else{
    startSpinToIndex(state.dateWheel, state.dates, 4000, turns, allowed);
  }
}

function finalizeAssignment(member, date){
  if(!member || !date){
    setResult("çµæœç•°å¸¸ï¼ˆmember/date ç‚ºç©ºï¼‰");
    setResultSub("è«‹é‡ç½®å¾Œå†è©¦");
    setSystem("READY_MEMBER");
    return;
  }

  // é˜²å‘†ï¼šæ—¥æœŸä¸å¯é‡è¤‡
  if(state.usedDates.has(date)){
    setResult(`æ—¥æœŸã€Œ${date}ã€å·²åˆ†é…éï¼ˆè«‹å†æŠ½ä¸€æ¬¡ï¼‰`);
    setResultSub("ï¼ˆç³»çµ±ä¿è­·ï¼‰");
    setSystem("READY_DATE");
    return;
  }

  // ä¸­å¤®é¡¯ç¤ºï¼šä¾ä½ éœ€æ±‚ã€Œå€¼æ—¥ç”Ÿã€Œå¹¾æœˆå¹¾æ—¥ã€ã€ä¸€è¡Œ
  setResult(`å€¼æ—¥ç”Ÿã€Œ${date}ã€`);
  setResultSub(`å€¼æ—¥ç”Ÿï¼š${member}`);

  // è¨˜éŒ„ï¼ˆæ™‚é–“å¾Œç¶´ï¼šå–®ç´”é¡¯ç¤ºæ‰‹å‹•/è‡ªå‹•ï¼›ä½ é¸ Cï¼‰
  const time = `${nowStamp()}ï¼ˆ${state.mode === "auto" ? "è‡ªå‹•" : "æ‰‹å‹•"}ï¼‰`;
  state.logs.push({ time, member, date });
  renderLogs();

  // æ¨™è¨˜ï¼šæ—¥æœŸå·²ç”¨ï¼›å€¼æ—¥ç”Ÿæœ¬è¼ªå·²ç”¨ï¼ˆå…©è¼ªéƒ½ã€Œä¸åˆªé™¤ã€ï¼Œæ”¹ç°åŒ–ï¼‹ä¸å¯å†æŠ½ï¼‰
  state.usedDates.add(date);
  state.usedMembers.add(member);

  // æ¸…æš«å­˜ï¼ˆé«˜äº®è¦ä¿ç•™åˆ°ä¸‹ä¸€æ¬¡æŠ½å€¼æ—¥ç”Ÿæ‰æ¸…é™¤ï¼‰
  state.selectedMember = null;
  state.selectedDate = null;

  updateCounters();

  // âœ… å®Œæˆåˆ¤æ–·ï¼šåªæœ‰ã€Œæ—¥æœŸ 21 æ¬¡å…¨éƒ¨æŠ½å®Œã€æ‰ FINISHEDï¼ˆä½ é¸ Aï¼‰
  if(state.usedDates.size >= state.dates.length){
    setSystem("FINISHED");
    setResult("ğŸ‰ å…¨å¹´åº¦å€¼æ—¥ç”Ÿåˆ†é…å®Œæˆï¼ˆ21 / 21ï¼‰");
    setResultSub("å¯ä¸‹è¼‰ PDFï¼Œæˆ–æŒ‰é‡ç½®é‡æ–°é–‹å§‹");
    el.chipAuto.textContent = "å®Œæˆ";
    stopAllAudio();
    return;
  }

  // äººæ± ç”¨å®Œ â†’ é‡ç½®æœ¬è¼ª
  if(state.members.length > 0 && state.usedMembers.size >= state.members.length){
    state.usedMembers.clear();
  }

  // å›åˆ°ç¬¬ä¸€è¼ª
  setSystem("READY_MEMBER");
  setResult("è«‹æŠ½å€¼æ—¥ç”Ÿ");
  setResultSub(state.mode === "auto" ? "è‡ªå‹•ï¼šæŒ‰è‡ªå‹•é–‹å§‹æˆ–ä¸­æ–·" : "æ‰‹å‹•ï¼šæŒ‰æŠ½å€¼æ—¥ç”Ÿ");
}

function abortAuto(reason){
  // åœæ­¢å‹•ç•«
  state.autoAbort = true;
  try{
    state.memberWheel.anim = null;
    state.dateWheel.anim = null;
  }catch(e){}
  stopAllAudio();

  // è‡ªå‹•æ”¹å›å¯æ“ä½œç‹€æ…‹ï¼ˆä¸æ¸…è³‡æ–™ã€ä¸æ¸…ç°åŒ–ï¼‰
  if(state.system === "FINISHED") return;

  el.chipAuto.textContent = "è‡ªå‹•å·²ä¸­æ­¢";
  setResultSub(reason || "å·²ä¸­æ­¢è‡ªå‹•æµç¨‹");
  setSystem(state.locked ? "READY_MEMBER" : "INIT");
}

async function runAuto(){
  if(!state.locked) return;
  if(state.mode !== "auto") return;

  // è‹¥å·²åœ¨è‡ªå‹•ä¸­ï¼ŒæŒ‰ä¸€æ¬¡å°±ä¸­æ­¢ï¼ˆä½ è¦ã€Œä¸­é€”æ‰“æ–·ã€ï¼‰
  if(state.system === "AUTO_RUNNING"){
    abortAuto("å·²ä¸­æ­¢è‡ªå‹•æµç¨‹ï¼ˆæ‰‹å‹•æ¥ç®¡ï¼‰");
    return;
  }

  if(isBusy()) return;

  const dateLeft = state.dates.length - state.usedDates.size;
  if(dateLeft <= 0){
    setSystem("FINISHED");
    setResult("ğŸ‰ å…¨å¹´åº¦å€¼æ—¥ç”Ÿåˆ†é…å®Œæˆï¼ˆ21 / 21ï¼‰");
    setResultSub("å¯ä¸‹è¼‰ PDFï¼Œæˆ–æŒ‰é‡ç½®é‡æ–°é–‹å§‹");
    return;
  }

  state.autoAbort = false;

  // è‡ªå‹•æ¨¡å¼ï¼šç«‹å³éœéŸ³
  stopAllAudio();
  el.chipAuto.textContent = "è‡ªå‹•åŸ·è¡Œä¸­â€¦";

  setSystem("AUTO_RUNNING");

  while(true){
    if(state.autoAbort) break;

    const left = state.dates.length - state.usedDates.size;
    if(left <= 0) break;

    // äººæ± ç”¨å®Œï¼šé‡ç½®æœ¬è¼ª
    if(state.members.length > 0 && state.usedMembers.size >= state.members.length){
      state.usedMembers.clear();
    }

    // === æŠ½å€¼æ—¥ç”Ÿï¼ˆåªæŠ½æœªç”¨ï¼‰===
    const mAllowed = [];
    for(let i=0;i<state.members.length;i++){
      if(!state.usedMembers.has(state.members[i])) mAllowed.push(i);
    }
    if(mAllowed.length === 0){
      state.usedMembers.clear();
      for(let i=0;i<state.members.length;i++) mAllowed.push(i);
    }

    clearHighlights(); // è‡ªå‹•ä¸éœ€è¦ä¸Šä¸€ç­†é–ƒçˆæ®˜ç•™
    startSpinToIndex(state.memberWheel, state.members, 750, 3 + Math.floor(Math.random()*2), mAllowed);
    await waitAnimDone(state.memberWheel);
    if(state.autoAbort) break;

    state.selectedMember = state.members[state.memberWheel.selectedIndex] ?? null;
    state.memberWheel.highlight = true;
    state.memberWheel.blink = false;

    // === æŠ½æ—¥æœŸï¼ˆåªæŠ½æœªç”¨ï¼‰===
    const dAllowed = [];
    for(let i=0;i<state.dates.length;i++){
      if(!state.usedDates.has(state.dates[i])) dAllowed.push(i);
    }
    if(dAllowed.length === 0) break;

    startSpinToIndex(state.dateWheel, state.dates, 750, 3 + Math.floor(Math.random()*2), dAllowed);
    await waitAnimDone(state.dateWheel);
    if(state.autoAbort) break;

    state.selectedDate = state.dates[state.dateWheel.selectedIndex] ?? null;
    state.dateWheel.highlight = true;
    state.dateWheel.blink = false;
    finalizeAssignment(state.selectedMember, state.selectedDate);

    // finalizeAssignment æœƒæŠŠ system æ‹‰å› READY_MEMBERï¼›è‡ªå‹•è¦ç¶­æŒ AUTO_RUNNING
    if(state.system === "FINISHED") break;
    state.system = "AUTO_RUNNING";
    el.sysState.textContent = "AUTO_RUNNING";

    await sleep(220);
  }

  if(state.autoAbort){
    // å·²åœ¨ abortAuto() åš UIï¼›é€™è£¡åªä¿è­·ç‹€æ…‹
    state.system = state.locked ? "READY_MEMBER" : "INIT";
    el.sysState.textContent = state.system;
    updateButtons();
    return;
  }

  // æ­£å¸¸å®Œæˆ
  if(state.usedDates.size >= state.dates.length){
    setSystem("FINISHED");
    el.chipAuto.textContent = "å®Œæˆ";
  }else{
    // é€”ä¸­è‡ªç„¶çµæŸï¼ˆç†è«–ä¸Šä¸æœƒï¼‰ï¼Œå›åˆ°å¯æ“ä½œ
    setSystem("READY_MEMBER");
    el.chipAuto.textContent = "è‡ªå‹•çµæŸ";
  }
}

function waitAnimDone(wheel){
  return new Promise(resolve=>{
    const check = ()=>{
      if(!wheel.anim) resolve();
      else requestAnimationFrame(check);
    };
    check();
  });
}

/** =========================
 *  Lock / Reset / PDF
 *  ========================= */
function lockLists(){
  const members = parseLines(el.inputMembers.value);
  const dates = parseLines(el.inputDates.value);

  if(members.length < 1){
    setResult("è«‹å…ˆè¼¸å…¥å€¼æ—¥ç”Ÿåå–®");
    setResultSub("å¯ç”¨ï¼šæ›è¡Œ / é€—è™Ÿ / ç©ºæ ¼ åˆ†éš”");
    return;
  }
  if(dates.length < 1){
    setResult("æ—¥æœŸæ¸…å–®ç‚ºç©º");
    setResultSub("è«‹å¡«å…¥æ—¥æœŸï¼ˆä¾‹ï¼š2/22 3/15 â€¦ï¼‰");
    return;
  }

  state.members = members;
  state.dates = dates;

  state.usedMembers.clear();
  state.usedDates.clear();

  state.logs = [];
  state.pdfDownloaded = false;
  state.selectedMember = null;
  state.selectedDate = null;

  clearHighlights();
  stopAllAudio();

  setLocked(true);
  setSystem("READY_MEMBER");
  setResult("è«‹æŠ½å€¼æ—¥ç”Ÿ");
  setResultSub(state.mode === "auto" ? "è‡ªå‹•ï¼šæŒ‰è‡ªå‹•é–‹å§‹æˆ–ä¸­æ–·" : "æ‰‹å‹•ï¼šæŒ‰æŠ½å€¼æ—¥ç”Ÿ");

  el.chipAuto.textContent = "è‡ªå‹•æœªåŸ·è¡Œ";

  updateCounters();
  renderLogs();
  redrawAll(performance.now());
  updateButtons();
}

function unlockLists(){
  stopAllAudio();
  clearHighlights();

  state.pdfDownloaded = false;
  setLocked(false);
  state.usedMembers.clear();
  state.usedDates.clear();
  state.selectedMember = null;
  state.selectedDate = null;

  setSystem("INIT");
  setResult("å°šæœªé–‹å§‹");
  setResultSub("è«‹å…ˆé–å®šåå–®");

  updateButtons();
  updateCounters();
  redrawAll(performance.now());
}

function resetAll(){
  if(isBusy()) return;

  const msg = "è³‡æ–™ç´€éŒ„å°‡è¢«æ¸…ç©º(clear) & æ­¸é›¶(reset)ï¼Œ\n" +
              "éœ€é‡æ–°è¼¸å…¥å§“åä¸¦é–å®šåå–®é–‹å§‹æ–°è½‰ç›¤éŠæˆ²ï¼\n" +
              "æ‚¨ç¢ºå®šè¦åŸ·è¡Œå— (Yes or No)?";

  if(!confirm(msg)) return;

  stopAllAudio();
  clearHighlights();

  // æ¸…ç©ºè³‡æ–™
  state.logs = [];
  state.pdfDownloaded = false;
  state.selectedMember = null;
  state.selectedDate = null;
  state.usedMembers.clear();
  state.usedDates.clear();

  // ğŸ”¥ å¼·åˆ¶å›åˆ° INIT
  setLocked(false);
  setSystem("INIT");
  setResult("å°šæœªé–‹å§‹");
  setResultSub("è«‹å…ˆè¼¸å…¥å§“åä¸¦é–å®šåå–®");

  el.chipAuto.textContent = "è‡ªå‹•æœªåŸ·è¡Œ";

  // æ¸…ç©ºå§“åè¼¸å…¥ï¼ˆç¢ºä¿é‡æ–°é–‹å§‹ï¼‰
  el.inputMembers.value = "";

  renderLogs();
  updateCounters();
  redrawAll(performance.now());
  updateButtons();
}

function exportPdfViaPrint(){

  // ç›´æ¥ä¸‹è¼‰ PDFï¼ˆä»¥ç•«å¸ƒ raster åŒ–ï¼Œé¿å…ä¸­æ–‡å­—é«”äº‚ç¢¼ï¼‰
  const { jsPDF } = (window.jspdf || {});
  if(!jsPDF){
    setResultSub("PDF æ¨¡çµ„è¼‰å…¥å¤±æ•—ï¼šè«‹æª¢æŸ¥ç¶²è·¯æ˜¯å¦å¯é€£åˆ° jsdelivrã€‚");
    return;
  }

  const title = "æŠ½å€¼æ—¥ç”Ÿè¼ªç›¤_æŠ½ç±¤ç´€éŒ„";
  const rows = state.logs.slice();

  // A4 ç›´å¼ï¼š150dpi
  const W = 1240, H = 1754;
  const canvas = document.createElement("canvas");
  canvas.width = W;
  canvas.height = H;
  const ctx = canvas.getContext("2d");

  // èƒŒæ™¯
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,W,H);

  // æ¨™é¡Œ
  ctx.fillStyle = "#111827";
  ctx.font = "bold 24px system-ui, -apple-system, Noto Sans TC, PingFang TC, Microsoft JhengHei, sans-serif";
  ctx.fillText(title, 60, 90);

  ctx.fillStyle = "#607080";
  ctx.font = "14px system-ui, -apple-system, Noto Sans TC, PingFang TC, Microsoft JhengHei, sans-serif";
  ctx.fillText(`å…± ${rows.length} ç­†`, 60, 130);

  // è¡¨æ ¼
  const x0 = 60, y0 = 170, tableW = W - 120;
  const col1 = 280, col2 = 300, col3 = tableW - col1 - col2;
  const rowH = 46;

  ctx.fillStyle = "#f3f6f9";
  ctx.fillRect(x0, y0, tableW, rowH);
  ctx.strokeStyle = "#d9e1ea";
  ctx.lineWidth = 2;
  ctx.strokeRect(x0, y0, tableW, rowH);

  ctx.fillStyle = "#111827";
  ctx.font = "bold 14px system-ui, -apple-system, Noto Sans TC, PingFang TC, Microsoft JhengHei, sans-serif";
  ctx.fillText("æ™‚é–“", x0 + 16, y0 + 32);
  ctx.fillText("å€¼æ—¥ç”Ÿ", x0 + col1 + 16, y0 + 32);
  ctx.fillText("æ—¥æœŸ", x0 + col1 + col2 + 16, y0 + 32);

  ctx.font = "14px system-ui, -apple-system, Noto Sans TC, PingFang TC, Microsoft JhengHei, sans-serif";

  rows.forEach((it, i) => {
    const y = y0 + rowH * (i+1);

    ctx.fillStyle = (i % 2 === 0) ? "#ffffff" : "#fbfdff";
    ctx.fillRect(x0, y, tableW, rowH);
    ctx.strokeStyle = "#d9e1ea";
    ctx.strokeRect(x0, y, tableW, rowH);

    ctx.fillStyle = "#111827";
    ctx.fillText(String(it.time||""), x0 + 16, y + 32);
    ctx.fillText(String(it.member||""), x0 + col1 + 16, y + 32);
    ctx.fillText(String(it.date||""), x0 + col1 + col2 + 16, y + 32);
  });

  const pdf = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });
  const img = canvas.toDataURL("image/jpeg", 0.92);

  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  pdf.addImage(img, "JPEG", 0, 0, pageW, pageH);

  pdf.save("æŠ½å€¼æ—¥ç”Ÿè¼ªç›¤_æŠ½ç±¤ç´€éŒ„.pdf");
}

/** =========================
 *  äº‹ä»¶ç¶å®š
 *  ========================= */
el.btnLock.onclick = lockLists;
el.btnUnlock.onclick = unlockLists;
el.btnReset.onclick = resetAll;

el.btnSpinMember.onclick = spinMember;
el.btnSpinDate.onclick = spinDate;

el.btnAutoStart.onclick = runAuto;
el.btnPdf.onclick = ()=>{ exportPdfViaPrint(); state.pdfDownloaded = true; updateButtons(); };
el.btnUnlockAudio.onclick = unlockAudio;

// æ¨¡å¼åˆ‡æ›ï¼ˆå¯ä¸­é€”ï¼Œä½†å¿™ç¢Œ/æ—‹è½‰ä¸­ç¦æ­¢ï¼›åˆ‡åˆ° auto ä¸æœƒè‡ªå‹•é–‹å§‹ï¼Œä½ é¸ Bï¼‰
el.modeToggle.addEventListener("change", (e)=>{
  const t = e.target;
  if(!(t && t.name==="mode")) return;

  if(!canSwitchMode()){
    const radios = el.modeToggle.querySelectorAll('input[type="radio"]');
    radios.forEach(r => r.checked = (r.value === state.mode));
    setResultSub("æ—‹è½‰ä¸­ä¸å¯åˆ‡æ›æ¨¡å¼");
    return;
  }

  // âœ… å…è¨±ä¸­é€”æ‰“æ–·è‡ªå‹•ï¼šåªè¦ AUTO_RUNNING ä¸”åˆ‡åˆ°æ‰‹å‹•ï¼Œå°±ç«‹åˆ»ä¸­æ­¢
  const nextMode = t.value;
  if(state.system === "AUTO_RUNNING" && nextMode === "manual"){
    abortAuto("å·²åˆ‡æ›æ‰‹å‹•æ¨¡å¼ï¼ˆä¸­æ­¢è‡ªå‹•ï¼‰");
  }

  setMode(nextMode);

  // åˆ‡æ›æ¨¡å¼å¾Œä¸è‡ªå‹•é–‹å§‹ï¼ˆä½ é¸ Bï¼‰
if(state.mode === "auto"){
  setResultSub("å·²åˆ‡æ›è‡ªå‹•æ¨¡å¼ï¼šè«‹æŒ‰ã€Œè‡ªå‹•é–‹å§‹æˆ–ä¸­æ–·ã€æ‰æœƒåŸ·è¡Œï¼ˆè‡ªå‹•éœéŸ³ï¼‰");
}else{
  setResultSub("å·²åˆ‡æ›æ‰‹å‹•æ¨¡å¼ï¼šè«‹æŒ‰ã€ŒæŠ½å€¼æ—¥ç”Ÿã€â†’ã€ŒæŠ½æ—¥æœŸã€");
}
updateButtons();
});

/** =========================
 *  åˆå§‹
 *  ========================= */
function init(){
  el.inputDates.value = DUTY_DATES.join("\n");
  el.dateTotal.textContent = String(DUTY_DATES.length);

  setMode("manual");
  setLocked(false);
  updateCounters();
  renderLogs();
  redrawAll(performance.now());
  if(!rafId) rafId = requestAnimationFrame(tick);
}
init();
</script>
</body>
</html>
