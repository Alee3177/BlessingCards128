<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BlessingCards128 Host</title>
  <style>
    :root{
      --bg:#fbf2dc;
      --panel:#ffffffcc;
      --text:#5a3b1f;
      --btn:#f3c05c;
      --btn2:#f0b04b;
      --danger:#d84b3a;
      --primary:#2e77d0;
      --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    body{margin:0;background:var(--bg);font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:22px 18px 40px;display:grid;grid-template-columns: 1fr 320px;gap:18px;}
    @media (max-width: 980px){.wrap{grid-template-columns:1fr;}}
    h1{font-size:22px;margin:0 0 10px;}
    .card{background:var(--panel);border-radius:22px;box-shadow:var(--shadow);padding:16px 16px 14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.15);background:#fff;}
    button{border:0;border-radius:999px;padding:10px 14px;background:var(--btn);cursor:pointer;font-weight:700;color:#4a2f15;box-shadow:0 6px 16px rgba(0,0,0,.08);}
    button:hover{background:var(--btn2);}
    button:disabled{opacity:.45;cursor:not-allowed;box-shadow:none;}
    .danger{background:var(--danger);color:#fff;}
    .primary{background:var(--primary);color:#fff;}
    .muted{opacity:.78;font-size:13px;}
    .status{display:flex;align-items:center;gap:8px;margin:8px 0 10px;font-weight:700;}
    .dot{width:10px;height:10px;border-radius:999px;background:#999;}
    .dot.ok{background:#1aa34a;}
    .dot.warn{background:#ff9f1a;}
    .dot.busy{background:#2e77d0;}
    .dot.end{background:#d84b3a;}
    .wheelBox{display:flex;justify-content:center;align-items:center;padding:12px 0;}
    canvas{background:transparent;}
    .centerText{white-space:pre-line;text-align:center;font-weight:800;line-height:1.35;}
    .big{font-size:18px;}
    .qrBox{display:flex;gap:12px;align-items:flex-start;}
    #qr{width:132px;height:132px;background:#fff;border-radius:14px;padding:8px;box-shadow:var(--shadow);}
    .linkBox{flex:1;min-width:0;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .log{font-size:13px;line-height:1.5;max-height:180px;overflow:auto;background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:10px;}
    .blink{animation:blink 1s infinite;}
    @keyframes blink{0%,50%{filter:brightness(1);}51%,100%{filter:brightness(1.25);}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆä¸»æŒæ©Ÿï¼‰</h1>
      <div class="status"><span id="dot" class="dot"></span><span id="statusText">ç³»çµ±åˆå§‹åŒ–ä¸­</span></div>

      <div class="row">
        <input id="nameInput" type="text" placeholder="è«‹è¼¸å…¥å§“åï¼›å¯ç”¨ç©ºç™½æˆ–é€—è™Ÿåˆ†éš”" />
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="lockBtn">é–å®šåå–®</button>
        <button id="spin1Btn">é–‹å§‹æŠ½å§“åï¼ˆç¬¬ä¸€è¼ªï¼‰</button>
        <button id="spin2Btn">æŠ½ç´…åŒ…ï¼ˆç¬¬äºŒè¼ªï¼‰</button>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="viewBtn">çœ‹ç´…åŒ…ï¼ˆé–‹ Viewerï¼‰</button>
        <button id="resetBtn" class="danger">å…¨éƒ¨æ­¸é›¶</button>
        <button id="pdfBtn" class="primary">æŠ½ç±¤ç´€éŒ„ PDF</button>
      </div>

      <div class="wheelBox">
        <div>
          <canvas id="wheel" width="420" height="420" aria-label="wheel"></canvas>
          <div class="centerText big" id="centerText">è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®</div>
        </div>
      </div>

      <div class="muted" id="summaryText"></div>
    </div>

    <div class="card">
      <h1 style="font-size:18px;margin-bottom:10px;">QRï¼ˆåƒèˆ‡è€…åªè®€ Viewerï¼‰</h1>
      <div class="qrBox">
        <div id="qr"></div>
        <div class="linkBox">
          <div class="muted">æƒæå¾Œæœƒè‡ªå‹•è·Ÿéš¨ä¸»æŒæ©Ÿã€Œæœ€æ–°æŠ½åˆ°çš„ç´…åŒ…ã€</div>
          <div class="mono" id="viewerLink" style="word-break:break-all;margin-top:6px;"></div>
          <div class="row" style="margin-top:10px;">
            <button id="copyLinkBtn">è¤‡è£½é€£çµ</button>
          </div>
        </div>
      </div>

      <h1 style="font-size:18px;margin:14px 0 10px;">æŠ½ç±¤ç´€éŒ„</h1>
      <div class="log" id="logBox"></div>
    </div>
  </div>

  <!-- libs (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  // ============================================================
  // Clean Host (Mode B) + Viewer (Mode A)
  // Paths assumption:
  // /BlessingCards128/
  //   logo3524.png
  //   /audio  drum.mp3 win.mp3
  //   /cards  001.png ... 128.png
  //   /host   index.html viewer.html
  // ============================================================
  const BASE = "..";
  const PATHS = {
    AUDIO: `${BASE}/audio`,
    CARDS: `${BASE}/cards`,
    VIEWER_URL: new URL("viewer.html", location.href).toString()
  };

  const KEY_LAST_DRAW = "LAST_DRAW";
  const KEY_LOGS = "drawLogs_v2";

  const SYS = Object.freeze({
    INIT: "INIT",
    READY: "READY",     // âœ… ç¬¬ä¸€è¼ªå¾…å‘½ï¼ˆæ‡‰é–ƒç¬¬ä¸€è¼ªï¼‰
    ROUND1: "ROUND1",
    ROUND2: "ROUND2",
    VIEWER: "VIEWER",   // âœ… ç¬¬äºŒè¼ªå®Œæˆå¾Œï¼Œå¿…é ˆå…ˆçœ‹ç´…åŒ…ï¼Œä¸èƒ½ç›´æ¥ FINISHED
    FINISHED: "FINISHED"
  });

  // DOM
  const nameInput = document.getElementById("nameInput");
  const lockBtn = document.getElementById("lockBtn");
  const spin1Btn = document.getElementById("spin1Btn");
  const spin2Btn = document.getElementById("spin2Btn");
  const viewBtn = document.getElementById("viewBtn");
  const resetBtn = document.getElementById("resetBtn");
  const pdfBtn = document.getElementById("pdfBtn");
  const centerText = document.getElementById("centerText");
  const summaryText = document.getElementById("summaryText");
  const statusText = document.getElementById("statusText");
  const dot = document.getElementById("dot");
  const logBox = document.getElementById("logBox");
  const viewerLinkEl = document.getElementById("viewerLink");
  const copyLinkBtn = document.getElementById("copyLinkBtn");

  // Audio (unlock-on-gesture)
  const drum = new Audio(`${PATHS.AUDIO}/drum.mp3`);
  const winSound = new Audio(`${PATHS.AUDIO}/win.mp3`);
  let audioUnlocked = false;

  function unlockAudioOnce(){
    if (audioUnlocked) return;
    audioUnlocked = true;
    [drum, winSound].forEach(a=>{
      try{
        a.muted = true;
        a.play().then(()=>{a.pause(); a.currentTime=0; a.muted=false;}).catch(()=>{a.muted=false;});
      }catch{}
    });
    document.removeEventListener("pointerdown", unlockAudioOnce);
  }
  document.addEventListener("pointerdown", unlockAudioOnce, { once: true });

  // State
  const state = {
    system: SYS.INIT,
    names: [],
    usedNameIdx: new Set(),
    usedVerse: new Set(),
    lastWinnerIdx: null,
    currentVerse: null, // "073"
    currentRef: ""
  };

  // Wheel rendering/animation
  const canvas = document.getElementById("wheel");
  const ctx = canvas.getContext("2d");
  let spinning = false;
  let rotation = 0;

  function pad3(n){ return String(n).padStart(3,"0"); }
  function nowHHMMSS(){
    const d = new Date();
    const h = String(d.getHours()).padStart(2,"0");
    const m = String(d.getMinutes()).padStart(2,"0");
    const s = String(d.getSeconds()).padStart(2,"0");
    return `${h}:${m}:${s}`;
  }
  function parseNames(raw){
    return raw.split(/[\n,ï¼Œ\s]+/g).map(s=>s.trim()).filter(Boolean);
  }

  function setStatus(kind, text){
    statusText.textContent = text;
    dot.className = "dot " + kind;
  }

  function setBlink(btn, on){
    if (!btn) return;
    btn.classList.toggle("blink", !!on);
  }

  function clearBlinks(){
    [spin1Btn, spin2Btn, viewBtn].forEach(b=>setBlink(b,false));
  }

  function applyUI(){
    clearBlinks();

    lockBtn.disabled = false;
    spin1Btn.disabled = true;
    spin2Btn.disabled = true;
    viewBtn.disabled = true;
    pdfBtn.disabled = true;

    if (state.system === SYS.INIT){
      setStatus("warn","è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®");
      centerText.textContent = "è«‹è¼¸å…¥å§“åä¸¦é–å®šåå–®";
    }

    if (state.system === SYS.READY){
      setStatus("ok","åå–®å·²é–å®šï¼Œæº–å‚™æŠ½ç±¤");
      spin1Btn.disabled = false;
      setBlink(spin1Btn, true); // âœ… ç¬¬ä¸€è¼ªå¿…é–ƒ
      centerText.textContent = "è«‹é–‹å§‹ç¬¬ä¸€è¼ªæŠ½ç±¤";
    }

    if (state.system === SYS.ROUND1){
      setStatus("busy","ç¬¬ä¸€è¼ªæŠ½äººä¸­â€¦");
    }

    if (state.system === SYS.ROUND2){
      setStatus("busy","ç¬¬äºŒè¼ªæŠ½ç¶“å¥ä¸­â€¦");
      spin2Btn.disabled = false;
      setBlink(spin2Btn, true);
    }

    if (state.system === SYS.VIEWER){
      setStatus("busy","ç¬¬äºŒè¼ªå®Œæˆï¼šè«‹æŒ‰ã€çœ‹ç´…åŒ…ã€");
      viewBtn.disabled = false;
      setBlink(viewBtn, true);
      centerText.textContent = `ğŸ“œ æŠ½ä¸­ç¶“å¥ã€Œ${state.currentVerse||""}ã€\nğŸ“– ${state.currentRef||""}`;
    }

    if (state.system === SYS.FINISHED){
      setStatus("end","æœ¬è¼ªå·²å®Œæˆï¼Œå¯ä¸‹è¼‰ PDF æˆ–å…¨éƒ¨æ­¸é›¶");
      pdfBtn.disabled = false;
      resetBtn.disabled = false;
      centerText.textContent = `ğŸ“œ æœ¬è¼ªå®Œæˆ\næœ€å¾ŒæŠ½ä¸­ã€Œ${state.currentVerse||""}ã€`;
      summaryText.textContent = "æœ¬è¼ªå·²å®Œæˆï¼Œå¯ä¸‹è¼‰ PDF æˆ–å…¨éƒ¨æ­¸é›¶";
    }

    if (spinning){
      lockBtn.disabled = true;
      spin1Btn.disabled = true;
      spin2Btn.disabled = true;
      viewBtn.disabled = true;
      pdfBtn.disabled = true;
      resetBtn.disabled = true;
    }
  }

  function drawWheel(labels){
    const W = canvas.width, H = canvas.height;
    const r = Math.min(W,H)/2 - 8;
    ctx.clearRect(0,0,W,H);

    ctx.save();
    ctx.translate(W/2, H/2);
    ctx.rotate(rotation);

    const n = Math.max(2, labels.length);
    for (let i=0;i<n;i++){
      const a0 = (i/n) * Math.PI*2;
      const a1 = ((i+1)/n) * Math.PI*2;

      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.arc(0,0,r,a0,a1);
      ctx.closePath();
      ctx.fillStyle = (i%2===0) ? "rgba(255,206,110,.55)" : "rgba(255,220,150,.45)";
      ctx.fill();

      ctx.strokeStyle = "rgba(255,255,255,.9)";
      ctx.lineWidth = 2;
      ctx.stroke();

      const mid = (a0+a1)/2;
      ctx.save();
      ctx.rotate(mid);
      ctx.translate(r*0.62,0);
      ctx.rotate(Math.PI/2);
      ctx.fillStyle = "rgba(60,40,20,.85)";
      ctx.font = "700 14px system-ui, -apple-system, Noto Sans TC, Microsoft JhengHei, sans-serif";
      const txt = labels[i] ?? "";
      ctx.fillText(txt.slice(0,6), -ctx.measureText(txt.slice(0,6)).width/2, 0);
      ctx.restore();
    }
    ctx.restore();

    // pointer (top)
    ctx.save();
    ctx.translate(W/2, H/2);
    ctx.beginPath();
    ctx.moveTo(0, -r - 6);
    ctx.lineTo(-14, -r + 18);
    ctx.lineTo(14, -r + 18);
    ctx.closePath();
    ctx.fillStyle = "rgba(90,59,31,.85)";
    ctx.fill();
    ctx.restore();
  }

  function pickRandomRemainingNameIndex(){
    const remain = [];
    for (let i=0;i<state.names.length;i++){
      if (!state.usedNameIdx.has(i)) remain.push(i);
    }
    if (!remain.length) return null;
    return remain[Math.floor(Math.random()*remain.length)];
  }

  function pickRandomRemainingVerse(){
    const remain = [];
    for (let i=1;i<=128;i++){
      const v = pad3(i);
      if (!state.usedVerse.has(v)) remain.push(v);
    }
    if (!remain.length) return null;
    return remain[Math.floor(Math.random()*remain.length)];
  }

  function animateSpin(turns, durationMs, onDone){
    spinning = true;
    const start = performance.now();
    const startRot = rotation;
    const endRot = startRot + (Math.PI*2*turns) + Math.random()*Math.PI*2;
    function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }
    function frame(now){
      const t = Math.min(1, (now-start)/durationMs);
      rotation = startRot + (endRot-startRot)*easeOutCubic(t);
      render();
      if (t<1) requestAnimationFrame(frame);
      else { spinning = false; onDone?.(); }
    }
    requestAnimationFrame(frame);
  }

  function render(){
    if (state.system === SYS.READY || state.system === SYS.ROUND1){
      const remain = [];
      for (let i=0;i<state.names.length;i++){
        if (!state.usedNameIdx.has(i)) remain.push(state.names[i]);
      }
      drawWheel(remain.length ? remain : state.names);
    }else{
      const n = Math.max(2, state.names.length || 2);
      drawWheel(Array.from({length:n}, (_,i)=>String(i+1)));
    }
    applyUI();
    renderLogs();
    renderQR();
  }

  function readLogs(){
    try{
      const v = JSON.parse(localStorage.getItem(KEY_LOGS) || "[]");
      return Array.isArray(v) ? v : [];
    }catch{ return []; }
  }
  function writeLogs(logs){
    localStorage.setItem(KEY_LOGS, JSON.stringify(logs));
  }
  function renderLogs(){
    const logs = readLogs().slice().reverse();
    logBox.innerHTML = logs.map(l=>`[${l.time}] ã€Œ${l.name}ã€ â†’ æŠ½ä¸­ç¶“å¥ç´…åŒ…: ${l.ref}ï¼ˆ${l.verse}ï¼‰`).join("<br>");
  }

  function broadcastLastDraw(){
    if (!state.currentVerse) return;
    const winnerName = (state.lastWinnerIdx!=null) ? (state.names[state.lastWinnerIdx] || "") : "";
    localStorage.setItem(KEY_LAST_DRAW, JSON.stringify({
      verse: state.currentVerse,
      ref: state.currentRef || "",
      name: winnerName,
      time: Date.now()
    }));
  }

  // QR rendering (points to viewer.html only; Mode A auto-follow)
  let qrObj = null;
  function renderQR(){
    viewerLinkEl.textContent = PATHS.VIEWER_URL;
    if (!qrObj){
      document.getElementById("qr").innerHTML = "";
      qrObj = new QRCode(document.getElementById("qr"), {
        text: PATHS.VIEWER_URL,
        width: 116,
        height: 116,
        correctLevel: QRCode.CorrectLevel.M
      });
    }else{
      qrObj.clear();
      qrObj.makeCode(PATHS.VIEWER_URL);
    }
  }

  copyLinkBtn.onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(PATHS.VIEWER_URL);
      copyLinkBtn.textContent = "å·²è¤‡è£½ âœ…";
      setTimeout(()=>copyLinkBtn.textContent="è¤‡è£½é€£çµ", 900);
    }catch{
      alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š\n" + PATHS.VIEWER_URL);
    }
  };

  // Optional ref map file (if you keep it in repo root: /BlessingCards128/verseRefMap.js)
  (function loadRefMap(){
    const s = document.createElement("script");
    s.src = `${BASE}/verseRefMap.js`;
    s.defer = true;
    s.onerror = ()=>{ /* ignore */ };
    document.head.appendChild(s);
  })();
  function refOf(v){
    if (window.VERSE_REF_MAP && window.VERSE_REF_MAP[v]) return window.VERSE_REF_MAP[v];
    return "";
  }

  // Actions
  lockBtn.onclick = ()=>{
    const list = parseNames(nameInput.value);
    if (!list.length){
      alert("è«‹å…ˆè¼¸å…¥è‡³å°‘ 1 ä½å§“å");
      return;
    }
    state.names = list;
    state.usedNameIdx = new Set();
    state.usedVerse = new Set();
    state.lastWinnerIdx = null;
    state.currentVerse = null;
    state.currentRef = "";
    summaryText.textContent = "";
    state.system = SYS.READY;
    render();
  };

  spin1Btn.onclick = ()=>{
    if (spinning) return;
    if (state.system !== SYS.READY) return;

    const idx = pickRandomRemainingNameIndex();
    if (idx == null){
      state.system = SYS.FINISHED;
      render();
      return;
    }

    state.system = SYS.ROUND1;
    try{ drum.currentTime=0; drum.play(); }catch{}
    render();

    animateSpin(5 + Math.random()*3, 2200, ()=>{
      state.lastWinnerIdx = idx;
      state.usedNameIdx.add(idx);
      const winnerName = state.names[idx] || "";
      centerText.textContent = `ğŸ¯ æŠ½ä¸­ã€Œ${winnerName}ã€\nè«‹é€²è¡Œç¬¬äºŒè¼ªæŠ½ç´…åŒ…`;

      // âœ… é€²ç¬¬äºŒè¼ªå¾…å‘½ï¼šåªé–ƒç¬¬äºŒè¼ªæŒ‰éˆ•
      state.system = SYS.ROUND2;
      render();
    });
  };

  spin2Btn.onclick = ()=>{
    if (spinning) return;
    if (state.system !== SYS.ROUND2) return;

    const v = pickRandomRemainingVerse();
    if (!v){
      alert("ç¶“å¥å·²ç”¨å®Œï¼ˆ001â€“128ï¼‰");
      return;
    }

    try{ drum.currentTime=0; drum.play(); }catch{}
    render();

    animateSpin(6 + Math.random()*4, 2500, ()=>{
      state.currentVerse = v;
      state.usedVerse.add(v);
      state.currentRef = refOf(v);

      // logs
      const winnerName = state.names[state.lastWinnerIdx] || "";
      const logs = readLogs();
      logs.push({ time: nowHHMMSS(), name: winnerName, verse: v, ref: state.currentRef || "" });
      writeLogs(logs);

      broadcastLastDraw();
      try{ winSound.currentTime=0; winSound.play(); }catch{}

      // âœ… ç¬¬äºŒè¼ªå®Œæˆï¼šå¿…é ˆå…ˆçœ‹ç´…åŒ…ï¼ˆä¸èƒ½å…ˆ FINISHEDï¼‰
      state.system = SYS.VIEWER;
      render();
    });
  };

  viewBtn.onclick = ()=>{
    if (state.system !== SYS.VIEWER) return;
    if (!state.currentVerse) return;

    const winnerName = state.names[state.lastWinnerIdx] || "";
    const url = `viewer.html?code=${encodeURIComponent(state.currentVerse)}&name=${encodeURIComponent(winnerName)}&t=${Date.now()}`;
    window.open(url, "_blank");
  };

  // âœ… ä¸»æŒæ©Ÿå¾ Viewer å›ä¾†ï¼ˆfocusï¼‰ï¼š
  // - è‹¥é‚„æœ‰äºº â†’ å› READYï¼ˆç¬¬ä¸€è¼ªé–ƒï¼‰
  // - è‹¥å·²æœ€å¾Œä¸€ä½ â†’ é€² FINISHEDï¼ˆé¡¯ç¤ºä¸‰è¡Œ + PDF/æ­¸é›¶è®Šè‰²ï¼‰
  window.addEventListener("focus", ()=>{
    if (state.system !== SYS.VIEWER) return;

    const total = state.names.length;
    const drawn = state.usedNameIdx.size;

    // æ¸…æ‰æœ¬ä½æš«å­˜ï¼ˆä½†ä¿ç•™ used setsï¼‰
    state.lastWinnerIdx = null;
    state.currentVerse = null;
    state.currentRef = "";

    if (drawn >= total){
      state.system = SYS.FINISHED;
    }else{
      state.system = SYS.READY; // âœ… ä¸‹ä¸€ä½å›ç¬¬ä¸€è¼ªé–ƒ
    }
    render();
  });

  resetBtn.onclick = ()=>{
    const ok = confirm("è³‡æ–™ç´€éŒ„å°‡è¢«æ¸…ç©º & æ­¸é›¶\néœ€é‡æ–°è¼¸å…¥å§“åä¸¦é–‹å§‹æ–°ä¸€è¼ª\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ");
    if (!ok) return;

    localStorage.removeItem(KEY_LOGS);
    localStorage.removeItem(KEY_LAST_DRAW);

    state.system = SYS.INIT;
    state.names = [];
    state.usedNameIdx = new Set();
    state.usedVerse = new Set();
    state.lastWinnerIdx = null;
    state.currentVerse = null;
    state.currentRef = "";

    nameInput.value = "";
    summaryText.textContent = "";
    rotation = 0;
    render();
  };

  pdfBtn.onclick = async ()=>{
    const logs = readLogs();
    if (!logs.length){
      alert("æ²’æœ‰å¯ä¸‹è¼‰çš„æŠ½ç±¤ç´€éŒ„");
      return;
    }

    // DOM render â†’ image â†’ PDF (keeps Chinese)
    const holder = document.createElement("div");
    holder.style.position="fixed";
    holder.style.left="-9999px";
    holder.style.top="0";
    holder.style.width="794px";
    holder.style.padding="28px";
    holder.style.background="#fff";
    holder.style.fontFamily='system-ui, -apple-system, "Noto Sans TC", "Microsoft JhengHei", sans-serif';
    holder.innerHTML = `
      <div style="font-size:18px;font-weight:800;margin-bottom:10px;">BlessingCards128 æŠ½ç±¤ç´€éŒ„</div>
      <div style="font-size:12px;opacity:.75;margin-bottom:14px;">ç”¢ç”Ÿæ™‚é–“ï¼š${new Date().toLocaleString()}</div>
      <div style="font-size:14px;line-height:1.6;">
        ${logs.map(l=>`[${l.time}] ã€Œ${l.name}ã€ â†’ æŠ½ä¸­ç¶“å¥ç´…åŒ…: ${l.ref}ï¼ˆ${l.verse}ï¼‰`).join("<br>")}
      </div>
    `;
    document.body.appendChild(holder);

    try{
      const c = await html2canvas(holder, { scale: 2 });
      const imgData = c.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p","pt","a4");

      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 24;
      const maxW = pageW - margin*2;
      const maxH = pageH - margin*2;

      const ratio = Math.min(maxW/c.width, maxH/c.height);
      pdf.addImage(imgData, "PNG", margin, margin, c.width*ratio, c.height*ratio);
      pdf.save(`BlessingCards128_logs_${Date.now()}.pdf`);
    }catch(e){
      console.error("PDF failed", e);
      alert("PDF ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹çœ‹ console");
    }finally{
      document.body.removeChild(holder);
    }
  };

  // init
  state.system = SYS.INIT;
  render();
  </script>
</body>
</html>
