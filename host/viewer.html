<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BlessingCards128ï¼ˆViewerï½œåªè®€ï¼‰</title>
  <style>
    :root{--bg:#f6f1e6;--card:#fff;--ink:#2b2b2b;--muted:#666;--btn:#f0c35a;--blue:#5b7cff;}
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--ink);}
    .wrap{max-width:760px;margin:0 auto;padding:14px;}
    .card{background:var(--card);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:14px;}
    h1{font-size:18px;margin:0 0 10px;}
    .muted{color:var(--muted);font-size:13px}
    .imgbox{background:#fff;border-radius:14px;border:1px solid rgba(0,0,0,.12);overflow:hidden}
    img{display:block;width:100%;height:auto}
    button{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:800;background:var(--btn);cursor:pointer}
    button.blue{background:var(--blue);color:#fff}
    button:disabled{opacity:.45;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ç¥ç¦ç¶“å¥ç´…åŒ…ï¼ˆViewerï½œåªè®€ï¼‰</h1>
      <div class="muted" id="infoBox">è®€å–ä¸­â€¦</div>
      <div class="muted" id="refBox" style="margin-top:6px"></div>

      <div style="margin-top:12px" class="imgbox">
        <img id="imgVerse" alt="ç´…åŒ…åœ–ç‰‡" />
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnDownload">ä¸‹è¼‰ç¶“å¥åœ–ç‰‡</button>
        <button id="btnBack" class="blue">è¿”å›ä¸»æŒæ©Ÿ</button>
      </div>

      <div class="muted" style="margin-top:8px">è‹¥æœªè‡ªå‹•æ›´æ–°ï¼Œè«‹é‡æ–°æ•´ç†æœ¬é ã€‚</div>
    </div>
  </div>

  <script src="../verseRefMap.js"></script>
  <script>
    const BASE = "..";
    const qs = new URL(window.location.href).searchParams;

    function pad3(x){
      const s = String(x||"").trim();
      if (!s) return "";
      return s.padStart(3,"0");
    }

    let code = pad3(qs.get("code") || qs.get("no"));
    const name = (qs.get("name")||"").trim();

    if (!code) {
      try{
        const last = JSON.parse(localStorage.getItem("LAST_VERSE")||"null");
        if (last && last.verse) code = pad3(last.verse);
      }catch{}
    }

    const infoBox = document.getElementById("infoBox");
    const refBox  = document.getElementById("refBox");
    const img = document.getElementById("imgVerse");

    if (!code){
      infoBox.textContent = "âš  å°šæœªæœ‰æŠ½åˆ°çš„ç´…åŒ…ï¼Œè«‹ç­‰å¾…ä¸»æŒæ©ŸæŠ½ç±¤ã€‚";
    }else{
      const ref = (window.VERSE_REF_MAP && window.VERSE_REF_MAP[code]) ? window.VERSE_REF_MAP[code] : "";
      infoBox.textContent = name ? `ã€Œ${name}ã€æŠ½ä¸­çš„ç¶“å¥ç´…åŒ…` : `æœ€æ–°æŠ½ä¸­çš„ç¶“å¥ç´…åŒ…`;
      refBox.textContent = `ğŸ“œ ç¶“å¥ç·¨è™Ÿï¼š${code}` + (ref ? `ï½œğŸ“– ${ref}` : "");

      const IMG_SRC = `${BASE}/cards/${code}.png`;
      img.src = IMG_SRC;

      img.onerror = () => {
        infoBox.textContent = "âš  æ‰¾ä¸åˆ°åœ–ç‰‡ï¼š" + IMG_SRC;
      };
    }

    document.getElementById("btnDownload").onclick = async () => {
      if (!code) return;
      const url = `${BASE}/cards/${code}.png`;
      try{
        const r = await fetch(url, {cache:"no-store"});
        if (!r.ok) throw new Error("HTTP " + r.status);
        const blob = await r.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `BlessingCard_${code}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
      }catch(e){
        alert("ä¸‹è¼‰å¤±æ•—ï¼š" + (e && e.message ? e.message : e));
      }
    };

    document.getElementById("btnBack").onclick = () => {
      try{
        localStorage.setItem("VIEWER_DONE", JSON.stringify({time:Date.now(), code: code || ""}));
      }catch{}
      window.location.href = "index.html";
    };
  </script>
</body>
</html>
