<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>BlessingCards128 Viewerï¼ˆå”¯è®€ï¼‰</title>

  <!-- âœ… ä½ æŒ‡å®šã€Œæœ€é©åˆæ‰‹æ©Ÿé¡¯ç¤ºã€çš„ viewer æ¨£å¼ï¼šç¶­æŒ -->
  <style>
body{
  font-family:"Noto Sans TC",system-ui;
  background:#fbf2df;
  text-align:center;
  margin:0;
  padding:16px;
  color:#5b3a00;
}
#infoBox{font-size:18px;white-space:pre-line;margin-bottom:10px;}
#imgVerse{
  width: min(98vw, 720px);
  max-height: 92vh;
  object-fit: contain;
  border-radius:18px;
  display:block;
  margin:16px auto;
  border:6px solid gold;
}
@keyframes glow{0%{box-shadow:0 0 10px gold;}50%{box-shadow:0 0 32px gold;}100%{box-shadow:0 0 10px gold;}}
@keyframes jump{0%{transform:scale(.8);opacity:.2;}40%{transform:scale(1.05);opacity:1;}80%{transform:scale(1.0);}100%{transform:scale(1.0);}}
.animate{animation:glow 2.2s infinite, jump 1.2s ease-out;}
.btn{
  min-width:110px;padding:8px 16px;border-radius:999px;border:none;
  background:#f4b63a;color:#5b3a00;font-size:15px;font-weight:600;
  box-shadow:0 3px 0 #d59b25;cursor:pointer;margin:10px 6px 0 6px;
}
.btn:disabled{background:#f0ddaa;cursor:default;}
#fxCanvas{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;}
#loading{margin:12px 0;font-size:15px;color:#8a5a00;}
@media (max-width: 768px){#imgVerse{width:98vw;max-height:90vh;}}
  </style>
</head>

<body>
  <div id="infoBox">ğŸ ç¶“å¥ç´…åŒ…</div>
  <div id="loading">è¼‰å…¥ä¸­â€¦</div>
  <img id="imgVerse" alt="verse" />
  <div><button id="saveBtn" class="btn">å­˜åœ–ç‰‡</button></div>
  <canvas id="fxCanvas"></canvas>

  <script type="module">
    import { launchViewerFX } from "./js/fxViewer.js";

    const img = document.getElementById("imgVerse");
    const loading = document.getElementById("loading");
    const infoBox = document.getElementById("infoBox");
    const saveBtn = document.getElementById("saveBtn");

    const q = new URLSearchParams(location.search);
    const noRaw = (q.get("no") || "").trim();
    const no = noRaw.padStart(3, "0");
    const name = (q.get("name") || "").trim();

    // âœ… cards åœ¨ repo rootï¼šHost å­ç›®éŒ„è¦å›ä¸Šä¸€å±¤
    const ASSET_BASE = "../";
    const src = ASSET_BASE + "cards/" + no + ".png";

    if (!noRaw || no === "000"){
      loading.textContent = "âš  ç¼ºå°‘ç¶“å¥ç·¨è™Ÿ";
      saveBtn.disabled = true;
    } else {
      img.onload = () => {
        loading.style.display = "none";
        img.classList.add("animate");
        infoBox.textContent = name ? `ğŸ ${name} çš„ç¶“å¥ç´…åŒ…\n#${no}` : `ğŸ ç¶“å¥ç´…åŒ…\n#${no}`;
        try { launchViewerFX(); } catch(e) {}
      };
      img.onerror = () => {
        loading.textContent = "âš  åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼ˆè«‹ç¢ºèª cards è³‡æ–™å¤¾ï¼‰";
        saveBtn.disabled = true;
      };
      img.src = src;

      // âœ… å”¯è®€ viewerï¼šåªå­˜åœ–ï¼Œæ²’æœ‰ä»»ä½•è¿”å›/ä¸‹ä¸€ä½
      saveBtn.onclick = async () => {
        try{
          const res = await fetch(src, { cache:"no-store" });
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `verse_${no}.png`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }catch(e){
          alert("å­˜åœ–å¤±æ•—ï¼Œè«‹æ”¹ç”¨ï¼šæ‰‹æ©Ÿé•·æŒ‰åœ–ç‰‡ â†’ å­˜åœ–");
        }
      };
    }
  </script>
</body>
</html>
