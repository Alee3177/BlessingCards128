<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æœ€å°å¯é©—è­‰è½‰ç›¤ï¼ˆMVPï¼‰</title>
  <style>
    body{font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;background:#fbf2df;margin:0;padding:24px;display:flex;flex-direction:column;align-items:center;gap:12px;}
    h2{margin:0;color:#5b3a00}
    #wrap{position:relative;width:360px}
    #btn{padding:10px 14px;border-radius:10px;border:1px solid #b58b5a;background:#fff;cursor:pointer}
    #btn:disabled{opacity:.5;cursor:not-allowed}
    canvas{background:#fff0;display:block;margin:0 auto}
    /* æŒ‡é‡ */
    #pointer{
      position:absolute;left:50%;top:56px;transform:translateX(-50%);
      width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-top:22px solid #d60000;
      filter:drop-shadow(0 1px 0 rgba(0,0,0,.12));
    }
    #log{width:360px;white-space:pre-wrap;font-size:13px;color:#5b3a00;background:#fff;border:1px solid #e7cfa6;border-radius:10px;padding:10px;box-sizing:border-box}
  </style>
</head>
<body>
  <h2>æœ€å°å¯é©—è­‰è½‰ç›¤ï¼ˆMVPï¼‰</h2>
  <button id="btn">é–‹å§‹æ—‹è½‰</button>

  <div id="wrap">
    <div id="pointer"></div>
    <canvas id="cv" width="360" height="360"></canvas>
  </div>

  <div id="log">ï¼ˆConsole ä¹Ÿæœƒè¼¸å‡ºï¼‰</div>

<script>
(() => {
  const items = ["1","2","3"];            // åªé©—è­‰ 1/2/3
  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");
  const btn = document.getElementById("btn");
  const logBox = document.getElementById("log");

  const W = cv.width, H = cv.height;
  const CENTER = W/2;
  const RADIUS = 150;

  let isSpinning = false;
  let currentRotation = 0;

  // é€Ÿåº¦ï¼šç…§ä½ çš„è¦æ±‚
  const SPEED_BOOST = 1.35;
  const baseSpins = 4.8;
  const spins = baseSpins * SPEED_BOOST;

  // æŒ‡é‡æ–¹å‘ï¼ˆ12 é»ï¼‰ï¼šåœ¨ canvas æ¥µåº§æ¨™ä¸­ç‚º -PI/2
  const pointerAngle = -Math.PI/2;

  function normAngle(a){
    a = a % (Math.PI*2);
    if(a < 0) a += Math.PI*2;
    return a;
  }

  function shortestDiff(from, to){
    // from/to éƒ½æ˜¯ [0,2pi)
    let d = to - from;
    if(d > Math.PI) d -= Math.PI*2;
    if(d < -Math.PI) d += Math.PI*2;
    return d;
  }

  // æ›´å¹³æ»‘çš„æ”¶å°¾ï¼ˆæ¯” cubic æ›´ä¸æŠ–ï¼‰
  function easeOutQuint(t){
    return 1 - Math.pow(1 - t, 5);
  }

  function drawWheel(rotation){
    ctx.clearRect(0,0,W,H);

    const count = items.length;
    const arc = (Math.PI*2)/count;

    ctx.save();
    ctx.translate(CENTER, CENTER);
    ctx.rotate(rotation);
    ctx.translate(-CENTER, -CENTER);

    for(let i=0;i<count;i++){
      // åˆ‡ç‰‡ï¼šèˆ‡ä½ ä¸»ç¨‹å¼ä¸€è‡´ï¼ˆä¸­å¿ƒå°æº– 12 é»ï¼‰
      const start = i*arc - Math.PI/2 - arc/2;
      const end   = start + arc;

      ctx.beginPath();
      ctx.moveTo(CENTER, CENTER);
      ctx.arc(CENTER, CENTER, RADIUS, start, end);
      ctx.closePath();
      ctx.fillStyle = (i%2===0) ? "#fde7b5" : "#fcdca0";
      ctx.fill();

      ctx.strokeStyle = "#ffffff";
      ctx.lineWidth = 2;
      ctx.stroke();

      // æ–‡å­—
      ctx.save();
      ctx.translate(CENTER, CENTER);
      const mid = start + arc/2;
      ctx.rotate(mid);
      ctx.textAlign = "right";
      ctx.font = "22px system-ui, -apple-system, 'Noto Sans TC', sans-serif";
      ctx.fillStyle = "#5b3a00";
      ctx.fillText(items[i], RADIUS - 22, 10);
      ctx.restore();
    }

    ctx.restore();
  }

  // åæ¨ï¼šåœ¨æŸ rotation ä¸‹ï¼ŒæŒ‡é‡æŒ‡åˆ°å“ªå€‹ indexï¼ˆç”¨ä¾†è‡ªæˆ‘é©—è­‰ï¼‰
  function indexAtPointer(rotation){
    const count = items.length;
    const arc = (Math.PI*2)/count;

    // æŒ‡é‡è§’åº¦åœ¨ã€Œè½‰ç›¤è‡ªèº«åº§æ¨™ã€ä¸­ï¼špointerAngle - rotation
    const a = normAngle(pointerAngle - rotation);

    // æˆ‘å€‘çš„ slice ä¸­å¿ƒåœ¨ï¼ši*arc - PI/2
    // è®“ a å»å°æ‡‰æœ€è¿‘çš„ä¸­å¿ƒï¼ši = round((a + PI/2)/arc)
    let i = Math.round((a + Math.PI/2)/arc);
    i = ((i % count) + count) % count;
    return i;
  }

  function setLog(s){
    logBox.textContent = s;
    console.log(s);
  }

  async function spinOnce(){
    if(isSpinning) {
      // é¿å…ä½ çœ‹åˆ°ã€Œconsole ç©ºç™½ã€
      console.warn("busy: still spinning");
      return;
    }
    isSpinning = true;
    btn.disabled = true;

    const count = items.length;
    const arc = (Math.PI*2)/count;

    // éš¨æ©ŸæŠ½ä¸­
    const targetIndex = Math.floor(Math.random() * count);
    const targetValue = items[targetIndex];

    // âœ… targetCenter è¦èˆ‡ drawWheel å®Œå…¨ä¸€è‡´ï¼š
    // drawWheel åˆ‡ç‰‡ä¸­å¿ƒ = i*arc - PI/2
    const targetCenter = targetIndex * arc - Math.PI/2;

    // å¸Œæœ›æœ€çµ‚ rotation(æ¨¡2Ï€) æ»¿è¶³ï¼š targetCenter + rotation = pointerAngle
    let desiredMod = normAngle(pointerAngle - targetCenter);

    // âœ… é¿å…åœåœ¨åˆ†éš”ç·šï¼šå¾€è©²æ ¼ä¸­å¿ƒã€Œå…§ç¸®ä¸€é»ã€
    // é€™å€‹ epsilon å¾ˆå°ï¼Œä½†è¶³å¤ æŠŠã€Œé ç·šã€æ¨å›ä¸­å¿ƒ
    const eps = arc * 0.03; // 3% çš„æ‰‡å½¢å¯¬
    desiredMod = normAngle(desiredMod + eps);

    const startRot = currentRotation;
    const startMod = normAngle(startRot);

    // å…ˆèµ°ä¸€å€‹ã€Œè¼ƒè‡ªç„¶çš„çŸ­è·¯å¾‘å·®ã€ï¼Œå†åŠ å¤šåœˆï¼ˆåŒæ–¹å‘ï¼‰
    const baseDelta = shortestDiff(startMod, desiredMod);

    // æ–¹å‘ï¼šå›ºå®šé€†æ™‚é‡ï¼ˆè·Ÿä½ ç¬¬ä¸€è¼ªä¸€è‡´ï¼‰â†’ clockwise=false â†’ dir=-1
    const dir = -1;

    const deltaRotation = baseDelta + dir * (spins * 2 * Math.PI);

    const durationMs = 5200; // ä½ å¯å†èª¿ï¼šæ™‚é–“è¶Šé•·è¶Šã€Œè‡ªç„¶ã€

    const t0 = performance.now();

    function frame(now){
      let t = (now - t0) / durationMs;
      if(t > 1) t = 1;
      const eased = easeOutQuint(t);
      const rot = startRot + deltaRotation * eased;
      drawWheel(rot);

      if(t < 1){
        requestAnimationFrame(frame);
      }else{
        currentRotation = startRot + deltaRotation;
        drawWheel(currentRotation);

        // âœ… è‡ªæˆ‘é©—è­‰ï¼šæŒ‡é‡ä¸‹æ–¹ index å¿…é ˆç­‰æ–¼ targetIndex
        const observedIndex = indexAtPointer(currentRotation);

        const msg =
`ğŸ¯ æŠ½ä¸­ index = ${targetIndex} å€¼ = ${targetValue}
ğŸ‘€ æŒ‡é‡è§€æ¸¬ index = ${observedIndex} å€¼ = ${items[observedIndex]}
rotation = ${currentRotation.toFixed(6)}`;

        setLog(msg);

        if(observedIndex !== targetIndex){
          console.error("MISMATCH: observedIndex !== targetIndex", {targetIndex, observedIndex});
          alert("âŒ å‘½ä¸­å¤±æ•—ï¼šè«‹çœ‹ Consoleï¼ˆå·²è¼¸å‡º target/observedï¼‰");
        }

        isSpinning = false;
        btn.disabled = false;
      }
    }

    requestAnimationFrame(frame);
  }

  // åˆå§‹ç•«é¢
  drawWheel(0);

  btn.addEventListener("click", spinOnce);
})();
</script>
</body>
</html>